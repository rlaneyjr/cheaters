var GLMobileDDL = function(options) {
	var self = this;

	self.dealers = [];
	self.isDebug = (options.isDebug != undefined) && (options.isDebug != null) && (options.isDebug === true);
	self.isGoLive = (options.isGoLive != undefined) && (options.isGoLive != null) && (options.isGoLive === true);
	self.isInit = true;
	self.options = options;
	self.targetId = options.targetId;

	self.strings = {
		'en-US': {
			'enter-your-zip': 'Please re-enter your zip code if this is not accurate',
			'dealers-near': '<em>{0}</em> dealer{1} near',
			'locate-dealer': 'Locate a Dealer',
			'visit-website': 'Visit Website'
		},
		'es-MX': {
			'enter-your-zip': 'Please re-enter your zip code if this is not accurate',
			'dealers-near': '<em>{0}</em> dealer{1} near',
			'locate-dealer': 'Locate a Dealer',
			'visit-website': 'Visit Website'
		},
		'es-PR': {
			'enter-your-zip': 'Please re-enter your zip code if this is not accurate',
			'dealers-near': '<em>{0}</em> dealer{1} near',
			'locate-dealer': 'Locate a Dealer',
			'visit-website': 'Visit Website'
		}
	};

	self.log = function() {
		if (self.isDebug) {
			var args = ['[ gl_ddl ]'].concat([].splice.call(arguments, 0));
			console.log(args.join(' '));
		}
	};

	for (var o in options) {
		self.log(o, '=', options[o]);
	}

	self.render = function(gl) {
		self.gl = gl;
		self.campaignAdId = gl.campaignAdId;
		self.clickUrl = gl.clickUrl;
		self.dartCampaignId = gl.dartCampaignId;
		self.dealerCount = ((gl.dealers.length == 0) || ((gl.dealers.length == 1) && !gl.dealers[0].isValid)) ? 0 : gl.dealers.length;
		self.dealerName = gl.dealerName;
		self.dealers = gl.dealers;
		self.target = gl.target.querySelectorAll(self.targetId);
		self.userZip = gl.userZip;
        self.brand = gl.brand;
        
        var s = self.strings[gl.locale];

		if (self.isInit) {
			var d =
				String.format('<div class="gl-ddl-asset gl-ddl-container gl-{1}" ddlType="{0}">', gl.ddlType, "{0}x{1}") +
				'<div class="gl-ddl-header gl-{0}x{1}">' +
				'<span class="gl-ddl-header-text gl-{0}x{1}"></span>' +
				((gl.adSize == '300x250') ? '' : '<br/>') +
				String.format('<input type="{2}" class="gl-ddl-zip" maxlength="{1}" value="{0}"/>', gl.userZip, self.isGoLive ? 5 : 6, self.isGoLive ? 'number' : 'text') +
				'<div class="gl-ddl-refresh-div" title="{2}">' +
				'<div class="gl-ddl-refresh-icon"></div>' +
				'</div>' +
				'</div>' +
				'<div class="gl-ddl-dealers gl-{0}x{1}">' +
				'<ul class="gl-ddl-dealer-list"></ul>' +
				'</div>' +
				'<div class="gl-ddl-asset gl-close-ddl gl-{0}x{1}" style="display:none;"></div>' +
				'</div>';
			d = String.format(d, gl.adWidth, gl.adHeight, s['enter-your-zip']);

			self.target
				.html(d)
				.on('blur', '.gl-ddl-zip', function(e) {
					if (e.currentTarget.val() == '') {
						e.currentTarget.val(self.userZip);
					}
				})
				.on('focus', '.gl-ddl-zip', function(e) {
					e.currentTarget.val('');
				})
				.on('keydown', '.gl-ddl-zip', self.onChangeZip)
				.on('click', '.gl-ddl-refresh-icon', self.onChangeZip)
				.on('click', '.gl-ddl-dealers', function() {
					self.onClickDealerAt((self.dealerCount == 0) ? -1 : 0);
				});

			if (!self.isGoLive) {
				self.target.find('.gl-close-ddl').show();
				self.target.on('click', '.gl-close-ddl', function(e) {
					e.preventDefault();
					e.stopImmediatePropagation();
					self.gl.ddlEvent(GLEvent.CLOSE_DDL);
				});
			}

			if (self.brand == "Chevrolet") {
                self.target.find('.gl-close-ddl').html("&#x2715");
				self.target.find('.gl-close-ddl').show();
				self.target.on('click', '.gl-close-ddl', function(e) {
					e.preventDefault();
					e.stopImmediatePropagation();
					self.gl.ddlEvent(GLEvent.SHOW_MESSAGE);
				});
			}            
            
            

			self.isInit = false;
		} else {
			self.target.find('.gl-ddl-zip').val(gl.userZip);
		}

		self.target.find('.gl-ddl-header-text').html(String.format(s['dealers-near'], self.dealerCount, (self.dealerCount == 1) ? '' : 's'));

		var d = '';
		if (self.dealerCount == 0) {
			var dealerName = gl.dealerName;
			if (String.isNullOrEmpty(dealerName)) {
				dealerName = s['locate-dealer'];
			}
			d += String.format('<li class="gl-ddl-single-dealer gl-{0}x{1}" data-index="0">{2}</li><button class="gl-ddl-visit-website">{3}</button>', gl.adWidth, gl.adHeight, dealerName, s['visit-website']);
		} else {
			switch (parseInt(gl.ddlType)) {
				case 1:
				case 2:
				case 4:
					dealer = gl.dealers[0];
					d += String.format('<li class="gl-ddl-single-dealer gl-{0}x{1}" data-index="0">{2}</li><button class="gl-ddl-visit-website">{3}</button>', gl.adWidth, gl.adHeight, dealer.dealerName, s['visit-website']);
					break;
				case 3:
				case 5:
				case 6:
					for (var i = 0; i < gl.dealers.length; i++) {
						var dealer = gl.dealers[i];
						d += String.format('<li class="gl-ddl-dealer gl-{0}x{1}" data-index="{2}">{3}</li>', gl.adWidth, gl.adHeight, i, dealer.dealerName);
					}
					break;
				default:
					break;
			}
		}
		self.target.find('.gl-ddl-dealer-list').html(d);
		self.target
			.on('click', '.gl-ddl-visit-website', self.onClickVisit)
			.on('click', '.gl-ddl-dealer', self.onClickDealer);
	};
	self.onChangeZip = function(e) {
		var zip = '';
		if (e.type == 'keydown') {
			zip = e.currentTarget.val();
			if (e.keyCode == 13) {

			} else {
				var maxLength = parseInt(e.currentTarget.attr('maxlength'));
				if (zip.length < maxLength) {
					if (self.isGoLive) {
						var isBsDel = (e.keyCode == 8) || (e.keyCode == 46);
						var isArrow = (e.keyCode > 36) && (e.keyCode < 41);
						var isNum = ((e.keyCode > 47) && (e.keyCode < 58)) || ((e.keyCode > 95) && (e.keyCode < 106));
						var isPaste = (e.ctrlKey || e.metaKey) && (e.keyCode == 86);
						return isBsDel || isArrow || isNum || isPaste;
					}
				} else {
					return false;
				}
			}
		} else {
			zip = e.currentTarget.parentElement.previousSibling.val();
		}
		if (zip.length > 4) {
			var len = zip.length;
			var isNum = parseInt(zip).toString() == zip;
			var isUS = (len == 5) && isNum;
			var isCA = (len == 6) && !isNum;

			if ((zip != self.userZip) && (isUS || isCA)) {
				self.gl.ddlEvent(GLEvent.SEARCH_ZIP, zip);
			}
		}
	};
	self.onClickVisit = function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		self.onClickDealerAt(0);
	};
	self.onClickDealer = function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		var li = e.target;
		var i = parseInt(li.getAttribute('data-index'));
		self.onClickDealerAt(i);
	};
	self.onClickDealerAt = function(idx) {
		var d = {};
		if ((idx < 0) || (self.dealers.length == 0)) {
			d = {
				clickUrl: self.clickUrl,
				dealerId: 0,
				dealerName: self.dealerName
			};
		} else {
			d = self.dealers[idx];
		}
		self.gl.ddlEvent(GLEvent.DEALER_CLICKED, d);
	};

	return self;
};
