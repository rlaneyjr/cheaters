### Create a new Python File
The Python script has a few places that will require some attention, so copy WebArya's output to a text editor and save it in your working directory as `add_application.py`. This lab will walk through each section of the file and explain what it is used for, and what changes should be made.
>If you are using your own device and do not have the cobra packages installed, then WebArya will create slightly different output than we have below. The output provided should still work, but we recommend replacing it with what we provide as this follows best practcies, and makes it easier to incorporate the "configuration variables" that we discuss below.

#### Credentials File
We use a `credentials.py` file in this lab to authenticate with the APIC. If you are following along with your own device, then we suggest creating this file and saving it in your working directory. The file should look like this with updated parameters for your environment:
```
URL = 'https://198.18.133.200'
LOGIN = 'admin'
PASSWORD = 'C1sco12345'
```

We have also provided this file in the sample code repo.

#### The Shebang
The first line in the script is the shebang line, which informs the system which Python to use when executing the file. This allows users to type `./program.py` instead of `python program.py`. This line should not be changed.
```python
#!/usr/bin/env python
```

#### Keep Existing Document
The next section is a multiline comment that provides the JSON data used to generate the script. It is good to keep the comment in the file for documentation purposes, and this is why we prefer to choose "Configuration Only" when downloading the sample data. Leave these lines in the script.
```python
'''
Autogenerated code using webarya.py
Original Object Document Input:
{"totalCount":"1","imdata":[{"fvAp":{"attributes":{"descr":"","dn":"uni/tn-Heroes/ap-Save_The_Planet","name":"Save_The_Planet","ownerKey":"","ownerTag":"","prio":"unspecified"},"children":[{"fvAEPg":{"attributes":{"descr":"","isAttrBasedEPg":"no","matchT":"AtleastOne","name":"app","prio":"unspecified"},"children":[{"fvRsCons":{"attributes":{"prio":"unspecified","tnVzBrCPName":"sql"}}},{"fvRsPathAtt":{"attributes":{"descr":"","encap":"vlan-201","instrImedcy":"lazy","mode":"regular","tDn":"topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2B]"}}},{"fvRsPathAtt":{"attributes":{"descr":"","encap":"vlan-201","instrImedcy":"lazy","mode":"regular","tDn":"topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2A]"}}},{"fvRsDomAtt":{"attributes":{"encap":"unknown","instrImedcy":"lazy","resImedcy":"lazy","tDn":"uni/phys-Heroes_phys"}}},{"fvRsCustQosPol":{"attributes":{"tnQosCustomPolName":""}}},{"fvRsBd":{"attributes":{"tnFvBDName":"Hero_Land"}}},{"fvRsProv":{"attributes":{"matchT":"AtleastOne","prio":"unspecified","tnVzBrCPName":"power_up"}}}]}},{"fvAEPg":{"attributes":{"descr":"","isAttrBasedEPg":"no","matchT":"AtleastOne","name":"db","prio":"unspecified"},"children":[{"fvRsPathAtt":{"attributes":{"descr":"","encap":"vlan-202","instrImedcy":"lazy","mode":"regular","tDn":"topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2B]"}}},{"fvRsPathAtt":{"attributes":{"descr":"","encap":"vlan-202","instrImedcy":"lazy","mode":"regular","tDn":"topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2A]"}}},{"fvRsDomAtt":{"attributes":{"encap":"unknown","instrImedcy":"lazy","resImedcy":"lazy","tDn":"uni/phys-Heroes_phys"}}},{"fvRsCustQosPol":{"attributes":{"tnQosCustomPolName":""}}},{"fvRsBd":{"attributes":{"tnFvBDName":"Hero_Land"}}},{"fvRsProv":{"attributes":{"matchT":"AtleastOne","prio":"unspecified","tnVzBrCPName":"sql"}}}]}},{"fvAEPg":{"attributes":{"descr":"","isAttrBasedEPg":"no","matchT":"AtleastOne","name":"web","prio":"unspecified"},"children":[{"fvRsCons":{"attributes":{"prio":"unspecified","tnVzBrCPName":"sql"}}},{"fvRsPathAtt":{"attributes":{"descr":"","encap":"vlan-200","instrImedcy":"lazy","mode":"regular","tDn":"topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2B]"}}},{"fvRsPathAtt":{"attributes":{"descr":"","encap":"vlan-200","instrImedcy":"lazy","mode":"regular","tDn":"topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2A]"}}},{"fvRsDomAtt":{"attributes":{"encap":"unknown","instrImedcy":"lazy","resImedcy":"lazy","tDn":"uni/phys-Heroes_phys"}}},{"fvRsCustQosPol":{"attributes":{"tnQosCustomPolName":""}}},{"fvRsBd":{"attributes":{"tnFvBDName":"Hero_Land"}}},{"fvRsProv":{"attributes":{"matchT":"AtleastOne","prio":"unspecified","tnVzBrCPName":"web"}}}]}}]}}]}
'''
```

#### Raise Error
This section is a warning message provided by Arya that is meant to prevent the script from execution. This is a reminder that the code will need to have some things changed and that it should be reviewed before exectution. Remove these lines from your script.
```python
raise RuntimeError('Please review the auto generated code before ' +
'executing the output. Some placeholders will ' +
'need to be changed')
```

#### Import Libraries
The rest of the file is the actual code that configures the new objects. First, the necessary libraries need to be imported. If you are using the credentials.py file for authentication, you need to add `from credentials import *`
```python
# list of packages that should be imported for this code to work
import cobra.mit.access
import cobra.mit.request
import cobra.mit.session
import cobra.model.fv
import cobra.model.pol
from cobra.internal.codec.xmlcodec import toXMLStr
from credentials import *
```

##### Add Variables to the Script
We recommend adding a section that creates variables for all fields that could be changed to make new configurations, and then replacing the WebArya script with the variable names. The advantage of this is that the script becomes easier to reuse, as you only need to update this portion of script with the new information. If you are not using a credentials file, then you should also add variables for `URL`, `LOGIN`, and `PASSWORD`.
```python
# configuration variables
tenant = 'Heroes'
bridge_domain = 'Hero_Land'
application = 'Save_The_Network'
vlan1 = 'vlan-211'
vlan2 = 'vlan-212'
vlan3 = 'vlan-210'
```

#### APIC Login
The next step is to provide the login information and establish a connection with the APIC. Update the URL, Username, and Password to use your variables from importing credentials.
```python
# log into an APIC and create a directory object
ls = cobra.mit.session.LoginSession(URL, LOGIN, PASSWORD)
md = cobra.mit.access.MoDirectory(ls)
md.login()
```

#### Create Top Level Objects
This section of code is for creating the necessary parent objects. `polUni` is the Root of the tree, and `fvTenant` uses the Root to identify the Tenant object.

Change the Tenant name from **'Heroes'** to use the tenant variable you just created.
```python
# the top level object on which operations will be made
polUni = cobra.model.pol.Uni('')
fvTenant = cobra.model.fv.Tenant(polUni, tenant)
```

#### Create New Configurations
The next major code block is the actual configuration of the Application, `Save_The_Planet`, which needs to have a few fields updated for your new Application, `Save_The_Network`. Although this is all one large block, we break it up to discuss each sub-section's purpose.
>Comments have been added within the code blocks to explain the purpose of each line; you do not need to add these to your file. Comments with `##` are used to indicate that an update is required in the following line.

##### Modify the Application and EPGs
The first line of code will create a new Applicaton Profile, which is the parent object for EPGs. Since the three EPGs you will create belong to the same Application; you only need to create one Application object, and each new EPG will reference this Managed Object.

Change the **name** argument to use the application variable created in the beginning the code.
```python
## the Application name "Save_The_Planet" should be changed to the application variable
fvAp = cobra.model.fv.Ap(fvTenant, ownerKey=u'', name=application, prio=u'unspecified', ownerTag=u'', descr=u'')
```

##### Create the "app" EPG
The first few lines of code can be grouped together as they all relate to the same EPG. The configuration line for creating the new EPG object will not need to be changed since the EPG's name will be the same as the EPG in "Save_The_Planet." Also the EPG is associated to an Application Profile by referencing the object, `fvAP`. As long as that object has been changed, and this was done in the previous step, then the App Profile object will be referencing the new App Profile.

The **encap** and **tnFvBDName** arguments need to be updated to use the vlan1 and bridge_domain variables.
> **Lines that need to be updated will contain a comment beginning with `##`.**

```python
# create the first EPG underneath your new Application.
fvAEPg = cobra.model.fv.AEPg(fvAp, isAttrBasedEPg=u'no', matchT=u'AtleastOne', prio=u'unspecified', name=u'app', descr=u'')

# have the EPG created by the previous line of code consume the "sql" contract.
fvRsCons = cobra.model.fv.RsCons(fvAEPg, tnVzBrCPName=u'sql', prio=u'unspecified')

# assign a VLAN and vPC to the EPG represented by fvAEPg
## the encap should be changed to use the vlan1 variable
fvRsPathAtt = cobra.model.fv.RsPathAtt(fvAEPg, tDn=u'topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2B]', instrImedcy=u'lazy', encap=vlan1, descr=u'', mode=u'regular')

# assign a VLAN and a second vPC to the EPG represented by fvAEPg 
## the encap should be changed to use the vlan1 variable
fvRsPathAtt2 = cobra.model.fv.RsPathAtt(fvAEPg, tDn=u'topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2A]', instrImedcy=u'lazy', encap=vlan1, descr=u'', mode=u'regular')

# creates a relationship between the EPG represented by fvAEPg and a Physical Domain.
# this determines what encapsulation values can be used.
fvRsDomAtt = cobra.model.fv.RsDomAtt(fvAEPg, instrImedcy=u'lazy', resImedcy=u'lazy', encap=u'unknown', tDn=u'uni/phys-Heroes_phys')

# sets the QoS policy for the EPG represented by fvAEPg
fvRsCustQosPol = cobra.model.fv.RsCustQosPol(fvAEPg, tnQosCustomPolName=u'')

# this assigns the Bridge Domain that hosts in fvAEPg will belong to. the Bridge 
# Domain provides a flooding domain and a set of subnets the hosts can belong to.
## the Bridge Domain name should be changed from "Hero_Land" to the bridge_domain variable
fvRsBd = cobra.model.fv.RsBd(fvAEPg, tnFvBDName=bridge_domain)

# have the EPG represented by the fvAEPg object provide the "power_up" contract
fvRsProv = cobra.model.fv.RsProv(fvAEPg, tnVzBrCPName=u'power_up', matchT=u'AtleastOne', prio=u'unspecified')
```

##### Create the "db" EPG
The Next few lines of code are very similar to the previous block, but each object name is slightly different to create a new instance of the object type.

The **encap** and **tnFvBDName** arguments need to be updated to use the vlan2 and bridge_domain variables.
> **Lines that need to be updated will contain a comment beginning with `##`.**

```python
# creates a new EPG object represented by the name fvAEPg2
fvAEPg2 = cobra.model.fv.AEPg(fvAp, isAttrBasedEPg=u'no', matchT=u'AtleastOne', prio=u'unspecified', name=u'db', descr=u'')

# assign a VLAN and vPC to the EPG represented by fvAEPg2
## the encap should be changed to use the vlan2 variable
fvRsPathAtt3 = cobra.model.fv.RsPathAtt(fvAEPg2, tDn=u'topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2B]', instrImedcy=u'lazy', encap=vlan2, descr=u'', mode=u'regular')

# assign a VLAN and a second vPC to the EPG represented by fvAEPg2
## the encap should be changed to use the vlan2 variable"
fvRsPathAtt4 = cobra.model.fv.RsPathAtt(fvAEPg2, tDn=u'topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2A]', instrImedcy=u'lazy', encap=vlan2, descr=u'', mode=u'regular')

# creates a relationship between the EPG represented by fvAEPg2 and a Physical Domain.
fvRsDomAtt2 = cobra.model.fv.RsDomAtt(fvAEPg2, instrImedcy=u'lazy', resImedcy=u'lazy', encap=u'unknown', tDn=u'uni/phys-Heroes_phys')

# sets the QoS policy for the EPG represented by fvAEPg2
fvRsCustQosPol2 = cobra.model.fv.RsCustQosPol(fvAEPg2, tnQosCustomPolName=u'')

# this assigns the Bridge Domain that hosts in the fvAEPg2 will belong to
## the Bridge Domain name should be changed from "Hero_Land" to the bridge_domain variable
fvRsBd2 = cobra.model.fv.RsBd(fvAEPg2, tnFvBDName=bridge_domain)

# have the EPG represented by the fvAEPg2 object provide the "sql" contract
fvRsProv2 = cobra.model.fv.RsProv(fvAEPg2, tnVzBrCPName=u'sql', matchT=u'AtleastOne', prio=u'unspecified')
```

##### Create the "web" EPG
The Next few lines of code are also very similar to the previous block, but each object name is slightly different to create a new instance of the object type.

The **encap** and **tnFvBDName** arguments need to be updated to use the vlan3 and bridge_domain variables.
> **Lines that need to be updated will contain a comment beginning with `##`.**

```python
# creates a new EPG object represented by the name fvAEPg3
fvAEPg3 = cobra.model.fv.AEPg(fvAp, isAttrBasedEPg=u'no', matchT=u'AtleastOne', prio=u'unspecified', name=u'web', descr=u'')

# have the EPG created by the previous line of code consume the "sql" contract.
fvRsCons2 = cobra.model.fv.RsCons(fvAEPg3, tnVzBrCPName=u'sql', prio=u'unspecified')

# assign a VLAN and vPC to the EPG represented by fvAEPg3
## the encap should be changed to use the vlan3 variable 
fvRsPathAtt5 = cobra.model.fv.RsPathAtt(fvAEPg3, tDn=u'topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2B]', instrImedcy=u'lazy', encap=vlan3, descr=u'', mode=u'regular')

# assign a VLAN and a second vPC to the EPG represented by fvAEPg3
## the encap should be changed to use the vlan3 variable
fvRsPathAtt6 = cobra.model.fv.RsPathAtt(fvAEPg3, tDn=u'topology/pod-1/protpaths-101-102/pathep-[Heroes_FI-2A]', instrImedcy=u'lazy', encap=vlan3, descr=u'', mode=u'regular')

# creates a relationship between the EPG represented by fvAEPg3 and a Physical Domain.
fvRsDomAtt3 = cobra.model.fv.RsDomAtt(fvAEPg3, instrImedcy=u'lazy', resImedcy=u'lazy', encap=u'unknown', tDn=u'uni/phys-Heroes_phys')

# sets the QoS policy for the EPG represented by fvAEPg3
fvRsCustQosPol3 = cobra.model.fv.RsCustQosPol(fvAEPg3, tnQosCustomPolName=u'')

# this assigns the Bridge Domain that hosts in the fvAEPg3 will belong to
## the Bridge Domain name should be changed from "Hero_Land" to the bridge_domain variable
fvRsBd3 = cobra.model.fv.RsBd(fvAEPg3, tnFvBDName=bridge_domain)

# have the EPG represented by the fvAEPg3 object provide the "web" contract
fvRsProv3 = cobra.model.fv.RsProv(fvAEPg3, tnVzBrCPName=u'web', matchT=u'AtleastOne', prio=u'unspecified')
```

#### Commit the Configuration
The final piece is to submit the configuration changes to the APIC. This is done by creating a config request, adding the top level object to the request, and commiting the changes.
```python
# commit the generated code to APIC
print toXMLStr(fvTenant)
c = cobra.mit.request.ConfigRequest()
c.addMo(fvTenant)
md.commit(c)
```

Make sure to save the file after you finish making all the changes. The final script can also be found in the sample code repo as add_application.py.