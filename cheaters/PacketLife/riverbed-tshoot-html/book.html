<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Troubleshooting Riverbed® Steelhead® WAN Optimizers</title><link rel="stylesheet" type="text/css" href="docbook.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><meta name="description" content='General: All rights reserved. This book may be distributed outside Riverbed to Riverbed customers via the Riverbed Support website. Except for the foregoing, no part of this book may be further redistributed, reproduced or transmitted in any form or by any means, electronic or mechanical, including photocopying, recording, or by any information storage and retrieval system, without written permission from Riverbed Technology, Inc.. Warning and disclaimer: This book provides foundational information about the troubleshooting of the Riverbed WAN optimization implementation and appliances. Every effort has been made to make this book as complete and accurate as possible, but no warranty or fitness is implied. The information is provided on as "as is" basis. The author and Riverbed Technology shall have neither liability nor responsibility to any person or entity with respect to any loss or damages arising from the information contained in this book. The opinions expressed in this book belong to the author and are not necessarily those of Riverbed Technology. Riverbed and any Riverbed product or service name or logo used herein are trademarks of Riverbed Technology, Inc. All other trademarks used herein belong to their respetive owners. Feedback Information: If you have any comments regarding how the quality of this book could be improved, please contact the author. He can be reached via email at edwin.groothuis@riverbed.com or at steelhead-troubleshooting@mavetju.org, his personal website can be found at http://www.mavetju.org/.'></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="idp29061288"></a>
	Troubleshooting
	<span class="trademark">Riverbed</span>®
	<span class="trademark">Steelhead</span>®
	WAN Optimizers
    </h1></div><div><div class="author"><h3 class="author"><span class="firstname">Edwin</span> <span class="surname">Groothuis</span></h3><div class="affiliation"><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:edwin.groothuis@riverbed.com">edwin.groothuis@riverbed.com</a>&gt;</code></p></div></div></div></div><div><p class="copyright">Copyright © 2011, 2012, 2013, 2014 Riverbed Technology, Inc</p></div><div><p class="pubdate">
      Mon 19 May 2014 10:57:33
    </p></div><div><div class="abstract"><p class="title"><b>Abstract</b></p><p>General:</p><p>
    All rights reserved.
  </p><p>
    This book may be distributed outside Riverbed to Riverbed
    customers via the Riverbed Support website.
    Except for the foregoing, no part of this book may be further
    redistributed, reproduced or transmitted in any form or by any
    means, electronic or mechanical, including photocopying,
    recording, or by any information storage and retrieval system,
    without written permission from Riverbed Technology, Inc..
  </p><p>
    Warning and disclaimer:
  </p><p>
    This book provides foundational information about the troubleshooting
    of the Riverbed WAN optimization implementation and appliances.
    Every effort has been made to make this book as complete and
    accurate as possible, but no warranty or fitness is implied.
  </p><p>
    The information is provided on as "as is" basis. The author and
    Riverbed Technology shall have neither liability nor responsibility
    to any person or entity with respect to any loss or damages
    arising from the information contained in this book.
  </p><p>
    The opinions expressed in this book belong to the author and are
    not necessarily those of Riverbed Technology.
  </p><p>
    Riverbed and any Riverbed product or service name or logo used
    herein are trademarks of Riverbed Technology, Inc. All other
    trademarks used herein belong to their respetive owners.
  </p><p>
    Feedback Information:
  </p><p>
    If you have any comments regarding how the quality of this book
    could be improved, please contact the author. He can be reached
    via email at edwin.groothuis@riverbed.com or at
    steelhead-troubleshooting@mavetju.org, his personal website can
    be found at http://www.mavetju.org/.
  </p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#idp32148072">Preface</a></span></dt><dt><span class="chapter"><a href="#Introduction_to_WAN_Optimization">1. Introduction to WAN Optimization</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp32165800">1.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp32170920">1.2. Why WAN optimization?</a></span></dt><dt><span class="sect1"><a href="#idp32215080">1.3. Three different optimization methods</a></span></dt><dt><span class="sect1"><a href="#idp32357928">1.4. Effects of WAN optimization on other equipment</a></span></dt></dl></dd><dt><span class="chapter"><a href="#The_Riverbed_Approach_to_WAN_Optimization">2. The Riverbed Approach to WAN Optimization</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp32383656">2.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp32503272">2.2. Appliance Setup</a></span></dt><dt><span class="sect1"><a href="#idp32684712">2.3. Basic configuration of a Steelhead appliance</a></span></dt><dt><span class="sect1"><a href="#idp32734184">2.4. The layout of an optimized TCP session</a></span></dt><dt><span class="sect1"><a href="#idp32748456">2.5. The setup of an optimized TCP session.</a></span></dt><dt><span class="sect1"><a href="#idp32796648">2.6. WAN Visibility</a></span></dt><dt><span class="sect1"><a href="#idp32801192">2.7. The optimization protocol</a></span></dt><dt><span class="sect1"><a href="#idp32809768">2.8. Hardware models</a></span></dt></dl></dd><dt><span class="chapter"><a href="#The_Command_Line_and_Tools">3. The Command Line and Tools</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp34301800">3.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp34441064">3.2. Dealing with the Command Line Interface</a></span></dt><dt><span class="sect1"><a href="#idp34724456">3.3. Tcpdump, the network packet capture tool</a></span></dt><dt><span class="sect1"><a href="#idp35271976">3.4. Tcpdump-x</a></span></dt><dt><span class="sect1"><a href="#idp35419368">3.5. Ping</a></span></dt><dt><span class="sect1"><a href="#idp35709800">3.6. Traceroute</a></span></dt><dt><span class="sect1"><a href="#tools_telnet">3.7. Telnet</a></span></dt><dt><span class="sect1"><a href="#idp36087912">3.8. Tproxytrace</a></span></dt><dt><span class="sect1"><a href="#idp36152488">3.9. Nettest</a></span></dt><dt><span class="sect1"><a href="#idp36188264">3.10. SSL connect</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Installation_Related_Issues">4. Installation Related Issues</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp36378984">4.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp36416424">4.2. Installation steps for fail-to-wire scenarios</a></span></dt><dt><span class="sect1"><a href="#idp36448616">4.3. Fail-to-Wire</a></span></dt><dt><span class="sect1"><a href="#install_cables">4.4. Cables</a></span></dt><dt><span class="sect1"><a href="#idp36759848">4.5. Network Interface Card speed issues</a></span></dt><dt><span class="sect1"><a href="#idp36871592">4.6. IP Subnet configuration related issues</a></span></dt><dt><span class="sect1"><a href="#idp36990248">4.7. Wrong location</a></span></dt><dt><span class="sect1"><a href="#idp37075432">4.8. In-path support on interface not enabled</a></span></dt><dt><span class="sect1"><a href="#idp37083496">4.9. Port security</a></span></dt><dt><span class="sect1"><a href="#idp37124008">4.10. Link State Propagation (LSP)</a></span></dt><dt><span class="sect1"><a href="#idp37200936">4.11. VPN Concentrators</a></span></dt><dt><span class="sect1"><a href="#idp37211432">4.12. Licenses</a></span></dt><dt><span class="sect1"><a href="#idp37515752">4.13. LAN and WAN cable switched</a></span></dt><dt><span class="sect1"><a href="#idp37531560">4.14. After an RMA</a></span></dt><dt><span class="sect1"><a href="#idp37550120">4.15. Best cabling for remote management</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Operation_Related_Issues">5. Operation Related Issues</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp37556904">5.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp37571432">5.2. Hardware related issues</a></span></dt><dt><span class="sect1"><a href="#idp37848232">5.3. Admission Control</a></span></dt><dt><span class="sect1"><a href="#idp38032616">5.4. Auto-negotiation and duplex issues</a></span></dt><dt><span class="sect1"><a href="#idp38093160">5.5. LAN speed maxed out</a></span></dt><dt><span class="sect1"><a href="#idp38120296">5.6. Watchdogs</a></span></dt><dt><span class="sect1"><a href="#idp38158312">5.7. Unexpected restarts of the optimization service</a></span></dt><dt><span class="sect1"><a href="#idp38221352">5.8. Unexpected reboots</a></span></dt><dt><span class="sect1"><a href="#operation_downgradenandupgradeissues">5.9. Downgrade and upgrade issues</a></span></dt><dt><span class="sect1"><a href="#idp38459560">5.10. Time related issues - The NTP service.</a></span></dt><dt><span class="sect1"><a href="#idp39004072">5.11. Firewalls in the path</a></span></dt><dt><span class="sect1"><a href="#idp39007464">5.12. Data Store Synchronization</a></span></dt><dt><span class="sect1"><a href="#idp39010408">5.13. Data store related errors</a></span></dt><dt><span class="sect1"><a href="#idp39025960">5.14. WCCP issues</a></span></dt><dt><span class="sect1"><a href="#operation_asymmetricrouting">5.15. Asymmetric Routing</a></span></dt><dt><span class="sect1"><a href="#operation_iproutingrelatedissues">5.16. IP Routing Related Issues</a></span></dt><dt><span class="sect1"><a href="#idp39062632">5.17. Alarms and health status</a></span></dt><dt><span class="sect1"><a href="#idp39167848">5.18. Long lived TCP session treatment</a></span></dt><dt><span class="sect1"><a href="#idp39182312">5.19. Order of the in-path rules</a></span></dt><dt><span class="sect1"><a href="#idp39188520">5.20. Network monitoring and network management systems</a></span></dt><dt><span class="sect1"><a href="#idp39191912">5.21. Web proxies and web caches</a></span></dt><dt><span class="sect1"><a href="#idp39193768">5.22. Security</a></span></dt><dt><span class="sect1"><a href="#idp39325608">5.23. The Riverbed Services Platform</a></span></dt><dt><span class="sect1"><a href="#idp39338856">5.24. Access related problems</a></span></dt><dt><span class="sect1"><a href="#idp39364200">5.25. Partitions running out of space</a></span></dt><dt><span class="sect1"><a href="#idp39401448">5.26. Memory usage on the Steelhead appliance</a></span></dt><dt><span class="sect1"><a href="#idp39398248">5.27. LAN side traffic is seen on the Steelhead appliance</a></span></dt><dt><span class="sect1"><a href="#idp39411048">5.28. Service Error</a></span></dt><dt><span class="sect1"><a href="#idp39470184">5.29. Can this application be optimized?</a></span></dt><dt><span class="sect1"><a href="#idp39473832">5.30. Interceptor cluster related issues</a></span></dt><dt><span class="sect1"><a href="#idp39489768">5.31. Expiring SSL certificates</a></span></dt><dt><span class="sect1"><a href="#idp39491048">5.32. High CPU related issues</a></span></dt><dt><span class="sect1"><a href="#idp39508712">5.33. Central Management Console related issues</a></span></dt></dl></dd><dt><span class="chapter"><a href="#System_Dump">6. System Dump</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp39518760">6.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp39543848">6.2. Creation of a system dump</a></span></dt><dt><span class="sect1"><a href="#idp39549096">6.3. Configuration of the system</a></span></dt><dt><span class="sect1"><a href="#idp39560552">6.4. Log files</a></span></dt><dt><span class="sect1"><a href="#systemdump_hardwareinformation">6.5. Hardware Information</a></span></dt><dt><span class="sect1"><a href="#idp39731240">6.6. System Information</a></span></dt><dt><span class="sect1"><a href="#idp39864424">6.7. Simplified Routing related files</a></span></dt><dt><span class="sect1"><a href="#idp39876328">6.8. ATA controller SMART data</a></span></dt><dt><span class="sect1"><a href="#idp39878312">6.9. Asymmetric routing table</a></span></dt><dt><span class="sect1"><a href="#idp39882152">6.10. The Image History file</a></span></dt><dt><span class="sect1"><a href="#idp39887592">6.11. The file "lsof"</a></span></dt><dt><span class="sect1"><a href="#idp39890600">6.12. Memory dump of the process sport</a></span></dt><dt><span class="sect1"><a href="#idp39894440">6.13. Out-of-memory profiling</a></span></dt><dt><span class="sect1"><a href="#idp39896360">6.14. CIFS pre-population related data</a></span></dt><dt><span class="sect1"><a href="#idp39899944">6.15. RSP related data</a></span></dt><dt><span class="sect1"><a href="#idp39903656">6.16. SAR statistics</a></span></dt><dt><span class="sect1"><a href="#idp39904616">6.17. Active Directory Integration</a></span></dt><dt><span class="sect1"><a href="#idp39907432">6.18. Process dumps</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Different_Network_Troubleshooting_Scenarios">7. Different Network Troubleshooting Scenarios</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp39911336">7.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp39912872">7.2. Traffic is blocked when the Steelhead appliance goes in by-pass.</a></span></dt><dt><span class="sect1"><a href="#idp39915688">7.3. Traffic is not optimized between two sites.</a></span></dt><dt><span class="sect1"><a href="#idp39961000">7.4. An optimized TCP Session gets reset or hangs</a></span></dt><dt><span class="sect1"><a href="#idp39965544">7.5. Slow network</a></span></dt><dt><span class="sect1"><a href="#idp40002408">7.6. Connection-based Admission Control</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Latency_Optimization">8. Latency Optimization</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp40016680">8.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp39999208">8.2. Introduction to Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40009192">8.3. CIFS Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40041640">8.4. CIFS Pre-population</a></span></dt><dt><span class="sect1"><a href="#idp40078696">8.5. NFS Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40069416">8.6. MAPI Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40080616">8.7. Windows Active Directory integration</a></span></dt><dt><span class="sect1"><a href="#idp40099816">8.8. MS-SQL Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40100584">8.9. FTP Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#latencyoptimization_httplatencyoptimization">8.10. HTTP Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40174824">8.11. SSL Pre-optimization</a></span></dt><dt><span class="sect1"><a href="#idp40185896">8.12. SCA Latency Optimization</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Logging">9. Logging</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp40231848">9.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp40232872">9.2. Logging format</a></span></dt><dt><span class="sect1"><a href="#idp40238504">9.3. TCP Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40284264">9.4. OOB Splice and Connection Pool</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Further_help_and_support">10. Further help and support</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp40290472">10.1. Riverbed websites</a></span></dt><dt><span class="sect1"><a href="#idp40293672">10.2. Documentation</a></span></dt><dt><span class="sect1"><a href="#idp40294696">10.3. Riverbed TAC</a></span></dt></dl></dd><dt><span class="appendix"><a href="#Jargon">A. Jargon</a></span></dt><dt><span class="appendix"><a href="#Troubleshooting_workflow_for_network_performance_related_issues">B. Troubleshooting workflow for network performance related issues</a></span></dt><dd><dl><dt><span class="sect1"><a href="#idp40350120">B.1. Step One: Does the TCP session get optimized?</a></span></dt><dt><span class="sect1"><a href="#idp40394664">B.2. Step Two: Does TCP optimization and data reduction work?</a></span></dt><dt><span class="sect1"><a href="#idp40401832">B.3. Step Three: Does latency optimization work</a></span></dt></dl></dd></dl></div><div class="list-of-figures"><p><b>List of Figures</b></p><dl><dt>1.1. <a href="#idp32201768">Serialization delay</a></dt><dt>1.2. <a href="#idp32232360">A typical Ethernet frame</a></dt><dt>1.3. <a href="#idp32253864">Bytes in-flight over time.</a></dt><dt>1.4. <a href="#idp32256168">Retransmission due to a time out in the acknowledgement</a></dt><dt>1.5. <a href="#idp32261096">Retransmission due to time out</a></dt><dt>1.6. <a href="#idp32362280">LAN/WAN bandwidth comparisons</a></dt><dt>1.7. <a href="#idp32365864">Traffic pattern on the client-side LAN side.</a></dt><dt>1.8. <a href="#idp32371688">Disk load on the server.</a></dt><dt>1.9. <a href="#idp32374440">Traffic pattern on the server-side LAN side.</a></dt><dt>2.1. <a href="#idp32550120">Back of a Steelhead appliance</a></dt><dt>2.2. <a href="#idp32624936">Ethernet links in normal operation, fail-to-wire and fail-to-block.</a></dt><dt>2.3. <a href="#idp32719656">Management via both the primary and auxiliary interfaces</a></dt><dt>2.4. <a href="#idp32735336">Three independent TCP sessions</a></dt><dt>2.5. <a href="#idp32749608">The setup of a normal TCP session without Steelhead appliances</a></dt><dt>2.6. <a href="#idp32751144">The setup of a normal TCP session seen by Steelhead appliances </a></dt><dt>2.7. <a href="#idp32757672">Setup of a new OOB Splice</a></dt><dt>2.8. <a href="#idp32772904">Termination of an OOB Splice due to admission control</a></dt><dt>2.9. <a href="#idp32775976">Termination of the Connection Pool because of the loss of the OOB Splice</a></dt><dt>2.10. <a href="#idp32780392">In-path rules on a Steelhead appliance.</a></dt><dt>2.11. <a href="#idp32782184">Additional fixed target in-path rule on a Steelhead appliance.</a></dt><dt>2.12. <a href="#idp32784680">The setup of an optimized TCP session using Fixed Target rules.</a></dt><dt>2.13. <a href="#idp32790760">The setup of an optimized TCP session using the default auto-discovery process</a></dt><dt>2.14. <a href="#idp32792552">The setup of an optimized TCP session using the enhanced auto-discovery process</a></dt><dt>2.15. <a href="#idp32794792">Peering rules on a Steelhead appliance.</a></dt><dt>2.16. <a href="#idp32799784">Tcpdump output showing the Transparency TCP options</a></dt><dt>3.1. <a href="#idp34407656">The network diagram</a></dt><dt>3.2. <a href="#idp34451624">Setup of an SSH session to the CLI of the Steelhead appliance</a></dt><dt>3.3. <a href="#idp34462760">Setup of an SSH session to the CLI of a replaced Steelhead appliance</a></dt><dt>3.4. <a href="#idp34518184">Download of a system dump via SCP</a></dt><dt>3.5. <a href="#idp34519528">Attempt to access a non-permitted directory</a></dt><dt>3.6. <a href="#idp34911080">The Riverbed specific TCP options not decoded in tcpdump before RiOS 6.1.4 and 6.5.2</a></dt><dt>3.7. <a href="#idp34913640">The Riverbed specific TCP options for auto-discovery decoded in tcpdump after RiOS 6.1.4 and 6.5.2</a></dt><dt>3.8. <a href="#idp34941160">The Riverbed specific TCP options for WAN Visibility Transparency feature decoded in tcpdump after RiOS 6.1.4 and 6.5.2</a></dt><dt>3.9. <a href="#idp34969064">The Riverbed specific TCP options decoded in tshark</a></dt><dt>3.10. <a href="#idp34972712">The Riverbed specific TCP options decoded in Wireshark</a></dt><dt>3.11. <a href="#idp35034792">Display the first ten packets from and to a certain host</a></dt><dt>3.12. <a href="#idp35039720">Display the first ten packets between hosts 10.0.1.1 and 192.168.1.1</a></dt><dt>3.13. <a href="#idp35043752">A normal 802.3 Ethernet frame</a></dt><dt>3.14. <a href="#idp35050984">An 802.1Q VLAN Ethernet frame</a></dt><dt>3.15. <a href="#idp35068584">Display the first ten packets between host 10.0.1.1 and host 192.168.1.1</a></dt><dt>3.16. <a href="#idp35071720">Capture all traffic for all ICMP traffic from and to host 10.0.1.1</a></dt><dt>3.17. <a href="#idp35074984">Capture all traffic from and to host 10.0.1.1 on port 443</a></dt><dt>3.18. <a href="#idp35200744">Tcpdump filter for all Ethernet broadcast traffic</a></dt><dt>3.19. <a href="#idp35230184">Incorrect TCP checksum messages because of TCP checksum offloading</a></dt><dt>3.20. <a href="#idp35256552">Wireshark showing larger than MSS size TCP packets</a></dt><dt>3.21. <a href="#idp35263464">Output of the command "show interface inpathX_X gso"</a></dt><dt>3.22. <a href="#idp35407784">Examples for using tcpdump-x</a></dt><dt>3.23. <a href="#idp35551848">Ping a host via the primary interface</a></dt><dt>3.24. <a href="#idp35558696">Ping a host via the in-path interface</a></dt><dt>3.25. <a href="#idp35562728">IP address 10.0.1.4 is not in use on this local IP subnet</a></dt><dt>3.26. <a href="#idp35628392">IP address 192.168.1.1 didn't reply.</a></dt><dt>3.27. <a href="#idp35637224">ICMP packets 3 to 5 and 8 to 9 didn't get answered.</a></dt><dt>3.28. <a href="#idp35680680">ICMP based MTU size detection - MTU of 1500 bytes</a></dt><dt>3.29. <a href="#idp35700584">ICMP based MTU size detection - MTU of 1492 bytes</a></dt><dt>3.30. <a href="#idp35727336">WAN router receives packet via a different path than it send it</a></dt><dt>3.31. <a href="#idp35812072">The command to traceroute to a remote host via the primary interface</a></dt><dt>3.32. <a href="#idp35824808">Traceroute to a remote host via an in-path interface</a></dt><dt>3.33. <a href="#idp35829352">Determining the MTU size with the --mtu option</a></dt><dt>3.34. <a href="#idp35855400">Successful traceroute between two hosts</a></dt><dt>3.35. <a href="#idp35861544">Failed traceroute due to MTU size issues</a></dt><dt>3.36. <a href="#idp35887528">Missing reply for hop three.</a></dt><dt>3.37. <a href="#idp35898664">Missing reply for hop three and following.</a></dt><dt>3.38. <a href="#idp35903528">Network Unreachable response</a></dt><dt>3.39. <a href="#idp35949864">Missing reply for the latest hop.</a></dt><dt>3.40. <a href="#idp35957416">Host Unreachable response</a></dt><dt>3.41. <a href="#idp35960424">Hop 4 has multiple outgoing interfaces</a></dt><dt>3.42. <a href="#idp35986152">Successful TCP session setup via the primary interface</a></dt><dt>3.43. <a href="#idp35998952">Successful TCP session setup via the in-path interface</a></dt><dt>3.44. <a href="#idp36018408">Telnet attempt to a host which does not exist</a></dt><dt>3.45. <a href="#idp36038120">Telnet attempt to a host which does not exist</a></dt><dt>3.46. <a href="#idp36080232">Telnet attempt to a host with no service listening on port 139</a></dt><dt>3.47. <a href="#idp36119336">Tproxytrace to a host via the primary interface</a></dt><dt>3.48. <a href="#idp36120232">Tproxytrace to a host via the in-path interface</a></dt><dt>3.49. <a href="#idp36163432">Output of a peer reachability test</a></dt><dt>3.50. <a href="#idp36165992">Capture of a peer reachability test</a></dt><dt>3.51. <a href="#idp36170856">Output of a net gateway test</a></dt><dt>3.52. <a href="#idp36173160">Output of a duplex test</a></dt><dt>3.53. <a href="#idp36184936">Output of the IP Port reachability test</a></dt><dt>3.54. <a href="#idp36186600">Capture of the IP Port reachability test</a></dt><dt>3.55. <a href="#idp36215592">Usage of the ssl-connect command</a></dt><dt>4.1. <a href="#idp36421928">Disable LSP during installation of a new Steelhead appliance</a></dt><dt>4.2. <a href="#idp36463400">Inpath0_0 is operational and set to fail-to-wire</a></dt><dt>4.3. <a href="#idp36681832">Configuring interface wan0_0 with MDI-x</a></dt><dt>4.4. <a href="#idp36702440">VLAN bridge to overcome fixed speed/duplex settings</a></dt><dt>4.5. <a href="#idp36778216">The output of "show interfaces primary"</a></dt><dt>4.6. <a href="#idp36851816">Interface set for auto-negotiation but coming up as half-duplex</a></dt><dt>4.7. <a href="#idp36864872">Interface set for fixed speed but with a lot of RX/TX errors</a></dt><dt>4.8. <a href="#idp36880488">ARP requests are coming from IP subnet 192.168.2.0/24</a></dt><dt>4.9. <a href="#idp36896296">SMB broadcast packets are coming from IP subnet 192.168.2.0/24</a></dt><dt>4.10. <a href="#idp36899368">OSPF broadcast and unicast packets and coming from IP subnet 192.168.170.0/24</a></dt><dt>4.11. <a href="#idp36907560">Ping the in-path interface IP address from the default gateway</a></dt><dt>4.12. <a href="#idp36944616">Tcpdump running for a ping from the Steelhead appliance </a></dt><dt>4.13. <a href="#idp36962536">Remove the IP address of inpath0_1 via the CLI</a></dt><dt>4.14. <a href="#idp36977512">Duplicate IP addresses on the in-path interfaces</a></dt><dt>4.15. <a href="#idp36991528">Steelhead appliance by-passed with a cable.</a></dt><dt>4.16. <a href="#idp37039272">Run these tcpdump commands</a></dt><dt>4.17. <a href="#idp37077992">No optimization support for inpath0_1</a></dt><dt>4.18. <a href="#idp37082344">Enabled in-path interfaces for optimization</a></dt><dt>4.19. <a href="#idp37117800">Port security show commands</a></dt><dt>4.20. <a href="#idp37121768">Port security configuration commands</a></dt><dt>4.21. <a href="#idp37132904">Compare the "Up" status to see which interface was brought down.</a></dt><dt>4.22. <a href="#idp37202664">Wrong location of the VPN concentrator</a></dt><dt>4.23. <a href="#idp37208168">Correct location of the VPN concentrator</a></dt><dt>4.24. <a href="#idp37501928">Automatic fetching of licenses at the startup of a new CX series model</a></dt><dt>4.25. <a href="#idp37506408">Failure of automatic fetching because of a DNS related failure</a></dt><dt>4.26. <a href="#idp37510504">Manual update of the licenses with "license autolicense fetch"</a></dt><dt>4.27. <a href="#idp37523688">Three CLI sessions for troubleshooting</a></dt><dt>4.28. <a href="#idp37528424">ICMP Echo Request and Echo Reply show up on the WAN interface.</a></dt><dt>4.29. <a href="#idp37553896">Cabling for remote management</a></dt><dt>4.30. <a href="#idp37554856">Configuration for routing towards remote management system via the auxiliary interface</a></dt><dt>5.1. <a href="#idp37578728">Grep for "Attached SCSI disk" in the bootlogs</a></dt><dt>5.2. <a href="#idp37650600">Output of the command "show raid diagram" on a 2050 model</a></dt><dt>5.3. <a href="#idp37701288">Output of the command "show raid diagram" on a model 5050 model</a></dt><dt>5.4. <a href="#idp37726056">Output of the command "raid swraid mdstat" on a 5050 model</a></dt><dt>5.5. <a href="#idp37758568">A Failing disk in the system logs</a></dt><dt>5.6. <a href="#idp37762088">Output of the command "show stats fan" on the 100 / 200 / 300 models</a></dt><dt>5.7. <a href="#idp37763368">Output of the command "show stats fan" on the 520 / 1020 / 1520 / 2020 models</a></dt><dt>5.8. <a href="#idp37764456">Output of the command "show stats fan" on the 3020 / 3520 / 5520 / 6020 / 6120 models</a></dt><dt>5.9. <a href="#idp37766824">Output of the command "show stats fan" on the 150 / 250 / 550 / 555 / 755 models</a></dt><dt>5.10. <a href="#idp37769192">Output of the command "show stats fan" on the 1050 / 2050 models</a></dt><dt>5.11. <a href="#idp37771112">Output of the command "show stats fan" on the 5050 / 6050 / 7050 models</a></dt><dt>5.12. <a href="#idp37772968">Output of the command "show stats fan" on the CX255 model</a></dt><dt>5.13. <a href="#idp37783656">Output of the command "show stats fan" on the CX555 / CX755 model</a></dt><dt>5.14. <a href="#idp37785192">Output of the command "show stats fan" on the CX5055 / CX7055 model</a></dt><dt>5.15. <a href="#idp37787688">Output of the command "show stats fan" on the DX8000 model</a></dt><dt>5.16. <a href="#idp37805096">Output of the command "show stats fan" on the EX560 / EX760 model</a></dt><dt>5.17. <a href="#idp37806120">Output of the command "show stats fan" on the EX1160 model</a></dt><dt>5.18. <a href="#idp37823336">Output of the command "show stats fan" on the EX1260 / EX1360 model</a></dt><dt>5.19. <a href="#idp37825448">Output of the command "show stats ecc-ram"</a></dt><dt>5.20. <a href="#idp37853928">Output of the command "show admission" for a model 560L</a></dt><dt>5.21. <a href="#idp37856104">Determining the admission control values via the system dump</a></dt><dt>5.22. <a href="#idp37858728">Connection-based admission control for a 250H model</a></dt><dt>5.23. <a href="#idp37867752">Check the list of TCP sessions to find the host which uses the most</a></dt><dt>5.24. <a href="#idp37870504">Get the list of TCP sessions for one specific host</a></dt><dt>5.25. <a href="#idp37884008">Output of the command "show admission internal"</a></dt><dt>5.26. <a href="#idp37894568">Optimizaiton service going into TCP Memory Pressure based admission control</a></dt><dt>5.27. <a href="#idp37930344">Non-zero receive queues and non-zero send queues</a></dt><dt>5.28. <a href="#idp37976936">Wireshark I/O graph for a 1 Mbps optimized WAN bandwidth limit</a></dt><dt>5.29. <a href="#idp37987112">Wireshark TCP graph for a 1 Mbps optimized WAN bandwidth limit</a></dt><dt>5.30. <a href="#idp37990248">Optimized Throughput graph for a 1 Mbps optimized WAN bandwidth limit</a></dt><dt>5.31. <a href="#idp38050600">Ping through a clean network</a></dt><dt>5.32. <a href="#idp38060712">Ping through a network with speed/duplex setting issues</a></dt><dt>5.33. <a href="#idp38085416">Ping flood on a relative clean path in the network</a></dt><dt>5.34. <a href="#idp38090856">Ping flood on a path with duplex configuration or negotiation issues.</a></dt><dt>5.35. <a href="#idp38097000">LAN bandwidth is more than 10 Mbps</a></dt><dt>5.36. <a href="#idp38125736">The wdt process is too slow</a></dt><dt>5.37. <a href="#idp38136616">The optimization service is too slow</a></dt><dt>5.38. <a href="#idp38139944">The optimization service has hung threads </a></dt><dt>5.39. <a href="#idp38189928">Proper restart of the optimization service</a></dt><dt>5.40. <a href="#idp38205160">Optimization service restart because of an assertion failure</a></dt><dt>5.41. <a href="#idp38217832">Optimization service restart because of a process failure</a></dt><dt>5.42. <a href="#idp38224552">Reboot caused by a kernel panic</a></dt><dt>5.43. <a href="#idp38226728">Enabling the crash kernel feature</a></dt><dt>5.44. <a href="#idp38249768">This device was rebooted because of loss of power.</a></dt><dt>5.45. <a href="#idp38266024">The watchdog interval was larger than expected.</a></dt><dt>5.46. <a href="#idp38294312">This device was rebooted by the hardware watchdog.</a></dt><dt>5.47. <a href="#idp38298536">Determining reboots based on the IPMI logs</a></dt><dt>5.48. <a href="#idp38330792">Output of "show version history": Upgrade to 6.1.5, then downgrade to 6.1.4</a></dt><dt>5.49. <a href="#idp38360104">Manual upgrade via the CLI, new image installed on partition 1</a></dt><dt>5.50. <a href="#idp38372136">Downgrade was unsuccessful</a></dt><dt>5.51. <a href="#idp38408552">Various upgrade failure scenarios</a></dt><dt>5.52. <a href="#idp38462312">The standard NTP service configuration</a></dt><dt>5.53. <a href="#idp38465384">Status of the NTP service with the command "show ntp status"</a></dt><dt>5.54. <a href="#idp38558120">Tcpdump trace for NTP traffic</a></dt><dt>5.55. <a href="#idp38559016">Tcpdump trace for NTP traffic</a></dt><dt>5.56. <a href="#idp39002984">Manual adjusting the date/time with the command "ntpdate"</a></dt><dt>5.57. <a href="#idp39005096">The TCP session goes into pass-through after the third SYN from the client</a></dt><dt>5.58. <a href="#idp39006120">Setup of an inner channel with Full Transparency with Firewall Reset WAN visibility</a></dt><dt>5.59. <a href="#idp39007784">Data Store Synchronization can be used in various designs</a></dt><dt>5.60. <a href="#idp39009832">Data Store Synchronization catching up after a restart</a></dt><dt>5.61. <a href="#idp39011688">Duplicate data store ID warnings from a former data store synchronization cluster node</a></dt><dt>5.62. <a href="#idp39012904">Duplicate data store ID warning in a data store synchronization cluster</a></dt><dt>5.63. <a href="#idp39013480">Prevent optimization from the data store synchronization peer 192.168.1.7</a></dt><dt>5.64. <a href="#idp39014568">Detection of duplicate labels</a></dt><dt>5.65. <a href="#idp39024040">Detection of duplicate labels</a></dt><dt>5.66. <a href="#idp39025448">Use of the command "service error reset"</a></dt><dt>5.67. <a href="#idp39026280">A WCCP setup</a></dt><dt>5.68. <a href="#idp39027752">Tcpdump of WCCP traffic</a></dt><dt>5.69. <a href="#idp39028520">Tcpdump of WCCP traffic</a></dt><dt>5.70. <a href="#idp39029864">Tcpdump of WCCP traffic</a></dt><dt>5.71. <a href="#idp39031464">Tcpdump shows that the WCCP router is not forwarding packets to the WCCP cache</a></dt><dt>5.72. <a href="#idp39032232">Tcpdump shows that the traffic is only forwarded from the server to the client</a></dt><dt>5.73. <a href="#idp39033320">Different forms of asymmetric routing.</a></dt><dt>5.74. <a href="#idp39034792">Asymmetric routing table via the CLI</a></dt><dt>5.75. <a href="#idp39035432">Normal setup of an optimized TCP session on the network map</a></dt><dt>5.76. <a href="#idp39036136">Auto-discovery for of an optimized TCP session - Flow of packets</a></dt><dt>5.77. <a href="#idp39036712">Auto-discovery for an optimized TCP session - tcpdump</a></dt><dt>5.78. <a href="#idp39037544">Client-side Asymmetry on the network map</a></dt><dt>5.79. <a href="#idp39038120">Client-side Asymmetry - Flow of packets</a></dt><dt>5.80. <a href="#idp39038696">Client-side Asymmetry on the wire</a></dt><dt>5.81. <a href="#idp39039144">Client-side Asymmetry in the logs</a></dt><dt>5.82. <a href="#idp39039976">Server-side Asymmetry on the network map</a></dt><dt>5.83. <a href="#idp39040552">Server-side Asymmetry - Flow of packets</a></dt><dt>5.84. <a href="#idp39041128">Server-side Asymmetry on the wire</a></dt><dt>5.85. <a href="#idp39041576">Server-side Asymmetry in the logs</a></dt><dt>5.86. <a href="#idp39042344">Complete Asymmetry on the network map</a></dt><dt>5.87. <a href="#idp39042920">Complete Asymmetry - Flow of packets</a></dt><dt>5.88. <a href="#idp39043496">Complete Asymmetry on the wire</a></dt><dt>5.89. <a href="#idp39044008">Complete Asymmetry in the logs</a></dt><dt>5.90. <a href="#idp39044776">Complete Asymmetry on the network map</a></dt><dt>5.91. <a href="#idp39045352">TCP SYN retransmit - Flow of packets</a></dt><dt>5.92. <a href="#idp39045992">TCP SYN retransmit on the wire</a></dt><dt>5.93. <a href="#idp39046440">TCP SYN retransmit in the logs</a></dt><dt>5.94. <a href="#idp39047528">Steelhead appliance with multiple LANs behind it</a></dt><dt>5.95. <a href="#idp39048232">Tcpdump of traffic if the in-path IP address is on the same IP subnet as the hosts on the LAN</a></dt><dt>5.96. <a href="#idp39048808">Tcpdump of traffic on a different IP subnet behind the Steelhead appliance</a></dt><dt>5.97. <a href="#idp39049704">In-path interface gateways</a></dt><dt>5.98. <a href="#idp39052008">Overview of the simplified routing table, pre RiOS 8.0</a></dt><dt>5.99. <a href="#idp39052520">Overview of the simplified routing table, RiOS 8.0 and later</a></dt><dt>5.100. <a href="#idp39054376">Matching the MAC addresses of the gateways with the LAN and WAN interfaces</a></dt><dt>5.101. <a href="#idp39060200">Unlearning entries from the macmap tables</a></dt><dt>5.102. <a href="#idp39075368">Full output of a log entry for an alarm before RiOS 7.0</a></dt><dt>5.103. <a href="#idp39076072">Full output of a log entry for an alarm on RiOS 7.0 and later</a></dt><dt>5.104. <a href="#idp39076904">Aggregate alarm tree for RiOS 8.0</a></dt><dt>5.105. <a href="#idp39078824">Generic health alarm</a></dt><dt>5.106. <a href="#idp39079592">Certificates related alarms</a></dt><dt>5.107. <a href="#idp39082216">CPU load related alarms</a></dt><dt>5.108. <a href="#idp39085672">License alarms</a></dt><dt>5.109. <a href="#idp39086376">RSP License alarms</a></dt><dt>5.110. <a href="#idp39087400">Disk alarms</a></dt><dt>5.111. <a href="#idp39088552">Domain joining alarms</a></dt><dt>5.112. <a href="#idp39089512">File system alarms</a></dt><dt>5.113. <a href="#idp39093352">Paging alarms</a></dt><dt>5.114. <a href="#idp39094248">RSP / VSP General alarms</a></dt><dt>5.115. <a href="#idp39095208">ESXi specific alarms</a></dt><dt>5.116. <a href="#idp39119912">RSP License alarms</a></dt><dt>5.117. <a href="#idp39120936">Secure Vault alarms</a></dt><dt>5.118. <a href="#idp39122856">Fan alarms</a></dt><dt>5.119. <a href="#idp39123752">Flash Error alarms</a></dt><dt>5.120. <a href="#idp39126056">Generic Hardware alarms</a></dt><dt>5.121. <a href="#idp39127528">IPMI alarms</a></dt><dt>5.122. <a href="#idp39129320">Memory error alarms</a></dt><dt>5.123. <a href="#idp39134376">Power supply alarms</a></dt><dt>5.124. <a href="#idp39135272">SSL Hardware alarm</a></dt><dt>5.125. <a href="#idp39136296">Temperature alarms</a></dt><dt>5.126. <a href="#idp39137384">Asymmetric routing alarms</a></dt><dt>5.127. <a href="#idp39097576">Bypass alarms</a></dt><dt>5.128. <a href="#idp39098472">Duplex error</a></dt><dt>5.129. <a href="#idp39099368">Link state alarms</a></dt><dt>5.130. <a href="#idp39100328">Virtual Steelhead related alarms</a></dt><dt>5.131. <a href="#idp39139112">Various admission control alarms</a></dt><dt>5.132. <a href="#idp39146152">Connection Forwarding alarms</a></dt><dt>5.133. <a href="#idp39149864">Data store related alarms</a></dt><dt>5.134. <a href="#idp39152104">Halt alarms</a></dt><dt>5.135. <a href="#idp39152936">Mismatched Peer alarms</a></dt><dt>5.136. <a href="#idp39153832">NFS related alarms</a></dt><dt>5.137. <a href="#idp39154792">Optimization Service alarms</a></dt><dt>5.138. <a href="#idp39155752">PFS related alarms</a></dt><dt>5.139. <a href="#idp39156712">Process dump related alarms</a></dt><dt>5.140. <a href="#idp39157928">Serial Cascade configuration alarms</a></dt><dt>5.141. <a href="#idp39158824">SMB alarms</a></dt><dt>5.142. <a href="#idp39159720">QoS alarms</a></dt><dt>5.143. <a href="#idp39160616">Software version alarms</a></dt><dt>5.144. <a href="#idp39161512">SSL related alarms</a></dt><dt>5.145. <a href="#idp39162600">System Detail Report alarms</a></dt><dt>5.146. <a href="#idp39163496">Granite related alarms</a></dt><dt>5.147. <a href="#idp39169512">Reset Connections At Startup</a></dt><dt>5.148. <a href="#idp39178984">Terminate Connection button in the GUI</a></dt><dt>5.149. <a href="#idp39180200">Terminate TCP session via the CLI</a></dt><dt>5.150. <a href="#idp39181160">Example of auto kick-off in-path rule</a></dt><dt>5.151. <a href="#idp39181608">Configuration of a Kick-off in-path rule</a></dt><dt>5.152. <a href="#idp39183464">Default in-path rules</a></dt><dt>5.153. <a href="#idp39184040">In-path rules: Add a new pass-through rule</a></dt><dt>5.154. <a href="#idp39184616">In-path rules: Change the default WAN visibility</a></dt><dt>5.155. <a href="#idp39185256">In-path rules: Add an all-ports auto-discovery rule</a></dt><dt>5.156. <a href="#idp39185896">In-path rules: Add an specific TCP port auto-discovery rule</a></dt><dt>5.157. <a href="#idp39186920">Disable MAPI optimization</a></dt><dt>5.158. <a href="#idp39191336">The right location for a spanning VLAN on a switch</a></dt><dt>5.159. <a href="#idp39192232">The TCP sessions towards a web proxy</a></dt><dt>5.160. <a href="#idp39195432">Telnet service is not enabled on this Steelhead appliance</a></dt><dt>5.161. <a href="#idp39197224">Secure SSH configuration</a></dt><dt>5.162. <a href="#idp39198376">HTTP and HTTPS security configuration</a></dt><dt>5.163. <a href="#idp39229672">SNMP security configuration</a></dt><dt>5.164. <a href="#idp39230440">SNMPv1 request for system.sysName.0</a></dt><dt>5.165. <a href="#idp39231784">SNMPv3 configuration for the user "shtest" to the system MIB</a></dt><dt>5.166. <a href="#idp39232552">SNMPv3 request for system.sysName.0</a></dt><dt>5.167. <a href="#idp39234152">SNMPv3 request with an unknown username</a></dt><dt>5.168. <a href="#idp39234920">SNMPv3 request for an unconfigured view</a></dt><dt>5.169. <a href="#idp39235496">SNMPv3 request for a disallowed view</a></dt><dt>5.170. <a href="#idp39244840">Data store encryption level</a></dt><dt>5.171. <a href="#idp39246056">Recreation of an encrypted data store</a></dt><dt>5.172. <a href="#idp39246632">After a move from AES_128 encryption to no encryption</a></dt><dt>5.173. <a href="#idp39247592">Secure Vault is not unlocked yet</a></dt><dt>5.174. <a href="#idp39249704">IPsec negotiation fails between two Steelhead appliances because the other side isn't configured for IPsec Secure Peering</a></dt><dt>5.175. <a href="#idp39250152">Tcpdump shows that the IPsec service on the remote Steelhead appliance is not enabled</a></dt><dt>5.176. <a href="#idp39251368">Incompatible options in the IPsec configuration</a></dt><dt>5.177. <a href="#idp39251880">Tcpdump shows that there are incompatible values in the configuration</a></dt><dt>5.178. <a href="#idp39252712">Incorrect shared secret</a></dt><dt>5.179. <a href="#idp39253160">Tcpdump shows that the IPsec negotiation fails because of an incorrect shared secret</a></dt><dt>5.180. <a href="#idp39322344">Failure due to an unknown SSL peering certificate</a></dt><dt>5.181. <a href="#idp39323304">Output of the command "show secure-peering gray-lst-peers"</a></dt><dt>5.182. <a href="#idp39324200">Optimized TCP session with an encrypted inner channel</a></dt><dt>5.183. <a href="#idp39325032">Remove Steelhead appliance does not have a valid SSL license</a></dt><dt>5.184. <a href="#idp39243112">RSP on RiOS</a></dt><dt>5.185. <a href="#idp39339752">Steelhead GUI redirection screen</a></dt><dt>5.186. <a href="#idp39341480">Output of the command "support show disk"</a></dt><dt>5.187. <a href="#idp39357608">An SSH session with verbose logging</a></dt><dt>5.188. <a href="#idp39359144">Telnet session to the SSH service</a></dt><dt>5.189. <a href="#idp39360040">Setup of an SSH session to the CLI of a replaced Steelhead appliance</a></dt><dt>5.190. <a href="#idp39366376">File system alarm</a></dt><dt>5.191. <a href="#idp39367208">Output of the command "support show disk"</a></dt><dt>5.192. <a href="#idp39389992">Removing an obsolete RSP image</a></dt><dt>5.193. <a href="#idp39390632">Removing an obsolete RSP package</a></dt><dt>5.194. <a href="#idp39391400">Removing an obsolete RSP backup</a></dt><dt>5.195. <a href="#idp39405224">Check for running background tcpdump captures</a></dt><dt>5.196. <a href="#idp39405928">Remove obsolete tcpdump capture files</a></dt><dt>5.197. <a href="#idp39406696">Remove obsolete process dumps</a></dt><dt>5.198. <a href="#idp39407464">Remove obsolete system dumps</a></dt><dt>5.199. <a href="#idp39400872">Neural Framing log files</a></dt><dt>5.200. <a href="#idp39398952">Running ipconfig on a Windows machine to check the subnet mask</a></dt><dt>5.201. <a href="#idp39399464">Running ifconfig on a Unix machine to check the subnet mask</a></dt><dt>5.202. <a href="#idp39409256">Tcpdump capture for a LAN side TCP conversation</a></dt><dt>5.203. <a href="#idp39410216">Check the MAC address table</a></dt><dt>5.204. <a href="#idp39411880">Duplicate DEF and a Service error with a Steelhead Mobile Client</a></dt><dt>5.205. <a href="#idp39413224">Duplicate DEF and a Service error but not with a Steelhead Mobile Client</a></dt><dt>5.206. <a href="#idp39415016">Requested reference does not exist anymore</a></dt><dt>5.207. <a href="#idp39416168">A service error due to a checksum mismatch</a></dt><dt>5.208. <a href="#idp39471336">An encrypted or compressed TCP session </a></dt><dt>5.209. <a href="#idp39471912">An formerly compressed TCP session </a></dt><dt>5.210. <a href="#idp39472680">The traffic summary report</a></dt><dt>5.211. <a href="#idp39474600">Network setup for the Interceptor cluster</a></dt><dt>5.212. <a href="#idp39477224">Setup of connection forwarding session between Interceptor and Steelhead appliance</a></dt><dt>5.213. <a href="#idp39477800">Failure in the setup of connection forwarding session between Interceptor and Steelhead appliance</a></dt><dt>5.214. <a href="#idp39486632">Failure in the setup of connection forwarding session between Interceptor and Steelhead appliance</a></dt><dt>5.215. <a href="#idp39487208">Failure in the connection forwarding session between Interceptor and Steelhead appliance</a></dt><dt>5.216. <a href="#idp39487784">Failure in the connection forwarding session between Interceptor and Steelhead appliance</a></dt><dt>5.217. <a href="#idp39482344">SSL certificates have expired</a></dt><dt>5.218. <a href="#idp39482984">SSL alarm is being raised</a></dt><dt>5.219. <a href="#idp39492712">CPU 7 shows a higher CPU load than the other ones</a></dt><dt>5.220. <a href="#idp39493672">Number of packets going through the LAN and WAN side</a></dt><dt>5.221. <a href="#idp39479464">Distribution of interrupts for a NIC dealt with by a single CPU</a></dt><dt>5.222. <a href="#idp39480104">Distribution of interrupts for a NIC dealt with by multiple CPUs</a></dt><dt>5.223. <a href="#idp39480680">Distrubution of interrupts for a NIC dealt with by multiple CPUs</a></dt><dt>5.224. <a href="#idp39481256">Statistics show that there are multiple queues for TX and RX</a></dt><dt>5.225. <a href="#idp39499880">A lot of CPU usage is in the 'nice' category</a></dt><dt>5.226. <a href="#idp39501544">Single spinning CPU</a></dt><dt>5.227. <a href="#idp39506664">A userland process is spinning on a CPU</a></dt><dt>5.228. <a href="#idp39508008">Single spinning CPU</a></dt><dt>5.229. <a href="#idp39509608">CMC 'CMC' connects to a Steelhead appliance</a></dt><dt>5.230. <a href="#idp39511144">Output of the command 'show cmc'</a></dt><dt>5.231. <a href="#idp39512232">Auto-registration by the Steelhead appliance</a></dt><dt>5.232. <a href="#idp39515240">Add Steelhead appliances to the unmanaged peer whitelist.</a></dt><dt>6.1. <a href="#idp39545576">Create a system dump from the CLI</a></dt><dt>6.2. <a href="#idp39546152">Upload a system dump directly to the Riverbed FTP server</a></dt><dt>6.3. <a href="#idp39547048">Create a system dump from the GUI</a></dt><dt>6.4. <a href="#idp39548008">Not being able to generate a system dump</a></dt><dt>6.5. <a href="#idp39556200">Contents of the active-running.txt file</a></dt><dt>6.6. <a href="#idp39559976">Configuration of the syslog daemon and SNMP daemon</a></dt><dt>6.7. <a href="#idp39562472">Beginning of the file "messages"</a></dt><dt>6.8. <a href="#idp39563112">Format of the log messages by the optimization service</a></dt><dt>6.9. <a href="#idp39573416">Beginning of the file "web_access.log"</a></dt><dt>6.10. <a href="#idp39574312">Beginning of the file "web_error.log"</a></dt><dt>6.11. <a href="#idp39575336">Part of the file "dmesg"</a></dt><dt>6.12. <a href="#idp39577192">Part of the file "cli_history_root"</a></dt><dt>6.13. <a href="#idp39579368">First ten lines of the file memlog.1</a></dt><dt>6.14. <a href="#idp39580392">Output of the "show logging" command, daily rotation</a></dt><dt>6.15. <a href="#idp39581352">Output of the "show logging" command, rotation by size</a></dt><dt>6.16. <a href="#idp39582888">Manually removing log files</a></dt><dt>6.17. <a href="#idp39585000">Output of the sensors section on the 100 / 200 / 300 models</a></dt><dt>6.18. <a href="#idp39585576">Output of the sensors section on the 520 / 1020 / 1520 / 2020 models</a></dt><dt>6.19. <a href="#idp39586088">Output of the sensors section on the 3020 / 3520 / 5520 / 6020 / 6120 models</a></dt><dt>6.20. <a href="#idp39586600">Output of the sensors section on the 150 / 250 / 550 models</a></dt><dt>6.21. <a href="#idp39587176">Output of the sensors section on the 1050 / 2050 models</a></dt><dt>6.22. <a href="#idp39587752">Output of the sensors section on the 5050 / 6050 / 7050 models</a></dt><dt>6.23. <a href="#idp39588328">Output of the sensors section on the 255 models</a></dt><dt>6.24. <a href="#idp39588904">Output of the sensors section on the 555 / 755 models</a></dt><dt>6.25. <a href="#idp39589608">Output of the sensors section on the EX560 / EX760 models</a></dt><dt>6.26. <a href="#idp39591720">Hard disk to chassis mapping for a 1050L and 1050M model</a></dt><dt>6.27. <a href="#idp39592296">Hard disk to chassis mapping for a 1050H model</a></dt><dt>6.28. <a href="#idp39662504">Hard disk to chassis mapping for a 2050 model</a></dt><dt>6.29. <a href="#idp39663016">Hard disk to chassis mapping for a 5050L and 5050M model</a></dt><dt>6.30. <a href="#idp39663592">Hard disk to chassis mapping for a 5050H model</a></dt><dt>6.31. <a href="#idp39664104">Hard disk to chassis mapping for a 6050 model</a></dt><dt>6.32. <a href="#idp39664616">Hard disk to chassis mapping for a 7050L model</a></dt><dt>6.33. <a href="#idp39665128">Hard disk to chassis mapping for a 7050M model</a></dt><dt>6.34. <a href="#idp39665640">Hard disk to chassis mapping for a 1555L, 1555M and 1555H model</a></dt><dt>6.35. <a href="#idp39666216">Hard disk to chassis mapping for a 5055M and 5055H model</a></dt><dt>6.36. <a href="#idp39658664">Hard disk to chassis mapping for a 7055L model</a></dt><dt>6.37. <a href="#idp39659176">Hard disk to chassis mapping for a 7055M model</a></dt><dt>6.38. <a href="#idp39659688">Hard disk to chassis mapping for a 7055H model</a></dt><dt>6.39. <a href="#idp39660200">Hard disk to chassis mapping for a DX8000 model</a></dt><dt>6.40. <a href="#idp39661096">Various hard disk fields on a 2050 model</a></dt><dt>6.41. <a href="#idp39661672">Front LED status fields for a 2050 model</a></dt><dt>6.42. <a href="#idp39699176">Physical characteristics of the disks in a 2050 model</a></dt><dt>6.43. <a href="#idp39700392">RAID configuration for RAID0 on a 1050H model</a></dt><dt>6.44. <a href="#idp39700968">Partition on a 1050H model</a></dt><dt>6.45. <a href="#idp39701736">RAID configuration for RAID10 on a 2050 model</a></dt><dt>6.46. <a href="#idp39702824">Partition on a 2050 model</a></dt><dt>6.47. <a href="#idp39708328">Various IPMI event records</a></dt><dt>6.48. <a href="#idp39711208">Output of the command "ipmitool sdr list" on the 1050 / 2050 models</a></dt><dt>6.49. <a href="#idp39720104">PS0 is connected, PS1 is not connected</a></dt><dt>6.50. <a href="#idp39721000">Licensed hardware in a 2050L model</a></dt><dt>6.51. <a href="#idp39722024">The NICs and other PCI cards</a></dt><dt>6.52. <a href="#idp39722856">Copper-based bypass cards</a></dt><dt>6.53. <a href="#idp39727784">Fiber-based bypass cards</a></dt><dt>6.54. <a href="#idp39728488">Virtual bypass cards</a></dt><dt>6.55. <a href="#idp39729256">RAID controllers</a></dt><dt>6.56. <a href="#idp39729960">Video cards</a></dt><dt>6.57. <a href="#idp39730664">SDR Accelerator cards</a></dt><dt>6.58. <a href="#idp39732200">System Information for a 550M model</a></dt><dt>6.59. <a href="#idp39733864">System information for an EX1160L model</a></dt><dt>6.60. <a href="#idp39749608">Hard disk utilization overview</a></dt><dt>6.61. <a href="#idp39760680">Ifconfig output</a></dt><dt>6.62. <a href="#idp39765992">ECC counter output</a></dt><dt>6.63. <a href="#idp39767208">System routing table output</a></dt><dt>6.64. <a href="#idp39767976">In-path routing table output</a></dt><dt>6.65. <a href="#idp39654120">ARP table overview</a></dt><dt>6.66. <a href="#idp39655016">Output of the netstat command</a></dt><dt>6.67. <a href="#idp39774312">Output of the command "ss"</a></dt><dt>6.68. <a href="#idp39788392">Output of the top program</a></dt><dt>6.69. <a href="#idp39790376">The process lists.</a></dt><dt>6.70. <a href="#idp39791272">Output of the "who" command</a></dt><dt>6.71. <a href="#idp39792296">Contents of /var/log</a></dt><dt>6.72. <a href="#idp39792872">Contents of /var/opt</a></dt><dt>6.73. <a href="#idp39794152">Output of the "netstat -s" command</a></dt><dt>6.74. <a href="#idp39795304">Ethtool section for an auto-negotiated Ethernet link</a></dt><dt>6.75. <a href="#idp39796008">Ethtool section for a fixed speed and duplex Ethernet link</a></dt><dt>6.76. <a href="#idp39796712">No Ethernet link negotiated</a></dt><dt>6.77. <a href="#idp39863144">Ethernet flow control</a></dt><dt>6.78. <a href="#idp39863912">TCP segmentation offloading</a></dt><dt>6.79. <a href="#idp39866024">The contents of the file macmap_tables</a></dt><dt>6.80. <a href="#idp39875624">The contents of the file er/0/pkttab_entries</a></dt><dt>6.81. <a href="#idp39879592">Contents of the file "asymrouting_table"</a></dt><dt>6.82. <a href="#idp39882728">Contents of the file "image_history"</a></dt><dt>6.83. <a href="#idp39888424">Output of the file "lsof.txt"</a></dt><dt>6.84. <a href="#idp39891496">Header of the mem-dump file</a></dt><dt>6.85. <a href="#idp39892648">Memory based admission based control values</a></dt><dt>6.86. <a href="#idp39893864">Connection based admission based control values</a></dt><dt>6.87. <a href="#idp39895528">Contents of the file oom_profile.log</a></dt><dt>6.88. <a href="#idp39896936">The rcud.conf section for the share \\192.168.1.1\Test</a></dt><dt>6.89. <a href="#idp39898216">Files for the share \\192.168.1.1\Test</a></dt><dt>6.90. <a href="#idp39899304">Contents of the files initial-copy.status and last-sync.status</a></dt><dt>6.91. <a href="#idp39901160">Files in the rsp/slots directory</a></dt><dt>6.92. <a href="#idp39902632">Memory allocation for the RSP slot RiverbedSMC </a></dt><dt>6.93. <a href="#idp39904168">Overview of the SAR data files</a></dt><dt>6.94. <a href="#idp39905576">Contents of the pfs directory</a></dt><dt>6.95. <a href="#idp39906408">Contents of the net_ads.out</a></dt><dt>6.96. <a href="#idp39909480">Generating a process dump of the process sport by cloning it</a></dt><dt>6.97. <a href="#idp39910376">Generating a process dump of the process sport by restarting it</a></dt><dt>7.1. <a href="#idp39915112">In-path interface being configured for fail-to-block</a></dt><dt>7.2. <a href="#idp39921768">Usage of the telnet command</a></dt><dt>7.3. <a href="#idp39923944">Reports -&gt; Networking -&gt; Current Connections</a></dt><dt>7.4. <a href="#idp39937448">Output of the "show connections all" command.</a></dt><dt>7.5. <a href="#idp39938792">TCP session details</a></dt><dt>7.6. <a href="#idp39939944">Output of the "show connections all full" command.</a></dt><dt>7.7. <a href="#idp39944040">No room for new TCP options for the auto-discovery phase</a></dt><dt>7.8. <a href="#idp39949480">Running tcpdump on the LAN side</a></dt><dt>7.9. <a href="#idp39949928">Running tcpdump on the WAN side</a></dt><dt>7.10. <a href="#idp39951080">Running tcpdump on the LAN side</a></dt><dt>7.11. <a href="#idp39951528">Running tcpdump on the WAN side</a></dt><dt>7.12. <a href="#idp39954024">Running tcpdump on the client-side WAN side, seeing the SYN+ packet</a></dt><dt>7.13. <a href="#idp39954472">Running tcpdump on the server-side WAN side without the SYN+ packet</a></dt><dt>7.14. <a href="#idp39989608">Latency optimized SMB requests response times overview</a></dt><dt>7.15. <a href="#idp39990440">CIFS Write Behind has been disabled by the optimization service.</a></dt><dt>7.16. <a href="#idp39991464">Comparison of two binary files</a></dt><dt>7.17. <a href="#idp40002856">Connection-based admission control for a 5520 model</a></dt><dt>7.18. <a href="#idp40011816">Use "lsof" to determine which application is owning a TCP session</a></dt><dt>7.19. <a href="#idp40013096">Use "netstat -no" to determine the Process ID of the application owning a TCP session</a></dt><dt>7.20. <a href="#idp40013672">Windows Task Manager with Process ID</a></dt><dt>7.21. <a href="#idp40015720">A half-closed TCP is about to be terminated</a></dt><dt>8.1. <a href="#idp40019688">Example of a TCP session on port 139 being terminated immediately</a></dt><dt>8.2. <a href="#idp40020712">Wireshark Response time statistics for an unoptimized CIFS session</a></dt><dt>8.3. <a href="#idp40021352">Wireshark Response time statistics for an optimized CIFS session</a></dt><dt>8.4. <a href="#idp40022504">Skewed statistics on the client-side Steelhead appliance because of read-ahead in the Windows Explorer.</a></dt><dt>8.5. <a href="#idp40023464">Comparison of the client-side and server-side LAN traffic for CIFS latency optimization</a></dt><dt>8.6. <a href="#idp40024232">Disable the CIFS read-ahead feature for files with the extension "myob"</a></dt><dt>8.7. <a href="#idp40025000">Heads up that the replies from the file servers are slow</a></dt><dt>8.8. <a href="#idp40039336">CIFS write-behind stopping because of a full disk.</a></dt><dt>8.9. <a href="#idp40040296">Unable to obtain oplock on a file</a></dt><dt>8.10. <a href="#idp40042088">CIFS pre-population configuration</a></dt><dt>8.11. <a href="#idp40044200">Successful registration of the CIFS pre-population session</a></dt><dt>8.12. <a href="#idp40046632">Registration failed due to an unknown hostname</a></dt><dt>8.13. <a href="#idp40056040">Registration failed due to an non-responding remote server</a></dt><dt>8.14. <a href="#idp40057256">Registration failed due to a login failure</a></dt><dt>8.15. <a href="#idp40058344">Registration failed due to a login failure</a></dt><dt>8.16. <a href="#idp40060200">A successful sync</a></dt><dt>8.17. <a href="#idp40061096">Log file of the Initial Copy</a></dt><dt>8.18. <a href="#idp40062504">Manually starting a CIFS pre-population sync</a></dt><dt>8.19. <a href="#idp40072680">Unable to read some of the files</a></dt><dt>8.20. <a href="#idp40073320">Initial copy failed due to reading errors</a></dt><dt>8.21. <a href="#idp40073896">CIFS pre-population failure settings</a></dt><dt>8.22. <a href="#idp40074792">No new files found during the periodical sync</a></dt><dt>8.23. <a href="#idp40075688">The Last Sync log files shows no new files found</a></dt><dt>8.24. <a href="#idp40076392">New files found during the periodical sync</a></dt><dt>8.25. <a href="#idp40077288">The Last Sync log files shows new or updated files found</a></dt><dt>8.26. <a href="#idp40078184">Status of the pre-population shares during syncing and when the share is idle</a></dt><dt>8.27. <a href="#idp40079912">NFS optimization does not work for NFS version 4</a></dt><dt>8.28. <a href="#idp40068456">NFS optimization does not work when using Kerberos authentication</a></dt><dt>8.29. <a href="#idp40080104">See the MAPI probing option</a></dt><dt>8.30. <a href="#idp40082536">192.168.1.6 points to ssh-primary.example.org</a></dt><dt>8.31. <a href="#idp40083176">NTP servers configured are the local Domain Controllers</a></dt><dt>8.32. <a href="#idp40083880">DNS SRV records for _ldap._tcp.example.org</a></dt><dt>8.33. <a href="#idp40097704">Domain join failed because of a clock skew between the Steelhead appliance and the Domain Controller</a></dt><dt>8.34. <a href="#idp40098472">Domain join failed because of DNS related issues</a></dt><dt>8.35. <a href="#idp40099304">Domain join failed because the object in Active Directory already exists</a></dt><dt>8.36. <a href="#idp40103336">FTP Data reported as unknown protocols</a></dt><dt>8.37. <a href="#idp40106152">An HTTP Reply header</a></dt><dt>8.38. <a href="#idp40122280">A 304 response code</a></dt><dt>8.39. <a href="#idp40122984">Network with Web-browsers, web-caches and web-servers</a></dt><dt>8.40. <a href="#idp40129320">An invalid URL error messages due to spaces in the URL</a></dt><dt>8.41. <a href="#idp40130280">Output of the command "show protocol http"</a></dt><dt>8.42. <a href="#idp40131112">X-RBT-Optimized header</a></dt><dt>8.43. <a href="#idp40146152">Enabling the HTTP debugging feature</a></dt><dt>8.44. <a href="#idp40147048">The X-RBT-Debug line</a></dt><dt>8.45. <a href="#idp40153320">HTTP Optimization scheme</a></dt><dt>8.46. <a href="#idp40175144">SSL encapsulated HTTP traffic</a></dt><dt>8.47. <a href="#idp40177768">Missing issuer certificate during the import of the server key and certificate</a></dt><dt>8.48. <a href="#idp40178792">Output of the command "show protocol ssl server-cert"</a></dt><dt>8.49. <a href="#idp40180072">Missing Root CA certificate missing but intermediate certificate is there</a></dt><dt>8.50. <a href="#idp40181352">Output of the command "show protocol ssl server-cert" for a chained certificate</a></dt><dt>8.51. <a href="#idp40182568">Successful import of the server certificate</a></dt><dt>8.52. <a href="#idp40183912">SSL Pre-optimization in-path rule</a></dt><dt>8.53. <a href="#idp40185384">SSL discovery list</a></dt><dt>8.54. <a href="#idp40210280">SCA connection Direct Branch Deployment</a></dt><dt>8.55. <a href="#idp40211432">SCA connection Back-Hauled Deployment</a></dt><dt>8.56. <a href="#idp40219048">Output of the command 'show service cloud-accel'</a></dt><dt>8.57. <a href="#idp40224424">Output of the command 'show service cloud-accel'</a></dt><dt>8.58. <a href="#idp40225960">SCA passed through connections.</a></dt><dt>8.59. <a href="#idp40227816">The first hop found by traceroute should be the SRIP-Edge host</a></dt><dt>8.60. <a href="#idp40228584">SCA inner channel is not secure.</a></dt><dt>8.61. <a href="#idp40230248">SCA invalid CA certificate installed in client browser.</a></dt><dt>9.1. <a href="#idp40233192">Example log lines</a></dt><dt>9.2. <a href="#idp40237608">Change the logging level of a single part of the optimization level</a></dt><dt>9.3. <a href="#idp40239784">Setup of an optimized TCP session from the client-side Steelhead appliance, Enhanced Auto Discovery and no Enhanced Auto Discovery </a></dt><dt>9.4. <a href="#idp40252520">Setup of an optimized TCP session from the server-side Steelhead appliance, Enhanced Auto Discovery</a></dt><dt>9.5. <a href="#idp40273256">Setup of an optimized TCP session from the server-side Steelhead appliance, No Enhanced Auto Discovery</a></dt><dt>9.6. <a href="#idp40274792">Setup of an OOB Splice from the client-side Steelhead appliance, Enhanced Auto Discovery</a></dt><dt>9.7. <a href="#idp40276200">Setup of an OOB Splice from the server-side Steelhead appliance, Enhanced Auto Discovery</a></dt><dt>9.8. <a href="#idp40277480">Setup of an OOB Splice from the server-side Steelhead appliance, no Enhanced Auto Discovery</a></dt><dt>9.9. <a href="#idp40278440">Cannot setup OOB Splice</a></dt><dt>9.10. <a href="#idp40279208">Server-side Steelhead appliance, no service listening on TCP port 25, Enhanced Auto Discovery</a></dt><dt>9.11. <a href="#idp40279784">Client-side Steelhead appliance, no service listening on TCP port 25, no Enhanced Auto Discovery</a></dt><dt>9.12. <a href="#idp40280232">Server-side Steelhead appliance, no service listening on TCP port 25, no Enhanced Auto Discovery</a></dt><dt>9.13. <a href="#idp40281064">Server-side Steelhead appliance, no host with IP address 192.168.1.1, Enhanced Auto Discovery</a></dt><dt>9.14. <a href="#idp40281640">Client-side Steelhead appliance, no host with IP address 192.168.1.1, no Enhanced Auto Discovery</a></dt><dt>9.15. <a href="#idp40282088">Server-side Steelhead appliance, no host with IP address 192.168.1.1, no Enhanced Auto Discovery</a></dt><dt>9.16. <a href="#idp40282920">Third SYN received before inner channel got setup</a></dt><dt>9.17. <a href="#idp40283752">TCP session closed before the inner channel could have been setup</a></dt><dt>9.18. <a href="#idp40285224">Local Steelhead appliance into admission control</a></dt><dt>9.19. <a href="#idp40285736">Remote Steelhead appliance into admission control</a></dt><dt>9.20. <a href="#idp40286568">Remote Steelhead appliance failed to setup an inner channel</a></dt><dt>9.21. <a href="#idp40287400">Remote Steelhead becomes the backup in a High Availability cluster</a></dt><dt>9.22. <a href="#idp40288168">Local Steelhead appliance disconnects</a></dt><dt>9.23. <a href="#idp40288616">Local Steelhead appliance disconnects</a></dt></dl></div><div class="list-of-tables"><p><b>List of Tables</b></p><dl><dt>2.1. <a href="#idp32813800">Model 50, 100, 200, 300</a></dt><dt>2.2. <a href="#idp32828328">Model 520, 1020, 1520, 2020</a></dt><dt>2.3. <a href="#idp32850984">Model 3020, 3520, 5520, 6020, 6120</a></dt><dt>2.4. <a href="#idp32869160">Model 150</a></dt><dt>2.5. <a href="#idp32876328">Model 250</a></dt><dt>2.6. <a href="#idp32888168">Model 550</a></dt><dt>2.7. <a href="#idp32913000">Model 1050</a></dt><dt>2.8. <a href="#idp33333736">Model 2050</a></dt><dt>2.9. <a href="#idp33347880">Model 5050</a></dt><dt>2.10. <a href="#idp33391016">Model 6050</a></dt><dt>2.11. <a href="#idp33425896">Model 7050</a></dt><dt>2.12. <a href="#idp33463976">Model CX255</a></dt><dt>2.13. <a href="#idp33582888">Model CX555</a></dt><dt>2.14. <a href="#idp33657128">Model CX755</a></dt><dt>2.15. <a href="#idp33701864">Model CX570</a></dt><dt>2.16. <a href="#idp33746792">Model CX770</a></dt><dt>2.17. <a href="#idp33807976">Model CX1555</a></dt><dt>2.18. <a href="#idp33854760">Model CX5055</a></dt><dt>2.19. <a href="#idp33864424">Model CX7055</a></dt><dt>2.20. <a href="#idp33934568">Model EX560</a></dt><dt>2.21. <a href="#idp34027496">Model EX760</a></dt><dt>2.22. <a href="#idp34081704">Model EX1160</a></dt><dt>2.23. <a href="#idp34165416">Model EX1260</a></dt><dt>2.24. <a href="#idp34193896">Model EX1360</a></dt><dt>2.25. <a href="#idp34256552">Model DX8000</a></dt><dt>3.1. <a href="#idp34523176">The less pager cheat sheet</a></dt><dt>3.2. <a href="#idp34632680">Control characters on the CLI</a></dt><dt>4.1. <a href="#idp36473064">Cabling for placement of Steelhead appliance between switch and router</a></dt><dt>4.2. <a href="#idp36523560">Cabling for placement of Steelhead appliance between two routers</a></dt><dt>4.3. <a href="#idp36602344">Cabling for placement of two Steelhead appliances between switch and router</a></dt><dt>4.4. <a href="#idp36642856">Cabling for placement of two Steelhead appliances between two routers</a></dt><dt>5.1. <a href="#idp38380648">Example of configuration changes for the Simplified Routing feature for the value "none"</a></dt><dt>5.2. <a href="#idp38387112">Example of configuration changes for the Simplified Routing feature for the value "dest-only"</a></dt><dt>5.3. <a href="#idp38401512">Example of configuration changes for the Simplified Routing feature for the value "all"</a></dt><dt>6.1. <a href="#idp39734568">RiOS EX software and matching RiOS version</a></dt><dt>8.1. <a href="#idp40131688">HTTP Optimization Scheme Code</a></dt><dt>8.2. <a href="#idp40147880">Optimization scheme bit mask</a></dt><dt>8.3. <a href="#idp40158184">Cache related category</a></dt><dt>8.4. <a href="#idp40164712">Prefetch related category</a></dt><dt>8.5. <a href="#idp40171688">Miscellaneous category</a></dt></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="idp32148072"></a>Preface</h1></div></div></div><h2><a name="idp32148904"></a>Introduction</h2><p>
    Welcome! This book is about troubleshooting 
    Riverbed Steelhead appliances and networks optimized by the
    Steelhead appliances. It contains the experiences with cases
    handled by the Riverbed TAC on how to
    detect the source of problems in networks with Steelhead
    appliances and how to troubleshoot problems with Steelhead
    appliances.
  </p><p>
    For many years, networking has been fun but it has become
    relative boring: Moving packets around, processing routing
    updates for reconnected networks and linking up different
    transport layers. Everybody knows and understands IP routing
    and troubleshooting it is a pretty straight forward process.
    WAN optimization is a new field, a Steelhead appliance is not
    just a router or switch where packets go through, it is a hop
    in the network where packets get mangled, contents get changed
    and some magic happens: Shazam! Knowing how this magic works
    will help you understand what is happening and resolve issues
    with the Steelhead appliances faster and more efficient.
  </p><p>
    Edwin.
  </p><h2><a name="idp32150888"></a>Intended Audience</h2><p>
    This is not a book on how to manage and deploy Steelhead
    appliances, the Riverbed Deployment Guide and the Steelhead
    Management Console User's Guide (both available from the Riverbed
    Support website) are the right books for that. This is a book
    about what can go wrong with Steelhead appliances in a network.
    This book is for everybody who has two or more Steelhead
    appliances in their network and wants to understand how the
    Steelhead appliances interact with other devices in the network,
    what can go wrong and how to use the features on the Steelhead
    appliance to troubleshoot it.
  </p><p>
    The easiest way to troubleshoot Steelhead appliances is to know
    what is expected to happen when you poke and prod it. Depending
    on the behaviour seen, the next steps can be easily determined.
    Very simple steps, very logical steps, sounds nearly like a
    normal networking troubleshoot approach. And that is often all
    what is required.
  </p><p>
    This book describes experiences, possible issues and troubleshooting
    with the xx20, xx50, CX and EX series Steelhead appliances and
    software versions up to, and including, RiOS 8.5.
  </p><h2><a name="idp32163752"></a>Organization of this book</h2><p>
    This book is split in several chapters; The first chapters with
    some background on WAN optimization, the next set of chapters
    are about tools available on Steelhead appliances, followed by
    the troubleshooting parts.
  </p></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="Introduction_to_WAN_Optimization"></a>Chapter 1. Introduction to WAN Optimization</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp32165800">1.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp32170920">1.2. Why WAN optimization?</a></span></dt><dt><span class="sect1"><a href="#idp32215080">1.3. Three different optimization methods</a></span></dt><dt><span class="sect1"><a href="#idp32357928">1.4. Effects of WAN optimization on other equipment</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32165800"></a>1.1. Index</h2></div></div></div><p>This chapter describes the background of WAN optimization in generic
terms, from a vendor neutral point of view.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Why WAN optimization is needed: Where are the delays?
</p></li><li class="listitem"><p>The three different optimization methods: The network transport
  layer, the packet payload and the application protocol.
</p></li><li class="listitem"><p>Effects of WAN optimization on the networks, servers and clients.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32170920"></a>1.2. Why WAN optimization?</h2></div></div></div><p>WAN optimization is a set of techniques that address various issues
experienced in a Wide Area Network (WAN):
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Link related issues, caused by physical limitations.
</p></li><li class="listitem"><p>Protocol related issues.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32185960"></a>1.2.1. Link related issues</h3></div></div></div><p>A network link has two characteristics:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The link speed, which defines the speed of the data through the
  physical layer.
</p></li><li class="listitem"><p>The link delay, which defines how long it takes for a bit to reach
  the other side of the link.
</p></li></ul></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32198248"></a>1.2.1.1. Historical changes in link speed</h4></div></div></div><p>The link speed is the number of bits per second which can be
transferred over a link. In general, the speed of the LAN is much
faster than the speed of the WAN.
</p><p>Around 1995, the speed of a
WAN link was measured in multitudes of 64 kbps and a LAN link was
still working on a 10 Mbps shared coax cable. It wasn't for another
five years in 2000 that an E1 link at 2 Mbps became the standard
speed for WAN links and that a 100 Mbps Ethernet cables towards a
LAN switch became available for the desktop. Five years later in
2005 the general speed for a WAN link was 10 Mbps and the network
switch was connected to the desktop at gigabit Ethernet speed (1000
Mbps).
</p><p>This LAN/WAN speed difference made it in the past necessary to have
services such as file servers, mail servers and web proxy servers, on
the local LAN on the remote location (the branch). However, the speed 
of the WAN link in 2005 is now fast enough to consolidate them into a data
center.
</p><p>Consolidation of these remote servers into data centers made the
management of the machines easier: Reduction of the number of
machines by consolidating then, better control over the environment
the machines are operating in, easier implementation of fail-over
scenarios because of the availability of high bandwidth needed for
replication, and a simplified management of the services running.
However, the bandwidth towards the client was reduced from gigabit
speeds back to pre-2000 speeds of 10 Mbps.
</p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp32200552"></a>1.2.1.1.1. Serialization delay</h5></div></div></div><p>The link-speed defines the serialization delay, the time it takes
for a packet to be converted from set of bytes in the memory of a
host (computer, router, or switch) into a string of bits on the
wire.
</p><p>For example, to forward one packet of 1500 bytes through a router
with a WAN interface of 1 Mbps, it will take 12 milliseconds (1500
bytes * 8 bits per byte / 1 000 000 bits per second = 12 ms).
</p><p>If WAN optimization reduces that packet of 1500 bytes to a packet
of 100 bytes, this serialization delay will be reduced to 0.8
milliseconds.
</p><div class="figure"><a name="idp32201768"></a><p class="title"><b>Figure 1.1. Serialization delay</b></p><div class="figure-contents"><pre class="screen">^ |
| |                                  _____
H |                       __________/    |
o |                      /|        |     |
p |                     / |        |     |
  |                    /  |        |     |
d |                   /   |        |     |
e |                  /    |        |     |
l |                 /     |        |     |
a |      __________/      |        |     |
y |     / |        |      |        |     |
  +----------------------------------------------- network hop distance
  client  WAN router      WAN router     server
</pre></div></div><br class="figure-break"></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32204520"></a>1.2.1.2. Link delay</h4></div></div></div><p>On longer distances, the speed the data travels through the medium
comes into play. For example, the speed of light in a fiber cable,
which is about 5 microseconds per kilometer (1.5 / 300 000 km/s,
where 1.5 is the refraction index for fiber{SOURCE:Wikipedia Latency
(engineering)}). For a fiber cable with a length of 1000 kilometers
this would add 5 ms for the signal to reach the other side.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32205160"></a>1.2.2. Network protocols</h3></div></div></div><p>The TCP network protocol has had lots of improvements over the last
years, but not all TCP stacks support all features. By terminating
the TCP session locally on the LAN and setting up a new one which
does support all the new features, the WAN optimizer can make
these TCP sessions faster over the WAN.
</p><p>Some protocols are smart, like the connection-oriented TCP protocol,
which makes sure that all the data sent by the sending application
is presented to the receiver application in such a way that nothing
is missing and that it is in the right order.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32213544"></a>1.2.3. Application protocol related issues</h3></div></div></div><p>Application protocols are the layer in which the client and the
server talk to each other.
</p><p>Application protocols can be unintentionally implemented with a
special environment in mind. For example results from database
queries can be requested either in bulk or one by one. The first
implementation works great over a WAN but needs more memory on the
client to store all the answers, while the second implementation
works bad over a WAN but doesn't need as much memory. Serialization
delay is here the cause of the problem for a WAN deployment.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32215080"></a>1.3. Three different optimization methods</h2></div></div></div><p>WAN optimization attacks the issues mentioned previously in three
different ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Transport layers optimization.
</p></li><li class="listitem"><p>Data reduction.
</p></li><li class="listitem"><p>Latency optimization.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32231208"></a>1.3.1. Transport layers optimization</h3></div></div></div><p>These days, the most popular transport layers are Ethernet, IP and TCP.
</p><div class="figure"><a name="idp32232360"></a><p class="title"><b>Figure 1.2. A typical Ethernet frame</b></p><div class="figure-contents"><pre class="screen">.---------------------------------------------------------------------.
| Ethernet | IP | TCP | Payload                                       |
'---------------------------------------------------------------------'
                      &lt;------------------------------ 1460 bytes -----&gt;
                &lt;------------------------------------ 1480 bytes -----&gt;
           &lt;----------------------------------------- 1500 bytes -----&gt;
</pre></div></div><br class="figure-break"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Ethernet is the local network layer to the next hop in the network.
  The default maximum payload for an Ethernet frame size is 1500
  bytes.
  
</p></li><li class="listitem"><p>IP is the layer which takes care of the routing of the packet in
  the network.
</p></li><li class="listitem"><p>TCP is the layer which takes care of the data exchanged between
  the client and server and which makes sure that the data is fed
  to the receiving application in the same order as the sending
  application has delivered it. It takes care of the retransmission
  of lost packets and time-outs, if there is a problem it backs off
  a little bit and allows the network to recover.
</p><p>  Standard TCP has the following features and limitations:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>The TCP Sliding Window method, which makes it possible for the
    sender to keep sending data until the limit for maximum number
    of bytes in flight as specified by the receiver is reached. In
    the original TCP design this was limited to 64 kilobytes{SOURCE:RFC
    793}.
</p><div class="figure"><a name="idp32253864"></a><p class="title"><b>Figure 1.3. Bytes in-flight over time.</b></p><div class="figure-contents"><pre class="screen">B I |        +--+--+--+--+--+
y n |        |  |  |  |  |  |
t f |        |  |  |  |  |  |
e l |     +--+  |  |  |  |  |
s i |     |  |  |  |  |  |  |
  g |  +--|  |  |  |  |  |  |
  h |  |  |  |  |  |  |  |  |
  t +-------------------------- ---&gt; time
               ^
                \__ First acknowledgement received
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>The original TCP Acknowledge method specifies that the receiver
    can only acknowledge packets it has received. It cannot tell the
    sender that it has missed packets but has to wait for a timeout
    in the acknowledgement from the server. Then the server has to
    retransmit all the unacknowledged packets.
</p><div class="figure"><a name="idp32256168"></a><p class="title"><b>Figure 1.4. Retransmission due to a time out in the acknowledgement</b></p><div class="figure-contents"><pre class="screen">    |
    |  +--+--+--+  +--+--+         +--+--+--+
    |  |  |  |  |  |  |  |         |  |  |  |
    |  |N |N |N |  |N |N |         |N |N |N |
    |  |- |- |- |  |+ |+ |         |  |+ |+ |
    |  |3 |2 |1 |  |1 |2 |         |  |1 |2 |
    |  |  |  |  |  |  |  |         |  |  |  |
    |  |  |  |  |  |  |  |         |  |  |  |
    +----------------------------------------- ---&gt; time
                  ^      ^         ^__ ACK timeout
                   \      \___________ TCP Window full
                    \_________________ Lost packet
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>The TCP Window Size uses a Slow Start mechanism which starts
    with a Window Size of 2 * Segment Size{SOURCE:RFC 793} and
    increases it with one Segment per received acknowledgment packet.
</p><p>    In case of packet loss it will half the TCP Window Size and
    slowly increase the Window Size again per received acknowledgment
    packet.
</p><div class="figure"><a name="idp32261096"></a><p class="title"><b>Figure 1.5. Retransmission due to time out</b></p><div class="figure-contents"><pre class="screen">    Window Size
    |
    |                       +--+--+                       +--+
    |                    +--+  |  |                    +--+  |
    |                 +--+  |  |  |                 +--+  |  |
    |              +--+  |  |  |  |              +--+  |  |  |
    |           +--+  |  |  |  |  |     +--+--+--+  |  |  |  |
    |  +--+--+--+  |  |  |  |  |  |     |  |  |  |  |  |  |  |
    |  |  |  |  |  |  |  |  |  |  |     |  |  |  |  |  |  |  |
    +----------------------------------------------------------- ---&gt; time
                 ^          ^     ^    ^        ^____________ First ACK
                  \          \     \    \____________________ Retransmission
                   \          \     \________________________ Lost packet
                    \          \_____________________________ TCP Window maximum size
                     \_______________________________________ First ACK
</pre></div></div><br class="figure-break"></li></ul></div></li></ul></div><p>Transport layer optimization can add the following features for the
traffic between two Steelhead appliances:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>For Ethernet there is not much which can be improved here, unless
  there is full control of all the WAN devices between the clients
  and servers, in which case Jumbo frames can be used.
</p><p>  The payload of Ethernet Jumbo frames can be increased up to 9000
  bytes {SOURCE: Wikipedia Jumbo Frame}. This means the IP payload,
  instead of having to split a stream in pieces of 1480 bytes, can
  be split in pieces of 8980 bytes. For the routers in the path
  this means that they have to process only one sixth of the number
  of packets. However on the TCP level the improvement is not
  comparable since the maximum number of outstanding bytes is still
  limited to the TCP Window size.
</p></li><li class="listitem"><p>On the IP level there is no optimization possible.
</p></li><li class="listitem"><p>On the TCP level there are several enhancements to improve the traffic
  flow:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>In newer TCP stacks a feature called TCP Window Scaling has
    been introduced which increases the 64 kilobyte window size
    limit by multiplying it with a power of two value {SOURCE:RFC
    1323}.  This means that the number of bytes in-flight can be
    much larger.
</p></li><li class="listitem"><p>TCP Fast Retransmission {SOURCE:RFC 2581} is a method for the
    receiver to signal, by sending three empty duplicate
    ACKs, that a certain packet has not been received but
    that later packets have been received. This will reduce the time
    for the start of the retransmission.
</p></li><li class="listitem"><p>TCP Selective ACK {SOURCE:RFC 2018} is a method to inform the
    sender that further packets have already been received, implicitly
    telling which packets have been lost by giving the already
    received TCP sequence numbers. This will reduce the time for
    the start of the retransmission and the amount of packets
    retransmitted.
</p></li><li class="listitem"><p>On the sender side, the use of TCP Timestamps {SOURCE:RFC 2018}
    can be used to determine the Round Trip Time (RTT) towards the receiver
    and thus the expected time that an acknowledgment for a packet
    should arrive. This will give the sender an indication of a
    lost packet before the official timer expires.
</p></li><li class="listitem"><p>If it is known that the quality of the network is not optimal
    due to packet loss, or a high latency, then the TCP Window might
    never be at the maximum size and the performance will be
    sub-optimal. The sender can start with a large TCP Window and
    decrease the TCP Window by only one Segment Size instead of a
    halving it to improve the performance over such kind of networks.
</p></li></ul></div><p>  The use of TCP Selective ACK and TCP Timestamps is negotiated
  during the setup of the TCP session.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32274088"></a>1.3.2. Data reduction</h3></div></div></div><p>Once the transport layer is optimized, the next step is to reduce
the payload sent over it. There are several methods to reduce the
size of the data: Compression and dictionaries.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Compression is the process of encoding data to use less bytes
  than the original data took.
</p><p>  As an example, the string
<span class="italics">AAAAAA</span>
  could be compressed to
<span class="italics">6"A"(NUL)</span>,
  reducing it from six bytes to three. The string
<span class="italics">ABABAB</span>
  could be compressed to
<span class="italics">3"AB"(NUL)</span>,
  reducing it from six bytes to four bytes. And the string
<span class="italics">ABCDEF</span>
  can only be compressed to
<span class="italics">1"ABCDEF"(NUL)</span>,
  increasing it from six bytes to eight bytes.
</p><p>  Certain data can be compressed very well, like HTML data and
  source code files. Other data cannot be compressed because it
  is too unique or compressed already.
</p></li><li class="listitem"><p>Dictionaries are lists of patterns that known to both Steelhead
  appliances, so that instead of having to send a long pattern it
  will send a reference to that data. For example if the sender
  receives the pattern
<span class="italics">AAAAABBBBB</span>
  and both sides have a reference for
<span class="italics">AAAAA</span>
  and
<span class="italics">BBBBB</span>
  in their dictionary, the sender can send the labels of these
  references, the receiver will look them up in the dictionary and
  forwards the referenced data on the wire.
</p><p>  These dictionaries are learnt over time by looking at the traffic
  going through the Steelhead appliances. Patterns which are used
  often will end up in the front of the dictionary. When the
  dictionary is full, patterns which were used only once or haven't
  been used for a long time get removed from the dictionary and
  space to store new learned patterns is created.
</p><p>  When a data stream contains patterns which are never seen before,
  the quality of the sending of the data is considered
<span class="italics">a cold transfer</span>.
  When a data stream contains patterns which have been seen before,
  the quality of the sending of data is considered
<span class="italics">a warm transfer</span>.
</p><p>  Unlike compression which doesn't like compressed data, dictionaries
  do not mind that the data is already compressed. However, this
  only works if the data is an object retrieved from a remote server,
  it doesn't work if the data-stream is compressed interactive
  traffic.
</p><p>  Storing patterns from encrypted data streams in the dictionary
  is also a bad thing, because by definition this encrypted data
  is unique. For example, the first time the string
<span class="italics">AAAAA</span>
  is encrypted it shows up as
<span class="italics">ABCDE</span>,
  the second time it is encrypted as
<span class="italics">AEDBC</span>,
  the time after that it is encrypted as
<span class="italics">BEBAC"</span>.
  Instead of learning a repetitive pattern, the dictionary will be
  polluted with patterns which never will be seen again.
</p></li><li class="listitem"><p>Encryption integration
</p><p>  As mentioned previously, patterns of encrypted data streams should
  not be stored in the dictionary. In trusted environments, WAN
  optimizers might be able to proxy and perform decryption and
  re-encryption on behalf of the sender. This way they are able to
  decrypt the data, optimize it over the WAN and then to encrypt
  it again to the receiver.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32335592"></a>1.3.3. Application latency optimization</h3></div></div></div><p>Application latency optimization improves the performance of the
protocol on top of the transport layer. The gain is when the protocol
is predictable or is chatty, meaning that many little requests and
responses are exchanged. This is fine for the zero millisecond delay
to a server on the local LAN, but very expensive if it has to go
over the WAN.  To be able to do latency optimization, a deep
understanding of the protocol and the client behaviour is required.
</p><p>Transaction prediction is part of latency optimization. It is a
technique to predict what the next request from the client is, based
on the past and current requests. For example, on a network file
system, if a client opens a file and asks for the first block of a
file, there is a huge chance it will ask for the second and the
third block of that file too. If however the client opens a file,
seeks to a random position, reads 16 bytes, seeks to another position,
reads 32 bytes, seeks to another position and reads 24 bytes, that
behaviour is not predictable.
</p><p>Various latency optimization techniques include:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Towards network file systems; the basic operations towards remote
  file systems include the reading and writing of files and scanning
  through directories.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Read-ahead: When a client opens a file and reads the first
    block, there is a huge chance that it will after that ask for
    the second block and the third block. The latency optimization
    sees the request for the first block, but asks the server for
    the first, second and third block and returns the first block
    to the client. When the client asks for the second block, the
    latency optimization already has this block available and the
    request doesn't have to go over the WAN anymore.
</p></li><li class="listitem"><p>Write-behind: When the client creates a new file and writes the
    first block to it, the local latency optimization can tell the
    client that the block was written after which the client can
    prepare and start to write the next block. In the meantime the
    latency optimization sends the data to the server.
</p></li><li class="listitem"><p>Directory caching: When a client asks the first entry in a
    directory on a server, there is a huge chance it will also ask
    for the next directory entries. The latency optimization will
    ask the server for all directory entries, send them to the
    client side latency optimization which then can answer the
    consecutive requests from the client without having to send the
    requests to the remote server.
</p></li><li class="listitem"><p>Pre-population: This is a technique in which new files on network
    file system are transferred over the WAN so that the Steelhead
    appliances know about the patterns and when the user asks for
    them they can be warm transferred.
</p></li></ul></div><p>  Data integrity is very important in network file systems, the
  client should not get the impression that the data has been written
  to disk while the data is still in transit. There are several
  commands which shouldn't touch local latency optimization, for
  example the open and close commands: It is the server which is
  saying Yes or No on the success of that command.
</p></li><li class="listitem"><p>Towards mail servers; the basic operations towards mail-servers
  are to open a mailbox, retrieve the contents of a message, retrieve
  attachments for a message, general mailbox maintenance, to move
  messages between folders and to deliver new messages.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Attachment warming: When the mail client polls for new email
    and retrieves a list of new messages, the latency optimization
    can check the contents to see if there are any attachments on
    these messages. If there are attachments, they can be downloaded 
    by latency optimization so that the patterns are known in the dictionary.
    When the user later reads the message and wants to see the
    attachment, the patterns are already known in the dictionary
    and the attachment gets retrieved in "a warm transfer".
</p></li><li class="listitem"><p>Attachment write behind: This works just like the write behind
    feature of the network file systems.
</p></li></ul></div></li><li class="listitem"><p>Towards web servers; Web servers receive a request and return an
  object. This object can contain references to other objects, which
  in turn need to be requested.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Caching of objects: If the returned object is a static object
    which is valid for a long time, for example an audio file or an
    image, the latency optimization uses the meta data of this
    object to check how long the object is valid for. If another
    client asks for the same object and the object is still valid,
    the latency optimization can serve it to the client without
    having to get it from the server again.
    
</p></li><li class="listitem"><p>Prefetching of static objects: When the object requested can
    contain references, the latency optimization can parse the
    object and retrieve the referenced objects in it before the
    client asks for them.
</p></li></ul></div></li></ul></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32357928"></a>1.4. Effects of WAN optimization on other equipment</h2></div></div></div><p>WAN optimization will remove the WAN bottleneck, but that means
that suddenly other bottlenecks can appear:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The amount of traffic on the WAN side of the Steelhead appliance
  will decrease, but on the other side the amount of traffic on the
  LAN side will increase.
</p><p>  Without WAN optimization, the maximum amount of traffic on the
  LAN side is the same as the maximum amount of traffic on the WAN
  side. With WAN optimization, the maximum amount of traffic on the
  LAN is suddenly not limited to the maximum amount of traffic on
  the WAN, it will be a multitude of it.
</p><p>  For example, if the WAN link is 10 Mbps and the optimized factor
  is 15x, then the amount of traffic on the LAN side will be 150 Mbps. 
  If the speed of the Ethernet segment on the LAN side is 100 Mbps,
  then the LAN side is suddenly the bottleneck.
</p><div class="figure"><a name="idp32362280"></a><p class="title"><b>Figure 1.6. LAN/WAN bandwidth comparisons</b></p><div class="figure-contents"><pre class="screen">
       Without WAN optimization
B p s |
y e e |+x+x+x+x+x+x+x+x+x+x+x+x+x+x+   + is incoming WAN
t r c |                                x is outgoing LAN
e   o |
s   n |
    d +-----------------------------
                             time -&gt;

       With WAN optimization
B p s |xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
y e e |                                + is incoming WAN
t r c |                                x is outgoing LAN
e   o |+++++++++++++++++++++++++++++
s   n |
    d +-----------------------------
                             time -&gt;
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>The traffic pattern will change: There will be higher bursts of
  traffic on the client-side LAN, but they will be shorter.
</p><div class="figure"><a name="idp32365864"></a><p class="title"><b>Figure 1.7. Traffic pattern on the client-side LAN side.</b></p><div class="figure-contents"><pre class="screen">  Without WAN optimization    With WAN optimization

  LAN traffic out             LAN traffic out
  |                           | ___
  |                           ||...|
  | _________                 ||...|
  ||.........|                ||...|
0 +-----------              0 +-------------
       time -&gt;                       time -&gt;
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>The CPU utilization on routers and switches behind the Steelhead
  appliances will change: The amount of packets and data transferred
  will stay the same over time, but the number of packets per
  time-period will increase.
</p></li><li class="listitem"><p>The CPU utilization on routers and switches between the Steelhead
  appliances will change: The number of packets transferred will
  decrease and the payload will be smaller. Due to the
  possibility to send more data, the number of packets will increase.
</p></li><li class="listitem"><p>On file servers, the I/O pattern to hard disks will change because
  the speed with which files are transferred over the network is
  faster.
</p><div class="figure"><a name="idp32371688"></a><p class="title"><b>Figure 1.8. Disk load on the server.</b></p><div class="figure-contents"><pre class="screen">  Without WAN optimization    With WAN optimization

  Disk load                   Disk load 
  |                           | ___
  |                           ||...|
  | _________                 ||...|
  ||.........|                ||...|
0 +-----------              0 +-------------
       time -&gt;                       time -&gt;
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>Latency optimization will not only cause the data to be retrieved
  faster from the servers, it will also increase the amount of
  traffic in cases where transaction prediction failed.
</p><div class="figure"><a name="idp32374440"></a><p class="title"><b>Figure 1.9. Traffic pattern on the server-side LAN side.</b></p><div class="figure-contents"><pre class="screen">  Without WAN optimization    With WAN optimization

  LAN traffic in              LAN traffic in
  |                           | ______
  |                           ||......|
  | _________                 ||......|
  ||.........|                ||......|
0 +-----------              0 +-------------
       time -&gt;                       time -&gt;
</pre></div></div><br class="figure-break"></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="The_Riverbed_Approach_to_WAN_Optimization"></a>Chapter 2. The Riverbed Approach to WAN Optimization</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp32383656">2.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp32503272">2.2. Appliance Setup</a></span></dt><dt><span class="sect1"><a href="#idp32684712">2.3. Basic configuration of a Steelhead appliance</a></span></dt><dt><span class="sect1"><a href="#idp32734184">2.4. The layout of an optimized TCP session</a></span></dt><dt><span class="sect1"><a href="#idp32748456">2.5. The setup of an optimized TCP session.</a></span></dt><dt><span class="sect1"><a href="#idp32796648">2.6. WAN Visibility</a></span></dt><dt><span class="sect1"><a href="#idp32801192">2.7. The optimization protocol</a></span></dt><dt><span class="sect1"><a href="#idp32809768">2.8. Hardware models</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32383656"></a>2.1. Index</h2></div></div></div><p>This chapter describes how Riverbed has implemented its WAN
optimization products.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The design of the Steelhead appliances, physical and logical.
</p></li><li class="listitem"><p>The startup of the Steelhead appliance, the processes running on
  it.
</p></li><li class="listitem"><p>The configuration of the Steelhead appliance, routing of the
  packets, interface settings, license keys.
</p></li><li class="listitem"><p>The design of an optimized TCP session, the setup of an optimized
  TCP session.
</p></li><li class="listitem"><p>In-path rules, peering rules, WAN visibility.
</p></li><li class="listitem"><p>Different hardware models.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32503272"></a>2.2. Appliance Setup</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32504488"></a>2.2.1. Technical overview</h3></div></div></div><p>Riverbed has two types of technologies for WAN optimization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Steelhead technology, which performs the WAN optimization.
</p><p>  Note that the Steelhead Mobile, Cloud Steelhead, Steelhead Cloud
  Accelerator and Virtual Steelhead all have the same technology
  as the Steelhead appliance but are implemented in different
  scenarios:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Steelhead Mobile runs on desktop and laptop computers
    running the Microsoft Windows and Apple OS X operating system
    and optimizes traffic from the single computer it is running
    on.
</p></li><li class="listitem"><p>Cloud Steelhead runs in cloud environments such as Amazon
    EC2 and optimizes traffic towards hosts in the cloud.
</p></li><li class="listitem"><p>Steelhead Cloud Accelerator runs in the Akamai network and
    optimizes traffic towards Software-as-a-Service applications
    like Microsoft Office365 and Salesforce.
</p></li><li class="listitem"><p>Virtual Steelhead runs as a virtual machine under VMware ESXi.
</p></li></ul></div></li><li class="listitem"><p>The Interceptor technology, which acts as a redirector of traffic
  towards Steelhead appliances.
</p><p>  Unlike other traffic redirection protocols like PBR or WCCP which
  are agnostic of the device it is forwarding to, the Interceptor
  only works with Steelhead appliances and takes advantage of the
  knowledge of the status reported by the Steelhead appliances.
</p></li></ul></div><p>There are two related appliances developed by Riverbed, which
do not perform any WAN optimization but are used to manage and monitor
the Steelhead appliances in the network:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Steelhead Mobile Controller (SMC), a configuration and reporting
  appliance to manage Steelhead Mobile deployments.
</p></li><li class="listitem"><p>The Central Management Console (CMC), a configuration and reporting
  appliance to manage configurations and monitor the behaviour of
  Steelhead appliances, Interceptor appliances and Steelhead Mobile
  Controllers.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32547816"></a>2.2.2. Design of the Steelhead appliance</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32548776"></a>2.2.2.1. The physical design</h4></div></div></div><p>From the outside, a Steelhead appliance has the following typical
features:
</p><div class="figure"><a name="idp32550120"></a><p class="title"><b>Figure 2.1. Back of a Steelhead appliance</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/02-steelhead-diagram.png" align="middle" alt="Back of a Steelhead appliance"></td></tr></table></div></div></div><br class="figure-break"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A serial console port, to be used to do the initial configuration
  of the device and a way to access the device in case it isn't
  reachable anymore via the IP addresses configured on the primary
  interface. Its speed is 9600 bps, 8 data bits and one stop bit.
</p></li><li class="listitem"><p>Two network interfaces, primary and auxiliary. These are
  the base interfaces used for management. The primary interface
  is normally the management port, which should be used to access
  the device via the network. The auxiliary interface is commonly
  used for data store synchronization but can also be used for
  management.
</p></li><li class="listitem"><p>One or more by-pass cards, each with a pair of network interfaces
  labeled LAN and WAN. These are the interfaces which are connected
  to the WAN router and the LAN switch. The by-pass cards can be
  integrated on the chassis or installed via additional PCI cards.
</p></li></ul></div><p>Depending on the model, the following features may be available:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>LED alarm lights on the front. They show the operational status
  of the device.
</p></li><li class="listitem"><p>Hot-swappable hard disks on the front.
</p></li><li class="listitem"><p>One or more hot-swappable power supplies.
</p></li></ul></div><p>On the inside there are several other important features:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The machine has two hardware watchdogs.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>The hardware watchdog, which will reboot the appliance
    if a user-land process has not been communicated with the
    hardware watchdog for 30 seconds. This prevents the Steelhead
    appliance to hang indefinitely and gives it a chance to recover.
</p></li><li class="listitem"><p>The network watchdog, which will put the by-pass card into
    fail-to-wire or fail-to-block mode if the optimization service
    has not communicated with the network watchdog for 7 seconds
    or more. This will remove the Steelhead appliance from the path
    in the network if there are problems with the optimization
    service.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>If the machine is in normal operation, the LAN and WAN ports of
  the by-pass card are in operational mode and the optimization
  service is intercepting the packets. If the appliance gets powered
  off, the by-pass card either goes in fail-to-wire or fail-to-block
  mode. In the former mode, the LAN and WAN port are directly
  cross-connected with each other so that the LAN switch and WAN
  router are on Ethernet level directly connected to each other.
  In the latter mode, the LAN and WAN port will be disconnected from
  each other and no Ethernet link will be established.
</p><div class="figure"><a name="idp32624936"></a><p class="title"><b>Figure 2.2. Ethernet links in normal operation, fail-to-wire and fail-to-block.</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/02-steelhead-failtowire.png" align="middle" alt="Ethernet links in normal operation, fail-to-wire and fail-to-block."></td></tr></table></div></div></div><br class="figure-break"></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32627816"></a>2.2.2.2. The logical design</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>As mentioned before, the primary and auxiliary interfaces are for the
  management of the port. Despite being two different interfaces,
  they cannot have an IP address on the same IP subnet as they share
  the same IP routing table.
</p></li><li class="listitem"><p>Each physical LAN and WAN interface is combined into a virtual
  in-path interface in the configuration of the Steelhead appliance.
  The IP subnet on the in-path interface can overlap with the IP
  subnet of the primary and auxiliary interfaces and with the other
  in-path interfaces. Each in-path interface has its own routing
  table and must have an IP address and a default gateway configured
  before optimization is possible via this in-path interface.
</p></li><li class="listitem"><p>Each Steelhead appliance has a data store to store its dictionary
  and every data store has a unique data store ID to identify the
  data store with other Steelhead appliances in the network.  The
  exceptions for these are Steelhead appliances which are in data
  store synchronization cluster, where the data store ID of the
  slave is the same value as the master.
</p></li><li class="listitem"><p>Some Steelhead appliances have only one hard disk, others have
  multiple hard disks in a RAID0, RAID1 or RAID10 setup so that for
  the operation system it looks like one giant hard disk. The
  operating system, the optimization service and the data store are
  all located on various partitions on this one giant hard disk.
</p><p>  Devices with a Fault Tolerant Segstore (FTS) have their operating
  system and optimization service separated from the data store: These
  devices have a normal RAID1 implementation for the operating
  system and the optimization service, while the data store is
  spread over the remaining disks. The contents of the data store
  are not protected for disk-failure but will be lost when one of
  the disks of the FTS fails. The advantage of the FTS is that there
  is no RAID overhead, the full capacity of the disks installed in
  the Steelhead appliance is used and there is no RAID rebuild
  overhead when a disk gets replaced.
</p></li><li class="listitem"><p>The Steelhead appliance has flash memory storage where it boots
  from and where it keeps a copy of the configuration. It allows
  models without the RAID1 or RAID10 capability to rebuild themselves
  in the field if the hard disk gets replaced.
</p></li><li class="listitem"><p>The Steelhead appliance has two partitions which it can boot into,
  one with the current version of RiOS and one with the version installed
  prior to the last upgrade. When a console is connected during 
  boot-up of the appliance, you will have the option to select the
  partition to boot from.
</p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32650408"></a>2.2.3. Start-up of the Steelhead appliance</h3></div></div></div><p>When a serial console is attached to the serial port of the Steelhead
appliance, you can follow the start-up sequence of the Steelhead
appliance.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Power On Self Test (POST) of the machine, during whic hthe
  BIOS is accessible and the RAID controller gets initialized.
</p></li><li class="listitem"><p>The boot-loader, which selects the RiOS version to boot from.
</p></li><li class="listitem"><p>The start-up of the Linux kernel and loading of various device
  drivers.
</p></li><li class="listitem"><p>The mounting, and if needed the checking, of file systems.
</p></li><li class="listitem"><p>If a software upgrade or downgrade needs to be done, this happens
  now.
</p></li><li class="listitem"><p>Other upgrades such as a network card firmware and RAID
  Kit installation will also occur at this stage.
</p></li><li class="listitem"><p>Start of the process
<span class="italics">pm</span>.
  This process is the RiOS Process Manager which controls all the
  RiOS specific processes, such as the statistics process, the
  optimization service, the management process, and the SNMP service
  related processes to name a few.
</p></li><li class="listitem"><p>From now on you will be able to login to the appliance via the
  network and via serial console.
</p></li></ul></div><p>Once the Process Manager is started, the configuration of
the network interfaces will be applied, but the by-pass card will
not go out of fail-to-wire or fail-to-block yet: This happens only
when the optimization service has completed the initialization and
has become operational.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="riverbedapproach_appliancesetup_processes"></a>2.2.4. The processes on the Steelhead appliance</h3></div></div></div><p>Besides the optimization service, there are other processes to
support the operation of the Steelhead appliance. The following
lists contain the processes known on a Steelhead appliance running
RiOS version 7.0, but some processes are only run when certain
features are enabled. This list can be obtained with the commands
<code class="computeroutput">show pm process ?</code>
on the CLI of the Steelhead appliance.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32684136"></a>2.2.4.1. Optimization service related processes</h4></div></div></div><p>This is a list of the most important process on the Steelhead appliance:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="bold"><strong>acp</strong></span>,
the Akamai tunnel process.
</p></li><li class="listitem"><p>
<span class="bold"><strong>alarmd</strong></span>,
the Alarm manager
</p></li><li class="listitem"><p>
<span class="bold"><strong>cli</strong></span>,
the CLI of the Steelhead appliance.
</p></li><li class="listitem"><p>
<span class="bold"><strong>cmcfc</strong></span>,
the CMC auto-registration.
</p></li><li class="listitem"><p>
<span class="bold"><strong>httpd</strong></span>,
the web server for the GUI.
</p></li><li class="listitem"><p>
<span class="bold"><strong>mgmtd</strong></span>,
the central management process.
</p></li><li class="listitem"><p>
<span class="bold"><strong>pm</strong></span>,
the Process Manager which keeps track of all Steelhead related processes.
</p></li><li class="listitem"><p>
<span class="bold"><strong>qosd</strong></span>,
the interface towards the QoS service.
</p></li><li class="listitem"><p>
<span class="bold"><strong>rcud</strong></span>,
related to CIFS pre-population.
</p></li><li class="listitem"><p>
<span class="bold"><strong>rgp</strong></span>,
CMC management related process.
</p></li><li class="listitem"><p>
<span class="bold"><strong>rpgd</strong></span>,
CMC management related process.
</p></li><li class="listitem"><p>
<span class="bold"><strong>rspd</strong></span>,
RSP watchdog
</p></li><li class="listitem"><p>
<span class="bold"><strong>shark</strong></span>,
for Cascade Pilot integration
</p></li><li class="listitem"><p>
<span class="bold"><strong>sched</strong></span>,
the job scheduler.
</p></li><li class="listitem"><p>
<span class="bold"><strong>sport</strong></span>,
the optimization service.
</p></li><li class="listitem"><p>
<span class="bold"><strong>statsd</strong></span>,
the statistics collection process.
</p></li><li class="listitem"><p>
<span class="bold"><strong>virt_wrapperd</strong></span>,
RSP related.
</p></li><li class="listitem"><p>
<span class="bold"><strong>wdt</strong></span>,
the user-land process to keep the watchdog happy.
</p></li><li class="listitem"><p>
<span class="bold"><strong>webasd</strong></span>,
related to the web server for the GUI.
</p></li><li class="listitem"><p>
<span class="bold"><strong>winbind</strong></span>,
for Active Directory integration.
</p></li></ul></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32684712"></a>2.3. Basic configuration of a Steelhead appliance</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32715816"></a>2.3.1. Host configuration</h3></div></div></div><p>The Steelhead appliance needs to know its hostname, DNS domain
name(s), DNS server(s) and NTP server(s).
</p><p>The hostname is used to create a self-signed SSL certificate for
HTTPS access to GUI of the Steelhead appliance, displayed in the
list of the Connected Appliances overview on other Steelhead
appliances, used in the SSL certificate for Secure Peering, used
during the joining of the Steelhead appliance to an Active Directory
domain and used on the login page of the GUI and on the CMC in the
appliances list.
</p><p>The domain names, DNS servers and NTP servers will be important
when the Steelhead appliance performs CIFS Pre-population and signed
CIFS and encrypted MAPI latency optimization as this involves
integration into the Active Directory infrastructure.
</p><p>Using valid NTP servers is a good practice even without Active
Directory integration, as it makes sure that the logging and
statistics match with other Steelhead appliances. By default the
devices are configured with the NTP server of Riverbed and NTP
servers from the pool.ntp.org project. If the Steelhead appliances
cannot communicate towards to the public Internet, make sure that
they use the internal NTP servers of your network.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32717608"></a>2.3.2. Management interface configuration</h3></div></div></div><p>The physical management network interfaces of the Steelhead appliance
are the primary and the auxiliary network interfaces. As a general
habit, you should access the Steelhead appliances via the IP address
defined on the primary interface.
</p><p>The primary interface needs an IP address, subnet mask and default
gateway. The auxiliary interface should only be needed to be configured
if Data Store Synchronization is enabled or if a separate private
network management network is used.
</p><p>Both the primary interface and the auxiliary interface share the
same routing table and it is not possible to use addresses from the
same IP subnet on the two interfaces.
</p><p>When the Steelhead appliance is initiating traffic, for example
to send out SNMP traps or when it is downloading software, it uses
the IP address of the primary interface as the source IP address.
</p><p>To force management packets out via the auxiliary interface, the destination
IP subnet should have a gateway IP address defined on the auxiliary
interface IP subnet:
</p><div class="figure"><a name="idp32719656"></a><p class="title"><b>Figure 2.3. Management via both the primary and auxiliary interfaces</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/02-managementconfiguration.png" align="middle" width="100%" alt="Management via both the primary and auxiliary interfaces"></td></tr></table></div></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32721832"></a>2.3.3. In-path interface configuration</h3></div></div></div><p>The in-path interfaces behave partly like a network bridge and
partly like a router:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>All traffic not going to be optimized is bridged through from the
  LAN port to the WAN port and vice versa without changing it, not
  even decreasing the TTL in the header of the IP packet.
</p></li><li class="listitem"><p>All traffic to be optimized will follow the routing configuration
  and routing decisions as defined on the in-path interface and
  learned via Simplified Routing.
</p></li></ul></div><p>Each active in-path interface needs an unique IP address, subnet
mask and default gateway. Optionally it can have a VLAN tag ID configured
on which the IP subnet is defined. Explicit routing entries can be
defined for the traffic terminating on or initiated from the in-path
interface.
</p><p>The routing table of each in-path interface is separate and each
in-path interface can have an IP address in subnets on the others
IP subnets.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32724264"></a>2.3.3.1. Simplified Routing</h4></div></div></div><p>Simplified Routing is a feature which can be used to overcome the
administrative overhead of having to configure all the IP subnets
behind the LAN switch or LAN router or the multiple gateways on the
WAN side.
</p><p>By default, the routing table on an in-path interface has only the
default gateway. This works fine if the IP subnet defined on the
in-path interface is the same IP subnet as all the hosts behind the
Steelhead appliance. If however there are multiple IP subnets behind
the Steelhead appliance, either because the IP subnet is defined
on the WAN router or because the IP subnet is defined on the LAN
router, then all traffic for those subnets will be send to the
default gateway before being send to the right IP subnet, traveling
via the WAN interface back through the Steelhead appliance before
it reaches the LAN router it had to end up in the beginning.
</p><p>This is further explained in the
<a class="xref" href="#operation_iproutingrelatedissues" title="5.16. IP Routing Related Issues">IP Routing Related Issues</a> section in the Operation Related Chapter.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32725928"></a>2.3.4. Interface speeds</h3></div></div></div><p>All interfaces can have either auto-negotiation defined or have a
fixed speed and duplex setting defined. These days, general
interoperability is not a reason to use a fixed speed and duplex
anymore and auto-negotiation should be used everywhere unless not
possible. This is especially important for gigabit speed interfaces,
which is explained in a later section.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32726952"></a>2.3.4.1. Fixed speed and duplex settings</h4></div></div></div><p>Keep in mind that when a fixed speed and duplex setting is used
that the LAN and the WAN interface and the devices connected to
them should all be at the same speed and duplex settings.
</p><p>If the interface speed and duplex settings of the LAN and WAN
interfaces are different, no Ethernet link will be established if
the Steelhead appliance is rebooted or turned off and all networks
behind the Steelhead appliance will be unreachable.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32728680"></a>2.3.4.2. Gigabit NICs with fixed speed</h4></div></div></div><p>10 Mbps Ethernet and 100 Mbps Fast Ethernet network cards can be
configured to a fixed speed and duplex settings which bypasses the
negotiation phase of setting up of the Ethernet link between the
devices.
</p><p>There is no such feature as a fixed speed and duplex settings for
the 1000 Mbps gigabit and faster NICs, the 802.3ab specification[SOURCE
IEEE 802.3ab] stated that auto-negotiation is a requirement.
</p><p>During the negotiation phase, each network card advertises the
speeds it is capable of. With these "fixed speed" gigabit configurations,
it will only advertise the 1000 Mbps speed and not the 100 Mbps and
10 Mbps speeds, thus forcing the device on the other side to accept
the 1000 Mbps speed.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32730088"></a>2.3.5. License keys</h3></div></div></div><p>Riverbed uses license keys to determine which feature-sets are
available on the Steelhead appliances in your network. The following
licenses are the most common feature sets:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Three license keys are included by default with every Steelhead
  appliance: The BASE, the CIFS and the MAPI licenses.  Without
  these three licenses the Steelhead appliance won't be able to
  perform its basic optimization services.
</p></li><li class="listitem"><p>The SSL license allows optimization of SSL encrypted traffic
  and SSL tunneling for the secure inner channel feature. It can
  be obtained for without charge from Riverbed for Steelhead
  appliances installed in countries without USA export restrictions
  against them.
</p></li><li class="listitem"><p>The RSP license, which can be used to enable the RSP virtualization
  system.
</p></li><li class="listitem"><p>Model base and configuration upgrade licenses. With the development
  of the xx50 series models, the upgrade from a certain model to a
  higher capacity configuration can be done via a license key without
  the need for a hardware swap.
</p></li></ul></div><p>Licenses are only valid for the Steelhead appliance with the serial
number they are ordered for. When a Steelhead appliance needs to
be replaced via an RMA, replacement licenses will be submitted
during the RMA process.
</p><p>The list of license keys for a Steelhead appliance can be found on
the Riverbed Support website under the assets list.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32734184"></a>2.4. The layout of an optimized TCP session</h2></div></div></div><p>The Riverbed implementation of an optimized TCP session is best
described as a TCP tunnel: The internal channel between the two
Steelhead appliances is transported via a TCP session. Of the
optimized TCP session, only the TCP payload gets optimized, the
details of the transport layer itself (the TCP header, IP header
and Ethernet frame header) does not get forwarded.
</p><p>Because of that design, there will be three different TCP sessions
on the path between the client and the server, each which look
similar but with their own characteristics and behaviour.
</p><div class="figure"><a name="idp32735336"></a><p class="title"><b>Figure 2.4. Three independent TCP sessions</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/02-threetcpsessions.png" align="middle" width="100%" alt="Three independent TCP sessions"></td></tr></table></div></div></div><br class="figure-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32737000"></a>2.4.1. Three different TCP sessions</h3></div></div></div><p>The first TCP session is between the client and the client-side
Steelhead appliance. It will be a fast connection with a low
latency, most likely to just behind the LAN switch where the client
is located. This TCP session is setup by the client and will have
the TCP capabilities that the client supports, for example if the
client doesn't support TCP Window Scaling, then this TCP session
will have a sliding window with a maximum size of 64 Kb. This should
not be too much of a problem, since the latency on this part of the
path is close to zero. This TCP session is called the client-side
outer channel.
</p><p>This TCP session has the following characteristics:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The IP addresses are the IP addresses of the client and server.
</p></li><li class="listitem"><p>The TCP ports are the TCP ports used by the client and the server[*].
</p></li><li class="listitem"><p>The TCP Sequence numbers used are specific for the TCP session
  between the client and the client-side Steelhead appliance.
</p></li><li class="listitem"><p>It only supports the TCP features that the client offers.
</p></li></ul></div><p>The second TCP session is between the two Steelhead appliances. In
general it will be a slow connection with a high latency going over
the WAN links. The Steelhead appliances will use all possible TCP
features they share, like TCP Window Scaling, TCP Fast Retransmission,
TCP Selective ACK, TCP Timestamps and Packet Loss behaviour. This
TCP session is called the inner channel.
</p><p>This TCP session has the following characteristics (by default):
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The IP addresses are the IP addresses of the in-path interface
  of the Steelhead appliances.[**]
</p></li><li class="listitem"><p>The TCP ports used on the server-side Steelhead appliance is
  7800, or 7810 for Fixed Target configurations.[**]
</p></li><li class="listitem"><p>The TCP Sequence numbers used are specific for the TCP session
  between the two Steelhead appliances.
</p></li><li class="listitem"><p>It supports the TCP features that the Steelhead appliances support.
</p></li></ul></div><p>The third TCP session is between the server-side Steelhead appliance
and the server. It will be a fast connection with a low latency,
most likely to just after the LAN switch where the server is located.
The Steelhead appliance will offer all possible TCP features to the
server, which might or might not support them. This TCP session is
called the server-side outer channel.
</p><p>This TCP session has normally the following characteristics:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The IP addresses are the IP addresses of the client and server.
</p></li><li class="listitem"><p>The TCP ports are the TCP ports used by the client and the server[*].
</p></li><li class="listitem"><p>The TCP Sequence numbers are specific for the TCP session between
  the server-side Steelhead appliance and the server.
</p></li><li class="listitem"><p>It supports the TCP features that the server supports.
</p></li></ul></div><p>Because of these different characteristics on TCP level, especially
the difference in TCP sequence numbers, optimized TCP sessions will
not recover when the optimization service on one of the Steelhead
appliance is restarted or traffic is rerouted to a path without a
Steelhead appliance in place.
</p><p>[*] The exception on this is the with MAPI latency optimization, there
the destination TCP port of 7830 is used between the client and
client-side Steelhead appliance.
</p><p>[**] In the default Correct Addressing WAN Visibility.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32748456"></a>2.5. The setup of an optimized TCP session.</h2></div></div></div><p>To setup a new optimized TCP session, the Steelhead appliance at
the client-side needs to know if there is another Steelhead in the
path and where to setup the inner channel to.
</p><p>The setup of a TCP session happens with the three way handshake[SOURCE:RFC
793] where the client sends a TCP packet with the SYN flag set in
the TCP header, the server replies with a TCP packet with the SYN
and ACK flags set in the TCP header and the client replies with a
TCP packet with the ACK flag set in the TCP header.
</p><div class="figure"><a name="idp32749608"></a><p class="title"><b>Figure 2.5. The setup of a normal TCP session without Steelhead appliances</b></p><div class="figure-contents"><pre class="screen">State                 Client                   Server    Time
Send TCP SYN              S &gt;-----
                                  '-----                   |
Receive TCP SYN                         '-----&gt;            |
                                                           |
Send TCP SYN/ACK                         -----&lt; SA         |
                                   -----'                  |
Receive TCP SYN/ACK         &lt;-----'                        v

Send TCP ACK              A &gt;-----
                                  '-----
Receive TCP ACK                         '-----&gt;

Data can be exchanged       &gt;-----------------&gt;
forwards and backwards      &lt;-----------------&lt;

                            &gt;-- initiated by
                            --&gt; received by
</pre></div></div><br class="figure-break"><p>With a pair of Steelhead appliances in the path, they will see this
setup of the TCP session:
</p><div class="figure"><a name="idp32751144"></a><p class="title"><b>Figure 2.6. The setup of a normal TCP session seen by Steelhead appliances </b></p><div class="figure-contents"><pre class="screen">Line State                 Client   CSH   SSH   Server    Time
  1  Send TCP SYN              S &gt;-&gt;
  2                                    --&gt;                  |
  3  Receive TCP SYN                         --&gt;            |
  4                                                         |
  5  Send TCP SYN/ACK                        &lt;-&lt; SA         |
  6                                    &lt;--                  |
  7  Receive TCP SYN/ACK         &lt;--                        v
  8  
  9  Send TCP ACK              A &gt;-&gt; 
 10                                    --&gt; 
 11  Receive TCP ACK                         --&gt;

 12  Data can be exchanged       &gt;--   ---   --&gt;
 13  forwards and backwards      &lt;--   ---   --&lt;

                            &gt;-- initiated by
                            --&gt; received by
</pre></div></div><br class="figure-break"><p>When the Steelhead appliance sees a TCP packet with the SYN flag
set coming in on the LAN side, it will know that this is a new TCP
session initiated by a local client. The Steelhead appliance will
check the In-path Rules table to determine what should happen with
the TCP session:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>It can be passed through, the Steelhead appliance does not
  intercept it.
</p></li><li class="listitem"><p>It can be optimized to another Steelhead appliance configured by
  a Fixed Target rule. This happens unconditionally, the other
  Steelhead appliances cannot ignore this.
</p></li><li class="listitem"><p>It can be tagged for optimization via the auto-discovery protocol:
  The Steelhead appliance adds an auto-discovery probe in the TCP
  options part of the TCP header so any other Steelhead appliance
  in the path will know that this TCP session can become an optimized
  TCP session. The other Steelhead appliance will check its Peering
  Rules table to determine if it wants to optimize with this Steelhead
  appliance or for this TCP session.
</p></li></ul></div><p>A TCP SYN packet without the auto-discovery probe is called a
<span class="italics">naked SYN</span>.
A TCP SYN packet with the auto-discovery probe is called a
<span class="italics">SYN+</span>.
A TCP SYN/ACK with the auto-discovery probe is called a
<span class="italics">SYN/ACK+</span>.
</p><p>If a naked SYN is seen on the WAN side of the Steelhead appliance,
it will ignore it and mark the TCP session as pass-through Note
that this is only valid for true in-path designs. For virtual in-path
designs where the traffic is forwarded via WCCP, PBR or Interceptors,
all traffic is received via the WAN interface and thus it will
accept and process a naked SYN packet on the WAN side.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32757096"></a>2.5.1. The Out-of-Band Splice</h3></div></div></div><p>When two Steelhead appliances see each other for the first time,
either via auto-discovery or via a fixed target rule, they will
start with the setup an Out-of-Band (OOB) Splice. This is a control
TCP session between the two Steelhead appliances, used to test the
connectivity towards between the two Steelhead appliances.
</p><div class="figure"><a name="idp32757672"></a><p class="title"><b>Figure 2.7. Setup of a new OOB Splice</b></p><div class="figure-contents"><pre class="screen">SH sport[24798]: [splice/oob.INFO] 1 {- -} New OOB Splice created at 10.0.1.6 for peer 192 \
    .168.1.6 
SH sport[24798]: [mgmt.INFO] - {- -} mgmtd notified that remote peer 192.168.1.6 was disco \
    vered 
SH sport[24798]: [splice/oob.INFO] 1 {- -} Establishing OOB Splice from 10.0.1.6:0 to 192. \
    168.1.6:7800 
SH mgmtd[3766]: [mgmtd.INFO]: EVENT:  /rbt/sport/peer/event/added 
SH sport[24798]: [splice/oob.INFO] 1 {- -} OOB Splice connected from 10.0.1.6:40271 to 192 \
    .168.1.6:7800 
SH sport[24798]: [splice/oob.INFO] 1 {- -} Negotiated sport protocol version: 8 for peer:  \
    192.168.1.6:7800 
</pre></div></div><br class="figure-break"><p>It has the following behaviour:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>After the setup of the OOB Splice, the two Steelhead appliances
  will exchange system information and a list of capabilities. This
  information contains the hostname, RiOS version and IP addresses.
  This capabilities list will contain the latency optimizations
  supported and help the two Steelhead appliances to match the level
  of these capabilities.
</p></li><li class="listitem"><p>When a Steelhead appliance goes into admission control or the
  optimization service gets restarted, the OOB Splice will be closed.
</p><div class="figure"><a name="idp32772904"></a><p class="title"><b>Figure 2.8. Termination of an OOB Splice due to admission control</b></p><div class="figure-contents"><pre class="screen">SH sport[6693]: [splice/oob.NOTICE] 8 {- -} Received disconnect cause="Admission control"  \
    laddr=10.0.1.6:7800 raddr=192.168.1.6:44264
SH sport[6693]: [splice/oob.NOTICE] 8 {- -} Lost OOB Splice between laddr=10.0.1.6:7800 an \
    d raddr=192.168.1.6:7800
</pre></div></div><br class="figure-break"><p>  The first line is the message that the other side goes into
  Admission Control. The second line is that the OOB Splice is about
  to be terminated.
</p></li><li class="listitem"><p>The OOB Splice has a TCP Keep Alive interval of 20 seconds. This
  means that if there is a network routing issue towards the other
  side, within one minute the Steelhead appliances will know that
  the other side is unreachable. Except for these TCP keep-alive
  packets there is no other data being transferred during normal
  operations.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32775016"></a>2.5.2. The Connection Pool</h3></div></div></div><p>Once the OOB Splice is setup, the optimization service will setup
a Connection Pool towards the remote Steelhead appliance. This is
a pool of 20 TCP sessions which can later be used to convert to
inner channels. Every time one of these TCP sessions is used to
create an inner channel, a replacement TCP session for the pool
will be setup.  The TCP Keep Alive interval is very large set to
20 minutes.
</p><p>The Connection Pool sessions is maintained as long as the OOB Splice
is established. If the OOB Splice gets terminated, the TCP sessions
in the unused Connection Pool will be terminated too.
</p><div class="figure"><a name="idp32775976"></a><p class="title"><b>Figure 2.9. Termination of the Connection Pool because of the loss of the OOB Splice</b></p><div class="figure-contents"><pre class="screen">SH sport[6693]: [splice/oob.NOTICE] 8 {- -} Lost OOB Splice between laddr=10.0.1.6:7800 an \
    d raddr=192.168.1.6:7800
SH sport[6693]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
SH sport[6693]: [spawnsplice.NOTICE] - {- -} (from 192.168.1.6:23210) End of stream readin \
    g splice hdr info. Peer maybe down.
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32776872"></a>2.5.3. In-path rules</h3></div></div></div><p>The default set of in-path rules consist of three pass-through
("don't try to optimize this traffic") statements and a default
auto-discovery rule:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Pass-through of encrypted or secure traffic.
</p></li><li class="listitem"><p>Pass-through of interactive traffic.
</p></li><li class="listitem"><p>Pass-through of Riverbed protocols related to the optimization process.
</p></li><li class="listitem"><p>Auto-discovery of everything else.
</p></li></ul></div><div class="figure"><a name="idp32780392"></a><p class="title"><b>Figure 2.10. In-path rules on a Steelhead appliance.</b></p><div class="figure-contents"><pre class="screen">SH # show in-path rules
 Rule Type P O L N W K VLAN Source Addr        Dest Addr          Port          
----- ---- - - - - - - ---- ------------------ ------------------ --------------
    1 pass - - - - - - all  all                all                Secure        
    2 pass - - - - - - all  all                all                Interactive   
    3 pass - - - - - - all  all                all                RBT-Proto     
  def auto N F F A C N all  all                all                all           

3 user-defined rule(s)

(P) Preoptimization Policy: O=Oracle-Forms S=SSL +=Oracle-Forms-over-SSL N=None
(O) Optimization Policy:    F=Full S=SDR-only C=Compression-only M=SDR-M N=None
(L) Latency Optimizations:  F=Full H=HTTP-only O=Outlook-anywhere N=None
(N) Neural Framing:         A=Always D=Dynamic T=TCP hints N=Never
(W) WAN Visibility Mode:    C=Correct-Addressing
                            P=Port-Transparency
                            F=Full-Transparency
                            R=Full-Transparency w/Reset
(K) Auto Kickoff:           Y=Enabled
                            N=Disabled
</pre></div></div><br class="figure-break"><p>In-path rules can be used to prevent optimization towards certain
machines or services. They can also be used to set specific options
for specific optimized TCP session with regarding to WAN visibility,
data reduction behaviour, pre-optimization features and so on.
</p><p>The in-path rules are parsed in order of definition. Global
pass-through, auto-discovery and fixed target in-path rules should
be added after the default in-path rules. Specific auto-discovery
in-path rules should be added to the end of the list of in-path
rules. This way ensures that you prevent optimization before you
start allowing it.
</p><div class="figure"><a name="idp32782184"></a><p class="title"><b>Figure 2.11. Additional fixed target in-path rule on a Steelhead appliance.</b></p><div class="figure-contents"><pre class="screen">SH # show in-path rules
 Rule Type P O L N W K VLAN Source Addr        Dest Addr          Port          
----- ---- - - - - - - ---- ------------------ ------------------ --------------
    1 pass - - - - - - all  all                all                Secure        
    2 pass - - - - - - all  all                all                Interactive   
    3 pass - - - - - - all  all                all                RBT-Proto     
    4 fixe N F F A - N all  all                192.168.1.1/32     all           
                                   Target: 192.168.1.6        7810           
  def auto N F F A C N all  all                all                all           
</pre></div></div><br class="figure-break"><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32783528"></a>2.5.3.1. Fixed Target in-path rules</h4></div></div></div><p>Fixed Target rules specify the remote Steelhead appliance to be
used for optimization of a certain set of traffic.
It is an administrative task of the order of O(N!) if you would do
it for every Steelhead appliance in the network.
</p><p>Fixed Target rules are often used in environments where auto-discovery
isn't possible because other devices in the network are stripping
the auto-discovery probe or where the auto-discovery process fails
because of policies on firewalls and NAT gateways.
</p><div class="figure"><a name="idp32784680"></a><p class="title"><b>Figure 2.12. The setup of an optimized TCP session using Fixed Target rules.</b></p><div class="figure-contents"><pre class="screen">Line State                 Client   CSH   SSH   Server    Time
  1  Send TCP SYN              S &gt;-&gt;
  2  Setup inner channel               &gt;-&gt;                  |
       via Connection Pool
( 3  Setup of new TCP                S &gt;-&gt;            )     |
( 4    session for the                 &lt;-&lt; SA         )     |
( 5    Connection Pool               A &gt;-&gt;            )     |
  6  Forward TCP SYN                       S &gt;-&gt;            v
  7  Receive TCP SYN/ACK                     &lt;-&lt; SA
  8  Send TCP ACK                          A &gt;-&gt;
  9                                    &lt;-&lt;  
 10  Receive TCP SYN/ACK         &lt;-&lt; SA       
 11  Send TCP ACK              A &gt;-&gt;          

 12  Data can be exchanged       &gt;-&gt;   &gt;-&gt;   &gt;-&gt;
 13  forwards and backwards      &lt;-&lt;   &lt;-&lt;   &lt;-&lt;

                            &gt;-- initiated by
                            --&gt; received by
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32790184"></a>2.5.3.2. Auto-Discovery in-path rules</h4></div></div></div><p>When a client-side Steelhead appliance adds an auto-discovery probe
the TCP header of a TCP SYN packet, it will inform any other Steelhead
appliances in the path that this TCP session can be optimized.  The
server-side Steelhead appliance will reply with a SYN/ACK+ packet
containing its IP address and TCP port number. When the client-side
Steelhead appliance sees the SYN/ACK+ packet, it will setup an inner
channel towards the server-side Steelhead appliance.
</p><div class="figure"><a name="idp32790760"></a><p class="title"><b>Figure 2.13. The setup of an optimized TCP session using the default auto-discovery process</b></p><div class="figure-contents"><pre class="screen">Line State                 Client   CSH   SSH   Server    Time
  1  Send TCP SYN              S &gt;-&gt;
  2  Forward SYN+                   S+ &gt;-&gt;                  |
  3  Receive SYN/ACK+                  &lt;-&lt; SA+              |
  4  Setup inner channel               &gt;-&gt;                  |
( 5  Setup of new TCP                S &gt;-&gt;            )     |
( 6    session for the                 &lt;-&lt; SA         )     |
( 7    Connection Pool               A &gt;-&gt;            )     |
  8  Forward TCP SYN                       S &gt;-&gt;            v
  9  Receive TCP SYN/ACK                     &lt;-&lt; SA
 10  Send TCP ACK                          A &gt;-&gt;  
 11  Server side TCP is setup          &lt;-&lt;
 12  Receive TCP SYN/ACK         &lt;-&lt; SA       
 13  Send TCP ACK              A &gt;-&gt;          

 14  Data can be exchanged       &gt;-&gt;   &gt;-&gt;   &gt;-&gt;
 15  forwards and backwards      &lt;-&lt;   &lt;-&lt;   &lt;-&lt;

                            &gt;-- initiated by
                            --&gt; received by
</pre></div></div><br class="figure-break"><p>In the default auto-discovery process the inner channel towards the
first Steelhead appliances seen gets setup before the outer channel
to the server is setup.
</p><div class="figure"><a name="idp32792552"></a><p class="title"><b>Figure 2.14. The setup of an optimized TCP session using the enhanced auto-discovery process</b></p><div class="figure-contents"><pre class="screen">Line State                 Client   CSH   SSH   Server    Time
  1  Send TCP SYN              S &gt;-&gt;
  2  Forward SYN+                   S+ &gt;-&gt;                  |
  3  Tell CSH that a SH was seen       &lt;-&lt; SA*              |
  4  Forward SYN+                         S+ &gt;-&gt;            |
  5  Receive TCP SYN/ACK                     &lt;-&lt; SA         |
  6  Receive SYN/ACK+                  &lt;-&lt; SA+              |
  7  Setup inner channel               &gt;-&gt;                  |
( 8  Setup of new TCP                S &gt;-&gt;            )     |
( 9    session for the                 &lt;-&lt; SA         )     |
(10    Connection Pool               A &gt;-&gt;            )     |
 11  Send TCP ACK                          A &gt;-&gt;            v
 12  Server side TCP is setup          &lt;-&lt;  
 13  Receive TCP SYN/ACK         &lt;-&lt; SA        
 14  Send TCP ACK              A &gt;-&gt;          

 15  Data can be exchanged       &gt;-&gt;   &gt;-&gt;   &gt;-&gt;
 16  forwards and backwards      &lt;-&lt;   &lt;-&lt;   &lt;-&lt;

                            &gt;-- initiated by
                            --&gt; received by
</pre></div></div><br class="figure-break"><p>In the enhanced auto-discovery process the outer channel towards
the server is determined before the inner channel is setup, making
it possible to auto-discover the Steelhead appliance furthest in
the network.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32793960"></a>2.5.4. Peering rules</h3></div></div></div><p>Peering rules define what the Steelhead appliance should do when
it receives a SYN+ packet. It can chose to accept the auto-discovery
attempt and reply with a SYN/ACK+ or to ignore it and pass it on.
</p><div class="figure"><a name="idp32794792"></a><p class="title"><b>Figure 2.15. Peering rules on a Steelhead appliance.</b></p><div class="figure-contents"><pre class="screen">SSH (config) # show in-path peering rules 
Rule  Type Source             Destination        Port   Peer             SSL-Cap
----- ---- ------------------ ------------------ ------ ---------------- -------
1     pass all                all                all    all              in-cap 
      desc: Default rule to passthrough connections destined to SSL servers
2     auto all                all                443    all              cap    
      desc: Default rule to attempt to optimize connections destined to port 443 as SSL
def   auto all                all                all    all              no-chk
--------------------------------------------------------------------------------
2 user added rule(s)
</pre></div></div><br class="figure-break"><p>Peering rules cannot be used to block optimized TCP sessions from
Fixed Target in-path rules coming from other Steelhead appliances.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32796648"></a>2.6. WAN Visibility</h2></div></div></div><p>As described earlier, an inner channel between two Steelhead
appliances is a TCP session with the IP addresses of the in-path
interfaces of the Steelhead appliances and the destination TCP port
of 7800.
</p><p>This means that your WAN devices don't know about the different
traffic types anymore: All traffic is seen on TCP port 7800. As a
result, QoS based on port number or IP subnet will fail and NetFlow
collectors will show everything coming from only two hosts.
</p><p>To overcome these issues, there are two additional WAN visibility
methods:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Port Transparency: Instead of using destination TCP port 7800,
  the inner channel uses the TCP port numbers of the original TCP
  session between the client and the server.
</p></li><li class="listitem"><p>Full Transparency: Like Port Transparency, but it also uses the
  IP addresses of the TCP session between the client and the server.
</p></li></ul></div><p>Port Transparency and Full Transparency work by adding a TCP option
in the TCP packet header of the inner channel which identifies the IP
addresses and TCP port numbers of the inner channel to the two
Steelhead appliances. For Full Transparency, as long as the IP
routing in the network makes sure that the traffic towards the IP
subnets goes through the respective Steelhead appliances, this
method will work fine.
</p><div class="figure"><a name="idp32799784"></a><p class="title"><b>Figure 2.16. Tcpdump output showing the Transparency TCP options</b></p><div class="figure-contents"><pre class="screen">11:54:02.740843 IP 10.0.1.100.43802 &gt; 192.168.1.1.445: Flags [S], seq 2130333957, win 5840 \
    , options [mss 1460,sackOK,TS val 284297166 ecr 0,nop,wscale 2,rvbd-trans Transp sSH:1 \
    0.0.1.6:54608 dSH:192.168.1.6:7800 00000a000106c0a80106d5501e78], length 0
11:54:02.872968 IP 192.168.1.1.445 &gt; 10.0.1.100.43802: Flags [S.], seq 1657645820, ack 213 \
    0333958, win 5792, options [mss 1460,sackOK,TS val 284639662 ecr 284297166,nop,wscale  \
    2,rvbd-trans Transp sSH:192.168.1.6:7800 dSH:10.0.1.6:54608 0000c0a801060a0001061e78d5 \
    50], length 0
</pre></div></div><br class="figure-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32801192"></a>2.7. The optimization protocol</h2></div></div></div><p>The protocol spoken between two Steelhead appliances on the inner
channel consists of nine different commands: DEF, ESC, REF, REQ,
REP, ACK, EOF, INF, LOP.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Create a new DEFinition:
</p><p>With the DEF command the sending Steelhead appliance will tell the
receiving Steelhead appliance to learn a new reference. The two
Steelhead appliances will store the label and the frame in their
data store and both now can use the label to send references later.
</p></li><li class="listitem"><p>ESCape this data:
</p><p>With the ESC command the sending Steelhead appliance will tell the
receiving Steelhead appliance to forward this data to the client
or server but not to store it in the data store. This can happen
with data which is too small (less than 16 characters) or when the
data reduction policy for an in-path rule is set to compression
only or to no data reduction at all.
</p></li><li class="listitem"><p>Use this REFerence:
</p><p>With the REF command the sending Steelhead appliance tells the
receiving Steelhead appliance to use the frame from an earlier
learned reference.
</p></li><li class="listitem"><p>REQuest a reference:
</p><p>When a REF command comes in and the receiving Steelhead appliance
cannot find the label in its data store, it will request the frame
from the sending Steelhead appliance with this command.
</p></li><li class="listitem"><p>REPeat a reference:
</p><p>When a request for a reference gets answered by the original sending
Steelhead appliance it will happen via a REP command.
</p></li><li class="listitem"><p>ACKnowledge an earlier command:
</p><p>With the ACK command an earlier DEF, ESC or REP statement gets
acknowledged so the original sending Steelhead appliance knows that
it has been processed properly.
</p></li><li class="listitem"><p>EOF: Outer channel was terminated:
</p><p>With the EOF (End Of File) command, the sending Steelhead appliance
tells that the outer channel has been properly terminated.
</p></li><li class="listitem"><p>INF: INFormation packet:
</p><p>With the INF packet the receiving Steelhead appliance tells the
sender about possible failures (Duplicate references, duplicate
requests) and changes in the SDR-A optimization policy.
</p></li><li class="listitem"><p>LOP: Lower Overhead Protocol
</p><p>Like the ESC command, but with a much smaller protocol overhead
(three bytes instead of 15 bytes).
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp32809768"></a>2.8. Hardware models</h2></div></div></div><p>There have been several generations of hardware, the xx10 series,
the xx20 series, the xx50 series, the CX series and the EX series.
In each generation there are several different models, from low end
desktop units to high end data center rack mounted models.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32810664"></a>2.8.1. Steelhead xx10 series models</h3></div></div></div><p>The xx10 series models are obsoleted and are not discussed here.
These models can run up to and including RiOS version 5.0.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32811432"></a>2.8.2. Steelhead xx20 series models</h3></div></div></div><p>The xx20 series models consist of a set of desktop models, 1RU
rack models and 3RU rack models. To upgrade between models, except
for the 50, 100, 200 and 300 models, the whole device must be
replaced.
</p><p>These models can run up to and including RiOS version 6.5.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32812648"></a>2.8.2.1. Model 50, 100, 200, 300</h4></div></div></div><p>The 50, 100, 200 and 300 models are desktop units. They have a
single in-path interface pair and a single hard disk.
</p><p>These models only differ in the optimized WAN capacity and the
number of optimized TCP sessions.
</p><div class="table"><a name="idp32813800"></a><p class="title"><b>Table 2.1. Model 50, 100, 200, 300</b></p><div class="table-contents"><table summary="Model 50, 100, 200, 300" border="1"><colgroup><col><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model 50</td><td>Model 100</td><td>Model 200</td><td>Model 300</td></tr><tr><td>WAN Capacity</td><td>256 Kbps</td><td>1 Mbps</td><td>1 Mbps</td><td>2 Mbps</td></tr><tr><td>TCP Connections</td><td>250</td><td>25</td><td>110</td><td>165</td></tr><tr><td>Data store size</td><td>35 Gb</td><td>35 Gb</td><td>35 Gb</td><td>35 Gb</td></tr><tr><td>Memory</td><td>512 Mb</td><td>512 Mb</td><td>512 Mb</td><td>512 Mb</td></tr><tr><td>On-board in-path interfaces</td><td>1</td><td>1</td><td>1</td><td>1</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32827560"></a>2.8.2.2. Model 520, 1020, 1520, 2020</h4></div></div></div><p>The 520, 1020, 1520 and 2020 models are 1RU units. They have two
on-board in-path interface pairs and can have one extra bypass card
for additional in-path interfaces.
</p><div class="table"><a name="idp32828328"></a><p class="title"><b>Table 2.2. Model 520, 1020, 1520, 2020</b></p><div class="table-contents"><table summary="Model 520, 1020, 1520, 2020" border="1"><colgroup><col><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model 520</td><td>Model 1020</td><td>Model 1520</td><td>Model 2020</td></tr><tr><td>WAN Capacity</td><td>1 Mbps</td><td>2 Mbps</td><td>4 Mbps</td><td>10 Mbps</td></tr><tr><td>TCP Connections</td><td>330</td><td>700</td><td>1 100</td><td>2 000</td></tr><tr><td>Data store size</td><td>80 Gb</td><td>80 Gb</td><td>80 Gb</td><td>150 Gb</td></tr><tr><td>Memory</td><td>2 Gb</td><td>2 Gb</td><td>2 Gb</td><td>4 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>Expansion slots</td><td>1</td><td>1</td><td>1</td><td>1</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32850152"></a>2.8.2.3. Model 3020, 3520, 5520, 6020, 6120</h4></div></div></div><p>The 3020, 3520, 5520, 6020 and 6120 models are 3RU units. They have
two on-board in-path interface pairs and can have up to three extra
bypass cards.
</p><div class="table"><a name="idp32850984"></a><p class="title"><b>Table 2.3. Model 3020, 3520, 5520, 6020, 6120</b></p><div class="table-contents"><table summary="Model 3020, 3520, 5520, 6020, 6120" border="1"><colgroup><col><col><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model 3020</td><td>Model 3520</td><td>Model 5520</td><td>Model 6020</td><td>Model 6120</td></tr><tr><td>WAN Capacity</td><td>20 Mbps</td><td>45 Mbps</td><td>155 Mbps</td><td>310 Mbps</td><td>310 Mbps</td></tr><tr><td>TCP Connections</td><td>3 500</td><td>6 000</td><td>15 000</td><td>40 000</td><td>4 000</td></tr><tr><td>Data store size</td><td>250 Gb</td><td>512 Gb</td><td>700 Gb</td><td>1.4 Tb</td><td>3.4 Tb</td></tr><tr><td>Memory</td><td>4 Gb</td><td>6 Gb</td><td>8 Gb</td><td>16 Gb</td><td>16 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>Expansion slots</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp32867112"></a>2.8.3. Steelhead xx50 series models</h3></div></div></div><p>Unlike the xx20 series models, where a hardware upgrade between
similar models involved a replacement of the hardware, most of the
xx50 series models can perform a configuration upgrade by using a
license key.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32868008"></a>2.8.3.1. Models 150, 250 and 550</h4></div></div></div><p>The 150, 250 and 550 models are desktop units. They have a single
in-path interface pair and a single hard disk.
</p><p>The 150 model comes only in the M configuration.
</p><div class="table"><a name="idp32869160"></a><p class="title"><b>Table 2.4. Model 150</b></p><div class="table-contents"><table summary="Model 150" border="1"><colgroup><col><col></colgroup><tbody><tr><td> </td><td>Model 150M</td></tr><tr><td>WAN Capacity</td><td>1 Mbps</td></tr><tr><td>TCP Connections</td><td>20</td></tr><tr><td>Data store size</td><td>40 Gb</td></tr><tr><td>Memory</td><td>1 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>1</td></tr><tr><td>Expansion slots</td><td>0</td></tr></tbody></table></div></div><br class="table-break"><p>The 250 model comes in L, M and H configurations which only differ
in the optimized WAN capacity and the number of optimized TCP
sessions.
</p><div class="table"><a name="idp32876328"></a><p class="title"><b>Table 2.5. Model 250</b></p><div class="table-contents"><table summary="Model 250" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model 250L</td><td>Model 250M</td><td>Model 250H</td></tr><tr><td>WAN Capacity</td><td>1 Mbps</td><td>1 Mbps</td><td>2 Mbps</td></tr><tr><td>TCP Connections</td><td>40</td><td>125</td><td>200</td></tr><tr><td>Data store size</td><td>40 Gb</td><td>40 Gb</td><td>40 Gb</td></tr><tr><td>Memory</td><td>1 Gb</td><td>1 Gb</td><td>1 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>1</td><td>1</td><td>1</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"><p>The 550 model comes in M and H configurations which only differ in
the optimized WAN capacity and the number of optimized TCP sessions.
</p><div class="table"><a name="idp32888168"></a><p class="title"><b>Table 2.6. Model 550</b></p><div class="table-contents"><table summary="Model 550" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Model 550M</td><td>Model 550H</td></tr><tr><td>WAN Capacity</td><td>2 Mbps</td><td>4 Mbps</td></tr><tr><td>TCP Connections</td><td>300</td><td>600</td></tr><tr><td>Data store size</td><td>80 Gb</td><td>80 Gb</td></tr><tr><td>Memory</td><td>2 Gb</td><td>2 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>1</td><td>1</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp32909800"></a>2.8.3.2. Models 1050 and 2050</h4></div></div></div><p>The 1050 and 2050 models are 1RU units. They have two on-board
in-path interface pairs and can have one extra in-path card.
</p><p>The 1050 model comes in U, L, M and H configurations and with an
optional RAID10 feature.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The 1050U model has the same WAN and TCP capacity as the model
  550H, but is capable of running 64-bit RSP instances.
</p></li><li class="listitem"><p>The 1050L and 1050M models have a single hard disk and have 2 Gb
  of memory.
</p></li><li class="listitem"><p>The 1050H model has two hard disks in a RAID0 configuration and
  has 4 Gb of memory.
</p></li><li class="listitem"><p>The 1050LR, 1050MR and 1050HR models contain four hard disks in
  a RAID10 configuration.
</p></li></ul></div><p>An upgrade towards a 1050H model requires the installation of extra
memory, one extra hard disk and requires the data store to be
re-initialized.
</p><p>An upgrade towards a RAID configuration requires the installation
of extra hard disks and will clear the data store.
</p><div class="table"><a name="idp32913000"></a><p class="title"><b>Table 2.7. Model 1050</b></p><div class="table-contents"><table summary="Model 1050" border="1"><colgroup><col><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model 1050U</td><td>Model 1050L / 1050LR</td><td>Model 1050M / 1050MR</td><td>Model 1050H / 1050HR</td></tr><tr><td>WAN Capacity</td><td>4 Mbps</td><td>8 Mbps</td><td>10 Mbps</td><td>20 Mbps</td></tr><tr><td>TCP Connections</td><td>600</td><td>800</td><td>1 200</td><td>2 300</td></tr><tr><td>Data store size</td><td>80 Gb</td><td>100 Gb</td><td>100 Gb</td><td>200 Gb</td></tr><tr><td>Memory</td><td>2 Gb</td><td>2 Gb</td><td>2 Gb</td><td>4 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>1</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>0</td><td>1</td><td>1</td><td>1</td></tr></tbody></table></div></div><br class="table-break"><p>The 2050 model comes in L, M and H configurations which only differ
in the optimized WAN capacity and the number of optimized TCP
sessions.
</p><div class="table"><a name="idp33333736"></a><p class="title"><b>Table 2.8. Model 2050</b></p><div class="table-contents"><table summary="Model 2050" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model 2050L</td><td>Model 2050M</td><td>Model 2050H</td></tr><tr><td>WAN Capacity</td><td>45 Mbps</td><td>45 Mbps</td><td>45 Mbps</td></tr><tr><td>TCP Connections</td><td>2 500</td><td>4 000</td><td>6 000</td></tr><tr><td>Data store size</td><td>400 Gb</td><td>400 Gb</td><td>400 Gb</td></tr><tr><td>Memory</td><td>6 Gb</td><td>6 Gb</td><td>6 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>1</td><td>1</td><td>1</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33346728"></a>2.8.3.3. Models 5050 and 6050</h4></div></div></div><p>The 5050 and 6050 models are 3RU units. They have two on-board
in-path interface pairs and can have four extra in-path cards.
</p><p>The 5050 model comes in L, M and H configurations which differ in
the optimized WAN capacity, the number of optimized TCP sessions
and the size of the data store.
</p><p>An upgrade towards a 5050H model requires the installation of extra
hard disks and will clear the data store.
</p><div class="table"><a name="idp33347880"></a><p class="title"><b>Table 2.9. Model 5050</b></p><div class="table-contents"><table summary="Model 5050" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model 5050L</td><td>Model 5050M</td><td>Model 5050H</td></tr><tr><td>WAN Capacity</td><td>90 Mbps</td><td>90 Mbps</td><td>155 Mbps</td></tr><tr><td>TCP Connections</td><td>7 500</td><td>10 000</td><td>18 000</td></tr><tr><td>Data store size</td><td>600 Gb</td><td>600 Gb</td><td>800 Gb</td></tr><tr><td>Memory</td><td>8 Gb</td><td>8 Gb</td><td>8 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>4</td><td>4</td><td>4</td></tr></tbody></table></div></div><br class="table-break"><p>The 6050 model comes in only one configuration.
</p><div class="table"><a name="idp33391016"></a><p class="title"><b>Table 2.10. Model 6050</b></p><div class="table-contents"><table summary="Model 6050" border="1"><colgroup><col><col></colgroup><tbody><tr><td> </td><td>Model 6050</td></tr><tr><td>WAN Capacity</td><td>310 Mbps</td></tr><tr><td>TCP Connections</td><td>50 000</td></tr><tr><td>Data store size</td><td>3.5 Tb</td></tr><tr><td>Memory</td><td>24 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td></tr><tr><td>Expansion slots</td><td>4</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33423464"></a>2.8.3.4. Model 7050</h4></div></div></div><p>The 7050 model is a 3RU unit.
</p><p>The 7050 model comes in L and M configurations which differ in
number of optimized TCP sessions and in data store size. The storage
of the data store in the 7050 model are solid-state disks instead
of hard disks.
</p><p>An upgrade towards a 7050M model requires the installation of extra
memory, extra hard disks and but, because of the use of the FTS,
will not require the re-initialization of the data store.
</p><div class="table"><a name="idp33425896"></a><p class="title"><b>Table 2.11. Model 7050</b></p><div class="table-contents"><table summary="Model 7050" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Model 7050L</td><td>Model 7050M</td></tr><tr><td>WAN Capacity</td><td>1 Gbps</td><td>1 Gbps</td></tr><tr><td>TCP Connections</td><td>75 000</td><td>100 000</td></tr><tr><td>Data store size</td><td>2.2 Tb</td><td>4.4 Tb</td></tr><tr><td>Memory</td><td>24 Gb</td><td>32 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>4</td><td>4</td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp33459432"></a>2.8.4. Steelhead CX series models</h3></div></div></div><p>The CX series models are the "classic series", one of the successors
of the xx50 series models. They are "classic" because they purely
do WAN optimization and don't have the virtualization capabilities
of the RSP/VSP features. Also the PFS capability has been removed from
them.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33462056"></a>2.8.4.1. Model CX255</h4></div></div></div><p>The CX255 model is a desktop unit. It has only one in-path interface
pairs and a single hard disk. There is no AUX port and the serial
port is an RJ45 port.
</p><p>The CX255 model comes in U, L, M and H configurations which differ in the
optimized WAN capacity and the number of optimized TCP sessions.
</p><div class="table"><a name="idp33463976"></a><p class="title"><b>Table 2.12. Model CX255</b></p><div class="table-contents"><table summary="Model CX255" border="1"><colgroup><col><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX255U</td><td>Model CX255L</td><td>Model CX255M</td><td>Model CX255H</td></tr><tr><td>WAN Capacity</td><td>2 Mbps</td><td>6 Mbps</td><td>6 Mbps</td><td>6 Mbps</td></tr><tr><td>TCP Connections</td><td>50</td><td>75</td><td>150</td><td>230</td></tr><tr><td>Data store size</td><td>50 Gb</td><td>50 Gb</td><td>50 Gb</td><td>50 Gb</td></tr><tr><td>Memory</td><td>2 Gb</td><td>2 Gb</td><td>2 Gb</td><td>2Gb</td></tr><tr><td>On-board in-path interfaces</td><td>1</td><td>1</td><td>1</td><td>1</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33580776"></a>2.8.4.2. Model CX555 and CX755</h4></div></div></div><p>The CX555 and CX755 models are desktop units. They have two in-path
interface pairs and a dual hard disk.
</p><p>The CX555 model comes in L, M and H configurations which differ in the
optimized WAN capacity and the number of optimized TCP sessions.
</p><div class="table"><a name="idp33582888"></a><p class="title"><b>Table 2.13. Model CX555</b></p><div class="table-contents"><table summary="Model CX555" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX555L</td><td>CX555M</td><td>Model CX555H</td></tr><tr><td>WAN Capacity</td><td>6 Mbps</td><td>10 Mbps</td><td>10 Mbps</td></tr><tr><td>TCP Connections</td><td>250</td><td>400</td><td>650</td></tr><tr><td>Data store size</td><td>80 Gb</td><td>80 Gb</td><td>80 Gb</td></tr><tr><td>Memory</td><td>2 Gb</td><td>2 Gb</td><td>2 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"><p>The CX755 model comes in L, M and H configurations which differ in
the optimized WAN capacity, the number of optimized TCP sessions
and size of the data store.
</p><p>The CX755H model comes with a single hard disk and a single solid-state
disk, the latter used for the data store.
</p><p>An upgrade towards a CX755M model does not require a change in
hardware.
</p><div class="table"><a name="idp33657128"></a><p class="title"><b>Table 2.14. Model CX755</b></p><div class="table-contents"><table summary="Model CX755" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX755L</td><td>Model CX755M</td><td>Model CX755H</td></tr><tr><td>WAN Capacity</td><td>10 Mbps</td><td>10 Mbps</td><td>20 Mbps</td></tr><tr><td>TCP Connections</td><td>900</td><td>1 500</td><td>2 300</td></tr><tr><td>Data store size</td><td>100 Gb</td><td>100 Gb</td><td>160 Gb</td></tr><tr><td>Memory</td><td>2 Gb</td><td>2 Gb</td><td>4 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33700072"></a>2.8.4.3. Model CX570 and CX770</h4></div></div></div><p>The CX570 and CX770 models are desktop units. They have two in-path interface
pairs and a hard disk and solid-state disk, the latter used for the
data store.
</p><p>The CX570 model comes in L, M and H configurations which differ in the
optimized WAN capacity and the number of optimized TCP sessions.
</p><div class="table"><a name="idp33701864"></a><p class="title"><b>Table 2.15. Model CX570</b></p><div class="table-contents"><table summary="Model CX570" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX570L</td><td>CX570M</td><td>Model CX570H</td></tr><tr><td>WAN Capacity</td><td>6 Mbps</td><td>10 Mbps</td><td>10 Mbps</td></tr><tr><td>TCP Connections</td><td>250</td><td>400</td><td>650</td></tr><tr><td>Data store size</td><td>70 Gb</td><td>70 Gb</td><td>70 Gb</td></tr><tr><td>Memory</td><td>2 Gb</td><td>2 Gb</td><td>2 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"><p>The CX770 model comes in L, M and H configurations which differ in
the optimized WAN capacity and the number of optimized TCP sessions.
</p><div class="table"><a name="idp33746792"></a><p class="title"><b>Table 2.16. Model CX770</b></p><div class="table-contents"><table summary="Model CX770" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX770L</td><td>Model CX770M</td><td>Model CX770H</td></tr><tr><td>WAN Capacity</td><td>10 Mbps</td><td>10 Mbps</td><td>20 Mbps</td></tr><tr><td>TCP Connections</td><td>900</td><td>1 500</td><td>2 300</td></tr><tr><td>Data store size</td><td>150 Gb</td><td>150 Gb</td><td>150 Gb</td></tr><tr><td>Memory</td><td>4 Gb</td><td>4 Gb</td><td>4 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>0</td><td>0</td><td>0</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33806120"></a>2.8.4.4. Model CX1555</h4></div></div></div><p>The CX1555 model is an 1RU units.
</p><p>The CX1555 model comes in L, M and H configurations which differ in
the number of optimized TCP sessions and size of the data store.
</p><p>The CX1555L and CX1555M models have four hard disks in a RAID10
configuration, the CX1555H model has two hard disks in a RAID1
configuration and two SSD disks in an FTS configuration.
</p><p>An upgrade towards a CX1555M model does not require a change in
hardware, the upgrade towards a CX1555H model requires a replacement of
two hard disks with two SSD disks.
</p><div class="table"><a name="idp33807976"></a><p class="title"><b>Table 2.17. Model CX1555</b></p><div class="table-contents"><table summary="Model CX1555" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX1555L</td><td>Model CX1555M</td><td>Model CX1555H</td></tr><tr><td>WAN Capacity</td><td>50 Mbps</td><td>50 Mbps</td><td>100 Mbps</td></tr><tr><td>TCP Connections</td><td>3 000</td><td>4 500</td><td>6 000</td></tr><tr><td>Data store size</td><td>400 Gb</td><td>400 Gb</td><td>320 Gb</td></tr><tr><td>Memory</td><td>8 Gb</td><td>8 Gb</td><td>8 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>2</td><td>2</td><td>2</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33853352"></a>2.8.4.5. Model CX5055 and CX7055</h4></div></div></div><p>The CX5055 and CX7055 models are 2RU units.
</p><p>Like the 7050 model, they use SSD disks in a Fault Tolerant Segstore
method for the data store and use two hard disks for the operating
system.
</p><p>The CX5055 model comes in M and H configurations which differ in the
optimized WAN capacity and the number of optimized TCP sessions.
</p><p>An upgrade towards a CX5055H model does not require a change in
hardware.
</p><div class="table"><a name="idp33854760"></a><p class="title"><b>Table 2.18. Model CX5055</b></p><div class="table-contents"><table summary="Model CX5055" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX5055M</td><td>Model CX5055H</td></tr><tr><td>WAN Capacity</td><td>200 Mbps</td><td>400 Mbps</td></tr><tr><td>TCP Connections</td><td>14 000</td><td>25 000</td></tr><tr><td>Data store size</td><td>640 Gb</td><td>640 Gb</td></tr><tr><td>Memory</td><td>16 Gb</td><td>16 GB</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>4</td><td>4</td></tr></tbody></table></div></div><br class="table-break"><p>The CX7055 model comes in L, M and H configurations which differ in 
the optimized WAN capacity, the number of optimized TCP sessions,
the amount of memory and the size of the data store.
</p><p>The CX7055L model does not have a hardware compression card, the CX7055M
and CX7055H models do have a hardware compression card.
</p><p>The CX7055 models cannot be upgraded in the field, it requires a
replacement of the unit.
</p><div class="table"><a name="idp33864424"></a><p class="title"><b>Table 2.19. Model CX7055</b></p><div class="table-contents"><table summary="Model CX7055" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model CX7055L</td><td>Model CX7055M</td><td>Model CX7055H</td></tr><tr><td>WAN Capacity</td><td>622 Mbps</td><td>1000 Mbps</td><td>1500 Mbps</td></tr><tr><td>TCP Connections</td><td>75 000</td><td>100 000</td><td>150 000</td></tr><tr><td>Data store size</td><td>1.6 Tb</td><td>2.4 Tb</td><td>4.8 Tb</td></tr><tr><td>Memory</td><td>32 Gb</td><td>48 Gb</td><td>64 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>4</td><td>4</td><td>4</td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp33921448"></a>2.8.5. Steelhead EX series models</h3></div></div></div><p>The EX series models are the "edge series", one of the successors
of the xx50 series. Unlike the CX series models they are capable
of doing the virtualization with VSP and are ready to work with the
Granite product. Like the CX series models, they don't have the PFS
capabilities.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp33932392"></a>2.8.5.1. Models EX560, EX760 and EX1160</h4></div></div></div><p>The EX560, EX760 and EX1160 models are 1RU units. They have two
on-board in-path interfaces. They all use solid state disks for
their data stores.
</p><p>The EX560 model comes in G, L, M and H configurations. The EX560G
model is only for use with the Granite product.
</p><p>An upgrade towards an EX560L, EX560M and EX560H model does not
require a change in hardware.
</p><div class="table"><a name="idp33934568"></a><p class="title"><b>Table 2.20. Model EX560</b></p><div class="table-contents"><table summary="Model EX560" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model EX560L</td><td>Model EX560M</td><td>Model EX560H</td></tr><tr><td>WAN Capacity</td><td>6 Mbps</td><td>10 Mbps</td><td>10 Mbps</td></tr><tr><td>TCP Connections</td><td>250</td><td>400</td><td>650</td></tr><tr><td>Data store size</td><td>40 Gb</td><td>70 Gb</td><td>70 Gb</td></tr><tr><td>Memory</td><td>8 Gb</td><td>8 Gb</td><td>8 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>2</td><td>2</td><td>2</td></tr></tbody></table></div></div><br class="table-break"><p>The EX760 model comes in L, M and H configurations.
</p><p>An upgrade towards an EX760M and EX760H model does not require a
change in hardware.
</p><div class="table"><a name="idp34027496"></a><p class="title"><b>Table 2.21. Model EX760</b></p><div class="table-contents"><table summary="Model EX760" border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model EX760L</td><td>Model EX760M</td><td>Model EX760H</td></tr><tr><td>WAN Capacity</td><td>10 Mbps</td><td>10 Mbps</td><td>20 Mbps</td></tr><tr><td>TCP Connections</td><td>900</td><td>1 500</td><td>2 300</td></tr><tr><td>Data store size</td><td>150 Gb</td><td>150 Gb</td><td>150 Gb</td></tr><tr><td>Memory</td><td>16 Gb</td><td>16 Gb</td><td>16 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>2</td><td>2</td><td>2</td></tr></tbody></table></div></div><br class="table-break"><p>The EX1160 model comes in G, L, M, H and VH configurations. The
EX1160G model is only for use with the Granite product.
</p><p>An upgrade towards an EX1160L, EX1160M and EX1160H model does not
require a change in hardware.
</p><div class="table"><a name="idp34081704"></a><p class="title"><b>Table 2.22. Model EX1160</b></p><div class="table-contents"><table summary="Model EX1160" border="1"><colgroup><col><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model EX1160L</td><td>Model EX1160M</td><td>Model EX1160H</td><td>Model EX1160VH</td></tr><tr><td>WAN Capacity</td><td>10 Mbps</td><td>10 Mbps</td><td>20 Mbps</td><td>50 / 100 Mbps</td></tr><tr><td>TCP Connections</td><td>900</td><td>1 500</td><td>2 3000</td><td>6 000</td></tr><tr><td>Data store size</td><td>140 Gb</td><td>140 Gb</td><td>140 Gb</td><td>280 Gb</td></tr><tr><td>Memory</td><td>20 Gb</td><td>20 Gb</td><td>20 Gb</td><td>24 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>2</td><td>2</td><td>2</td><td>2</td></tr></tbody></table></div></div><br class="table-break"><p>The WAN capacity of an EX1160VH can be increased to 100 Mbps via a
license key.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp34147368"></a>2.8.5.2. Model EX1260</h4></div></div></div><p>The EX1260 model is a 2RU chassis.
</p><p>The EX1260 model comes in G, L, M, H and VH configurations. The
EX1260G model is only for use with the Granite product.
</p><p>An upgrade towards an EX1260L, EX1260M and EX1260H model does not
require a change in hardware.
</p><div class="table"><a name="idp34165416"></a><p class="title"><b>Table 2.23. Model EX1260</b></p><div class="table-contents"><table summary="Model EX1260" border="1"><colgroup><col><col><col><col><col></colgroup><tbody><tr><td> </td><td>Model EX1260L</td><td>Model EX1260M</td><td>Model EX1260H</td><td>Model EX1260VH</td></tr><tr><td>WAN Capacity</td><td>10 Mbps</td><td>10 Mbps</td><td>20 Mbps</td><td>50 / 100 Mbps</td></tr><tr><td>TCP Connections</td><td>900</td><td>1 1 500</td><td>2 300</td><td>6 000</td></tr><tr><td>Data store size</td><td>140 Gb</td><td>140 Gb</td><td>140 Gb</td><td>280 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>4</td><td>4</td><td>4</td><td>4</td></tr></tbody></table></div></div><br class="table-break"><p>The memory field has been removed from here because of the way the
model EX1260 can be configured.
</p><p>The WAN capacity of an EX1260VH can be increased to 100 Mbps via a
license key.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp34191592"></a>2.8.5.3. Model EX1360</h4></div></div></div><p>The EX1360 model is a 2RU model.
</p><p>The EX1360 model comes in the G, L and M configurations. The EX1360G
model is only for use with the Granite product.
</p><p>An upgrade towards an EX1360L and EX1360M model does not require a
change in hardware.
</p><div class="table"><a name="idp34193896"></a><p class="title"><b>Table 2.24. Model EX1360</b></p><div class="table-contents"><table summary="Model EX1360" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Model EX1360L</td><td>Model EX1360M</td></tr><tr><td>WAN Capacity</td><td>50 Mbps</td><td>100 Mbps</td></tr><tr><td>TCP Connections</td><td>4 500</td><td>6 000</td></tr><tr><td>Data store size</td><td>320 Gb</td><td>320 Gb</td></tr><tr><td>Memory</td><td>24 Gb</td><td>24 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>2</td><td>2</td></tr><tr><td>Expansion slots</td><td>4</td><td>4</td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34253736"></a>2.8.6. Steelhead DX series models</h3></div></div></div><p>The DX series models are the "data center series", for specific
data-center to data-center environments. They have a memory-only data
store and only limited latency optimization features.
</p><p>The DX series models will only optimize against other DX series models.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp34255592"></a>2.8.6.1. Model DX8000</h4></div></div></div><p>The DX8000 model is a 2RU unit. They have one on-board in-path interface.
</p><div class="table"><a name="idp34256552"></a><p class="title"><b>Table 2.25. Model DX8000</b></p><div class="table-contents"><table summary="Model DX8000" border="1"><colgroup><col><col></colgroup><tbody><tr><td> </td><td>Model DX8000</td></tr><tr><td>WAN Capacity</td><td>no limit</td></tr><tr><td>TCP Connections</td><td>10 500</td></tr><tr><td>Data store size</td><td>memory only</td></tr><tr><td>Memory</td><td>128 Gb</td></tr><tr><td>On-board in-path interfaces</td><td>1</td></tr><tr><td>Expansion slots</td><td>-</td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34274280"></a>2.8.7. Interceptor models</h3></div></div></div><p>The two hardware models are the 9200 and 9350 model. The old 9200
model had a single hard disk and supported up to and including
Interceptor software version 3.0.x. The new 9350 model has two hard
disks in a RAID1 configuration.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34275496"></a>2.8.8. Steelhead Mobile models</h3></div></div></div><p>The two hardware models are the 8500 and 8650 model. The old 8500
model had a single hard disk and supported up to and including SMC
software version 3.1.x. The new 8650 model has two hard disks in a
RAID1 configuration.
</p><p>The VM based SMC model has two virtual disks.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34297640"></a>2.8.9. Central Management Console models</h3></div></div></div><p>The two hardware models are the 8000 and 8150 model. The old 8000
model had a single hard disk and supported up to and including CMC
software version 6.5.x. The new 8150 model has two hard disks in a
RAID1 configuration.
</p><p>The VM based CMC 8001 model has three virtual disks, two for the
operating system and the CMC software and one for the data.

</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="The_Command_Line_and_Tools"></a>Chapter 3. The Command Line and Tools</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp34301800">3.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp34441064">3.2. Dealing with the Command Line Interface</a></span></dt><dt><span class="sect1"><a href="#idp34724456">3.3. Tcpdump, the network packet capture tool</a></span></dt><dt><span class="sect1"><a href="#idp35271976">3.4. Tcpdump-x</a></span></dt><dt><span class="sect1"><a href="#idp35419368">3.5. Ping</a></span></dt><dt><span class="sect1"><a href="#idp35709800">3.6. Traceroute</a></span></dt><dt><span class="sect1"><a href="#tools_telnet">3.7. Telnet</a></span></dt><dt><span class="sect1"><a href="#idp36087912">3.8. Tproxytrace</a></span></dt><dt><span class="sect1"><a href="#idp36152488">3.9. Nettest</a></span></dt><dt><span class="sect1"><a href="#idp36188264">3.10. SSL connect</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp34301800"></a>3.1. Index</h2></div></div></div><p>This chapter describes how to access and deal with the Command Line
Interface (CLI) and the various troubleshooting tools available on
the Steelhead appliances, how to use them and how to interpret the results.
</p><p>The following tools are described:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="bold"><strong>tcpdump</strong></span>,
the network packet capture tool.
</p></li><li class="listitem"><p>
<span class="bold"><strong>tcpdump-x</strong></span>,
a wrapper around tcpdump.
</p></li><li class="listitem"><p>
<span class="bold"><strong>ping</strong></span>
and
<span class="bold"><strong>ping6</strong></span>,
to determine the reachability of a remote host.
</p></li><li class="listitem"><p>
<span class="bold"><strong>traceroute</strong></span>
and
<span class="bold"><strong>traceroute6</strong></span>,
to determine the path to a remote host.
</p></li><li class="listitem"><p>
<span class="bold"><strong>telnet</strong></span>,
to setup a TCP connection.
</p></li><li class="listitem"><p>
<span class="bold"><strong>tproxytrace</strong></span>,
to detect Steelhead appliances in the network.
</p></li><li class="listitem"><p>
<span class="bold"><strong>Nettest</strong></span>,
the internal network testing tools.
</p></li><li class="listitem"><p>
<span class="bold"><strong>ssl-connect</strong></span>,
to setup an SSL encrypted TCP connection.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34404456"></a>3.1.1. Introduction</h3></div></div></div><p>The Steelhead appliance comes with a large set of built-in tools
to investigate network related issues interfering with the setup
and the operation of optimized TCP sessions. Knowing how to use
them and what to expect in the output will reduce the time needed
to finalize installations and identify operational issues.
</p><p>Note: most of the tools use Linux specific options. Some of the
tools use a different naming for the options on other operating
systems such as FreeBSD and Microsoft Windows. See the "man" pages
or the help section of these other operating systems to find the
right options.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34406632"></a>3.1.2. Network diagram</h3></div></div></div><p>Most of the scenarios, logging and traces are obtained from the
following network:
</p><div class="figure"><a name="idp34407656"></a><p class="title"><b>Figure 3.1. The network diagram</b></p><div class="figure-contents"><pre class="screen">                              .-,(  ),-.    
                           .-(          )-. 
                     .--- (       WAN      ) ------.
                     |     '-(          ).-'       |
                     |         '-.( ).-'           |
                     |                             |
                     v                             v
                __________                     __________ 
               [_...__...*]                   [_...__...*]
                  Router                         Router
                    |                              |
                    |                              |
                    v                              v
                __________                     __________ 
               [    W     ]                   [    W     ]
               [    L  P  ]                   [    L  P  ]
               [_...__...*]                   [_...__...*]
                   SSH |                          CSH |
                    |  |                           |  |
 ________           |  |                           |  |
|==|=====|          v  v                           v  v
|  |     |      __________                     __________ 
|  |     |     [_...__...*]                   [_...__...*]
|  |     |        Switch                         Switch
|  |     |          |                              |          _  __ 
|  |====*|          |                              |         |=|[__]
|__|_____|&lt;---------'                              '--------&gt;|_|\::\
  Server                                                     Client

Client:             10.0.1.1        d4:9a:20:c2:52:0e
C-SWI:              10.0.1.8
CSH PRI:            10.0.1.5        00:0e:b6:42:f8:98
CSH 0_0 LAN:        10.0.1.6        00:0e:b6:8c:74:9c
CSH 0_0 WAN:        10.0.1.6        00:0e:b6:8c:74:9b
C-RTR-lan:          10.0.1.9        00:0d:b9:17:28:de
C-RTR-wan           172.16.1.1
                    30 ms
N-RTR-1-wan:        172.16.1.2
N-RTR-1-wan:        172.16.2.1
                    60 ms
N-RTR-2-wan:        172.16.2.2
N-RTR-2-wan:        172.16.3.1
                    40 ms
S-RTR-wan:          172.16.3.2        
S-RTR-lan           192.168.1.9     00:0d:b9:17:28:dd
SSH 0_0 WAN:        192.168.1.6     00:0e:b6:8c:7a:ed
SSH 0_0 LAN:        192.168.1.6     00:0e:b6:8c:7a:ee
SSH PRI:            192.168.1.5     00:0e:b6:31:45:e0
S-SWI:              192.168.1.8
Server:             192.168.1.1     00:21:70:3e:6b:7f
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp34441064"></a>3.2. Dealing with the Command Line Interface</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34441448"></a>3.2.1. Accessing the CLI via the serial console</h3></div></div></div><p>The serial console of the Steelhead appliance can be used to access
the CLI if the device does not have network connectivity yet. The
serial console assumes that the screen size of the terminal is
80x25 characters. If the screen size of the terminal is different,
then the output to the console will become garbled when the pager
is used, for example during the display of the configuration with
the commands
<code class="computeroutput">show running</code>
and
<code class="computeroutput">show log</code>.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34450408"></a>3.2.2. Accessing the CLI via SSH</h3></div></div></div><p>The Command Line Interface of the Steelhead appliance can be accessed
via a Secure Shell application, SSH. The best known SSH application
for OS X, Unix and Linux hosts is OpenSSH, the best known for
Microsoft Windows is PuTTY, available from
www.chiark.greenend.org.uk/~sgtatham/putty/.
</p><div class="figure"><a name="idp34451624"></a><p class="title"><b>Figure 3.2. Setup of an SSH session to the CLI of the Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">$ ssh admin@10.0.1.5
The authenticity of host '10.0.1.5 (10.0.1.5)' can't be established.
ECDSA key fingerprint is 7f:e2:c5:18:db:17:08:91:2d:44:e9:7a:b4:97:f7:92.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.0.1.5' (ECDSA) to the list of known hosts.
Riverbed Steelhead
Password:
SH &gt; en
SH # cli session auto-logout 0
SH # configure terminal
SH (config) #
</pre></div></div><br class="figure-break"><p>After being logged in the CLI session is a limited
command mode, identified by the '&gt;' in the prompt.
Use the command
<code class="computeroutput">enable</code>
to elevate to the more powerful enable mode,
identified by the '#' in the prompt. To be able to make changes in
the configuration mode, use the command
<code class="computeroutput">configure terminal</code>
and the prompt will have the string '(config)' in it. Use the command
<code class="computeroutput">exit</code>
to go one level lower.
</p><p>The first line complains that the SSH application hasn't seen the
SSH fingerprint of this host before. This is normal for the first
time an SSH connection is made to this host. If the device has been
replaced via an RMA, then the replacement will have a different SSH
fingerprint and SSH will complain about it:
</p><div class="figure"><a name="idp34462760"></a><p class="title"><b>Figure 3.3. Setup of an SSH session to the CLI of a replaced Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">$ ssh admin@10.0.1.5
Riverbed Steelhead
Password:
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the RSA key sent by the remote host is
79:8f:b4:7e:4b:3c:4a:fb:ad:e6:f6:fe:56:c1:50:2c.
Please contact your system administrator.
Add correct host key in /usr/home/edwin/.ssh/known_hosts to get rid of this message.
Offending RSA key in /usr/home/edwin/.ssh/known_hosts:50
RSA host key for 10.0.1.5 has changed and you have requested strict checking.
Host key verification failed.
</pre></div></div><br class="figure-break"><p>If this happens, confirm that the device was replaced.
</p><p>To overcome this issue with OpenSSH, remove the line in the file
mentioned. With PuTTY a dialog box will be shown with the option
to replace the key.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34477160"></a>3.2.3. Accessing the file system via SCP</h3></div></div></div><p>Secure Copy, or SCP, is a file transfer layer on top of SSH. It can
be used to upload RiOS software images, RSP images and RSP packages
and to download system dumps, process dumps and tcpdump traces.
</p><p>The OpenSSH software includes the scp binary. The PuTTY website
distributes a SCP program called "pscp.exe".
</p><p>The following limitations are implemented on the Steelhead appliance:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>You can only upload to:

</p></li><li class="listitem"><p>/images for RiOS images.
</p></li><li class="listitem"><p>/rsp/images for RSP images.
</p></li><li class="listitem"><p>/rsp/packages for RSP packages.
</p></li><li class="listitem"><p>You can only download from:

</p></li><li class="listitem"><p>/sysdumps for system dumps.
</p></li><li class="listitem"><p>/snapshots for process dumps.
</p></li><li class="listitem"><p>/tcpdumps for tcpdumps captures.
</p></li><li class="listitem"><p>/log for log files.
</p></li></ul></div><p>Note that only SCP is permitted. SFTP is not supported, neither is
FTP over SSL.
</p><div class="figure"><a name="idp34518184"></a><p class="title"><b>Figure 3.4. Download of a system dump via SCP</b></p><div class="figure-contents"><pre class="screen">$ scp admin@10.0.1.5:/sysdumps/sysdump-CSH-20120612-123456.tgz .
Riverbed Steelhead
Password:
sysdump-CSH-2012-123456.tgz                        100% 34Mb   400KB/s  00:00
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp34519528"></a><p class="title"><b>Figure 3.5. Attempt to access a non-permitted directory</b></p><div class="figure-contents"><pre class="screen">$ scp admin@10.0.1.5:/var/opt/tms/image-history .
Riverbed Steelhead
Password:
Riverbed ssh: ssh remote command is not allowed.
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34520616"></a>3.2.4. Surviving the 'less' pager</h3></div></div></div><p>The pager used on the Steelhead appliance to view multiple pages
of output is based on the 'less' pager, known from Unix and Linux
environments. If the last character on the screen is a
"<code class="computeroutput">:</code>"
or
"<code class="computeroutput">(END)</code>"
then you are in this pager. 
</p><p>Here is a list of keys and what their function is:
</p><div class="table"><a name="idp34523176"></a><p class="title"><b>Table 3.1. The less pager cheat sheet</b></p><div class="table-contents"><table summary="The less pager cheat sheet" border="1"><colgroup><col><col></colgroup><tbody><tr><td>Key</td><td>Functionality</td></tr><tr><td>q</td><td>Quit the pager (very important)</td></tr><tr><td>Enter or j or arrow-down</td><td>Scroll one line down</td></tr><tr><td>k or y or arrow-up</td><td>Scroll one line up</td></tr><tr><td>Space</td><td>Scroll one page down</td></tr><tr><td>b</td><td>Scroll one page backwards</td></tr><tr><td>control-G</td><td>Show information of the file, size and location</td></tr><tr><td>control-L</td><td>Redraw the screen, in case it got garbled</td></tr><tr><td>/</td><td>Search forward</td></tr><tr><td>?</td><td>Search backward</td></tr><tr><td>n</td><td>Perform the last search again, forwards or backwards</td></tr><tr><td>g</td><td>Scroll to the beginning of the file</td></tr><tr><td>G</td><td>Scroll to the end of the file</td></tr></tbody></table></div></div><br class="table-break"><p>The search string is a regular expression, so some magic can be
performed with it.
</p><p>Normally, the less pager starts at the beginning of the text to
display. However, when viewing a log files the less pager will start
at the end. Use the 'b' key to go backwards!
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34616040"></a>3.2.5. Control keys on the CLI</h3></div></div></div><p>The following combination of control keys are available to navigate
on the CLI:
</p><div class="table"><a name="idp34632680"></a><p class="title"><b>Table 3.2. Control characters on the CLI</b></p><div class="table-contents"><table summary="Control characters on the CLI" border="1"><colgroup><col><col></colgroup><tbody><tr><td>^U</td><td>Delete everything from the cursor to the beginning of the line</td></tr><tr><td>^W</td><td>Delete the word left of the cursor</td></tr><tr><td>^H</td><td>Delete the character in front of the cursor</td></tr><tr><td>^D</td><td>Delete the character under the cursor. If no characters are left, exit the CLI session.</td></tr><tr><td>^Y</td><td>Paste the previously deleted string</td></tr><tr><td>^L</td><td>Clear the screen and write the current entered command at the top</td></tr><tr><td>^A</td><td>Go to the beginning of the line</td></tr><tr><td>^E</td><td>Go to the end of the line</td></tr><tr><td>^C</td><td>Abort the current command</td></tr><tr><td>^P or arrow up</td><td>Show the previous command executed</td></tr><tr><td>^N or arrow down</td><td>Show the next command (if ^P has been used)</td></tr><tr><td>^S</td><td>Stop scrolling on the the CLI</td></tr><tr><td>^Q</td><td>Continue scrolling on the CLI</td></tr><tr><td>^V</td><td>Interpret the next key literally</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34720552"></a>3.2.6. Backspace doesn't work</h3></div></div></div><p>When the backspace is pressed and a
<code class="computeroutput">^?</code>
shows up, try control-H to delete the character.
</p><p>When the backspace is pressed and a
<code class="computeroutput">^H</code>
shows up, try control-backspace to delete the character.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp34724456"></a>3.3. Tcpdump, the network packet capture tool</h2></div></div></div><p>Being able to see the traffic that goes in and out a network card
is great value to determine what occurs on network level. Tcpdump,
the standard network packet capture tool, is included on the Steelhead
appliances. It uses the pcap library for the capturing of the packets
on the NIC.
</p><p>The place where tcpdump captures the data from the network stack
is just before the sending or just after the receiving of the data
to and from the network card. This makes sure that the capture
happens with the data as closely as it is on the network cable as
possible.
</p><p>Tcpdump supports both IPv4 and IPv6 addresses.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34727208"></a>3.3.1. Tcpdump options</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The option 
<code class="computeroutput">-n</code>
  will prevent DNS name resolution of the IP addresses and services
  detected in the captured packet.
</p></li><li class="listitem"><p>The option 
<code class="computeroutput">-s</code>
  specifies the number of bytes to read from the captured packets.
</p></li><li class="listitem"><p>The option 
<code class="computeroutput">-i</code>
  will select the interface to capture on.
</p></li><li class="listitem"><p>The option 
<code class="computeroutput">-c</code>
  specifies the limit on the number of packets captured.
</p></li><li class="listitem"><p>The option 
<code class="computeroutput">-w</code>
  specifies the filename to write the capture to.
</p></li><li class="listitem"><p>The option 
<code class="computeroutput">-v</code>
  will print how many packets are captured and written to disk.
</p></li><li class="listitem"><p>The option 
<code class="computeroutput">-le</code>
  will print the link layer information of the captured packet.
</p></li><li class="listitem"><p>The option 
<code class="computeroutput">-X</code>
  (capital X) will also print contents of the captured packet in
  hex and character dump format.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34764904"></a>3.3.2. Usage hints for tcpdump</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Always use the
<code class="computeroutput">-n</code>
  option to disable name resolution otherwise it will slow down the
  display of packets and possible dropping of captured packets.
</p></li><li class="listitem"><p>Don't capture on the in-path interfaces, always capture on the
  corresponding LAN and WAN interfaces.
</p></li><li class="listitem"><p>Don't capture on the
<span class="italics">primary</span>
  interface, always capture on the
<span class="italics">prihw</span>
  interface.
</p></li><li class="listitem"><p>Use
<code class="computeroutput">-c</code>
  to limit the number of packets captured to prevent them from
  scrolling of the screen.
</p></li><li class="listitem"><p>When writing captured packets to disk, use the
<code class="computeroutput">-v</code>
  option to see the number of packets written.
</p></li><li class="listitem"><p>Use correct filters to capture only the packets you are interested
  in.
</p></li><li class="listitem"><p>The default filter is based on the standard Ethernet frame headers.
  Use the
<code class="computeroutput">vlan</code>
  primitive to switch to the 802.1Q VLAN Ethernet frame format.
</p></li><li class="listitem"><p>Use a snaplength of 1600 for a full payload capture.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34843560"></a>3.3.3. Auto-discovery and Full transparency / Port Transparency options</h3></div></div></div><p>The normal tcpdump program will not be able to decode the Riverbed
TCP Options and will display them as a hex-string:
</p><div class="figure"><a name="idp34911080"></a><p class="title"><b>Figure 3.6. The Riverbed specific TCP options not decoded in tcpdump before RiOS 6.1.4 and 6.5.2</b></p><div class="figure-contents"><pre class="screen">11:12:47.668647 IP 10.0.1.1.52175 &gt; 192.168.1.1.80: Flags [S], seq 4101063156, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 693134564 ecr 0,sackOK,nop,nop,opt-76:01 \
    010a0001060005,opt-76:0c01,nop,eol], length 0
11:12:47.801418 IP 192.168.1.1.80 &gt; 10.0.1.1.52175: Flags [S.], seq 20020520, ack 41010631 \
    57, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 693134564 ecr 0,sackOK,no \
    p,nop,opt-76:0c01,nop,nop,nop,eol], length 0
11:12:47.801454 IP 192.168.1.1.80 &gt; 10.0.1.1.52175: Flags [S.], seq 20020520, ack 41010631 \
    57, win 65535, options [mss 1460,nop,wscale 3,TS val 693134564 ecr 0,sackOK,opt-76:111 \
    10a000106c0a801061e78,opt-76:0e3d,nop,eol], length 0
</pre></div></div><br class="figure-break"><p>With the release of RiOS 6.1.4 and 6.5.2, the tcpdump program
included on the Steelhead appliances will decode the auto-discovery
and the WAN Visibility Transparency TCP options:
</p><div class="figure"><a name="idp34913640"></a><p class="title"><b>Figure 3.7. The Riverbed specific TCP options for auto-discovery decoded in tcpdump after RiOS 6.1.4 and 6.5.2</b></p><div class="figure-contents"><pre class="screen">11:12:47.668647 IP 10.0.1.1.52175 &gt; 192.168.1.1.80: Flags [S], seq 4101063156, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 693134564 ecr 0,sackOK,nop,nop,rvbd-prob \
    e AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
11:12:47.801418 IP 192.168.1.1.80 &gt; 10.0.1.1.52175: Flags [S.], seq 20020520, ack 41010631 \
    57, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 693134564 ecr 0,sackOK,no \
    p,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
11:12:47.801454 IP 192.168.1.1.80 &gt; 10.0.1.1.52175: Flags [S.], seq 20020520, ack 41010631 \
    57, win 65535, options [mss 1460,nop,wscale 3,TS val 693134564 ecr 0,sackOK,rvbd-probe \
     AD CSH:10.0.1.6 SSH:192.168.1.6:7800 11110a000106c0a801061e78,rvbd-probe EAD 0e3d,nop \
    ,eol], length 0
</pre></div></div><br class="figure-break"><p>For the Auto-Discovery process, it will show the IP addresses of
the CSH (Client-side Steelhead appliance) and the SSH (Server-side
Steelhead appliance).
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The keyword
<code class="computeroutput">rvbd-probe</code>
  tells that the option is TCP option 76 for the auto-discovery
  process.
</p></li><li class="listitem"><p>The keyword
<code class="computeroutput">AD</code>
  tells that the option is part of the auto-discovery process.
</p></li><li class="listitem"><p>The keyword
<code class="computeroutput">EAD</code>
  tells that the option is part of the enhanced auto-discovery
  process.
</p></li><li class="listitem"><p>The keyword
<code class="computeroutput">CSH</code>
  gives the IP address of the client-side Steelhead appliance.
</p></li><li class="listitem"><p>The keyword
<code class="computeroutput">SSH</code>
  gives the IP address and TCP port of the server-side Steelhead
  appliance.
</p></li></ul></div><p>For the WAN Visibility Transparency feature, it will show the IP
addresses and TCP port numbers of the inner channel.
</p><div class="figure"><a name="idp34941160"></a><p class="title"><b>Figure 3.8. The Riverbed specific TCP options for WAN Visibility Transparency feature decoded in tcpdump after RiOS 6.1.4 and 6.5.2</b></p><div class="figure-contents"><pre class="screen">12:02:03.274738 IP 10.0.1.1.3789 &gt; 192.168.1.1.80: Flags [P.], seq 1:11, ack 7, win 4592,  \
    options [nop,nop,TS val 958790087 ecr 1176840218,rvbd-trans Transp sSH:10.0.1.6:42455  \
    dSH:192.168.1.1:7800 00000a000106c0a80106a5d71e78], length 10
12:02:03.288821 IP 192.168.1.1.80 &gt; 10.0.1.1.3789: Flags [.], seq 7, ack 11, win 23, optio \
    ns [nop,nop,TS val 1176840247 ecr 958790087,rvbd-trans Transp sSH:192.168.1.6:7800 dSH \
    :10.0.1.6:42455 0000c0a801060a0001061e78a5d7], length 0
</pre></div></div><br class="figure-break"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The keyword
<code class="computeroutput">rvbd-trans</code>
  tells that the option is TCP option 78 for the WAN Visibility
  Full Transparency feature.
</p></li><li class="listitem"><p>The keyword
<code class="computeroutput">Transp</code>
  tells that the standard transparency options are used.
</p></li><li class="listitem"><p>The keyword
<code class="computeroutput">sSH</code>
  gives the IP address and TCP port of the sending Steelhead appliance.
</p></li><li class="listitem"><p>The keyword
<code class="computeroutput">dSH</code>
  gives the IP address and TCP port of the destination Steelhead
  appliance.
</p></li></ul></div><p>With the release of Wireshark version 1.6.0, it can decode the
auto-discovery and the transparency TCP options.
</p><div class="figure"><a name="idp34969064"></a><p class="title"><b>Figure 3.9. The Riverbed specific TCP options decoded in tshark</b></p><div class="figure-contents"><pre class="screen">$ tshark -O tcp -V -nr autodiscovery.cap
Frame 1: 94 bytes on wire (752 bits), 94 bytes captured (752 bits)
Ethernet II, Src: d4:9a:20:c2:52:0e (d4:9a:20:c2:52:0e), Dst: 00:0d:b9:17:28:de (00:0d:b9: \
    17:28:de)
Internet Protocol Version 4, Src: 10.0.1.1 (10.0.1.1), Dst: 192.168.1.1 (192.168.1.1)
Transmission Control Protocol, Src Port: 52175 (52175), Dst Port: 80 (80), Seq: 0, Len: 0
    Source port: 52175 (52175)
    Destination port: 80 (80)
    [Stream index: 0]
    Sequence number: 0    (relative sequence number)
    Header length: 60 bytes
    Flags: 0x02 (SYN)
    Window size value: 65535
    [Calculated window size: 65535]
    Checksum: 0xe76d [validation disabled]
    Options: (40 bytes)
        Maximum segment size: 1460 bytes
        No-Operation (NOP)
        Window scale: 3 (multiply by 8)
        No-Operation (NOP)
        No-Operation (NOP)
        Timestamps: TSval 693134564, TSecr 0
        TCP SACK Permitted Option: True
        No-Operation (NOP)
        No-Operation (NOP)
        Riverbed Probe: Probe Query, CSH IP: 10.0.1.6
            Length: 10
            0000 .... = Type: 0
            .... 0001 = Version: 1
            Reserved
            CSH IP: 10.0.1.6 (10.0.1.6)
            Application Version: 5
        Riverbed Probe: Probe Query Info
            Length: 4
            0000 110. = Type: 6
            .... ...0 = Version: 2
            Probe Flags: 0x01
                .... .0.. = Not CFE: Not set
                .... ...1 = Last Notify: Set
        No-Operation (NOP)
        End of Option List (EOL)

Frame 2: 86 bytes on wire (688 bits), 86 bytes captured (688 bits)
Ethernet II, Src: 00:0d:b9:17:28:de (00:0d:b9:17:28:de), Dst: d4:9a:20:c2:52:0e (d4:9a:20: \
    c2:52:0e)
Internet Protocol Version 4, Src: 192.168.1.1 (192.168.1.1), Dst: 10.0.1.1 (10.0.1.1)
Transmission Control Protocol, Src Port: 80 (80), Dst Port: 52175 (52175), Seq: 0, Ack: 1, \
     Len: 0
    Source port: 80 (80)
    Destination port: 52175 (52175)
    [Stream index: 0]
    Sequence number: 0    (relative sequence number)
    Acknowledgement number: 1    (relative ack number)
    Header length: 52 bytes
    Flags: 0x12 (SYN, ACK)
    Window size value: 65535
    [Calculated window size: 65535]
    Checksum: 0xe020 [validation disabled]
    Options: (32 bytes)
        Maximum segment size: 1460 bytes
        No-Operation (NOP)
        Window scale: 3 (multiply by 8)
        No-Operation (NOP)
        No-Operation (NOP)
        Timestamps: TSval 693134564, TSecr 0
        TCP SACK Permitted Option: True
        No-Operation (NOP)
        No-Operation (NOP)
        Riverbed Probe: Probe Query Info
            Length: 4
            0000 110. = Type: 6
            .... ...0 = Version: 2
            Probe Flags: 0x01
                .... .0.. = Not CFE: Not set
                .... ...1 = Last Notify: Set
        No-Operation (NOP)
        No-Operation (NOP)
        No-Operation (NOP)
        End of Option List (EOL)
    [SEQ/ACK analysis]
        [This is an ACK to the segment in frame: 1]
        [The RTT to ACK the segment was: 0.132771000 seconds]

Frame 3: 94 bytes on wire (752 bits), 94 bytes captured (752 bits)
Ethernet II, Src: 00:0d:b9:17:28:de (00:0d:b9:17:28:de), Dst: d4:9a:20:c2:52:0e (d4:9a:20: \
    c2:52:0e)
Internet Protocol Version 4, Src: 192.168.1.1 (192.168.1.1), Dst: 10.0.1.1 (10.0.1.1)
Transmission Control Protocol, Src Port: 80 (80), Dst Port: 52175 (52175), Seq: 0, Ack: 1, \
     Len: 0
    Source port: 80 (80)
    Destination port: 52175 (52175)
    [Stream index: 0]
    Sequence number: 0    (relative sequence number)
    Acknowledgement number: 1    (relative ack number)
    Header length: 60 bytes
    Flags: 0x12 (SYN, ACK)
    Window size value: 65535
    [Calculated window size: 65535]
    Checksum: 0x7893 [validation disabled]
    Options: (40 bytes)
        Maximum segment size: 1460 bytes
        No-Operation (NOP)
        Window scale: 3 (multiply by 8)
        Timestamps: TSval 693134564, TSecr 0
        TCP SACK Permitted Option: True
        Riverbed Probe: Probe Response, Server Steelhead: 192.168.1.6:7800
            Length: 14
            0001 .... = Type: 1
            .... 0001 = Version: 1
            Reserved
            CSH IP: 10.0.1.6 (10.0.1.6)
            SSH IP: 192.168.1.6 (192.168.1.6)
            SSH Port: 7800
        Riverbed Probe: Probe Response Info
            Length: 4
            0000 111. = Type: 7
            .... ...0 = Version: 2
            Probe Flags: 0x3d
                ...1 .... = Disable Probe Cache on CSH: Set
                .... ..0. = SSL Enabled: Not set
                .... ...1 = SSH outer to server established: Set
        No-Operation (NOP)
        End of Option List (EOL)
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp34972712"></a><p class="title"><b>Figure 3.10. The Riverbed specific TCP options decoded in Wireshark</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/03-tools-02-wireshark.png" align="middle" width="100%" alt="The Riverbed specific TCP options decoded in Wireshark"></td></tr></table></div></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp34975144"></a>3.3.4. Pcap filters</h3></div></div></div><p>There are several basic pcap primitives to be understood before
tcpdump can be used effectively:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The primitive
<code class="computeroutput">host &lt;IP address&gt;</code>
  filters the packets to match this source or destination IP address.
</p></li><li class="listitem"><p>The primitive
<code class="computeroutput">net &lt;IP subnet&gt;</code>
  filters the packets to match this source or destination IP subnet.
</p></li><li class="listitem"><p>The primitive
<code class="computeroutput">port &lt;port number&gt;</code>
  filters the packets to match this source or destination TCP or
  UDP port numbers.
</p></li><li class="listitem"><p>The primitive
<code class="computeroutput">ip</code>
  and
<code class="computeroutput">ip6</code>
  filters explicitly for IPv4 and IPv6 addresses.
</p></li><li class="listitem"><p>The primitive
<code class="computeroutput">icmp</code>
  filters for only ICMP packets, the primitive
<code class="computeroutput">tcp</code>
  filters for only TCP packets, the primitive
<code class="computeroutput">udp</code>
  filters for only UDP packets.
</p></li><li class="listitem"><p>The primitive
<code class="computeroutput">vlan</code>
  is not so much a filter but more a change in the offset in the
  filter: From this part of the filter, the offset for the IP packet
  is indexed to the size of a 802.1Q VLAN tagged Ethernet frame.
</p></li></ul></div><p>The various primitives can be merged with a boolean "and" and "or".
But keep in mind that, unlike boolean logic, the "and" and "or"
have the same precedence. The precedence can be changed by using
round brackets around a part of the filter.
</p><p>For example, if the filter needs to capture all traffic from host
H1 on port P1 or from host H2 on port P2, then
<code class="computeroutput">host H1 and port P1 or host H2 and port P2</code>
gets interpreted as
<code class="computeroutput">((((host H1) and port P1) or host H2) and port P2)</code>.
However, what was needed was:
<code class="computeroutput">(host H1 and port P1) or (host H2 and port P2)</code>.
</p><p>Always use round brackets to prioritize parts of the filter!
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35032424"></a>3.3.5. Examples of tcpdump scenarios</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35033256"></a>3.3.5.1. Display the first ten packets from or to one host</h4></div></div></div><p>The first example is capturing the first 10 packets to host 10.0.1.1.
</p><div class="figure"><a name="idp35034792"></a><p class="title"><b>Figure 3.11. Display the first ten packets from and to a certain host</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0_0 -c 10 'host 10.0.1.1'
tcpdump: WARNING: lan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
12:07:07.298829 ARP, Request who-has 10.0.1.6 tell 10.0.1.1, length 46
12:07:07.298872 ARP, Reply 10.0.1.6 is-at 00:0e:b6:8c:74:9c, length 28
12:07:08.194021 IP 10.0.1.1.52902 &gt; 202.83.176.1.53: 53837 [1au] A? www.mavetju.org. (44)
12:07:08.234151 IP 202.83.176.1.53 &gt; 10.0.1.1.52902: 53837*- 1/2/3 A 192.168.1.1 (141)
12:07:09.464621 IP 10.0.1.1.42825 &gt; 192.168.1.1.80: Flags [S], seq 3872240793, win 65535,  \
    options [mss 1460,nop,wscale 6,sackOK,TS val 5351449 ecr 0], length 0
12:07:09.598157 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [S.], seq 2971872340, ack 387224 \
    0794, win 5792, options [mss 1460,sackOK,TS val 285084142 ecr 5351449,nop,wscale 2], l \
    ength 0
12:07:09.602342 IP 10.0.1.1.42825 &gt; 192.168.1.1.80: Flags [.], seq 1, ack 1, win 1040, opt \
    ions [nop,nop,TS val 5351588 ecr 285084142], length 0
12:07:09.602375 IP 10.0.1.1.42825 &gt; 192.168.1.1.80: Flags [P.], seq 1:188, ack 1, win 1040 \
    , options [nop,nop,TS val 5351589 ecr 285084142], length 187
12:07:09.602393 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [.], seq 1, ack 188, win 1716, o \
    ptions [nop,nop,TS val 285084146 ecr 5351589], length 0
12:07:09.875867 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [P.], seq 1:1151, ack 188, win 1 \
    716, options [nop,nop,TS val 285084420 ecr 5351589], length 1150
10 packets captured
14 packets received by filter
0 packets dropped by kernel
</pre></div></div><br class="figure-break"><p>In the example above, 14 packets were captured from the network and
10 matched the filter. Zero packets could not be processed in time
by the pcap filter.
</p><p>The packets are: an Ethernet broadcast ARP request and reply, a DNS
request and answer and then a TCP SYN, SYN/ACK and ACK to setup the
TCP session and some data towards a web server.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35037672"></a>3.3.5.2. Display the first ten packets between two hosts</h4></div></div></div><p>For troubleshooting, capturing traffic between two hosts is required.
Here we filter between the hosts 10.0.1.1 and 192.168.1.1.
</p><div class="figure"><a name="idp35039720"></a><p class="title"><b>Figure 3.12. Display the first ten packets between hosts 10.0.1.1 and 192.168.1.1</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0_0 -c 10 'host 10.0.1.1 and host 192.168.1.1'
tcpdump: WARNING: lan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
12:07:09.464621 IP 10.0.1.1.42825 &gt; 192.168.1.1.80: Flags [S], seq 3872240793, win 65535,  \
    options [mss 1460,nop,wscale 6,sackOK,TS val 5351449 ecr 0], length 0
12:07:09.598157 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [S.], seq 2971872340, ack 387224 \
    0794, win 5792, options [mss 1460,sackOK,TS val 285084142 ecr 5351449,nop,wscale 2], l \
    ength 0
12:07:09.602342 IP 10.0.1.1.42825 &gt; 192.168.1.1.80: Flags [.], seq 1, ack 1, win 1040, opt \
    ions [nop,nop,TS val 5351588 ecr 285084142], length 0
12:07:09.602375 IP 10.0.1.1.42825 &gt; 192.168.1.1.80: Flags [P.], seq 1:188, ack 1, win 1040 \
    , options [nop,nop,TS val 5351589 ecr 285084142], length 187
12:07:09.602393 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [.], seq 1, ack 188, win 1716, o \
    ptions [nop,nop,TS val 285084146 ecr 5351589], length 0
12:07:09.875867 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [P.], seq 1:1151, ack 188, win 1 \
    716, options [nop,nop,TS val 285084420 ecr 5351589], length 1150
12:07:09.979743 IP 10.0.1.100.42825 &gt; 192.168.1.6.80: Flags [.], seq 188, ack 1151, win 10 \
    40, options [nop,nop,TS val 5351967 ecr 285084420], length 0
12:07:10.881288 IP 10.0.1.100.42825 &gt; 192.168.1.6.80: Flags [P.], seq 188:420, ack 1151, w \
    in 1040, options [nop,nop,TS val 5352869 ecr 285084420], length 232
12:07:10.881392 IP 192.168.1.6.80 &gt; 10.0.1.100.42825: Flags [.], seq 1151, ack 420, win 17 \
    16, options [nop,nop,TS val 285085425 ecr 5352869], length 0
12:07:11.106812 IP 192.168.1.6.80 &gt; 10.0.1.100.42825: Flags [P.], seq 1151:1663, ack 420,  \
    win 1716, options [nop,nop,TS val 285085651 ecr 5352869], length 512
10 packets captured
18 packets received by filter
0 packets dropped by kernel
</pre></div></div><br class="figure-break"><p>The packets shown are the setup of a HTTP TCP session and the
exchange of the data.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35042344"></a>3.3.5.3. Display packets on a VLAN trunk</h4></div></div></div><p>The difference in length of a normal IEEE 802.3 Ethernet frame and
a IEEE 802.1q VLAN Ethernet frame is four bytes:
</p><div class="figure"><a name="idp35043752"></a><p class="title"><b>Figure 3.13. A normal 802.3 Ethernet frame</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/03-ethernet-novlan.png" align="middle" width="100%" alt="A normal 802.3 Ethernet frame"></td></tr></table></div></div></div><br class="figure-break"><div class="figure"><a name="idp35050984"></a><p class="title"><b>Figure 3.14. An 802.1Q VLAN Ethernet frame</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/03-ethernet-vlan.png" align="middle" width="100%" alt="An 802.1Q VLAN Ethernet frame"></td></tr></table></div></div></div><br class="figure-break"><p>The implementation of pcap capture library is not capable to
automatically determine the size difference of the two frame types
and it will assume the size of a normal 802.3 Ethernet frame. This
means that the offset for the IP header, and thus the higher level
protocols on top of IP, for 802.1q frames is incorrect and the
filtering of packets on the specified fields will fail. To overcome
this, the primitive "vlan" can be used, however it will cause the
rest of the filter to assume that the Ethernet frame size is the
size of a 802.1q Ethernet frame.
</p><p>To filter for host 10.0.1.1 for normal 802.3 Ethernet frames:
<code class="computeroutput">host 10.0.1.1</code>.
To filter for host 10.0.1.1 for 802.1q Ethernet frames:
<code class="computeroutput">(vlan and host 10.0.1.1)</code>.
To filter for host 10.0.1.1 for normal 802.3 and 802.1q Ethernet frames:
<code class="computeroutput">host 10.0.1.1 or (vlan and host 10.0.1.1)</code>.
</p><p>The default output of tcpdump doesn't show the VLAN tag ID of the 802.1q
Ethernet frames, to show then use the option
<code class="computeroutput">-le</code>
to display them.
</p><div class="figure"><a name="idp35068584"></a><p class="title"><b>Figure 3.15. Display the first ten packets between host 10.0.1.1 and host 192.168.1.1</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -le -ni lan0_0 -c 10 'host 10.0.1.1 and host 192.168.1.1 or (vlan and host 10 \
    .0.1.1 and host 192.168.1.1)''
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
12:11:36.684544 00:21:70:3e:6b:7f &gt; 00:0d:b9:17:28:de, ethertype 802.1Q (0x8100), length 9 \
    4: vlan 200, p 0, ethertype IPv4, IP 10.0.1.1.60035 &gt; 192.168.1.1.https: S 1139103120: \
    1139103120(0) win 5840 &lt;mss 1460,sackOK,timestamp 1864443320 0,nop,wscale 2&gt;
12:11:36.685159 00:0d:b9:17:28:de &gt; 00:21:70:3e:6b:7f, ethertype 802.1Q (0x8100), length 8 \
    2: vlan 200, p 0, ethertype IPv4, IP 192.168.1.1.https &gt; 10.0.1.1.60035: S 2827780182: \
    2827780182(0) ack 1139103121 win 4380 &lt;mss 1460,nop,wscale 0,nop,nop,timestamp 7927005 \
    29 1864443320,sackOK,eol&gt;
12:11:36.685203 00:21:70:3e:6b:7f &gt; 00:0d:b9:17:28:de, ethertype 802.1Q (0x8100), length 7 \
    0: vlan 200, p 0, ethertype IPv4, IP 10.0.1.1.60035 &gt; 192.168.1.1.https: . ack 1 win 1 \
    460 &lt;nop,nop,timestamp 1864443320 792700529&gt;
12:11:37.025716 00:21:70:3e:6b:7f &gt; 00:0d:b9:17:28:de, ethertype 802.1Q (0x8100), length 1 \
    36: vlan 200, p 0, ethertype IPv4, IP 10.0.1.1.60035 &gt; 192.168.1.1.https: P 1:67(66) a \
    ck 1 win 1460 &lt;nop,nop,timestamp 1864443661 792700529&gt;
12:11:37.026275 00:0d:b9:17:28:de &gt; 00:21:70:3e:6b:7f, ethertype 802.1Q (0x8100), length 1 \
    518: vlan 200, p 0, ethertype IPv4, IP 192.168.1.1.https &gt; 10.0.1.1.60035: . 1:1449(14 \
    48) ack 67 win 4380 &lt;nop,nop,timestamp 792700870 1864443661&gt;
12:11:37.026284 00:0d:b9:17:28:de &gt; 00:21:70:3e:6b:7f, ethertype 802.1Q (0x8100), length 1 \
    518: vlan 200, p 0, ethertype IPv4, IP 192.168.1.1.https &gt; 10.0.1.1.60035: . 1449:2897 \
    (1448) ack 67 win 4380 &lt;nop,nop,timestamp 792700870 1864443661&gt;
12:11:37.026288 00:0d:b9:17:28:de &gt; 00:21:70:3e:6b:7f, ethertype 802.1Q (0x8100), length 1 \
    518: vlan 200, p 0, ethertype IPv4, IP 192.168.1.1.https &gt; 10.0.1.1.60035: P 2897:4345 \
    (1448) ack 67 win 4380 &lt;nop,nop,timestamp 792700870 1864443661&gt;
12:11:37.026314 00:21:70:3e:6b:7f &gt; 00:0d:b9:17:28:de, ethertype 802.1Q (0x8100), length 7 \
    0: vlan 200, p 0, ethertype IPv4, IP 10.0.1.1.60035 &gt; 192.168.1.1.https: . ack 1449 wi \
    n 2184 &lt;nop,nop,timestamp 1864443661 792700870&gt;
12:11:37.026327 00:21:70:3e:6b:7f &gt; 00:0d:b9:17:28:de, ethertype 802.1Q (0x8100), length 7 \
    0: vlan 200, p 0, ethertype IPv4, IP 10.0.1.1.60035 &gt; 192.168.1.1.https: . ack 2897 wi \
    n 2908 &lt;nop,nop,timestamp 1864443661 792700870&gt;
12:11:37.026336 00:21:70:3e:6b:7f &gt; 00:0d:b9:17:28:de, ethertype 802.1Q (0x8100), length 7 \
    0: vlan 200, p 0, ethertype IPv4, IP 10.0.1.1.60035 &gt; 192.168.1.1.https: . ack 4345 wi \
    n 3632 &lt;nop,nop,timestamp 1864443661 792700870&gt;
10 packets captured
19 packets received by filter
0 packets dropped by kernel
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35070184"></a>3.3.5.4. Display all ICMP traffic from and to a certain host</h4></div></div></div><p>This can be used to determine the forward and backward path the
traffic takes by pinging from the client.
</p><div class="figure"><a name="idp35071720"></a><p class="title"><b>Figure 3.16. Capture all traffic for all ICMP traffic from and to host 10.0.1.1</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0_0 -c 10 'host 10.0.1.1 and icmp'
tcpdump: WARNING: lan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
10:41:36.717861 IP 10.0.1.1 &gt; 192.168.1.1: ICMP echo request, id 2722, seq 0, length 64
10:41:36.851611 IP 192.168.1.1 &gt; 10.0.1.1: ICMP echo reply, id 2722, seq 0, length 64
10:41:37.714418 IP 10.0.1.1 &gt; 192.168.1.1: ICMP echo request, id 2722, seq 1, length 64
10:41:37.847110 IP 192.168.1.1 &gt; 10.0.1.1: ICMP echo reply, id 2722, seq 1, length 64
10:41:44.120470 IP 10.0.1.1 &gt; 192.168.1.1: ICMP echo request, id 2978, seq 0, length 64
10:41:44.253989 IP 192.168.1.1 &gt; 10.0.1.1: ICMP echo reply, id 2978, seq 0, length 64
10:41:45.121247 IP 10.0.1.1 &gt; 192.168.1.1: ICMP echo request, id 2978, seq 1, length 64
10:41:45.254498 IP 192.168.1.1 &gt; 10.0.1.1: ICMP echo reply, id 2978, seq 1, length 64
10:41:46.122364 IP 10.0.1.1 &gt; 192.168.1.1: ICMP echo request, id 2978, seq 2, length 64
10:41:46.255055 IP 192.168.1.1 &gt; 10.0.1.1: ICMP echo reply, id 2978, seq 2, length 64
10:41:47.123360 IP 10.0.1.1 &gt; 192.168.1.1: ICMP echo request, id 2978, seq 3, length 64
10:41:47.255448 IP 192.168.1.1 &gt; 10.0.1.1: ICMP echo reply, id 2978, seq 3, length 64
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35073640"></a>3.3.5.5. Display the first ten packets from and to certain host on TCP port 443</h4></div></div></div><p>This can be used to capture the setup of a TCP session.
</p><div class="figure"><a name="idp35074984"></a><p class="title"><b>Figure 3.17. Capture all traffic from and to host 10.0.1.1 on port 443</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0_0 -c 10 'host 10.0.1.1 and port 443'
tcpdump: WARNING: lan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
10:42:56.184613 IP 10.0.1.1.57118 &gt; 192.168.1.1.443: Flags [S], seq 1770219666, win 65535, \
     options [mss 1460,nop,wscale 1,nop,nop,TS val 2747475397 ecr 0,sackOK,eol], length 0
10:42:56.317961 IP 192.168.1.1.443 &gt; 10.0.1.1.57118: Flags [S.], seq 2854931292, ack 17702 \
    19667, win 5792, options [mss 1460,sackOK,TS val 92454666 ecr 2747475397,nop,wscale 2] \
    , length 0
10:42:56.320460 IP 10.0.1.1.57118 &gt; 192.168.1.1.443: Flags [.], seq 1, ack 1, win 33304, o \
    ptions [nop,nop,TS val 2747475537 ecr 92454666], length 0
10:42:56.320522 IP 10.0.1.1.57118 &gt; 192.168.1.1.443: Flags [P.], seq 1:149, ack 1, win 333 \
    04, options [nop,nop,TS val 2747475537 ecr 92454666], length 148
10:42:56.454635 IP 192.168.1.1.443 &gt; 10.0.1.1.57118: Flags [.], seq 1, ack 149, win 1448,  \
    options [nop,nop,TS val 92454803 ecr 2747475537], length 0
10:42:56.509572 IP 192.168.1.1.443 &gt; 10.0.1.1.57118: Flags [.], seq 1:1449, ack 149, win 1 \
    448, options [nop,nop,TS val 92454858 ecr 2747475537], length 1448
10:42:56.514621 IP 192.168.1.1.443 &gt; 10.0.1.1.57118: Flags [P.], seq 1449:2564, ack 149, w \
    in 1448, options [nop,nop,TS val 92454858 ecr 2747475537], length 1115
10:42:56.518535 IP 10.0.1.1.57118 &gt; 192.168.1.1.443: Flags [.], seq 149, ack 2564, win 327 \
    46, options [nop,nop,TS val 2747475729 ecr 92454858], length 0
10:42:56.522466 IP 10.0.1.1.57118 &gt; 192.168.1.1.443: Flags [P.], seq 149:347, ack 2564, wi \
    n 33304, options [nop,nop,TS val 2747475732 ecr 92454858], length 198
10:42:56.522477 IP 10.0.1.1.57118 &gt; 192.168.1.1.443: Flags [P.], seq 347:384, ack 2564, wi \
    n 33304, options [nop,nop,TS val 2747475732 ecr 92454858], length 37

</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35080424"></a>3.3.5.6. Display all Ethernet broadcast traffic</h4></div></div></div><p>When the issue seems to be related to a mismatch of the VLAN tag,
the best way to determine what goes wrong is to look at the Ethernet
broadcast traffic.
</p><div class="figure"><a name="idp35200744"></a><p class="title"><b>Figure 3.18. Tcpdump filter for all Ethernet broadcast traffic</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -le -ni lan0_0 -c 10 'ether broadcast or (vlan and ether broadcast)''
18:53:46.027193 00:0e:b6:42:f8:9c &gt; ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 4 \
    6: vlan 12, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.6, length 28
18:53:46.123323 00:0d:b9:17:28:de &gt; ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 4 \
    6: vlan 3, p 0, ethertype ARP, Request who-has 10.0.1.1 tell 10.0.1.9, length 28
</pre></div></div><br class="figure-break"><p>In this example, the Ethernet frames of host 10.0.1.6 are on VLAN
12, while the Ethernet frames of host 10.0.1.9 are on VLAN 3. 
</p><p>If no traffic shows up, try to force it by:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Clearing the ARP table on the Steelhead appliance and on the router.
</p></li><li class="listitem"><p>From the router, ping an unused IP address on the LAN. This will
  force the router to keep sending out ARP requests and then, from
  the Steelhead appliance, ping an unused IP address on the LAN.
</p></li></ul></div><p>
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35227688"></a>3.3.6. Tcpdump related issues</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35228584"></a>3.3.6.1. TCP Checksum errors</h4></div></div></div><p>When running tcpdump, packets created by the Steelhead appliance
and put on the wire might show up with a TCP checksum mismatch.
This is caused by the capability of the network card to generate
the TCP header checksum and the IP header checksum.
</p><div class="figure"><a name="idp35230184"></a><p class="title"><b>Figure 3.19. Incorrect TCP checksum messages because of TCP checksum offloading</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -lennv -s 1500 -i wan0_0
tcpdump: WARNING: wan0_0: no IPv4 address assigned
listening on wan0_0, link-type EN10MB (Ethernet), capture size 1500 bytes
19:47:09.324317 d4:9a:20:c2:52:0e &gt; 00:0d:b9:17:28:de, ethertype IPv4 (0x0800), length 66: \
     (tos 0x0, ttl 127, id 6410, offset 0, flags [DF], proto TCP (6), length 52)
    10.0.1.1.58616 &gt; 192.168.1.1.445: Flags [S], cksum 0x0e5a (correct), seq 3025755960, w \
    in 8192, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
19:47:09.342483 00:0d:b9:17:28:de &gt; d4:9a:20:c2:52:0e, ethertype IPv4 (0x0800), length 66: \
     (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 52)
    192.168.1.1.445 &gt; 10.0.1.1.58616: Flags [S.], cksum 0x4695 (incorrect -&gt; 0xdc12), seq  \
    753995387, ack 3025755961, win 5840, options [mss 1460,nop,nop,sackOK,nop,wscale 2], l \
    ength 0
</pre></div></div><br class="figure-break"><p>The second packet has an incorrect calculated TCP checksum:
<code class="computeroutput">cksum 0x4695 (incorrect -&gt; 0xdc12)</code>.
Since the MAC address identifies it as being created by this Steelhead
appliance, it is safe to assume that the TCP checksum mismatch is
caused by the TCP checksum offloading towards the network card and
can be ignored.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35255656"></a>3.3.6.2. TCP Segmentation Offloading</h4></div></div></div><p>TCP Segmentation Offloading is a feature on the NICs which allows
the NIC to present multiple TCP packets as one large one:
</p><div class="figure"><a name="idp35256552"></a><p class="title"><b>Figure 3.20. Wireshark showing larger than MSS size TCP packets</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/03-wireshark-tso.png" align="middle" width="100%" alt="Wireshark showing larger than MSS size TCP packets"></td></tr></table></div></div></div><br class="figure-break"><p>Despite that the MSS size is negotiated to 1460, the captured packets
have a TCP length of 2920 and 4380 bytes in size. This is two times
and three times the maximum size.
</p><p>The impact of this is that a capture length of 1600 suddenly doesn't
capture the whole packet and analysis by Wireshark and other tools
have insufficient data to work with.
</p><p>To disable this feature, use the command
<code class="computeroutput">no interface inpathX_X gso enable</code>.
Use the command
<code class="computeroutput">show interface inpathX_X gso</code>
to see the current settings:
</p><div class="figure"><a name="idp35263464"></a><p class="title"><b>Figure 3.21. Output of the command "show interface inpathX_X gso"</b></p><div class="figure-contents"><pre class="screen">SH # show interfaces inpath0_0 gso
generic-segmentation-offload: on
TCP-segmentation-offload: on
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35265832"></a>3.3.6.3. WCCP / PBR captures</h4></div></div></div><p>In a WCCP or PBR environment, traffic which is not supposed to be
optimized can still be forwarded to the Steelhead appliance.
</p><p>The traces of pass-through traffic will show double packets for
pass-through traffic: First the incoming packet towards the Steelhead
appliance, then the outgoing packet towards the default gateway.
On Ethernet level the payload is the same, the only difference is
the MAC addresses.
</p><p>However, captures taken of this pass-through traffic will show that
the MAC addresses of the two packets are the same: This is because
the way the data is handled in the network buffers. Wireshark will
show these packets as duplicate packets. This is a dissector issue
for this redirected traffic, not an issue with the traffic.
</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp35271976"></a>3.4. Tcpdump-x</h2></div></div></div><p>Tcpdump-x is a wrapper around tcpdump. It has the advantage over
the normal
<span class="italics">tcpdump</span>
command that the parameters are in a friendlier format and that it
can capture on multiple interfaces at the same time.
</p><p>It knows the following parameters:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="bold"><strong>all-interfaces</strong></span>:
Capture on all interfaces
</p></li><li class="listitem"><p>
<span class="bold"><strong>interfaces &lt;interface list&gt;</strong></span>
Capture on the specified interfaces, comma separated.
</p></li><li class="listitem"><p>
<span class="bold"><strong>capture-name &lt;identifier&gt;</strong></span>:
Use the specified
<span class="italics">identifier</span>
to identify the files stored when the capture is finished.
</p></li><li class="listitem"><p>
<span class="bold"><strong>snaplength &lt;length&gt;</strong></span>:
Capture the first
<span class="italics">length</span>
bytes per frame. Use 1600 for a full packet.
</p></li><li class="listitem"><p>
<span class="bold"><strong>custom &lt;pcap filter&gt;</strong></span>:
Use this pcap filter to limit the packets captured. It is fed to
tcpdump so all the primitives available to tcpdump are possible here.
</p></li><li class="listitem"><p>
<span class="bold"><strong>continuous</strong></span>:
Do not automatically terminate the capture after a certain time period
</p></li><li class="listitem"><p>
<span class="bold"><strong>duration &lt;number of seconds&gt;</strong></span>:
Run the capture for
<span class="italics">number of seconds</span>
seconds.
</p></li><li class="listitem"><p>
<span class="bold"><strong>file-size &lt;size&gt;</strong></span>:
Rotate the capture file when its size is
<span class="italics">size</span>
megabytes.
</p></li><li class="listitem"><p>
<span class="bold"><strong>rotate-count &lt;number&gt;</strong></span>:
Store at maximum
<span class="italics">number</span>
capture files per interface.
</p></li><li class="listitem"><p>
<span class="bold"><strong>stop &lt;capture-name&gt;</strong></span>:
Stop the capture specified by the previous
<span class="italics">capture-name</span>.
</p></li></ul></div><p>In the following example, the first command will capture all packets
on the lan0_0 and wan0_0 interfaces between host 10.0.1.1 and host
192.168.1.1. The second command captures all packets on the lan0_0
and wan0_0 interfaces for 30 seconds, maximum file size is 10 Mb
and the maximum number of files is 12. The third command shows all
running tcpdump-x captures. The fourth command terminates the first
command and the fifth command shows all the tcpdump captures.
</p><div class="figure"><a name="idp35407784"></a><p class="title"><b>Figure 3.22. Examples for using tcpdump-x</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump-x interfaces lan0_0,wan0_0 capture-name test1 snaplength 1600 custom 'host 10 \
    .0.1.1 and host 192.168.1.1' continuous
SH # tcpdump-x interfaces lan0_0,wan0_0 capture-name test2 snaplength 1600 rotate-count 12 \
     duration 30 file-size 10
SH # show tcpdump-x
Name: test1
Start Time: 21:41:14
SH # tcpdump-x capture-name test1 stop
SH # show files tcpdump
SH_lan0_0_test1.cap0
SH_wan0_0_test1.cap0
SH_lan0_0_test2.cap0
SH_wan0_0_test2.cap0
</pre></div></div><br class="figure-break"><p>Note that order of the options can be specific, so always use the
<span class="italics">?</span>
to see which options are available!

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp35419368"></a>3.5. Ping</h2></div></div></div><p>Ping is the most well-known command in the networking world to
determine if a remote host is reachable. It works by sending
<span class="italics">ICMP Echo Request</span>
packets and displays any ICMP packet returned.
</p><p>Besides the
<span class="italics">ping</span>
command, used for the IPv4 transport layer, there is also the
<span class="italics">ping6</span>
command, used for the IPv6 transport layer. The options used for
the IPv4 version can also be used for the IPv6 version unless noted
differently.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35424232"></a>3.5.1. Ping options</h3></div></div></div><p>The following options are available:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The option
<code class="computeroutput">-c #</code>
  limits the number of ICMP packets send out.
</p></li><li class="listitem"><p>The option
<code class="computeroutput">-I &lt;IP address&gt;</code>
  specifies the source IPv4 address to use and thus the outgoing
  interface. To specify the IPv6 source address, use the
<code class="computeroutput">-I &lt;interface&gt;</code>
  option, the IPv6 address on the specified interface will be used
  there.
</p></li><li class="listitem"><p>The option
<code class="computeroutput">-s #</code>
  specifies the size of the ICMP packet payload.
</p></li><li class="listitem"><p>The option
<code class="computeroutput">-M do</code>
  disables IP packet fragmentation due to MTU size issues.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35550696"></a>3.5.2. Ping examples</h3></div></div></div><p>On the Steelhead appliance, the ping command uses by default the
IP address of the primary interface as the source IP address of the
packets:
</p><div class="figure"><a name="idp35551848"></a><p class="title"><b>Figure 3.23. Ping a host via the primary interface</b></p><div class="figure-contents"><pre class="screen">SH # ping -c 3 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.
64 bytes from 192.168.1.1: icmp_seq=0 ttl=59 time=290.0 ms
64 bytes from 192.168.1.1: icmp_seq=1 ttl=59 time=260.0 ms
64 bytes from 192.168.1.1: icmp_seq=2 ttl=59 time=260.0 ms

--- 192.168.1.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 260.0/280.0/290.0/10.000 ms, pipe 2
</pre></div></div><br class="figure-break"><p>The option
<code class="computeroutput">-c 3</code>
limits the number of ICMP packets send to three, otherwise it will
keep sending
<span class="italics">ICMP Echo Request</span>
packets until the ping command is aborted via the control-C key
combination. The next option is the IP address or the hostname of
the destination host.
</p><p>The output shows the IP address of the device which answered the
<span class="italics">ICMP Echo Request</span>
command, the sequence number of the
<span class="italics">ICMP Echo Reply</span>
packet received back, the TTL of the IP packet which can be used
to identify the number of hops to the destination host is and the
time it took for the answer to come back.
</p><p>The
<code class="computeroutput">-I</code>
option can be used to specify the IP address of an in-path interface
to force the ICMP packet out via the corresponding LAN or WAN
interfaces. It will follow the routing table of that interface.
</p><div class="figure"><a name="idp35558696"></a><p class="title"><b>Figure 3.24. Ping a host via the in-path interface</b></p><div class="figure-contents"><pre class="screen">SH # ping -c 3 -I 10.0.1.6 192.168.1.1
PING 192.168.1.1 (192.168.1.1) from 10.0.1.6 : 56(84) bytes of data.
64 bytes from 192.168.1.1: icmp_seq=0 ttl=59 time=290 ms
64 bytes from 192.168.1.1: icmp_seq=0 ttl=59 time=260 ms
64 bytes from 192.168.1.1: icmp_seq=0 ttl=59 time=260 ms

--- 192.168.1.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 260.0/290.0/280.0/10.000 ms, pipe 2
</pre></div></div><br class="figure-break"><p>In this example, 10.0.1.6 was the in-path interface IP address.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35560232"></a>3.5.3. Detecting failure scenarios</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35560616"></a>3.5.3.1. No answer from a host on the local subnet</h4></div></div></div><p>When pinging a host on a local subnet and you get an
<span class="italics">ICMP Destination Host Unreachable</span>
message, it means that the ARP request for the destination host
didn't get an answered. Most of the time it means that the host
with that IP address is turned off.
</p><div class="figure"><a name="idp35562728"></a><p class="title"><b>Figure 3.25. IP address 10.0.1.4 is not in use on this local IP subnet</b></p><div class="figure-contents"><pre class="screen">SH # ping -c 3 10.0.1.4
PING 10.0.1.4 (10.0.1.4) 56(84) bytes of data.
From 10.0.1.5 icmp_seq=0 Destination Host Unreachable
From 10.0.1.5 icmp_seq=0 Destination Host Unreachable
--- 10.0.1.4 ping statistics ---
3 packets transmitted, 0 received, +2 errors, 100% packet loss, time 0ms , pipe 2
</pre></div></div><br class="figure-break"><p>Note that the
<span class="italics">ICMP Destination Host Unreachable</span>
message occurred because the ARP request for the IP address did not
get answered. If the host was firewalled and would drop the ICMP
traffic, the ARP request would have been answered so instead of
the
<span class="italics">ICMP Destination Host Unreachable</span>
message there would have been no output at all.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35565992"></a>3.5.3.2. No answer at all from a remote host</h4></div></div></div><p>For a host on a remote subnet, no answers can mean one of the
following issues:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The IP address is not in use and the router for that subnet is
  not sending
<span class="italics">ICMP Destination Host Unreachable</span>
  packets back.
</p></li><li class="listitem"><p>The destination host has been configured to not respond to
<span class="italics">ICMP Echo Request packets.</span>
</p></li><li class="listitem"><p>The destination IP subnet is unreachable from the sending host.
</p></li><li class="listitem"><p>The source IP subnet is unreachable from the remote host.
</p></li><li class="listitem"><p>A firewall in the network has blocked either the
<span class="italics">ICMP Echo Request</span>
  or the
<span class="italics">ICMP Echo Reply</span>
  packet.
</p></li></ul></div><div class="figure"><a name="idp35628392"></a><p class="title"><b>Figure 3.26. IP address 192.168.1.1 didn't reply.</b></p><div class="figure-contents"><pre class="screen">SH # ping -c 3 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.

--- 192.168.1.1 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 5000ms, pipe 2
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35629992"></a>3.5.3.3. Serious packet loss</h4></div></div></div><p>In every
<span class="italics">ICMP Echo Request</span>
message sent, the
<span class="italics">icmp_seq</span>
field contains the sequence number of the request. The returned
<span class="italics">ICMP Echo Response</span>
will contain the same sequence number and it can be used to determine
which packets were lost:
</p><div class="figure"><a name="idp35637224"></a><p class="title"><b>Figure 3.27. ICMP packets 3 to 5 and 8 to 9 didn't get answered.</b></p><div class="figure-contents"><pre class="screen">SH # ping -c 10 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.
64 bytes from 192.168.1.1: icmp_seq=0 ttl=59 time=260.0 ms
64 bytes from 192.168.1.1: icmp_seq=1 ttl=59 time=260.0 ms
64 bytes from 192.168.1.1: icmp_seq=2 ttl=59 time=260.0 ms
64 bytes from 192.168.1.1: icmp_seq=6 ttl=59 time=260.0 ms
64 bytes from 192.168.1.1: icmp_seq=7 ttl=59 time=260.0 ms

--- 192.168.1.1 ping statistics ---
10 packets transmitted, 5 received, 50% packet loss, time 0ms
rtt min/avg/max/mdev = 260.0/260.0/260.0/0.000 ms, pipe 2
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35654184"></a>3.5.4. Path MTU detection</h3></div></div></div><p>When an IP packet arrives at a router and the outgoing link has a
maximum packet size which is smaller than the IP packet, it will
break the IP packet in several smaller IP packets and send that
over the wire. To prevent this breaking up from happening, the
sender can set the
<span class="italics">Don't Fragment</span>
flag in the IP header. As a result, the router will not be able to
forward the packet and will send an
<span class="italics">ICMP Fragmentation Needed</span>
packet back to the sender. This
<span class="italics">ICMP Fragmentation Needed</span>
packet contains the MTU size of the link. The sender should then
retransmit the IP packet with a smaller payload.
</p><p>The IP packets of the inner channel of an optimized TCP session
have that
<span class="italics">Don't Fragment</span>
flag set. Therefore, routers on a link with a smaller MTU size than
what is configured on the Steelhead in-path interface should send
back an
<span class="italics">ICMP Fragmentation Needed</span>
packet. If the network for whatever reason doesn't deliver this to
the Steelhead appliance, the packet will not be delivered, the inner
channel will time-out and the optimized TCP session will break.
</p><p>The size parameter on the ping command can be used to determine the
maximum MTU size off the network.
</p><p>The initial size value to check should be the MTU size of the
interface on the Steelhead appliance minus 28 bytes. The 28 bytes
are the IP header and the
<span class="italics">ICMP Echo Request</span>
header.
</p><div class="figure"><a name="idp35680680"></a><p class="title"><b>Figure 3.28. ICMP based MTU size detection - MTU of 1500 bytes</b></p><div class="figure-contents"><pre class="screen">SH # ping -s 1472 -M do 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 1472(1500) bytes of data.
556 bytes from 10.0.1.9 (10.0.1.9): frag needed and DF set (MTU 1492)
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src         Dst
 4  5  00 d505 0058   0 0000  40  01 b4e1 10.0.1.5 192.168.1.1
</pre></div></div><br class="figure-break"><p>This
<span class="italics">ICMP Fragmentation Needed</span>
packet shows the following information:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The IP header contains 10.0.1.9, the IP address of the router
  which could not forward the IP packet.
</p></li><li class="listitem"><p>The ICMP payload contains 0058, the IP packet identifier of the
  IP packet which could not be forwarded.
</p></li><li class="listitem"><p>The ICMP payload contains 10.0.1.5 and 192.168.1.1, the source
  and destination IP address of the IP packet which was too big.
</p></li><li class="listitem"><p>1492, the MTU size of the outgoing link.
</p></li></ul></div><p>If no
<span class="italics">ICMP Fragment Needed</span>
packet or
<span class="italics">ICMP Echo Reply</span>
is returned, that is an indication that the network is dropping the
reply packet.
</p><p>The next steps is to reduce the size value to a value until you
receive
<span class="italics">ICMP Echo Replies</span>
instead of
<span class="italics">ICMP Fragmentation Needed</span>
packets. In this case where it is now known that the MTU size of
the first link is 1492, the next value to try should be 1492 minus
28 is 1464.
</p><div class="figure"><a name="idp35700584"></a><p class="title"><b>Figure 3.29. ICMP based MTU size detection - MTU of 1492 bytes</b></p><div class="figure-contents"><pre class="screen">SH # ping -s 1464 -M do 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 1464(1492) bytes of data.
1472 bytes from 192.168.1.1: icmp_seq=0 ttl=59 time=260.0 ms
</pre></div></div><br class="figure-break"><p>Setting the MTU size of the in-path interface to 1492 will overcome
the communication problem towards this remote Steelhead appliance.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp35709800"></a>3.6. Traceroute</h2></div></div></div><p>Traceroute is a basic command in the networking world to determine
the path the traffic takes to a remote host. It sends a number of
UDP packets with different source ports and with increasing TTL value.
The source address of the returned
<span class="italics">ICMP TTL Exceeded</span>
replies will show the IP addresses of the path.
</p><p>Besides the
<span class="italics">traceroute</span>
command, used for the IPv4 transport layer, there is also the
<span class="italics">traceroute6</span>
command, used for the IPv6 transport layer. The options used for
the IPv4 version can also be used for the IPv6 version unless noted
differently.
</p><p>With the returned ICMP packets, the IP addresses on it are often
the IP address of the outgoing interface on that router which might
not be the IP address of the incoming interface of that router. So
to confirm the path, the traceroute program should to be run on
both the client and the server.
</p><div class="figure"><a name="idp35727336"></a><p class="title"><b>Figure 3.30. WAN router receives packet via a different path than it send it</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/03-traceroute-asym.png" align="middle" width="100%" alt="WAN router receives packet via a different path than it send it"></td></tr></table></div></div></div><br class="figure-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35730856"></a>3.6.1. Traceroute options</h3></div></div></div><p>The following options are available for the traceroute command:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The option
<code class="computeroutput">-n</code>
  prevents name-resolution of the IP addresses displayed.
</p></li><li class="listitem"><p>The option
<code class="computeroutput">-s &lt;IP address&gt;</code>
  changes the source IPv4 or IPv6 address to use for and thus the outgoing
  interface. 
</p></li><li class="listitem"><p>The option
<code class="computeroutput">-S #</code>
  changes the size of the payload of the outgoing UDP packet.
</p></li><li class="listitem"><p>The option
<code class="computeroutput">--mtu</code>
  can be used to identify the maximum MTU size towards the remote
  host.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35810664"></a>3.6.2. Traceroute examples</h3></div></div></div><p>The traceroute command uses by default the IP address of the primary
interface:
</p><div class="figure"><a name="idp35812072"></a><p class="title"><b>Figure 3.31. The command to traceroute to a remote host via the primary interface</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 38 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 172.16.2.2  90.657 ms  90.245 ms  90.342 ms 
 4 172.16.3.2  130.657 ms  130.245 ms  130.342 ms 
 5 192.168.1.1  130.857 ms  130.545 ms  130.642 ms 
</pre></div></div><br class="figure-break"><p>The
<code class="computeroutput">-s</code>
option can be used to specify the IP address of an in-path interface:
</p><div class="figure"><a name="idp35824808"></a><p class="title"><b>Figure 3.32. Traceroute to a remote host via an in-path interface</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n -s 10.0.1.5 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1) from 10.0.1.5, 30 hops max, 38 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 172.16.2.2  90.657 ms  90.245 ms  90.342 ms 
 4 172.16.3.2  130.657 ms  130.245 ms  130.342 ms 
 5 192.168.1.1  130.857 ms  130.545 ms  130.642 ms 
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35826344"></a>3.6.3. MTU Path Detection with traceroute</h3></div></div></div><p>The ping command can be used to determine that there are MTU size
issues in a network, the traceroute command can be used to determine
where it is happening.
</p><p>If the network is properly informing with
<span class="italics">ICMP Fragmentation Needed</span>
packets, the
<code class="computeroutput">--mtu</code>
option can be used to see it:
</p><div class="figure"><a name="idp35829352"></a><p class="title"><b>Figure 3.33. Determining the MTU size with the --mtu option</b></p><div class="figure-contents"><pre class="screen">CSH # traceroute -n --mtu 192.168.1.1
traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 65000 byte packets
 1 10.0.1.9  0.657 ms F=1422  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 172.16.2.2  90.657 ms  90.245 ms  90.342 ms 
 4 172.16.3.2  130.657 ms  130.245 ms  130.342 ms 
 5 192.168.1.1  130.857 ms  130.545 ms  130.642 ms 
</pre></div></div><br class="figure-break"><p>The detected maximum MTU size here is 1422 bytes.
</p><p>If the network is not sending the
<span class="italics">ICMP Fragmentation Needed</span>
packets, the same method by increasing and decreasing the packet
size as used with the
<span class="italics">ping</span>
command should be used.
</p><p>First the path between towards the remote host needs to be determined:
</p><div class="figure"><a name="idp35855400"></a><p class="title"><b>Figure 3.34. Successful traceroute between two hosts</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 38 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 172.16.2.2  90.657 ms  90.245 ms  90.342 ms 
 4 172.16.3.2  130.657 ms  130.245 ms  130.342 ms 
 5 192.168.1.1  130.857 ms  130.545 ms  130.642 ms 
</pre></div></div><br class="figure-break"><p>Now the same trace but with a packet size larger than the MTU size
of the link:
</p><div class="figure"><a name="idp35861544"></a><p class="title"><b>Figure 3.35. Failed traceroute due to MTU size issues</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n -S 1480 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 1480 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 * * *
 4 * * *
 5 * * *
</pre></div></div><br class="figure-break"><p>The router with the IP address of 172.16.1.2 did forward the packet,
but the router with the IP address of 172.16.2.2 did not return any
answers. Use a smaller option for the size to determine the right
maximum MTU size.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35863976"></a>3.6.4. Determine failure scenarios</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35864232"></a>3.6.4.1. The trace doesn't show data for certain hops.</h4></div></div></div><p>In this example the traceroute command returned no data for hop 3:
</p><div class="figure"><a name="idp35887528"></a><p class="title"><b>Figure 3.36. Missing reply for hop three.</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 38 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 * * *
 4 172.16.3.2  130.657 ms  130.245 ms  130.342 ms 
 5 192.168.1.1  130.857 ms  130.545 ms  130.642 ms 
</pre></div></div><br class="figure-break"><p>This could happen when for example:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A firewall doesn't allow ICMP TTL Expired messages from the IP
  addresses on hop 3.
</p></li><li class="listitem"><p>The gateway in hop 3 is instructed not to send out ICMP TTL Expired
  messages.
</p></li></ul></div><p>As the end-to-end communication works, the missing hop may be ignored.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35897256"></a>3.6.4.2. The trace doesn't show data after a certain hop.</h4></div></div></div><p>The traceroute command could have returned only *'s after a certain
hop:
</p><div class="figure"><a name="idp35898664"></a><p class="title"><b>Figure 3.37. Missing reply for hop three and following.</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 38 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 * * *
 4 * * *
 5 * * *
</pre></div></div><br class="figure-break"><p>This can happen when:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The network after hop 2 doesn't know the way back to the source
  IP subnet of the trace of 10.0.1.0/24.
</p></li><li class="listitem"><p>The network after hop 2 doesn't know the way to 192.168.1.1
  but doesn't send back ICMP Network Unreachable. If it did, the
  output would have ended with:
</p><div class="figure"><a name="idp35903528"></a><p class="title"><b>Figure 3.38. Network Unreachable response</b></p><div class="figure-contents"><pre class="screen">   3  192.168.1.1  3000.123 ms !N  3000.231 ms !N  3000.349 ms !N
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>A firewall between hop 2 and 3 is blocking the traffic.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35936872"></a>3.6.4.3. The trace doesn't return anything for the last hop.</h4></div></div></div><p>The traceroute command could have returned *'s for the latest hop:
</p><div class="figure"><a name="idp35949864"></a><p class="title"><b>Figure 3.39. Missing reply for the latest hop.</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 38 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 172.16.2.2  90.657 ms  90.245 ms  90.342 ms 
 4 172.16.3.2  130.657 ms  130.245 ms  130.342 ms
 5 * * *
</pre></div></div><br class="figure-break"><p>This could happen when for example:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>When the firewall on the remote host is configured not to send
  ICMP Port Unreachable.
</p></li><li class="listitem"><p>When the destination IP address is not configured on that
  IP subnet and the final router did not send back ICMP Host
  Unreachable. If it did, the output would have ended with:
</p><div class="figure"><a name="idp35957416"></a><p class="title"><b>Figure 3.40. Host Unreachable response</b></p><div class="figure-contents"><pre class="screen">   5  192.168.1.1  3000.123 ms  !H 3000.231 ms !H  3000.349 ms !H
</pre></div></div><p><br class="figure-break">
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp35958696"></a>3.6.4.4. The trace did contain multiple IP addresses for a hop</h4></div></div></div><p>This happens when a hop is doing load balancing over multiple links.
In that case the outgoing interface is pretty much random.
</p><div class="figure"><a name="idp35960424"></a><p class="title"><b>Figure 3.41. Hop 4 has multiple outgoing interfaces</b></p><div class="figure-contents"><pre class="screen">SH # traceroute -n 192.168.1.1
Traceroute to 192.168.1.1 (192.168.1.1), 30 hops max, 38 byte packets
 1 10.0.1.9  0.657 ms  0.245 ms  0.342 ms 
 2 172.16.1.2  30.657 ms  30.245 ms  30.342 ms 
 3 172.16.2.2  90.657 ms  90.245 ms  90.342 ms 
 4 172.16.3.2  130.657 ms
   172.16.3.10  130.245 ms
   172.16.3.2  130.342 ms 
 5 192.168.1.1  130.857 ms  130.545 ms  130.642 ms 
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools_telnet"></a>3.7. Telnet</h2></div></div></div><p>Telnet is a basic command in the networking world to setup a TCP
session to a service on a remote host. It completes the TCP handshake
(SYN, SYN/ACK, ACK) so it can be used to emulate the setup of an
TCP session expected to be optimized.
</p><p>Once telnet has successfully setup its TCP session, the only way to
get out of it is to either let the server terminate the TCP session
(protocol timeout, protocol error, issuing the command to terminate
the TCP session) or to press the
<code class="computeroutput">control-]</code>
and to type
<code class="computeroutput">quit</code>
command in the
<code class="computeroutput">telnet&gt;</code>
prompt.
</p><p>Using the telnet client available under Microsoft Windows, the
screen will be cleared when the TCP session is setup.
</p><p>With the introduction of Microsoft Windows 7, the telnet client is
not installed by default anymore. You can install it via Control
Panel -&gt; Programs and Features -&gt; Enable Features and install the
Telnet Client from there.
</p><p>The reason the command-line telnet application should be used and
not an integrated telnet client like in PuTTY or in SecureCRT is
that they are very time-wasting to setup and hide information from
you. For example you will have to enter the connection details in
a dialog box, you will get dialog box on the screen which shows that
a failure happened and you will not see that a TCP session has setup
successfully until you get text send back to you. The telnet
application on the command-line has an easy way to enter the session
details, it will be clear when the TCP session has been setup, has
an easy way to terminate the session and is clear when the TCP
session has been terminated.
</p><p>The telnet command available on the Steelhead appliance supports
both IPv4 and IPv6 destinations, but it is not possible to explicitly
choose for an IPv4 or IPv6 address when using a hostname to connect
to.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35967848"></a>3.7.1. Telnet options</h3></div></div></div><p>The following options are available for the telnet command:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The option
<code class="computeroutput">-b &lt;IP address&gt;</code>
  binds the source IPv4 or IPv6 address of TCP session to the
  destination IP address.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp35985256"></a>3.7.2. Telnet examples</h3></div></div></div><p>The telnet command uses by default the IP address of the primary
interface:
</p><div class="figure"><a name="idp35986152"></a><p class="title"><b>Figure 3.42. Successful TCP session setup via the primary interface</b></p><div class="figure-contents"><pre class="screen">SH # telnet 192.168.1.1 139
Trying 192.168.1.1...
Connected to 192.168.1.1.
Escape character is '^]'
</pre></div></div><br class="figure-break"><p>In this case the TCP session is setup between the hosts 10.0.1.5
and 192.168.1.1 on destination TCP port 139.
</p><p>The
<code class="computeroutput">-b</code>
option can be used to specify the IP address of the in-path interface.
</p><div class="figure"><a name="idp35998952"></a><p class="title"><b>Figure 3.43. Successful TCP session setup via the in-path interface</b></p><div class="figure-contents"><pre class="screen">SH # telnet -b 10.0.1.6 192.168.1.1 139
Trying 192.168.1.1...
Connected to 192.168.1.1.
Escape character is '^]'
</pre></div></div><br class="figure-break"><p>In this case the TCP session is setup between the hosts 10.0.1.6
and 192.168.1.1.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36006824"></a>3.7.3. Telnet failure scenarios</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36007656"></a>3.7.3.1. No route to host</h4></div></div></div><p>A
<span class="italics">No route to host</span>
error is shown when the remote host does not exist and the router
on that subnet sends back an ICMP Host Unreachable message or when
the a router in the network doesn't know where to forward the IP
packet to and sends an ICMP Network Unreachable message to the
client.
</p><div class="figure"><a name="idp36018408"></a><p class="title"><b>Figure 3.44. Telnet attempt to a host which does not exist</b></p><div class="figure-contents"><pre class="screen">SH # telnet 192.168.1.1 139
Trying 192.168.1.1...
telnet: connect to address 192.168.1.1: No route to host
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36036520"></a>3.7.3.2. Connection timed out</h4></div></div></div><p>This happens when no TCP SYN/ACK is received on the three TCP SYN
packets send out by the client.
</p><div class="figure"><a name="idp36038120"></a><p class="title"><b>Figure 3.45. Telnet attempt to a host which does not exist</b></p><div class="figure-contents"><pre class="screen">SH # telnet 192.168.1.1 139
Trying 192.168.1.1...
telnet: connect to address 192.168.1.1: Connection timed out
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36067624"></a>3.7.3.3. Connection refused</h4></div></div></div><p>This happens when the TCP SYN packet is delivered to the remote
host but when there is no service listening on that TCP port.
</p><div class="figure"><a name="idp36080232"></a><p class="title"><b>Figure 3.46. Telnet attempt to a host with no service listening on port 139</b></p><div class="figure-contents"><pre class="screen">SH # telnet 192.168.1.1 139
Trying 192.168.1.1...
telnet: connect to address 192.168.1.1: Connection refused
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36087912"></a>3.8. Tproxytrace</h2></div></div></div><p>Tproxytrace is a RiOS specific command to probe for Steelhead
appliances in the path to a remote server. It sends a SYN+ packet,
and any Steelhead appliance in the path that answers the auto-discovery
probe will have their information displayed.
</p><p>The tproxytrace command does not support IPv6 destinations.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36100904"></a>3.8.1. Tproxytrace options</h3></div></div></div><p>The following options are available for the tproxytrace command:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The option
<code class="computeroutput">-i &lt;interface-name&gt;</code>
  specifies the interface which outgoing packets will use and thus
  which IP address will be used for them.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36105320"></a>3.8.2. Tproxytrace examples</h3></div></div></div><p>The tproxytrace command does not use the IP address of the primary
interface by default. Use the
<code class="computeroutput">-i</code>
option to specify the outgoing interface:
</p><div class="figure"><a name="idp36119336"></a><p class="title"><b>Figure 3.47. Tproxytrace to a host via the primary interface</b></p><div class="figure-contents"><pre class="screen">SH # tproxytrace -i primary 192.168.1.1:139
Probe from 10.0.1.5 (primary) to 192.168.1.1:139
depth 1 proxy 10.0.1.6:7800
depth 2 proxy 192.168.1.1:7800
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp36120232"></a><p class="title"><b>Figure 3.48. Tproxytrace to a host via the in-path interface</b></p><div class="figure-contents"><pre class="screen">SH # tproxytrace -i inpath0_0 192.168.1.1:139
Probe from 10.0.1.6 (inpath0_0) to 192.168.1.1:139
depth 1 proxy 192.168.1.1:7800
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36139688"></a>3.8.3. Tproxytrace failure scenarios</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36140712"></a>3.8.3.1. The tproxytrace output doesn't return expected Steelhead appliances</h4></div></div></div><p>There could be various reasons, including:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The path the SYN+ takes doesn't have a Steelhead appliance in it.
</p></li><li class="listitem"><p>The Steelhead appliances in the path are configured to not peer
  with the source specified.
</p></li><li class="listitem"><p>The Steelhead appliances in the path cannot send the answer back
  to the source of the SYN+.
</p></li><li class="listitem"><p>The auto-discovery TCP option number used in the SYN+ is different
  than the one used on the Steelhead appliances in the network.
</p></li><li class="listitem"><p>The expected Steelhead appliances in the network are in admission
  control.
</p></li></ul></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36152488"></a>3.9. Nettest</h2></div></div></div><p>The nettest command can be used to perform some of the tests described
earlier automatic.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36154280"></a>3.9.1. Peer reachability</h3></div></div></div><p>The Peer Reachability test tries to set up a TCP session to port 7801
to a remote Steelhead appliance. It attempts to set them up from all
configured IP addresses:
</p><p>This test only supports IPv4 addresses.
</p><div class="figure"><a name="idp36163432"></a><p class="title"><b>Figure 3.49. Output of a peer reachability test</b></p><div class="figure-contents"><pre class="screen">CSH (config) # nettest run peer-reach addr 192.168.1.6
Peer Reachability Test        Last Run: 2013/11/25 10:54:01
Passed

Address            Interface          Result
==================================================================
192.168.1.6        primary            Passed
192.168.1.6        aux                Passed
192.168.1.6        inpath0_0          Passed
</pre></div></div><br class="figure-break"><p>The captures on the various interfaces look like this:
</p><div class="figure"><a name="idp36165992"></a><p class="title"><b>Figure 3.50. Capture of a peer reachability test</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni primary host 10.0.1.5
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on primary, link-type EN10MB (Ethernet), capture size 300 bytes
11:12:09.331690 IP 10.0.1.5.65535 &gt; 192.168.1.6.7801: Flags [S], seq 169835245, win 5840,  \
    options [rvbd-probe unkn-ver-type:1/3 31010a0001050005,nop,eol], length 0
11:12:09.634781 IP 192.168.1.6.7801 &gt; 10.0.1.5.65535: Flags [S.], seq 20020520, ack 169835 \
    246, win 5840, options [rvbd-probe AD CSH:10.0.1.5 SSH:192.168.1.6:7800 11110a000105c0 \
    a801061e78,rvbd-probe EAD 0e3c,nop,eol], length 0
11:12:09.634888 IP 10.0.1.5.65535 &gt; 192.168.1.6.7801: Flags [R], seq 169835246, win 0, len \
    gth 0
11:12:09.635405 IP 10.0.1.5.65535 &gt; 192.168.1.6.7801: Flags [S], seq 169835245, win 5840,  \
    options [rvbd-probe unkn-ver-type:1/3 31020a0001050005,nop,eol], length 0
11:12:09.936657 IP 192.168.1.6.7801 &gt; 10.0.1.5.65535: Flags [S.], seq 1081397572, ack 1698 \
    35246, win 5840, options [mss 1460], length 0
11:12:09.936697 IP 10.0.1.5.65535 &gt; 192.168.1.6.7801: Flags [R], seq 169835246, win 0, len \
    gth 0
</pre></div></div><br class="figure-break"><p>As can be seen, the client-side Steelhead appliance sends a SYN+,
the server-side Steelhead appliance replies with a SYN/ACK+. Finally
the client-side Steelhead appliance sends a TCP RST and the test is
tried again.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36168488"></a>3.9.2. Net gateway test</h3></div></div></div><p>The Net Gateway test sends three pings the IP addresses of the local
network gateways. It takes the gateways of the base interfaces routing
table and the in-path interfaces routing table and tries to ping them.
</p><p>In the examples below an extra destination was added to the two routing
tables before the test was ran:
</p><div class="figure"><a name="idp36170856"></a><p class="title"><b>Figure 3.51. Output of a net gateway test</b></p><div class="figure-contents"><pre class="screen">CSH (config) # show ip route
Destination       Mask              Gateway           Interface
1.2.3.4           255.255.255.255   10.0.1.67         primary
10.0.1.0          255.255.255.0     0.0.0.0           primary
default           0.0.0.0           10.0.1.9          primary

CSH (config) # show ip in-path route inpath0_0
Destination       Mask              Gateway
1.2.3.4           255.255.255.255   10.0.1.66
10.0.1.0          255.255.255.0     0.0.0.0
default           0.0.0.0           10.0.1.9

CSH (config) # nettest run net-gateway
Gateway Test                  Last Run: 2013/11/25 11:22:01
Passed

Interface          Address            Packet Loss        Result
==================================================================
Default            10.0.1.9           0%                 Passed
inpath0_0          10.0.1.66          100%               Failed
inpath0_0          10.0.1.9           0%                 Passed
Static             10.0.1.67          100%               Failed

CSH (config) # nettest run net-gateway ipv6 
Gateway Test                  Last Run: 2013/06/03 17:18:35
Passed

Interface          Address            Packet Loss        Result
==================================================================
Default            2600:809:200:4ff:20e:b6ff:fe01:6070
                                      0%                 Passed
</pre></div></div><br class="figure-break"><p>As expected, the ones to 10.0.1.66 and 10.0.1.67 didn't get answered.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36172328"></a>3.9.3. Duplex test</h3></div></div></div><p>The Duplex test works by sending a large amount of ICMP ping tests over
an interface. In case of a speed or duplex mismatch, there will be
packet loss on it.
</p><div class="figure"><a name="idp36173160"></a><p class="title"><b>Figure 3.52. Output of a duplex test</b></p><div class="figure-contents"><pre class="screen">CSH (config) # nettest run duplex primary target 10.0.1.9
Duplex Test                   Last Run: 2013/11/25 11:42:16
Passed

Interface          Number of Errors   Result
==================================================================
primary            0                  Passed
</pre></div></div><br class="figure-break"><p>CSH (config) # nettest run duplex primary ipv6-target fd57:1083::3
Duplex Test                   Last Run: 2013/11/25 11:42:16
Passed
</p><p>Interface          Number of Errors   Result
==================================================================
primary            0                  Passed
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36175272"></a>3.9.4. IP Port reachability test</h3></div></div></div><p>The IP Port Reachability test sets up a TCP session from one of the base
interfaces to the specified host.
</p><div class="figure"><a name="idp36184936"></a><p class="title"><b>Figure 3.53. Output of the IP Port reachability test</b></p><div class="figure-contents"><pre class="screen">CSH (config) # nettest run ip-port-reach source primary addr 192.168.1.1 port 22
IP/Port Reachability Test     Last Run: 2013/11/25 11:54:17
Passed

Interface          Address            Protocol           Result
==================================================================
aux                192.168.1.1:22     Netcat             Passed

CSH (config) # nettest run ip-port-reach source primary ipv6-addr fd57:1083::3 port 22
IP/Port Reachability Test     Last Run: 2013/11/25 11:54:17
Passed

Interface          Address            Protocol           Result
==================================================================
aux                [fd57:1083::3]:22  Netcat             Passed
</pre></div></div><br class="figure-break"><p>On the wire it looks like a normal TCP session, prefixed by some DNS resolution:
</p><div class="figure"><a name="idp36186600"></a><p class="title"><b>Figure 3.54. Capture of the IP Port reachability test</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni primary host 10.0.1.5
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on primary, link-type EN10MB (Ethernet), capture size 300 bytes
11:57:42.526526 IP 10.0.1.5.32825 &gt; 192.168.1.1.53: 18418+ PTR? 5.1.0.10.in-addr.arpa. (39 \
    )
11:57:42.827737 IP 192.168.1.1.53 &gt; 10.0.1.5.32825: 18418 NXDomain* 0/1/0 (91)
11:57:42.828122 IP 10.0.1.5.32825 &gt; 192.168.1.1.53: 11624+ PTR? 1.1.168.192.in-addr.arpa.  \
    (42)
11:57:43.127581 IP 192.168.1.1.53 &gt; 10.0.1.5.32825: 11624 NXDomain* 0/1/0 (94)
11:57:43.128040 IP 10.0.1.5.33329 &gt; 192.168.1.1.80: Flags [S], seq 3966492797, win 5840, o \
    ptions [mss 1460,sackOK,TS val 5332034 ecr 0,nop,wscale 2], length 0
11:57:43.427441 IP 192.168.1.1.80 &gt; 10.0.1.5.33329: Flags [S.], seq 3407753711, ack 396649 \
    2798, win 65535, options [mss 1460,nop,wscale 6,sackOK,TS val 3117926755 ecr 5332034], \
     length 0
11:57:43.427490 IP 10.0.1.5.33329 &gt; 192.168.1.1.80: Flags [.], seq 1, ack 1, win 1460, opt \
    ions [nop,nop,TS val 5332333 ecr 3117926755], length 0
11:57:43.427799 IP 10.0.1.5.33329 &gt; 192.168.1.1.80: Flags [F.], seq 1, ack 1, win 1460, op \
    tions [nop,nop,TS val 5332334 ecr 3117926755], length 0
11:57:43.729324 IP 192.168.1.1.80 &gt; 10.0.1.5.33329: Flags [.], seq 1, ack 2, win 1040, opt \
    ions [nop,nop,TS val 3117927055 ecr 5332334], length 0
11:57:43.731237 IP 192.168.1.1.80 &gt; 10.0.1.5.33329: Flags [F.], seq 1, ack 2, win 1040, op \
    tions [nop,nop,TS val 3117927055 ecr 5332334], length 0
11:57:43.731262 IP 10.0.1.5.33329 &gt; 192.168.1.1.80: Flags [.], seq 2, ack 2, win 1460, opt \
    ions [nop,nop,TS val 5332637 ecr 3117927055], length 0
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36188264"></a>3.10. SSL connect</h2></div></div></div><p>Tunneling a protocol over SSL is a simple feast these days. However,
troubleshooting it is a difficult task: An extra layer is added and
instead of a plain text protocol you are suddenly stuck with a
binary protocol.
</p><p>Since RiOS 8.0, the command
<code class="computeroutput">ssl-connect</code>
provides a method to setup an SSL encrypted TCP session towards a
server. It uses the same certificate store as the Steelhead appliance,
so it can be used to check if all intermediate certificates are
available and valid.
</p><p>The ssl-connect command supports IPv4 and IPv6 but doesn't recognize
the IPv6 address as such, a hostname which resolves into an IPv6
address is required.
</p><div class="figure"><a name="idp36215592"></a><p class="title"><b>Figure 3.55. Usage of the ssl-connect command</b></p><div class="figure-contents"><pre class="screen">CSH # ssl-connect 192.168.1.1:443
CONNECTED(00000003)
depth=2 C = US, O = "The Go Daddy Group, Inc.", OU = Go Daddy Class 2 Certification Author \
    ity
verify return:1
depth=1 C = US, ST = Arizona, L = Scottsdale, O = "GoDaddy.com, Inc.", OU = http://certifi \
    cates.godaddy.com/repository, CN = Go Daddy Secure Certification Authority, serialNumb \
    er = 07969287
verify return:1
depth=0 O = *.mavetju.org, OU = Domain Control Validated, CN = *.mavetju.org
verify return:1
---
Certificate chain
 0 s:/O=*.mavetju.org/OU=Domain Control Validated/CN=*.mavetju.org
   i:/C=US/ST=Arizona/L=Scottsdale/O=GoDaddy.com, Inc./OU=http://certificates.godaddy.com/ \
    repository/CN=Go Daddy Secure Certification Authority/serialNumber=07969287
 1 s:/C=US/ST=Arizona/L=Scottsdale/O=GoDaddy.com, Inc./OU=http://certificates.godaddy.com/ \
    repository/CN=Go Daddy Secure Certification Authority/serialNumber=07969287
   i:/C=US/O=The Go Daddy Group, Inc./OU=Go Daddy Class 2 Certification Authority
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIFUzCCBDugAwIBAgIHKyoFsgHhjjANBgkqhkiG9w0BAQUFADCByjELMAkGA1UE
BhMCVVMxEDAOBgNVBAgTB0FyaXpvbmExEzARBgNVBAcTClNjb3R0c2RhbGUxGjAY
[...]
8gVExh5WcDWWTRAB3IgV+puWx6rFblZ2WTjHKqfvvpfolaCy8+xMVwQI7BJyA6vF
SgMsfQ42zKMwIiHEHM8jdI5AMVM5VCQ=
-----END CERTIFICATE-----
subject=/O=*.mavetju.org/OU=Domain Control Validated/CN=*.mavetju.org
issuer=/C=US/ST=Arizona/L=Scottsdale/O=GoDaddy.com, Inc./OU=http://certificates.godaddy.co \
    m/repository/CN=Go Daddy Secure Certification Authority/serialNumber=07969287
---
No client certificate CA names sent
---
SSL handshake has read 2782 bytes and written 439 bytes
---
New, TLSv1/SSLv3, Cipher is AES256-SHA
Server public key is 2048 bit
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1
    Cipher    : AES256-SHA
    Session-ID: 1809B7245E7E42B9F2CAB82B54019B3E20F3923C16A2927A4D3996FAC4528CB5
    Session-ID-ctx: 
    Master-Key: B3DCF9008DBB76B7F0151B723DFB8AFF530310720985BC6739E9E60E7EE64EB8F81B88368A \
    9EA8131D4DE3FBEB77BEF5
    Key-Arg   : None
    Krb5 Principal: None
    PSK identity: None
    PSK identity hint: None
    Start Time: 1359015123
    Timeout   : 300 (sec)
    Verify return code: 0 (ok)
---
GET / HTTP/1.0
Host: www.mavetju.org

HTTP/1.1 200 OK
Date: Thu, 24 Jan 2013 08:12:29 GMT
Server: Apache/2.2.3 (FreeBSD)
Content-Length: 239
Keep-Alive: timeout=15, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=iso-8859-1
X-RBT-Optimized-By: CSH (RiOS 8.0.1) IK

&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"&gt;
&lt;html&gt;&lt;head&gt;
[...]
&lt;/body&gt;&lt;/html&gt;
closed
</pre></div></div><br class="figure-break"><p>The result code under 
<span class="italics">Verify return code</span>:
is how the ssl-client command interprets the certificates. This is
a list of possible result codes, obtained of the man page of the
OpenSSL verify(1) utility.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>0 / Ok:
The operation was successful.
</p></li><li class="listitem"><p>2 / Unable to get issuer certificate:
The issuer certificate of a looked up certificate could not be
found. This normally means the list of trusted certificates is not
complete.
</p></li><li class="listitem"><p>4 / Unable to decrypt certificate's signature:
The certificate signature could not be decrypted. This means that
the actual signature value could not be determined rather than it
not matching the expected value, this is only meaningful for RSA
keys.
</p></li><li class="listitem"><p>6 / Unable to decode issuer public key:
The public key in the certificate SubjectPublicKeyInfo could not
be read.
</p></li><li class="listitem"><p>7 / Certificate signature failure:
The signature of the certificate is invalid.
</p></li><li class="listitem"><p>9 / Certificate is not yet valid:
The certificate is not yet valid: the notBefore date is after the
current time.
</p></li><li class="listitem"><p>10 / Certificate has expired:
The certificate has expired: that is the notAfter date is before
the current time.
</p></li><li class="listitem"><p>13 / Format error in certificate's notBefore field:
The certificate notBefore field contains an invalid time.
</p></li><li class="listitem"><p>14 / Format error in certificate's notAfter field:
The certificate notAfter field contains an invalid time.
</p></li><li class="listitem"><p>17 / Out of memory:
An error occurred trying to allocate memory. This should never
happen.
</p></li><li class="listitem"><p>18 / Self signed certificate:
The passed certificate is self-signed and the same certificate
cannot be found in the list of trusted certificates.
</p></li><li class="listitem"><p>19 / Self signed certificate in certificate chain:
The certificate chain could be built up using the untrusted
certificates but the root could not be found locally.
</p></li><li class="listitem"><p>20 / Unable to get local issuer certificate:
The issuer certificate could not be found: this occurs if the issuer
certificate of an untrusted certificate cannot be found.
</p></li><li class="listitem"><p>21 / Unable to verify the first certificate:
No signatures could be verified because the chain contains only one
certificate and it is not self-signed.
</p></li><li class="listitem"><p>24 / Invalid CA certificate:
A CA certificate is invalid. Either it is not a CA or its extensions
are not consistent with the supplied purpose.
</p></li><li class="listitem"><p>25 / Path length constraint exceeded:
The basicConstraints pathlength parameter has been exceeded.
</p></li><li class="listitem"><p>26 / Unsupported certificate purpose:
The supplied certificate cannot be used for the specified purpose.
</p></li><li class="listitem"><p>27 / Certificate not trusted:
The root CA is not marked as trusted for the specified purpose.
</p></li><li class="listitem"><p>28 / Certificate rejected:
The root CA is marked to reject the specified purpose.
</p></li><li class="listitem"><p>29 / Subject issuer mismatch:
The current candidate issuer certificate was rejected because its
subject name did not match the issuer name of the current certificate.
</p></li><li class="listitem"><p>30 / Authority and subject key identifier mismatch:
The current candidate issuer certificate was rejected because its
subject key identifier was present and did not match the authority
key identifier current certificate.
</p></li><li class="listitem"><p>31 / Authority and issuer serial number mismatch:
The current candidate issuer certificate was rejected because its
issuer name and serial number was present and did not match the
authority key identifier of the current certificate.
</p></li><li class="listitem"><p>32 / Key usage does not include certificate signing:
The current candidate issuer certificate was rejected because its
keyUsage extension does not permit certificate signing.
</p></li><li class="listitem"><p>24 / Invalid CA certificate:
A CA certificate is invalid. Either it is not a CA or its extensions
are not consistent with the supplied purpose.
</p></li><li class="listitem"><p>25 / Path length constraint exceeded:
The basicConstraints pathlength parameter has been exceeded.
</p></li><li class="listitem"><p>26 / Unsupported certificate purpose:
The supplied certificate cannot be used for the specified purpose.
</p></li><li class="listitem"><p>27 / Certificate not trusted:
The root CA is not marked as trusted for the specified purpose.
</p></li><li class="listitem"><p>28 / Certificate rejected:
The root CA is marked to reject the specified purpose.
</p></li><li class="listitem"><p>29 / Subject issuer mismatch:
The current candidate issuer certificate was rejected because its
subject name did not match the issuer name of the current certificate.
</p></li><li class="listitem"><p>30 / Authority and subject key identifier mismatch:
The current candidate issuer certificate was rejected because its
subject key identifier was present and did not match the authority
key identifier current certificate.
</p></li><li class="listitem"><p>31 / Authority and issuer serial number mismatch:
The current candidate issuer certificate was rejected because its
issuer name and serial number was present and did not match the
authority key identifier of the current certificate.
</p></li><li class="listitem"><p>32 / Key usage does not include certificate signing:
The current candidate issuer certificate was rejected because its
keyUsage extension does not permit certificate signing.
</p></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="Installation_Related_Issues"></a>Chapter 4. Installation Related Issues</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp36378984">4.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp36416424">4.2. Installation steps for fail-to-wire scenarios</a></span></dt><dt><span class="sect1"><a href="#idp36448616">4.3. Fail-to-Wire</a></span></dt><dt><span class="sect1"><a href="#install_cables">4.4. Cables</a></span></dt><dt><span class="sect1"><a href="#idp36759848">4.5. Network Interface Card speed issues</a></span></dt><dt><span class="sect1"><a href="#idp36871592">4.6. IP Subnet configuration related issues</a></span></dt><dt><span class="sect1"><a href="#idp36990248">4.7. Wrong location</a></span></dt><dt><span class="sect1"><a href="#idp37075432">4.8. In-path support on interface not enabled</a></span></dt><dt><span class="sect1"><a href="#idp37083496">4.9. Port security</a></span></dt><dt><span class="sect1"><a href="#idp37124008">4.10. Link State Propagation (LSP)</a></span></dt><dt><span class="sect1"><a href="#idp37200936">4.11. VPN Concentrators</a></span></dt><dt><span class="sect1"><a href="#idp37211432">4.12. Licenses</a></span></dt><dt><span class="sect1"><a href="#idp37515752">4.13. LAN and WAN cable switched</a></span></dt><dt><span class="sect1"><a href="#idp37531560">4.14. After an RMA</a></span></dt><dt><span class="sect1"><a href="#idp37550120">4.15. Best cabling for remote management</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36378984"></a>4.1. Index</h2></div></div></div><p>This chapter describes possible issues encountered during the installation
of a Steelhead appliance.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Installation of a Steelhead appliance.
</p></li><li class="listitem"><p>The Fail-to-Wire feature.
</p></li><li class="listitem"><p>Cabling.
</p></li><li class="listitem"><p>Network Interface Card speed issues.
</p></li><li class="listitem"><p>IP Subnet configuration related issues.
</p></li><li class="listitem"><p>Wrong location in the network.
</p></li><li class="listitem"><p>In-path support not enabled on an interface.
</p></li><li class="listitem"><p>Link State Propagation (LSP).
</p></li><li class="listitem"><p>VPN concentrators.
</p></li><li class="listitem"><p>License related issues.
</p></li><li class="listitem"><p>LAN and WAN cable switched.
</p></li><li class="listitem"><p>After an RMA.
</p></li><li class="listitem"><p>Cabling for remote management
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36416424"></a>4.2. Installation steps for fail-to-wire scenarios</h2></div></div></div><p>The bypass cards have two failure modes: Fail-to-wire and fail-to-block.
</p><p>During the physical installation of a Steelhead appliance in a
fail-to-wire scenario the following scenarios should be checked:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>When the Steelhead appliance is turned off, the LAN switch and
  WAN router should negotiate an Ethernet link and all traffic
  should flow through, unless fail-to-block has been configured.
</p></li><li class="listitem"><p>When the Steelhead appliance is turned on, configured and the
  optimization service is running, the LAN switch and WAN router
  should negotiate an Ethernet link towards the Steelhead LAN and
  WAN interfaces and all traffic should flow through.
</p></li><li class="listitem"><p>Now that the Steelhead appliance is working properly, check again
  that the fail-to-wire scenario works: Shutdown the Steelhead appliance
  with the command
<code class="computeroutput">reload halt</code>.
  The traffic should flow through.
</p></li></ul></div><p>Afterwards, every time a device on the WAN or on the LAN side of
the Steelhead appliance is replaced or when the interface configuration
of the Steelhead appliance or one of the connecting devices is
changed, this fail-to-wire implementation should be checked again.
</p><p>The following list is a good order to install new Steelhead appliances
in an in-path environment:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Without being connected to the network, turn on the Steelhead
  appliance and configure the IP addresses and routing details on
  the primary interface and in-path interfaces. In the in-path
  configuration, disable the Link State Propagation feature. Enable
  in-path support and enable optimization on the in-path interfaces.
</p><div class="figure"><a name="idp36421928"></a><p class="title"><b>Figure 4.1. Disable LSP during installation of a new Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">SH (config) # interface inpath0_0 ip address 10.0.1.6 /24
SH (config) # ip in-path-gateway inpath0_0 "10.0.1.9"
SH (config) # in-path enable
SH (config) # in-path interface inpath0_0 enable
SH (config) # no in-path lsp enable
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>Save the configuration with the command
<code class="computeroutput">write memory</code>
  and turn off the Steelhead appliance with the command
<code class="computeroutput">reload halt</code>.
</p></li><li class="listitem"><p>Connect the cables to the LAN and WAN interfaces and confirm that
  the WAN router and LAN switch have an Ethernet link established.
</p></li><li class="listitem"><p>Turn on the Steelhead appliance and wait for the optimization
  service to be initialized and started.
</p></li><li class="listitem"><p>Confirm that the LAN and WAN interfaces on the Steelhead appliance
  have an Ethernet link established with the commands
<code class="computeroutput">show interface lan0_0 brief</code>
  and
<code class="computeroutput">show interface wan0_0 brief</code>.
</p></li><li class="listitem"><p>In the in-path configuration, enable the Link State Propagation
  feature with the configuration command
<code class="computeroutput">in-path lsp enable</code>
  and save the configuration with the command
<code class="computeroutput">write memory</code>.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36448616"></a>4.3. Fail-to-Wire</h2></div></div></div><p>After installing a Steelhead appliance, the in-path interfaces can
be in one of the following two states:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>In a non-operational state, when the Steelhead appliance is turned
  off or when the in-path interface is not enabled.
</p><p>  The failure configuration of the in-path interface can then either
  be fail-to-wire or fail-to-block:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>In the fail-to-block configuration, where the by-pass card does
    not link the WAN and LAN interfaces together. Traffic from and
    to the LAN switch and WAN router is blocked.
</p><p>    In the output of
<code class="computeroutput">show interfaces inpath0_0 configured</code>
    the failure mode is
<span class="italics">Disconnect</span>.
</p></li><li class="listitem"><p>In the fail-to-wire configuration, where the by-pass card does
    link the WAN and LAN interfaces together. The LAN switch and
    the WAN router are then directly connected with each other and
    will be able to negotiate an Ethernet link.
</p><p>    In the output of
<code class="computeroutput">show interfaces inpath0_0 configured</code>
    the failure mode is
<span class="italics">Bypass</span>.
</p></li></ul></div></li><li class="listitem"><p>In an operational state, when the by-pass card has two Ethernet
  links are negotiated: One between the WAN interface and the WAN
  router and the LAN interface and the LAN switch. The by-pass card
  intercepts the packets from the LAN and WAN interface and let the
  network stack process them.
</p><p>  In the output of
<code class="computeroutput">show interfaces inpath0_0 brief</code>
  the traffic status will be
<span class="italics">Normal</span>.
</p></li></ul></div><div class="figure"><a name="idp36463400"></a><p class="title"><b>Figure 4.2. Inpath0_0 is operational and set to fail-to-wire</b></p><div class="figure-contents"><pre class="screen">SH # show interfaces inpath0_0 brief
Interface inpath0_0 state
   Up:                 yes
   Interface type:     ethernet
   IP address:         10.0.0.6
   Netmask:            255.255.255.0
   IPv6 link-local address: fe80::20e:b6ff:fe90:352e/64
   MTU:                1500
   HW address:         00:0E:B6:90:35:2E
   Traffic status:     Normal
   HW blockable:       yes
SH # show interfaces inpath0_0 configured 
Interface inpath0_0 configuration
   Enabled:            yes
   DHCP:               no
   Dynamic DNS DHCP:   no
   DHCPv6:             no
   Dynamic DNS DHCPv6: no
   IP address:         10.0.0.6
   Netmask:            255.255.255.0
   IPv6 address:
   MTU:                1500
   Failure mode:       Bypass
</pre></div></div><br class="figure-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install_cables"></a>4.4. Cables</h2></div></div></div><p>Connecting cables between Gigabit NICs is very simple: The
auto-negotiation feature between two NICs takes care about the crossover
cable versus straight through cable detection and this section can
be ignored.
</p><p>Connecting cables toward Fast Ethernet NICs is pretty tricky:
Everything towards a switch needs to be a straight through cable,
everything else needs to be a crossover cable.
</p><p>When a by-pass card gets turned off or disabled and the failure
mode is fail-to-wire, it will act as a crossover cable.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36469544"></a>4.4.1. Cabling for different scenarios</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36470632"></a>4.4.1.1. Single Steelhead appliance located between switch and router</h4></div></div></div><p>The WAN router is connected via a crossover cable, the LAN switch is
connected via a straight through cable.
</p><p>During fail-to-wire a straight through cable is required.
</p><div class="table"><a name="idp36473064"></a><p class="title"><b>Table 4.1. Cabling for placement of Steelhead appliance between switch and router</b></p><div class="table-contents"><table summary="Cabling for placement of Steelhead appliance between switch and router" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Installation</td><td>Fail to wire</td></tr><tr><td>WAN router to WAN interface</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>LAN switch to LAN interface</td><td>straight through</td><td class="auto-generated"> </td></tr><tr><td>WAN router to LAN switch</td><td> </td><td>C + C + S -&gt; straight through</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36479528"></a>4.4.1.2. Single Steelhead appliance located between two routers</h4></div></div></div><p>The WAN router and the LAN router are connected via crossover cables
to the Steelhead appliance.
</p><p>During fail-to-wire a crossover cable is required.
</p><div class="table"><a name="idp36523560"></a><p class="title"><b>Table 4.2. Cabling for placement of Steelhead appliance between two routers</b></p><div class="table-contents"><table summary="Cabling for placement of Steelhead appliance between two routers" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Installation</td><td>Fail to wire</td></tr><tr><td>WAN router to WAN interface</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>LAN router to LAN interface</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>WAN router to LAN router</td><td> </td><td>C + C + C -&gt; crossover cable</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36529832"></a>4.4.1.3. Serial Steelhead cluster located between switch and router</h4></div></div></div><p>The WAN router is connected via a crossover cable, the two Steelhead
appliances are connected via a crossover cable and the LAN switch
is connected via a straight through cable.
</p><p>During fail-to-wire a crossover cable is required for the Steelhead
appliance to the WAN router, a straight through cable is required
between the two Steelhead appliances and the LAN switch and a
straight through cable is required between the WAN router and the
LAN switch.
</p><div class="table"><a name="idp36602344"></a><p class="title"><b>Table 4.3. Cabling for placement of two Steelhead appliances between switch and router</b></p><div class="table-contents"><table summary="Cabling for placement of two Steelhead appliances between switch and router" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Installation</td><td>Fail to wire</td></tr><tr><td>WAN router to SH1 WAN interface</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>SH1 LAN interface to SH2 WAN interface</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>SH2 LAN interface to LAN switch</td><td>straight through</td><td class="auto-generated"> </td></tr><tr><td>WAN router to SH2 WAN interface</td><td> </td><td>C + C + C -&gt; crossover</td></tr><tr><td>SH1 LAN interface to LAN switch</td><td> </td><td>C + C + S -&gt; straight through</td></tr><tr><td>WAN router to LAN switch</td><td> </td><td>C + C + C + C + S -&gt; straight through</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36635048"></a>4.4.1.4. Serial Steelhead cluster located between two routers</h4></div></div></div><p>The WAN router and the LAN router are connected via crossover cables
to the Steelhead-appliances, the two Steelhead appliances are
connected via a crossover cable with each other.
</p><p>During fail-to-wire crossover cables are required everywhere.
</p><div class="table"><a name="idp36642856"></a><p class="title"><b>Table 4.4. Cabling for placement of two Steelhead appliances between two routers</b></p><div class="table-contents"><table summary="Cabling for placement of two Steelhead appliances between two routers" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td> </td><td>Installation</td><td>Fail to wire</td></tr><tr><td>WAN router to SH1 WAN interface</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>SH1 LAN interface to SH2 WAN interface</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>SH2 LAN interface to LAN switch</td><td>crossover</td><td class="auto-generated"> </td></tr><tr><td>WAN router to SH2 WAN interface</td><td> </td><td>C + C + C -&gt; crossover</td></tr><tr><td>SH1 LAN interface to LAN switch</td><td> </td><td>C + C + C -&gt; crossover</td></tr><tr><td>WAN router to LAN switch</td><td> </td><td>C + C + C + C + C -&gt; crossover</td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36666408"></a>4.4.2. 100 Mbps fixed speed and MDI-X</h3></div></div></div><p>When the Ethernet link is configured to 100 Mbps, it can happen
that the Ethernet link doesn't come up because of a wrong cable
type. Forcing the NIC to be MDI-X can resolve this:
</p><div class="figure"><a name="idp36681832"></a><p class="title"><b>Figure 4.3. Configuring interface wan0_0 with MDI-x</b></p><div class="figure-contents"><pre class="screen">SH (config) # interface lan0_0 force-mdi-x enable
% Interface must be set to 100/full before enabling force mdi-x.
SH (config) # interface lan0_0 speed 100
SH (config) # interface lan0_0 duplex full
SH (config) # interface lan0_0 force-mdi-x enable
SH (config) # show interfaces force-mdi-x 
aux: false
inpath0_0: false
lan0_0: true
lo: false
primary: false
wan0_0: false
</pre></div></div><br class="figure-break"><p>Afterwards, a check for the fail-to-wire scenario should be done
when the Steelhead appliance is turned off.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36693288"></a>4.4.3. Fiber by-pass card</h3></div></div></div><p>When a Fiber by-pass card shows that it has detected an Ethernet
link, it means that it has seen the light shone into the fiber
string by the other side. So it is possible that the switch says
it has detected a link, but that the Steelhead appliance says that
it hasn't detected a link. The problem issue lies between the TX
port of the switch and the RX port on the by-pass card.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36694568"></a>4.4.4. VLAN bridge to overcome slow fixed speed LAN interfaces</h3></div></div></div><p>When a fixed speed and duplex setting is used on the LAN and the WAN
interface and the devices connected to them should all be at the same
speed and duplex settings. If the WAN bandwidth is more than about
ten percent of the fixed speed, it might be worth to implement a VLAN
bridge to overcome the fixed speed requirement on the Steelhead appliance
LAN/WAN interfaces.
</p><p>For example if the WAN bandwidth is 5 Mbps and the WAN router is
set to 10 Mbps, the speed of the optimized traffic coming out of
the LAN interface is capped to 10 Mbps. Suddenly the LAN interface
would be the limiting factor.
</p><p>Also, the WAN router could be managed by a third party which means
changing the interfaces to auto-negotiate is not possible. The way to
overcome this is by creating a VLAN bridge on the LAN switch:
</p><div class="figure"><a name="idp36702440"></a><p class="title"><b>Figure 4.4. VLAN bridge to overcome fixed speed/duplex settings</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/02-vlanbridge.png" align="middle" alt="VLAN bridge to overcome fixed speed/duplex settings"></td></tr></table></div></div></div><br class="figure-break"><p>Port A should be set to the fixed speed and duplex setting of the
WAN router.  Port B and C should be set to auto-negotiation. The
VLAN between port A and B should not have an IP address, it is just
there to forward Ethernet packets.
</p><p>This way, if the in-path interface goes into bypass, the LAN switch
and WAN router are still able to talk to each other because the
Ethernet link gets negotiated between port B and C.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36759848"></a>4.5. Network Interface Card speed issues</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36764136"></a>4.5.1. Normal operation</h3></div></div></div><p>The negotiated Ethernet links on the network interfaces should be
stable and the interface error counters should not increase. The
status and the counters can be seen with the command 
<code class="computeroutput">show interfaces &lt;interface name&gt;</code>.
</p><p>The counters in this output are cumulative since the start-up of
the appliance and they can be reset to zero with the command
<code class="computeroutput">clear interfaces</code>.
</p><div class="figure"><a name="idp36778216"></a><p class="title"><b>Figure 4.5. The output of "show interfaces primary"</b></p><div class="figure-contents"><pre class="screen">SH # show interfaces primary
Interface primary state
   Up:                 yes
   Interface type:     ethernet
   IP address:         10.17.6.119
   Netmask:            255.255.255.128
   IPv6 address:       2001:44b8:7bf1:a50:d69a:20ff:fec2:520e/64
   IPv6 auto-assigned: fe80::20e:b6ff:fe31:45e0/64
   Speed:              100Mb/s (auto)
   Duplex:             full (auto)
   MTU:                1500
   HW address:         00:0E:B6:31:45:E0

   RX bytes:           104060364
   RX packets:         660069
   RX mcast packets:   0
   RX discards:        0
   RX errors:          0
   RX overruns:        0
   RX frame:           0

   TX bytes:           3658160
   TX packets:         33089
   TX discards:        0
   TX errors:          1
   TX overruns:        0
   TX carrier:         1
   TX collisions:      0
</pre></div></div><br class="figure-break"><p>The following fields are important:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Up: Shows the administrative status of the network interface.
<span class="italics">Yes</span>
  means that the interface is enabled.
</p></li><li class="listitem"><p>Speed: The value is the speed used by the network interface. If
  the value contains the string 
<span class="italics">(auto)</span>,
  then the speed is negotiated, otherwise it is a fixed speed.
</p></li><li class="listitem"><p>Duplex: The value is the duplex setting used by the network
  interface. If the value contains the string
<span class="italics">(auto)</span>,
  then the duplex is negotiated, otherwise it is a fixed duplex
  setting.
</p></li><li class="listitem"><p>MTU: The MTU size defined on this network interface.
</p></li><li class="listitem"><p>RX bytes / RX packets / TX bytes / TX packets: The number of
  packets, sent and received, and the total number of bytes of data,
  sent and received.
</p></li><li class="listitem"><p>RX discards / RX errors / RX frame: Number of Ethernet frames
  which could not be processed because the Ethernet frame was
  corrupted.
</p></li><li class="listitem"><p>TX discards / TX errors / TX carrier / TX collisions: Number
  of Ethernet frames which could not be sent because of Ethernet
  layer related problems.
</p></li><li class="listitem"><p>RX overruns / TX overruns: Number of Ethernet frames which could
  not be processed because the NIC ran out of memory to store
  incoming frames or wasn't fast enough with the processing of
  frames the buffer.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36850280"></a>4.5.2. Possible causes of TX and RX errors</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36850728"></a>4.5.2.1. Negotiation issues</h4></div></div></div><p>The Ethernet specification states that if no Ethernet link can be
negotiated that the network interface speed should be set to 10
Mbps and the duplex should be set to half-duplex.
</p><p>This situation can happen when one side of the Ethernet link is set
to a fixed duplex/speed and the other side is set to auto-negotiation.
</p><div class="figure"><a name="idp36851816"></a><p class="title"><b>Figure 4.6. Interface set for auto-negotiation but coming up as half-duplex</b></p><div class="figure-contents"><pre class="screen">SH # show interfaces lan0_0
Interface lan0_0 state
   Up:                 yes
   Interface type:     ethernet
   Speed:              10Mb/s (auto)
   Duplex:             half (auto)
   MTU:                1500
   HW address:         00:0E:B6:8C:7A:EE
   Link:               yes
</pre></div></div><br class="figure-break"><p>Alternatively when the NIC on the Steelhead appliance is set
to a fixed speed and duplex but it receiving a lot of RX/TX errors
in the counters:
</p><div class="figure"><a name="idp36864872"></a><p class="title"><b>Figure 4.7. Interface set for fixed speed but with a lot of RX/TX errors</b></p><div class="figure-contents"><pre class="screen">SH # show interfaces lan0_0
Interface lan0_0 state
   Up:                 yes
   Interface type:     ethernet
   Speed:              100Mb/s
   Duplex:             full
   MTU:                1500
   HW address:         00:0E:B6:8C:7A:EE
   Link:               yes

   RX bytes:           104060364
   RX packets:         660069
   RX mcast packets:   0
   RX discards:        0
   RX errors:          12737
   RX overruns:        0
   RX frame:           12737

   TX bytes:           3658160
   TX packets:         33089
   TX discards:        0
   TX errors:          19244
   TX overruns:        0
   TX carrier:         6921
   TX collisions:      12323
</pre></div></div><br class="figure-break"><p>These RX/TX counters are cumulative so make sure they are actually
increasing before drawing conclusions about them.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp36867688"></a>4.5.2.2. Cable and switch port related issues</h4></div></div></div><p>If the issue cannot be resolved by fixing the speed / duplex mismatch,
consider a replacement of the cables.
</p><p>If that doesn't overcome the problem, try a different port on the
LAN switch or the WAN router and see if the problem migrates to the
new port.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36871592"></a>4.6. IP Subnet configuration related issues</h2></div></div></div><p>To be able to communicate to other Steelhead appliances, each active
in-path interface needs to have an IP address, subnet mask and a
default gateway defined. If the IP address is defined in a tagged
VLAN, also a VLAN tag ID should be defined.
</p><p>The most common issues with regards to the configuration are that
the in-path interface IP address is the wrong IP subnet, that the
VLAN tag ID is not properly defined or that the default gateway is set
wrong.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36877672"></a>4.6.1. Wrong IP subnet for the in-path interface</h3></div></div></div><p>The easiest way to determine if this is the case is to run tcpdump
and check out the broadcast traffic like ARP requests, OSPF Hello
packets and SMB traffic.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The ARP requests will be for IP addresses which are not in the
  expected IP subnet.
</p><p>  In this example the traffic from 192.168.1.0/24 while the in-path
  IP address is in 10.0.1.0/24:
</p><div class="figure"><a name="idp36880488"></a><p class="title"><b>Figure 4.8. ARP requests are coming from IP subnet 192.168.2.0/24</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0_0 'arp or (vlan and arp)'
tcpdump: WARNING: lan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 65535 bytes
21:19:59.256938 ARP, Request who-has 192.168.1.1 tell 192.168.1.3 length 28
21:20:07.618390 ARP, Request who-has 192.168.1.254 tell 192.168.1.8 length 46
21:20:08.127260 ARP, Request who-has 192.168.1.13 tell 192.168.1.12 length 46
3 packets captured
2123 packets received by filter
0 packets dropped by kernel
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>The SMB protocol uses IP broadcasts to announce services. These
  broadcasts should not leave the local IP subnet, so if you see them
  for IP addresses which are not on the expected IP subnet you know
  that there is something wrong.
</p><div class="figure"><a name="idp36896296"></a><p class="title"><b>Figure 4.9. SMB broadcast packets are coming from IP subnet 192.168.2.0/24</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni wan0_0 ether broadcast
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
21:35:19.514281 IP 192.168.2.55.42776 &gt; 192.168.2.255.137: NBT UDP PACKET(137): QUERY; REQ \
    UEST; BROADCAST
21:35:21.407979 IP 192.168.2.55.42776 &gt; 192.168.2.255.137: NBT UDP PACKET(137): QUERY; REQ \
    UEST; BROADCAST
21:35:21.678573 IP 192.168.2.55.42776 &gt; 192.168.2.255.137: NBT UDP PACKET(137): QUERY; REQ \
    UEST; BROADCAST
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>OSPF Hello packets are sent from the IP address of the router
  interface to a multicast address. If the IP address of the OSPF
  packet is not the IP address on the expected IP subnet you know
  that there is something wrong.
</p><div class="figure"><a name="idp36899368"></a><p class="title"><b>Figure 4.10. OSPF broadcast and unicast packets and coming from IP subnet 192.168.170.0/24</b></p><div class="figure-contents"><pre class="screen">23:20:13.384849 IP 192.168.170.8 &gt; 224.0.0.5: OSPFv2, Hello, length 48
23:20:14.386980 IP 192.168.170.2 &gt; 224.0.0.5: OSPFv2, Hello, length 48
23:20:14.414477 IP 192.168.170.8 &gt; 192.168.170.2: OSPFv2, Database Description, length 32
23:20:14.415890 IP 192.168.170.2 &gt; 192.168.170.8: OSPFv2, Database Description, length 32
23:20:14.418003 IP 192.168.170.2 &gt; 192.168.170.8: OSPFv2, LS-Request, length 36
23:20:14.418258 IP 192.168.170.8 &gt; 192.168.170.2: OSPFv2, LS-Request, length 108
23:20:14.418357 IP 192.168.170.8 &gt; 224.0.0.5: OSPFv2, LS-Update, length 64
23:20:14.420459 IP 192.168.170.2 &gt; 224.0.0.6: OSPFv2, LS-Update, length 292
</pre></div></div><br class="figure-break"></li></ul></div><p>To solve this issue:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A visual confirmation of the ports of the devices connected to
  the LAN/WAN interfaces is required, with a follow-up in the
  configuration of these devices to check out which IP subnets are
  defined on them.
</p></li><li class="listitem"><p>A remote investigation by shutting down interfaces so Ethernet
  links go down on the connected devices, giving indication of the
  connected ports on the neighbouring devices.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36903784"></a>4.6.2. In-path interface IP address is in the wrong VLAN</h3></div></div></div><p>If the Ethernet frames generated by Steelhead appliance transmitted
from the in-path interface are incorrectly tagged, the ARP requests
coming out of it will never be answered or will be send out on the
wrong VLAN.
</p><p>First step: Ping the in-path interface IP address of the default
gateway:
</p><div class="figure"><a name="idp36907560"></a><p class="title"><b>Figure 4.11. Ping the in-path interface IP address from the default gateway</b></p><div class="figure-contents"><pre class="screen">RTR # ping
Protocol [ip]:
Target IP address: 10.0.1.6
Repeat count [5]:
Datagram size [100]:
Timeout in seconds [2]:
Extended commands [n]: y
Source address or interface: 10.0.1.9
Type of service [0]:
Set DF bit in IP header? [no]:
Validate reply data? [no]:
Data pattern [0xABCD]:
Loose, Strict, Record, Timestamp, Verbose[none]:
Sweep range of sizes [n]:
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.0.1.6, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/3 ms  

RTR # ping ip 10.0.1.6 source 10.0.1.9
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.0.1.6, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/3 ms  
</pre></div></div><br class="figure-break"><p>If the in-path interface is using the wrong VLAN, this will fail
completely.
</p><p>The output of tcpdump will show only ARP requests:
</p><div class="figure"><a name="idp36944616"></a><p class="title"><b>Figure 4.12. Tcpdump running for a ping from the Steelhead appliance </b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -leni wan0_0 'host 10.0.1.9 and icmp or (vlan and host 10.0.1.9 and icmp))'
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
18:53:46.123323 00:0d:b9:17:28:de &gt; ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 4 \
    6: vlan 3, p 0, ethertype ARP, Request who-has 10.0.1.6 tell 10.0.1.9, length 28
18:53:47.027193 00:0e:b6:42:f8:9c &gt; ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 4 \
    6: vlan 12, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.6, length 28
</pre></div></div><p><br class="figure-break">
</p><p>So the ARP requests from the Steelhead appliance are on VLAN 12,
while the ARP requests from the router are on VLAN 3.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36960552"></a>4.6.3. Duplicate IP addresses on in-path interfaces</h3></div></div></div><p>If an in-path interface has been disabled in the configuration, any
IP address in the configuration will still be configured on the
virtual in-path interface.
</p><p>This means that if the same IP address has been configured on the
inpath0_0 and inpath0_1 but inpath0_1 has been disabled, the two
in-path interfaces will still get the same IP address configured.
Despite that the in-path interfaces are independent, can be on the
same IP subnet and have their own routing table, a duplicate IP
address is not supported.
</p><p>The solution would be to remove the IP address of the disabled
in-path interfaces and a restart of the optimization service:
</p><div class="figure"><a name="idp36962536"></a><p class="title"><b>Figure 4.13. Remove the IP address of inpath0_1 via the CLI</b></p><div class="figure-contents"><pre class="screen">SH (config) # no interface inpath0_1 ip address
SH (config) # restart
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36976552"></a>4.6.4. Duplicate IP addresses on the IP subnet</h3></div></div></div><p>If an in-path interface detects that it has been configured with
an IP address already in use on the IP subnet, it will complain
about it in the logs:
</p><div class="figure"><a name="idp36977512"></a><p class="title"><b>Figure 4.14. Duplicate IP addresses on the in-path interfaces</b></p><div class="figure-contents"><pre class="screen">kernel: [IP.ERR] inpath0_0: IP address 192.168.1.5 conflicts with 00:1c:c4:ee:3f:90
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp36989032"></a>4.6.5. Default gateway unreachable</h3></div></div></div><p>In the end, when everything is configured correctly, it just could
be that the default gateway is unreachable. Ping any other IP
addresses on the IP subnet and see if they work would be the next
steps.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp36990248"></a>4.7. Wrong location</h2></div></div></div><p>It could also be that the Steelhead appliance is connected to a
wrong device in the network. One possibility is described in the
previous section, where the IP subnet configured on the in-path
interface is wrong, possibly because the LAN/WAN interfaces are
connected to the wrong switch.
</p><p>But there is another possibility, where the Steelhead appliance is
properly put between the WAN router and LAN switch, but there is
also a normal cable directly connected between the WAN router and
LAN switch.
</p><div class="figure"><a name="idp36991528"></a><p class="title"><b>Figure 4.15. Steelhead appliance by-passed with a cable.</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/04-steelhead-bypassed.png" align="middle" alt="Steelhead appliance by-passed with a cable."></td></tr></table></div></div></div><br class="figure-break"><p>There are four possibilities:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The LAN switch has the MAC address of the default gateway determined
  via interface
<span class="italics">l0</span>
  and the WAN router has the MAC addresses of the hosts behind the
  LAN switch determined via the interface
<span class="italics">r0</span>.
</p><p>  As expected, all traffic goes through the Steelhead appliance and
  will be optimized.
</p></li><li class="listitem"><p>The LAN switch has the MAC address of the default gateway determined
  via interface
<span class="italics">l0</span>
  and the WAN router has the MAC addresses of the hosts behind the
  LAN switch determined via the interface
<span class="italics">r1</span>.
</p><p>  The outgoing traffic will be marked for optimization, but the
  auto-discovery process will fail catastrophically because of the
  client-side asymmetry. The auto-discovery on the incoming traffic
  will fail safely because the auto-discovery probe will not be
  seen by the Steelhead appliance.
</p></li><li class="listitem"><p>The LAN switch has the MAC address of the default gateway determined
  via interface l1 and the WAN router has the MAC addresses of the
  hosts behind the LAN switch determined via the interface
<span class="italics">r0</span>.
</p><p>  The outgoing traffic will not be marked for optimization because
  it is not going through the Steelhead appliance. The auto-discovery
  of the incoming traffic will fail catastrophically because of the
  server-side asymmetry.
</p></li><li class="listitem"><p>The LAN switch has the MAC address of the default gateway determined
  via interface
<span class="italics">l1</span>
  and the WAN router has the MAC addresses of the hosts behind the
  LAN switch determined via the interface
<span class="italics">r1</span>.
</p><p>  The outgoing traffic will not be marked for optimization because
  it is not going through the Steelhead appliance. The auto-discovery
  on the incoming traffic will fail safely because the auto-discovery
  probe will not be seen by the Steelhead appliance.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37032232"></a>4.7.1. What can cause this?</h3></div></div></div><p>This scenario can be caused in two ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Steelhead appliance got installed and the technician didn't
  take out the cable. 
</p></li><li class="listitem"><p>The Steelhead appliance got installed, everything was fine and
  due to some reason later a site-technician sees that there is no
  cable between the LAN switch and WAN router and he thinks that
  this is a bad idea because he is only aware of scenarios without
  WAN optimizers and puts it back in.
</p></li></ul></div><p>These issues can be present but only manifest when the Steelhead
appliance, WAN router, or LAN switch gets reset, and the devices need
to re-discover the path to the MAC addresses of the default gateway,
and that path bypasses the Steelhead appliance.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37035560"></a>4.7.2. How to determine</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37037480"></a>4.7.2.1. With tcpdump</h4></div></div></div><p>On a remote machine, start to ping a device behind the LAN switch.
On the Steelhead appliance, run the tcpdump commands:
</p><div class="figure"><a name="idp37039272"></a><p class="title"><b>Figure 4.16. Run these tcpdump commands</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0 'icmp or (vlan and icmp)'
SH # tcpdump -ni wan0 'icmp or (vlan and icmp)'
</pre></div></div><br class="figure-break"><p>If the traffic is going via the normal cable, you should only see
the
<span class="italics">ICMP Echo Reply</span>
packets, the
<span class="italics">ICMP Echo Request</span>
packets or nothing at all.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37052264"></a>4.7.2.2. On the LAN switch</h4></div></div></div><p>To do this, you first need the MAC addresses of the LAN and WAN
interfaces on the Steelhead appliance and the MAC address of the
default gateway on the WAN router.
</p><p>On the LAN switch, issue the command to see the ARP table. Search
for the MAC address of the default gateway in the list and note
down the outgoing port. Then search for the MAC addresses of the
LAN and WAN interfaces in the list and note down the outgoing ports.
These outgoing ports should be the same if the traffic goes via the
Steelhead appliance.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37073832"></a>4.7.2.3. On the WAN router</h4></div></div></div><p>To do this, you first need the MAC addresses of the LAN and WAN
interfaces on the Steelhead appliance and the MAC address of a
device behind the LAN switch.
</p><p>On the WAN router, issue the command to see the ARP table. Search
for the MAC address of the LAN device in the list and note down the
outgoing port. Then search for the MAC addresses of the LAN and WAN
interfaces in the list and note down the outgoing ports.  These
outgoing ports should be the same if the traffic goes via the
Steelhead appliance.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37075432"></a>4.8. In-path support on interface not enabled</h2></div></div></div><p>When a new in-path interface is activated in an existing Steelhead
appliance and no optimization via that interface is happening, check
out the following pre-requisites on the Steelhead appliance:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The IP address, subnet mask, default gateway and VLAN tag ID for the
  in-path interface has been configured under Configure -&gt; Networking
  -&gt; In-path Interfaces.
</p></li><li class="listitem"><p>In-path optimization has been enabled for that in-path interface
  under Configure -&gt; Optimization -&gt; General.
</p></li></ul></div><div class="figure"><a name="idp37077992"></a><p class="title"><b>Figure 4.17. No optimization support for inpath0_1</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/04-install-inpathnotenabled.png" align="middle" width="100%" alt="No optimization support for inpath0_1"></td></tr></table></div></div></div><br class="figure-break"><p>On the CLI, check that the in-path interface is enabled with the
<code class="computeroutput">show in-path</code>
command:
</p><div class="figure"><a name="idp37082344"></a><p class="title"><b>Figure 4.18. Enabled in-path interfaces for optimization</b></p><div class="figure-contents"><pre class="screen">SH # show in-path 
Enabled: yes
Kickoff: no
L4/PBR/WCCP/Interceptor: no
Maintain Multipath: no
Main Interface: inpath0_0
Asymmetric Routing Detection: yes
Asymmetric Routing Pass Through: yes

Optimizations Enabled On:
  inpath0_0

VLAN Tag IDs:
  inpath0_0: 0
</pre></div></div><br class="figure-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37083496"></a>4.9. Port security</h2></div></div></div><p>Port security is a range of features on switches and routers to
make sure that certain security policies are upheld.
</p><p>The maximum number of MAC addresses policy can interfere with the
operation of the Steelhead appliance: Normally a link between a
switch and a router only has two devices on it. With an in-path
device in it, that will increase and thus the number of MAC addresses
seen by the router or switch increases.
</p><p>On a Cisco switch or router, the status of the port security can
be seen with the command
<code class="computeroutput">show port-security</code>.
</p><div class="figure"><a name="idp37117800"></a><p class="title"><b>Figure 4.19. Port security show commands</b></p><div class="figure-contents"><pre class="screen">Switch# show port-security 
Secure Port  MaxSecureAddr  CurrentAddr  SecurityViolation  Security Action
(Count)       (Count)          (Count)
---------------------------------------------------------------------------
      Gi0/1              1            1                  0          Protect
---------------------------------------------------------------------------
Total Addresses in System (excluding one mac per port)     : 0
Max Addresses limit in System (excluding one mac per port) : 1024

Switch#sh port-security interface gi0/1
Port Security              : Enabled
Port Status                : Secure-up
Violation Mode             : Protect
Aging Time                 : 5 mins
Aging Type                 : Absolute
SecureStatic Address Aging : Disabled
Maximum MAC Addresses      : 1
Total MAC Addresses        : 1
Configured MAC Addresses   : 0
Sticky MAC Addresses       : 0
Last Source Address        : 00a0.1234.5678
Security Violation Count   : 0
</pre></div></div><br class="figure-break"><p>Port-security can be disabled for a particular interface using
command
<code class="computeroutput">no switchport port-security</code>.
The number of MAC addresses allowed on an interface can be changed
with the command
<code class="computeroutput">switchport port-security maximum &lt;number&gt;</code>.
</p><div class="figure"><a name="idp37121768"></a><p class="title"><b>Figure 4.20. Port security configuration commands</b></p><div class="figure-contents"><pre class="screen">switch (config) # interface gig 0/1
switch (config-if) # no switchport port-security
switch (config-if) # switchport port-security maximum 3
</pre></div></div><br class="figure-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37124008"></a>4.10. Link State Propagation (LSP)</h2></div></div></div><p>Link State Propagation is a feature on which an interface in an
in-path interface pair will follow the state of the Ethernet link
of the opposite interface.
</p><p>Without Steelhead appliances, the WAN and LAN routers are directly
connected. When the interface on the LAN router goes down (cable
disconnected, router rebooting) then the interface on the WAN router
will lose the Ethernet link. The routing process will be immediately
informed about this and inform the rest of the routing cloud that
the networks learned from the LAN router are unreachable.
</p><p>With a Steelhead appliance between the two routers, when the interface
on the LAN router goes down, it is only the LAN interface on the
in-path interface which notices it. Since the WAN router will be
unaware of this, the routing process on the WAN router will not get
alerted and has to wait for a timeout on protocol level.  With Link
State Propagation enabled, when the LAN interface loses its Ethernet
link, the in-path interface will also bring down the WAN interface
and thus the interface on the WAN router will lose its Ethernet
link too. Now the routing process on the WAN router will immediately
be informed that path to the LAN router is down instead of having
to wait for routing protocol timeouts.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37126504"></a>4.10.1. How to determine which interface went down first</h3></div></div></div><p>In this example the output of the
<code class="computeroutput">show interface lan0_0 brief</code>
and
<code class="computeroutput">show interface wan0_0 brief</code>
commands show that the lan0_0 went down
(<span class="italics">Up: yes</span>)
and that wan0_0 is brought down
(<span class="italics">Up: no</span>).
</p><div class="figure"><a name="idp37132904"></a><p class="title"><b>Figure 4.21. Compare the "Up" status to see which interface was brought down.</b></p><div class="figure-contents"><pre class="screen">SH # show in-path lsp 
Link State Propagation Enabled: yes 

SH # show interface lan0_0 brief
Interface lan0_0 state
   Up:                 yes
   Interface type:     ethernet
   Speed:              UNKNOWN
   Duplex:             UNKNOWN
   MTU:                1500
   HW address:         00:0E:B6:8C:7C:42
   Link:               no

SH # show interface wan0_0 brief
Interface wan0_0 state
   Up:                 no
   Interface type:     ethernet
   Speed:              UNKNOWN
   Duplex:             UNKNOWN
   MTU:                1500
   HW address:         00:0E:B6:8C:7C:41
   Link:               no
</pre></div></div><br class="figure-break"><p>The LSP feature still works when you have multiple Steelhead
appliances in a serial cluster.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37180968"></a>4.10.2. LSP during installation</h3></div></div></div><p>During installation a lot of swapping of cables might happen until
everything is working properly. It could be easier to disable LSP at
this time with the command 
<code class="computeroutput">no in-path lsp enable</code>
so that the persons on-site have direct visual feedback about link
states when cables are plugged in. When all the cables are plugged
in and all the Ethernet links are established, then LSP should be
enabled again with the command
<code class="computeroutput">in-path lsp enable</code>.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37200936"></a>4.11. VPN Concentrators</h2></div></div></div><p>Steelhead appliances are not capable of optimizing any encrypted
traffic between VPN concentrators, but it is of course capable of
optimizing traffic coming out of the VPN concentrator.
</p><p>A common problem is that the Steelhead appliances are setup on the
network-side of the network, while the VPN concentrators are setup on
the server-side of the network.
</p><div class="figure"><a name="idp37202664"></a><p class="title"><b>Figure 4.22. Wrong location of the VPN concentrator</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/04-vpn-wrong.png" align="middle" alt="Wrong location of the VPN concentrator"></td></tr></table></div></div></div><br class="figure-break"><p>In this case, the traffic from the hosts behind a remote VPN gateway
towards the servers will not be optimized because the non-VPN traffic
towards the servers does not touch the Steelhead appliance. Traffic
towards the servers across the WAN will be optimized though.
</p><p>The correct location for the VPN concentrator should be between the
Steelhead appliance and the firewall.
</p><div class="figure"><a name="idp37208168"></a><p class="title"><b>Figure 4.23. Correct location of the VPN concentrator</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/04-vpn-correct.png" align="middle" alt="Correct location of the VPN concentrator"></td></tr></table></div></div></div><br class="figure-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37211432"></a>4.12. Licenses</h2></div></div></div><p>As discussed earlier, there are licenses for various features.
The licenses for the Steelhead appliances can be found on the
Riverbed Support website, except for the SSL license.
</p><p>There are several reasons why the Steelhead appliance would need
to be reconfigured with the licenses:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Steelhead appliances lost its configuration when it got factory
  reset because of relocation or software downgrade.
</p></li><li class="listitem"><p>The original license was a temporary evaluation license which has
  expired and the purchased license was not delivered to the
  networking group responsible for the Steelhead appliances.
</p></li><li class="listitem"><p>The device got replaced in an RMA and the licenses need to be
  swapped.
</p></li><li class="listitem"><p>Somebody got too enthousiastic on the license management page in
  the GUI and deleted the current licenses.
</p></li></ul></div><p>If the assets can't be found on the Riverbed Support website,
please contact the Riverbed TAC for assistance. If the license
required is an SSL license, then the application forms on the
Riverbed Support website should be followed.
</p><p>The following licenses are available on Steelhead appliances:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>BASE license, for example "LK1-SH10BASE-0000-...". This license
  is to allow the Steelhead appliance to perform SDR services like
  data reduction.
</p></li><li class="listitem"><p>CIFS license, for example "LK1-SH10CIFS-0000-...". This license
  is to allow the Steelhead appliance to perform CIFS latency
  optimization.
</p></li><li class="listitem"><p>MAPI license, for example "LK1-SH10EXCH-0000-...". This license
  is to allow the Steelhead appliance to perform MAPI latency
  optimization.
</p></li><li class="listitem"><p>SSL license, for example "LK1-SH40SSL-0000...". This license is
  to allow SSL pre-optimization and SSL secure peering.
</p></li><li class="listitem"><p>RSP license, for example "LK1-SH50RSP-0000...". This
  license is to allow the Riverbed Services Platform feature for
  RiOS 5.0 to be enabled.
</p></li><li class="listitem"><p>RSP license, for example "LK1-SH55RSPM-0000...". This
  license is to allow the Riverbed Services Platform feature
  on the xx20 and xx50 series models for RiOS 5.5 and later to be
  enabled.
</p></li><li class="listitem"><p>Print Package License, for example "LK1-SH55PKGPRNT-0000-...".
  This license is to allow a single instance of the RSP Print Package
  for RiOS 5.5 and later to be enabled.
</p></li><li class="listitem"><p>WAN Bandwidth licenses, for example "LK1-SH70BWLIMIT#100000-0000-...".
  This license is to allow the optimizable WAN bandwidth for the EX1160VH
  and EX1260VH models to be increased from 50 Mbps to 100 Mbps.
</p></li><li class="listitem"><p>Professional Services license, for example "LK1-PROFSRV-0000...".
  This license is to allow access to the underlying operating
  system without the challenge/response authorization.
</p></li><li class="listitem"><p>High Speed TCP license, for example "LK1-SH20HTCP-0000...". This
  license is to enable the High Speed TCP feature. It has been
  obsoleted.
</p></li><li class="listitem"><p>Hardware model upgrade, for example "LK1-SH20HWUP-0000...". This
  license is for the xx20 series models and allows an upgrade towards
  a higher capacity model.
</p></li><li class="listitem"><p>Machine specification license, for example "LK1-MSPEC2050M-0000...".
  This license is to specify the base model of the xx50 series
  model. In this case the device is a 2050M model.
</p></li><li class="listitem"><p>Machine specification configuration upgrade, for example
  "LK1-MSPECHWUP1050H-0000...". This license is for the xx50 series
  models and allows an upgrade towards a higher capacity configuration.
</p></li><li class="listitem"><p>Granite license, for example "LK1-GRANITE-000...". This license is
  to enable the Granite feature.
</p></li><li class="listitem"><p>SCPS license, for example "LK1-SH55SCPS-0000...". This license is to
  enable the Space Communication Protocol Specifications specific features.
</p></li><li class="listitem"><p>FIPS license, for example "LK1-FIPS-0000...". This license is to
  enable the Steelhead appliance to run the FIPS specific software.
</p></li></ul></div><p>The following licenses are available on Steelhead Mobile Controllers:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Base license, for example "LK1-SMCVE#00087F85-0000...". This
  license is to allow the SMC VE to work.
</p></li><li class="listitem"><p>Virtual SMC license, for example "LK1-SMCVBASE#VA6MR00012334-0000...".
  This license is to allow the Virtual SMC to work.
</p></li><li class="listitem"><p>Additional client license, for example "LK1-SMCEL#190+4E12346D-0000-...".
  This license allows extra Steelhead Mobile Clients to be active.
  The string
<span class="italics">190</span>
  in the license is the extra capacity in hex.
</p></li><li class="listitem"><p>Standard CIFS license for Steelhead Mobile Clients, for example
  "LK1-SMCCIFS-0000-...". This license allows the Steelhead Mobile
  Client to perform CIFS latency optimization.
</p></li><li class="listitem"><p>Standard MAPI license for Steelhead Mobile Clients, for example
  "LK1-SMCMAPI-0000-...". This license allows the Steelhead Mobile
  Client to perform MAPI latency optimization.
</p></li><li class="listitem"><p>SSL license, for example "LK1-SMCSSL-0000...". This license is
  to allow SSL pre-optimization and SSL secure peering.
</p></li></ul></div><p>The following licenses are available on Central Management Console:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Base license, for example "LK1-CMC10BASE-0000". This license is
  to allow the CMC appliance to manage the devices.
</p></li><li class="listitem"><p>Base license for the CMC VE, for example
  "LK1-CMCVEBASE#V58GW000D1234-0000-". This license is to allow the
  CMC VE appliance to manage the devices. The string 
<span class="italics">V58GW000D1234</span>
  is the serial number of the CMC VE.
</p></li><li class="listitem"><p>Additional devices license, for example "LK1-CMCVE#32+50CA2E1D-0000-".
  This license increases the number of devices allowed to be managed. 
  The string
<span class="italics">32</span>
  is the extra number of devices.
</p></li><li class="listitem"><p>Additional devices license, for example "LK1-CMC10S0050-0000".
  This license increases the number of devices allowed to be managed.
  The string
<span class="italics">0050</span>
  is the extra number of devices.
</p></li><li class="listitem"><p>Increased devices license, for example "LK1-CMCIL#122+51535ABE-0000-".
  The string
<span class="italics">122</span>
  is the hex value of the extra number of devices.
</p></li></ul></div><p>The following licenses are available on the Interceptor appliance:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Interceptor base license, for example "LK1-IB10BASE-0000-...".
  This license is to allow the Interceptor to redirect traffic.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37490344"></a>4.12.1. Licenses and tokens</h3></div></div></div><p>In the xx20 series models, there were no licenses to upgrade between
models. In the xx50 series models, there are licenses to upgrade
between the different configurations inside the same model, but the
appliances coming out of the manufacturing plants still had the
distinction between if it was a 1050L, 1050M or 1050H model.
</p><p>In the newer CX and EX series, the appliances coming out of the
manufacturing plants will be the basic models like a 755 or 760
model, but not with licenses to make it a 755L or 755H configuration.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37500712"></a>4.12.1.1. Licenses and tokens on the CX and EX series</h4></div></div></div><p>When obtaining a new CX or EX series model, the configuration first
needs to be activated. This can be done by going to the Riverbed
Licensing website at https://licensing.riverbed.com/. You will be
asked for your name, email address, phone number and device serial
number.  Next you will be asked what the base level is you want to
make for it, for example an L or an M or an H model.
</p><p>Once activated, the licenses are generated and available for download
when the Steelhead appliance is powered up:
</p><div class="figure"><a name="idp37501928"></a><p class="title"><b>Figure 4.24. Automatic fetching of licenses at the startup of a new CX series model</b></p><div class="figure-contents"><pre class="screen">SH mgmtd[5156]: [mgmtd.INFO]: Attempting automatic license retrieval 
SH mgmtd[5156]: [mgmtd.INFO]: Next automatic license retrieval attempt in 81002 seconds 
SH mgmtd[5156]: [mgmtd.NOTICE]: Installing new license 'LK1-MSPECCX755H-0000-0000-1-72D2-F \
    FCA-9FBC' 
SH mgmtd[5156]: [mgmtd.INFO]: Starting database commit 
</pre></div></div><br class="figure-break"><p>After that the optimization server gets started and the Steelhead
appliance will start optimization new TCP sessions.
</p><p>Of course there are various network related problems which can occur.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>DNS lookup failures for the licensing server: Can the DNS server
  resolve external hosts?
</p></li><li class="listitem"><p>Unable to connect to the licensing server: Does the traffic need
  to go through a web proxy?
</p></li></ul></div><div class="figure"><a name="idp37506408"></a><p class="title"><b>Figure 4.25. Failure of automatic fetching because of a DNS related failure</b></p><div class="figure-contents"><pre class="screen">SH mgmtd[5156]: [mgmtd.INFO]: Attempting automatic license retrieval 
SH mgmtd[5156]: [mgmtd.WARNING]: Automatic licensing server api.licensing.riverbed.com is  \
    unreachable: Couldn't resolve host name 
SH mgmtd[5156]: [mgmtd.INFO]: Next automatic license retrieval attempt in 300 seconds 
</pre></div></div><br class="figure-break"><p>Once access to the licensing server has been fixed, the command
<code class="computeroutput">license autolicense fetch</code>
can be used to force an update of the licenses.
</p><div class="figure"><a name="idp37510504"></a><p class="title"><b>Figure 4.26. Manual update of the licenses with "license autolicense fetch"</b></p><div class="figure-contents"><pre class="screen">SH cli[9572]: [cli.INFO]: user admin: Executing command: license autolicense fetch 
SH cli[9572]: [cli.INFO]: user admin: Command license autolicense fetch authorized 
SH mgmtd[5156]: [mgmtd.INFO]: Attempting automatic license retrieval 
SH mgmtd[5156]: [mgmtd.INFO]: Next automatic license retrieval attempt in 81571 seconds 
SH mgmtd[5156]: [mgmtd.INFO]: Skipping already installed license 'LK1-MSPECCX755H-0000-000 \
    0-1-72D2-FFCA-9FBC' 
SH mgmtd[5156]: [mgmtd.INFO]: Skipping already installed license 'LK1-MSPECCX755M-0000-000 \
    0-1-6799-DA37-1EF7' 
SH mgmtd[5156]: [mgmtd.INFO]: Skipping already installed license 'LK1-SH10BASE-0000-0000-1 \
    -E32A-DC6A-E50F' 
SH mgmtd[5156]: [mgmtd.INFO]: Skipping already installed license 'LK1-SH10CIFS-0000-0000-1 \
    -8BD2-4668-8EDA' 
SH mgmtd[5156]: [mgmtd.NOTICE]: Installing new license 'LK1-SH10EXCH-0000-0000-1-211C-36AC \
    -455C' 
</pre></div></div><br class="figure-break"><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp37513128"></a>4.12.1.1.1. SSL licenses</h5></div></div></div><p>The SSL licenses will be distributed in this way too, but they are
only generated once a day and will not be available immediately.
</p></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37514280"></a>4.12.1.2. Licenses and tokens on the virtual appliances</h4></div></div></div><p>When purchasing a virtual appliance, you will get a License Request
Token. Once the virtual machine has been created and the appliance
software has been installed in the virtual machine, you will enter
this License Request Token in the GUI and it is converted to a
license Request String. This License Request String contains some
unique information about the virtual machine like the UID and the
MAC address. The License Request String can be redeemed on the
Riverbed Licensing website and the licenses will be generated. After
that the license can be installed manually or automatically fetched
by the appliance.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37515752"></a>4.13. LAN and WAN cable switched</h2></div></div></div><p>The processing of new TCP sessions depends of which interface the
naked SYN (TCP SYN packet without an auto-discovery probe) gets
received. If the naked SYN comes in via the WAN interface, then the
Steelhead appliance will not process the packet but just forward
it, marking the pass-through session as
<span class="italics">SYN on WAN side</span>.
Only if the naked SYN comes in via the LAN interface, the Steelhead
appliance will check what to do with it via the In-path Rules and,
if allowed, perform auto-discovery for it.
</p><p>If the Steelhead appliance is wrongly cabled, with the LAN interface
to the WAN router and the WAN interface to the LAN switch, no traffic
coming from the LAN will be optimized.
</p><p>There are two ways to determine this issue is happening: A visual
inspection and a tcpdump with ping approach.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37521896"></a>4.13.1. Visual check</h3></div></div></div><p>The instructions are very simple: Walk to the Steelhead appliance,
find the cable connected to the LAN interface and follow it all the
way to the next device. If it is the router you expect to be on the
WAN interface, then the cable is swapped.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37522600"></a>4.13.2. Tcpdump and ping check</h3></div></div></div><p>This will require three CLI sessions on the Steelhead appliance.
</p><p>In the first CLI session, run tcpdump on the LAN interface.
In the second CLI session, run tcpdump on the WAN interface.
In the third CLI session, ping the IP address of a host which traffic
doesn't get optimized.
</p><div class="figure"><a name="idp37523688"></a><p class="title"><b>Figure 4.27. Three CLI sessions for troubleshooting</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0_0 '(icmp and host 10.0.1.1) or (vlan and icmp and host 10.0.1.1)'

SH # tcpdump -ni wan0_0 '(icmp and host 10.0.1.1) or (vlan and icmp and host 10.0.1.1)'

SH # ping -I 10.0.1.6 10.0.1.1
</pre></div></div><br class="figure-break"><p>We expect this ICMP Echo Request traffic to show up on the tcpdump
output of the lan0_0 interface. In the scenario where the LAN and
WAN cables are swapped, the
<span class="italics">ICMP Echo Request</span>
and
<span class="italics">ICMP Echo Reply</span>
packets show up on the WAN interface.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37526248"></a>4.13.2.1. ICMP Echo Request and Echo Reply show up on the WAN interface.</h4></div></div></div><p>When both the
<span class="italics">ICMP Echo Request</span>
and
<span class="italics">ICMP Echo Reply</span>
packets are seen up on the WAN interface, which indicates that the
host is located behind the WAN interface of the Steelhead appliance.
</p><div class="figure"><a name="idp37528424"></a><p class="title"><b>Figure 4.28. ICMP Echo Request and Echo Reply show up on the WAN interface.</b></p><div class="figure-contents"><pre class="screen">SH # ping -I 10.0.1.6 10.0.1.1
PING 10.0.1.6 (10.0.1.6) from 10.0.1.6 : 56(84) bytes of data.
64 bytes from 10.0.1.1: icmp_seq=0 ttl=63 time=2 ms
64 bytes from 10.0.1.1: icmp_seq=1 ttl=63 time=1 ms
64 bytes from 10.0.1.1: icmp_seq=2 ttl=63 time=1 ms

SH # tcpdump -ni lan0_0 '(icmp and host 10.0.1.1) or (vlan and icmp and host 10.0.1.1)'
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 96 bytes

SH # tcpdump -ni wan0_0 '(icmp and host 10.0.1.1) or (vlan and icmp and host 10.0.1.1)'
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
08:22:05.703095 IP 10.0.1.6 &gt; 10.0.1.1: ICMP echo request, id 9738, seq 0, length 64
08:22:05.719544 IP 10.0.1.1 &gt; 10.0.1.6: ICMP echo reply, id 9738, seq 0, length 64
08:22:06.728721 IP 10.0.1.6 &gt; 10.0.1.1: ICMP echo request, id 9738, seq 1, length 64
08:22:06.736897 IP 10.0.1.1 &gt; 10.0.1.6: ICMP echo reply, id 9738, seq 1, length 64
08:22:07.752379 IP 10.0.1.6 &gt; 10.0.1.1: ICMP echo request, id 9738, seq 2, length 64
08:22:07.762682 IP 10.0.1.1 &gt; 10.0.1.6: ICMP echo reply, id 9738, seq 2, length 64
</pre></div></div><br class="figure-break"><p>In this case it is clear that the host is on the WAN side of the
Steelhead appliance and therefore the naked SYN packet never gets
processed.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37531560"></a>4.14. After an RMA</h2></div></div></div><p>When a full chassis gets replaced in the RMA process, some minor
changes and updates might be required.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37537704"></a>4.14.1. The replacement device doesn't boot</h3></div></div></div><p>There are several kind of "not booting": No power, no output to the
console, not completing the boot process.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37538408"></a>4.14.1.1. No power</h4></div></div></div><p>When the power cables get connected to the replacement chassis and
the device gets turned on but no lights or fans come on:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the device is a 1RU or 3RU chassis, reseat the power supplies
  and hard disks.
</p></li><li class="listitem"><p>If that doesn't resolve the issue, install the power supplies of
  the old chassis in the replacement chassis.
</p></li><li class="listitem"><p>If that doesn't resolve the issue, open the chassis and press
  down all the connectors and reseat the memory.
</p></li></ul></div><p>If the replacement chassis doesn't power up at the end, call the
Riverbed TAC to arrange a Support DOA RMA.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37540968"></a>4.14.1.2. Not completing the boot process</h4></div></div></div><p>This is when the device boots and initializes the kernel, as can
be seen on the serial console, but it never ends up at the login prompt:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Reseat the hard disks.
</p></li><li class="listitem"><p>Reseat the network cards.
</p></li></ul></div><p>If this doesn't resolve it, capture the full boot log and contact
the Riverbed TAC to determine where it goes wrong here.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37542952"></a>4.14.2. The extra memory or in-path card did not get pre-installed</h3></div></div></div><p>The chassis kept in the depots are the basic models, they don't
have extra kits like the RSP memory or extra in-path cards installed.
</p><p>So when a chassis with RSP memory installed has to be replaced, two
packages will get delivered: One big box with the chassis, and one
small box with the RSP memory. This memory needs to be installed
before the device gets installed and powered up.
</p><p>The
<span class="italics">Hardware Maintenance Guide</span>
document on the Riverbed Support website has clear instructions on
how to open the chassis and where the additional parts need to
placed. The Multimedia menu in the Knowledge Base section on the
Riverbed Support website has videos with instructions on how to
replace parts in various appliances.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37545064"></a>4.14.3. The licenses are absent</h3></div></div></div><p>When the licenses are absent, the device will not start the
optimization service. An overview of the licenses can be found in
the asset section on the Riverbed Support website. If the asset
list does not have the device on it, please contact Riverbed TAC
to request a copy of the licenses.
</p><p>Because of legal restrictions, the SSL license cannot be re-issued
by Riverbed TAC. Please go to the Riverbed Support website and apply
for them there.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37546920"></a>4.14.4. The RiOS software version is incorrect</h3></div></div></div><p>The RiOS version on the replacement chassis is installed during
manufacturing and might not be the one you want to run in your
network. Please follow the RiOS upgrade instructions in the
<a class="xref" href="#operation_downgradenandupgradeissues" title="5.9. Downgrade and upgrade issues">Downgrade and upgrade issues</a> chapter to go to the RiOS version you want to run.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37550120"></a>4.15. Best cabling for remote management</h2></div></div></div><p>In the standard design, the primary interface is used for management
of the Steelhead appliance: The GUI and CLI are accessible via it,
the remote logging of system messages and SNMP traps are send out
via it. Also, the traffic for CIFS pre-population and Windows Active
Directory integration is send out via this interface.
</p><p>To increase the manageability of the Steelhead appliance, especially
the central ones in data centers, several steps can be taken:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Connect the auxiliary interface to a device on the WAN side of
  the Steelhead appliance. In the main routing table, configure an
  entry for a remote network management host going out via the IP
  subnet defined on the auxiliary interface. This way if the primary
  interface is unreachable (due to a failure of the optimization
  service, a fail-to-block configuration or a problem with the
  negotiation of the Ethernet link on the in-path interface), the
  device is still reachable via the auxiliary interface.
</p></li><li class="listitem"><p>Connect the serial port to a terminal server or to a serial-over-TCP
  module and connect the Ethernet port of the terminal server or
  module to a device on the WAN side of the Steelhead appliance.
</p></li></ul></div><div class="figure"><a name="idp37553896"></a><p class="title"><b>Figure 4.29. Cabling for remote management</b></p><div class="figure-contents"><pre class="screen">                            Terminal
                             Server 
       .-,(  ),-.         __________ 
    .-(          )-.     [_...__...o]
   (       WAN      )        |   ^
    '-(          ).-'        |   |   Serial __________   PRI
        '-.( ).-'            |   '---------|          |-----------.
            ^                |     ________|          |           |
            |                v    v    AUX |          |           v
            |             __________       |          |      __________ 
            '------------[_...__...o]&lt;-----|_...__...o|----&gt;[_...__...o]
                                       WAN              LAN
                          WAN router         Steelhead       LAN router
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37554856"></a><p class="title"><b>Figure 4.30. Configuration for routing towards remote management system via the auxiliary interface</b></p><div class="figure-contents"><pre class="screen"></pre></div></div><br class="figure-break"></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="Operation_Related_Issues"></a>Chapter 5. Operation Related Issues</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp37556904">5.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp37571432">5.2. Hardware related issues</a></span></dt><dt><span class="sect1"><a href="#idp37848232">5.3. Admission Control</a></span></dt><dt><span class="sect1"><a href="#idp38032616">5.4. Auto-negotiation and duplex issues</a></span></dt><dt><span class="sect1"><a href="#idp38093160">5.5. LAN speed maxed out</a></span></dt><dt><span class="sect1"><a href="#idp38120296">5.6. Watchdogs</a></span></dt><dt><span class="sect1"><a href="#idp38158312">5.7. Unexpected restarts of the optimization service</a></span></dt><dt><span class="sect1"><a href="#idp38221352">5.8. Unexpected reboots</a></span></dt><dt><span class="sect1"><a href="#operation_downgradenandupgradeissues">5.9. Downgrade and upgrade issues</a></span></dt><dt><span class="sect1"><a href="#idp38459560">5.10. Time related issues - The NTP service.</a></span></dt><dt><span class="sect1"><a href="#idp39004072">5.11. Firewalls in the path</a></span></dt><dt><span class="sect1"><a href="#idp39007464">5.12. Data Store Synchronization</a></span></dt><dt><span class="sect1"><a href="#idp39010408">5.13. Data store related errors</a></span></dt><dt><span class="sect1"><a href="#idp39025960">5.14. WCCP issues</a></span></dt><dt><span class="sect1"><a href="#operation_asymmetricrouting">5.15. Asymmetric Routing</a></span></dt><dt><span class="sect1"><a href="#operation_iproutingrelatedissues">5.16. IP Routing Related Issues</a></span></dt><dt><span class="sect1"><a href="#idp39062632">5.17. Alarms and health status</a></span></dt><dt><span class="sect1"><a href="#idp39167848">5.18. Long lived TCP session treatment</a></span></dt><dt><span class="sect1"><a href="#idp39182312">5.19. Order of the in-path rules</a></span></dt><dt><span class="sect1"><a href="#idp39188520">5.20. Network monitoring and network management systems</a></span></dt><dt><span class="sect1"><a href="#idp39191912">5.21. Web proxies and web caches</a></span></dt><dt><span class="sect1"><a href="#idp39193768">5.22. Security</a></span></dt><dt><span class="sect1"><a href="#idp39325608">5.23. The Riverbed Services Platform</a></span></dt><dt><span class="sect1"><a href="#idp39338856">5.24. Access related problems</a></span></dt><dt><span class="sect1"><a href="#idp39364200">5.25. Partitions running out of space</a></span></dt><dt><span class="sect1"><a href="#idp39401448">5.26. Memory usage on the Steelhead appliance</a></span></dt><dt><span class="sect1"><a href="#idp39398248">5.27. LAN side traffic is seen on the Steelhead appliance</a></span></dt><dt><span class="sect1"><a href="#idp39411048">5.28. Service Error</a></span></dt><dt><span class="sect1"><a href="#idp39470184">5.29. Can this application be optimized?</a></span></dt><dt><span class="sect1"><a href="#idp39473832">5.30. Interceptor cluster related issues</a></span></dt><dt><span class="sect1"><a href="#idp39489768">5.31. Expiring SSL certificates</a></span></dt><dt><span class="sect1"><a href="#idp39491048">5.32. High CPU related issues</a></span></dt><dt><span class="sect1"><a href="#idp39508712">5.33. Central Management Console related issues</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37556904"></a>5.1. Index</h2></div></div></div><p>This chapter describes various issues encountered during the operational
of a Steelhead appliance in the network.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Hardware related issues, like hard disk failures, power supply
  failures, fan related failures and memory related failures.
</p></li><li class="listitem"><p>Admission control.
</p></li><li class="listitem"><p>Auto-negotiation and speed/duplex issues.
</p></li><li class="listitem"><p>LAN speed is maxed out.
</p></li><li class="listitem"><p>Unexpected restarts of the optimization service.
</p></li><li class="listitem"><p>Unexpected reboots of the Steelhead appliance.
</p></li><li class="listitem"><p>Watchdogs on the Steelhead appliance.
</p></li><li class="listitem"><p>Downgrade and upgrade related issues.
</p></li><li class="listitem"><p>Time related issues.
</p></li><li class="listitem"><p>Firewalls in the path.
</p></li><li class="listitem"><p>Data Store Synchronization.
</p></li><li class="listitem"><p>Data store related errors.
</p></li><li class="listitem"><p>WCCP related issues.
</p></li><li class="listitem"><p>Asymmetric Routing.
</p></li><li class="listitem"><p>IP Routing related issues.
</p></li><li class="listitem"><p>Alarms and health status.
</p></li><li class="listitem"><p>Long lived TCP sessions.
</p></li><li class="listitem"><p>Order of the in-path rules.
</p></li><li class="listitem"><p>Network monitoring and network management systems.
</p></li><li class="listitem"><p>Web proxies and web caches.
</p></li><li class="listitem"><p>Security.
</p></li><li class="listitem"><p>The Riverbed Services Platform (RSP)
</p></li><li class="listitem"><p>Access related issues
</p></li><li class="listitem"><p>Partitions running out of space
</p></li><li class="listitem"><p>Memory usage
</p></li><li class="listitem"><p>LAN side traffic seen
</p></li><li class="listitem"><p>Service errors
</p></li><li class="listitem"><p>Can this application be optimized?
</p></li><li class="listitem"><p>Interceptor cluster
</p></li><li class="listitem"><p>Expiring SSL certificates
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37571432"></a>5.2. Hardware related issues</h2></div></div></div><p>This section describes the possible hardware related issues during
the operation of the Steelhead appliance.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37572136"></a>5.2.1. Storage</h3></div></div></div><p>There are three kinds of storage devices in the Steelhead appliances:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>USB flash disk with the boot-partition, the configuration and a
  copy of the latest installed RiOS software.
</p></li><li class="listitem"><p>One or more hard disk drives.
</p></li><li class="listitem"><p>One or more solid-state disks
</p></li></ul></div><p>From a troubleshooting point of view, the USB flash disk is not
interesting.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37574696"></a>5.2.1.1. Hard disks</h4></div></div></div><p>The hard disk in a Steelhead appliance can get hammered a lot and can
fail after time. That is why in the higher end Steelhead appliances their
hard disks are mirrored in a RAID array, so that if one hard disk fails
the data is still available on the mirror hard disk.
</p><p>On the Steelhead appliance without a RAID array, the failure of a
hard disk will cause initial slowness in the processing of optimized
TCP sessions, and at a certain moment the hardware watchdog will
timeout and restart the appliance and then the device will fail in
the boot process.
</p><p>In case of a hard disk failure there are different steps per model:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The low-end desktop models of the xx20, xx50, CX and EX series
  models have a single hard disk or a dual non-RAID set of disks.
  The whole chassis needs to be replaced.
</p></li><li class="listitem"><p>The 1RU xx20 series models have a single hard disk. The whole
  chassis needs to be replaced.
</p></li><li class="listitem"><p>The 1RU xx50 series 1050U, 1050L and 1050M models with a single
  hard disk, but the appliance can rebuild itself during the startup
  from the flash partition. Only a hard disk replacement is needed.
</p></li><li class="listitem"><p>The 1RU xx50 series 1050H model has two hard disks but they are
  in a RAID0 array. The appliance can rebuild itself during the
  startup of the appliance and only a hard disk replacement is
  needed.
</p><p>  If a system dump is not available but the serial console bootlogs
  are, search for the available disks in with the string
<code class="computeroutput">Attached SCSI disk</code>
</p><div class="figure"><a name="idp37578728"></a><p class="title"><b>Figure 5.1. Grep for "Attached SCSI disk" in the bootlogs</b></p><div class="figure-contents"><pre class="screen">  [~/sysdumps] edwin@t43&gt;grep "Attached SCSI disk" dmesg-boot 
  sd 0:0:0:0: [sda] Attached SCSI disk
  sd 1:0:0:0: [sdb] Attached SCSI disk
  sd 6:0:0:0: [sdc] Attached SCSI disk
</pre></div></div><p><br class="figure-break">
</p><p>  If
<code class="computeroutput">sd 1:0:0:0</code>
  shows up, that is disk 1 which means that disk 0 is missing.
</p></li><li class="listitem"><p>The 1RU xx50 series 1050UR, 1050LR, 1050MR, 1050HR models and
  CX1555 models have four hard disks in a RAID10 array. In case of
  a single hard disk failure only the hard disk needs to be replaced.
  In case of a multiple hard disk failure on the same RAID1 array,
  the chassis can rebuild itself during the startup from the flash
  partition.
</p></li><li class="listitem"><p>The 1RU xx50 series 2050 model, the 3RU xx50 series 5050 and 6050
  models have multiple hard disks in a RAID10 array. In case of a
  single hard disk failure only the hard disk needs to be replaced.
  In case of a multiple hard disk failure on the same RAID1 array,
  the whole chassis needs to be replaced.
</p></li><li class="listitem"><p>The 7050, 5055 and 6055 models have the hard disks in a RAID1
  configuration while the solid state disks are in a FTS configuration.
</p></li></ul></div><p>During the RMA process of a broken hard disk, the device is running
in a degraded mode. If the appliance has Silver level or Gold level
support contract, you might want to obtain spare hard disks so you
can replace them faster and thus get the redundancy on the RAID
array back faster.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37583464"></a>5.2.1.2. Solid-state disks</h4></div></div></div><p>The solid-state disks will suffer from Write Endurance: The number
of write cycles to any block of flash is limited. The Steelhead
appliance keeps track of the number of writes per block of flash
and if it gets higher than the manufacturer specifications it will
raise an alarm that the solid-state disk needs to be replaced.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37583848"></a>5.2.1.3. RAID status and rebuilding</h4></div></div></div><p>The operational status of the RAID array can be seen with the command
<code class="computeroutput">show raid diagram</code>.
</p><div class="figure"><a name="idp37650600"></a><p class="title"><b>Figure 5.2. Output of the command "show raid diagram" on a 2050 model</b></p><div class="figure-contents"><pre class="screen">SH # show raid diagram
[  0 : online   ][  1 : online   ][  2 : online   ][  3 : online ]
</pre></div></div><br class="figure-break"><p>When a hard disk fails, its status will go from
<span class="italics">online</span>
to
<span class="italics">missing</span>
or
<span class="italics">degraded</span>.
When the broken hard disk is replaced, the status will go to
<span class="italics">rebuilding</span>.
When the rebuilding has finished, then the status will go back to
<span class="italics">online</span>.
</p><p>In this following example there is a RAID10 array of 12 hard disks,
with the RAID1 array of disk 2 and 3 being rebuild, the RAID1
array of disk 10 and 11 is degraded because of a broken disk and
the RAID1 array of disk 8 and 9 still okay but disk 9 is currently
degraded.
</p><div class="figure"><a name="idp37701288"></a><p class="title"><b>Figure 5.3. Output of the command "show raid diagram" on a model 5050 model</b></p><div class="figure-contents"><pre class="screen">SH # show raid diagram
[  0 : online   ][  1 : online   ][  2 : online   ][  3 : rebuilding ]
[  4 : online   ][  5 : online   ][  6 : online   ][  7 : online     ]
[  8 : online   ][  9 : degraded ][ 10 : online   ][ 11 : missing    ]
[ 12 : missing  ][ 13 : missing  ][ 14 : missing  ][ 15 : missing    ]
</pre></div></div><br class="figure-break"><p>The rebuild of a RAID array will take about 12 hours, depending on
how busy the Steelhead appliance is. On the xx50, CX and EX series
models, the progress of the rebuilding can be seen with the command
<code class="computeroutput">raid swraid mdstat</code>:
</p><div class="figure"><a name="idp37726056"></a><p class="title"><b>Figure 5.4. Output of the command "raid swraid mdstat" on a 5050 model</b></p><div class="figure-contents"><pre class="screen">SH # raid swraid mdstat
Personalities : [linear] [raid0] [raid10] [raid6] [raid5] 
md3 : active raid10 sdd6[12] sda6[0] sdl6[11] sdk6[10] sdj6[9] sdi6[8] sdh6[7] sdg6[6] sdf \
    6[5] sde6[4] sdc6[2] sdb6[1]
      146512128 blocks 64K chunks 2 near-copies [12/11] [UUU_UUUUUUUU]
        resync=DELAYED
      
md0 : active raid10 sdd5[12] sda5[0] sdl5[11] sdk5[10] sdj5[9] sdi5[8] sdh5[7] sdg5[6] sdf \
    5[5] sde5[4] sdc5[2] sdb5[1]
      781288704 blocks 64K chunks 2 near-copies [12/11] [UUU_UUUUUUUU]
        resync=DELAYED
      
md2 : active raid10 sdd2[3] sda2[0] sdl2[11] sdk2[10] sdj2[9] sdi2[8] sdh2[7] sdg2[6] sdf2 \
    [5] sde2[4] sdc2[2] sdb2[1]
      37784448 blocks 64K chunks 2 near-copies [12/12] [UUUUUUUUUUUU]
      
md1 : active raid10 sdd3[12] sda3[0] sdl3[11] sdk3[10] sdj3[9] sdi3[8] sdh3[7] sdg3[6] sdf \
    3[5] sde3[4] sdc3[2] sdb3[1]
      100678656 blocks 64K chunks 2 near-copies [12/11] [UUU_UUUUUUUU]
      [=&gt;...................]  recovery =  5.4% (920064/16779776) finish=6.3min speed=4182 \
    1K/sec
      
unused devices: &lt;none&gt;
</pre></div></div><br class="figure-break"><p>In this example, disk 3 was replaced. The re-syncing of RAID1 array
md2 has been completed already while md1 is currently at 5.4%
completion while completion is estimated in 6.3 minutes. md3 and
md0 will be made redundant after this.
</p><p>On machines with multiple hard disks in a RAID10 configuration, the
machine can survive a multiple hard disk failure as long as the
failures are not on the same RAID1 array.
</p><p>If a disk is in the
<span class="italics">degraded</span>
state then it is not yet removed from the RAID array but it still
can cause performance problems. To remove it from the RAID array
use the command
<code class="computeroutput">raid swraid fail-disk</code>.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37744424"></a>5.2.1.4. Indication of a failure of a disk</h4></div></div></div><p>The failure of a disk is often indicated by a slower-than-normal
performance of a Steelhead appliance: The RAID controller or RAID
software has not yet marked the hard disk as broken, but it sees
long delays in reading and writing with it.
</p><p>In the system logs a failing disk can be seen with the log entries like:
</p><div class="figure"><a name="idp37758568"></a><p class="title"><b>Figure 5.5. A Failing disk in the system logs</b></p><div class="figure-contents"><pre class="screen">SH kernel: ata4.00: exception Emask 0x0 SAct 0x1 SErr 0x0 action 0x0
SH kernel: ata4.00: (irq_stat 0x40000008)
SH kernel: ata4.00: cmd 60/3e:00:43:00:00/00:00:00:00:00/40 tag 0 cdb 0x0 data 31744 in
SH kernel:          res 41/40:3e:43:00:00/00:00:00:00:00/40 Emask 0x9 (media error)
SH kernel: ata4.00: configured for UDMA/133
SH kernel: SCSI error : &lt;3 0 0 0&gt; return code = 0x8000002
SH kernel: Info fld=0x4000000 (nonstd), Invalid sdd: sense = 72 11
SH kernel: end_request: I/O error, dev sdd, sector 67
SH kernel: Buffer I/O error on device sdd1, logical block 33
SH kernel: ata4: EH complete
SH kernel: SCSI device sdd: 490350672 512-byte hdwr sectors (251060 MB)
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37760232"></a>5.2.2. Power supplies</h3></div></div></div><p>The Steelhead appliances with multiple power supplies are able to
sustain the loss of one. An alarm will be raised if a power supply
has failed.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37761256"></a>5.2.3. Fans</h3></div></div></div><p>Depending on the model, there are one or multiple fans in a Steelhead
appliance. An alarm will be raised if a fan has failed.
</p><div class="figure"><a name="idp37762088"></a><p class="title"><b>Figure 5.6. Output of the command "show stats fan" on the 100 / 200 / 300 models</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       5869    2657    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37763368"></a><p class="title"><b>Figure 5.7. Output of the command "show stats fan" on the 520 / 1020 / 1520 / 2020 models</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       3000    750     ok
2       3000    750     ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37764456"></a><p class="title"><b>Figure 5.8. Output of the command "show stats fan" on the 3020 / 3520 / 5520 / 6020 / 6120 models</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
0       4963    712     ok
1       4821    712     ok
2       4963    712     ok
3       4821    712     ok
4       4963    712     ok
5       4963    712     ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37766824"></a><p class="title"><b>Figure 5.9. Output of the command "show stats fan" on the 150 / 250 / 550 / 555 / 755 models</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       3559    2500    ok
2       3573    2500    ok
3       3588    2500    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37769192"></a><p class="title"><b>Figure 5.10. Output of the command "show stats fan" on the 1050 / 2050 models</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       8760    1080    ok
2       9240    1080    ok
3       9480    1080    ok
5       9120    1080    ok
7       9120    1080    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37771112"></a><p class="title"><b>Figure 5.11. Output of the command "show stats fan" on the 5050 / 6050 / 7050 models</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       3720    1080    ok
2       3840    1080    ok
3       3720    1080    ok
4       4920    1080    ok
5       3720    1080    ok
6       3720    1080    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37772968"></a><p class="title"><b>Figure 5.12. Output of the command "show stats fan" on the CX255 model</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       5133    164     ok
3       5192    164     ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37783656"></a><p class="title"><b>Figure 5.13. Output of the command "show stats fan" on the CX555 / CX755 model</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       4518    2500    ok
2       4397    2500    ok
3       4368    2500    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37785192"></a><p class="title"><b>Figure 5.14. Output of the command "show stats fan" on the CX5055 / CX7055 model</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
SnId   RPM     Min RPM Status
1       5520    1080    ok
2       6840    1080    ok
3       5520    1080    ok
4       6960    1080    ok
5       5400    1080    ok
6       6840    1080    ok
7       5520    1080    ok
8       6840    1080    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37787688"></a><p class="title"><b>Figure 5.15. Output of the command "show stats fan" on the DX8000 model</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       5280    1080    ok
2       6840    1080    ok
3       5400    1080    ok
4       7080    1080    ok
5       5280    1080    ok
6       6720    1080    ok
7       5400    1080    ok
8       6720    1080    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37805096"></a><p class="title"><b>Figure 5.16. Output of the command "show stats fan" on the EX560 / EX760 model</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       5520    1800    ok
2       5520    1800    ok
3       5520    1800    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37806120"></a><p class="title"><b>Figure 5.17. Output of the command "show stats fan" on the EX1160 model</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       6000    1080    ok
3       5640    1080    ok
4       5040    1080    ok
5       5760    1080    ok
6       5160    1080    ok
7       5640    1080    ok
8       5160    1080    ok
9       5640    1080    ok
10      5160    1080    ok
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp37823336"></a><p class="title"><b>Figure 5.18. Output of the command "show stats fan" on the EX1260 / EX1360 model</b></p><div class="figure-contents"><pre class="screen">SH # show stats fan
FanId   RPM     Min RPM Status
1       5520    1080    ok
2       6840    1080    ok
3       5520    1080    ok
4       7080    1080    ok
5       5520    1080    ok
6       6840    1080    ok
7       5760    1080    ok
8       6840    1080    ok
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37824360"></a>5.2.4. Memory errors</h3></div></div></div><p>The memory in the Steelhead appliances supports ECC, which means
it can determine if there are problems inside the memory modules.
An alarm will be raised if such a problem has been detected.
</p><div class="figure"><a name="idp37825448"></a><p class="title"><b>Figure 5.19. Output of the command "show stats ecc-ram"</b></p><div class="figure-contents"><pre class="screen">SH # show stats ecc-ram
No ECC memory errors have been detected
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp37848232"></a>5.3. Admission Control</h2></div></div></div><p>Admission Control is a state of the optimization service where it
will no longer intercept any new TCP sessions because of licensing
limitations or internal problems.
</p><p>When in admission control, except for MAPI based admission control,
the Steelhead appliance will drop all the Out-of-Band splices and
the TCP sessions of the Connection Pools to the connected Steelhead
appliances. When the Steelhead appliance comes out of admission
control, the OOB Splice and the Connection Pool will be setup again
once a new optimized TCP session towards the remote Steelhead
appliance will be setup.
</p><p>The various values for admission control can be seen in the CLI
with the command
<code class="computeroutput">show admission</code>:
</p><div class="figure"><a name="idp37853928"></a><p class="title"><b>Figure 5.20. Output of the command "show admission" for a model 560L</b></p><div class="figure-contents"><pre class="screen">SH # show admission 
Enable Admission Control Override Settings: no

  Override Settings:
    Connection Enable:   250
    Connection Cutoff:   260
    Memory Enable:       1300 MB
    Memory Cutoff:       1400 MB
    Low Memory Ratio:    96%

  Current Settings:
    Connection Enable:   250
    Connection Cutoff:   260
    Memory Enable:       1300 MB
    Memory Cutoff:       1400 MB
    Low Memory Ratio:    96%

  Current State:
    Connections:         2
    Memory:              995 MB
</pre></div></div><br class="figure-break"><p>Or in the system dump with the following command:
</p><div class="figure"><a name="idp37856104"></a><p class="title"><b>Figure 5.21. Determining the admission control values via the system dump</b></p><div class="figure-contents"><pre class="screen">sh-4.1# grep /rbt/sport/admission/config/ active-brief.txt 
/rbt/sport/admission/config/cpu_util/enable = false (bool)
/rbt/sport/admission/config/cutoff_conn = 260 (uint32)
/rbt/sport/admission/config/cutoff_mem = 1400 (uint32)
/rbt/sport/admission/config/enable_conn = 250 (uint32)
/rbt/sport/admission/config/enable_mem = 1300 (uint32)
/rbt/sport/admission/config/low_mem_ratio = 96 (uint32)
/rbt/sport/admission/config/mapi/enable = false (bool)
/rbt/sport/admission/config/mapi/threshold = 85 (uint32)
/rbt/sport/admission/config/override = false (bool)
/rbt/sport/admission/config/tcp_mem/enable = true (bool)
/rbt/sport/admission/config/unlock/licensed = false (bool)
/rbt/sport/admission/config/vm/dirty_background_ratio = 5 (uint8)
/rbt/sport/admission/config/vm/dirty_expire_centisecs = 800 (uint32)
/rbt/sport/admission/config/vm/dirty_ratio = 6 (uint8)
/rbt/sport/admission/config/vm/dirty_writeback_centisecs = 300 (uint32)
</pre></div></div><br class="figure-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37857640"></a>5.3.1. Connection-based admission control</h3></div></div></div><p>Every Steelhead has a licensed maximum number of concurrent TCP
connections, for example, the 250H model which has a maximum of concurrent
200 TCP sessions.
</p><p>In the admission control algorithm, this value is used to define
when the interception of new TCP sessions should be enabled again.
Interception is disabled when this value plus some spare is reached.
This spare amount is to dampen the flapping of the admission control
status. Interception is enabled again when the number of optimized TCP
drops below this value.
</p><div class="figure"><a name="idp37858728"></a><p class="title"><b>Figure 5.22. Connection-based admission control for a 250H model</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-04-tcplimit.jpg" align="middle" width="100%" alt="Connection-based admission control for a 250H model"></td></tr></table></div></div></div><br class="figure-break"><p>The flat yellow line between 08:00 and 14:00 shows that the device
was in connection-based admission control the entire time. Check the 
Current Connections report to determine which hosts uses most and if
their traffic is legit.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37865960"></a>5.3.1.1. Determining via the GUI</h4></div></div></div><p>If the issue is still happening the data in the list of Current
Connections can be used to find out if there is a host with an
extraordinary large amount of optimized TCP sessions in the list.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp37866920"></a>5.3.1.2. Determining via the system dump</h4></div></div></div><p>If a system dump is available, the file connection_table can be
used to determine the host with the most TCP sessions:
</p><div class="figure"><a name="idp37867752"></a><p class="title"><b>Figure 5.23. Check the list of TCP sessions to find the host which uses the most</b></p><div class="figure-contents"><pre class="screen">[~/systemdump-SH] edwin@t43&gt;awk '{ print $1 }' &lt; connection_table | sed -e 's/:.*//' | sor \
    t | uniq -c | sort -nr | head
 120   10.0.1.6
 112   10.0.1.1
   5   10.0.1.5
   3   10.0.1.8
</pre></div></div><br class="figure-break"><p>The IP address 192.168.1.6 should be ignored since it is the IP
address of an in-path interface. The host with IP address 192.168.1.1
is using 112 TCP sessions.
</p><p>The next steps would be to find the TCP sessions for that host:
</p><div class="figure"><a name="idp37870504"></a><p class="title"><b>Figure 5.24. Get the list of TCP sessions for one specific host</b></p><div class="figure-contents"><pre class="screen">[~/systemdump-SH] edwin@t43&gt;grep 192.168.1.1 connection_table
10.0.1.1:6802 EAL_DEV_LAN 192.168.1.1:80 EAL_DEV_LOCAL CONN_ESTABLISHED 1338909287 0 NONE  \
    0 0 inpath0_0
10.0.1.1:6814 EAL_DEV_LAN 192.168.1.1:80 EAL_DEV_LOCAL CONN_CLOSED 1338909304 0 NONE 0 0 i \
    npath0_0
10.0.1.1:6832 EAL_DEV_LAN 192.168.1.1:80 EAL_DEV_LOCAL CONN_CLOSED 1338909308 0 NONE 0 0 i \
    npath0_0
10.0.1.1:6846 EAL_DEV_LAN 192.168.1.1:80 EAL_DEV_LOCAL CONN_ESTABLISHED 1338909329 0 NONE  \
    0 0 inpath0_0
10.0.1.1:6819 EAL_DEV_LAN 192.168.1.1:80 EAL_DEV_LOCAL CONN_CLOSED 1338909306 0 NONE 0 0 i \
    npath0_0
[...]
</pre></div></div><br class="figure-break"><p>So for this host most of the traffic went to the host with IP address
192.168.1.1 on TCP port 80.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37882216"></a>5.3.2. MAPI connection-based admission control</h3></div></div></div><p>On the network level, a MAPI session uses multiple TCP sessions to
communicate towards the Exchange server. All these TCP sessions
should be optimized and go through the same Steelhead appliances,
otherwise the latency optimization will not work properly and MAPI
connections can be interrupted.
</p><p>To prevent MAPI sessions from becoming partly optimized, the Steelhead
appliance can be configured to stop performing latency optimization
for new MAPI sessions when the Steelhead appliance is using 85% of
the maximum number of concurrent TCP sessions. Non-MAPI traffic
will still be optimized, new TCP sessions from current MAPI sessions
will still be optimized, only new TCP sessions from new MAPI sessions
will not be optimized anymore.
</p><div class="figure"><a name="idp37884008"></a><p class="title"><b>Figure 5.25. Output of the command "show admission internal"</b></p><div class="figure-contents"><pre class="screen">SH (config) # admission control mapi threshold 85
SH (config) # show admission internal
    TCP Memory Enabled:      yes
    CPU Utilization Enabled: no
    MAPI Enabled:            no
    MAPI Threshold:          85
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37885800"></a>5.3.3. Memory-based admission control</h3></div></div></div><p>During startup, the optimization process will allocate a large chunk
of memory for its own internal memory pool. When new optimized TCP
sessions get setup, memory from this pool will be allocated for its
data-structures and buffers.
</p><p>There are two situations where this memory-pool can run out of space
and the optimization service will go in memory-based admission
control:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The optimization service is servicing so many TCP connections
  that it uses all the available memory. When the Steelhead appliance
  constantly enters and leaves memory-based admission control, this
  is most likely what is happening. If it happens for the first
  time, the first step would be to create a system dump and open a
  case with Riverbed TAC.
</p><p>  The solution would be to reduce the amount of TCP sessions to be
  optimized via:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>In-path rules to disable optimization for certain TCP sessions.
</p></li><li class="listitem"><p>Additional hardware in a virtual in-path deployment cluster.
</p></li><li class="listitem"><p>The increase the capacity of the Steelhead appliance, either
    by a license upgrade or by a model upgrade.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The optimization service is allocating memory and never
  releasing it, this is called a memory-leak. If this happens, the
  first step would be to create a system dump and open a case with
  Riverbed TAC, but do not restart the optimization service yet.
  Unless the cause can be determined from the system dump provided,
  Riverbed TAC might want to obtain a process dump of the optimization
  service.
</p><p>  Once Riverbed TAC has all the required information, the immediate
  solution would be to restart the optimization service, the long term
  solution would be a software upgrade to a RiOS version where the
  memory-leak is resolved in.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37893480"></a>5.3.4. TCP Memory Pressure</h3></div></div></div><p>TCP Memory Pressure admission control happens when the optimization
service is running out of memory allocated for network buffers.
</p><div class="figure"><a name="idp37894568"></a><p class="title"><b>Figure 5.26. Optimizaiton service going into TCP Memory Pressure based admission control</b></p><div class="figure-contents"><pre class="screen">sport[9672]: [admission_control.NOTICE] - {- -} TCP Memory Pressure.
sport[9672]: [admission_control.WARN] - {- -} Pausing intercept: TCP Memory Pressure;
sport[9672]: [admission_control.NOTICE] - {- -} Memory Usage: 3298 Current Connections: 16 \
    55 TCP Memory Usage: 34869;
</pre></div></div><br class="figure-break"><p>This can happen because of a slow client or server or because of a
slow remote Steelhead appliance. The amount of memory used for every
TCP session can be found in the file
<span class="italics">sysinfo.txt</span>
in the system of the device:
</p><div class="figure"><a name="idp37930344"></a><p class="title"><b>Figure 5.27. Non-zero receive queues and non-zero send queues</b></p><div class="figure-contents"><pre class="screen">Output of 'netstat -a --numeric-hosts':"
[...]
Proto Recv-Q Send-Q Local Address           Foreign Address     State 
tcp        0 108228 192.168.1.6:23456       192.168.1.1:543     ESTABLISHED
tcp   208322      0 192.168.1.6:7801        10.0.1.6:1040       ESTABLISHED
</pre></div></div><br class="figure-break"><p>For the non-zero send queue, most likely there will be a large
amount of TCP sessions towards a single host. Determining this host
and finding out why it is so slow would be the next steps.
</p><p>For the non-zero receive queue, a case with Riverbed TAC should be
opened since this is a slowness towards the optimization service.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp37964712"></a>5.3.5. Optimized WAN bandwidth limitation</h3></div></div></div><p>Technically speaking this is not an admission control related issue,
the optimized WAN bandwidth limitation is a licensing related feature
which will limit the bandwidth of the outgoing optimized traffic.
This is not affecting pass-through traffic.
</p><p>Different models have different optimized WAN bandwidth limitations.
For example the 250M model has a limit of 1 Mbps, while the 250H
model has a limit of 2 Mbps. Not all the models have capped optimized
WAN bandwidth limitations, for example the 2050 model has a 45 Mbps
optimized WAN bandwidth speed which is not capped but up to which
the model is capable of running.
</p><p>This limitation is implemented by a 200 milliseconds separated burst
of traffic. This trace was taken for a transfer of a 1 Mb file via
a 250M model via an optimized TCP session with only TCP optimization
and no data reduction:
</p><div class="figure"><a name="idp37976936"></a><p class="title"><b>Figure 5.28. Wireshark I/O graph for a 1 Mbps optimized WAN bandwidth limit</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-04-wiresharkiograph.png" align="middle" width="100%" alt="Wireshark I/O graph for a 1 Mbps optimized WAN bandwidth limit"></td></tr></table></div></div></div><br class="figure-break"><div class="figure"><a name="idp37987112"></a><p class="title"><b>Figure 5.29. Wireshark TCP graph for a 1 Mbps optimized WAN bandwidth limit</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-04-wiresharktcpgraph.png" align="middle" width="100%" alt="Wireshark TCP graph for a 1 Mbps optimized WAN bandwidth limit"></td></tr></table></div></div></div><br class="figure-break"><p>It clearly shows the 200 ms interval during which no traffic is send.
</p><div class="figure"><a name="idp37990248"></a><p class="title"><b>Figure 5.30. Optimized Throughput graph for a 1 Mbps optimized WAN bandwidth limit</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-04-wanthroughput.png" align="middle" width="100%" alt="Optimized Throughput graph for a 1 Mbps optimized WAN bandwidth limit"></td></tr></table></div></div></div><br class="figure-break"><p>The Optimized Throughput graph is showing to be pegged at 1 Mbps.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp38032616"></a>5.4. Auto-negotiation and duplex issues</h2></div></div></div><p>As discussed before, the interface speed and duplex settings for
all Ethernet links on the path between the two Steelhead appliances
should configured and negotiated correctly.
</p><p>The symptoms for an incorrect configured or negotiation can be
determined via various ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Ping times to a remote site should be constant and without packet-loss.
</p></li><li class="listitem"><p>An unoptimized high-speed file transfer should have a consistent
  throughput.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38049320"></a>5.4.1. Ping times</h3></div></div></div><p>Under normal conditions, the response times for the ping command
should be constant. With problems in the interface speed and duplex
settings, this response time will fluctuate wildly because of constant
problems on this link in the network.
</p><div class="figure"><a name="idp38050600"></a><p class="title"><b>Figure 5.31. Ping through a clean network</b></p><div class="figure-contents"><pre class="screen">SH # ping 192.168.1.1
PING 192.168.1.1 (192.168.1.1): 56 data bytes
64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=147.372 ms
64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=140.338 ms
64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=137.355 ms
64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=137.144 ms
64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=137.219 ms
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp38060712"></a><p class="title"><b>Figure 5.32. Ping through a network with speed/duplex setting issues</b></p><div class="figure-contents"><pre class="screen">SH # ping 192.168.1.1
PING 192.168.1.1 (192.168.1.1): 56 data bytes
64 bytes from 192.168.1.1: icmp_seq=0 ttl=63 time=303.304 ms
64 bytes from 192.168.1.1: icmp_seq=1 ttl=63 time=253.271 ms
64 bytes from 192.168.1.1: icmp_seq=2 ttl=63 time=312.912 ms
64 bytes from 192.168.1.1: icmp_seq=3 ttl=63 time=264.712 ms
64 bytes from 192.168.1.1: icmp_seq=4 ttl=63 time=248.469 ms
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38062632"></a>5.4.2. Throughput tests</h3></div></div></div><p>This can be done on the Steelhead appliances but also on a client
and server behind the Steelhead appliances.
</p><p>These tests should only be done if the data stream is not affected
by QoS.
</p><p>Be aware that this determines the end-to-end packet-loss, not the
packet-loss on individual links in the path.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp38066664"></a>5.4.2.1. Ping flood</h4></div></div></div><p>A ping flood consists of the client sending out lots of ICMP Echo
Request packets and measuring the amount of received ICMP Echo
Response packets, making it possible to determine the packet-loss
on a link in the network.
</p><div class="figure"><a name="idp38085416"></a><p class="title"><b>Figure 5.33. Ping flood on a relative clean path in the network</b></p><div class="figure-contents"><pre class="screen">SH # ping -f -s 1400 -c 1000 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 1400(1428) bytes of data.

--- 192.168.1.1 ping statistics ---
1000 packets transmitted, 1000 received, 0% packet loss, time 13951ms
rtt min/avg/max/mdev = 131.142/133.056/134.008/0.561 ms, pipe 13, ipg/ewma 13.965/133.019  \
    ms
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp38090856"></a><p class="title"><b>Figure 5.34. Ping flood on a path with duplex configuration or negotiation issues.</b></p><div class="figure-contents"><pre class="screen">SH # ping -f -s 1400 -c 1000 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 1400(1428) bytes of data.
.......................................................................................... \
    ...................................................................................... \
    ...................................................................................... \
    .............................................
--- 192.168.1.1 ping statistics ---
1000 packets transmitted, 753 received, 24.7% packet loss, time 16701ms
rtt min/avg/max/mdev = 166.241/184.156/208.234/18.631 ms, pipe 13, ipg/ewma 16.701/160.190 \
     ms
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp38093160"></a>5.5. LAN speed maxed out</h2></div></div></div><p>Without WAN optimization, the maximum bandwidth utilization between
the WAN router and the LAN switch should not be more than the lowest
bandwidth coming going through the WAN.
</p><p>With WAN optimization, this balance doesn't exist anymore and the
LAN interface can become a new bottleneck.
</p><p>If your WAN bandwidth is 2 Mbps and LAN bandwidth is set to 10 Mbps,
then there is a high probability that the post-optimized traffic
will fill that 10 Mbps link.
</p><p>If your WAN bandwidth is 10 Mbps and the LAN bandwidth is set to
100 Mbps, then there is a reasonable probability that the post-optimized
traffic will fill that 100 Mbps link.
</p><div class="figure"><a name="idp38097000"></a><p class="title"><b>Figure 5.35. LAN bandwidth is more than 10 Mbps</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-04-wanthroughput.png" align="middle" width="100%" alt="LAN bandwidth is more than 10 Mbps"></td></tr></table></div></div></div><br class="figure-break"><p>If the reason for this 100 Mbps limit is a limitation of the switch,
then the switch should be replaced.
</p><p>If the reason for the 10 Mbps or 100 Mbps is because the interface
on the WAN router owned by the service provider is set a fixed speed
and duplex, then the service provider should be urged to reconfigure
the interface on the WAN router from a fixed speed and duplex
configuration to an auto-negotiation configuration. This way the LAN
interface on the Steelhead appliance can negotiate a gigabit
Ethernet link to the LAN switch while it can negotiate a lower speed
on the Ethernet link between the WAN interface and the WAN router.
</p><p>If the service provider cannot do this, a VLAN bridge can be
implemented.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp38120296"></a>5.6. Watchdogs</h2></div></div></div><p>As described earlier, the Steelhead appliance and the optimization
service have several hardware watchdogs and watchdog processes:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The hardware watchdog, which will reboot the appliance
  if the user-land process
<span class="italics">wdt</span>
  has not been communicated with the hardware watchdog for 30
  seconds. This prevents the Steelhead appliance to hang indefinitely
  and gives it a chance to recover.
</p><p>  This process communicates with the hardware watchdog every six
  seconds. If it is too late, the following line will be printed:
</p><div class="figure"><a name="idp38125736"></a><p class="title"><b>Figure 5.36. The wdt process is too slow</b></p><div class="figure-contents"><pre class="screen">SH wdt[11472]: [wdt.WARNING]: [lan1_0] watchdog poll late: 6265 with interval 6000 
</pre></div></div><br class="figure-break"><p>  The most likely cause is a problem with the hard disks.
</p></li><li class="listitem"><p>The network watchdog, which will put the by-pass card into
  fail-to-wire or fail-to-block mode if the optimization service
  hasn't communicated with the network watchdog for 7 seconds.
  This will remove the Steelhead appliance from the path in the
  network and the traffic flows again.
</p><p>  The optimization service communicates with the network watchdog
  every second. If it is too late, the following lines will be
  printed:
</p><div class="figure"><a name="idp38136616"></a><p class="title"><b>Figure 5.37. The optimization service is too slow</b></p><div class="figure-contents"><pre class="screen">SH sport[9367]: [ErWatchdog.NOTICE] - {- -} ether-relay watchdog poll late: 3491 period 10 \
    00 
SH sport[9367]: [null_watchdog.WARN] - {- -} null watchdog poll late: 3127 period 1000 
</pre></div></div><br class="figure-break"><p>  The most likely cause is a problem inside the optimization service
  and a case with Riverbed TAC should be opened.
</p></li><li class="listitem"><p>The software watchdog, a watchdog in the optimization service
  which checks if the threads inside the optimization service are
  still responsive enough or that they are blocked.
</p><div class="figure"><a name="idp38139944"></a><p class="title"><b>Figure 5.38. The optimization service has hung threads </b></p><div class="figure-contents"><pre class="screen">SH sport[5348]: [eventthread/watch/worker/4.WARN] - {- -} watcher: One or more threads not \
     responding after at least 20s; unhealthy threads follow
SH sport[5348]: [eventthread/watch/worker/4.WARN] - {- -} watcher:    EventThread(main)[LW \
    P 5348] 0x1c1a000 is not healthy
</pre></div></div><br class="figure-break"><p>  The most likely cause is a problem inside the optimization service
  and a case with Riverbed TAC should be opened.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp38158312"></a>5.7. Unexpected restarts of the optimization service</h2></div></div></div><p>There are two ways the optimization service gets aborted: 
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Because of an assertion failure. In this situation the operation service
  encounters a failure because a pre-condition hasn't been met.
</p></li><li class="listitem"><p>Because of a process failure. In this situation the operation service
  encounters a failure because of an unknown condition.
</p></li></ul></div><p>In both situations, the Steelhead appliance will generate a process dump.
When this happens, open a case with Riverbed TAC and provide them
with a system dump. The process dump might be requested later by
them.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38164136"></a>5.7.1. Clean restart of the optimization service</h3></div></div></div><p>When the optimization service gets restarted, either via the CLI or via
the GUI, the logs will show that the optimization service gets cleanly
shutdown:
</p><div class="figure"><a name="idp38189928"></a><p class="title"><b>Figure 5.39. Proper restart of the optimization service</b></p><div class="figure-contents"><pre class="screen">SH pm[11256]: [pm.NOTICE]: Terminating process sport 
SH sport[19125]: [signal.NOTICE] - {- -} /opt/rbt/bin/sport (pid 19125) received signal 2  \
    (SIGINT) 
SH pm[11256]: [pm.NOTICE]: Output from sport: /opt/rbt/bin/sport (pid 19125) received sign \
    al 2 (SIGINT) marking bit 
[...]
SH sport[19125]: [sport.NOTICE] - {- -} Sport is shutting down. 
SH sport[19125]: [sport.NOTICE] - {- -} Sport has cleanly shutdown. 
SH pm[11256]: [pm.NOTICE]: Launched sport with pid 19132 
SH sport[19132]: [sport.NOTICE] - {- -} Sport initializing... (main thread pid 19132)
SH sport[19132]: [sport.NOTICE] - {- -} AsyncLogger initialized, backlog 1000, shutdown ti \
    meout 30 
SH kernel:  &lt;5&gt;[intercept.NOTICE] Intercept paused since watchdog failed.
SH statsd[14594]: [statsd.NOTICE]: Alarm triggered for rising error for event bypass 
[...]
SH sport[19132]: [sport.NOTICE] - {- -} Sport ready. 
SH kernel: [intercept.NOTICE] Intercept unpaused , watchdog is normal.
SH wdt[14896]: [wdt.NOTICE]: Hardware watchdog change event.  Hardware Watchdog is now : e \
    nabled 
SH statsd[14594]: [statsd.NOTICE]: Alarm triggered for rising clear for event bypass 
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38191656"></a>5.7.2. Restart of the optimization service because of an assertion failure</h3></div></div></div><p>An assertion failure happens when the optimization service experiences
a pre-condition which wasn't met. This is put in the code by the
developers because they know this is a situation which shouldn't
happen and which will cause problems later on.
</p><p>It can be seen in the logs by the string
<span class="italics">received signal SIGABRT</span>
in the log files together with the string
<span class="italics">ASSERTION FAILED</span>.
After that a stack trace is captured and the optimization service
is restarted.
</p><div class="figure"><a name="idp38205160"></a><p class="title"><b>Figure 5.40. Optimization service restart because of an assertion failure</b></p><div class="figure-contents"><pre class="screen">SH sport[20486]: [assert.CRIT] - {- -} ASSERTION FAILED (true == cur_req_-&gt;req_.done()) at \
     ../protocol/http/http.cc:3064 
SH pm[11899]: [pm.ERR]: Output from sport: /opt/rbt/bin/sport (pid 20486) received signal  \
    6 (SIGABRT) dumping core 
SH pm[11899]: [pm.ERR]: Output from sport: /opt/rbt/bin/sport STACK TRACE: 0x2a959c75b0:/l \
    ib64/tls/libpthread.so.0:@0x2a959bb000+0x0000c5b0 0x2a961a026d:/lib64/tls/libc.so.6:gs \
    ignal@0x2a96172000+0x0002e26d 0x2a961a1a6e:/lib64/tls/libc.so.6:abort@0x2a96172000+0x0 \
    002fa6e 0x0084b448:/opt/rbt/bin/sport:@0x400000+0x0044b448 0x011c8682:/opt/rbt/bin/spo \
    rt:_ZN10HttpServer8proc_reqEP7DataBufj13HttpTransType@0x400000+0x00dc8682 0x0117bac7:/ \
    opt/rbt/bin/sport:_ZN8HttpUnit19proc_http_turbo_msgEP7DataBufj@0x400000+0x00d7bac7 0x0 \
    11bfd55:/opt/rbt/bin/sport:_ZN10HttpServer9proc_dataEP7DataBufjb@0x400000+0x00dbfd55 0 \
    x0117b8cf:/opt/rbt/bin/sport:_ZN12HttpConsumer7consumeEP7DataBufj@0x400000+0x00d7b8cf  \
    0x009244b5:/opt/rbt/bin/sport:_ZN7Decoder5flushEv@0x400000+0x005244b5 0x00923a31:/opt/ \
    rbt/bin/sport:_ZN7Decoder25handle_refs_disk_callbackEv@0x400000+0x00523a31 0x00923eaa: \
    /opt/rbt/bin/sport:_ZN7Decoder12handle_eventE11EventSource9EventTypePvS2_@0x400000+0x0 \
    0523eaa 0x009d6e7a:/opt/rbt/bin/sport:_ZN20sp_lookup_b
SH pm[11899]: [pm.WARNING]: Output from sport:  (pid 20486) Force Flushing AsyncLogger, ti \
    mestamps may be incorrect 
SH statsd[15655]: [statsd.NOTICE]: statsd/provider handle_session_close 68 
SH pm[11899]: [pm.NOTICE]: Process sport (pid 20486) terminated from signal 6 (SIGABRT) 
SH pm[11899]: [pm.WARNING]: Exit with code 1 from /sbin/fuser 
SH pm[11899]: [pm.WARNING]: Core file found in sport's working directory 
SH pm[11899]: [pm.NOTICE]: Waiting 1 seconds before relaunching sport 
SH kernel: [intercept.NOTICE] Intercept paused since watchdog failed.
SH statsd[15655]: [statsd.NOTICE]: Alarm triggered for rising error for event bypass 
SH sport[21850]: [sport.NOTICE] - {- -} Sport initializing... (main thread pid 21850)
SH pm[11899]: [pm.NOTICE]: Launched sport with pid 21850 
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38208040"></a>5.7.3. Restart of the optimization service because of a process failure</h3></div></div></div><p>A process failure happens when the optimization service experiences a
condition which causes the operation system to terminate the optimization
service.
</p><p>It can be seen in the logs by the string
<span class="italics">received signal SIGxxx</span>
but without the string
<span class="italics">ASSERTION FAILED</span>.
After that a stack trace is captured and the optimization service
is restarted.
</p><div class="figure"><a name="idp38217832"></a><p class="title"><b>Figure 5.41. Optimization service restart because of a process failure</b></p><div class="figure-contents"><pre class="screen">SH pm[5996]: [pm.ERR]: Output from sport: /opt/rbt/bin/sport (pid 14917) received signal 1 \
    1 (SIGSEGV) dumping core 
SH pm[5996]: [pm.ERR]: Output from sport: /opt/rbt/bin/sport STACK TRACE: 0x2a959c75b0:/li \
    b64/tls/libpthread.so.0:@0x2a959bb000+0x0000c5b0 0x012c36df:/opt/rbt/bin/sport:_ZN4Smb \
    212ClientParser22process_CreateResponseEPNS_14CreateResponseE@0x400000+0x00ec36df 0x01 \
    2aadce:/opt/rbt/bin/sport:_ZN4Smb215CompoundRequest17process_responsesEPNS_8Smb2ListI3 \
    PtrINS_12ResponseBaseEEEE@0x400000+0x00eaadce 0x0126b568:/opt/rbt/bin/sport:_ZN4Smb26P \
    arser17process_responsesERKNS_8Smb2ListI3PtrINS_12ResponseBaseEEEE@0x400000+0x00e6b568 \
     0x0126bb1f:/opt/rbt/bin/sport:_ZN4Smb212ClientParser18server_consume_smbEP7DataBufj@0 \
    x400000+0x00e6bb1f 0x00c9e5e9:/opt/rbt/bin/sport:_ZN4Cifs12CifsConsumer18process_data_ \
    queueEv@0x400000+0x0089e5e9 0x00c9e6ef:/opt/rbt/bin/sport:_ZN4Cifs12CifsConsumer15proc \
    ess_consumeEP7DataBufj@0x400000+0x0089e6ef 0x00c9d457:/opt/rbt/bin/sport:_ZNK5boost9fu \
    nction0IvEclEv@0x400000+0x0089d457 0x00c9be93:/opt/rbt/bin/sport:_ZN4Cifs10CifsParser9 \
    add_eventERKN5boost9function0IvEE@0x400000+0x0089be93 
SH pm[5996]: [pm.WARNING]: Output from sport:  (pid 14917) Force Flushing AsyncLogger, tim \
    estamps may be incorrect 
SH statsd[9264]: [statsd.NOTICE]: statsd/provider handle_session_close 4 
SH pm[5996]: [pm.NOTICE]: Process sport (pid 14917) terminated from signal 11 (SIGSEGV) 
SH pm[5996]: [pm.WARNING]: Exit with code 1 from /sbin/fuser 
SH pm[5996]: [pm.WARNING]: Core file found in sport's working directory 
SH pm[5996]: [pm.NOTICE]: Waiting 1 seconds before relaunching sport 
SH mgmtd[5997]: [mgmtd.NOTICE]: Sending email to event recipients 
SH kernel: [intercept.NOTICE] Intercept paused since watchdog failed.
SH statsd[9264]: [statsd.NOTICE]: Alarm triggered for rising error for event bypass 
SH mgmtd[5997]: [mgmtd.NOTICE]: Sending email to event recipients 
SH sport[11613]: [sport.NOTICE] - {- -} Sport initializing... (main thread pid 11613)
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp38221352"></a>5.8. Unexpected reboots</h2></div></div></div><p>Unexpected reboots can happen for three reasons: Kernel panics,
power failures and hardware watchdog initiated reboots.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38222824"></a>5.8.1. Kernel panics</h3></div></div></div><p>The optimization service runs on top of a Linux kernel. When there
is a problem in the kernel, it will panic and reboot the machine.
Problems in the kernel can be either caused by software (for example
a reference to a invalid block of memory or a divide by zero) or
by hardware (errors in the memory-sticks). When this happens, the
kernel will try to create a crash dump and reboot. During startup
the startup scripts will detect these crash dumps and extract the
necessary information from it.
</p><div class="figure"><a name="idp38224552"></a><p class="title"><b>Figure 5.42. Reboot caused by a kernel panic</b></p><div class="figure-contents"><pre class="screen">localhost kernel: con_dump: restoring oops message, timestamp=1351785953 ---------
localhost kernel: divide error: 0000 [1] SMP 
localhost kernel: CPU 0 
localhost kernel: Pid: 0, comm: swapper Tainted: PF     2.6.9-34.EL-rbt-11902SMP
localhost kernel: RIP: 0010:[tcp_snack_new_ofo_skb+356/684] &lt;ffffffff8045d302&gt;{tcp_snack_n \
    ew_ofo_skb+356}
localhost kernel: RIP: 0010:[&lt;ffffffff8045d302&gt;] &lt;ffffffff8045d302&gt;{tcp_snack_new_ofo_skb+ \
    356}
localhost kernel: RSP: 0018:ffffffff806b4cc8  EFLAGS: 00010246
localhost kernel: RAX: 0000000000000551 RBX: 00000100755d5338 RCX: 0000000000000000
localhost kernel: RDX: 0000000000000000 RSI: 00000101286f7040 RDI: 00000100755d5338
localhost kernel: RBP: 00000100755d5000 R08: ffffffff01000000 R09: 00000101286f7040
localhost kernel: R10: 0000000000000000 R11: deaf1eed01000000 R12: 0000010074b5c034
localhost kernel: R13: 00000101286f7040 R14: 0000000000000295 R15: 0000000000000000
localhost kernel: FS:  0000000040401960(0000) GS:ffffffff80753e00(0000) knlGS:000000000000 \
    0000
localhost kernel: CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
localhost kernel: CR2: 0000002a98215000 CR3: 0000000000101000 CR4: 00000000000006e0
localhost kernel: Process swapper (pid: 0, threadinfo ffffffff80758000, task ffffffff805d9 \
    480)
localhost kernel: Stack: 00000100755d5338 ffffffff80460dc2 0000000000000001 00000100755d50 \
    00 
localhost kernel:        0000000000000003 000001012a83c800 0000000000000000 000001012a83c8 \
    00 
localhost kernel:        00000000ba098a8f ffffffff8046e25e 
localhost kernel: Call Trace:&lt;IRQ&gt; &lt;ffffffff80460dc2&gt;{tcp_rcv_state_process+2471} &lt;fffffff \
    f8046e25e&gt;{tcp_child_process+51} 
localhost kernel:        &lt;ffffffff8046a72a&gt;{tcp_v4_do_rcv+391} &lt;ffffffff8046ad4a&gt;{tcp_v4_r \
    cv+1449} 
localhost kernel:        &lt;ffffffff8044ad04&gt;{ip_local_deliver_finish+248} &lt;ffffffff8044ac0c \
    &gt;{ip_local_deliver_finish+0} 
localhost kernel:        &lt;ffffffff8043e7a2&gt;{nf_hook_slow+184} &lt;ffffffff8044b007&gt;{ip_local_ \
    deliver+552} 
localhost kernel:        &lt;ffffffff8044b20e&gt;{ip_rcv_finish+512} &lt;ffffffff8044b00e&gt;{ip_rcv_f \
    inish+0} 
localhost kernel:        &lt;ffffffff8043e7a2&gt;{nf_hook_slow+184} &lt;ffffffff8044b6d7&gt;{ip_rcv+11 \
    38} 
localhost kernel:        &lt;ffffffff80435528&gt;{netif_receive_skb+590} &lt;ffffffff804355eb&gt;{proc \
    ess_backlog+137} 
localhost kernel:        &lt;ffffffff804356f5&gt;{net_rx_action+129} &lt;ffffffff8013ac80&gt;{__do_sof \
    tirq+88} 
localhost kernel:        &lt;ffffffff8013ad29&gt;{do_softirq+49} &lt;ffffffff8011311f&gt;{do_IRQ+328} 
localhost kernel:        &lt;ffffffff801107cb&gt;{ret_from_intr+0}  &lt;EOI&gt; &lt;ffffffff801
localhost kernel: con_dump: end of oops ------------------------------------
</pre></div></div><br class="figure-break"><p>When this happens, please open a case with Riverbed TAC for follow-up.
</p><p>In RiOS version 8.0 and later, there is the feature of a crash
kernel available: When a kernel panic happens, instead of that the
Steelhead appliance gets rebooted and the memory contents are lost,
the Steelhead appliance will reboot into a second kernel and is
able to collect all the memory contents for debugging later by
Riverbed engineering.
</p><div class="figure"><a name="idp38226728"></a><p class="title"><b>Figure 5.43. Enabling the crash kernel feature</b></p><div class="figure-contents"><pre class="screen">SH (config) # support show kexec
Kexec Mode Enabled: no 
SH (config) # support kexec enable
You must reboot the appliance for your changes to take effect
SH (config) # write memory
SH (config) # reload
</pre></div></div><br class="figure-break"><p>When this crash kernel feature is enabled, a kernel crash will take
longer than normal. Afterwards a file named
<span class="italics">kernel-crashdump-&lt;timestamp&gt;.tgz</span>
will be avalable in the process dump directory.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38242024"></a>5.8.2. Power failure caused reboots</h3></div></div></div><p>Power failure is either when the power to the power supplies fails
or when a power supply fails. On the xx20 series models without a
hardware RAID controller and on the xx50, CX and EX series models,
this kind of reboots can be identified by checking the SMART status
of the hard disks. In case of a power off/on, the value of the
<span class="italics">Current Power Cycle Count</span>
attributes gets increased while in case of a reboot it doesn't get
increased.
</p><p>So by by searching for the lines
<span class="italics">Current Power Cycle Count</span>
and
<span class="italics">shutdown_check</span>
in the startup logs, the kind of reboot can be determined:
</p><div class="figure"><a name="idp38249768"></a><p class="title"><b>Figure 5.44. This device was rebooted because of loss of power.</b></p><div class="figure-contents"><pre class="screen">localhost disk: Drive=sda, Serial= 080806DP1D10DGGHV06P, Current Power Cycle Count=68, Las \
    t Power Cycle Count=66
[...]
localhost shutdown_check: Checking for unexpected shutdown
localhost shutdown_check: Detected unexpected shutdown!
localhost shutdown_check: 
localhost rc: Starting shutdown_check:  succeeded
</pre></div></div><br class="figure-break"><p>In this case the 
<span class="italics">Current Power Cycle Count</span>
was increased: This was a power related restart.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38253864"></a>5.8.3. Hardware watchdog initiated reboots</h3></div></div></div><p>The hardware watchdog is integrated on the motherboard and which
will reboot the appliance if the process
<span class="italics">wdt</span>
has not been communicated with the hardware watchdog for 30 seconds.
</p><p>This can happen when:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The kernel hangs and doesn't allow the user-land to run. This is
  a bad situation and the reboot will give the machine a chance to
  recover, hopefully without getting into the same situation again.
</p></li><li class="listitem"><p>The kernel is waiting for a hard disk to complete a read or write
  operation and it takes too long. This can happen when a hard disk
  is in the process of failing but its controller hasn't given up
  yet.
</p><p>  For non-RAID or non-FTS appliances, this might cause the Steelhead
  appliance to not come back since an essential hard disk has
  malfunctioned.
</p><p>  For RAID-appliances, this might be the first step for the RAID
  controller, RAID software or FTS process to determine that a disk
  is broken.
</p><div class="figure"><a name="idp38266024"></a><p class="title"><b>Figure 5.45. The watchdog interval was larger than expected.</b></p><div class="figure-contents"><pre class="screen">SH wdt[6805]: [wdt.WARNING]: watchdog poll late: 16415 with interval 1000 
</pre></div></div><br class="figure-break"><p>  In this example, the watchdog timer had been activated 16.415
  seconds after the last time instead if the expected one second.
</p></li></ul></div><p>Unlike the previous section, where the line
<span class="italics">Current Power Cycle Count</span>
had a different value for the current and last, a hardware watchdog
initiated reboot does not increase that value.
</p><div class="figure"><a name="idp38294312"></a><p class="title"><b>Figure 5.46. This device was rebooted by the hardware watchdog.</b></p><div class="figure-contents"><pre class="screen">localhost disk: Drive=sda, Serial= 080806DP1D10DGGHV06P, Current Power Cycle Count=68, Las \
    t Power Cycle Count=68
[...]
localhost shutdown_check: Checking for unexpected shutdown
localhost shutdown_check: Detected unexpected shutdown!
localhost shutdown_check: 
localhost rc: Starting shutdown_check:  succeeded
</pre></div></div><br class="figure-break"><p>In the file
<span class="italics">hardwareinfo.txt</span>,
which is found in a system dump and discussed in the section
<a class="xref" href="#systemdump_hardwareinformation" title="6.5. Hardware Information">Hardware Information</a>, the hardware watchdog initiated reboots can be seen in the IPMI log:
</p><div class="figure"><a name="idp38298536"></a><p class="title"><b>Figure 5.47. Determining reboots based on the IPMI logs</b></p><div class="figure-contents"><pre class="screen">Output of 'show_ipmi_info':

Motherboard '400-00100-01'

SEL Record ID          : 0005
 Record Type           : 02
 Timestamp             : 04/06/2011 15:56:54
 Generator ID          : 0020
 EvM Revision          : 04
 Sensor Type           : Critical Interrupt
 Sensor Number         : e7
 Event Type            : Sensor-specific Discrete
 Event Direction       : Assertion Event
 Event Data            : 03ffff
 Description           : Software NMI

SEL Record ID          : 0157
 Record Type           : 02
 Timestamp             : 04/06/2011 15:56:55
 Generator ID          : 0020
 EvM Revision          : 04
 Sensor Type           : Watchdog 2
 Sensor Number         : 81
 Event Type            : Sensor-specific Discrete
 Event Direction       : Assertion Event
 Event Data            : c104ff
 Description           : Hard reset
</pre></div></div><br class="figure-break"><p>Since RiOS version 7.0 a software NMI handler is called before the
hardware watchdog will reboot the device. This will be used to save
a copy of the kernel stack which can be retrieved in the next startup
of the device.
</p><p>When the hardware watchdog resets the Steelhead appliance, please
open a case with Riverbed TAC for investigation.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="operation_downgradenandupgradeissues"></a>5.9. Downgrade and upgrade issues</h2></div></div></div><p>The upgrade and downgrade process on Steelhead appliances is not
always straightforward. The following restrictions and caveats are
in place:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>You can only downgrade to RiOS versions which you have had
  installed on the Steelhead appliance. So if a certain Steelhead
  appliance comes installed with RiOS 5.0.6 and you have upgraded
  via 5.5.3, 6.0.1, 6.1.0 to 6.5.0, then you can only downgrade to
  these four versions.
</p><p>  Use the command
<code class="computeroutput">show version history</code>
  to see the list of previous installed RiOS versions.
</p><div class="figure"><a name="idp38330792"></a><p class="title"><b>Figure 5.48. Output of "show version history": Upgrade to 6.1.5, then downgrade to 6.1.4</b></p><div class="figure-contents"><pre class="screen">SH # show version history
Firstboot to rbt_sh 6.1.4 #92_4 2011-06-08 15:54:25 x86_64 root@palermo0:svn://svn/mgmt/br \
    anches/cook_92_fix_branch on Tue Dec  6 05:33:28 GMT 2011
Upgraded to rbt_sh 6.1.5 #104_8 2011-09-29 15:26:28 x86_64 root@athens:svn://svn/mgmt/bran \
    ches/cook_104_fix_branch on Wed Feb  1 23:30:34 GMT 2012
Downgraded to rbt_sh 6.1.4 #92_4 2011-06-08 15:54:25 x86_64 root@palermo0:svn://svn/mgmt/b \
    ranches/cook_92_fix_branch on Thu Feb  1 23:33:28 GMT 2012
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>When a Steelhead appliance gets upgraded, the latest configuration
  file used on that software version will be saved. When a Steelhead
  appliance gets downgraded, it will restart from that saved
  configuration. So if network configurations like the IP address
  of the in-path interface have been changed, after the move to the
  current version, that IP address will be changed back to the old
  IP address.
</p></li><li class="listitem"><p>A Steelhead appliance can only be upgraded to a software version
  which is released later, time wise, than the current one. So an
  upgrade from 5.5.9 to 6.0.0 is not allowed because 5.5.9 had been
  released later than 6.0.0 had been released.
</p></li><li class="listitem"><p>In general, when upgrading a Steelhead appliance to a new branch,
  for example from 5.0.x to 6.1.x, all branches should be touched.
  So the Steelhead appliance needs to be upgraded to 5.5.x and 6.0.x
  before the upgrade to 6.1.x can be done.
</p><p>  The
<span class="italics">Software Upgrade Path Tool</span>
  on the Riverbed Support website will tell which intermediate
  software versions can be used to upgrade between two branches.
</p><p>  There are several RiOS releases which are certified for direct
  upgrades, which mean that they can be upgraded to a different
  branch than the next one. To find out which ones, search the
  Riverbed Support KB system for "RiOS Direct Upgrade".
</p></li><li class="listitem"><p>When the Steelhead appliance is running RSP, the recommendation
  is to disable RSP before doing the upgrades and to install the
  correct version of RSP image at the end. After that RSP can be
  enabled again.
</p></li></ul></div><p>The steps in the upgrade process are the installation of the upgrade
image on the spare boot partition and, after a reboot into the new
boot partition, the upgrade of the current configuration into the
new software is performed.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38338600"></a>5.9.1. Upgrade via the CLI</h3></div></div></div><p>To perform the RiOS upgrade from the CLI, issue the following
commands. This example assumes that the image can be retrieved from
the web server images.example.com.
</p><div class="figure"><a name="idp38360104"></a><p class="title"><b>Figure 5.49. Manual upgrade via the CLI, new image installed on partition 1</b></p><div class="figure-contents"><pre class="screen">SH # show images
[...]
Last boot partition: 2
Next boot partition: 2
SH # image fetch http://images.example.com/rios/sh-5.5.3-i386.img
SH # image install sh-5.5.3-i386.img 1
SH # config term
SH (config) # image boot 1
SH (config) # write memory
SH (config) # reload
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38363048"></a>5.9.2. Force a downgrade</h3></div></div></div><p>If a downgrade is not possible because the downgrade image has never
been installed before, it will fail with the following error:
</p><div class="figure"><a name="idp38372136"></a><p class="title"><b>Figure 5.50. Downgrade was unsuccessful</b></p><div class="figure-contents"><pre class="screen">localhost mgmtd[6353]: [mgmtd.NOTICE]: Downgrade fallback in progress. 
localhost mgmtd[6353]: [mgmtd.NOTICE]: Downgrade fallback file /config/db/working-PROD-rbt \
    sh-VER-54b74c06 doesn't exist. Looking for the most recent file with version hash 54b7 \
    4c06. 
localhost mgmtd[6353]: [mgmtd.ERR]: db &amp; reg version hash mismatch, could not fallback eit \
    her. possibly due to module removed without upgrade rule 
localhost mgmtd[6353]: [mgmtd.NOTICE]: Downgrade: could not find file for working with ver \
    sion hash 54b74c06 to downgrade to. 
localhost mgmtd[6353]: [mgmtd.WARNING]: Configuration 'working' is damaged! 
localhost mgmtd[6353]: [mgmtd.NOTICE]: mgmtd exiting at 2013/11/12 22:23:23 with code 1401 \
    0 
localhost mdinit: failed.
localhost mdinit: Forcing reboot from fallback image 1
</pre></div></div><br class="figure-break"><p>To force a downgrade to a RiOS version which has not been installed
before, use the commands
<code class="computeroutput">image install &lt;image&gt; &lt;partition&gt; force</code>
and
<code class="computeroutput">image boot &lt;partition&gt; force</code>.
This will wipe the configuration including the license keys, so
make sure to keep a copy of them. Also make sure to clear the data
store afterwards, because a proper downgrade has not been performed.
</p><p>The
<span class="italics">force</span>
in the
<code class="computeroutput">image install</code>
command skips the check to see if the image to be installed is
newer than the current image during the installation phase.
</p><p>The
<span class="italics">force</span>
in the
<code class="computeroutput">image boot</code>
command skips the check to see there is a saved configuration
available for the new version during the downgrade phase.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38378920"></a>5.9.3. New features after an upgrade</h3></div></div></div><p>After an upgrade, new features are often disabled by default. Because
the configuration displayed with the command
<code class="computeroutput">show running-config</code>
doesn't show the configuration lines which still have their default
values, the new features will often not show up. If during a later
upgrade that feature becomes enabled by default, the configuration
on the Steelhead appliance will show this feature to be disabled.
</p><div class="table"><a name="idp38380648"></a><p class="title"><b>Table 5.1. Example of configuration changes for the Simplified Routing feature for the value "none"</b></p><div class="table-contents"><table summary='Example of configuration changes for the Simplified Routing feature for the value "none"' border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td>RiOS version</td><td>Default value</td><td>Configured value</td><td>Displayed value</td></tr><tr><td>5.5</td><td>none</td><td>none</td><td>(nothing)</td></tr><tr><td>6.0</td><td>dest-only</td><td>none</td><td>in-path simplified routing "none"</td></tr></tbody></table></div></div><br class="table-break"><div class="table"><a name="idp38387112"></a><p class="title"><b>Table 5.2. Example of configuration changes for the Simplified Routing feature for the value "dest-only"</b></p><div class="table-contents"><table summary='Example of configuration changes for the Simplified Routing feature for the value "dest-only"' border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td>RiOS version</td><td>Default value</td><td>Configured value</td><td>Displayed value</td></tr><tr><td>5.5</td><td>none</td><td>dest-only</td><td>in-path simplified routing "dest-only"</td></tr><tr><td>6.0</td><td>dest-only</td><td>dest-only</td><td>(nothing)</td></tr></tbody></table></div></div><br class="table-break"><div class="table"><a name="idp38401512"></a><p class="title"><b>Table 5.3. Example of configuration changes for the Simplified Routing feature for the value "all"</b></p><div class="table-contents"><table summary='Example of configuration changes for the Simplified Routing feature for the value "all"' border="1"><colgroup><col><col><col><col></colgroup><tbody><tr><td>RiOS version</td><td>Default value</td><td>Configured value</td><td>Displayed value</td></tr><tr><td>5.5</td><td>none</td><td>all</td><td>in-path simplified routing "all"</td></tr><tr><td>6.0</td><td>dest-only</td><td>all</td><td>in-path simplified routing "all"</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38407464"></a>5.9.4. Failures during the installation phase</h3></div></div></div><p>An installation failure will be logged in the system logs:
</p><div class="figure"><a name="idp38408552"></a><p class="title"><b>Figure 5.51. Various upgrade failure scenarios</b></p><div class="figure-contents"><pre class="screen">SH mgmtd[4229]: [mgmtd.WARNING]: Image install failed. -- The upgrade image provided is in \
    compatible with the architecture of this appliance's hardware.  Please provide an imag \
    e for the x86_64 architecture. 
</pre></div></div><br class="figure-break"><p>The following failures are possible:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="italics">The upgrade image provided is incompatible with this appliance</span>,
which happens when a non-Steelhead image is being installed on the
Steelhead appliance.
</p></li><li class="listitem"><p>
<span class="italics">The upgrade image provided does not support this model</span>
or
<span class="italics">The upgrade image provided is incompatible with the architecture</span>
<span class="italics">of this appliance's hardware. Please provide an image for the</span>
<span class="italics">x86_64 architecture</span>
or
<span class="italics">The upgrade image provided is incompatible with the architecture</span>
<span class="italics">of this appliance's hardware. Please provide an image for the</span>
<span class="italics">i386 architecture</span>,
which happens when the provided upgrade image has the wrong CPU
architecture, 32-bit instead of 64-bit or the other way around.
</p></li><li class="listitem"><p>
<span class="italics">The upgrade image provided is too old.  Please use a newer image.</span>
<span class="italics">See log for more details</span>,
which happens when the upgrade image doesn't know about this model
Steelhead appliance yet.
</p></li><li class="listitem"><p>
<span class="italics">Unable to partition the disk to install image. Please retry,</span>
<span class="italics">contact support if problem persists</span>
or
<span class="italics">Unable to create filesystem for upgrade image. Please retry,</span>
<span class="italics">contact support if problem persists</span>
or
<span class="italics">Cannot find the image layout for machine. Please retry, contact</span>
<span class="italics">support if problem persists</span>
or
<span class="italics">Partitions used to upgrade image are already mounted. Please</span>
<span class="italics">unmount partitions manually before retrying</span>
or
<span class="italics">Could not get the upgrade image. Please check the url if using</span>
<span class="italics">a remote image</span>,
which happens when there is a problem during the installation with
one of the partitions on the Steelhead appliance.
</p></li><li class="listitem"><p>
<span class="italics">The upgrade image provided does not pass validation. Please check</span>
<span class="italics">the to make sure the correct image is used for upgrade</span>,
which happens when there is a problem with extracting the image. Use
the command
<code class="computeroutput">show images checksum</code>
to compare the MD5 checksum of the upgrade image with the MD5
checksums found on the Riverbed Support website.
</p></li><li class="listitem"><p>
<span class="italics">Error mounting tmpfs to upgrade image. Please contact support</span>,
which happens when the mounting of a installation partition fails.
</p></li><li class="listitem"><p>
<span class="italics">No space left on disk to install image. Please contact support</span>,
which happens when the target installation partition is full.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38455976"></a>5.9.5. Upgrade failed, CLI doesn't become available anymore</h3></div></div></div><p>If for a certain reason the upgrade was successful and the Steelhead
appliance comes back but doesn't allow CLI or GUI access: This means
that a back out of the upgrade cannot be performed.
</p><p>The way out of this would be to hook up a serial console to the
Steelhead appliance and reboot the device. After the BIOS, the Grub
bootloader will show up with the text
<code class="computeroutput">Press any key to continue...</code>.
After pressing a key, the two boot partitions are displayed. Use
the
<span class="italics">v</span>
and the
<span class="italics">^</span>
to select the pre-upgrade boot image and press enter. After the
downgrade, access to the Steelhead appliance should be available
again and the Riverbed TAC should be involved to determine why after
the upgrade the connectivity failed.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp38459560"></a>5.10. Time related issues - The NTP service.</h2></div></div></div><p>Having all your network devices operate on a synchronized time is
essential for reporting and troubleshooting. Further, to achieve
Active Directory integration, the clock on the Steelhead appliance
needs to be in sync with the clock on the Domain Controllers.
</p><p>By default the Steelhead appliance has the NTP service enabled
against a couple of NTP clocks on the public Internet. If the
Steelhead appliances do not have access to the public Internet and
the network does not have an internal NTP server, then the Steelhead
appliances should sync to the clock on the Domain Controllers.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38460904"></a>5.10.1. Configuration of the NTP service</h3></div></div></div><p>In the configuration of the NTP service you specify a number of NTP
servers.
</p><p>Note that using the hostnames from the riverbed.pool.ntp.org pool
of NTP servers returns geographically local IP addresses which might
not match the IP addresses seen on other return statuses.
</p><div class="figure"><a name="idp38462312"></a><p class="title"><b>Figure 5.52. The standard NTP service configuration</b></p><div class="figure-contents"><pre class="screen">SH # show running
[...]
no ntp disable
   ntp server ftp.riverbed.com enable
   ntp server ftp.riverbed.com version "4"
   ntp server 0.riverbed.pool.ntp.org enable
   ntp server 0.riverbed.pool.ntp.org version "4"
   ntp server 1.riverbed.pool.ntp.org enable
   ntp server 1.riverbed.pool.ntp.org version "4"
   ntp server 2.riverbed.pool.ntp.org enable
   ntp server 2.riverbed.pool.ntp.org version "4"
   ntp server 3.riverbed.pool.ntp.org enable
   ntp server 3.riverbed.pool.ntp.org version "4"
[...]

SH # show ntp
NTP enabled: yes
No NTP peers configured.
NTP server: 208.70.196.25 (version 4)   Enabled: yes
NTP server: 121.0.0.42 (version 4)      Enabled: yes
NTP server: 202.60.94.11 (version 4)    Enabled: yes
NTP server: 203.23.237.200 (version 4)  Enabled: yes
NTP server: 203.192.179.98 (version 4)  Enabled: yes
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38463592"></a>5.10.2. Determining the status of the NTP service</h3></div></div></div><p>In RiOS version 6.5 and later the status of the NTP service can
be seen with the command
<code class="computeroutput">show ntp status</code>:
</p><div class="figure"><a name="idp38465384"></a><p class="title"><b>Figure 5.53. Status of the NTP service with the command "show ntp status"</b></p><div class="figure-contents"><pre class="screen">SH # show ntp status
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 ntp.tourism.wa. 130.95.179.80    2 u   13   64    1  1702.52  667.275   0.002
 ns.creativecont .STEP.          16 u  985   64    0    0.000    0.000   0.002
+cachens2.onqnet 209.81.9.7       2 u    6   64    1  772.591  218.753   0.002
+ds001.hostingsh 203.12.160.2     3 u  173   64  374  105.205   40.096  35.771
+wireless.org.au 17.83.253.7      3 u  173   64  374  111.738   12.724  35.467
*ftp.riverbed.co 203.161.12.165   3 u  172   64  374  114.232   -6.295  56.603
</pre></div></div><br class="figure-break"><p>The NTP service determines the best NTP server based on the
stratum (number of hops towards a reference clock), the delay (the
network delay towards the server), the offset between the received
time of the NTP server and the clock on the local machine and the
network jitter.
</p><p>A stratum of 16 means that the NTP server is unsynchronized.
</p><p>Instead of IP addresses, the refid can also contain the name of the
clock source, like
<span class="italics">.GPS.</span>
and
<span class="italics">.CDMA.</span>.
</p><p>The character in front of the remote clock explains how the NTP
service feels about it: A
<span class="italics">*</span>
means that this NTP server is the chosen peer to sync from, a
<span class="italics">+</span>
means that this NTP server is a backup in case the chosen peer
becomes unreachable.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp38557608"></a>5.10.3. Troubleshooting</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp38557800"></a>5.10.3.1. Expected behaviour</h4></div></div></div><p>Use the tcpdump tool to see if the NTP service is talking to the
NTP servers and if they answer back. NTP traffic is UDP based and
on both port 123 for the client and the server.
</p><div class="figure"><a name="idp38558120"></a><p class="title"><b>Figure 5.54. Tcpdump trace for NTP traffic</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni primary port ntp 
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on primary, link-type EN10MB (Ethernet), capture size 96 bytes
08:43:03.149487 IP 119.12.133.239.123 &gt; 202.158.218.239.123: NTPv4, Client, length 48
08:43:05.721339 IP 202.158.218.239.123 &gt; 119.12.133.239.123: NTPv4, Server, length 48
08:43:14.632504 IP 119.12.133.239.123 &gt; 192.189.54.17.123: NTPv4, Client, length 48
08:43:14.785459 IP 192.189.54.17.123 &gt; 119.12.133.239.123: NTPv4, Server, length 48
08:43:15.631914 IP 119.12.133.239.123 &gt; 119.148.74.66.123: NTPv4, Client, length 48
08:43:16.632304 IP 119.12.133.239.123 &gt; 119.63.208.27.123: NTPv4, Client, length 48
08:43:16.632433 IP 119.12.133.239.123 &gt; 192.189.54.17.123: NTPv4, Client, length 48
08:43:17.632670 IP 119.12.133.239.123 &gt; 119.148.74.66.123: NTPv4, Client, length 48
08:43:18.440873 IP 119.63.208.27.123 &gt; 119.12.133.239.123: NTPv4, Server, length 48
08:43:18.441874 IP 192.189.54.17.123 &gt; 119.12.133.239.123: NTPv4, Server, length 48
08:43:18.441971 IP 119.148.74.66.123 &gt; 119.12.133.239.123: NTPv4, Server, length 49
</pre></div></div><br class="figure-break"><p>Both client and server traffic is seen here, which means that the
NTP server is reachable and the Steelhead appliance is allowed to
talk to its NTP service.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp38558696"></a>5.10.3.2. No answer from the NTP service</h4></div></div></div><p>If the NTP server doesn't exist anymore or is configured to not
respond to the queries, no answers will be returned:
</p><div class="figure"><a name="idp38559016"></a><p class="title"><b>Figure 5.55. Tcpdump trace for NTP traffic</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni primary port ntp 
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on primary, link-type EN10MB (Ethernet), capture size 96 bytes
08:43:03.149487 IP 119.12.133.239.123 &gt; 202.158.218.239.123: NTPv4, Client, length 48
08:43:18.494871 IP 119.12.133.239.123 &gt; 202.158.218.239.123: NTPv4, Client, length 48
08:43:33.948712 IP 119.12.133.239.123 &gt; 202.158.218.239.123: NTPv4, Client, length 48
08:43:48.487123 IP 119.12.133.239.123 &gt; 202.158.218.239.123: NTPv4, Client, length 48
</pre></div></div><br class="figure-break"><p>Only client traffic is seen here, which means that the NTP server
is either unreachable or that the Steelhead appliance is not allowed
to talk to this NTP server.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp38559592"></a>5.10.3.3. Time offset is too big</h4></div></div></div><p>If the offset between the reference clock and the system clock is
too big, more than 30 minutes, then the NTP service will refuse to
synchronize and exit.
</p><p>To overcome this problem, either disable the NTP service, set the
clock of the Steelhead appliance with the command
<code class="computeroutput">clock set '&lt;yyyy/mm/dd hh:mm:ss&gt;'</code>
to a value close to the reference clock and then enable the NTP
service again. Or disable the NTP service, issue the command
<code class="computeroutput">ntpdate &lt;NTP server&gt;</code>
and restart the NTP service.
</p><div class="figure"><a name="idp39002984"></a><p class="title"><b>Figure 5.56. Manual adjusting the date/time with the command "ntpdate"</b></p><div class="figure-contents"><pre class="screen">SH (config) # show clock
Time: 12:12:20
Date: 2012/12/12
Zone: Australia Sydney
No active ntp peers
SH (config) # show ntp active-peers
No active ntp peers
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 static-96-226-1 139.78.135.14    2 u    2   64    1  209.560  3923152   0.000
 xen1.rack911.co 209.51.161.238   2 u    2   64    1  177.707  3923152   0.000
 lithium.constan 128.4.1.1        2 u    8   64    1  224.869  3923152   0.000
 240.140.8.72.in 64.147.116.229   2 u    7   64    1  172.970  3923152   0.000

     remote       conf  auth  key  
===================================
 static-96-226-1  yes   none  none 
 xen1.rack911.co  yes   none  none 
 lithium.constan  yes   none  none 
 240.140.8.72.in  yes   none  none 

SH (config) # no ntp enable 
SH (config) # ntpdate 0.riverbed.pool.ntp.org
26 Jan 21:59:13 ntpdate[12761]: step time server 208.68.36.196 offset 3923152.813162 sec
SH (config) # show clock
Time: 21:59:16
Date: 2013/01/26
Zone: Australia Sydney
No active ntp peers
SH (config) # ntp enable 
SH (config) # show ntp active-peers
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
-shed.galexander 204.163.51.41    3 u    9   64   37  168.203   -3.754   0.433
+xen1.rack911.co 209.51.161.238   2 u    4   64   37  177.716    5.831   0.301
+ec2-50-16-231-1 209.51.161.238   2 u    9   64   37  218.954    3.933   0.577
*lttleman.deekay 130.207.244.240  2 u    9   64   37  223.387    6.205   1.380

     remote       conf  auth  key  
===================================
 shed.galexander  yes   none  none 
 xen1.rack911.co  yes   none  none 
 ec2-50-16-231-1  yes   none  none 
 lttleman.deekay  yes   none  none 
</pre></div></div><br class="figure-break"><p>At the beginning the offset is nearly 4 million seconds, or 45 days.
After running the command
<code class="computeroutput">ntpdate 0.riverbed.pool.ntp.org</code>
the clock is correct again and after a couple of minutes the NTP
service shows up as synchronized again.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39004072"></a>5.11. Firewalls in the path</h2></div></div></div><p>From a network point of view, firewalls are routers with a stricter
set of policies than normal routers. Based on their configured
policies, they can interfere with the WAN optimization.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39004392"></a>5.11.1. Stripping of TCP options</h3></div></div></div><p>The TCP auto-discovery option and the TCP transparency option are
not officially registered TCP options with the IANA [SOURCE
http://www.iana.org/assignments/tcp-parameters/tcp-parameters.txt] and
therefore firewalls can chose not to trust them by default and
remove them from the TCP header.
</p><p>When the firewall disallows the Auto-Discovery TCP options and it
is stripped away from the SYN+ packet, the auto-discovery will fail
but an unoptimized TCP session will be setup as normal.
</p><p>When the firewall disallows the WAN visibility TCP options and it
is stripped away by firewalls, the setup of the inner-channel will
fail and after the third TCP SYN packet from the client an unoptimized
TCP session will be setup as normal.
</p><p>When the TCP SYN packet with the auto-discovery probe is blocked,
after the third TCP SYN packet from the client an unoptimized TCP
session will be setup as normal.
</p><div class="figure"><a name="idp39005096"></a><p class="title"><b>Figure 5.57. The TCP session goes into pass-through after the third SYN from the client</b></p><div class="figure-contents"><pre class="screen">SH kernel: [intercept.NOTICE] nat_check: SYN packet for already natted connection 10.0.1.1 \
    :56923 -&gt; 192.168.1.1:80 ==&gt; 10.0.1.1:56923 -&gt; 10.0.1.5:7801
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39005544"></a>5.11.2. Stateful firewalls</h3></div></div></div><p>A firewall might check state of the TCP session. The auto-discovery
of the optimized TCP session consists of a SYN+ and one or more
SYN/ACK+s, but no final ACK is seen. The firewall might send a TCP
RST packet after a timeout to reset the TCP connection on the client
and server because of this missing final TCP ACK.
</p><p>The sequence numbers of the TCP SYN packets seen during the
auto-discovery and the setup of the inner channel with a Full
Transparency WAN visibility differs: First the firewall sees the
SYN+ packet with sequence number X, a moment later it sees a TCP
SYN packet with the same IP addresses and TCP ports although with
transparency options with sequence number Y. A firewall might block
that packet or reset the TCP session. The way around this would be
using the Full Transparency with Firewall Reset WAN visibility.
</p><p>In this example, the auto-discovery happened in the first three
packets and then the client-side Steelhead sends the TCP RST in
packet 4. After that the inner channel gets setup in packet 5:
</p><div class="figure"><a name="idp39006120"></a><p class="title"><b>Figure 5.58. Setup of an inner channel with Full Transparency with Firewall Reset WAN visibility</b></p><div class="figure-contents"><pre class="screen">22:37:34.613669 IP 10.0.1.1.23090 &gt; 192.168.1.1.80: Flags [S], seq 1402966182, win 65535,  \
    options [mss 1460,nop,wscale 6,sackOK,TS val 3240829280 ecr 0,rvbd-probe AD CSH:10.0.1 \
    .6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
22:37:34.913093 IP 192.168.1.1.80 &gt; 10.0.1.1.23090: Flags [S.], seq 20020520, ack 14029661 \
    83, win 65535, options [rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
22:37:34.918955 IP 192.168.1.1.80 &gt; 10.0.1.1.23090: Flags [S.], seq 20020520, ack 14029661 \
    83, win 65535, options [rvbd-probe AD CSH:10.0.1.6 SSH:192.168.1.6:7800 11110a000106c0 \
    a801061e78,rvbd-probe EAD 0e3d,nop,eol], length 0
22:37:34.920476 IP 10.0.1.1.23090 &gt; 192.168.1.1.80: Flags [R], seq 1402966183, win 5840, o \
    ptions [rvbd-trans Transp sSH:10.0.1.6:40296 dSH:192.168.1.6:7800 01000a000106c0a80106 \
    9d681e78,nop,nop,nop,eol], length 0
22:37:34.920582 IP 10.0.1.1.23090 &gt; 192.168.1.1.80: Flags [S], seq 1335892636, win 5840, o \
    ptions [mss 1460,sackOK,TS val 3241303025 ecr 0,nop,wscale 2,rvbd-trans Transp sSH:10. \
    0.1.6:40296 dSH:192.168.1.6:7800 00000a000106c0a801069d681e78], length 0
22:37:35.223347 IP 192.168.1.1.80 &gt; 10.0.1.1.23090: Flags [S.], seq 1345286799, ack 133589 \
    2637, win 5792, options [mss 1460,sackOK,TS val 3241350970 ecr 3241303025,nop,wscale 2 \
    ,rvbd-trans Transp sSH:192.168.1.6:7800 dSH:10.0.1.6:40296 0000c0a801060a0001061e789d6 \
    8], length 0
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39006632"></a>5.11.3. Deep Packet Inspection</h3></div></div></div><p>This is a problem for inner channels with Port Transparency or Full
Transparency WAN visibility. When a DPI engine determines the
protocol based on the TCP port number of the server and expects a
certain protocol to be followed but gets the content of the inner
channel which doesn't make sense for it: It might block or reset
the TCP connection.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39007016"></a>5.11.4. Packet direction</h3></div></div></div><p>Firewalls can have the policy that when an IP packet comes in via
a certain network interface, it should not be forwarded back out
via that network interface. If an in-path interface of a Steelhead
appliance has its default gateway set to a firewall and the firewall
enforces this policy and there are multiple IP subnets behind the
Steelhead appliance, then the firewall will block traffic to these
IP subnets. The way around this is to set the default gateway to a
routing host on the LAN side and use Simplified Routing.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39007464"></a>5.12. Data Store Synchronization</h2></div></div></div><p>Data Store Synchronization is a technique which can be used for two
Steelhead appliances to synchronize their data stores so that both
Steelhead appliances have the same references known in their
data store. This not a feature specific for serial clusters or
high-availability clusters, but should also be used for parallel
clusters and Interceptor / WCCP clusters.
</p><div class="figure"><a name="idp39007784"></a><p class="title"><b>Figure 5.59. Data Store Synchronization can be used in various designs</b></p><div class="figure-contents"><pre class="screen"> .----------.               .----------.          .----------.          
 |  Router  |               |  Router  |          |  Router  |
 '----------'               '----------'          '----------'
      |                        |    |                 |
      |                   .----'    '---.         .--------.
      |                   |             |         |   IC   |
 .----------.             |             |         '--------'
 |   SH 1   |---.   .-----------.  .-----------.      |       .--------.
 '----------'   |   |    SH 1   |  |   SH 2    |      |   .---|  SH 1  |-.
      |         |   '-----------'  '-----------'      |   |   '--------' |
      |         |         |   |      |  |             |   |   .--------. |
 .----------.   |         |   '------'  |             |   |---|  SH 2  |-'
 |   SH 2   |---'         |             |             |   |   '--------'
 '----------'             |             |             |   |
      |              .----------.  .----------.  .----------.
      |              |  Switch  |  |  Switch  |  |  Switch  |
 .----------.        '----------'  '----------'  '----------'
 |  Switch  |
 '----------'
Serial deployment       Parallel deployment      Virtual in-path deployment
</pre></div></div><br class="figure-break"><p>This has two advantages:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If one of the Steelhead appliances fails, the other Steelhead
  appliance has a warm data store and can serve optimized data without
  having to learn all references again.
</p></li><li class="listitem"><p>If traffic between two sites goes via a cluster of parallel
  Steelhead appliances and the traffic takes a different path for
  the incoming and for the outgoing traffic, both Steelhead appliances
  will know the references and can use the references without having
  to learn it again.
</p></li></ul></div><p>
</p><p>When a Data Store Synchronization cluster gets configured, one of
the Steelhead appliances is made the master and other one is made
the slave. This has nothing to do with the direction of the flow
data but with which data store ID is used in the replicated data
store.
</p><p>When one of the Steelhead appliances fails, either the master or
the slave, the replacement Steelhead appliance will always have to
be configured to be the slave. The Steelhead appliance which didn't
get replaced will always become the master.
</p><p>When a Data Store Synchronization cluster gets unconfigured or the
Data Store Synchronization cluster gets redeployed in the network,
both the Steelhead appliances will need to have their data store
synchronization feature disabled and their data stores cleared (via
the command
<code class="computeroutput">restart clean</code>
on the CLI).  If this doesn't happen, both Steelhead appliances
will show Service Alarm errors because they will see a Steelhead
appliance in the network with the same data store ID and that is a
situation which should not happen.
</p><p>Data Store Synchronization clusters should be the same hardware and
run the same RiOS version. If there are mismatches the synchronization
service will throw an alarm and the status of the Steelhead appliance
will become degraded.
</p><p>When a Steelhead appliance in a Data Store Synchronization cluster
comes back after a reboot or power-down, all new references learned
are replicated from the other Steelhead appliance. In the log files
this can be seen as:
</p><div class="figure"><a name="idp39009832"></a><p class="title"><b>Figure 5.60. Data Store Synchronization catching up after a restart</b></p><div class="figure-contents"><pre class="screen">SH sport[123] [replicate/client.INFO] - {- -} Connected from: 40282 to: 7744 
SH sport[123] [replicate/client.NOTICE] - {- -} Client Connected to 10.23.18.212:7744 tota \
    l_pages: 85258240 pages_in_use: 85258238 
SH sport[123] [replicate/client.INFO] - {- -} Recvd header info with version: 3 store_id_: \
     482671 
SH sport[123] [replicate/storesync.INFO] - {- -}  current store_id: 482671 remote store_id \
    : 482671 
SH sport[123] [replicate/storesync.NOTICE] - {- -} Running with storeid 482671 
SH sport[123] [replicate/client.NOTICE] - {- -} Requesting keepup start 
SH sport[123] [replicate/client.NOTICE] - {- -} Requesting catchup start npages: 85258240 
SH sport[123] [replicate/client.INFO] - {- -} [ping] Scheduling ping every 60 seconds.  
SH sport[123] [replicate/sync_server.NOTICE] - {- -} Came to end of store.  Will end catch \
    up next time client request indexes. 
SH sport[123] [replicate/sync_server.NOTICE] - {- -} requesting end to catchup cur_page_:  \
    85258240 npages_: 85258240 
SH sport[123] [replicate/sync_server.NOTICE] - {- -} Done with catchup  Sent: 24573 pages  \
     
SH sport[123] [replicate/client.NOTICE] - {- -} client catchup is complete. catchup pages_ \
    written: 31720
</pre></div></div><br class="figure-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39010408"></a>5.13. Data store related errors</h2></div></div></div><p>The Data store is the database with references to frames the Steelhead
appliance has learned. There are two possible issues with regarding
to data store:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Data store identification, where the data store identifier is
  reused.
</p></li><li class="listitem"><p>Data store contents, with issues with regarding to references
  exchanged.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39011240"></a>5.13.1. Data store identification issues</h3></div></div></div><p>The Data store ID is a unique identifier to identify the data store
on a Steelhead appliance. There is only one reason why a data store
ID used on two Steelhead appliances could be the same and that is
because they are part of a data store synchronization cluster: The
backup node in the data store cluster will assume the data store
ID of the master node.
</p><p>Once a Steelhead is taken out of a data store synchronization
cluster, its data store should be cleared before redeploying it.
If this doesn't happen and the two Steelhead appliances detect each
other in the field, they will complain about the duplicate data
store ID.
</p><div class="figure"><a name="idp39011688"></a><p class="title"><b>Figure 5.61. Duplicate data store ID warnings from a former data store synchronization cluster node</b></p><div class="figure-contents"><pre class="screen">SH sport[123] [splice/oob.NOTICE] 1 {- -} Got a iochannel for an existing oob to peer: 192 \
    .168.1.6
SH sport[123] [splice/oob.ALERT] 1 {- -} ALARM Peer sport id (478552) is the same as mine! \
     Closing connection to peer with store id (478552) remote address (192.168.1.6:7800). 
SH sport[123] [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
</pre></div></div><br class="figure-break"><p>If this happens, remove the obsolete data store synchronization
configuration from the Steelhead appliance and restart the optimization
service in the GUI with the option
<span class="italics">Clear the data store</span>
or with the CLI command
<code class="computeroutput">restart clean</code>.
</p><p>Sometimes a data store synchronization cluster is deployed in a
serial cluster, and it is possible that the first Steelhead appliance
in the cluster will try to peer with the second Steelhead appliance
in the cluster. This will show up as:
</p><div class="figure"><a name="idp39012904"></a><p class="title"><b>Figure 5.62. Duplicate data store ID warning in a data store synchronization cluster</b></p><div class="figure-contents"><pre class="screen">SH sport[2967]: [sport/config_info.ALERT] - {- -} ALARM Peer (10.0.1.5) store id (685523)  \
    is the same as mine! Check for replicated datastore steelheads used as a peer.
</pre></div></div><br class="figure-break"><p>If this happens, add peering rules on the two Steelhead appliances to prevent
auto-discovery happening between the two of them:
</p><div class="figure"><a name="idp39013480"></a><p class="title"><b>Figure 5.63. Prevent optimization from the data store synchronization peer 192.168.1.7</b></p><div class="figure-contents"><pre class="screen">SSH1 # show in-path peering rules
Rule Type C Source             Destination        Port   Peer            SSL-Cap
---- ---- - ------------------ ------------------ ------ --------------- -------
1    pass A all-ip             all-ip             all    192.168.1.7     no-chk
      desc: Prevent optimization from SSH2 (inpath0_0)
1    pass A all-ip             all-ip             all    all-ipv4        in-cap
      desc: Default rule to passthrough connections destined to currently bypassed SSL cli \
    ent-server pairs
2    auto A all-ip             all-ip             443    all-ipv4        cap
      desc: Default rule to auto-discover and attempt to optimize connections destined to  \
    port 443 as SSL
def  auto A all-ip             all-ip             all    all-ipv4        no-chk
---- ---- - ------------------ ------------------ ------ --------------- -------
3 user added rule(s)
(C) Cloud-accel mode:            A=Auto
                                 P=Passthru
</pre></div></div><br class="figure-break"><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39013928"></a>5.13.1.1. Duplicate data store ID on Steelhead mobile clients.</h4></div></div></div><p>Data store IDs in Steelhead Mobile Clients are generated by the PCs
themselves when the Steelhead Mobile Client software is started for
the first time. Before Steelhead Mobile version 3.1.3, the source
for this Data store ID is the Security Identifier provided via the
Windows operating system.
</p><p>Although the Security Identifier is supposed to be unique, it is
not. For normal operation of the Windows operating system and the
various integrations into Active Directory, this is not an issue.
For applications which use it as a source of uniqueness for the
machine this is a problem.
</p><p>The source of the problem of duplicate data store IDs on Steelhead
mobile clients is caused by installation of new computers via cloning
them from a master computer: The clones of this master machine have the
same Security Identifier which will cause the creation of the same Data
store ID on the Steelhead Mobile Clients.
</p><div class="figure"><a name="idp39014568"></a><p class="title"><b>Figure 5.64. Detection of duplicate labels</b></p><div class="figure-contents"><pre class="screen">SH sport[123] [segpage.ERR] - {- -} Duplicate DEF {}25 hash 3792051065887642647 vs. 420433 \
    /96599509:1411#0{}115 hash 7975538566276211596, memcmp() -1
SH sport[123] [defunpacker.ALERT] - {- -} ALARM (clnt: 10.0.1.1:60663 serv: 192.168.1.1:53 \
     cfe: 10.0.1.1:2770 sfe: 192.168.1.5:7810) name maps to more than one segment has a st \
    eelhead been improperly installed and/or steelhead mobiles are sharing config files po \
    ssibly through copying or cloning?
</pre></div></div><br class="figure-break"><p>In this case the
<span class="italics">clnt</span>
and the 
<span class="italics">cfe</span>
are the same, which indicates that this is a Steelhead Mobile Client.
</p><p>To overcome this issue, the following steps need to be taken:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>After the installation of the Steelhead Mobile Client on the
  master machine, remove the configuration file
<code class="computeroutput">C:\Documents and Settings\All Users\Application Data\Riverbed\Steelhead_Mobile\config\sport.xml</code>.
</p></li><li class="listitem"><p>After the cloning of the machine, run the program
<code class="computeroutput">newsid.exe</code>
  on the newly cloned machine. This will cause it to generate a new
  Security Identifier.
</p></li><li class="listitem"><p>Stop the Steelhead Mobile Client, issue the command
<code class="computeroutput">rbtdebug --new-sid</code>
  in the directory
<code class="computeroutput">C:\Program Files\Riverbed\Steelhead Mobile</code>
  and restart the Steelhead Mobile Client.
</p></li><li class="listitem"><p>Restart the Steelhead Mobile Client with the command
<code class="computeroutput">rbtsport -C</code>
  in the directory
<code class="computeroutput">C:\Program Files\Riverbed\Steelhead Mobile</code>.
</p></li></ul></div><p>Now the Steelhead Mobile Client is ready to be used.
</p><p>Note that this issue is resolved in Steelhead Mobile Client version
3.1.3 and 3.2 and later where the Steelhead Mobile Client Data store
ID gets determined by a different method than the Security Identifier.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39018792"></a>5.13.2. Data store contents issues</h3></div></div></div><p>If there are multiple Steelhead appliances in the network
with the same Data store ID, data referencing will be hampered:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Steelhead appliance can have a reference with a label which
  the peer Steelhead appliance doesn't know about. The peer Steelhead
  appliance will request to have the definition send again and
  no error will be raised.
</p></li><li class="listitem"><p>The Steelhead appliance can generate a new reference with a label
  which the peer Steelhead appliance already has. Both Steelhead
  appliances will destroy the reference and raise an error.
</p></li><li class="listitem"><p>The Steelhead appliance can have a reference with a label which
  the peer Steelhead appliance has, but with a different checksum.
  Both Steelhead appliances will destroy the reference and an error
  will be raised.
</p></li></ul></div><p>In the log files it will show up like:
</p><div class="figure"><a name="idp39024040"></a><p class="title"><b>Figure 5.65. Detection of duplicate labels</b></p><div class="figure-contents"><pre class="screen">SH sport[123] [segpage.ERR] - {- -} Duplicate DEF {}25 hash 3792051065887642647 vs. 420433 \
    /96599509:1411#0{}115 hash 7975538566276211596, memcmp() -1
SH sport[123] [defunpacker.ALERT] - {- -} ALARM (clnt: 10.0.1.1:60663 serv: 192.168.1.1:53 \
     cfe: 10.0.1.5:2770 sfe: 192.168.1.5:7810) name maps to more than one segment has a st \
    eelhead been improperly installed and/or steelhead mobiles are sharing config files po \
    ssibly through copying or cloning?
</pre></div></div><br class="figure-break"><p>In this case the issue was happening between the Steelhead appliances
with in-path IP addresses of 192.168.250.1 and 192.168.7.12. The
TCP session it was optimizing had the IP addresses of 192.168.250.1
and 192.168.7.7.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39024616"></a>5.13.2.1. False alerts about duplicate labels</h4></div></div></div><p>When the data store on a Steelhead appliance gets cleared, the
contents are only forgotten on that Steelhead appliance but the
other devices in the network still have the references. In due time
they will be removed by garbage collection methods in the optimization
service, but for now they are there. If the Steelhead appliance
with the empty data store generates a new label which still exist
on another Steelhead appliance, the checksum of the new reference
will most likely not match the checksum of the old reference. The
Steelhead appliance which will receive the new definition will
detect this duplicate definition and complain about it with the
same kind of logs as above.
</p><p>Keeping track of when data stores are cleared is a good thing to
catch these false positives.
</p><p>To overcome this alarm, use the command
<code class="computeroutput">service error reset</code>:
</p><div class="figure"><a name="idp39025448"></a><p class="title"><b>Figure 5.66. Use of the command "service error reset"</b></p><div class="figure-contents"><pre class="screen">SH # service error reset
Please note that it may take a few seconds for the alarm to reset.
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39025960"></a>5.14. WCCP issues</h2></div></div></div><p>WCCP is a protocol which is used for the redirection of packets
from a WCCP router (read: the WAN router or LAN switch) to a set of
WCCP caches (read: the Steelhead appliances).
</p><div class="figure"><a name="idp39026280"></a><p class="title"><b>Figure 5.67. A WCCP setup</b></p><div class="figure-contents"><pre class="screen">     .-,(  ),-.     
  .-(          )-.         .----------------------------.      .--------.
 (     network     )-------| WCCP router                |------| Server |
  '-(          ).-'        '-------------.--------------'  |   '--------'
      '-.( ).-'                          |                 |   .--------.
                                .--------'--------,        '---| Server |
                                |                 |        |   '--------'
                           .------------.  .------------.  |   .--------.
                           | WCCP cache |  | WCCP cache |  '---| Server |
                           '------------'  '------------'      '--------'
WCCP router: 192.168.2.1
WCCP cache: 192.168.2.2
WCCP cache: 192.168.2.3
</pre></div></div><br class="figure-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39026728"></a>5.14.1. The configuration of a WCCP router and WCCP cache</h3></div></div></div><p>The WCCP router has one or more service-groups defined. A service-group
is a set of IP addresses and TCP port numbers which are directed
to a specific group of caches. By configuring multiple service-groups,
different groups of WCCP caches can be used for the redirection of
different kinds of traffic.
</p><p>The WCCP cache has one or more service-groups and every service-group
has one or more WCCP routers configured and various negotiable
options like the encapsulation method and the assignment type.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39027240"></a>5.14.2. Setup of operation of a WCCP cache</h3></div></div></div><p>The negotiation of a WCCP cache with the WCCP router is initiated
by the WCCP cache: It sends a WCCP HERE_I_AM packet to the WCCP
routers, which should be answered with a WCCP I_SEE_YOU packet.
</p><p>With tcpdump, this looks like:
</p><div class="figure"><a name="idp39027752"></a><p class="title"><b>Figure 5.68. Tcpdump of WCCP traffic</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni wan0_0 port 2048
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
16:57:40.916187 IP 192.168.2.2.2048 &gt; 192.168.2.1.2048: UDP, length 144
16:57:40.948061 IP 192.168.2.1.2048 &gt; 192.168.2.2.2048: UDP, length 140
16:57:50.927298 IP 192.168.2.2.2048 &gt; 192.168.2.1.2048: UDP, length 144
16:57:50.957309 IP 192.168.2.1.2048 &gt; 192.168.2.2.2048: UDP, length 140
</pre></div></div><br class="figure-break"><p>The UDP packet gets send from the in-path IP address of the Steelhead
appliance to the WCCP router IP address. If the WCCP router is
willing to accept the WCCP cache, it will send an UDP packet back.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39028328"></a>5.14.2.1. No answer from the WCCP router</h4></div></div></div><div class="figure"><a name="idp39028520"></a><p class="title"><b>Figure 5.69. Tcpdump of WCCP traffic</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni wan0_0 port 2048
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
16:57:40.916187 IP 192.168.2.2.2048 &gt; 192.168.2.1.2048: UDP, length 144
16:57:50.927298 IP 192.168.2.2.2048 &gt; 192.168.2.1.2048: UDP, length 144
</pre></div></div><br class="figure-break"><p>Besides the obvious two reasons, that the IP address of the WCCP
router is entered incorrectly on the WCCP cache or that the WCCP
router is not configured correctly, this will happen when the WCCP
options given by the WCCP cache are incompatible by the current
operation of the WCCP router:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The WCCP cache encapsulation and assignment options are not
  compatible with the capabilities of the WCCP router. For example
  the WCCP cache wants to use GRE forwarding, the WCCP router can
  only do L2 forwarding.
</p></li><li class="listitem"><p>This WCCP cache options are different from the options configured
  on the other WCCP caches in the same service group. In this scenario
  there will always be one WCCP cache joined to the WCCP router and
  the second one will not be successful.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39029544"></a>5.14.2.2. Invalid answer from the WCCP router</h4></div></div></div><p>It is possible that the IP address of the WCCP router configured
on the WCCP cache is not the source IP address of the WCCP I_SEE_YOU
packets returned and thus the packets are ignored by the WCCP cache.
</p><div class="figure"><a name="idp39029864"></a><p class="title"><b>Figure 5.70. Tcpdump of WCCP traffic</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni wan0_0 port 2048
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
16:57:40.916187 IP 192.168.2.2.2048 &gt; 172.16.3.2.2048: UDP, length 144
16:57:40.948061 IP 192.168.2.1.2048 &gt; 192.168.2.2.2048: UDP, length 140
16:57:50.927298 IP 192.168.2.2.2048 &gt; 172.16.3.2.2048: UDP, length 144
16:57:50.957309 IP 192.168.2.1.2048 &gt; 192.168.2.2.2048: UDP, length 140
</pre></div></div><br class="figure-break"><p>This could happen if the IP address of the WCCP router configured
on the WCCP cache is an HSRP or a loopback address and the answers
are coming from the IP address of the outgoing interface of the
WCCP router.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39030440"></a>5.14.3. Redirection of traffic towards a WCCP cache</h3></div></div></div><p>Once the WCCP session is successfully negotiated, it will redirect
packets as defined in the WCCP redirection list. This redirection
list should be applied on both the incoming WAN interface and the
incoming LAN interfaces.
</p><p>The best practice is to use inbound redirection of the interfaces
of the WCCP router: Packets redirected when they come in on the
interface will have had less processing done on them, leaving the
router free to do other important things like forwarding packets.
</p><p>If the WCCP router and the WCCP cache are on the same IP subnet,
L2 forwarding should be preferred over GRE encapsulation, to overcome
possible IP fragmentation overhead.
</p><p>When traffic or a certain kind of traffic does not get optimized,
the easiest way to find out what happens is on the Steelhead appliance
WAN interface with tcpdump:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the only traffic seen is traffic on UDP port 2048 and Ethernet
  broadcast traffic, then the WCCP router is not redirecting packets
  to the WCCP cache.
</p><div class="figure"><a name="idp39031464"></a><p class="title"><b>Figure 5.71. Tcpdump shows that the WCCP router is not forwarding packets to the WCCP cache</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni wan0_0 -c 100
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
16:57:40.916187 IP 192.168.2.2.2048 &gt; 192.168.2.1.2048: UDP, length 144
16:57:40.948061 IP 192.168.2.1.2048 &gt; 192.168.2.2.2048: UDP, length 140
16:57:42.123456 ARP, Request who-has 192.168.2.2 tell 192.168.2.5, length 46
16:57:44.654321 ARP, Request who-has 192.168.2.2 tell 192.168.2.5, length 46
16:57.48.932198 snap 0:0:c:20:0 CDP v2, ttl: 180s, checksum: 692 (unverified)
        Device-ID (0x01), length: 25 bytes: 'WCCP01.example.com'
16:57:50.927298 IP 192.168.2.2.2048 &gt; 192.168.2.1.2048: UDP, length 144
16:57:50.957309 IP 192.168.2.1.2048 &gt; 192.168.2.2.2048: UDP, length 140
</pre></div></div><br class="figure-break"><p>  The next steps would be checking the path the traffic takes and
  the WCCP redirection access-lists.
</p></li><li class="listitem"><p>If the output shows traffic coming from one side, as in only WAN
  side traffic to port 80 or only LAN side traffic from port 80,
  then the redirect lists on either the LAN side VLANs or the WAN
  side interfaces is incorrect.
</p><div class="figure"><a name="idp39032232"></a><p class="title"><b>Figure 5.72. Tcpdump shows that the traffic is only forwarded from the server to the client</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni wan0_0 port 80
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 96 bytes
12:07:09.598157 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [S.], seq 2971872340, ack 387224 \
    0794, win 5792, options [mss 1460,sackOK,TS val 285084142 ecr 5351449,nop,wsc
ale 2], length 0
12:07:09.602393 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [.], seq 1, ack 188, win 1716, o \
    ptions [nop,nop,TS val 285084146 ecr 5351589], length 0
12:07:09.875867 IP 192.168.1.1.80 &gt; 10.0.1.1.42825: Flags [P.], seq 1:1151, ack 188, win 1 \
    716, options [nop,nop,TS val 285084420 ecr 5351589], length 1150
12:07:10.881392 IP 192.168.1.6.80 &gt; 10.0.1.100.42825: Flags [.], seq 1151, ack 420, win 17 \
    16, options [nop,nop,TS val 285085425 ecr 5352869], length 0
12:07:11.106812 IP 192.168.1.6.80 &gt; 10.0.1.100.42825: Flags [P.], seq 1151:1663, ack 420,  \
    win 1716, options [nop,nop,TS val 285085651 ecr 5352869], length 512
</pre></div></div><br class="figure-break"><p>  The next steps would be to confirm that the forward traffic is
  going via the WCCP router and to check the redirection access-lists.
</p></li></ul></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="operation_asymmetricrouting"></a>5.15. Asymmetric Routing</h2></div></div></div><p>As described in an earlier chapter, Asymmetric Routing is one of
the reasons that auto-discovery for a TCP session expected to be
optimized fails due to network routing related issues:
</p><div class="figure"><a name="idp39033320"></a><p class="title"><b>Figure 5.73. Different forms of asymmetric routing.</b></p><div class="figure-contents"><pre class="screen"> .--------.
 |        |&lt;---------------------------------------.
 |        |-----------.     SYN/ACK+               |
 |        |   ACK     v                            |
 |        |         .-------------.          .-------------.
 |        |         |             |          |             |         .--------.
 |        |   SYN   |             |   SYN+   |             |   SYN+  |        |
 | Client |--------&gt;| Client-side |---------&gt;| Server-side |--------&gt;| Server |
 |        |&lt;--------| Steelhead   |&lt;---------| Steelhead   |&lt;--------|        |
 |        | SYN/ACK |             | SYN/ACK+ |             | SYN/ACK '--------'
 |        |         |             |          '-------------'            |  |
 |        |         |             |                                     |  |
 |        |         |             |                                     |  |
 |        |         |             |&lt;------------------------------------'  |
 |        |         '-------------'                SYN/ACK                 |
 |        |   ACK      ^                                                   |
 |        |------------'                                                   |
 |        |&lt;---------------------------------------------------------------'
 '--------'                     SYN/ACK
</pre></div></div><br class="figure-break"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>At the top the SYN/ACK+ sent from the server-side Steelhead
  appliance bypasses the client-side Steelhead appliance, that
  is called Client Side Asymmetry.
</p></li><li class="listitem"><p>When the SYN/ACK sent from the server bypasses the server-side
  Steelhead appliance, that is called Server Side Asymmetry.
</p></li><li class="listitem"><p>When the SYN/ACK sent from the server bypasses both the server-side
  and client-side Steelhead appliance Steelhead appliance, that
  is called Complete Asymmetry.
</p></li></ul></div><p>The solution to resolve asymmetric routing issues is simple: Make
sure that all traffic goes through the server-side and the client-side
Steelhead appliance. This can be done by adding additional by-pass
cards in the Steelhead appliance to cover all the links going out
of a site, or by rolling out multiple Steelhead appliances per site
and to use Connection Forwarding to inform the other Steelhead
appliances that all traffic for this TCP session should be forwarded
to this Steelhead appliance.
</p><p>The last form of Asymmetric Routing is SYN Retransmit, which
happens when the SYN+ packet does not get answered by either the
server or another Steelhead appliance, but when a normal TCP SYN
packet does get answered by the server.
</p><p>When asymmetric traffic is detected, the IP addresses pair gets
added to the asymmetric routing table and is passed-through for an
interval to normally establish unoptimized TCP sessions.
</p><div class="figure"><a name="idp39034792"></a><p class="title"><b>Figure 5.74. Asymmetric routing table via the CLI</b></p><div class="figure-contents"><pre class="screen">SH # show in-path asym-route-tab 

[IP 1]  [IP 2]  [reason]  [timeout (sec)]  [created]  [last used]

10.0.1.1 192.168.1.1 no-SYNACK 86237 (07/03/12 12:34:51) (07/03/12 12:34:51)
10.0.1.1 192.168.1.1 invalid-SYNACK 55035 (07/03/12 18:46:04) (07/03/12 20:26:48)
10.0.1.1 192.168.1.1 bad-RST 86350 (07/17/12 11:14:29) (07/17/12 11:14:30)
10.0.1.1 192.168.1.1 probe-filtered(not-AR) 298 (07/03/12 11:57:39) (07/03/12 11:57:39)
</pre></div></div><br class="figure-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39035240"></a>5.15.1. Normal flow of packets</h3></div></div></div><div class="figure"><a name="idp39035432"></a><p class="title"><b>Figure 5.75. Normal setup of an optimized TCP session on the network map</b></p><div class="figure-contents"><pre class="screen"> .--------.
 |        |         .-------------.          .-------------.
 |        |   SYN   |             |   SYN+   |             |   SYN+   .--------.
 | Client |--------&gt;| Client-side |---------&gt;| Server-side |-------- &gt;| Server |
 |        | SYN/ACK | Steelhead   | SYN/ACK+ | Steelhead   | SYN/ACK  |        |
 |        |&lt;---------             |&lt;---------|             |&lt;---------|        |
 |        |         |             |          |             |          '--------'
 |        |         |             |          '-------------'                   
 |        |         '-------------'
 '--------'
</pre></div></div><br class="figure-break"><p>With normal auto-discovery, you should see the naked SYN packet on
the LAN interface, the SYN+ packet on the WAN interfaces and the
SYN/ACK+ on the WAN interfaces, the SYN+ again and a SYN/ACK on the
server-side Steelhead appliance LAN interface, a SYN/ACK+ on the
WAN interfaces, some traffic on port 7800 on the WAN interfaces and
then a  ACK on the LAN interfaces of the server-side Steelhead
appliance and then a SYN/ACK and an ACK on the client-side Steelhead
appliance LAN interface.
</p><div class="figure"><a name="idp39036136"></a><p class="title"><b>Figure 5.76. Auto-discovery for of an optimized TCP session - Flow of packets</b></p><div class="figure-contents"><pre class="screen">      Client                CSH                 SSH                  Server
 1          ----- SYN -----&gt;
 2                             ----- SYN+ -----&gt;
 3                             &lt;--- SYN/ACK+ ---
 4                                                 ----- SYN+ -----&gt;
 5                                                 &lt;--- SYN/ACK ----
 6                             &lt;--- SYN/ACK+ ---
 7                             -- Setup Inner -&gt;
 8                                                 ----- ACK ------&gt;
 9          &lt;--- SYN/ACK ---
10          ----- ACK -----&gt;
</pre></div></div><br class="figure-break"><p>On the wire, it will look like this:
</p><div class="figure"><a name="idp39036712"></a><p class="title"><b>Figure 5.77. Auto-discovery for an optimized TCP session - tcpdump</b></p><div class="figure-contents"><pre class="screen">CSH LAN
12:50:33.020243 IP 10.0.1.1.61284 &gt; 192.168.1.1.50: Flags [S], seq 1526534172, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3783247869 ecr 0,sackOK,eol], length 0
12:50:33.153146 IP 192.168.1.1.50 &gt; 10.0.1.1.61284: Flags [S.], seq 4133019662, ack 152653 \
    4173, win 5792, options [mss 1460,sackOK,TS val 6324752 ecr 3783247869,nop,wscale 2],  \
    length 0
12:50:33.156482 IP 10.0.1.1.61284 &gt; 192.168.1.1.50: Flags [.], seq 1, ack 1, win 65535, op \
    tions [nop,nop,TS val 3783247998 ecr 6324752], length 0

CSH WAN
12:50:33.020331 IP 10.0.1.1.61284 &gt; 192.168.1.1.50: Flags [S], seq 1526534172, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3783247869 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
12:50:33.153021 IP 192.168.1.1.50 &gt; 10.0.1.1.61284: Flags [S.], seq 20020520, ack 15265341 \
    73, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 3783247869 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
12:50:33.153061 IP 192.168.1.1.50 &gt; 10.0.1.1.61284: Flags [S.], seq 20020520, ack 15265341 \
    73, win 65535, options [mss 1460,nop,wscale 3,TS val 3783247869 ecr 0,sackOK,rvbd-prob \
    e AD CSH:10.0.1.6 SSH:192.168.1.6:7800 11110a000106c0a801061e78,rvbd-probe EAD 0e3d,no \
    p,eol], length 0

SSH WAN
12:33:06.883718 IP 10.0.1.1.61284 &gt; 192.168.1.1.50: Flags [S], seq 1526534172, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3783247869 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
12:33:06.883823 IP 192.168.1.1.50 &gt; 10.0.1.1.61284: Flags [S.], seq 20020520, ack 15265341 \
    73, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 3783247869 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
12:33:06.884217 IP 192.168.1.1.50 &gt; 10.0.1.1.61284: Flags [S.], seq 20020520, ack 15265341 \
    73, win 65535, options [mss 1460,nop,wscale 3,TS val 3783247869 ecr 0,sackOK,rvbd-prob \
    e AD CSH:10.0.1.6 SSH:192.168.1.6:7800 11110a000106c0a801061e78,rvbd-probe EAD 0e3d,no \
    p,eol], length 0

SSH LAN
12:33:06.884044 IP 10.0.1.1.61284 &gt; 192.168.1.1.50: Flags [S], seq 2724579398, win 5840, o \
    ptions [mss 1460,sackOK,TS val 4294837098 ecr 0,nop,wscale 2,rvbd-probe AD CSH:10.0.1. \
    6 01010a0001060005,rvbd-probe EAD 0c05,nop,eol], length 0
12:33:06.884131 IP 192.168.1.1.50 &gt; 10.0.1.1.61284: Flags [S.], seq 3757738477, ack 272457 \
    9399, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 1624809945 ecr 429483709 \
    8], length 0
12:33:06.884177 IP 10.0.1.1.61284 &gt; 192.168.1.1.50: Flags [.], seq 1, ack 1, win 1460, opt \
    ions [nop,nop,TS val 4294837098 ecr 1624809945], length 0
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39037224"></a>5.15.2. How to identify the Client-side Asymmetry</h3></div></div></div><p>Client-side Asymmetry happens when the return traffic from the
server-side Steelhead appliance bypasses the client-side Steelhead
appliance and goes directly back to the client.
</p><div class="figure"><a name="idp39037544"></a><p class="title"><b>Figure 5.78. Client-side Asymmetry on the network map</b></p><div class="figure-contents"><pre class="screen"> .--------.
 |        |&lt;--------------------------------------.
 |        |-----------.     SYN/ACK+              |
 |        |   ACK     v                           |
 |        |         .-------------.         .-------------.
 |        |   SYN   |             |   SYN+  |             |         .--------.
 | Client |--------&gt;| Client-side |--------&gt;| Server-side |         | Server |
 |        |         | Steelhead   |         | Steelhead   |         |        |
 |        |         |             |         |             |         '--------'
 |        |         |             |         '-------------'                   
 |        |         '-------------'
 '--------'
</pre></div></div><br class="figure-break"><p>With Client-side Asymmetry, the packets seen are the naked SYN
packet on the LAN interface, the SYN+ packet on the WAN interfaces,
a SYN/ACK+ on the WAN interface of the server-side Steelhead appliance
and an ACK on the LAN interface of the client-side Steelhead
appliance.
</p><div class="figure"><a name="idp39038120"></a><p class="title"><b>Figure 5.79. Client-side Asymmetry - Flow of packets</b></p><div class="figure-contents"><pre class="screen">      Client                CSH                 SSH                  Server
 1          ----- SYN -----&gt;
 2                             ----- SYN+ -----&gt;
 3          &lt;---------------/ /-- SYN/ACK+ -----
 4          &lt;---------------/ /-- SYN/ACK+ -----
 5          ----- ACK ---------------------------------------------&gt;
</pre></div></div><br class="figure-break"><p>On the wire, it will look like this:
</p><div class="figure"><a name="idp39038696"></a><p class="title"><b>Figure 5.80. Client-side Asymmetry on the wire</b></p><div class="figure-contents"><pre class="screen">CSH LAN
12:42:20.243577 IP 10.0.1.1.61242 &gt; 192.168.1.1.50: Flags [S], seq 2702983144, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3782775016 ecr 0,sackOK,eol], length 0
12:42:20.314239 IP 10.0.1.1.61242 &gt; 192.168.1.1.50: Flags [.], seq 2702983145, ack 2002052 \
    1, win 65535, options [nop,nop,TS val 3782775083 ecr 3782775016], length 0

CSH WAN
12:42:20.243692 IP 10.0.1.1.61242 &gt; 192.168.1.1.50: Flags [S], seq 2702983144, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3782775016 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
12:42:20.314349 IP 10.0.1.1.61242 &gt; 192.168.1.1.50: Flags [.], seq 2702983145, ack 2002052 \
    1, win 65535, options [nop,nop,TS val 3782775083 ecr 3782775016], length 0

SSH WAN
12:24:53.637086 IP 10.0.1.1.61242 &gt; 192.168.1.1.50: Flags [S], seq 2702983144, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3782775016 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
12:24:53.637205 IP 192.168.1.1.50 &gt; 10.0.1.1.61242: Flags [S.], seq 20020520, ack 27029831 \
    45, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 3782775016 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
12:24:53.637713 IP 192.168.1.1.50 &gt; 10.0.1.1.61242: Flags [S.], seq 20020520, ack 27029831 \
    45, win 65535, options [mss 1460,nop,wscale 3,TS val 3782775016 ecr 0,sackOK,rvbd-prob \
    e AD CSH:10.0.1.6 SSH:192.168.1.6:7800 11110a000106c0a801061e78,rvbd-probe EAD 0e3d,no \
    p,eol], length 0
12:24:53.707892 IP 10.0.1.1.61242 &gt; 192.168.1.1.50: Flags [.], seq 1, ack 1, win 65535, op \
    tions [nop,nop,TS val 3782775083 ecr 3782775016], length 0
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39039144"></a><p class="title"><b>Figure 5.81. Client-side Asymmetry in the logs</b></p><div class="figure-contents"><pre class="screen">CSH kernel: [intercept.WARN] asymmetric routing between 10.0.1.1:61242 and 192.168.1.1:50  \
    detected (no SYN/ACK)
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39039656"></a>5.15.3. How to identify the Server-side Asymmetry</h3></div></div></div><p>Service-side Asymmetry happens when the return traffic from the
server bypasses the server-side Steelhead appliance and goes directly
to the client-side Steelhead appliance.
</p><div class="figure"><a name="idp39039976"></a><p class="title"><b>Figure 5.82. Server-side Asymmetry on the network map</b></p><div class="figure-contents"><pre class="screen"> .--------.
 |        |         .-------------.          .-------------.
 |        |   SYN   |             |   SYN+   |             |   SYN+  .--------.
 | Client |--------&gt;| Client-side |---------&gt;| Server-side |--------&gt;| Server |
 |        |         | Steelhead   |&lt;---------| Steelhead   |         |        |
 |        |         |             | SYN/ACK+ |             |         '--------'
 |        |         |             |          '-------------'            |
 |        |         |             |                                     |
 |        |         |             |                                     |
 |        |         |             |&lt;------------------------------------'
 |        |         '-------------'                SYN/ACK
 '--------'
</pre></div></div><br class="figure-break"><p>With Server-side Asymmetry, the packets seen are the naked SYN
packet on the LAN interface, the SYN+ and SYN/ACK+ packets on the
WAN interfaces, a SYN+ on the LAN interface of the server-side
Steelhead appliance and then a SYN/ACK on the client-side Steelhead
appliance WAN interface.
</p><div class="figure"><a name="idp39040552"></a><p class="title"><b>Figure 5.83. Server-side Asymmetry - Flow of packets</b></p><div class="figure-contents"><pre class="screen">      Client                CSH                   SSH                 Server
 1          ----- SYN -----&gt;
 2                             ----- SYN+ -------&gt;
 3                             &lt;---- SYN/ACK+ ----
 4                                                   ----- SYN+ -----&gt;
 5                             &lt;------------------/ /--- SYN/ACK -----
</pre></div></div><br class="figure-break"><p>On the wire, it will look like this:
</p><div class="figure"><a name="idp39041128"></a><p class="title"><b>Figure 5.84. Server-side Asymmetry on the wire</b></p><div class="figure-contents"><pre class="screen">CSH LAN
10:51:35.610009 IP 10.0.1.1.65116 &gt; 192.168.1.1.50: Flags [S], seq 3361390561, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3862289659 ecr 0,sackOK,eol], length 0
10:51:35.768643 IP 192.168.1.1.50 &gt; 10.0.1.1.65116: Flags [S.], seq 64094818, ack 45721004 \
    4, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 493782756 ecr 1312273], len \
    gth 0

CSH WAN
10:51:35.610117 IP 10.0.1.1.65116 &gt; 192.168.1.1.50: Flags [S], seq 3361390561, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3862289659 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
10:51:35.766684 IP 192.168.1.1.50 &gt; 10.0.1.1.65116: Flags [S.], seq 20020520, ack 33613905 \
    62, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 3862289659 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
10:51:35.769341 IP 192.168.1.1.50 &gt; 10.0.1.1.65116: Flags [S.], seq 64094818, ack 45721004 \
    4, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 493782756 ecr 1312273], len \
    gth 0

SSH WAN
10:33:56.895288 IP 10.0.1.1.65116 &gt; 192.168.1.1.50: Flags [S], seq 3361390561, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3862289659 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
10:33:56.895407 IP 192.168.1.1.50 &gt; 10.0.1.1.65116: Flags [S.], seq 20020520, ack 33613905 \
    62, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 3862289659 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0

SSH LAN
10:33:56.896551 IP 10.0.1.1.65116 &gt; 192.168.1.1.50: Flags [S], seq 457210043, win 5840, op \
    tions [mss 1460,sackOK,TS val 1312273 ecr 0,nop,wscale 2,rvbd-probe AD CSH:10.0.1.6 01 \
    010a0001060005,rvbd-probe EAD 0c05,nop,eol], length 0
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39041576"></a><p class="title"><b>Figure 5.85. Server-side Asymmetry in the logs</b></p><div class="figure-contents"><pre class="screen">CSH kernel: [intercept.WARN] asymmetric routing between 192.168.1.1:50 and 10.0.1.1:65116  \
    detected (invalid SYN/ACK)
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39042024"></a>5.15.4. How to identify the Complete Asymmetry</h3></div></div></div><p>Complete Asymmetry happens when the return traffic from the
server bypasses both the Steelhead appliances and goes directly
to the client.
</p><div class="figure"><a name="idp39042344"></a><p class="title"><b>Figure 5.86. Complete Asymmetry on the network map</b></p><div class="figure-contents"><pre class="screen"> .--------.
 |        |         .-------------.          .-------------.
 |        |   SYN   |             |   SYN+   |             |   SYN+  .--------.
 | Client |--------&gt;| Client-side |---------&gt;| Server-side |--------&gt;| Server |
 |        |         | Steelhead   |&lt;---------| Steelhead   |         |        |
 |        |         |             | SYN/ACK+ |             |         '--------'
 |        |         |             |          '-------------'               |
 |        |         '-------------'                                        |
 |        |   RST      ^                                                   |
 |        |------------'                                                   |
 |        |&lt;---------------------------------------------------------------'
 '--------'                     SYN/ACK
</pre></div></div><br class="figure-break"><p>With Complete Asymmetry, the packets seen are the naked SYN packet
on the LAN interface, the SYN+ packet on the WAN sides and the
SYN/ACK+ on the WAN interface, a SYN+ on the server-side Steelhead
appliance LAN interface and a RST on the client-side Steelhead
appliance LAN interface.
</p><div class="figure"><a name="idp39042920"></a><p class="title"><b>Figure 5.87. Complete Asymmetry - Flow of packets</b></p><div class="figure-contents"><pre class="screen">      Client                CSH                   SSH                 Server
 1          ----- SYN -----&gt;
 2                             ----- SYN+ -------&gt;
 3                             &lt;---- SYN/ACK+ ----
 4                                                   ----- SYN+ -----&gt;
 5          &lt;---------------/ /-------------------/ /--- SYN/ACK -----
 6          ----- RST -----------------------------------------------&gt;
</pre></div></div><br class="figure-break"><p>On the wire, it will look like this:
</p><div class="figure"><a name="idp39043496"></a><p class="title"><b>Figure 5.88. Complete Asymmetry on the wire</b></p><div class="figure-contents"><pre class="screen">CSH LAN
11:14:29.879623 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [S], seq 3888516971, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3863658656 ecr 0,sackOK,eol], length 0
11:14:29.953403 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [R], seq 1895386924, win 0, leng \
    th 0

CSH WAN
11:14:29.879773 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [S], seq 3888516971, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3863658656 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
11:14:29.953521 IP 192.168.1.1.50 &gt; 10.0.1.1.65268: Flags [S.], seq 20020520, ack 38885169 \
    72, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 3863658656 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
11:14:30.038356 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [R], seq 1895386924, win 0, leng \
    th 0

SSH WAN
10:56:51.168188 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [S], seq 3888516971, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3863658656 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
10:56:51.168305 IP 192.168.1.1.50 &gt; 10.0.1.1.65268: Flags [S.], seq 20020520, ack 38885169 \
    72, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 3863658656 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
10:56:51.317550 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [R], seq 1895386924, win 0, leng \
    th 0

SSH LAN
10:56:51.170499 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [S], seq 1895386923, win 5840, o \
    ptions [mss 1460,sackOK,TS val 2686747 ecr 0,nop,wscale 2,rvbd-probe AD CSH:10.0.1.6 0 \
    1010a0001060005,rvbd-probe EAD 0c05,nop,eol], length 0
10:56:51.317623 IP 10.0.1.1.65268 &gt; 192.168.1.1.50: Flags [R], seq 1895386924, win 0, leng \
    th 0
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39044008"></a><p class="title"><b>Figure 5.89. Complete Asymmetry in the logs</b></p><div class="figure-contents"><pre class="screen">CSH kernel: [intercept.WARN] asymmetric routing between 10.0.1.1 and 192.168.1.1 detected  \
    (bad RST)
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39044456"></a>5.15.5. How to identify TCP SYN retransmit</h3></div></div></div><p>SYN retransmit happens when there is no answer from the SYN+ packets
but when the naked SYN is forwarded it is answered by a SYN/ACK.
</p><div class="figure"><a name="idp39044776"></a><p class="title"><b>Figure 5.90. Complete Asymmetry on the network map</b></p><div class="figure-contents"><pre class="screen"> .--------.
 |        |         .-------------.          .-------------.
 |        |   SYN   |             | SYN+     |             |
 | Client |--------&gt;| Client-side |----&gt;...  | Server-side |
 |        |         | Steelhead   |---------&gt;| Steelhead   |
 |        |         |             |   SYN    |             |
 |        |         |             |&lt;---------|             |
 |        |         |             |  SYN/ACK '-------------'
 |        |         '-------------'
 '--------'
</pre></div></div><br class="figure-break"><p>With TCP SYN retransmit, the packets seen are the naked SYN packet
on the LAN interface, two SYN+ packets and a naked SYN packet on
the WAN interface of the client-side Steelhead appliance WAN
interface, only the naked SYN on the server-side Steelhead appliance
WAN interface and a SYN/ACK on the client-side and server-side
Steelhead appliances WAN interface.
</p><div class="figure"><a name="idp39045352"></a><p class="title"><b>Figure 5.91. TCP SYN retransmit - Flow of packets</b></p><div class="figure-contents"><pre class="screen">      Client                CSH                   SSH                 Server
 1          ----- SYN -----&gt;
 2                             ----- SYN+ ---&gt;...   
 3                             ----- SYN+ ---&gt;...
 4                             ----- SYN ----------------------------&gt;
 5          &lt;------------------------------------------- SYN/ACK -----
</pre></div></div><br class="figure-break"><p>On the wire, it will look like this:
</p><div class="figure"><a name="idp39045992"></a><p class="title"><b>Figure 5.92. TCP SYN retransmit on the wire</b></p><div class="figure-contents"><pre class="screen">CSH LAN
CSH # tcpdump -ni lan0_0 port 50
tcpdump: WARNING: lan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
11:48:48.001687 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [S], seq 1165704202, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3779692639 ecr 0,sackOK,eol], length 0
11:48:49.055780 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [S], seq 1165704202, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3779693654 ecr 0,sackOK,eol], length 0
11:48:50.160832 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [S], seq 1165704202, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3779694716 ecr 0,sackOK,eol], length 0
11:48:50.294530 IP 192.168.1.1.50 &gt; 10.0.1.1.60961: Flags [S.], seq 3036249837, ack 116570 \
    4203, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 1496970988 ecr 377969471 \
    6], length 0
11:48:50.297878 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [.], seq 1, ack 1, win 65535, op \
    tions [nop,nop,TS val 3779694847 ecr 1496970988], length 0

CSH WAN
CSH # tcpdump -ni wan0_0 port 50
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
11:48:48.001814 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [S], seq 1165704202, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3779692639 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
11:48:49.055894 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [S], seq 1165704202, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3779693654 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
11:48:50.160937 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [S], seq 1165704202, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3779694716 ecr 0,sackOK,eol], length 0
11:48:50.294456 IP 192.168.1.1.50 &gt; 10.0.1.1.60961: Flags [S.], seq 3036249837, ack 116570 \
    4203, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 1496970988 ecr 377969471 \
    6], length 0
11:48:50.297927 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [.], seq 1, ack 1, win 65535, op \
    tions [nop,nop,TS val 3779694847 ecr 1496970988], length 0

SSH WAN
SSH # tcpdump -ni wan0_0 port 50
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
11:48:50.230826 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [S], seq 1165704202, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 3779694716 ecr 0,sackOK,eol], length 0
11:48:50.234423 IP 192.168.1.1.50 &gt; 10.0.1.1.60961: Flags [S.], seq 3036249837, ack 116570 \
    4203, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 1496970988 ecr 377969471 \
    6], length 0
11:48:50.365821 IP 10.0.1.1.60961 &gt; 192.168.1.1.50: Flags [.], seq 1, ack 1, win 65535, op \
    tions [nop,nop,TS val 3779694847 ecr 1496970988], length 0
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39046440"></a><p class="title"><b>Figure 5.93. TCP SYN retransmit in the logs</b></p><div class="figure-contents"><pre class="screen">CSH kernel: [intercept.WARN] it appears as though probes from 10.0.1.1 to 192.168.1.1 are  \
    being filtered.  Passing through connections between these two hosts.
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="operation_iproutingrelatedissues"></a>5.16. IP Routing Related Issues</h2></div></div></div><p>In the simplest deployment scenario, an in-path deployment with the
same IP subnet behind the Steelhead appliance LAN interface as on
the in-path interface, the routing of packets coming from an in-path
interface is simple: All delivery is either on the local IP subnet
or to be sent to the default gateway of the IP subnet.
</p><p>When there are multiple IP subnets defined on the LAN behind the
Steelhead appliance or when the IP subnet on in-path interface is
different from the IP subnets of the LANs, this approach of a single
default gateway doesn't work anymore because traffic to the IP
subnets which is not on the in-path interface will be sent to the
default gateway on the WAN side of the Steelhead appliance instead
of to the router on the LAN side of the Steelhead appliance. This
causes that traffic to travel one extra hop, to be inspected by a
firewall which might not like the traffic, to be applied to QoS
rules defined on the WAN interface of the Steelhead appliance and
so on.
</p><div class="figure"><a name="idp39047528"></a><p class="title"><b>Figure 5.94. Steelhead appliance with multiple LANs behind it</b></p><div class="figure-contents"><pre class="screen">               192.168.0.0/24
 .------------.    ,----.    .------------.
 | WAN Router |----| SH |----| LAN Router |--- IP Subnet 1 / 192.168.1.0/24
 '------------'.9 W'----'L .8|            |
                             |            |--- IP Subnet 2 / 192.168.2.0/24
                             |            |
                             |            |--- IP Subnet 3 / 192.168.3.0/24
                             '------------'

WAN router MAC address: 00:0d:b9:17:28:dd
LAN router MAC address: 00:21:70:3e:6b:7f
Default gateway for Steelhead in-path interface: WAN router
</pre></div></div><br class="figure-break"><p>With the in-path interface being on the same IP subnet as the rest
of the hosts on the LAN side, in the auto-discovery phase there
will be two or three packets seen on the WAN interface: one incoming
SYN+ and one or two outgoing SYN/ACK+s, depending on if Enhanced
Auto Discovery is enabled or not.
</p><div class="figure"><a name="idp39048232"></a><p class="title"><b>Figure 5.95. Tcpdump of traffic if the in-path IP address is on the same IP subnet as the hosts on the LAN</b></p><div class="figure-contents"><pre class="screen">11:44:12.311915 00:0d:b9:17:28:dd &gt; 00:21:70:3e:6b:7f, ethertype IPv4 (0x0800), length 94: \
     10.0.1.1.49850 &gt; 192.168.1.1.50: Flags [S], seq 3346759466, win 65535, options [mss 1 \
    460,nop,wscale 1,nop,nop,TS val 2834406441 ecr 0,sackOK,nop,nop,rvbd-probe AD CSH:10.0 \
    .1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
11:44:12.312010 00:0e:b6:8c:7a:ed &gt; 00:0d:b9:17:28:dd, ethertype IPv4 (0x0800), length 86: \
     192.168.1.1.50 &gt; 10.0.1.1.49850: Flags [S.], seq 20020520, ack 3346759467, win 65535, \
     options [mss 1460,nop,wscale 1,nop,nop,TS val 2834406441 ecr 0,sackOK,nop,nop,rvbd-pr \
    obe EAD 0c01,nop,nop,nop,eol], length 0
11:44:12.312484 00:0e:b6:8c:7a:ed &gt; 00:0d:b9:17:28:dd, ethertype IPv4 (0x0800), length 94: \
     192.168.1.1.50 &gt; 10.0.1.1.49850: Flags [S.], seq 20020520, ack 3346759467, win 65535, \
     options [mss 1460,nop,wscale 1,TS val 2834406441 ecr 0,sackOK,rvbd-probe AD CSH:10.0. \
    1.6 SSH:192.168.1.6:7800 11110a000106c0a801061e78,rvbd-probe EAD 0e3d,nop,eol], length \
     0
</pre></div></div><br class="figure-break"><p>With the in-path interface being on a different IP subnet than the
rest of the hosts on the LAN side and the default gateway set to
the WAN router, there will be seven packets seen on the WAN interface:
One incoming SYN+, one outgoing SYN/ACK+, one forwarded SYN+ to the
server seen twice, one final ACK to the server seen twice and one
SYN/ACK+ back to the client-side Steelhead appliance.
</p><div class="figure"><a name="idp39048808"></a><p class="title"><b>Figure 5.96. Tcpdump of traffic on a different IP subnet behind the Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">11:44:25.629579 00:0d:b9:17:28:dd &gt; 00:21:70:3e:6b:7f, ethertype IPv4 (0x0800), length 94: \
     10.0.1.1.49853 &gt; 192.168.2.1.50: Flags [S], seq 3631007307, win 65535, options [mss 1 \
    460,nop,wscale 1,nop,nop,TS val 2834419715 ecr 0,sackOK,nop,nop,rvbd-probe AD CSH:10.0 \
    .1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
11:44:25.629695 00:0e:b6:8c:7a:ed &gt; 00:0d:b9:17:28:dd, ethertype IPv4 (0x0800), length 86: \
     192.168.2.1.50 &gt; 10.0.1.1.49853: Flags [S.], seq 20020520, ack 3631007308, win 65535, \
     options [mss 1460,nop,wscale 1,nop,nop,TS val 2834419715 ecr 0,sackOK,nop,nop,rvbd-pr \
    obe EAD 0c01,nop,nop,nop,eol], length 0
11:44:25.629966 00:0e:b6:8c:7a:ed &gt; 00:0d:b9:17:28:dd, ethertype IPv4 (0x0800), length 90: \
     10.0.1.1.49853 &gt; 192.168.2.1.50: Flags [S], seq 3498683517, win 5840, options [mss 14 \
    60,sackOK,TS val 11038597 ecr 0,nop,wscale 2,rvbd-probe AD CSH:10.0.1.6 01010a00010600 \
    05,rvbd-probe EAD 0c05,nop,eol], length 0
11:44:25.696347 00:0d:b9:17:28:dd &gt; 00:21:70:3e:6b:7f, ethertype IPv4 (0x0800), length 90: \
     10.0.1.1.49853 &gt; 192.168.2.1.50: Flags [S], seq 3498683517, win 5840, options [mss 14 \
    60,sackOK,TS val 11038597 ecr 0,nop,wscale 2,rvbd-probe AD CSH:10.0.1.6 01010a00010600 \
    05,rvbd-probe EAD 0c05,nop,eol], length 0
11:44:25.696686 00:0e:b6:8c:7a:ed &gt; 00:0d:b9:17:28:dd, ethertype IPv4 (0x0800), length 66: \
     10.0.1.1.49853 &gt; 192.168.2.1.50: Flags [.], seq 4162643507, ack 1520852933, win 1460, \
     options [nop,nop,TS val 11038663 ecr 2163923817], length 0
11:44:25.696790 00:0e:b6:8c:7a:ed &gt; 00:0d:b9:17:28:dd, ethertype IPv4 (0x0800), length 94: \
     192.168.2.1.50 &gt; 10.0.1.1.49853: Flags [S.], seq 20020520, ack 3631007308, win 65535, \
     options [mss 1460,nop,wscale 1,TS val 2834419715 ecr 0,sackOK,rvbd-probe AD CSH:10.0. \
    1.6 SSH:192.168.0.6:7800 11110a000106c0a800061e78,rvbd-probe EAD 0e3d,nop,eol], length \
     0
11:44:25.763141 00:0d:b9:17:28:dd &gt; 00:21:70:3e:6b:7f, ethertype IPv4 (0x0800), length 66: \
     10.0.1.1.49853 &gt; 192.168.2.1.50: Flags [.], seq 4162643507, ack 1520852933, win 1460, \
     options [nop,nop,TS val 11038663 ecr 2163923817], length 0
</pre></div></div><br class="figure-break"><p>Checking the source and destination MAC addresses of the packets,
you can see that the additional packets are the ones normally
expected on the LAN side of the Steelhead appliance. However, because
the default gateway is set to the WAN side router, currently they
are first send back to the WAN router which then forwards them to
the LAN router.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39049384"></a>5.16.1. Static Routing Configuration</h3></div></div></div><p>The first solution would be to configure the gateways to these IP
subnets behind the Steelhead appliance in the routing table of the
Steelhead in-path interface:
</p><div class="figure"><a name="idp39049704"></a><p class="title"><b>Figure 5.97. In-path interface gateways</b></p><div class="figure-contents"><pre class="screen">SH (config) # ip in-path route inpath0_0 192.168.1.0 /24 192.168.0.8
SH (config) # ip in-path route inpath0_0 192.168.2.0 /24 192.168.0.8
SH (config) # ip in-path route inpath0_0 192.168.3.0 /24 192.168.0.8

SH # show ip in-path route inpath0_0 static 
Destination       Mask              Gateway
default           0.0.0.0           192.168.0.8
192.168.1.0       255.255.255.0     192.168.0.8
192.168.2.0       255.255.255.0     192.168.0.8
192.168.3.0       255.255.255.0     192.168.0.8
</pre></div></div><br class="figure-break"><p>This is an administrative overhead which needs to be synchronized
every time a new IP subnet is defined behind the Steelhead appliance,
but it will make sure that the in-path interface does know the path
to the configured IP subnets.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39050280"></a>5.16.2. Simplified Routing Configuration</h3></div></div></div><p>Instead of having to configure all the IP subnets behind the LAN
interfaces of the Steelhead appliances, the Steelhead appliance can
learn the source and destination IP addresses of the packets received
by associating it with the source and destination MAC addresses of
the Ethernet frame.
</p><p>This way it will build a list of destination IP addresses and the
MAC address on the Ethernet segment they are reachable via.  IP
addresses not in the Simplified Routing table will be sent out via
the normal IP routing table.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39050728"></a>5.16.2.1. Learning from the sources, destinations, both or all</h4></div></div></div><p>The Simplified Routing method can populate the IP address and MAC
address combinations in the Simplified Routing table by looking at
different kinds of data:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Destination-only: The destination IP addresses and destination
  MAC addresses of optimized TCP sessions. This will populate the
  Simplified Routing table with the destination IP addresses based
  on the routing information to the destination IP addresses. This
  is the default since RiOS versions 6.0.
</p></li><li class="listitem"><p>Source and destination: Both the source and destination IP addresses
   of optimized TCP sessions.
</p></li><li class="listitem"><p>All: The source and destination IP addresses of all IP traffic,
  not only the optimized TCP sessions.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39051752"></a>5.16.2.2. Examining the Simplified Routing table</h4></div></div></div><div class="figure"><a name="idp39052008"></a><p class="title"><b>Figure 5.98. Overview of the simplified routing table, pre RiOS 8.0</b></p><div class="figure-contents"><pre class="screen">SH (config) # in-path simplified routing dest-only
SH # show in-path macmap-tables
    relay         ip_addr          mac_addr  vlan ref_count
inpath0_0        10.0.1.1 00:0d:b9:17:28:dd     0        1
inpath0_0     192.168.2.1 00:21:70:3e:6b:7f     0        1
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39052520"></a><p class="title"><b>Figure 5.99. Overview of the simplified routing table, RiOS 8.0 and later</b></p><div class="figure-contents"><pre class="screen">SH # show in-path macmap-tables
    relay         ip_addr          mac_addr  vlan ref_count valid
inpath0_0        10.0.1.1 00:0d:b9:17:28:dd     0         0   Yes
inpath0_0     192.168.2.1 00:21:70:3e:6b:7f     0         0   Yes
</pre></div></div><br class="figure-break"><p>So it knows that on inpath0_0 the host with IP address 10.0.1.1 is
behind the gateway with MAC address d4:9a:20:c2:52:0e. But it still
doesn't tell you if it is on the LAN or on the WAN side of the
in-path interface, you need the system dump for that.
</p><p>The file
<span class="italics">macmap_tables</span>
contains the table as above. The files
<span class="italics">mactab_entries</span>
in RiOS 5.5
and
<span class="italics">pkttab_entries</span>
in RiOS 6.0 and higher in the subdirectories of the
<code class="computeroutput">er/</code>
directory contains the link between the MAC addresses of the gateways
and the LAN or WAN side and the VLAN the gateway is in:
</p><div class="figure"><a name="idp39054376"></a><p class="title"><b>Figure 5.100. Matching the MAC addresses of the gateways with the LAN and WAN interfaces</b></p><div class="figure-contents"><pre class="screen">[~/sysdumps-SH] edwin@t43&gt;cat macmap_tables
inpath0_0        10.0.1.1 00:0d:b9:17:28:dd     0        1
inpath0_0     192.168.2.1 00:21:70:3e:6b:7f     0        1

[~/sysdumps-SH] edwin@t43&gt;ls -al er/*/pkttab_entries
-rw-r--r--  1 edwin  edwin   681 Jun  6  2012 er/0/pkttab_entries
-rw-r--r--  1 edwin  edwin   664 Jun  6  2012 er/1/pkttab_entries
-rw-r--r--  1 edwin  edwin  5343 Jun  6  2012 er/2/pkttab_entries

[~/sysdump-SH] edwin@t43&gt;cat er/0/pkttab_entries
ent/tot  ht[chain] p        addr           vlan   dev        type          hits  flaps p   \
     vlan_chg p   race
  1/  2   317[  0] 0  00:21:70:3e:6b:7f       0   lan0_0    EAL_DEV_LAN    0     0       0 \
           0     0     0
  2/  2   569[  0] 0  00:0d:b9:17:28:dd       0   wan0_0    EAL_DEV_WAN    509394     0    \
        0       0     0     0
</pre></div></div><br class="figure-break"><p>So the host with IP address 10.0.1.1 is on inpath0_0 behind the
gateway with MAC address 00:0d:b9:17:28:dd which is on the WAN side
of the inpath0_0 interface.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39054952"></a>5.16.2.3. What can go wrong?</h4></div></div></div><p>While in theory this should be fool proof since it learns from the
network there are a couple of scenarios to keep alert about.
</p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39055272"></a>5.16.2.3.1. Unlearning an entry from the macmap table.</h5></div></div></div><p>Pre RiOS 7.0.4 and 8.0, the Simplified Routing table could only be cleared
by rebooting the appliance. Once learned the entry could not be
unlearned, only overwritten with new information.
</p><p>With RiOS 7.0.4 and 8.0, the command
<code class="computeroutput">in-path simplified routing-entries flush &lt;interface&gt;</code>
will mark all the macmap table entries for a specific in-path
interface as invalid, causing them to be ignored until learned
again:
</p><div class="figure"><a name="idp39060200"></a><p class="title"><b>Figure 5.101. Unlearning entries from the macmap tables</b></p><div class="figure-contents"><pre class="screen">SH # in-path simplified routing-entries flush all
SH # show in-path macmap-tables
    relay         ip_addr          mac_addr  vlan ref_count valide_data   jiffies_update_l \
    ru
inpath0_0        10.0.1.1 00:0d:b9:17:28:dd     0         0    No          159168 59901600 \
    68
inpath0_0     192.168.2.1 00:21:70:3e:6b:7f     0         0    No          451650 59904525 \
    50
</pre></div></div><br class="figure-break"></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39060648"></a>5.16.2.3.2. Interface bonding</h5></div></div></div><p>Interface bonding consists of two interfaces on a server which
listen to the same IP address. It has been the experience that they
can be sending out packets with the MAC address of the non-master
interface but not accepting packets send to it. Switching to the
<span class="italics">Destination-Only</span>
Simplified Routing setting will overcome this problem.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39061288"></a>5.16.2.3.3. Connection Forwarding</h5></div></div></div><p>In a Connection Forwarding deployment, always use the
<span class="italics">Destination-Only</span>
Simplified Routing setting.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39061928"></a>5.16.2.3.4. Other in-path devices</h5></div></div></div><p>Other in-path devices behind or in front of the Steelhead appliance
can transparently generate the traffic, but will end up with the
source MAC address of the in-path device, causing the Steelhead
appliance to learn them.  Use the
<span class="italics">Destination-Only</span>
Simplified Routing setting in this situation.

</p></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39062632"></a>5.17. Alarms and health status</h2></div></div></div><p>The Steelhead appliance has various alarms which indicate a problem
with the Steelhead appliance in general or with the optimization
service specifically.
</p><p>To make sure you are informed about possible issues on the Steelhead
appliances, alarms can be send out via several methods:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>SNMP Traps - Configure the SNMP trap servers under Configure -&gt;
  System Settings -&gt; SNMP Basic. You can use the CLI configuration
  command 
<code class="computeroutput">snmp-server trap-test</code>
  to confirm that the SNMP trap gets delivered.
</p></li><li class="listitem"><p>Email alerts - Configure the email alerts under Configure -&gt;
  System Settings -&gt; Email. You can use the CLI command 
<code class="computeroutput">email send-test</code>
  to confirm that the email delivery works.
</p></li></ul></div><p>There are six styles of lines for reporting alarm related issues:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="italics">Alarm triggered for rising error</span>:
  An error condition has been set because of the monitored value
  being too high. This is before RiOS 7.0.
</p></li><li class="listitem"><p>
<span class="italics">Alarm triggered for rising clear</span>:
  An error condition caused by the monitored value being too high,
  has been cleared. This is before RiOS 7.0.
</p></li><li class="listitem"><p>
<span class="italics">Alarm triggered for falling error</span>:
  An error condition has been set because of the monitored value
  being too low. This is before RiOS 7.0.
</p></li><li class="listitem"><p>
<span class="italics">Alarm triggered for falling clear</span>:
  An error condition caused by the monitored value being too low,
  has been cleared. This is before RiOS 7.0.
</p></li><li class="listitem"><p>
<span class="italics">Alarm 'X' clearing</span>:
  An error condition has been cleared. This is on RiOS 7.0 and higher.
</p></li><li class="listitem"><p>
<span class="italics">Alarm 'X' triggering</span>:
  An error condition has been set. This is on RiOS 7.0 and higher.
</p></li></ul></div><p>The full output of the logging for alarms is:
</p><div class="figure"><a name="idp39075368"></a><p class="title"><b>Figure 5.102. Full output of a log entry for an alarm before RiOS 7.0</b></p><div class="figure-contents"><pre class="screen">SH statsd[312]: [statsd.NOTICE]: Alarm triggered for rising error for event xxx
</pre></div></div><p><br class="figure-break">
</p><p>and
</p><div class="figure"><a name="idp39076072"></a><p class="title"><b>Figure 5.103. Full output of a log entry for an alarm on RiOS 7.0 and later</b></p><div class="figure-contents"><pre class="screen">SH alarmd[29863]: [alarmd.NOTICE]: Alarm 'xxx' triggering 
</pre></div></div><p><br class="figure-break">
</p><p>With the introduction of RiOS 7.0 there are aggregate alarms, which
rise if one of the source alarms rises. The aggregation tree is
currently:
</p><div class="figure"><a name="idp39076904"></a><p class="title"><b>Figure 5.104. Aggregate alarm tree for RiOS 8.0</b></p><div class="figure-contents"><pre class="screen">health
 |\_ admission_control
 |    |\_ admission_conn
 |    |\_ admission_cpu
 |    |\_ admission_mapi
 |    |\_ admission_mem
 |     \_ admission_tcp
 |\_ arcount
 |\_ block_store
 |    \_ block_store:*
 |\_ bypass
 |\_ connection_forwarding
 |    |\_ cf_ipv6_incompatible_cluster
 |    |\_ disconnected_sh_alert
 |     \_ single_cf
 |         |\_ cf_ack_timeout_aggr
 |         |     \_ cf_ack_timeout:*
 |         |\_ cf_conn_failure_aggr
 |         |     \_ cf_conn_failure:*
 |         |\_ cf_conn_lost_eos_aggr
 |         |     \_ cf_conn_lost_eos:*
 |         |\_ cf_conn_lost_err_aggr
 |         |     \_ cf_conn_lost_err:*
 |         |\_ cf_keepalive_timeout_aggr
 |         |     \_ cf_keepalive_timeout:*
 |         |\_ cf_latency_exceeded_aggr
 |         |     \_ cf_latency_exceeded:*
 |          \_ cf_read_info_timeout_aggr
 |               \_ cf_read_info_timeout:*
 |\_ cpu_util_indiv
 |     \_ cpu:*:util
 |\_ datastore
 |    |\_ datastore_error
 |    |\_ datastore_sync_error
 |    |\_ disk_not_setup
 |     \_ store_corruption
 |\_ domain_join_error
 |\_ duplex
 |\_ flash_protection_failed
 |\_ fs_mnt
 |     \_ fs_mnt:*:full
 |\_ granite-core
 |     \_ granite-core:*
 |\_ hardware
 |    |\_ disk
 |    |     \_ disk_error:*
 |    |\_ fan_error
 |    |\_ flash_error
 |    |\_ ipmi
 |    |\_ memory_error
 |    |\_ other_hardware_error
 |    |\_ power_supply
 |    |\_ raid_disk_indiv
 |    |     \_ disk:*:status
 |     \_ ssd_wear
 |          \_ ssd_wear_warning:*
 |\_ high_availability
 |     \_ high_availability:*
 |\_ inbound_qos_wan_bw_err
 |\_ iscsi
 |     \_ iscsi:*
 |\_ lan_wan_loop
 |\_ licensing
 |    |\_ appliance_unlicensed
 |    |\_ autolicense_error
 |    |\_ autolicense_info
 |    |\_ license_expired
 |     \_ license_expiring
 |\_ link_duplex
 |     \_ link_state:*:half_duplex
 |\_ link_io_errors
 |     \_ link_state:*:io_errors
 |\_ linkstate
 |     \_ link_state:*:link_error
 |\_ lun
 |     \_ lun:*
 |\_ nfs_v2_v4
 |\_ optimization_service
 |    |\_ halt_error
 |    |\_ optimization_general
 |     \_ service_error
 |\_ outbound_qos_wan_bw_err
 |\_ paging
 |\_ path_selection_path_down
 |\_ pfs
 |    |\_ pfs_config
 |     \_ pfs_operation
 |\_ profile_switch_failed
 |\_ rsp
 |    |\_ rsp_general_alarm
 |    |\_ rsp_license_expired
 |    |\_ rsp_license_expiring
 |     \_ rsp_service
 |\_ secure_vault
 |    |\_ secure_vault_rekey_needed
 |    |\_ secure_vault_uninitialized
 |     \_ secure_vault_unlocked
 |\_ serial_cascade_misconfig
 |\_ smb_alert
 |\_ snapshot
 |     \_ snapshot:*
 |\_ ssl
 |    |\_ certs_expiring
 |    |\_ crl_error:*
 |    |\_ non_443_sslservers_detected_on_upgrade
 |     \_ ssl_peer_scep_auto_reenroll
 |\_ sticky_staging_dir
 |\_ sw_version_aggr
 |    |\_ mismatch_peer_aggr
 |    |     \_ mismatch_peer:*
 |     \_ sw_version_mismatch_aggr
 |          \_ sw_version:*
 |\_ system_detail_report
 |\_ temperature
 |    |\_ critical_temp
 |     \_ warning_temp
 |\_ uncommitted_data
  \_ vsp
      |\_ esxi_communication_failed
      |\_ esxi_disk_creation_failed
      |\_ esxi_initial_config_failed
      |\_ esxi_license
      |    |\_ esxi_license_expired
      |    |\_ esxi_license_expiring
      |     \_ esxi_license_is_trial
      |\_ esxi_memory_overcommitted
      |\_ esxi_not_set_up
      |\_ esxi_version_unsupported
      |\_ esxi_vswitch_mtu_unsupported
      |\_ virt_cpu_util_indiv
      |     \_ virt_cpu:*:util
      |\_ vsp_general_alarm
      |\_ vsp_service
      |\_ vsp_service_not_running
       \_ vsp_unsupported_vm_count
</pre></div></div><br class="figure-break"><p>If an alarm in one of the end-nodes gets triggered, the nodes above
it will get triggered too: So if the
<span class="italics">warning_temp alarm</span>
gets triggered, the
<span class="italics">temperature alarm</span>
will get triggered and the
<span class="italics">health alarm</span>
gets triggered.
</p><p>The examples of log messages in this section use a shorter notation
without the hostname, process name and severity.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39078440"></a>5.17.1. General alarms</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39078632"></a>5.17.1.1. Generic health alarm</h4></div></div></div><div class="figure"><a name="idp39078824"></a><p class="title"><b>Figure 5.105. Generic health alarm</b></p><div class="figure-contents"><pre class="screen">Alarm 'health' triggered
</pre></div></div><br class="figure-break"><p>This is the top level node which gets triggered when any of the
other alarms gets triggered.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39079400"></a>5.17.1.2. Certificates related alarms</h4></div></div></div><div class="figure"><a name="idp39079592"></a><p class="title"><b>Figure 5.106. Certificates related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'certs_expiring' triggered
Alarm 'crl_error:SSL_CAs' triggered
Alarm 'crl_error:SSL_Peering_CAs' triggered
Alarm 'ssl' triggered
Alarm 'ssl_peer_scep_auto_enroll' triggered

Alarm triggered for rising error for event certs_expiring
Alarm triggered for rising error for event crl_error
Alarm triggered for rising error for event ssl_peer_scep_auto_enroll
</pre></div></div><br class="figure-break"><p>The
<span class="italics">certs_expiring alarm</span>
gets triggered if any Root CA certificates or any SSL peering
certificates or any SSL server certificates are going to expire in
two months or already have expired.
</p><p>Any expired Root CA certificates can be safely removed if they are
not used by one of your SSL server certificates.
</p><p>The expired SSL peering certificates need to be reissued on the
Steelhead appliance itself.
</p><p>The expired SSL server certificates need to be obtained again from
the department which runs the SSL server and imported again on the
Steelhead appliance.
</p><p>Next steps: Check the expiry dates on the certificates in the
Certificate Authority and the certificates in the SSL server list.
</p><p>The
<span class="italics">crl_error alarm</span>
gets triggered when the LDAP server containing the Certificate
Revocation List cannot be contacted.
</p><p>Next steps: Check the connectivity and availability of the LDAP
server containing the CRL list.
</p><p>The
<span class="italics">ssl_peer_scep_auto_enroll alarm</span>
get triggered when the SCEP functionality, to enroll peering
certificates, has encountered an error.
</p><p>Next steps: Check the connectivity and the content of the LDAP
server.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39082024"></a>5.17.1.3. CPU load related alarms</h4></div></div></div><div class="figure"><a name="idp39082216"></a><p class="title"><b>Figure 5.107. CPU load related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'cpu_util_indiv' triggered
Alarm 'cpu:N:util' triggered

Alarm triggered for rising error for event cpu_util_indiv 
</pre></div></div><br class="figure-break"><p>These alarms get triggered when the usage on one of the CPU cores
exceeds a certain threshold. The CPU usage metric are generally
measured in four usage types: System, User, I/O Wait and Idle.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>System: The percentage of time the CPU spends in the kernel.
</p></li><li class="listitem"><p>User: The percentage of time the CPU spends in the user land
  (optimization service, the GUI, the CLI, the SNMP server etc).
</p></li><li class="listitem"><p>I/O Wait: The percentage of time the CPU is waiting for an I/O
  device to complete its actions. On the Steelhead appliance this
  is most likely to complete a read and write request to the hard
  disk.
</p></li><li class="listitem"><p>Idle: The percentage of time the CPU is waiting for interrupts
  to process.
</p></li></ul></div><p>Normally the CPU usage pattern should be more-or-less equal on all
CPUs. It can be different if:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>In a data recovery scenario with few TCP sessions which are all
  handled on one single CPU. This will show as a high User usage
  on one of the CPUs and not on the others.
</p><p>  This can be changed with the option Multi-Core Balancing at Configure -&gt;
  Optimization -&gt; Performance.
</p></li><li class="listitem"><p>PBR, WCCP and Interceptor redirected traffic is handled by a single
  thread, therefore it will be done on a single CPU. This will show
  up as a lot of System usage on one of the CPUs.
  
  For PBR and WCCP this can be resolved by only redirecting the traffic
  to be optimized and not the pass-through traffic.
</p><p>  On a 10Gbps bypass card, this issue has been resolved since RiOS 8.0
  by distributing this load over multiple CPUs.
</p></li><li class="listitem"><p>If there is a problem with one of the threads in the optimization
  service. This will show as a lot of user-land usage on one of the
  CPUs. Please open a case with Riverbed TAC to troubleshoot this.
</p></li></ul></div><p>The following reasons could be the reason for a generic high CPU
utilization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the CPU usage is mostly I/O Wait, then either one of the disks
  in the appliance has operational problems or there is a lot of
  encrypted traffic being optimized which causes a large amount of
  searching through the data store and a lot of writing of new
  segments. Inspecting the Traffic Summary and the SMART related
  part of the system dump would be the next steps.
</p></li><li class="listitem"><p>If the CPU usage is on average at 80-90% and the CPU pattern
  follows the traffic pattern, then it could just be that the machine
  is underpowered for the traffic load.
</p></li></ul></div><p>Next steps: Open a case with Riverbed TAC to determine the reason
for the high CPU load.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39085480"></a>5.17.1.4. License alarms</h4></div></div></div><div class="figure"><a name="idp39085672"></a><p class="title"><b>Figure 5.108. License alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'appliance_unlicensed' triggered
Alarm 'license_expired' triggered
Alarm 'license_expiring' triggered
Alarm 'licensing' triggered
Alarm 'autolicense_error' triggered
Alarm 'autolicense_info' triggered

Alarm triggered for rising error for event license 
Alarm triggered for rising error for event license 
</pre></div></div><br class="figure-break"><p>The appliance unlicensed alarm is raised when there is no MSPEC
license on the xx55 and xx60 platforms.
</p><p>One or more evaluation license keys on the Steelhead appliance are
expired or about to expire.
</p><div class="figure"><a name="idp39086376"></a><p class="title"><b>Figure 5.109. RSP License alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'rsp_license_expired' triggered
Alarm 'rsp_license_expiring' triggered

Alarm triggered for rising error for event rsp_license_expired 
Alarm triggered for rising error for event rsp_license_expiring
</pre></div></div><br class="figure-break"><p>These alarms get triggered when the evaluation RSP licenses are
about to expire or already have expired.
</p><p>When an RSP instance gets initially setup in an evaluation environment,
it will get a time-limited RSP license. When the evaluation is
finished and an RSP license is purchased and configured but the
evaluation license which has not been removed will expire and this
alarm is raised.
</p><p>Next steps: Remove the temporary licenses, configure the proper
licenses or stop the RSP service.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39087208"></a>5.17.1.5. Disk alarms</h4></div></div></div><div class="figure"><a name="idp39087400"></a><p class="title"><b>Figure 5.110. Disk alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'raid_disk_indiv' triggered
Alarm 'disk:X:status' triggered
Alarm 'disk' triggered
Alarm 'disk_error:X' triggered
Alarm 'ssd_wear' triggered
Alarm 'ssd_wear_warning:X' triggered

Alarm triggered for rising error for event disk_error
Alarm triggered for rising error for event disk_not_setup
Alarm triggered for rising error for event raid_error
Alarm triggered for rising error for event ssd_wear_warning
</pre></div></div><br class="figure-break"><p>These alarms get triggered when a hard disk has high SMART error-rate
or when a hard disk in a RAID array has failed. The
<span class="italics">ssd_wear alarm</span>
is related to the 5055, 7050 and 7055 models where the number of
writes to a solid-state disk in the Fault Tolerant Segstore has
exceeded the threshold.
</p><p>Next steps: Contact Riverbed TAC for the replacement of the hard disk.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39088360"></a>5.17.1.6. Domain joining alarm</h4></div></div></div><div class="figure"><a name="idp39088552"></a><p class="title"><b>Figure 5.111. Domain joining alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'domain_join_error' triggered

Alarm triggered for rising error for event domain_join_error
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when the Steelhead appliance has been
joined to the domain but the communication with one or more Domain
Controllers has been interrupted.
</p><p>Next steps: Check the settings for the domain and perform the domain
join again.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39089320"></a>5.17.1.7. Filesystem related alarm</h4></div></div></div><div class="figure"><a name="idp39089512"></a><p class="title"><b>Figure 5.112. File system alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'fs_mnt' triggered
Alarm 'fs_mnt:X:full' triggered

Alarm triggered for rising error for event fs_mnt
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when the usage of one of the partitions
are above a threshold or when it is completely filled up.
</p><p>For the /var partition, there can be various reasons for this:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Too many system dumps or process dumps have been created. You can
  remove them via the GUI under Reports -&gt; Diagnostics -&gt; System Dumps
  or in the CLI via the command
<code class="computeroutput">files debug ... delete</code>
  and
<code class="computeroutput">files snapshot ... delete</code>.
</p></li><li class="listitem"><p>A background tcpdump capture has captured too much data and has filled
  up the partition.
</p></li><li class="listitem"><p>The logging level has been set too high, most likely INFO level,
  and the rotation-interval of the log files has been changed.
</p></li><li class="listitem"><p>The rotation of the log files has failed. This can be determined
  by checking the dates on the earlier log files to spot a skip in
  time between them.
</p></li><li class="listitem"><p>For older RiOS versions: The log files of the neural framing
  algorithm are filling up the partition or the rotation of the
  log files has failed due to a race condition between two logrotate
  processes.
</p></li></ul></div><p>
</p><p>If the usage was 100%, then once the disk space has been reclaimed
the best next step is to reboot the appliance so that all processes
and all log files are recreated properly.
</p><p>For the /proxy partition, in use by the RSP system, there can be
various solutions for this:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Remove old RSP installation images.
</p></li><li class="listitem"><p>Remove old RSP packages.
</p></li><li class="listitem"><p>Remove old RSP slots.
</p></li></ul></div><p>
</p><p>Note that the optimization service itself isn't affected by a
full-disk situation since the data store is located on its own
partition.
</p><p>Next steps: If the space cannot be reclaimed via the removal of
system dumps, process dumps or RSP related files, then contact
Riverbed TAC for further investigation.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39093160"></a>5.17.1.8. Paging alarms</h4></div></div></div><div class="figure"><a name="idp39093352"></a><p class="title"><b>Figure 5.113. Paging alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'paging' triggered

Alarm triggered for rising error for event paging
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when there is excessive swapping happening.
</p><p>Next steps: Do not reset the device and contact Riverbed TAC to
analyse this issue.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39094056"></a>5.17.1.9. RSP / VSP Alarms</h4></div></div></div><div class="figure"><a name="idp39094248"></a><p class="title"><b>Figure 5.114. RSP / VSP General alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'rsp' triggered
Alarm 'rsp_general_alarm' triggered
Alarm 'rsp_service' triggered
Alarm 'virt_cpu_util_indiv' triggered
Alarm 'virt_cpu:*:util
Alarm 'vsp' triggered
Alarm 'vsp_general_alarm' triggered
Alarm 'vsp_service' triggered
Alarm 'vsp_service_not_running' triggered
Alarm 'vsp_unsupported_vm_count' triggered

Alarm triggered for rising error for event rsp_general_alarm 
</pre></div></div><br class="figure-break"><p>These alarms get triggered when the VSP or RSP service has experienced
a problem.
</p><p>For RSP on the xx20 and xx50 series models, most likely this will
be an incompatibility between the RiOS version installed and the
RSP version installed.
</p><p>Next steps: Install the correct RSP version for this RiOS release.
</p><p>For VSP on the EX series models, the issue could be related to
communication between RiOS and the ESXi infrastructure.
</p><div class="figure"><a name="idp39095208"></a><p class="title"><b>Figure 5.115. ESXi specific alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'esxi_communication_failed' triggered
Alarm 'esxi_disk_creation_failed' triggered
Alarm 'esxi_initial_config_failed' triggered
Alarm 'esxi_license' triggered
Alarm 'esxi_license_expired' triggered
Alarm 'esxi_license_expiring' triggered
Alarm 'esxi_license_is_trial' triggered
Alarm 'esxi_memory_overcommitted' triggered
Alarm 'esxi_not_set_up' triggered
Alarm 'esxi_version_unsupported' triggered
Alarm 'esxi_vswitch_mtu_unsupported' triggered
</pre></div></div><br class="figure-break"><p>These alarms are related to the ESXi part of the EX appliances.
</p><p>The
<span class="italics">esxi_not_set_up alarm</span>
happens when an EX appliance doesn't have the VSP service enabled yet.
</p><p>Next step: Enable the VSP service in the GUI under Configure -&gt;
Virtualization -&gt; Virtual Services Platform.
</p><p>The
<span class="italics">esxi_disk_creation_failed alarm</span>
and the
<span class="italics">esxi_initial_config_failed alarm</span>
happen when the initial setup has failed.
</p><p>Next steps: Contact the Riverbed TAC.
</p><p>The
<span class="italics">esxi_communication_failed alarm</span>
happens when the communication towards the ESXi platform doesn't work
anymore. Most likely reason is that the password has been changed in
the ESXi infrastructure.
</p><p>Next steps: Update the password in the VSP configuration.
</p><p>The
<span class="italics">esxi_memory_overcommitted alarm</span>
happens when the memory required by the ESXi system is less than what
is available.
</p><p>Next steps: Reduce the memory requirements of the VMs in the ESXi system.
</p><p>The
<span class="italics">esxi_version_unsupported alarm</span>
happens when the version of ESXi has changed due to patches.
</p><p>Next steps: Back out to the original ESXi version.
</p><p>The
<span class="italics">esxi_vswitch_mtu_unsupported alarm</span>
is raised when the vSwitch on the ESXi platform has an MTU size of
more than 1500.
</p><p>Next steps: Undo the MTU size changes on the vSwitch.
</p><div class="figure"><a name="idp39119912"></a><p class="title"><b>Figure 5.116. RSP License alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'rsp_license_expired' triggered
Alarm 'rsp_license_expiring' triggered

Alarm triggered for rising error for event rsp_license_expired 
Alarm triggered for rising error for event rsp_license_expiring
</pre></div></div><br class="figure-break"><p>These alarms get triggered when the evaluation RSP licenses are
about to expire or already have expired.
</p><p>When an RSP instance gets initially setup in an evaluation environment,
it will get a time-limited RSP license. When the evaluation is
finished and an RSP license is purchased but not installed, the
evaluation license will expire and the RSP service will not restart
at the next restart.
</p><p>Next steps: Remove the temporary licenses, configure the proper
licenses or stop the RSP service.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39120744"></a>5.17.1.10. Secure Vault alarm</h4></div></div></div><div class="figure"><a name="idp39120936"></a><p class="title"><b>Figure 5.117. Secure Vault alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'secure_vault' triggered
Alarm 'secure_vault_rekey_needed' triggered
Alarm 'secure_vault_uninitialized' triggered
Alarm 'secure_vault_unlocked' triggered

Alarm triggered for falling error for event secure_vault_unlocked
</pre></div></div><br class="figure-break"><p>The
<span class="italics">secure vault</span>
alarm is a general alarm when one of the other alarms get triggered.
</p><p>The
<span class="italics">secure vault unlocked</span>
alarm gets triggered when the secure vault cannot be opened with
the default password.
</p><p>This happens when the password for the secure vault has been changed:
After a restart of the Steelhead appliance the secure vault cannot
be automatically opened anymore and this alarm gets triggered.
</p><p>Next steps: Unlock the secure vault manually via the GUI of the
Steelhead appliance or configure the correct secure vault password
on the CMC.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39122472"></a>5.17.2. Hardware related alarms</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39122664"></a>5.17.2.1. Fan alarms</h4></div></div></div><div class="figure"><a name="idp39122856"></a><p class="title"><b>Figure 5.118. Fan alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'fan_error' triggered

Alarm triggered for rising error for event fan_error
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when one of the fans in the chassis has
failed.
</p><p>Next steps: Contact Riverbed TAC for the replacement of the fan.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39123560"></a>5.17.2.2. Flash Error alarms</h4></div></div></div><div class="figure"><a name="idp39123752"></a><p class="title"><b>Figure 5.119. Flash Error alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'flash_error' triggered
Alarm 'flash_protection_failed' triggered

Alarm triggered for rising error for event flash_error
</pre></div></div><br class="figure-break"><p>The
<span class="italics">flash_error alarm</span>
gets triggered when the USB Flash Memory has become read-only or when
it has become unavailable.
</p><p>This is an issue with the xx50 series models, where the USB bus
towards the Flash Memory becomes locked due to timing issues.
</p><p>Checkout KB article S15568 to confirm that the device is running the
right minimum RIOS version to best overcome this issue.
</p><p>Next steps: Reboot the appliance as soon as possible to unlock the
USB Flash Memory.
</p><p>The
<span class="italics">flash_protection_failed alarm</span>
is raised when the backup of the USB Flash Memory could not have
been completed.
</p><p>Next steps: Confirm that there is enough free space on the
<span class="italics">/var</span>
partition for the backup.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39125864"></a>5.17.2.3. Generic hardware alarm</h4></div></div></div><div class="figure"><a name="idp39126056"></a><p class="title"><b>Figure 5.120. Generic Hardware alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'hardware' triggered
Alarm 'other_hardware_error' triggered

Alarm triggered for rising error for event hardware_error
</pre></div></div><br class="figure-break"><p>These alarms get triggered when there is a mismatch with the
configuration of the Steelhead appliance:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A faulty disk, insufficient memory or missing CPUs.
</p></li><li class="listitem"><p>An unqualified hard disk, memory stick or network card has been detected.
</p></li></ul></div><p>Next steps: Contact Riverbed TAC for investigation.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39127336"></a>5.17.2.4. IPMI alarms</h4></div></div></div><div class="figure"><a name="idp39127528"></a><p class="title"><b>Figure 5.121. IPMI alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'ipmi' triggered

Alarm triggered for rising error for event ipmi
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when the IPMI subsystem reports an issue:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The chassis of the Steelhead appliance has been opened,
</p></li><li class="listitem"><p>The ECC memory has reported an error,
</p></li><li class="listitem"><p>A hard disk is failing or has failed,
</p></li><li class="listitem"><p>A power supply is failing or has failed.
</p></li></ul></div><p>Next steps: If the alarm is with regarding to the intrusion alarm,
it can be reset from the GUI. If the issue is with regarding to
failing hardware, then contact Riverbed TAC for a replacement.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39129128"></a>5.17.2.5. Memory error alarms</h4></div></div></div><div class="figure"><a name="idp39129320"></a><p class="title"><b>Figure 5.122. Memory error alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'memory_error' triggered

Alarm triggered for rising error for event memory_error
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when an ECC error on one of the memory
sticks gets reported.
</p><p>Next steps: Contact Riverbed TAC for identification and replacement.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39134184"></a>5.17.2.6. Power supply alarms</h4></div></div></div><div class="figure"><a name="idp39134376"></a><p class="title"><b>Figure 5.123. Power supply alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'power_supply' triggered

Alarm triggered for rising error for event power_supply
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when one of the power supplies in the
chassis has failed.
</p><p>Next steps: Confirm that the power source to the power supply is
working properly, if not contact Riverbed TAC for a replacement.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39135080"></a>5.17.2.7. SSL Hardware alarm</h4></div></div></div><div class="figure"><a name="idp39135272"></a><p class="title"><b>Figure 5.124. SSL Hardware alarm</b></p><div class="figure-contents"><pre class="screen">Alarm triggered for rising error for event ssl_hardware
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when the SSL Offload hardware has encountered
an error.
</p><p>Next steps: Contact Riverbed TAC for investigation.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39136104"></a>5.17.2.8. Temperature alarms</h4></div></div></div><div class="figure"><a name="idp39136296"></a><p class="title"><b>Figure 5.125. Temperature alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'temperature' triggered
Alarm 'critical_temp' triggered
Alarm 'warning_temp' triggered

Alarm triggered for rising error for event warning_temp
Alarm triggered for rising error for event critical_temp 
</pre></div></div><br class="figure-break"><p>These alarms get triggered when the temperature of the Steelhead
appliance is too high. Possible causes are fan-failures, high
operating temperatures, high humidity, blocked air vents or dusty
environment.
</p><p>Next steps: Confirm that the environment temperature is not too
high, that the airflow is sufficient, clear the chassis of excessive
dust. If the issue keeps happening, contact Riverbed TAC for
investigation.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39137000"></a>5.17.3. Network related alarms</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39137192"></a>5.17.3.1. Asymmetric Routing alarms</h4></div></div></div><div class="figure"><a name="idp39137384"></a><p class="title"><b>Figure 5.126. Asymmetric routing alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'arcount' triggered

Alarm triggered for rising error for event arcount 
</pre></div></div><br class="figure-break"><p>This alarm gets triggered if one or more instances of asymmetric
routing have been detected. See the chapter
<a class="xref" href="#operation_iproutingrelatedissues" title="5.16. IP Routing Related Issues">IP Routing Related Issues</a> on how to deal with this.
</p><p>Next steps: If the cause of the alarm is real network asymmetry,
then make sure that all paths in the network are covered with
Steelhead appliances. If the cause of the alarm is SYN retransmission,
then configure Fixed-Target in-path rules to overcome the auto-discovery
issue, or configure pass-through in-path rules to prevent optimization
towards that subnet.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39097384"></a>5.17.3.2. Bypass alarms</h4></div></div></div><div class="figure"><a name="idp39097576"></a><p class="title"><b>Figure 5.127. Bypass alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'bypass' triggered

Alarm triggered for rising error for event bypass 
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when one or more in-path interfaces have
gone into bypass, linking the WAN router and LAN interface together.
This happens when the optimization service is stopped or when the
network card watchdog has been activated.
</p><p>Next steps: Restart the optimization service if the optimization
service is stopped. Contact Riverbed TAC to investigate if the issue
is related to the watchdog.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39098280"></a>5.17.3.3. Duplex alarms</h4></div></div></div><div class="figure"><a name="idp39098472"></a><p class="title"><b>Figure 5.128. Duplex error</b></p><div class="figure-contents"><pre class="screen">Alarm 'duplex' triggered
Alarm 'link_duplex' triggered
Alarm 'link_state:*:half_duplex' triggered
Alarm 'link_io_errors' triggered
Alarm 'link_state:*:io_errors' triggered

Alarm triggered for rising error for event duplex 
</pre></div></div><br class="figure-break"><p>These alarms gets triggered when there is a large amount of frame
errors or carrier errors on one of the interfaces, often indicating
a speed/duplex configuration mismatch.
</p><p>Next steps: Check the speed and duplex settings on the interface
reported. Consider a new Ethernet cable or a different port on the
switch if the speed and duplex settings are the same.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39099176"></a>5.17.3.4. Link state alarms</h4></div></div></div><div class="figure"><a name="idp39099368"></a><p class="title"><b>Figure 5.129. Link state alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'linkstate' triggered
Alarm 'link_state:X:link_error' triggered

Alarm triggered for rising error for event linkstate 
</pre></div></div><br class="figure-break"><p>These alarms get triggered when one of the interfaces of the Steelhead
appliance has lost its Ethernet link.
</p><p>Next steps: Investigate the loss of Ethernet link.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39100136"></a>5.17.4. Virtual Steelhead related alarms</h3></div></div></div><div class="figure"><a name="idp39100328"></a><p class="title"><b>Figure 5.130. Virtual Steelhead related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'disk_not_setup' triggered
Alarm 'lan_wan_loop' triggered
</pre></div></div><br class="figure-break"><p>The
<span class="italics">disk_not_setup alarm</span>
gets triggered when the Virtual Steelhead appliance detects that
the disk reserved for the data store is not yet provisioned or not
of the right size.
</p><p>Next steps: In the ESXi environment, check the properties of the
virtual disks for the Virtual Steelhead.
</p><p>The
<span class="italics">lan_wan_loop alarm</span>
gets triggered when the Virtual Steelhead appliance detects that
the LAN and the WAN interface are configured to be on the same
virtual switch.
</p><p>Next steps: In the ESXi environment, put the LAN and the WAN
interfaces in different virtual switches.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39138728"></a>5.17.5. Optimization service alarms</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39138920"></a>5.17.5.1. Admission control alarms</h4></div></div></div><div class="figure"><a name="idp39139112"></a><p class="title"><b>Figure 5.131. Various admission control alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'admission_control' rising
Alarm 'admission_conn' rising
Alarm 'admission_cpu' rising
Alarm 'admission_mapi' rising
Alarm 'admission_mem' rising
Alarm 'admission_tcp' rising

Alarm triggered for rising error for event admission_conn 
Alarm triggered for rising error for event admission_cpu 
Alarm triggered for rising error for event admission_mapi 
Alarm triggered for rising error for event admission_mem 
Alarm triggered for rising error for event admission_tcp 
</pre></div></div><br class="figure-break"><p>The following admission control alarms do exist:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The generic admission control alarm, it is raised when one of
  the other alarms is raised.
</p></li><li class="listitem"><p>Connection based admission control, when the number of TCP sessions
  optimized has increased to above the number of licensed TCP
  sessions.
</p><p>  Next steps: Check the list of TCP connections in the Current
  Connections overview and to reduce the number of optimized TCP
  sessions by applying in-path rules to pass-through traffic which
  does not get a high optimization factor. If the issue is structural
  consider an upgrade to a higher model.
</p></li><li class="listitem"><p>CPU load admission control, when the CPU load is too high and no
  new TCP sessions will be optimized.
</p><p>  Next steps: Open a case with Riverbed TAC when this happens.
</p></li><li class="listitem"><p>MAPI based admission control, when the number of optimized TCP
  sessions exceeds a by default 85% threshold of the maximum number
  of licensed TCP sessions. This is to overcome the problems caused
  by the MAPI protocol use of multiple TCP sessions which all need
  to be optimized against the same client-side and server-side
  Steelhead appliances.
</p><p>  Next steps: The same as with Connection based admission control.
</p></li><li class="listitem"><p>Memory based admission control, where the internal memory pool
  of the optimization service has exceeded a certain threshold.
</p><p>  Next steps: Open a case with Riverbed TAC to investigate.
</p></li><li class="listitem"><p>TCP based admission control, where the TCP buffers in the kernel
  running on the Steelhead appliance is running out of memory.
</p><p>  Next steps:
  In the sysinfo.txt in the system dump, check the netstat output
  and find out which hosts have the biggest send-queue values. That
  is the host with the slow network stack. Also, open a case with
  Riverbed TAC to investigate.
</p></li></ul></div><p>
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39141800"></a>5.17.5.2. Connection Forwarding related alarms</h4></div></div></div><div class="figure"><a name="idp39146152"></a><p class="title"><b>Figure 5.132. Connection Forwarding alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'cf_ipv6_incompatible_cluster' triggered
Alarm 'connection_forwarding' triggered
Alarm 'disconnected_sh_alert' triggered
Alarm 'single_cf' triggered
Alarm 'cf_ack_timeout_aggr' triggered
Alarm 'cf_ack_timeout:*' triggered
Alarm 'cf_conn_failure_aggr' triggered
Alarm 'cf_conn_failure:*' triggered
Alarm 'cf_conn_lost_eos_aggr' triggered
Alarm 'cf_conn_lost_eos:*' triggered
Alarm 'cf_conn_lost_err_aggr' triggered
Alarm 'cf_conn_lost_err:*' triggered
Alarm 'cf_keepalive_timeout_aggr' triggered
Alarm 'cf_keepalive_timeout:*' triggered
Alarm 'cf_latency_exceeded_aggr' triggered
Alarm 'cf_latency_exceeded:*' triggered
Alarm 'cf_read_info_timeout_aggr' triggered
Alarm 'cf_read_info_timeout:*' triggered

Alarm triggered for rising error for event cf_ack_timeout 
Alarm triggered for rising error for event cf_conn_failure 
Alarm triggered for rising error for event cf_conn_lost_eos 
Alarm triggered for rising error for event cf_conn_lost_err 
Alarm triggered for rising error for event cf_keepalive_timeout
Alarm triggered for rising error for event cf_latency_exceeded 
Alarm triggered for rising error for event cf_read_info_timeout
</pre></div></div><br class="figure-break"><p>The most common alarms with regarding to Connection Forwarding
protocol are the
<span class="italics">cf_conn_failure alarm</span>
and the
<span class="italics">cf_latency_exceeded alarm</span>.
</p><p>The
<span class="italics">cf_conn_failure alarm</span>
happens when the Steelhead appliance is unable to setup of the TCP
session for the Connection Forwarding protocol. This is most likely
related to a network related issue between the two in-path interfaces
or because the optimization service on the other Steelhead appliance
is not operational.
</p><p>The
<span class="italics">cf_latency_exceeded alarm</span>
happens when the responses in the Connection Forwarding sessions
take too long to come back to the Steelhead appliance. This could
be related to the network between the two in-path interfaces but
also to the load on the neighbour Steelhead appliance.
</p><p>Next steps: Check the network between the in-path interfaces.
</p><p>The
<span class="italics">disconnected_sh_alert alarm </span>
gets triggered when a Connection Forwarding neighbour gets disconnected.
</p><p>The
<span class="italics">single_cf alarm</span>
gets triggered when there are no neighbouring nodes in the Connection
Forwarding cluster.
</p><p>Next steps: Determine why the neighbours got disconnected.
</p><p>The
<span class="italics">cf_ipv6_incompatible_cluster alarm </span>
gets triggered when one of the nodes in the cluster do not support
optimization over IPv6 yet.
</p><p>Next steps: Upgrade all nodes in the cluster to the right RiOS version.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39149672"></a>5.17.5.3. Data store related alarms</h4></div></div></div><div class="figure"><a name="idp39149864"></a><p class="title"><b>Figure 5.133. Data store related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'datastore' triggered
Alarm 'datastore_error' triggered
Alarm 'datastore_sync_error' triggered
Alarm 'store_corruption' triggered

Alarm triggered for rising error for event datastore_error
Alarm triggered for rising error for event datastore_sync_error
Alarm triggered for rising error for event store_corruption
</pre></div></div><br class="figure-break"><p>When the optimization service detects a corruption in the data store
it try to recover from the issue and raise the
<span class="italics">store_corruption alarm</span>.
This alarm also can happen when encryption of the data store has
been enabled or disabled but the restart of the optimization service
didn't include the clearing of the data store.
</p><p>Next steps: Restart the optimization service and clear the data store.
</p><p>The
<span class="italics">datastore_sync_error alarm</span>
gets triggered when the Steelhead appliance is part of a data store
synchronization cluster but its peer has become unreachable.
</p><p>Next steps: Confirm the network between the two Steelhead appliances.
</p><p>The
<span class="italics">datastore_error alarm</span>
gets triggered when the metadata in the data store cannot be
initialized with the current settings. This alarm can happen when
encryption of the data store has been changed or when the Extended
Peering Table has been enabled or disabled but the restart of the
optimization service didn't include the clearing of the data store.
</p><p>Next steps: Restart the optimization service with the option to
clear the data store.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39151912"></a>5.17.5.4. Halt alarm</h4></div></div></div><div class="figure"><a name="idp39152104"></a><p class="title"><b>Figure 5.134. Halt alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'halt_error' triggered

Alarm triggered for rising error for event halt_error
</pre></div></div><br class="figure-break"><p>Next steps: Open a case with Riverbed TAC to investigate.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39152744"></a>5.17.5.5. Mismatched Peer alarm</h4></div></div></div><div class="figure"><a name="idp39152936"></a><p class="title"><b>Figure 5.135. Mismatched Peer alarms</b></p><div class="figure-contents"><pre class="screen">Alarm triggered for rising error for event mismatch_peer
</pre></div></div><br class="figure-break"><p>Next steps: Open a case with Riverbed TAC to investigate.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39153640"></a>5.17.5.6. NFS related alarm</h4></div></div></div><div class="figure"><a name="idp39153832"></a><p class="title"><b>Figure 5.136. NFS related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'nfs_v2_v4' triggered

Alarm triggered for rising error for event nfs_v2_v4
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when the NFS latency optimization has
detected an NFS server which only uses the NFS version 2 or NFS
version 4 protocols. The NFS latency optimization can only optimize
NFS version 3 traffic.
</p><p>Next steps: See if the NFS servers reported can be changed to support
NFS version 3. If not, consider a pass-through rule for them.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39154600"></a>5.17.5.7. Optimization Service alarm</h4></div></div></div><div class="figure"><a name="idp39154792"></a><p class="title"><b>Figure 5.137. Optimization Service alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'service_error' triggered
Alarm 'optimization_service' triggered
Alarm 'optimization_general' triggered

Alarm triggered for rising error for event service_error
</pre></div></div><br class="figure-break"><p>These alarms get triggered when the optimization service is not
running or when an issue has been encountered which indicate a
critical failure in the optimization protocol.
</p><p>Next steps: Open a case with Riverbed TAC to investigate.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39155560"></a>5.17.5.8. PFS related alarms</h4></div></div></div><div class="figure"><a name="idp39155752"></a><p class="title"><b>Figure 5.138. PFS related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'pfs' triggered
Alarm 'pfs_config' triggered
Alarm 'pfs_operation' triggered

Alarm triggered for rising error for event pfs_config
Alarm triggered for rising error for event pfs_operation
</pre></div></div><br class="figure-break"><p>These alarms get triggered when there is an issue with the Proxy
File Service.
</p><p>Next steps: Open a case with Riverbed TAC to investigate.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39156520"></a>5.17.5.9. Process dump related alarm</h4></div></div></div><div class="figure"><a name="idp39156712"></a><p class="title"><b>Figure 5.139. Process dump related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'sticky_staging_dir' triggered

Alarm triggered for rising error for event sticky_staging_dir
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when there is an issue creating new process
dumps. Most of the time it correlates with a
<span class="italics">fs_mnt alarm</span>.
</p><p>Next steps: Open a case with Riverbed TAC to investigate.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39157736"></a>5.17.5.10. Serial Cascade configuration alarm</h4></div></div></div><div class="figure"><a name="idp39157928"></a><p class="title"><b>Figure 5.140. Serial Cascade configuration alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'serial_cascade_misconfig' triggered

Alarm triggered for rising error for event serial_cascade_misconfig
</pre></div></div><br class="figure-break"><p>Next steps: Open a case with Riverbed TAC to investigate.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39158632"></a>5.17.5.11. SMB alarm</h4></div></div></div><div class="figure"><a name="idp39158824"></a><p class="title"><b>Figure 5.141. SMB alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'smb_alert' triggered

Alarm triggered for rising error for event smb_alert
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when there is an issue with the SMB Signing
feature.
</p><p>Next steps: Check the status of the computer object in the Active
Directory service and the log files on the Domain Controllers. Check
the status of the delegation user in the Active Directory service
and the log files on the Domain Controllers. Check the connectivity
between the Steelhead appliance primary interface and the Domain
Controllers.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39159528"></a>5.17.5.12. QoS related alarms</h4></div></div></div><div class="figure"><a name="idp39159720"></a><p class="title"><b>Figure 5.142. QoS alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'inbound_qos_wan_bw_err' triggered
Alarm 'outbound_qos_wan_bw_err' triggered
</pre></div></div><br class="figure-break"><p>These alarms get raised when the sum of the configured QoS bandwidth
values exceed the configured WAN bandwidth speeds.
</p><p>Next steps: Check the QoS settings page and confirm that the QoS bandwidth
values are correct.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39160424"></a>5.17.5.13. Software version alarm</h4></div></div></div><div class="figure"><a name="idp39160616"></a><p class="title"><b>Figure 5.143. Software version alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'sw_version_aggr' triggered
Alarm 'mismatch_peer_aggr'
Alarm 'mismatch_peer:*'
Alarm 'sw_version_mismatch_aggr'
Alarm 'sw_version:*'

Alarm triggered for rising error for event sw-version
</pre></div></div><br class="figure-break"><p>These alarms get triggered when an incompatibility with the RiOS
software version of a remote Steelhead appliance has been detected.
</p><p>Next steps: Upgrade the remote Steelhead appliance to a compatible
RiOS version or configure Peering Rules to prevent optimization
between the two Steelhead appliances.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39161320"></a>5.17.5.14. SSL related alarm</h4></div></div></div><div class="figure"><a name="idp39161512"></a><p class="title"><b>Figure 5.144. SSL related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'non_443_ssl_servers_detected_on_upgrade' triggered

Alarm triggered for rising error for event non_443_ssl_servers_detected_on_upgrade
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when, after the upgrade to RiOS version
6.0 or later, an SSL server on a port different than port 443 has
been detected.
</p><p>In RiOS version 6.0 and later traffic on TCP port 443 is automatically
assumed to be SSL encapsulated and when SSL optimization has been
enabled, then no in-path rule is required to get that traffic
optimized. For SSL traffic on a different TCP port than port 443
an in-path rule is still required.
</p><p>Next steps: Configure the correct In-path Rules and Peering Rules
to optimize this SSL traffic.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39162344"></a>5.17.5.15. System Detail Report alarm</h4></div></div></div><div class="figure"><a name="idp39162600"></a><p class="title"><b>Figure 5.145. System Detail Report alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'system_detail_report' triggered

Alarm triggered for rising error for event system_detail_report
</pre></div></div><br class="figure-break"><p>This alarm gets triggered when an issue with the operation or
configuration of the optimization service has been determined.
</p><p>Next steps: Check the System Detail Report and attend to the issues
reported.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39163304"></a>5.17.6. Granite related alarms</h3></div></div></div><div class="figure"><a name="idp39163496"></a><p class="title"><b>Figure 5.146. Granite related alarms</b></p><div class="figure-contents"><pre class="screen">Alarm 'block_store' triggered
Alarm 'block_store:*' triggered
Alarm 'profile_switch_failed' triggered
Alarm 'granite-core' triggered
Alarm 'granite-core:*' triggered
Alarm 'high_availability' triggered
Alarm 'high_availability:*' triggered
Alarm 'iscsi' triggered
Alarm 'iscsi:*' triggered
Alarm 'lun' triggered
Alarm 'lun:*' triggered
Alarm 'snapshot' triggered
Alarm 'snapshot:*' triggered
Alarm 'uncommitted_data' triggered
</pre></div></div><br class="figure-break"><p>The
<span class="italics">block_store alarm</span>
gets triggered when there are issues with the Granite block store.
</p><p>Next steps: Check the system logs and contact Riverbed TAC for
investigation.
</p><p>This alarm gets triggered when repartitioning the drives fails
during the switching of the storage profile.
</p><p>Next steps: Contact Riverbed TAC for investigation.
</p><p>The
<span class="italics">granite-core alarm</span>
gets triggered when there are communication problems towards the
Granite Core appliance.
</p><p>Next steps: Confirm that there are no network related issues between
the Granite Edge and the Granite Core.
</p><p>The
<span class="italics">high_availability alarm</span>
gets triggered when there are communication problems towards a node in
high availability cluster.
</p><p>Next steps: Check connectivity with the HA peer.
</p><p>The
<span class="italics">iscsi alarm</span>
gets triggered when the iSCSI initiator isn't accessible.
</p><p>Next steps: Confirm the configuration of the iSCSI configuration.
</p><p>The
<span class="italics">lun alarm</span>
gets triggered when a LUN isn't avaiable for the Granite Core.
</p><p>Next step: Confirm the status of the LUN on the Data Center NAS.
</p><p>The
<span class="italics">snapshot alarm</span>
gets triggered when a snapshot couldn't be completed or committed.
</p><p>Next steps: Confirm the status of the Data Center NAS.
</p><p>This alarm gets triggered when the Granite Edge has a large amount
of uncommitted data in its blockstore.
</p><p>Next steps: Confirm that the Granite Core and the NAS are working
fine.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39167848"></a>5.18. Long lived TCP session treatment</h2></div></div></div><p>When the optimization service gets restarted or a Steelhead appliance
gets rebooted, the current optimized TCP sessions will be terminated.
During the initialization period of the optimization service new
TCP sessions will be setup, either new ones or the replacement of
the ones which were terminated earlier. When the initialization of
the optimization service is completed and new TCP sessions will be
optimized, these already established TCP sessions will be passed-through,
showing up as pre-existing in the list of current connections.
</p><p>This is fine for short lived TCP sessions such as HTTP, SMPT and
POP3, which last only a short time. However, long lived TCP sessions
like CIFS sessions, MAPI traffic, database replication and file
server replication will stay unoptimized and suffer from a bad
performance.
</p><p>To overcome this, the optimization service needs to know which
traffic needs to be optimized at all times. It will require regular
interaction with the people who run the services to keep track of
changes in their servers. It will need to be documented properly
for operation of the network.
</p><p>To restart these TCP sessions, there are three possible solutions
from the Steelhead appliances perspective:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Reset TCP connections at restart.
</p></li><li class="listitem"><p>Manual termination of TCP sessions.
</p></li><li class="listitem"><p>Auto kick-off of pre-existing TCP sessions via an in-path rule.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39169192"></a>5.18.1. Reset TCP connections at restart</h3></div></div></div><p>This option can be found under the General Optimization configuration:
Reset Connections At Startup.
</p><div class="figure"><a name="idp39169512"></a><p class="title"><b>Figure 5.147. Reset Connections At Startup</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-connectionresetatstartup.png" align="middle" width="100%" alt="Reset Connections At Startup"></td></tr></table></div></div></div><br class="figure-break"><p>It will cause all pre-existing TCP sessions to be reset when
they are detected after the restart of the optimization service.
This is obsoleted by the auto kick-off in-path rule.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39170408"></a>5.18.2. Manual termination of TCP sessions</h3></div></div></div><p>Under the details of the TCP session in the report of the Current
Connections, there is an option to reset the connection.
</p><div class="figure"><a name="idp39178984"></a><p class="title"><b>Figure 5.148. Terminate Connection button in the GUI</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-35-manualtermination.png" align="middle" width="100%" alt="Terminate Connection button in the GUI"></td></tr></table></div></div></div><br class="figure-break"><p>In the CLI, the command to terminate the TCP session is
<code class="computeroutput">tcp connection send reset pass-reset</code>.
It will require the IP addresses and the TCP port numbers of both
the client and the server.
</p><div class="figure"><a name="idp39180200"></a><p class="title"><b>Figure 5.149. Terminate TCP session via the CLI</b></p><div class="figure-contents"><pre class="screen">SH # show connections passthrough filter pre_existing
T  Source                Destination           App    Rdn Since
--------------------------------------------------------------------------------
PI 10.0.1.1         1025 192.168.1.1       139            pre_existing        c
--------------------------------------------------------------------------------
Pass Through (P):              1
PI = Passthrough Intentional
PU = Passthrough Unintentional
Forwarded (F):                 0
--------------------------------
Total:                         1
c = Client Steelhead
s = Server Steelhead

SH (config) # tcp connection send pass-reset source-addr 10.0.1.1 source-port 1025 dest-ad \
    dr 192.168.1.1 dest-port 139 
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39180648"></a>5.18.3. In-path auto kick-off of pre-existing TCP sessions</h3></div></div></div><p>The automatic way to terminate selected pre-existing TCP sessions
after a restart of the optimization service can be done via an
in-path rule on the client-side Steelhead appliance with the auto
kick-off option enabled.
</p><p>For example, to retry to optimize pre-existing CIFS sessions, which
are normally long-lived, use the following in-path rule:
</p><div class="figure"><a name="idp39181160"></a><p class="title"><b>Figure 5.150. Example of auto kick-off in-path rule</b></p><div class="figure-contents"><pre class="screen">SH (config) # in-path rule auto-discover auto-kickoff enable dstport 445 rulenum 4 descrip \
    tion "Always retry pre-existing CIFS connections"
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39181608"></a><p class="title"><b>Figure 5.151. Configuration of a Kick-off in-path rule</b></p><div class="figure-contents"><pre class="screen">SH (config) # show in-path rules 
 Rule Type P O L N W K VLAN Source Addr        Dest Addr          Port          
----- ---- - - - - - - ---- ------------------ ------------------ --------------
    1 pass - - - - - - all  all                all                Secure        
    2 pass - - - - - - all  all                all                Interactive   
    3 pass - - - - - - all  all                all                RBT-Proto     
    4 auto N F F A C Y all  all                all                445           
      desc: Always retry pre-existing CIFS connections                          
  def auto N F F A C N all  all                all                all           

4 user-defined rule(s)

(P) Preoptimization Policy: O=Oracle-Forms S=SSL +=Oracle-Forms-over-SSL N=None
(O) Optimization Policy:    F=Full S=SDR-only C=Compression-only M=SDR-M N=None
(L) Latency Optimizations:  F=Full H=HTTP-only O=Outlook-anywhere N=None
(N) Neural Framing:         A=Always D=Dynamic T=TCP hints N=Never
(W) WAN Visibility Mode:    C=Correct-Addressing
                            P=Port-Transparency
                            F=Full-Transparency
                            R=Full-Transparency w/Reset
(K) Auto Kickoff:           Y=Enabled
                            N=Disabled

</pre></div></div><br class="figure-break"><p>Pre-existing TCP sessions on TCP port 445 will now be terminated
the optimization service.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39182312"></a>5.19. Order of the in-path rules</h2></div></div></div><p>By default, there are three standard pass-through in-path rules on
a Steelhead appliance and one default catch-all. The best way to
add new in-path rules is:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Any port specific rules go at the beginning.
</p></li><li class="listitem"><p>Any global rules go at the end.
</p></li><li class="listitem"><p>Any subnet specific rules go after the default rules but before
  the global rules.
</p></li></ul></div><p>These are the default in-path rules.
</p><div class="figure"><a name="idp39183464"></a><p class="title"><b>Figure 5.152. Default in-path rules</b></p><div class="figure-contents"><pre class="screen">No Type         From To  Ports
 1 Pass-through Any  Any Secure
 2 Pass-through Any  Any Interactive
 3 Pass-through Any  Any RBT-proto
</pre></div></div><br class="figure-break"><p>Any new port specific rules should be added before these three. For
example to pass-through all traffic on TCP port 12345, add rule 1:
</p><div class="figure"><a name="idp39184040"></a><p class="title"><b>Figure 5.153. In-path rules: Add a new pass-through rule</b></p><div class="figure-contents"><pre class="screen">No Type         From To  Ports
 1 Pass-through Any  Any 12345
 2 Pass-through Any  Any Secure
 3 Pass-through Any  Any Interactive
 4 Pass-through Any  Any RBT-proto
</pre></div></div><br class="figure-break"><p>Any global "Use this WAN visibility" should be added to the end as
rule 5:
</p><div class="figure"><a name="idp39184616"></a><p class="title"><b>Figure 5.154. In-path rules: Change the default WAN visibility</b></p><div class="figure-contents"><pre class="screen">No Type            From To   Ports        WAN
 1 Pass-through    Any  Any  12345
 2 Pass-through    Any  Any  Secure
 3 Pass-through    Any  Any  Interactive
 4 Pass-through    Any  Any  RBT-proto    
 5 Auto-Discovery  Any  Any  All          FT
</pre></div></div><br class="figure-break"><p>Any specific optimization or auto-discovery features towards a
specific IP subnet should be added after the standard pass-through
rules as rule 6:
</p><div class="figure"><a name="idp39185256"></a><p class="title"><b>Figure 5.155. In-path rules: Add an all-ports auto-discovery rule</b></p><div class="figure-contents"><pre class="screen">No Type            From To              Ports       WAN  
 1 Pass-through    Any  Any             12345       
 2 Pass-through    Any  Any             Secure
 3 Pass-through    Any  Any             Interactive
 4 Pass-through    Any  Any             RBT-proto    
 5 Auto-Discovery  Any  192.168.1.0/24  All         FT,FW-RST
 6 Auto-Discovery  Any  Any             All         FT
</pre></div></div><br class="figure-break"><p>Any specific optimization features towards a specific TCP port on
a specific IP subnet or host could be added after the standard
pass-through rules but can be in front of the pass-through rules,
for example as rule 1:
</p><div class="figure"><a name="idp39185896"></a><p class="title"><b>Figure 5.156. In-path rules: Add an specific TCP port auto-discovery rule</b></p><div class="figure-contents"><pre class="screen">SH # show in-path rules
No Type            From To              Ports       WAN        LatOpt
 1 Auto-Discovery  Any  192.168.1.1/32  1080        FT         HTTP
 2 Pass-through    Any  Any             12345
 3 Pass-through    Any  Any             Secure
 4 Pass-through    Any  Any             Interactive
 5 Pass-through    Any  Any             RBT-proto    
 6 Auto-Discovery  Any  192.168.1.0/24  All         FT,FW-RST  Normal
 7 Auto-Discovery  Any  Any             All         FT         Normal
</pre></div></div><br class="figure-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39186408"></a>5.19.1. Specific in-path rules rules</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39186600"></a>5.19.1.1. MAPI latency optimization</h4></div></div></div><p>Latency optimization of TCP sessions for the MAPI protocol gets determined
by the traffic going to the port-mapper running on TCP port 135 on the
Exchange server. To disable MAPI latency optimization via an in-path rule,
use TCP port 135 in the in-path rule.
</p><div class="figure"><a name="idp39186920"></a><p class="title"><b>Figure 5.157. Disable MAPI optimization</b></p><div class="figure-contents"><pre class="screen">No Type            From To              Ports       WAN        LatOpt
[...]
 5 Pass-through    Any  Any             135
</pre></div></div><br class="figure-break"><p>Once a Exchange server has been detected, a hidden in-path rule
gets added to the list which states that all traffic to that server
needs to be Fixed Targeted to the Steelhead appliance in front of
the Exchange server. This hidden in-path rule overrules any newly
added in-path rules to not optimize traffic on TCP port 135.
</p><p>This hidden in-path rule can be disabled with the CLI command
<code class="computeroutput">in-path probe-mapi-data</code>,
which is enabled by default in RiOS versions 6.1.x and up to version
6.5.2.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39188008"></a>5.19.1.2. Traffic on TCP port 443 is always SSL pre-optimized.</h4></div></div></div><p>TCP port 443 is reserved for HTTPS traffic. The traffic for this
port does always gets treated with a SSL pre-optimization policy,
even if there is an in-path rule which doesn't have the SSL
pre-optimization policy defined.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39188520"></a>5.20. Network monitoring and network management systems</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39188776"></a>5.20.1. Network Management Systems</h3></div></div></div><p>Network Management Systems and Network Monitoring Systems can be
confused by the changes the Steelhead appliances make to the network.
For example, the latency optimization might reply to requests much
faster than the server would, giving the impression that the network
and the server are fine.
</p><p>Since there are two networks to be monitored now, an optimized and
a non-optimized one, there should be two network management systems:
One to monitor the services via the TCP sessions and one to monitor
the services via the non-optimized TCP sessions. The unoptimized
TCP sessions can be monitored by adding a pass-through in-path rule
for traffic from that network management host on its local Steelhead
appliance.
</p><p>The two network management systems should give the same statuses
for the remote machines or services, working, failure or unavailable.
If there is a difference in the status, it means that there could
be problem with a part of the network or with the services or with
the optimization service.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39189352"></a>5.20.2. Network Probing Systems</h3></div></div></div><p>Network mappers and port scanners, like the nmap utility, work by
sending out a large amount of TCP SYN packets to multiple ports on
a single host or to a single port on multiple hosts, all during a
short time. On an unoptimized network, this is cheap because the
packets are small. On an optimized network, these TCP SYN packets
will cause a lot of work to be done on the Steelhead appliances:
Optimized TCP sessions will have to be setup and latency optimization
will have to be initialized. As a result, the Steelhead appliance
can generate alarms about connection-based admission control and
high CPU.
</p><p>OS Finger Printing will be incorrect because the TCP/IP stack the
scanner is talking to is the one from the Steelhead appliance, not
from the remote server.
</p><p>The best practice is to exempt the traffic from port scanners and
network mappers from being optimized via a pass-through in-path
rule on the Steelhead appliance closest to it.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39189928"></a>5.20.3. Spanning VLANs</h3></div></div></div><p>The spanning feature on routers and switches allows all traffic
coming into and going out via an interface or a VLAN to be copied
and forwarded out via a physical interface or forwarded out via a
spanning VLAN specifically defined for this kind of traffic.
</p><p>In a network without Steelhead appliances, this forwarding over a
VLAN work fine because there is often nothing in the path which
worries about it except for some firewalls.
</p><p>In a network with Steelhead appliances, if the traffic going over
that spanning VLAN comes in touch with the Steelhead appliance it
might confuse the Steelhead appliance in the following way:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The simplified routing feature might learn the MAC address on the
  wrong interface and forward the packets to the wrong interface.
</p></li><li class="listitem"><p>The optimization service will count the packets double in its
  statistics in the list of Current Connections.
</p></li><li class="listitem"><p>If the TCP SYN packets are forwarded through the Steelhead appliance
  again the real second TCP SYN of the client will be seen as the
  third TCP SYN and the Steelhead appliance will put that TCP session
  into pass-through too early.
</p></li></ul></div><p>If the spanning VLAN has to go over the WAN, make sure it leaves
the local network without it touching the Steelhead appliance.
</p><div class="figure"><a name="idp39191336"></a><p class="title"><b>Figure 5.158. The right location for a spanning VLAN on a switch</b></p><div class="figure-contents"><pre class="screen">     .-,(  ),-.    
  .-(          )-. 
 (       WAN      )
  '-(          ).-'
      '-.( ).-'    
          ^      __________    Steelhead       __________ 
          |     [          ]    _________     [          ]
          |     [          ]&lt;--[_________]&lt;---[          ]
          '-----[          ]                  [          ]
                [          ]&lt;-----------------[          ]
                [_...__...o]    Spanning      [_...__....]
                   Router       VLAN vlan        Switch
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39191912"></a>5.21. Web proxies and web caches</h2></div></div></div><p>Web proxies are servers in the network which proxy the traffic towards
the web server by terminating the TCP session towards the client and
establishing a TCP session towards the web server. The data retrieved
on the session towards the web server is forwarded to the client.
</p><div class="figure"><a name="idp39192232"></a><p class="title"><b>Figure 5.159. The TCP sessions towards a web proxy</b></p><div class="figure-contents"><pre class="screen">.--------.          .----------.          .------------.
| client | &lt;------&gt; | web proxy | &lt;------&gt; | web server |
'--------'          '----------'          '------------'
       TCP session from         TCP session from
      client to web proxy       web proxy to server
       on TCP port 8080          on TCP port 80
</pre></div></div><br class="figure-break"><p>Web proxies can also have a caching functionality, where static
objects requested by a remote web server are stored on the web proxy
and served to the client if the web proxy knows that the object is
still valid. This will save traffic on the link between the web
proxy and the web server, but the latency is often still there.
</p><p>For the Steelhead appliance, the issue is that the web proxy is
serving both plain-text and encrypted traffic on TCP port 8080 which
makes an optimal optimization on that TCP port impossible.
</p><p>The details of which web proxy server to use are configured on the
client's web browser and there are two approaches:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Manual configuration in the clients web browsers settings, where
  different proxies can be configured for HTTP, HTTPS and FTP
  protocols.
</p></li><li class="listitem"><p>Automatic configuration of the clients web browsers settings by
  the use of a Proxy Auto-Configuration file, a JavaScript file
  which parses the URL about to be retrieved and returns the proxy
  to be used.
</p></li></ul></div><p>By selecting different TCP port numbers for different kinds of
traffic, for example TCP port 8080 for HTTP traffic and TCP port
8443 for HTTPS traffic, it will be possible for the Steelhead
appliances to only optimize the plain-text HTTP traffic on TCP port
8080 and pass-through the encrypted HTTPS traffic on TCP port 8443.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39193768"></a>5.22. Security</h2></div></div></div><p>With regarding to security on a Steelhead appliance, the following
aspects can be considered:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Access security, how to secure management access to the Steelhead
  appliance.
</p></li><li class="listitem"><p>Data security, how the data stored on the Steelhead appliance is
  secured.
</p></li><li class="listitem"><p>Network security, how data transmitted between Steelhead appliances
  is secured.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39194728"></a>5.22.1. Access Security towards the Steelhead appliance</h3></div></div></div><p>The management interfaces of the Steelhead appliance can be accessed
via the CLI, either via SSH or via Telnet, and via the GUI, either
via HTTP or via HTTPS. Further data can be retrieved from the device
via the SNMP service.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39195048"></a>5.22.1.1. Access Security via the Telnet service</h4></div></div></div><p>Traffic transmitted via the Telnet protocol is transmitted in clear
text. By default, the telnet service is not enabled on the Steelhead.
</p><div class="figure"><a name="idp39195432"></a><p class="title"><b>Figure 5.160. Telnet service is not enabled on this Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">SH (config) # no telnet-server enable
SH (config) # show telnet-server
Telnet server enabled:  no
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39195944"></a>5.22.1.2. Access Security via the SSH service</h4></div></div></div><p>Traffic transmitted via the Secure Shell protocol is encrypted. By
default the SSH service is enabled on the Steelhead appliance.
</p><p>It can be used for interactive traffic or for batch transfers with
the scp command, however the access to the device via scp is limited
to specific directories.
</p><p>By default, the SSH service accepts the SSH version 1 and SSH version
2 protocols, but it can be configured to use the SSH version 2
protocol only.
</p><p>Not all SSH ciphers are enabled anymore in the later RiOS versions.
PuTTY version 0.59 and before and SecureCRT are known to not to
like this. See the command
<code class="computeroutput">show ssh server allow-ciphers</code>
for the list of supported ciphers on the Steelhead appliance.
</p><p>The SSH service by default listens for connections on all interfaces
but it can be configured to listen only on specific interfaces.
</p><p>As a bonus point the SSH service can be told to listen to a different
TCP port. For Steelhead appliance configured with a public IP address
and is directly accessible from the public Internet, this is a must
to prevent dictionary attacks against the SSH service. However,
Steelhead appliances managed by the CMC cannot use any other TCP
port the default.
</p><div class="figure"><a name="idp39197224"></a><p class="title"><b>Figure 5.161. Secure SSH configuration</b></p><div class="figure-contents"><pre class="screen">SH (config) # ssh server listen enable
SH (config) # ssh server listen interface primary
SH (config) # ssh server v2-only enable
SH (config) # ssh server port 8022
SH (config) # show ssh server allow-ciphers
SSH server allowed ciphers:
---------------------------
aes128-cbc
aes192-cbc
aes256-cbc
SH (config) # show ssh server
SH server enabled: yes
SSH server listen enabled: yes
SSH port: 8022
SSH v2 only: yes
   Listen Interfaces:
      Interface: primary
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39197672"></a>5.22.1.3. Access security via the HTTP and HTTPS services</h4></div></div></div><p>Traffic transported via the HTTP protocol is transmitted in clear
text, while traffic transported via the HTTPS protocol is encrypted.
The HTTP and HTTPS services are both enabled by default.
</p><p>The HTTP and HTTPS services by default listen for connections on
all interfaces, but they can be configured to listen only on specific
interfaces.
</p><p>The HTTP and HTTPS services can be moved from the default TCP port
80 and TCP port 443 to different ports.
</p><p>The SSL ciphers used for the HTTPS server can be configured with
the standard Apache SSLCipherSuite statement options.
</p><div class="figure"><a name="idp39198376"></a><p class="title"><b>Figure 5.162. HTTP and HTTPS security configuration</b></p><div class="figure-contents"><pre class="screen">SH (config) # no web http enable
SH (config) # web httpd listen enable
SH (config) # web httpd listen interface primary
SH (config) # web http port 8080
SH (config) # web https enable
SH (config) # web https port 8443
SH (config) # web ssl cipher ALL:!ADH:RC4+RSA:+HIGH:!MEDIUM:!LOW:!SSLv2:!EXPORT
SH (config) # show web
Web-based management console enabled: yes
   HTTP enabled: no
   HTTP port: 80
   HTTPS enabled: yes
   HTTPS port: 8443
   SOAP server enabled: no
   SOAP server port: 9001
   Configure Mode TRAP: yes
   Inactivity timeout: 120 minutes
   Session timeout: 60 minutes
   Session renewal threshold: 30 minutes
   Timeout during report auto-refresh: yes
   SSLv2 enabled: no
   SSLv3 enabled: yes
   TLSv1 enabled: yes
   Listen enabled: yes
   Listen Interfaces:
      Interface: primary
SH (config) # show web ssl cipher
   Apache SSL cipher string: ALL:!ADH:RC4+RSA:+HIGH:!MEDIUM:!LOW:!SSLv2:!EXPORT
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39198824"></a>5.22.1.4. Access security via the SNMP services</h4></div></div></div><p>SNMP is an UDP based protocol. For the versions 1 and 2, the
authentication is done via a shared secret known as the community
string, which is transmitted in the clear. For version 3 the
authentication is done via a challenge response mechanism.
</p><p>The SNMP MIBs for the Riverbed appliances can be obtained from the
Riverbed Support website under the documentation section or from
the appliance itself under the Support tab in the GUI. There are
several different MIB files, one for each appliance:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>RBT-MIB: The Riverbed specific MIB which links the individual
  appliance MIBs towards the enterprises MIB. This one is required
  for all other MIBs.
</p></li><li class="listitem"><p>STEELHEAD-MIB: The Steelhead appliance specific MIB.
</p></li><li class="listitem"><p>STEELHEAD-EX-MIB: The Steelhead EX appliance specific MIB.
</p></li><li class="listitem"><p>CMC-MIB: The CMC appliance specific MIB.
</p></li><li class="listitem"><p>CONTROLLER-MIB: The Steelhead Mobile Controller appliance specific MIB.
</p></li><li class="listitem"><p>INTERCEPTOR-MIB: The Interceptor appliance specific MIB.
</p></li></ul></div><p>The SNMP service on the Steelhead appliance can only be used to
read data from the appliance, it cannot be used to write data to
it or to enable features.
</p><p>The SNMP service by default listens for connections on all interfaces,
but it can be configured to listen only on specific interfaces.
</p><div class="figure"><a name="idp39229672"></a><p class="title"><b>Figure 5.163. SNMP security configuration</b></p><div class="figure-contents"><pre class="screen">SH (config) # snmp-server listen enable 
SH (config) # snmp-server listen interface primary 
SH (config) # no snmp-server listen interface primary 
SH (config) # snmp-server listen interface primary 
SH (config) # show snmp 
SNMP enabled: yes
System location: 
System contact: 
Engine ID: 0x8000430b80bfb2484edda91d
Read-only community: 
Traps enabled: yes
Interface listen enabled: yes
Trap interface: primary
Persistent ifindex: no
Listen Interfaces:
   Interface: primary
No trap sinks configured.
</pre></div></div><br class="figure-break"><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39230120"></a>5.22.1.4.1. SNMP v1</h5></div></div></div><p>The SNMP version 1 implementation on the Steelhead appliance only
supports one community string. If the community string is correct,
then the Steelhead appliance will send the response. If the community
string is incorrect, then the Steelhead appliance will not respond.
There is no view on the data to limit the MIB tree that can be
accessed via SNMP version 1.
</p><div class="figure"><a name="idp39230440"></a><p class="title"><b>Figure 5.164. SNMPv1 request for system.sysName.0</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni primary -v -X -s 1600 port snmp 
tcpdump: listening on primary, link-type EN10MB (Ethernet), capture size 1600 bytes
07:39:15.699362 IP (tos 0x0, ttl 58, id 0, offset 0, flags [DF], proto UDP (17), length 71 \
    )
    10.0.1.1.39643 &gt; 10.0.1.5.161:  { SNMPv1 { GetRequest(28) R=18892990  .1.3.6.1.2.1.1.5 \
    .0 } } 
        0x0000:  4500 0047 0000 4000 3a11 103d 0a00 0101  E..G..@.:..=....
        0x0010:  0a00 0105 9adb 00a1 0033 88ab 3029 0201  .........3..0)..
        0x0020:  0004 0670 7562 6c69 63a0 1c02 0401 2048  ...public......H
        0x0030:  be02 0100 0201 0030 0e30 0c06 082b 0601  .......0.0...+..
        0x0040:  0201 0105 0005 00                        .......
07:39:15.699484 IP (tos 0x0, ttl 64, id 36, offset 0, flags [DF], proto UDP (17), length 7 \
    3)
    10.0.1.5.161 &gt; 10.0.1.1.39643:  { SNMPv1 { GetResponse(30) R=18892990  .1.3.6.1.2.1.1. \
    5.0="SH" } } 
        0x0000:  4500 0052 0024 4000 4011 0a0e 0a00 0005  E..R.$@.@.......
        0x0010:  0a00 0101 00a1 9adb 003e 30b9 3034 0201  .........&gt;0.04..
        0x0020:  0004 0670 7562 6c69 63a2 2702 0401 2048  ...public.'....H
        0x0030:  be02 0100 0201 0030 1930 1706 082b 0601  .......0.0...+..
        0x0040:  0201 0105 0004 0253 48                   .......SH
</pre></div></div><br class="figure-break"><p>As can be seen, the community string used here is
<span class="italics">public</span>,
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39231336"></a>5.22.1.4.2. SNMP v3</h5></div></div></div><p>The SNMP version 3 implementation on the Steelhead appliance supports
multiple users and views. A user is a username and password
combination, a view is a part of the MIB tree. Together they define
what an SNMPv3 client can see.
</p><p>In this example the username is "shtest" is allowed to see the view
"system", which includes the MIB tree .1.3.6.1.2.1.1, which is the
system MIB ".iso.org.dod.internet.mgmt.mib-2.system".
</p><div class="figure"><a name="idp39231784"></a><p class="title"><b>Figure 5.165. SNMPv3 configuration for the user "shtest" to the system MIB</b></p><div class="figure-contents"><pre class="screen">snmp-server acl group shtest security-level noauth read-view system
snmp-server engine-ID "0x8000430b80bfb2484edda91d"
snmp-server group shtest security-model usm security-name shtest
snmp-server user shtest password encrypted 0x54e42e390606150a0dcb67fa5b6775ca auth-protoco \
    l MD5
snmp-server view system included ".1.3.6.1.2.1.1"
</pre></div></div><br class="figure-break"><p>The SNMPv3 request will look like this on the wire:
</p><div class="figure"><a name="idp39232552"></a><p class="title"><b>Figure 5.166. SNMPv3 request for system.sysName.0</b></p><div class="figure-contents"><pre class="screen">SH (config) # tcpdump -ni primary -v -X -s 1600 port snmp 
tcpdump: listening on primary, link-type EN10MB (Ethernet), capture size 1600 bytes
12:25:01.539068 IP (tos 0x0, ttl 58, id 0, offset 0, flags [DF], proto UDP (17), length 92 \
    )
    10.0.1.1.35409 &gt; 10.0.1.5.161:  { SNMPv3 { F=r } { USM B=0 T=0 U= } { ScopedPDU E=  C= \
     { GetRequest(14) R=383165213  } } } 
	0x0000:  4500 005c 0000 4000 3a11 1028 0a00 0101  E..\..@.:..(....
	0x0010:  0a00 0105 8a51 00a1 0048 23f9 303e 0201  .....Q...H#.0&gt;..
	0x0020:  0330 1102 0424 9448 2702 0300 ffe3 0401  .0...$.H'.......
	0x0030:  0402 0103 0410 300e 0400 0201 0002 0100  ......0.........
	0x0040:  0400 0400 0400 3014 0400 0400 a00e 0204  ......0.........
	0x0050:  16d6 a31d 0201 0002 0100 3000            ..........0.
12:25:01.539478 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 13 \
    4)
    10.0.1.5.161 &gt; 10.0.1.1.35409:  { SNMPv3 { F= } { USM B=32 T=631 U= } { ScopedPDU E= 0 \
    x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { Report(31) R=383165213  .1.3.6.1. \
    6.3.15.1.1.4.0=1 } } } 
	0x0000:  4500 0086 0000 4000 4011 09fe 0a00 0105  E.....@.@.......
	0x0010:  0a00 0101 00a1 8a51 0072 30ed 3068 0201  .......Q.r0.0h..
	0x0020:  0330 1102 0424 9448 2702 0300 ffe3 0401  .0...$.H'.......
	0x0030:  0002 0103 041d 301b 040c 8000 430b 80bf  ......0.....C...
	0x0040:  b248 4edd a91d 0201 2002 0202 7704 0004  .HN.........w...
	0x0050:  0004 0030 3104 0c80 0043 0b80 bfb2 484e  ...01....C....HN
	0x0060:  dda9 1d04 00a8 1f02 0416 d6a3 1d02 0100  ................
	0x0070:  0201 0030 1130 0f06 0a2b 0601 0603 0f01  ...0.0...+......
	0x0080:  0104 0041 0101                           ...A..
12:25:01.710160 IP (tos 0x0, ttl 58, id 0, offset 0, flags [DF], proto UDP (17), length 13 \
    7)
    10.0.1.1.35409 &gt; 10.0.1.5.161:  { SNMPv3 { F=r } { USM B=32 T=631 U=shtest } { ScopedP \
    DU E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { GetRequest(28) R=383165214 \
      .1.3.6.1.2.1.1.5.0 } } } 
	0x0000:  4500 0089 0000 4000 3a11 0ffb 0a00 0101  E.....@.:.......
	0x0010:  0a00 0105 8a51 00a1 0075 99c2 306b 0201  .....Q...u..0k..
	0x0020:  0330 1102 0424 9448 2802 0300 ffe3 0401  .0...$.H(.......
	0x0030:  0402 0103 0423 3021 040c 8000 430b 80bf  .....#0!....C...
	0x0040:  b248 4edd a91d 0201 2002 0202 7704 0673  .HN.........w..s
	0x0050:  6874 6573 7404 0004 0030 2e04 0c80 0043  htest....0.....C
	0x0060:  0b80 bfb2 484e dda9 1d04 00a0 1c02 0416  ....HN..........
	0x0070:  d6a3 1e02 0100 0201 0030 0e30 0c06 082b  .........0.0...+
	0x0080:  0601 0201 0105 0005 00                   .........
12:25:01.710314 IP (tos 0x0, ttl 64, id 1, offset 0, flags [DF], proto UDP (17), length 13 \
    9)
    10.0.1.5.161 &gt; 10.0.1.1.35409:  { SNMPv3 { F= } { USM B=32 T=631 U=shtest } { ScopedPD \
    U E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { GetResponse(30) R=383165214 \
      .1.3.6.1.2.1.1.5.0="SH" } } } 
	0x0000:  4500 0094 0001 4000 4011 09ef 0a00 0105  E.....@.@.......
	0x0010:  0a00 0101 00a1 8a51 0080 30fb 3076 0201  .......Q..0.0v..
	0x0020:  0330 1102 0424 9448 2802 0300 ffe3 0401  .0...$.H(.......
	0x0030:  0002 0103 0423 3021 040c 8000 430b 80bf  .....#0!....C...
	0x0040:  b248 4edd a91d 0201 2002 0202 7704 0673  .HN.........w..s
	0x0050:  6874 6573 7404 0004 0030 3904 0c80 0043  htest....09....C
	0x0060:  0b80 bfb2 484e dda9 1d04 00a2 2702 0416  ....HN......'...
	0x0070:  d6a3 1e02 0100 0201 0030 1930 1706 082b  .........0.0...+
	0x0080:  0601 0201 0105 0004 0b53 48              .........SH


</pre></div></div><br class="figure-break"><p>The first two packets are a handshake between the SNMP client and
the SNMP server, the next two packets are the actual request.
</p><p>There are several failure situations here:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Unknown user name
</p></li><li class="listitem"><p>No access to a MIB tree
</p></li></ul></div><p>
</p><div class="sect5"><div class="titlepage"><div><div><h6 class="title"><a name="idp39233832"></a>5.22.1.4.2.1. Unknown user name</h6></div></div></div><p>In case of an unknown username, the answer will be a Report instead
of a GetResponse:
</p><div class="figure"><a name="idp39234152"></a><p class="title"><b>Figure 5.167. SNMPv3 request with an unknown username</b></p><div class="figure-contents"><pre class="screen">11:24:52.269466 IP (tos 0x0, ttl 58, id 0, offset 0, flags [DF], proto UDP (17), length 13 \
    7)
    10.0.1.1.43166 &gt; 10.0.1.5.161:  { SNMPv3 { F=r } { USM B=26 T=275 U=shtest } { ScopedP \
    DU E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { GetRequest(28) R=794705738 \
      .1.3.6.1.2.1.1.5.0 } } } 
11:24:52.269731 IP (tos 0x0, ttl 64, id 5, offset 0, flags [DF], proto UDP (17), length 14 \
    0)
    10.0.1.5.161 &gt; 10.0.1.1.43166:  { SNMPv3 { F= } { USM B=26 T=276 U=shtest } { ScopedPD \
    U E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { Report(31) R=794705738  .1. \
    3.6.1.6.3.15.1.1.3.0=3 } } } 
</pre></div></div><br class="figure-break"></div><div class="sect5"><div class="titlepage"><div><div><h6 class="title"><a name="idp39234600"></a>5.22.1.4.2.2. No access to a part of the MIB tree</h6></div></div></div><p>The SNMPv3 configuration allows views to a part of the MIB tree.
If the user is not configured to any part of the MIB tree, it will
return an authorizationError:
</p><div class="figure"><a name="idp39234920"></a><p class="title"><b>Figure 5.168. SNMPv3 request for an unconfigured view</b></p><div class="figure-contents"><pre class="screen">11:29:56.037463 IP (tos 0x0, ttl 58, id 0, offset 0, flags [DF], proto UDP (17), length 13 \
    6)
    10.0.1.1.45142 &gt; 10.0.1.5.161:  { SNMPv3 { F=r } { USM B=28 T=78 U=shtest } { ScopedPD \
    U E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { GetRequest(28) R=1322240049 \
      .1.3.6.1.2.1.1.5.0 } } } 
11:29:56.037671 IP (tos 0x0, ttl 64, id 1, offset 0, flags [DF], proto UDP (17), length 13 \
    6)
    10.0.1.5.161 &gt; 10.0.1.1.45142:  { SNMPv3 { F= } { USM B=28 T=78 U=shtest } { ScopedPDU \
     E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { GetResponse(28) R=1322240049 \
      authorizationError[errorIndex==0] .1.3.6.1.2.1.1.5.0= } } } 
</pre></div></div><br class="figure-break"><p>If the user is not allowed to see a certain part of the MIB tree, it will return a noSuchObject:
</p><div class="figure"><a name="idp39235496"></a><p class="title"><b>Figure 5.169. SNMPv3 request for a disallowed view</b></p><div class="figure-contents"><pre class="screen">12:05:52.867922 IP (tos 0x0, ttl 58, id 0, offset 0, flags [DF], proto UDP (17), length 13 \
    7)
    10.0.1.1.40284 &gt; 10.0.1.5.161:  { SNMPv3 { F=r } { USM B=28 T=2234 U=shtest } { Scoped \
    PDU E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { GetRequest(28) R=11416833 \
    94  .1.3.6.1.2.1.2.1.0 } } } 
12:05:52.868041 IP (tos 0x0, ttl 64, id 25, offset 0, flags [DF], proto UDP (17), length 1 \
    37)
    10.0.1.5.161 &gt; 10.0.1.1.40284:  { SNMPv3 { F= } { USM B=28 T=2234 U=shtest } { ScopedP \
    DU E= 0x800x000x430x0B0x800xBF0xB20x480x4E0xDD0xA90x1D C= { GetResponse(28) R=11416833 \
    94  .1.3.6.1.2.1.2.1.0=[noSuchObject] } } } 
</pre></div></div><br class="figure-break"></div></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39235944"></a>5.22.2. Data Security on the Steelhead appliance</h3></div></div></div><p>With regarding to data security on the Steelhead appliance, there
is data store encryption and there is the Secure Vault.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39244520"></a>5.22.2.1. Data store encryption</h4></div></div></div><p>The data store on the Steelhead appliance can be encrypted with the
AES_128, AES_192 or AES_256 algorithms. The expected performance
hit depends on workload and disk intensity, but about a 10% slower
data store I/O should be expected.
</p><div class="figure"><a name="idp39244840"></a><p class="title"><b>Figure 5.170. Data store encryption level</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-datastoreencryption.png" align="middle" alt="Data store encryption level"></td></tr></table></div></div></div><br class="figure-break"><p>After a restart of the optimization service with the 
<span class="italics">Clear the data store</span>
option enabled, the data store will be recreated and data will be
written in an encrypted format:
</p><div class="figure"><a name="idp39246056"></a><p class="title"><b>Figure 5.171. Recreation of an encrypted data store</b></p><div class="figure-contents"><pre class="screen">SH cli[10962]: [cli.INFO]: user admin: Executing command: restart clean
SH cli[10962]: [cli.INFO]: user admin: Command restart clean authorized
[...]
SH sport[11423]: [sport.INFO] - {- -} Stage 1 initialization starting...
SH sport[11423]: [segstore/DatastoreDiskOffset.INFO] - {- -} Initialized Special disk offs \
    et
[...]
SH sport[11423]: [segstore/peertable.INFO] - {- -} Peer table. Num peers : 4096 Groups : 1 \
    024 Pages : 9 Min Disconnect time : 86400
SH sport[11423]: [segstore.INFO] - {- -} Starting Persistent Store, config:  diskpolicy li \
    near cachepgs 1250000 hashbits 59 nblocks 4096 replacement_policy RVBDLRU w_behind 102 \
    4 r_ahead 1 w_queue_depth 128 encryption_type AES_128 clean_start 1
[...]
SH sport[11423]: [segstore/checker.NOTICE] - {- -} Creating a new data store. All existing \
     data will be erased.
[...]
SH sport[11423]: [sport.NOTICE] - {- -} Sport ready.
[...]
SH mgmtd[12237]: [mgmtd.INFO]: Exiting bypass mode
SH mgmtd[12237]: [mgmtd.INFO]: Traffic is now being optimized.
</pre></div></div><br class="figure-break"><p>If some experimenting has been done with data store encryption and
a data store has not been cleaned, the following message will be
printed and the optimization service will not start:
</p><div class="figure"><a name="idp39246632"></a><p class="title"><b>Figure 5.172. After a move from AES_128 encryption to no encryption</b></p><div class="figure-contents"><pre class="screen">SH sport[15692]: [segstore.INFO] - {- -} Starting Persistent Store, config:  diskpolicy li \
    near cachepgs 1250000 hashbits 59 nblocks 4096 replacement_policy RVBDLRU w_behind 102 \
    4 r_ahead 1 w_queue_depth 128 encryption_type NONE clean_start 0
[...]
SH sport[15692]: [segstore/drive/0 [/dev/md0].ERR] - {- -}   Encryption level mismatch.  C \
    urrently configured for: NONE but datastore is encrypted with: AES_128
SH sport[15692]: [mgmt.INFO] - {- -} Sending datastore alarm to true
SH sport[15692]: [segstore/drive/0 [/dev/md0].ERR] - {- -}  Segment store header invalid r \
    etry the dup header
SH sport[15692]: [segstore.ERR] - {- -} no good drives
SH sport[15692]: [segstore/drive/0 [/dev/md0].INFO] - {- -} destroying pending i/o stats
SH sport[15692]: [segstore.ALERT] - {- -} HALT Unable to initialize persistent store!
[...]
SH sport[15692]: [mgmt.WARN] - {- -} A corruption was found in the datastore. The datastor \
    e may not have been cleaned after the encryption type was changed.
SH sport[15692]: [mgmt.INFO] - {- -} Notifying management system that the datastore is cor \
    rupt.
SH sport[15692]: [mgmt.INFO] - {- -} Notifying management system that the service is stayi \
    ng down.
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39247144"></a>5.22.2.2. Secure Vault</h4></div></div></div><p>The Secure Vault is an encrypted partition which contains the
encrypted data store key and the SSL certificates and SSL private
keys used for Secure Peering and SSL pre-optimization.
</p><p>By default, the Secure Vault has been locked with a standard password
which the Steelhead appliance can use to open the Secure Vault
during its startup process. If this password is changed, the startup
process cannot open the Secure Vault and the optimization service
will not start until the Secure Vault is unlocked. The unlocking
can be done either via the GUI or the CLI or automatically by the
CMC.
</p><div class="figure"><a name="idp39247592"></a><p class="title"><b>Figure 5.173. Secure Vault is not unlocked yet</b></p><div class="figure-contents"><pre class="screen">SH mgmtd[12258]: [mgmtd.INFO]: EVENT:  /rbt/discovery/event/sport_mgmt_disc_init_done
SH statsd[16376]: [statsd.NOTICE]: Alarm triggered for falling error for event secure_vaul \
    t_unlocked
SH mgmtd[12258]: [mgmtd.INFO]: EVENT:  /stats/event/alarm_activity
SH mgmtd[12258]: [mgmtd.INFO]: EVENT:  /rbt/health/event/activity
SH mgmtd[12258]: [mgmtd.INFO]: EVENT:  /stats/events/secure_vault_unlocked/falling/error
SH mgmtd[12258]: [mgmtd.INFO]: Secure vault must be unlocked
SH mgmtd[12258]: [mgmtd.INFO]: SSL acceleration and the secure datastore cannot be used un \
    til the secure vault has been unlocked.  To unlock the secure vault, please visit: htt \
    ps://SH/mgmt/gui?p=setupVault
SH mgmtd[12258]: [mgmtd.INFO]: EVENT:  /secure_vault/event/unlock_needed
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39248040"></a>5.22.3. Network security between Steelhead appliances</h3></div></div></div><p>By default, the inner channel of the optimized TCP sessions is not
encrypted. There are two ways to encrypt the inner channel: Via the
IPsec Secure Peering feature, on which the IP packets with the inner
channel gets transported via an IPsec tunnel over the WAN, or via
the SSL Secure Peering feature, where the TCP session with the inner
channel gets SSL encrypted.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39248360"></a>5.22.3.1. IPsec Secure Peering</h4></div></div></div><p>The configuration of the IPsec tunnels is symmetric, which means
that the configuration on all the Steelhead appliances in the field
which need secure peering between each other need to be in sync:
Encryption policy, authentication policy and the shared secret.
One incompatible mismatch between two IPsec peering configurations
and all traffic is passed through unoptimized.
</p><p>IPsec Secure Peering configuration is based on the IP addresses of
the remote peer. If a renumbering of an in-path IP address happens
or an additional in-path interface gets enabled, all peering Steelhead
appliances need to be reconfigured to make sure that all optimized
traffic towards this server stays encrypted.
</p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39248872"></a>5.22.3.1.1. Setup of an IPsec Secure Peering encrypted inner channel</h5></div></div></div><p>Assume there is no IPsec tunnel setup towards the remote Steelhead
appliance yet:
</p><p>After the auto-discovery phase the inner channel gets setup: First
the IPsec tunnel will be established towards the remote Steelhead
appliance. Then the OOB Splice and Connection Pool will be setup
over that IPsec tunnel. One of the TCP sessions of the inner channel
will be converted into an inner channel and the inner channel is
encrypted.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39249384"></a>5.22.3.1.2. IPsec Secure Peering only enabled on one side</h5></div></div></div><p>When the IPsec Secure Peering is configured on only one side of the
inner channel, the client-side Steelhead appliance will try to setup
an IPsec tunnel towards the server-side Steelhead appliance but
fail. At the third TCP SYN packet from the client, the optimization
service will pass-through the TCP session unoptimized.
</p><div class="figure"><a name="idp39249704"></a><p class="title"><b>Figure 5.174. IPsec negotiation fails between two Steelhead appliances because the other side isn't configured for IPsec Secure Peering</b></p><div class="figure-contents"><pre class="screen">CSH racoon: 2012-06-16 10:10:45: INFO: IPSec-SA request for 192.168.1.6 queued due to no p \
    hase1 found.
CSH racoon: 2012-06-16 10:10:45: INFO: initiate new phase 1 negotiation: 10.0.1.6[500]&lt;=&gt;1 \
    92.168.1.6[500]
CSH racoon: 2012-06-16 10:10:45: INFO: begin Identity Protection mode.
CSH racoon: 2012-06-16 10:11:16: ERROR: phase2 negotiation failed due to time up waiting f \
    or phase1. ESP 192.168.1.6[500]-&gt;10.0.1.6[500]
CSH racoon: 2012-06-16 10:11:16: INFO: delete phase 2 handler.
CSH racoon: 2012-06-16 10:11:45: ERROR: phase1 negotiation failed due to time up. f2763262 \
    b03147b0:0000000000000000
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39250152"></a><p class="title"><b>Figure 5.175. Tcpdump shows that the IPsec service on the remote Steelhead appliance is not enabled</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni wan0_0 port 500 or icmp
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
10:29:37.907488 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 1 I ident
10:29:38.040176 IP 192.168.1.6 &gt; 10.0.1.6: ICMP 192.168.1.6 udp port 500 unreachable, leng \
    th 140
</pre></div></div><br class="figure-break"><p>The
<span class="italics">ICMP Port Unreachable</span>
message shows that the IPsec service on the remote Steelhead appliance
is not operational.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39250984"></a>5.22.3.1.3. IPsec Secure Peering incompatible mismatch in parameters</h5></div></div></div><p>The IPsec options can be depending on the model. For example the
50, 100, 200 and 300 models can only do encryption with the DES
algorithm and cannot do encryption with the 3DES, AES or AES256
algorithms. When they setup an IPsec tunnel towards a Steelhead
appliance which does not permit the low-level encryption algorithms,
the setup of the IPsec tunnel will fail:
</p><div class="figure"><a name="idp39251368"></a><p class="title"><b>Figure 5.176. Incompatible options in the IPsec configuration</b></p><div class="figure-contents"><pre class="screen">CSH sport[6467]: [splice/client.INFO] 914 {10.0.1.1:58923 192.168.1.1:25} init client 10.0 \
    .1.1:58923 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connect \
    ed: no
CSH racoon: 2012-06-16 10:34:45: INFO: IPsec-SA request for 192.168.1.6 queued due to no p \
    hase1 found.
CSH racoon: 2012-06-16 10:34:45: INFO: initiate new phase 1 negotiation: 10.0.1.6[500]&lt;=&gt;1 \
    92.168.1.6[500]
CSH racoon: 2012-06-16 10:34:45: INFO: begin Identity Protection mode.
CSH racoon: 2012-06-16 10:34:45: INFO: received Vendor ID: DPD
CSH racoon: 2012-06-16 10:34:46: INFO: ISAKMP-SA established 10.0.1.6[500]-192.168.1.6[500 \
    ] spi:59b96bb1d3f8513c:42bfd4b628b8d2ee
CSH racoon: 2012-06-16 10:34:46: INFO: initiate new phase 2 negotiation: 10.0.1.6[500]&lt;=&gt;1 \
    92.168.1.6[500]
CSH sport[6467]: [splice/client.ERR] 914 {10.0.1.1:58923 192.168.1.1:25} (clnt: 10.0.1.1:5 \
    8923 peer: 192.168.1.6:7800 serv: 192.168.1.1:25) Error connecting to peer: Resource t \
    emporarily unavailable. trpy: TRPY_NONE
CSH sport[6467]: [splice/client.INFO] 914 {10.0.1.1:58923 192.168.1.1:25} fini client 10.0 \
    .1.1:58923 server 192.168.1.1:25 cfe 10.0.1.6:0 sfe 192.168.1.6:7800 app TCP

SSH sport[7137]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:0 clnt: 10.0.1.1:58923 ser \
    v: 192.168.1.1:25) init
SSH racoon: 2012-06-16 10:18:56: INFO: respond new phase 1 negotiation: 192.168.1.6[500]&lt;= \
    &gt;10.0.1.6[500]
SSH racoon: 2012-06-16 10:18:56: INFO: begin Identity Protection mode.
SSH racoon: 2012-06-16 10:18:56: INFO: received Vendor ID: DPD
SSH racoon: 2012-06-16 10:18:57: INFO: ISAKMP-SA established 192.168.1.6[500]-10.0.1.6[500 \
    ] spi:59b96bb1d3f8513c:42bfd4b628b8d2ee
SSH sport[7137]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40302 clnt: 10.0.1.1:58923 \
     serv: 192.168.1.1:25) fini
SSH racoon: 2012-06-16 10:19:27: INFO: purging ISAKMP-SA spi=59b96bb1d3f8513c:42bfd4b628b8 \
    d2ee.
SSH racoon: 2012-06-16 10:19:27: INFO: purged ISAKMP-SA spi=59b96bb1d3f8513c:42bfd4b628b8d \
    2ee.
SSH racoon: 2012-06-16 10:19:27: ERROR: unknown Informational exchange received.
SSH racoon: 2012-06-16 10:19:28: INFO: ISAKMP-SA deleted 192.168.1.6[500]-10.0.1.6[500] sp \
    i:59b96bb1d3f8513c:42bfd4b628b8d2ee
SSH racoon: 2012-06-16 10:19:32: ERROR: unknown Informational exchange received.
SSH racoon: 2012-06-16 10:19:37: ERROR: unknown Informational exchange received.
SSH racoon: 2012-06-16 10:19:42: ERROR: unknown Informational exchange received.
SSH racoon: 2012-06-16 10:19:47: ERROR: unknown Informational exchange received.
SSH racoon: 2012-06-16 10:20:31: INFO: respond new phase 1 negotiation: 192.168.1.6[500]&lt;= \
    &gt;10.0.1.6[500]
SSH racoon: 2012-06-16 10:20:31: INFO: begin Identity Protection mode.
SSH racoon: 2012-06-16 10:20:31: INFO: received Vendor ID: DPD
SSH racoon: 2012-06-16 10:20:31: INFO: ISAKMP-SA established 192.168.1.6[500]-10.0.1.6[500 \
    ] spi:0ecac81771e26077:144dc771e6186531
SSH racoon: 2012-06-16 10:20:32: INFO: respond new phase 2 negotiation: 192.168.1.6[500]&lt;= \
    &gt;10.0.1.6[500]
SSH racoon: 2012-06-16 10:20:32: WARNING: trns_id mismatched: my:3DES peer:DES
SSH racoon: 2012-06-16 10:20:32: ERROR: not matched
SSH racoon: 2012-06-16 10:20:32: ERROR: no suitable policy found.
SSH racoon: 2012-06-16 10:20:32: ERROR: failed to pre-process packet.
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39251880"></a><p class="title"><b>Figure 5.177. Tcpdump shows that there are incompatible values in the configuration</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni wan0_0 port 500 or icmp
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
10:34:45.517507 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 1 I ident
10:34:45.678227 IP 192.168.1.6.500 &gt; 10.0.1.6.500: isakmp: phase 1 R ident
10:34:45.706988 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 1 I ident
10:34:45.849801 IP 192.168.1.6.500 &gt; 10.0.1.6.500: isakmp: phase 1 R ident
10:34:45.927267 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 1 I ident[E]
10:34:46.209888 IP 192.168.1.6.500 &gt; 10.0.1.6.500: isakmp: phase 1 R ident[E]
10:34:46.209971 IP 192.168.1.6.500 &gt; 10.0.1.6.500: isakmp: phase 2/others R inf[E]
10:34:46.210702 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 2/others I inf[E]
10:34:51.342009 IP 192.168.1.6.500 &gt; 10.0.1.6.500: isakmp: phase 2/others R inf[E]
</pre></div></div><br class="figure-break"></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39252328"></a>5.22.3.1.4. Incorrect shared secrets</h5></div></div></div><p>When the IPsec shared secret doesn't match, the setup of the IPsec
tunnel will fail.
</p><div class="figure"><a name="idp39252712"></a><p class="title"><b>Figure 5.178. Incorrect shared secret</b></p><div class="figure-contents"><pre class="screen">CSH sport[6467]: [splice/client.INFO] 987 {10.0.1.1:65379 192.168.1.1:25} init client 10.0 \
    .1.1:65379 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connect \
    ed: no
CSH racoon: 2012-06-16 10:58:55: INFO: IPsec-SA request for 192.168.1.6 queued due to no p \
    hase1 found.
CSH racoon: 2012-06-16 10:58:55: INFO: initiate new phase 1 negotiation: 10.0.1.6[500]&lt;=&gt;1 \
    92.168.1.6[500]
CSH racoon: 2012-06-16 10:58:55: INFO: begin Identity Protection mode.
CSH racoon: 2012-06-16 10:58:56: INFO: received Vendor ID: DPD
CSH sport[6467]: [splice/client.ERR] 987 {10.0.1.1:65379 192.168.1.1:25} (clnt: 10.0.1.1:6 \
    5379 peer: 192.168.1.6:7800 serv: 192.168.1.1:25) Error connecting to peer: Resource t \
    emporarily unavailable. trpy: TRPY_NONE
CSH sport[6467]: [splice/client.INFO] 987 {10.0.1.1:65379 192.168.1.1:25} fini client 10.0 \
    .1.1:65379 server 192.168.1.1:25 cfe 10.0.1.6:0 sfe 192.168.1.6:7800 app TCP

SSH racoon: 2012-06-16 10:48:17: INFO: respond new phase 1 negotiation: 192.168.1.6[500]&lt;= \
    &gt;10.0.1.6[500]
SSH racoon: 2012-06-16 10:48:17: INFO: begin Identity Protection mode.
SSH racoon: 2012-06-16 10:48:17: INFO: received Vendor ID: DPD
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39253160"></a><p class="title"><b>Figure 5.179. Tcpdump shows that the IPsec negotiation fails because of an incorrect shared secret</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni wan0_0 port 500 or icmp
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
10:58:55.948616 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 1 I ident
10:58:56.082075 IP 192.168.1.6.500 &gt; 10.0.1.6.500: isakmp: phase 1 R ident
10:58:56.093290 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 1 I ident
10:58:56.237696 IP 192.168.1.6.500 &gt; 10.0.1.6.500: isakmp: phase 1 R ident
10:58:56.249238 IP 10.0.1.6.500 &gt; 192.168.1.6.500: isakmp: phase 1 I ident[E]
</pre></div></div><br class="figure-break"></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="operation_security_sslsecurepeering"></a>5.22.3.2. SSL Secure Peering</h4></div></div></div><p>SSL Secure Peering is the encryption of the inner channel of an
optimized TCP session via the Secure Sockets Layer protocol. Unlike
IPsec Secure Peering where the IP packets of the inner channel got
tunneled, with SSL Secure Peering it is only encrypting the TCP
payload of the inner channel.
</p><p>The advantages of this method are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The encryption starts after a TCP session of the Connection Pool
  has been converted into an inner channel. This makes it possible
  to use the Secure Peering feature for only certain protocols.
  This also makes it possible to fall-back to no encryption if the
  remote peer has not been configured properly.
</p></li><li class="listitem"><p>With IPsec Secure Peering all IP traffic from the Steelhead
  appliance towards the remote Steelhead appliance went through the
  IPsec tunnel, including ICMP traffic. With SSL Secure Peering
  only the optimized TCP session gets encrypted.
</p></li><li class="listitem"><p>With IPsec Secure Peering all traffic is seen as UDP traffic on
  UDP port 500, with SSL Secure Peering the inner channel is still
  visible on the WAN, making it possible to use a different WAN
  visibility to the TCP session and to apply QoS to the TCP session.
</p></li><li class="listitem"><p>With SSL Secure Peering, the dependency on knowing the IP addresses
  of the in-path interfaces of the remote Steelhead appliance is
  gone, the identification now happens on the SSL certificate of
  the remote Steelhead appliance.
</p></li></ul></div><p>The SSL Secure Peering can be enabled for SSL protocols only (via
an in-path rule which has SSL pre-optimization enabled), for secure
protocols (SSL, encrypted MAPI, encrypted Lotus Notes, encrypted
Citrix) or for all protocols.
</p><p>Before two Steelhead appliances setup a SSL session between them,
they need to trust each other. This can be done via three methods:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>SSL Peering certificates from unknown Steelhead appliances are
  stored in the SSL Peering Gray list. If the unknown Steelhead
  appliance is considered to be trusted, you can move it to the SSL
  Peering White list and SSL Secure Peering can be performed towards
  that Steelhead appliance. If the unknown Steelhead appliance is
  considered not to be trusted, you can move it to the SSL Peering
  Black list and SSL Secure Peering will never be performed towards
  that Steelhead appliance. This is extensive manual labour of the
  order O(N!) but available to the Steelhead appliance without the
  need for external software. Using a CMC will make his much easier.
</p></li><li class="listitem"><p>The SSL Peering feature can be configured with a trusted CA
  certificate. As such, this Steelhead appliance will trust SSL peering
  certificates signed by this CA. This is an one time configuration
  per Steelhead appliance making it an issue of the order O(N) but an
  external certificate authority is required.
</p><p>  There is also the Mobile Trust feature, which is the same approach
  but specifically for the SSL Peering CA certificates for Mobile
  Steelhead Mobile Controllers.
</p></li><li class="listitem"><p>Support for the Simple Certificate Enrollment Protocol, which
  allows the importing of the SSL Certificate generated by an
  automated Certificate Authority.
</p></li></ul></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39256040"></a>5.22.3.2.1. Setup of an SSL Secure Peering encrypted inner channel</h5></div></div></div><p>The auto-discovery phase and the setup of the OOB Splice and
Connection Pool are the same as a normal deployment. During the
conversion from the TCP session of the Connection Pool to an inner
channel, the request for an secure inner channel gets added. Once the
SSL session has been setup, the inner channel data gets transported
over it.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39256424"></a>5.22.3.2.2. Unknown SSL peering certificates</h5></div></div></div><p>In case the SSL peering certificate of a remote Steelhead appliance
does not exist in the SSL Peering White list, the setup of the SSL
session will fail with these messages:
</p><div class="figure"><a name="idp39322344"></a><p class="title"><b>Figure 5.180. Failure due to an unknown SSL peering certificate</b></p><div class="figure-contents"><pre class="screen">CSH sport[13790]: [splice/client.INFO] 26 {10.0.1.1:15092 192.168.1.1:25} init client 10.0 \
    .1.1:15092 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connect \
    ed: yes
CSH sport[13790]: [splice/client.INFO] 26 {10.0.1.1:15092 192.168.1.1:25} Splice client si \
    de initializing: No protocol port = 25 protocol id = TCP(0) transport = TRANSPORT_ID_S \
    SLINNER
CSH sport[13790]: [splice/client.INFO] 26 {10.0.1.1:15092 192.168.1.1:25} Start flowing, l \
    port 40336, rport 7800, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT \
    _ID_SSLINNER, TPTOPT_NONE(0x0)
CSH sport[13790]: [ssl.WARN] - {- -} Failure in certificate verification:  error num: 18 e \
    rror string: self signed certificate depth: 0 subject name: /CN=Steelhead A17WT000628B \
    C/O=Riverbed Technology, Inc./L=San Francisco/ST=California/C=--
CSH sport[13790]: [keystore/0x9bdaa80.WARN] - {- -} Failure in certificate verification, s \
    ubject: "/CN=Steelhead A17WT000628BC/O=Riverbed Technology, Inc./L=San Francisco/ST=Ca \
    lifornia/C=--"
CSH sport[13790]: [keystore/0x9bdaa80.WARN] - {- -} Failed with error num: 18, error strin \
    g: "self signed certificate", depth: 0
CSH sport[13790]: [sslinnerchan/CliConnect.WARN] 26 {10.0.1.1:15092 192.168.1.1:25} The se \
    rver-side steelhead at ip address: 192.168.1.6 couldn't verify this steelhead's peerin \
    g certificate. Perhaps the peering trust list on server-side steelhead is misconfigure \
    d
CSH sport[13790]: [sslinnerchan/CliConnect.WARN] 26 {10.0.1.1:15092 192.168.1.1:25} SSL co \
    nnection to an untrusted Steelhead appliance at IP address: 192.168.1.6 while attempti \
    ng to optimize the end-to-end SSL connection between client: 10.0.1.1:15092 and server \
    : 192.
CSH sport[13790]: [sslinnerchan/CliConnect.WARN] 26 {10.0.1.1:15092 192.168.1.1:25} 168.1. \
    1:25
CSH sport[13790]: [mgmt.INFO] - {- -} mgmtd notified that ssl peer 192.168.1.6 failed hand \
    shake
CSH mgmtd[3768]: [mgmtd.INFO]: EVENT:  /rbt/sport/ssl/event/peer_info
CSH mgmtd[3768]: [mgmtd.NOTICE]: Peer 192.168.1.6 is created/updated in the gray list.

SSH sport[10600]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:0 clnt: 10.0.1.1:15092 se \
    rv: 192.168.1.1:25) init
SSH sport[10600]: [splice/server.INFO] 1 {- -} init cfe 10.0.1.6:40336 sfe 192.168.1.6:780 \
    0
SSH sport[10600]: [splice/server.INFO] 1 {- -}  sock 41 id 548627 client 10.0.1.1:15092 se \
    rver 192.168.1.1:25 remote inner port 7800 trpy TRPY_NONE
SSH sport[10600]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40268 clnt: 10.0.1.1:1509 \
    2 serv: 192.168.1.1:25) acquired
SSH sport[10600]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40268 clnt: 10.0.1.1:1509 \
    2 serv: 192.168.1.1:25) fini
SSH sport[10600]: [splice/server.INFO] 1 {- -} Splice server side initializing: No protoco \
    l port = 25 transport = TRANSPORT_ID_SSLINNER
SSH sport[10600]: [splice/server.INFO] 1 {10.0.1.1:15092 192.168.1.1:25} Start flowing, lp \
    ort 7800, rport 40336, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_ \
    ID_SSLINNER, TPTOPT_NONE(0x0)
SSH sport[10600]: [ssl.WARN] - {- -} Failure in certificate verification:  error num: 18 e \
    rror string: self signed certificate depth: 0 subject name: /CN=Steelhead A41SU00085F1 \
    3/O=Riverbed Technology, Inc./L=San Francisco/ST=California/C=--
SSH sport[10600]: [keystore/0x9bda9a0.WARN] - {- -} Failure in certificate verification, s \
    ubject: "/CN=Steelhead A41SU00085F13/O=Riverbed Technology, Inc./L=San Francisco/ST=Ca \
    lifornia/C=--"
SSH sport[10600]: [keystore/0x9bda9a0.WARN] - {- -} Failed with error num: 18, error strin \
    g: "self signed certificate", depth: 0
SSH sport[10600]: [sslinnerchan/SrvAccept.WARN] 1 {10.0.1.1:15092 192.168.1.1:25} SSL conn \
    ection from an untrusted Steelhead appliance at IP address: 10.0.1.6 while attempting  \
    to optimize the end-to-end SSL connection between client: 10.0.1.1:15092 and server: 1 \
    92.168
SSH sport[10600]: [sslinnerchan/SrvAccept.WARN] 1 {10.0.1.1:15092 192.168.1.1:25} .1.1:25
SSH sport[10600]: [mgmt.INFO] - {- -} mgmtd notified that ssl peer 10.0.1.6 failed handsha \
    ke
SSH sport[10600]: [sslinnerchan/SrvAccept.WARN] 1 {10.0.1.1:15092 192.168.1.1:25} Informin \
    g the client-side steelhead about failure to verify its peering certificate, so that f \
    uture connections are temporarily bypassed.
SSH mgmtd[4019]: [mgmtd.INFO]: EVENT:  /rbt/sport/ssl/event/peer_info
SSH mgmtd[4019]: [mgmtd.NOTICE]: Peer 10.0.1.6 is created/updated in the gray list.
</pre></div></div><br class="figure-break"><p>The list of entries in the Secure Peering Gray list can be found
with the command
<code class="computeroutput">show secure-peering gray-lst-peers</code>.
This output does only contain the IP address of the in-path interface
and the hostname while the log files only contain the IP address
of the in-path interface and the Steelhead appliance serial number.
</p><div class="figure"><a name="idp39323304"></a><p class="title"><b>Figure 5.181. Output of the command "show secure-peering gray-lst-peers"</b></p><div class="figure-contents"><pre class="screen">CSH # show secure-peering gray-lst-peers
 IP               Hostname                                             Exp Date
 ---------------  -----------------------------------  ------------------------
 192.168.1.6      SSH                                  Nov 29 03:44:24 2012 GMT

SSH # show secure-peering gray-lst-peers
 IP               Hostname                                             Exp Date
 ---------------  -----------------------------------  ------------------------
 10.0.1.6         CSH                                  Jun 20 01:42:12 2013 GMT
</pre></div></div><br class="figure-break"><p>Use the command
<code class="computeroutput">secure-peering gray-lst-peer &lt;IP address&gt; trust</code>
to move an entry from the Secure Peering Gray list to the Secure
Peering White list. After the move, new TCP connections should be
optimized with a secure inner channel, this can be seen with the
transport option set to TRANSPORT_ID_SSLINNER:
</p><div class="figure"><a name="idp39324200"></a><p class="title"><b>Figure 5.182. Optimized TCP session with an encrypted inner channel</b></p><div class="figure-contents"><pre class="screen">CSH sport[25745]: [splice/client.INFO] 1 {10.0.1.1:44130 192.168.1.1:25} init client 10.0. \
    1.1:44130 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connecte \
    d: yes 
CSH sport[25745]: [splice/client.INFO] 1 {10.0.1.1:44130 192.168.1.1:25} Splice client sid \
    e initializing: No protocol port = 25 protocol id = TCP(0) transport = TRANSPORT_ID_SS \
    LINNER 
CSH sport[25745]: [splice/client.INFO] 1 {10.0.1.1:44130 192.168.1.1:25} Start flowing, lp \
    ort 40269, rport 7800, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_ \
    ID_SSLINNER, TPTOPT_NONE(0x0) 
</pre></div></div><br class="figure-break"></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39324712"></a>5.22.3.2.3. Remote appliances without the SSL license</h5></div></div></div><p>When a remote Steelhead appliance does not have a valid SSL license,
the secure inner channel cannot be setup and the following message will
be displayed in the logs:
</p><div class="figure"><a name="idp39325032"></a><p class="title"><b>Figure 5.183. Remove Steelhead appliance does not have a valid SSL license</b></p><div class="figure-contents"><pre class="screen">SH sport[994]: [splice/client.WARN] 482649 {10.0.1.1:2800 192.168.1.1:135} SSL license is  \
    either absent or invalid on peer Steelhead appliance with IP address: 192.168.1.6
SH sport[994]: [splice/client.NOTICE] 482649 {10.0.1.1:2800 192.168.1.1:135} Together, loc \
    al and peer steelhead appliance at: 192.168.1.6:7800 request encryption of secure appl \
    ication traffic over WAN. And this connection between client: 10.0.1.1 and
SH sport[994]: [splice/client.NOTICE] 482649 {10.0.1.1:2800 192.168.1.1:135}  server: 192. \
    168.1.1.  201:135 belongs to a secure application protocol: EPM(4) But one (or both) o \
    f them is missing a valid enhanced cryptographic license.
</pre></div></div><br class="figure-break"></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39325608"></a>5.23. The Riverbed Services Platform</h2></div></div></div><p>The Riverbed Services Platform (RSP) is a VMware based solution to
be able to run virtual machines on the xx20 and xx50 series models.
</p><p>The Virtual Services Platform (VSP) is for the EX series models and
discussed in a different chapter.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39326056"></a>5.23.1. Design of the RSP feature</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39326248"></a>5.23.1.1. Prerequisites</h4></div></div></div><p>To be able to run the RSP service on the Steelhead appliance, the
following conditions need to be met:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>An RSP license needs to be installed. This will allow the RSP
  software to be installed and started.
</p></li><li class="listitem"><p>Extra RSP memory needs to be installed.  This RSP memory is not
  used by the optimization service.
</p><p>  For the 6050 model, this is a 4 Gb memory module but it will only
  use 2 Gb of it.
</p><p>  For the 1050 model, this is a 2 Gb memory module. However if more
  RSP memory is required it is possible to add another 2 Gb to it.
</p><p>  For the 150, 250 and 550 models, this is a 2 Gb memory module.
  However because of the design of the machine only 1.5 Gb of the
  memory is available for RSP.
</p><p>  For the other models, this is a 2 Gb memory module.
</p></li><li class="listitem"><p>The RSP image needs to be installed.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39241832"></a>5.23.1.2. How it fits in the system</h4></div></div></div><p>First some definitions:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>An RSP image is the software image of the RSP service as provided
  by Riverbed. Once installed it has become the RSP service.
</p></li><li class="listitem"><p>The RSP service is the virtualization software, based on VMware
  server.
</p></li><li class="listitem"><p>An RSP package is the virtual machine software image as generated
  by the RSP Package Generator. Once installed in the RSP service
  it can become a RSP slot.
</p></li><li class="listitem"><p>An RSP slot is a virtual machine, running on top of the RSP
  service.
</p></li></ul></div><p>The RSP service runs on top of RiOS. The RSP slots run on top of
the RSP service.
</p><div class="figure"><a name="idp39243112"></a><p class="title"><b>Figure 5.184. RSP on RiOS</b></p><div class="figure-contents"><pre class="screen">.-------------------------------------------.
| RSP slot         | RSP slot      | ...    |
| (Windows server) | (Linux based) |        |
|-------------------------------------------|
|        RSP service (VMware server)        |
|-------------------------------------------|
|              RiOS (Linux)                 |
'-------------------------------------------'
</pre></div></div><br class="figure-break"><p>The networks to the RSP slots can be provided in several ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The RSP slot can be configured to be on the network of the primary
  or auxiliary interface and will need to be configured to have an IP
  address of that IP subnet. This can be used for stand-alone services
  like an Active Directory Domain Controller or a local DNS/DHCP server.
</p></li><li class="listitem"><p>The RSP slot can be configured to be on the in-path interface
  on the LAN side, where it will receive the unoptimized traffic.
  This can be used for a transparent proxy or for an IPS service.
</p></li><li class="listitem"><p>The RSP slot can be configured to be on the in-path interface
  on the WAN side, where it will receive the optimized traffic.
  This can be used for a traffic shaper or the SCPS service.
</p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39334568"></a>5.23.2. Possible issues</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39334760"></a>5.23.2.1. Limitations</h4></div></div></div><p>Because the RSP slot runs in the Steelhead appliance, there are
several hardware components which are not available for the RSP
slots:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>No floppy disk drives
</p></li><li class="listitem"><p>No CD-ROM drivers
</p></li><li class="listitem"><p>No audio
</p></li><li class="listitem"><p>No access to the USB ports
</p></li></ul></div><p>The RSP Package Generator checks for these issues and will generate
a warning when they are defined in the virtual machine.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39336040"></a>5.23.2.2. Upgrades</h4></div></div></div><p>When the RiOS version is upgraded, make sure to check the release
notes to see if the RSP image needs to be upgraded too. When the
RSP image needs to be upgraded too, perform the following steps:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Upload the new RiOS image.
</p></li><li class="listitem"><p>Upload the new RSP image.
</p></li><li class="listitem"><p>Install the new RiOS image.
</p></li><li class="listitem"><p>Disable the RSP service.
</p></li><li class="listitem"><p>Reboot the Steelhead appliance.
</p></li><li class="listitem"><p>Install the new RSP image.
</p></li><li class="listitem"><p>Enable the RSP service.
</p></li></ul></div><p>If there are multiple RiOS images to be installed, do not install
the latest RSP image until the RiOS version required has been
reached.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39337896"></a>5.23.2.3. Excessive paging</h4></div></div></div><p>Despite having 2 Gb of RSP memory available, this is not fully
available to the RSP slots. The RSP service itself uses about 384
Mb, leaving 1664 Mb available for the RSP slots.
</p><p>So if the Steelhead appliance has raised the paging alarm and RSP
is enabled, make sure that the memory for the total memory in use
on the RSP slots is less than 1664 Mb.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39338344"></a>5.23.2.4. VLAN tagging on primary interface</h4></div></div></div><p>VLAN trunking is not supported on the primary and auxiliary interfaces.
So the virtual machine always needs to have an IP address from the
IP subnets defined on the primary or auxiliary interfaces.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39338856"></a>5.24. Access related problems</h2></div></div></div><p>During the operation of the device it is possible that the GUI or
CLI access is not working. It is important to notice various different
styles of not working:
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39339176"></a>5.24.1. Unable to access the GUI</h3></div></div></div><p>For the Steelhead appliance, the GUI consists of two pieces: A
management application and a web server which acts as front-end of
the management application.
</p><p>When connecting to the root of the GUI, for example via the URL
http://10.0.1.5/, the web server will answer the request for the
root of the GUI with a redirection to /mgmt/, the path of the
management application, in this example at http://10.0.1.5/mgmt/.
At the root of the GUI there will be the login screen or the overview
screen of the management application.
</p><p>If the redirection page does not get loaded, then there is a problem
with connecting to the web server. Check with ping to see if the
primary interface of the Steelhead appliance is still reachable and
with telnet to port 80 to see if the web server is running.
</p><div class="figure"><a name="idp39339752"></a><p class="title"><b>Figure 5.185. Steelhead GUI redirection screen</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-47-redirectscreen.png" align="middle" width="100%" alt="Steelhead GUI redirection screen"></td></tr></table></div></div></div><br class="figure-break"><p>With regards to the case where the redirection page does get
loaded, but the management application does not load: This behaviour
has been observed in the following situations:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>When the
<span class="italics">/var</span>
  partition is full. This can be checked with the
  command
<code class="computeroutput">support show disk</code>:
</p><div class="figure"><a name="idp39341480"></a><p class="title"><b>Figure 5.186. Output of the command "support show disk"</b></p><div class="figure-contents"><pre class="screen">Filesystem         1024-blocks      Used Available Capacity Mounted on
[...]
/dev/sda3             16513448  16513448         0     100% /var
[...]
</pre></div></div><p><br class="figure-break">
</p><p>  If this is the case, please call Riverbed TAC to help clean up
  the
<span class="italics">/var</span>
  partition.
</p></li><li class="listitem"><p>When the eUSB flash memory is locked for a long time and the
  machine isn't running the RiOS versions which deals with it. See
  KB article S15568 and S15587 for the full details.
</p></li><li class="listitem"><p>When the management application is failing: The next steps would
  be to connect to the CLI and issue the command
<code class="computeroutput">pm process webasd restart</code>.
</p></li><li class="listitem"><p>When there is something wrong with the optimized sessions towards that
  Steelhead appliance. Try using HTTPS instead of HTTP to overcome any
  optimization related issues.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39355560"></a>5.24.2. Unable to connect to the CLI</h3></div></div></div><p>There are several steps in the setup of the SSH session:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>(1) The command to start the SSH client.
</p></li><li class="listitem"><p>(2) The setup of the TCP session over which the SSH session gets setup.
</p></li><li class="listitem"><p>(3) The SSH server banner.
</p></li><li class="listitem"><p>(4) The host key exchange.
</p></li><li class="listitem"><p>(5) The DNS lookup of the client IP address by the server.
</p></li><li class="listitem"><p>(6) The login banner.
</p></li><li class="listitem"><p>(7) The password authentication.
</p></li><li class="listitem"><p>(8) The first output of the login shell.
</p></li></ul></div><div class="figure"><a name="idp39357608"></a><p class="title"><b>Figure 5.187. An SSH session with verbose logging</b></p><div class="figure-contents"><pre class="screen">1 edwin@t43&gt;ssh -v admin@10.0.1.5 
  OpenSSH_5.8p2_hpn13v11 FreeBSD-20110503, OpenSSL 0.9.8q 2 Dec 2010
  debug1: Reading configuration data /usr/home/edwin/.ssh/config
  debug1: Reading configuration data /etc/ssh/ssh_config
2 debug1: Connecting to 10.0.1.5 [10.0.1.5] port 22.
  debug1: Connection established.
  debug1: identity file /usr/home/edwin/.ssh/id_dsa type -1
  debug1: identity file /usr/home/edwin/.ssh/id_dsa-cert type -1
3 debug1: Remote protocol version 1.99, remote software version OpenSSH_5.2
  debug1: match: OpenSSH_5.2 pat OpenSSH*
  debug1: Remote is not HPN-aware
  debug1: Enabling compatibility mode for protocol 2.0
  debug1: Local version string SSH-2.0-OpenSSH_5.8p2_hpn13v11 FreeBSD-20110503
  debug1: SSH2_MSG_KEXINIT sent
  debug1: SSH2_MSG_KEXINIT received
  debug1: kex: server-&gt;client aes128-ctr hmac-md5 none
  debug1: kex: client-&gt;server aes128-ctr hmac-md5 none
  debug1: SSH2_MSG_KEX_DH_GEX_REQUEST(1024&lt;1024&lt;8192) sent
  debug1: expecting SSH2_MSG_KEX_DH_GEX_GROUP
  debug1: SSH2_MSG_KEX_DH_GEX_INIT sent
  debug1: expecting SSH2_MSG_KEX_DH_GEX_REPLY
4 debug1: Server host key: RSA ae:f3:6b:8c:6f:a0:e7:4d:01:1f:9c:cf:91:ad:14:e7
  The authenticity of host '10.0.1.5 (10.0.1.5)' can't be established.
  RSA key fingerprint is ae:f3:6b:8c:6f:a0:e7:4d:01:1f:9c:cf:91:ad:14:e7.
  Are you sure you want to continue connecting (yes/no)? yes
  Warning: Permanently added '10.0.1.5' (RSA) to the list of known hosts.
  debug1: ssh_rsa_verify: signature correct
  debug1: SSH2_MSG_NEWKEYS sent
  debug1: expecting SSH2_MSG_NEWKEYS
5 debug1: SSH2_MSG_NEWKEYS received
  debug1: Roaming not allowed by server
  debug1: SSH2_MSG_SERVICE_REQUEST sent
  debug1: SSH2_MSG_SERVICE_ACCEPT received
6 Riverbed Steelhead
  debug1: Authentications that can continue: publickey,password
  debug1: Next authentication method: publickey
  debug1: Trying private key: /usr/home/edwin/.ssh/id_rsa
  debug1: Trying private key: /usr/home/edwin/.ssh/id_dsa
  debug1: Trying private key: /usr/home/edwin/.ssh/id_ecdsa
  debug1: Next authentication method: password
7 admin@10.0.1.5's password: 
  debug1: Authentication succeeded (password).
  Authenticated to 10.0.1.5 ([10.0.1.5]:22).
  debug1: HPN to Non-HPN Connection
  debug1: Final hpn_buffer_size = 2097152
  debug1: HPN Disabled: 0, HPN Buffer Size: 2097152
  debug1: channel 0: new [client-session]
  debug1: Enabled Dynamic Window Scaling

  debug1: Requesting no-more-sessions@openssh.com
  debug1: Entering interactive session.
8 Last login: Sun Jul 29 01:55:15 2012 from 10.0.1.1
</pre></div></div><br class="figure-break"><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39358120"></a>5.24.2.1. SSH TCP session does not get setup</h4></div></div></div><p>If the TCP session times out, then it could be either a routing
issue, firewall issue or the Steelhead appliance is turned off.
</p><p>If the SSH client comes back with 
<span class="italics">ssh: connect to host 10.0.1.5 port 22: Connection refused</span>
then there is no SSH server running
on that IP address.
</p><p>The easiest way to check if the SSH server is running is to use
telnet to setup a TCP session to the primary interface on port 22:
</p><div class="figure"><a name="idp39359144"></a><p class="title"><b>Figure 5.188. Telnet session to the SSH service</b></p><div class="figure-contents"><pre class="screen">[~] edwin@t43&gt;telnet 10.0.1.5 22  
Trying 10.0.1.5...
Connected to 10.0.1.5.
Escape character is '^]'.
SSH-1.99-OpenSSH_5.2
</pre></div></div><br class="figure-break"><p>If the TCP session is setup and there is a SSH banner, then the SSH
service is working. If the SSH banner is not displayed, then the
kernel on the Steelhead appliance is still working but the user-land
is having problems.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39359720"></a>5.24.2.2. SSH host key has changed</h4></div></div></div><p>When a Steelhead appliance gets replaced in the network, the IP
address or hostname will stay the same but the SSH host key will
be different. OpenSSH will give a warning like this:
</p><div class="figure"><a name="idp39360040"></a><p class="title"><b>Figure 5.189. Setup of an SSH session to the CLI of a replaced Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">$ ssh admin@10.0.1.5
Riverbed Steelhead
Password:
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the RSA key sent by the remote host is
e:f3:6b:8c:6f:a0:e7:4d:01:1f:9c:cf:91:ad:14:e7.
Please contact your system administrator.
Add correct host key in /usr/home/edwin/.ssh/known_hosts to get rid of this message.
Offending RSA key in /usr/home/edwin/.ssh/known_hosts:50
RSA host key for 10.0.1.5 has changed and you have requested strict checking.
Host key verification failed.
</pre></div></div><br class="figure-break"><p>If this happens, confirm that the device was replaced.
</p><p>To overcome this issue with the OpenSSH SSH client, remove the line
in the file mentioned. With the PuTTY SSH client a dialog box will
be shown with the option to replace the key.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39360808"></a>5.24.2.3. SSH Reverse DNS timeout</h4></div></div></div><p>If the SSH client has a delay of about 60 seconds before displaying
the password prompt, then the issue is most likely related to reverse
DNS lookup failure: Confirm that the DNS servers configured on the
Steelhead appliance are correct and reachable.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39361128"></a>5.24.2.4. SSH login shell not started at all.</h4></div></div></div><p>If, after the authentication, the login shell is not started then
there is most likely a disk failure on the Steelhead appliance.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39361448"></a>5.24.2.5. Prompt only disappears after a very long delay</h4></div></div></div><p>It can happen that the SSH client asks for the username and password,
but doesn't get to the CLI. This has experienced when an appliance
has a high system load, for example because of the generation of a
lot of process dumps. The way out of that is to reboot the appliance
in single user mode and remove all process dumps from
<span class="italics">/var/opt/tms/snapshots/.staging/.</span>
</p><p>Next steps: Please contact the Riverbed TAC for assistance. Access to
the serial console is required, as well as permission to reboot the
Steelhead appliance.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39362024"></a>5.24.2.6. Reduced CLI shell</h4></div></div></div><p>During the login to the CLI, the login shell
<span class="italics">cli</span>
opens a communication channel to the process
<span class="italics">mgmtd</span>.
If this channel cannot be made, the prompt will show
<code class="computeroutput">CLI&gt;</code>
and only accept a certain subset of commands. Once the communication
channel to the mgmtd process is available the shell will connect
to it and all commands be available again.
</p><p>If the process
<span class="italics">mgmtd</span>
does not come back, the next step would be to boot the appliance
in single user mode and investigate why the process
<span class="italics">mgmtd</span>
didn't start.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39364200"></a>5.25. Partitions running out of space</h2></div></div></div><p>There are several partitions on the Steelhead appliance which are
writable and can run out of space:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="italics">/config</span>:
  This partition is part of the flash memory and is used
  for storing the configuration files.
</p></li><li class="listitem"><p>
<span class="italics">/proxy</span>:
  This partition is used for the RSP and PFS.
</p></li><li class="listitem"><p>
<span class="italics">/var</span>:
  This partition is used for logging, system dumps and process
  dumps.
</p></li></ul></div><p>When a partition is full, an alarm will be raised and the status
of the device will become
<span class="italics">Degraded</span>:
</p><div class="figure"><a name="idp39366376"></a><p class="title"><b>Figure 5.190. File system alarm</b></p><div class="figure-contents"><pre class="screen">[statsd.NOTICE]: Alarm triggered for rising error for event fs_mnt
</pre></div></div><br class="figure-break"><p>The command
<code class="computeroutput">support show disk</code>
shows the status of the partitions:
</p><div class="figure"><a name="idp39367208"></a><p class="title"><b>Figure 5.191. Output of the command "support show disk"</b></p><div class="figure-contents"><pre class="screen">SH # support show disk
Filesystem         1024-blocks      Used Available Capacity Mounted on
/dev/sdb7               418806     49904    347277      13% /config
/dev/sda3             16513448   2769100  12905408      18% /var
/dev/disk0p6          56765020  39510668  14370736      74% /proxy
</pre></div></div><br class="figure-break"><p>The capacity shows the amount of usage which is used: 0% is empty,
100% is full.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39388328"></a>5.25.1. The /config partition is full</h3></div></div></div><p>The
<span class="italics">/config</span>
partition is not manageable from the GUI or CLI and Riverbed TAC
should be contacted to determine the cause and resolve the issue.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39388904"></a>5.25.2. The /proxy partition is full</h3></div></div></div><p>The
<span class="italics">/proxy</span>
partition is used by both PFS and RSP.
</p><p>If PFS is used and the partition is full, then the amount of data
stored on the file server backed by the PFS share has exceeded the
threshold.
</p><p>If RSP is used there are several scenarios:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Check if there are any RSP images, the RSP software or RSP backups
  which can be removed.
</p><div class="figure"><a name="idp39389992"></a><p class="title"><b>Figure 5.192. Removing an obsolete RSP image</b></p><div class="figure-contents"><pre class="screen">SH # show rsp images
image_rbt_rsp_6_0_0_n19.img
image_rbt_rsp_6_5_0_n77.img
SH # rsp image delete image_rbt_rsp_6_0_0_n19.img
SH #
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>Check if there are any RSP packages, the virtual machines, which
  can be removed.
</p><div class="figure"><a name="idp39390632"></a><p class="title"><b>Figure 5.193. Removing an obsolete RSP package</b></p><div class="figure-contents"><pre class="screen">SH # show rsp packages
FCI_WIN2K3_STD_X32_v3.0.pkg
FCI_WIN2K3_STD_X32_v3.1.pkg
SH # rsp package delete FCI_WIN2K3_STD_X32_v3.0.pkg
SH #
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>Check if there are any RSP backups which can be removed.
</p><div class="figure"><a name="idp39391400"></a><p class="title"><b>Figure 5.194. Removing an obsolete RSP backup</b></p><div class="figure-contents"><pre class="screen">SH # show rsp backups
backup-slot3-20120801.tgz
backup-slot3-20120802.tgz
SH # rsp backups delete backup-slot3-20120801.tgz
SH #
</pre></div></div><p><br class="figure-break">
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39404264"></a>5.25.3. The /var partition is full</h3></div></div></div><p>The
<span class="italics">/var</span>
partition is used for the logging of services running on the Steelhead
appliance, to capture historical statistics of various parts of the
Steelhead appliance, to store process dumps, system dumps and tcpdump
captures and to keep track of process files.
</p><p>Check the following things:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Are there any tcpdump captures running? The background tcpdump
  capture files are not showing up in the GUI under Reports -&gt;
  Diagnostics -&gt; TCP Dumps but they still use the disk space:
</p><div class="figure"><a name="idp39405224"></a><p class="title"><b>Figure 5.195. Check for running background tcpdump captures</b></p><div class="figure-contents"><pre class="screen">SH # show tcpdump-x
Name: ssh-cifs
Start Time: 10:48:17

SH # tcpdump-x capture-name ssh-cifs stop
SH #
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>Are there any tcpdump capture files which can be removed?
</p><div class="figure"><a name="idp39405928"></a><p class="title"><b>Figure 5.196. Remove obsolete tcpdump capture files</b></p><div class="figure-contents"><pre class="screen">SH # show files tcpdump
SH_primary_csh-cifs.cap
SH_lan0_0_csh-cifs.cap
SH_wan0_0_csh-cifs.cap
SH # file tcpdump delete SH_primary_csh-cifs.cap
SH #
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>Are there any old process dumps which can be removed?
</p><div class="figure"><a name="idp39406696"></a><p class="title"><b>Figure 5.197. Remove obsolete process dumps</b></p><div class="figure-contents"><pre class="screen">SH # show files process-dump
sysdump-SH-20120801-200301.tgz
sysdump-SH-20120801-200523.tgz
SH # file process-dump delete sysdump-SH-20120801-200301.tgz
SH #
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>Are there any old system dumps which can be removed?
</p><div class="figure"><a name="idp39407464"></a><p class="title"><b>Figure 5.198. Remove obsolete system dumps</b></p><div class="figure-contents"><pre class="screen">SH # show files debug-dump
SH-sport-20120801-200257.tar.gz
SH-sport-20120801-200519.tar.gz
SH # file debug-dump delete SH-sport-20120801-200257.tar.gz
SH #
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>Neural framing statistics logs can be gathered but are never
  rotated. In the
<span class="italics">sysinfo.txt</span>
   they can be found under the
<code class="computeroutput">Output of 'find /var/opt ( -name .running -prune ) -o -type f -ls -mount'</code>:
  section as
<span class="italics">/var/opt/rbt/neural-stats</span>.
  Contact the Riverbed TAC to remove them.
</p><div class="figure"><a name="idp39400872"></a><p class="title"><b>Figure 5.199. Neural Framing log files</b></p><div class="figure-contents"><pre class="screen">Output of 'find /var/opt ( -name .running -prune ) -o -type f -ls -mount':
[...]
634172  564 ---S-wS--T  1 admin  root  72586 Nov  2  2007 /var/opt/rbt/neural-stats.22416. \
    0
634215   80 ---S-wS--T  1 admin  root  77441 Nov  2  2007 /var/opt/rbt/neural-stats.22416. \
    1
634216  116 ---S-wS--T  1 admin  root  11986 Nov  2  2007 /var/opt/rbt/neural-stats.22416. \
    2
634217 2312 ---S-wS--T  1 admin  root  60701 Nov  2  2007 /var/opt/rbt/neural-stats.22416. \
    3
[...]
640388   88 -rw-rws---  1 admin  root  84021 Jul 31  2008 /var/opt/rbt/neural-stats.6631.1 \
    159
640389  144 -rw-rws---  1 admin  root  40656 Jul 31  2008 /var/opt/rbt/neural-stats.6631.1 \
    160
640390   96 -rw-rws---  1 admin  root  92481 Jul 31  2008 /var/opt/rbt/neural-stats.6631.1 \
    161
</pre></div></div><br class="figure-break"></li></ul></div><p>If the issue isn't resolved after this, please contact Riverbed TAC
for further investigation.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39401448"></a>5.26. Memory usage on the Steelhead appliance</h2></div></div></div><p>There are two kinds of memory on the Steelhead appliance: Real and
virtual. Real memory comes from the DIMM memory sticks inside the
appliance and is fast, virtual memory comes from an allocated slice
on the hard disks and is slow. The process of moving memory from
the real memory to the virtual and vice versa is called paging.
</p><p>If paging is happening, it means that the processes needing its
memory will have to wait before it is served and that other processes
will start to page too. Thus: Active paging is a bad thing and a
source of slowness.
</p><p>Under normal circumstances, there should be no virtual memory in
active use. The following exceptions will be there:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>On the 3RU xx50 series models like the 5050 and 6050 models, a
  part of the virtual memory allocated for the copy of the USB flash
  memory. However, it will not be actively used: No paging in and
  paging out should be happening except during times when there are write
  operations to the USB flash disk.
</p></li><li class="listitem"><p>On the 50, 100, 200 and 300 models the memory is very tight, under
  normal operations there is only 2-3 Mb of memory free. When logging
  in to the Steelhead appliance it will start to swap to rearrange
  the memory and this will cause paging.
</p></li></ul></div><p>The memory on the Steelhead appliance is used in several ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Used by the optimization service.
</p></li><li class="listitem"><p>Used by the operating system.
</p></li><li class="listitem"><p>Used by the non-optimization processes.
</p></li><li class="listitem"><p>Used by the RSP service.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39403496"></a>5.26.1. The optimization service</h3></div></div></div><p>The optimization service takes up most of the memory on a Steelhead
appliance. For example on a 1050L model with 2 Gb of memory, the
optimization service aka the process
<span class="italics">sport</span>
will use 1.3 Gb of it.
</p><p>When monitoring the memory usage on the Steelhead appliance via
SNMP, you will see that the the memory usage on the Steelhead
appliance is very high, often above 80%: This is normal.
</p><p>During the startup of the optimization service, it will allocate a
pool of memory which it will use to allocate internal memory
structures used by the optimized TCP sessions. For example these
structures are for the general TCP optimization, the CIFS read-ahead
buffers and the objects for the HTTP optimization. The memory
allocated by the optimization service is marked as "non-paging",
which means that it will never be paged out to disk.
</p><p>If coded properly, every object allocated will be released later.
If not, a piece of memory will be lost. If this happens too often,
this pool of memory will be exhausted and the optimization service
will be entering memory based admission control. When this happens,
please open a case with Riverbed TAC to investigate.
</p><p>The only way out is to restart the optimization service, but don't
do this until Riverbed TAC has the data required.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39396392"></a>5.26.2. The operating system</h3></div></div></div><p>The memory usage by the operating system is not directly identifiable
but there are two usages which can be observed: The network buffers
and the disk buffers.
</p><p>If the operating system runs out of network buffers, the optimization
service will enter TCP based admission control. This scenario is
described in the
<span class="italics">Admission Control</span>
section.
</p><p>If the operating system runs out of disk buffers, it will become
slow at reading from and writing to disk. This can happen when a
large amount of brand new, compressed or encrypted data comes
through: The data store has to be searched for matching references,
but they cannot be found. Furthermore the data store will be written
to the whole time. This constant reading and writing will exhaust
the disk buffers and cause slowness on the system.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39397224"></a>5.26.3. The non-optimization processes</h3></div></div></div><p>The non-optimization processes use the rest of the memory. Unless
there is a memory related issue and paging is happening, they should
all run inside the real memory. If however for some reason the
Steelhead appliance is running out of memory and paging start
happening, these are the processes which will be paged to disk.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39397544"></a>5.26.4. The RSP service</h3></div></div></div><p>As described in a previous section
<span class="italics">The Riverbed Services Platform</span>,
the RSP memory is used by the RSP software and the RSP slots.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39398248"></a>5.27. LAN side traffic is seen on the Steelhead appliance</h2></div></div></div><p>If the list of Current Connections shows TCP sessions, either
optimized or pass-through, and they are coming from and going to
the same IP subnet which is defined on the LAN side, then there is
something wrong with either the switches or with the subnet mask
definitions on the hosts.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39398632"></a>5.27.1. IP subnet and Subnet masks mismatch</h3></div></div></div><p>If the TCP session shows up for only one host on the network,
checking the IP subnet and subnet mask on that host would be the
first step to make sure that it matches the configured IP subnet
and subnet mask as on the router.
</p><div class="figure"><a name="idp39398952"></a><p class="title"><b>Figure 5.200. Running ipconfig on a Windows machine to check the subnet mask</b></p><div class="figure-contents"><pre class="screen">C:\&gt;ipconfig

Ethernet adapter Local Area Connection:
    Connection-specific DNS Suffix . :
    IP Address . . . . . . . . . . . : 10.0.1.1
    Subnet . . . . . . . . . . . . . : 255.255.255.0
    Default Gateway. . . . . . . . . : 10.0.1.9

C:\&gt;
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39399464"></a><p class="title"><b>Figure 5.201. Running ifconfig on a Unix machine to check the subnet mask</b></p><div class="figure-contents"><pre class="screen">[~] edwin@t43&gt;ifconfig bge0
bge0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=8009b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,LINKSTATE&gt;
	inet 10.0.1.1 mask 255.255.255.0
        ether d4:9a:20:c2:52:0e
        inet6 fe80::216:41ff:fe53:6b26%bge0 prefixlen 64 scopeid 0x1 
        nd6 options=23&lt;PERFORMNUD,ACCEPT_RTADV,AUTO_LINKLOCAL&gt;
        media: Ethernet autoselect (1000baseTX &lt;full-duplex&gt;)
        status: active
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39399976"></a>5.27.2. Switch related issues</h3></div></div></div><p>Normally a switch knows which MAC addresses are behind a physical
port and it will forward the Ethernet frames to there: You will not
see these packets on the Steelhead appliance.
</p><p>If however the switch does not know where a MAC address is, it will
forward it to out via all physical ports. The reason it doesn't
know where a MAC address is can be for a couple of reasons:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The host which has sent out that Ethernet frame has the MAC address
  for that IP address hard coded in its MAC table.
</p></li><li class="listitem"><p>The MAC table on the switch is full and it cannot learn any new
  MAC address to port mappings.
</p></li></ul></div><p>The way to troubleshoot this would be to take a short capture of a
TCP session on the Steelhead with the link layer details:
</p><div class="figure"><a name="idp39409256"></a><p class="title"><b>Figure 5.202. Tcpdump capture for a LAN side TCP conversation</b></p><div class="figure-contents"><pre class="screen">SH # tcpdump -ni lan0_0 -le -c 10 host 10.0.1.1 and host 10.0.1.5
08:12:56.776625 d4:9a:20:c2:52:0e &gt; 00:0e:b6:42:f8:98, ethertype IPv4 (0x0800), length 82: \
     10.0.1.1.59623 &gt; 10.0.1.5.80: Flags [.], ack 13, win 65535, options [nop,nop,TS val 1 \
    821865 ecr 1813898], length 0
08:12:56.777495 d4:9a:20:c2:52:0e &gt; 00:0e:b6:42:f8:98, ethertype IPv4 (0x0800), length 82: \
     10.0.1.1.59623 &gt; 10.0.1.5.80: Flags [.], ack 1445, win 65535, options [nop,nop,TS val \
     1821865 ecr 1813898], length 0
08:12:56.778494 d4:9a:20:c2:52:0e &gt; 00:0e:b6:42:f8:98, ethertype IPv4 (0x0800), length 82: \
     10.0.1.1.59623 &gt; 10.0.1.5.80: Flags [.], ack 2877, win 65535, options [nop,nop,TS val \
     1821865 ecr 1813898], length 0
08:12:56.778561 d4:9a:20:c2:52:0e &gt; 00:0e:b6:42:f8:98, ethertype IPv4 (0x0800), length 82: \
     10.0.1.1.59623 &gt; 10.0.1.5.80: Flags [.], ack 4309, win 65535, options [nop,nop,TS val \
     1821866 ecr 1813898], length 0
</pre></div></div><br class="figure-break"><p>As can be seen, the MAC addresses are the ones expected. Also note
that this traffic is only coming from one host, the one with IP address
10.0.1.5.
</p><p>The next step would be check the switch if it knows where to send
these MAC addresses to. On a Cisco switch this command is
<code class="computeroutput">show mac address-table</code>.
</p><div class="figure"><a name="idp39410216"></a><p class="title"><b>Figure 5.203. Check the MAC address table</b></p><div class="figure-contents"><pre class="screen">SWITCH # show mac address-table
          Mac Address Table
-------------------------------------------
Vlan    Mac Address       Type        Ports
----    -----------       --------    -----
[...]
d49a.20c2.520e
   1    d49a.20c2.520e    DYNAMIC     Fa0/3
[...]
SWITCH # show mac address-table | i d49a.20c2.520e
   1    d49a.20c2.520e    DYNAMIC     Fa0/3
SWITCH # show mac address-table | i 000e.b642.f898
SWITCH #
</pre></div></div><br class="figure-break"><p>So it knows where to find the MAC address of d4:9a:20:c2:52:0e, but
not where the MAC address of 00:0e:b6:42:f8:98 is located. And
therefore the packet to 00:0e:b6:42:f8:98 gets forwarded to all
ports.
</p><p>The next step would be to find out why the switch doesn't know about
the destination MAC address.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39411048"></a>5.28. Service Error</h2></div></div></div><p>Sometimes the optimization service determines that there is something
wrong, either in the data store or in the communication towards a
peer. It will then raise the service_error alarm, which is a non-fatal
error for the optimization service but a fatal error for the TCP
session it has been encountered on.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39411368"></a>5.28.1. Data store related service errors</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39411560"></a>5.28.1.1. Steelhead Mobile Client Cloning</h4></div></div></div><p>When a new computer gets rolled out and the installation of the
software on it happens via cloning it from a master image, the data
store id of the Steelhead Mobile Client software will be cloned
too. As a result, the server-side Steelhead appliance will see
duplicate labels and thus raise the service_error alarm:
</p><div class="figure"><a name="idp39411880"></a><p class="title"><b>Figure 5.204. Duplicate DEF and a Service error with a Steelhead Mobile Client</b></p><div class="figure-contents"><pre class="screen">SH sport[1448]: [segpage.ERR] - {- -} Duplicate DEF {}136 hash 11237544087762729201 vs. 44 \
    0090/248488450:20#0{}176 hash 4723104384001475725, memcmp() 1
SH sport[1448]: [defunpacker.ALERT] - {- -} ALARM (clnt: 10.0.1.1:49358 serv: 192.168.1.1: \
    1352 cfe: 10.0.1.1:49349 sfe: 192.168.1.6:7800) name maps to more than one segment has \
     a steelhead been improperly installed and/or steelhead mobiles are sharing config fil \
    es p
SH sport[1448]: [defunpacker.ALERT] - {- -} ossibly through copying or cloning?
SH sport[1448]: [defunpacker.WARN] - {- -} (clnt: 10.0.1.1:49358 serv: 192.168.1.1:1352 cf \
    e: 10.0.1.1:49349 sfe: 192.168.1.6:7800) Killing page 0x2b8835a000 name: 440090/248488 \
    450:20 off 59732398 refs 2 cnt 50 flags CA--- tag 1954835526/12, segment #
SH sport[1448]: [defunpacker.WARN] - {- -} 544087762729201
SH sport[1448]: [segstore/kill_page.ERR] - {- -} Killing page name: 440090/248488450:20 of \
    f 59732398 refs 2 cnt 50 flags CA--- tag 1954835526/12 and dumping it to refd_pages.14 \
    48
SH statsd[28893]: [statsd.NOTICE]: Alarm triggered for rising error for event service_erro \
    r
</pre></div></div><br class="figure-break"><p>The IP addresses of the
<span class="italics">clnt</span>
(client) and the
<span class="italics">cfe</span>
(client-side Steelhead) are the same, therefore it is a Steelhead
Mobile Client causing this problem.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39413032"></a>5.28.1.2. Data store clustering</h4></div></div></div><div class="figure"><a name="idp39413224"></a><p class="title"><b>Figure 5.205. Duplicate DEF and a Service error but not with a Steelhead Mobile Client</b></p><div class="figure-contents"><pre class="screen">SH sport[26651]: [defunpacker.ALERT] - {- -} ALARM (clnt: 10.0.1.1:51748 serv: 192.168.1.1 \
    :80 cfe: 10.0.1.6:7801 sfe: 192.168.1.6:7800) name maps to more than one segment has a \
     steelhead been improperly installed and/or  steelhead mobiles are sharing conf 
SH sport[26651]: [defunpacker.ALERT] - {- -} ig files possibly through copying or cloning? \
     
</pre></div></div><br class="figure-break"><p>Here the IP addresses of the
<span class="italics">clnt</span>
(client) and the
<span class="italics">cfe</span>
(client-side Steelhead) are not the same, therefore the remote IP
address belong to a real Steelhead appliance and not a Steelhead
Mobile Client.
</p><p>The most likely cause is that there has been an issue with hosts
in a data store synchronization cluster and the data store wasn't
cleared after the cluster got taken apart. Clearing the data store and
a service restart with the command
<code class="computeroutput">restart clean</code>
should resolve this issue.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39414696"></a>5.28.1.3. Requested frame does not exist anymore</h4></div></div></div><p>When the sending Steelhead appliance sends a reference and the
receiving Steelhead appliance does not have that reference in its
data store, the receiving Steelhead appliance will request that
reference from the sending Steelhead appliance. If the sending
Steelhead appliance does not have that reference it its data store
anymore, it will throw this error:
</p><div class="figure"><a name="idp39415016"></a><p class="title"><b>Figure 5.206. Requested reference does not exist anymore</b></p><div class="figure-contents"><pre class="screen">SH sport[32414]: [replypacker.ALERT] - {- -} ALARM ACK problem: REQd segment 380198/193427 \
    159:2600447491#16 absent 
</pre></div></div><br class="figure-break"><p>This can happen when the optimized TCP connection is running in
the SDR-M optimization policy or the optimized TCP connection is a
CIFS connection and the reference was only available in the CIFS
cache part of the data store.
</p><p>If this happens once, then just clear the alarm. If this happens
more and more, then open a TAC case.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39415720"></a>5.28.2. Communication related service errors</h3></div></div></div><p>If there is a problem in the protocol spoken on the inner channel
between the Steelhead appliances, a service error will be raised.
</p><p>Since the protocol is spoken over TCP, the network stack will take
care of TCP checksum issues and the data should be valid. When using
the WAN visibility modes of port transparency or full transparency,
there might be firewalls or IPS devices which check the protocol
and "fix" irregularities in it, which can cause corruption on the
inner channel.
</p><div class="figure"><a name="idp39416168"></a><p class="title"><b>Figure 5.207. A service error due to a checksum mismatch</b></p><div class="figure-contents"><pre class="screen">SH sport[3612]: [sportpkt.ALERT] - {- -} ALARM decode_hdr: checksum mismatch, cmd 1, len 3 \
    2789
SH statsd[9205]: [statsd.NOTICE]: Alarm triggered for rising error for event service_error
</pre></div></div><br class="figure-break"><p>To troubleshoot checksum mismatches would be to take traces in
various places in the network between the two Steelhead appliances
until the issue happens again and see if the corruption is already
there.  Then use the divide-and-conquer approach to find the device
which is corrupting the content.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39470184"></a>5.29. Can this application be optimized?</h2></div></div></div><p>This question comes often to the Riverbed TAC and the answer is
mostly "Most likely".
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39470504"></a>5.29.1. On individual TCP sessions</h3></div></div></div><p>The Steelhead appliance optimizes in three ways: TCP optimization,
Data Reduction and Latency Optimization.
</p><p>The first one, TCP optimization, changes the characteristics of the
TCP session, for example the TCP Window which allows more data
outstanding over the WAN. If the client doesn't support these
features in its TCP stack, the TCP optimization of the Steelhead
appliance will improve the throughput.
</p><p>The third one, latency optimization, only works if the application
uses certain protocols like CIFS, NFS and HTTP. If the application
is using these protocols to access remote data, then latency
optimization on the Steelhead appliance will improve the throughput.
</p><p>The second one, data reduction, works most likely unless the data
stream is compressed or encrypted. If the data is compressed, then
the configuration of the application should be checked to see if
the compression can be disabled. If the data is encrypted via SSL,
then the traffic can be optimized if the server SSL certificate and
the server SSL private key are available. If these two items are
not available, then the traffic cannot be optimized. If the data
is not encrypted via SSL, then the traffic cannot be optimized.
</p><p>If that application is already being optimized, the ratio of the
traffic on the LAN and WAN side can be checked:
</p><div class="figure"><a name="idp39471336"></a><p class="title"><b>Figure 5.208. An encrypted or compressed TCP session </b></p><div class="figure-contents"><pre class="screen">CSH # show connections opt filter 10.16.5.39 full
T  Source                Destination           App    Rdn Since
--------------------------------------------------------------------------------
O  10.0.1.1         2067 192.168.1.1      1039 TCP     0% 2013/03/20 11:45:47
                   Peer: 192.168.1.6      7800 Inner: 37024
            Outer Local: 10.0.1.6         7801   WAN: 2299KB
           Outer Remote: 10.0.1.1         2067   LAN: 2003KB
    WAN Visibility Mode: Correct Addressing
                  Flags: cfe,sdr,lz,te=0,pe=0
</pre></div></div><br class="figure-break"><p>In this case the protocol is TCP (so no skewing because of a
read-ahead feature in latency optimization) and the amount of bytes
on the WAN side is larger than the amount of bytes on the LAN side,
making the Reduction 0%. We found out that the application used
compression on the wire. After the application configuration was
changed the amount of bytes on the LAN side increased but due to
the data reduction of the Steelhead appliance the amount of bytes
on the WAN side decreased.
</p><div class="figure"><a name="idp39471912"></a><p class="title"><b>Figure 5.209. An formerly compressed TCP session </b></p><div class="figure-contents"><pre class="screen">CSH # show connections opt filter 10.16.5.39 full
T  Source                Destination           App    Rdn Since
--------------------------------------------------------------------------------
O  10.0.1.1         2103 192.168.1.1      1039 TCP     9% 2013/03/20 11:57:12
                   Peer: 192.168.1.6      7800 Inner: 37041
            Outer Local: 10.0.1.6         7801   WAN: 599KB
           Outer Remote: 10.0.1.1         2103   LAN: 6412KB
    WAN Visibility Mode: Correct Addressing
                  Flags: cfe,sdr,lz,te=0,pe=0
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39472360"></a>5.29.2. Overview per protocol</h3></div></div></div><p>In the Traffic Summary under Reports -&gt; Networking -&gt; Traffic
Summary, it will be possible to determine the overal performance
of a certain protocol:
</p><div class="figure"><a name="idp39472680"></a><p class="title"><b>Figure 5.210. The traffic summary report</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-willitoptimize-trafficsummary.png" align="middle" width="100%" alt="The traffic summary report"></td></tr></table></div></div></div><br class="figure-break"><p>Here can be seen that traffic on TCP port 3268, 49156 and 5989 is
not being reduced in size at all. The total percentage of traffic
for these three ports is 9.53%, which is quite big. If the application
settings cannot be modified to allow a better data reduction, disabling
optimization for these ports via an in-path rule would prevent the data
store to be filled with useless references and free up TCP connections.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39473832"></a>5.30. Interceptor cluster related issues</h2></div></div></div><p>The Interceptor appliance is a Riverbed specific appliance to
redirects traffic to a cluster of Steelhead appliances. It does not
take part in the optimization of the traffic itself, it only
redirects.
</p><p>An Interceptor cluster consists of two types on nodes: one or more
Interceptors and one or more Steelhead appliances.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39474280"></a>5.30.1. Network setup</h3></div></div></div><p>While the Interceptor appliance is located inline in the traffic
flow, the Steelhead appliances in the cluster are only connected
with the WAN interface.
</p><div class="figure"><a name="idp39474600"></a><p class="title"><b>Figure 5.211. Network setup for the Interceptor cluster</b></p><div class="figure-contents"><pre class="screen"> .----------.
 |  Router  |
 '----------'
       |
  .--------.
  |   IC   |
  '--------'
       |       .--------.
       |   .---|  SH 1  |
       |   |   '--------'
       |   |   .--------.
       |   |---|  SH 2  |
       |   |   '--------'
       |   |
   .----------.
   |  Switch  |
   '----------'
</pre></div></div><br class="figure-break"><p>There are several traffic flows:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Unoptimized traffic, which flows through the Interceptor appliance.
  This includes inner channels of optimized TCP sessions with the
  Correct Addressing or Port Transparency WAN Visibility methods
  which are not terminating on this Interceptor cluster.
</p></li><li class="listitem"><p>New traffic that could be optimized:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>A SYN+ packet comes in via the WAN interface and gets GRE
    encapsulated forwarded to one of the Steelhead appliances in
    the cluster.
</p></li><li class="listitem"><p>A naked SYN comes in via the LAN interface and gets GRE
    encapsulated forwarded to one of the Steelhead appliances in
    the cluster.
</p></li><li class="listitem"><p>A naked SYN/ACK comes in via the LAN interface and gets GRE
    encapsulated forwarded to the correct Steelhead appliance.
</p></li><li class="listitem"><p>A SYN/ACK+ comes in via the WAN interface and gets GRE encapsulated
    forwarded to the correct Steelhead appliance.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Traffic from the server to the client, which gets received on the
  LAN side. The destination IP address in the IP header will be
  swapped for the IP address of the Steelhead appliance in-path
  interface and send to the correct Steelhead appliance.
</p></li><li class="listitem"><p>The inner channel of an optimized TCP session from the client-side
  Steelhead appliance to the server-side Steelhead appliance with
  the Full Transparency WAN visibility mode. This gets modified from
  Full Transparency mode to Correct Addressing mode and then send
  to the correct Steelhead appliance.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39476904"></a>5.30.2. The cluster</h3></div></div></div><p>The communication between the individual nodes is happening via the
Connection Forwarding protocol via their in-path interfaces. At
startup of the redirection service, the Interceptor appliance will
contact all other nodes, Interceptor and Steelhead appliances, and
exchange capability information which includes the IP addresses of
the in-path interfaces and, for the Steelhead appliances, the
capacity and health status.
</p><div class="figure"><a name="idp39477224"></a><p class="title"><b>Figure 5.212. Setup of connection forwarding session between Interceptor and Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">IC interecptor[25354]: [neigh/client/channel.INFO] - {- -} Establishing neighbor channel f \
    rom 192.168.1.12 to 192.168.1.6:7850
IC interecptor[25354]: [neigh/client/channel.INFO] - {- -} Neighbor channel to 192.168.1.6 \
    :7850 established.
</pre></div></div><br class="figure-break"><p>If the neighbouring Steelhead appliance isn't reachable, it will
time out:
</p><div class="figure"><a name="idp39477800"></a><p class="title"><b>Figure 5.213. Failure in the setup of connection forwarding session between Interceptor and Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">IC interceptor[4937]: [neigh/client/channel.INFO] - {- -} Establishing neighbor channel fr \
    om 192.168.1.12 192.168.1.6:7850
IC interceptor[4937]: [neigh/client/channel.WARN] - {- -} Connection failure: couldn't con \
    nect to neighbor 192.168.1.6:7850. Connection timed out
</pre></div></div><br class="figure-break"><p>If the neighbouring Steelhead appliance optimization service isn't
running, it will show a connection refused.
</p><div class="figure"><a name="idp39486632"></a><p class="title"><b>Figure 5.214. Failure in the setup of connection forwarding session between Interceptor and Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">IC interceptor[4937]: [neigh/client/channel.INFO] - {- -} Establishing neighbor channel fr \
    om 192.168.1.12 192.168.1.6:7850
IC interceptor[4937]: [neigh/client/channel.WARN] - {- -} Connection failure: couldn't con \
    nect to neighbor 192.168.1.6:7850. Connection refused
</pre></div></div><br class="figure-break"><p>If the neighbour Steelhead appliance becomes unreachable, the session
will timeout after three seconds.
</p><div class="figure"><a name="idp39487208"></a><p class="title"><b>Figure 5.215. Failure in the connection forwarding session between Interceptor and Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">IC interecptor[25354]: [neigh/client/channel.INFO] - {- -} Establishing neighbor channel f \
    rom 192.168.1.12 to 192.168.1.6:7850
IC interecptor[25354]: [neigh/client/channel.INFO] - {- -} Neighbor channel to 192.168.1.6 \
    :7850 established.
IC interecptor[25354]: [neigh/client/channel.WARN] - {- -} No response from neighbor 192.1 \
    68.1.6:7850. Count = 1
IC interecptor[25354]: [neigh/client/channel.WARN] - {- -} No response from neighbor 192.1 \
    68.1.6:7850. Count = 2
IC interecptor[25354]: [neigh/client/channel.WARN] - {- -} No response from neighbor 192.1 \
    68.1.6:7850. Count = 3
IC interecptor[25354]: [neigh/client/channel.WARN] - {- -} No response from neighbor 192.1 \
    68.1.6:7850. Neighbor is unreachable.
</pre></div></div><br class="figure-break"><p>If the optimization service on the neighbour Steelhead appliance
stops, the session will be terminated too:
</p><div class="figure"><a name="idp39487784"></a><p class="title"><b>Figure 5.216. Failure in the connection forwarding session between Interceptor and Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">IC interecptor[25354]: [neigh/client/channel.INFO] - {- -} Establishing neighbor channel f \
    rom 192.168.1.12 to 192.168.1.6:7850
IC interecptor[25354]: [neigh/client/channel.INFO] - {- -} Neighbor channel to 192.168.1.6 \
    :7850 established.
IC interceptor[25354]: [neigh/server/channel.NOTICE] - {- -} End of stream reading neighbo \
    r from 192.168.1.6:7850. Peer maybe down.
</pre></div></div><br class="figure-break"><p>When a new optimizable TCP session gets seen, the Interceptor
appliance will select one of the Steelhead appliances to which it
will be redirected which uses the Connection Forwarding mechanism
to inform all the other Interceptor and Steelhead appliances about
it. If a new optimized TCP session gets setup to a Steelhead
appliance directly, for example via a Fixed Target rule, it also
will inform all the nodes in the Interceptor cluster about it.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39488360"></a>5.30.2.1. Peering affinity</h4></div></div></div><p>When a new optimizable TCP session gets seen by an Interceptor
appliance, it needs to be forwarded to one of the Steelhead appliances
in the cluster. The best data reduction can be obtained between two
Steelhead appliances which have exchanged the most references. So
the Interceptor cluster always tries to send the TCP session from
a certain remote Steelhead appliance to the same Steelhead appliance
in the cluster, to obtain the best data reduction.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39488680"></a>5.30.2.2. Fair peering</h4></div></div></div><p>With peering affinity, it would be possible for traffic going through
an Interceptor cluster with multiple Steelhead appliances to end
up on the same Steelhead appliance. With the Fair Peering feature
the Interceptor cluster puts effort in the attempts to distribute
the traffic from remote Steelhead appliances equally over the number
of Steelhead appliances in the cluster.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39489000"></a>5.30.2.3. Pressure Monitoring and Capacity Adjustments</h4></div></div></div><p>With the Pressure Monitoring feature enabled, the Interceptor
appliances keep track of the memory usage and the disk pressure on
the Steelhead appliances. With the Capacity Adjustment feature, the
Interceptor appliances will dynamically reduce the initially exchanged
capacity of the Steelhead appliances if there is pressure on them.
This will decrease the number of TCP sessions being redirected to
that Steelhead appliance, giving it a chance to reduce the pressure.
Once every hour the Interceptor appliance will decide if the pressure
on the Steelhead appliances has been reduced far enough to increase
the capacity again.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39489320"></a>5.30.2.4. After an RMA</h4></div></div></div><p>When a Steelhead appliance in an Interceptor cluster is replaced,
its data store will be new to the network. Therefore, the peering
affinity algorithm will not forward any TCP sessions to that new
Steelhead appliance. Only when the Interceptor appliances consider
the other Steelhead appliances in the cluster to be in admission
control, either for real or via capacity adjustments, then new TCP
sessions will be forwarded to the new Steelhead appliance.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39489768"></a>5.31. Expiring SSL certificates</h2></div></div></div><p>The SSL certificates used on the Steelhead appliances, for the GUI,
the SSL pre-optimization and for the SSL Secure Peering, have an
expiry date on them. Once the SSL certificate has expired it cannot
be used anymore.
</p><p>Only when SSL Optimization is enabled, the expiry of the SSL
certificates is noticed in the health status of the device. The
list of expiring SSL certificates can be found with the command
<code class="computeroutput">show protocol ssl expiring-certs</code>.
</p><div class="figure"><a name="idp39482344"></a><p class="title"><b>Figure 5.217. SSL certificates have expired</b></p><div class="figure-contents"><pre class="screen">SH # show protocol ssl
Enabled: yes
Protocol Versions: SSLv3_or_TLSv1
SFE Mode: Advanced_Only
Mid Session SSL: no
No server certificates.
[...]

SH # show alarms triggered 
Alarm ID:          certs_expiring
Alarm Description: SSL Certificates Expiring
Status:            error
-------------------------------------
Alarm ID:          health
Alarm Description: Appliance Health
Status:            error
-------------------------------------
Alarm ID:          ssl
Alarm Description: SSL
Status:            error
-------------------------------------

SH # show protocol ssl expiring-certs
Peering certificate is OK.

All server certificates are OK.

All server chain certificates are OK.

Expiring/Expired CA certificate(s):
  Akamai_Subordinate_3 (on May 11 23:59:00 2013 GMT)
  Autoridad_de_Certificacion_Firmaprofesional_CIF_A62634068 (on Oct 24 22:00:00 
2013 GMT)
  Digisign_Server_ID_Enrich (on Jul 17 15:16:55 2012 GMT)
  GlobalSign_Organization (on Jan 27 11:00:00 2014 GMT)
  Google_Internet (on Jun  7 19:43:27 2013 GMT)
  Microsoft_Code_Signing_PCA (on Aug 25 07:00:00 2012 GMT)

All peering CA certificates are OK.

All peering white list certificates are OK.

All mobile trusts certificates are OK.
</pre></div></div><br class="figure-break"><p>In the log files this will be shown as:
</p><div class="figure"><a name="idp39482984"></a><p class="title"><b>Figure 5.218. SSL alarm is being raised</b></p><div class="figure-contents"><pre class="screen">SH alarmd[5547]: [alarmd.NOTICE]: Alarm 'certs_expiring' triggering 
SH alarmd[5547]: [alarmd.INFO]: Propagating changes for 1 alarms 
SH alarmd[5547]: [alarmd.NOTICE]: Alarm 'ssl' triggering 
SH alarmd[5547]: [alarmd.NOTICE]: Alarm 'health' triggering 
SH mgmtd[3544]: [mgmtd.INFO]: EVENT:  /alarm/event/alarm/certs_expiring/triggered 
SH mgmtd[3544]: [mgmtd.INFO]: Expiring/Expired SSL certificate(s) detected. 
SH mgmtd[3544]: [mgmtd.INFO]: Expiring/Expired SSL certificate(s) have been detected.  For \
     more information, please check these pages:  http://SH/mgmt/gui?p=setupServiceProtoco \
    lsSSLMain  http://SH/mgmt/gui?p=setupServiceProtocolsSSLPeering  http://SH/mgmt/gui?p= \
    setupServiceProtocolsSSLCAs or use the CLI command "show protocol ssl expiring-certs" 
</pre></div></div><br class="figure-break"><p>The expired SSL certificates can be removed via the GUI or CLI,
depending on their roles:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Peering certificates: Under Configure -&gt; Optimization -&gt; Secure
  Peering (SSL) you can regenerate the certificate. From the CLI:
<code class="computeroutput">secure-peering generate-cert rsa</code>
</p></li><li class="listitem"><p>Server certificates: Under Configure -&gt; Optimization -&gt; SSL Main
  Settings you can update or remove the certificate. From the CLI:
<code class="computeroutput">no protocol ssl server-cert name &lt;name&gt;</code>
</p></li><li class="listitem"><p>Server chain certificates: From the CLI:
<code class="computeroutput">no protocol ssl server-cert name &lt;name&gt; chain-cert &lt;name&gt;</code>
</p></li><li class="listitem"><p>CA certificates: Under Configure -&gt; Optimization -&gt; Certifcate
  Authorities you can remove the certificate. This list can be
  large, sorting it on Expiration Date will help. From the CLI:
<code class="computeroutput">no protocol ssl ca &lt;name&gt;</code>
</p></li><li class="listitem"><p>Peering CA certificates: Under Configure -&gt; Optimization -&gt; Secure
  Peering (SSL) under the Peering Trust you can remove the certificate.
  From the CLI:
<code class="computeroutput">no secure-peering trust ca &lt;name&gt;</code>
</p></li><li class="listitem"><p>Peering white list certificates: Under Under Configure -&gt;
  Optimization -&gt; Secure Peering (SSL) under the Self-Signed Peer
  White List you can remove the certificate. From the CLI:
<code class="computeroutput">no secure-peering white-lst-peer &lt;name&gt;</code>
</p></li><li class="listitem"><p>Mobile trusts certificates: Under Under Configure -&gt;
  Optimization -&gt; Secure Peering (SSL) under the Mobile Trust
  certificate. From the CLI:
<code class="computeroutput">no secure-peering trust mobile &lt;name&gt;</code>
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39491048"></a>5.32. High CPU related issues</h2></div></div></div><p>When there is a high CPU alarm on the Steelhead appliance, there
can be various reasons for this:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>High CPU due to traffic issues.
</p></li><li class="listitem"><p>High CPU due to RSP issues.
</p></li><li class="listitem"><p>High CPU due to spinning processes.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39492008"></a>5.32.1. Traffic related CPU issues</h3></div></div></div><p>If the CPU issues are related to the traffic, then the CPU load
should follow the traffic pattern.
</p><p>If the CPU load recorded in the System Accounting Records
on this device show that CPU 0-6 and 8-11 have all more or less the
same pattern and CPU 7 shows with a huge
<span class="italics">%soft</span>
value which might be related to the traffic:
</p><div class="figure"><a name="idp39492712"></a><p class="title"><b>Figure 5.219. CPU 7 shows a higher CPU load than the other ones</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operations-63-cpu.png" align="middle" width="100%" alt="CPU 7 shows a higher CPU load than the other ones"></td></tr></table></div></div></div><br class="figure-break"><p>This is the traffic as in number of packets per second on the LAN
side and on the WAN side as recorded in the System Accounting
Records:
</p><div class="figure"><a name="idp39493672"></a><p class="title"><b>Figure 5.220. Number of packets going through the LAN and WAN side</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operations-63-traffic.png" align="middle" width="100%" alt="Number of packets going through the LAN and WAN side"></td></tr></table></div></div></div><br class="figure-break"><p>So that confirms that the CPU load is following the traffic pattern,
which means that the traffic is causing the CPU alarm.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39478312"></a>5.32.1.1. NIC limitations and multi-queuing</h4></div></div></div><p>For some of the NICs, the traffic is dealt with by the same CPU.
This is fine for desktop and 1RU devices, however for the large 3RU
devices this is often a bottleneck. Since RiOS 8.0 and higher, for
some of the NICs the traffic can be distributed in multiple queues,
spreading the load over multiple CPUs and thus preventing a single
CPU to be overloaded.
</p><p>If the NIC supports this feature can be seen in the section of
<code class="computeroutput">Output of 'cat /proc/interrupts'</code>
the file
<span class="italics">sysinfo.txt</span>
in the system dump:
</p><p>The first output shows that each NIC is dealt with by its own single CPU:
</p><div class="figure"><a name="idp39479464"></a><p class="title"><b>Figure 5.221. Distribution of interrupts for a NIC dealt with by a single CPU</b></p><div class="figure-contents"><pre class="screen">      CPU0       CPU1       CPU2       CPU3
[...]
 48:   143         14    1217838         96  PCI-MSI-edge  wan0_0
 49:     3         88        108    1217838  PCI-MSI-edge  lan0_0
 50:    15          8    2573665         65  PCI-MSI-edge  wan0_1
 51:    54         99         82    8434328  PCI-MSI-edge  lan0_1
</pre></div></div><br class="figure-break"><p>The second output shows that each NIC queue is spread over all CPUs:
</p><div class="figure"><a name="idp39480104"></a><p class="title"><b>Figure 5.222. Distribution of interrupts for a NIC dealt with by multiple CPUs</b></p><div class="figure-contents"><pre class="screen">      CPU0       CPU1       CPU2       CPU3
[...]
 52:     4          0          0          0  PCI-MSI-edge  wan1_1
 53:    68  375249745  383988175  371645180  PCI-MSI-edge  wan1_1-rx-0
 54:    22  424257135  414943503  415290180  PCI-MSI-edge  wan1_1-rx-1
 55:    22  327132986  319572437  314607486  PCI-MSI-edge  wan1_1-rx-2
 56:    22  405144547  408061894  400918998  PCI-MSI-edge  wan1_1-rx-3
 57:    22  650505324  625281921  621856160  PCI-MSI-edge  wan1_1-tx-0
 58:  7663  540561142  529003647  513297250  PCI-MSI-edge  wan1_1-tx-1
 59:    22  668132358  654101138  626834780  PCI-MSI-edge  wan1_1-tx-2
 60:    27  640642031  624693149  605929490  PCI-MSI-edge  wan1_1-tx-3
</pre></div></div><br class="figure-break"><p>The third output shows that each NIC queue is dealt with by its own single CPU:
</p><div class="figure"><a name="idp39480680"></a><p class="title"><b>Figure 5.223. Distrubution of interrupts for a NIC dealt with by multiple CPUs</b></p><div class="figure-contents"><pre class="screen">      CPU0       CPU1       CPU2       CPU3
[...]
 88: 1379090814          0          0          0     PCI-MSI-edge      wan2_0-TxRx-0
 89:         97 1975362362          0          0     PCI-MSI-edge      wan2_0-TxRx-1
 90:         97          0 1616533530          0     PCI-MSI-edge      wan2_0-TxRx-2
 91:         97          0          0 1533039750     PCI-MSI-edge      wan2_0-TxRx-3
</pre></div></div><br class="figure-break"><p>and in the output of the ethtool statistics:
</p><div class="figure"><a name="idp39481256"></a><p class="title"><b>Figure 5.224. Statistics show that there are multiple queues for TX and RX</b></p><div class="figure-contents"><pre class="screen">Output of 'ethtool -S lan1_0':

NIC statistics:
     rx_packets: 63450051974
     tx_packets: 98718359686
     rx_bytes: 37546291563374
     tx_bytes: 37018865599885
[...]
     tx_queue_0_packets: 25155414255
     tx_queue_0_bytes: 9268449949519
     tx_queue_0_restart: 0
     tx_queue_1_packets: 23339319194
     tx_queue_1_bytes: 9115355264290
     tx_queue_1_restart: 0
     tx_queue_2_packets: 23978453361
     tx_queue_2_bytes: 8207159290199
     tx_queue_2_restart: 0
     tx_queue_3_packets: 26245172876
     tx_queue_3_bytes: 10032958161335
     tx_queue_3_restart: 0
     rx_queue_0_packets: 15784045932
     rx_queue_0_bytes: 9098239857902
     rx_queue_0_drops: 0
     rx_queue_0_csum_err: 0
     rx_queue_0_alloc_failed: 0
     rx_queue_1_packets: 15658010393
     rx_queue_1_bytes: 9148562150602
     rx_queue_1_drops: 0
     rx_queue_1_csum_err: 0
     rx_queue_1_alloc_failed: 0
     rx_queue_2_packets: 15809170269
     rx_queue_2_bytes: 9485746463221
     rx_queue_2_drops: 0
     rx_queue_2_csum_err: 0
     rx_queue_2_alloc_failed: 0
     rx_queue_3_packets: 16198806283
     rx_queue_3_bytes: 9559962031124
     rx_queue_3_drops: 0
     rx_queue_3_csum_err: 0
     rx_queue_3_alloc_failed: 0
</pre></div></div><br class="figure-break"><p>If the right NICs is installed but the RiOS version is lower than
8.0, then upgrade to a newer RiOS version. If the right NIC is
installed but not in use, then move the cables and reconfigure the
IP addresses to the right in-path interface.
</p><p>The full list of NICs supporting multiple queues is available in
KB article S23409.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39498536"></a>5.32.1.2. Bypass the traffic</h4></div></div></div><p>If the CPU is overloaded because of traffic, the most logical
workaround would be to not send the traffic through the Steelhead
appliance. There are several methods:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If a large chunk of the traffic is not optimizable, for example
  UDP voice traffic towards a VLAN with VoIP phones, the traffic
  could be routed from the WAN router around the Steelhead appliance
  towards the LAN switch and vice-versa. This way the Steelhead
  appliance doesn't see it and thus not have to process it.
</p></li><li class="listitem"><p>If the NIC in the Steelhead appliance supports hardware by-pass,
  the traffic can be passed through on the NIC level instead of
  having to be dealt with in the kernel level on the Steelhead
  appliance.
</p></li><li class="listitem"><p>Change to a virtual in-path design where only the relevant traffic
  gets send to the Steelhead appliance. In case of WCCP and PBR
  deployment, use the right redirection access-lists to only forward
  optimizable traffic. In case of an Interceptor deployment, only
  optimizable traffic gets redirected to the Steelhead appliance.
</p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39499496"></a>5.32.2. RSP related CPU issues</h3></div></div></div><p>In the System Accounting Records this could like look:
</p><div class="figure"><a name="idp39499880"></a><p class="title"><b>Figure 5.225. A lot of CPU usage is in the 'nice' category</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operations-63-rsprelatedcpu.png" align="middle" width="100%" alt="A lot of CPU usage is in the 'nice' category"></td></tr></table></div></div></div><br class="figure-break"><p>The type is "Nice", which is indicates to RSP related process
</p><p>The contents of the file
<span class="italics">top_output</span>
can show that the process causing the most load is the
<span class="italics">vmware-vmx</span>
process:
</p><div class="figure"><a name="idp39501544"></a><p class="title"><b>Figure 5.226. Single spinning CPU</b></p><div class="figure-contents"><pre class="screen">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND            
 5436 admin     18   1 1065m 797m 539m R 98.7 10.0 169856:25 vmware-vmx         
</pre></div></div><br class="figure-break"><p>The next steps would be to determine what the RSP slot is doing.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39502120"></a>5.32.3. Process related CPU issues</h3></div></div></div><p>In the System Accounting Records this could like look:
</p><div class="figure"><a name="idp39506664"></a><p class="title"><b>Figure 5.227. A userland process is spinning on a CPU</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operations-63-processrelatedcpu.png" align="middle" width="100%" alt="A userland process is spinning on a CPU"></td></tr></table></div></div></div><br class="figure-break"><p>What you see here is that since 21 January around 22:10, suddenly
there were high CPU spikes on all CPUs. It can be on all CPUs, it
can just be stuck on one CPU. The type is "User", which means that
it is a userland process.
</p><p>The contents of the file
<span class="italics">top_output</span>
can show that a single process uses 100% of the CPU time:
</p><div class="figure"><a name="idp39508008"></a><p class="title"><b>Figure 5.228. Single spinning CPU</b></p><div class="figure-contents"><pre class="screen">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND            
 1414 admin     25   0 81176  45m  41m R 100.9  0.1   1005:54 winbindd          
</pre></div></div><br class="figure-break"><p>That 100.9% CPU means that it is spinning in a loop, consuming a
full CPU. The expected behaviour would be that the winbindd process
will only be woken up when Active Directory integration related
tasks are running, for example when a new encrypted MAPI session
gets setup.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39508712"></a>5.33. Central Management Console related issues</h2></div></div></div><p>The CMC manages the configuration of the Steelhead appliances in
the network and monitors the health of the Steelhead appliances,
Steelhead Mobile Controllers, Interceptors and Whitewater appliances.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39509032"></a>5.33.1. CMC connection to the Steelhead appliance</h3></div></div></div><p>The CMC connects to a remote Steelhead appliance on TCP port 22 via
the SSH protocol. It logs in and executes the command
<span class="italics">rgp</span>.
</p><div class="figure"><a name="idp39509608"></a><p class="title"><b>Figure 5.229. CMC 'CMC' connects to a Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">SH sshd[9016]: Accepted password for admin from 192.168.1.102 port 59677 ssh2
SH sshd[9016]: pam_unix(sshd:session): session opened for user admin by (uid=0)
SH cli[9359]: [cli.NOTICE]: user admin: executing remote command: /opt/tms/bin/rgp CMC DA2 \
    HV0001234F
SH rgp[9359]: [rgp.NOTICE]: rgp starting at 2014/01/14 07:34:16
SH rgp[9359]: [rgp.INFO]: session 1: connected to server 'rgpd' as authenticated user 'adm \
    in' (uid 0, gid 0) authorization key 'admin', interactive 'false'
SH rgpd[8624]: [rgpd.INFO]: session 2: accepted client 'rgp-9359' for authenticated user ' \
    admin' (uid 0, gid 0) authorization key 'admin', interactive 'true'
SH rgpd[8624]: [rgpd.INFO]: Getting auth from new outer session
SH rgp[9359]: [rgp.NOTICE]: session 1: existing connection from 
SH rgp[9359]: [rgp.INFO]: Sending first connect event
SH mgmtd[7342]: [mgmtd.INFO]: EVENT:  /cmc/event/connect
SH rgp[9359]: [rgp.INFO]: session 1: accepted client 'rbmd-4108' for authenticated user 'a \
    dmin' (uid 0, gid 0) authorization key 'admin', interactive 'true'
SH rgpd[8624]: [rgpd.INFO]: cli_init_pam(), cli_auth.c:91, build (null): Successfully star \
    ted pam session for the user admin from &lt;unknown&gt;
</pre></div></div><br class="figure-break"><p>The CMC starts the process
<span class="italics">rgp</span>
and specifies the hostname of the CMC,
<span class="italics">CMC</span>
in this case, and the serial number of the Steelhead appliance.
</p><p>To see if a Steelhead appliance is connected to a CMC and which CMC
it is connected to, use the command
<code class="computeroutput">show cmc</code>.
</p><div class="figure"><a name="idp39511144"></a><p class="title"><b>Figure 5.230. Output of the command 'show cmc'</b></p><div class="figure-contents"><pre class="screen">SH # show cmc
CMC auto-registration enabled:       yes
CMC auto-registration hostname:      riverbedcmc
Managed by CMC:                      yes
CMC hostname:                        CMC (192.168.1.102)
Auto configuration status:           Inactive
Last message sent to cmc:            Auto-registration
Time that message was sent:          Thu Jan  9 13:36:39 2014
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39511592"></a>5.33.2. CMC auto-registration</h3></div></div></div><p>The Steelhead appliance can inform the CMC that it is up and running
and that the CMC can connect to it. It tries to resolve the hostname
<span class="italics">riverbedcmc</span>
and sends an HTTP request to it on TCP port 443:
</p><div class="figure"><a name="idp39512232"></a><p class="title"><b>Figure 5.231. Auto-registration by the Steelhead appliance</b></p><div class="figure-contents"><pre class="screen">17:51:06.614599 IP 10.0.1.5.14661 &gt; 192.168.1.1.53: 2495+ A? riverbedcmc.example.org. (45)
17:51:06.614608 IP 10.0.1.5.14661 &gt; 192.168.1.1.53: 2687+ AAAA? riverbedcmc.example.org. ( \
    45)
17:51:06.803037 IP 192.168.1.1.53 &gt; 10.0.1.5.14661: 2495* 1/0/0 A 192.168.1.102 (61)
17:51:06.803275 IP 192.168.1.1.53 &gt; 10.0.1.5.14661: 2687* 0/1/0 (96)
17:51:06.803368 IP 10.0.1.5.24332 &gt; 192.168.1.102.443: Flags [S], seq 4235884934, win 5840 \
    , options [mss 1460,sackOK,TS val 2859884311 ecr 0,nop,wscale 2], length 0
17:51:06.993913 IP 192.168.1.102.443 &gt; 10.0.1.5.24332: Flags [S.], seq 1834967271, ack 423 \
    5884935, win 5792, options [mss 1304,sackOK,TS val 1233057525 ecr 2859884311,nop,wscal \
    e 7], length 0
17:51:06.993930 IP 10.0.1.5.24332 &gt; 192.168.1.102.443: Flags [.], seq 1, ack 1, win 1460,  \
    options [nop,nop,TS val 2859884501 ecr 1233057525], length 0
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39512680"></a>5.33.3. CMC Managed Appliance Alarms</h3></div></div></div><p>The CMC will collect data from all Steelhead appliances, analyses
this data and raise an alarm on the CMC while the Steelhead appliance
itself is healthy. This report can be found in the GUI under Reports
-&gt; Appliance Diagnostics -&gt; Appliance Details.
</p><p>Examples of this alarms are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Unmanaged appliances
</p></li><li class="listitem"><p>Time drift
</p></li><li class="listitem"><p>Duplex alarm
</p></li><li class="listitem"><p>Configuration change
</p></li><li class="listitem"><p>High usage and Connection Limit Warning
</p></li><li class="listitem"><p>Too many half-open or half-closed connections
</p></li><li class="listitem"><p>PFS and RSP
</p></li><li class="listitem"><p>Poll timeout
</p></li></ul></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39514792"></a>5.33.3.1. Unmanaged appliances</h4></div></div></div><p>This alarm gets raised when the Steelhead appliance is peering with
another Steelhead appliance this CMC is not managing.
</p><p>The presence of an unknown peer Steelhead appliance which is not
managed by the CMC can be caused by an oversight of the networking
team or a problem in the network. If the origin of the unknown
Steelhead appliance has been determined, it can either be added
under control of the CMC or it can be added to a blacklist under
Configure -&gt; System Settings -&gt; Alarms -&gt; CMC Managed Appliance
Alarms -&gt; Unmanaged Appliances:
</p><div class="figure"><a name="idp39515240"></a><p class="title"><b>Figure 5.232. Add Steelhead appliances to the unmanaged peer whitelist.</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operations-90-unmanagedpeers.png" align="middle" width="100%" alt="Add Steelhead appliances to the unmanaged peer whitelist."></td></tr></table></div></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39516072"></a>5.33.3.2. Time drift</h4></div></div></div><p>This alarm gets raised when the time on the Steelhead appliance is
significantly different from the time on the CMC. It might indicate
a broken NTP configuration on the Steelhead appliance, which might
interfere with the Windows Active Directory integration.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39516392"></a>5.33.3.3. Duplex alarm</h4></div></div></div><p>This alarm gets raised when there are frame errors detected on the
Steelhead appliance. The next steps would be to inspect the Steelhead
appliance interface NIC statistics and determine why this alarm got
raised.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39516712"></a>5.33.3.4. Configuration change</h4></div></div></div><p>This alarm gets raised when the configuration on the Steelhead
appliance has changed. Since the configuration is managed via the
CMC, an uncontrolled change has happened and should be investigated.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39517032"></a>5.33.3.5. High usage and Connection Limit Warning</h4></div></div></div><p>These alarms get raised when the Steelhead appliance is close to
Connection-based Admission Control.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39517352"></a>5.33.3.6. Too many half-open or half-closed connections</h4></div></div></div><p>This alarm gets raised when there are many half-opened or half-closed
TCP connections on the Steelhead appliance. This can happen when
there are problems in the auto-discovery process or during the setup
of the optimized TCP session or in the teardown of the optimized
TCP session.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39517672"></a>5.33.3.7. PFS and RSP</h4></div></div></div><p>This alarm gets raised when both RSP and PFS are configured on a
Steelhead appliance. These two services are mutually exclusive.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39517992"></a>5.33.3.8. Poll timeout</h4></div></div></div><p>This alarm gets raised when the commands submitted by the CMC to
the Steelhead appliance take a long time to obtain responses. The
next step would be a health check of the Steelhead appliance.
</p></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="System_Dump"></a>Chapter 6. System Dump</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp39518760">6.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp39543848">6.2. Creation of a system dump</a></span></dt><dt><span class="sect1"><a href="#idp39549096">6.3. Configuration of the system</a></span></dt><dt><span class="sect1"><a href="#idp39560552">6.4. Log files</a></span></dt><dt><span class="sect1"><a href="#systemdump_hardwareinformation">6.5. Hardware Information</a></span></dt><dt><span class="sect1"><a href="#idp39731240">6.6. System Information</a></span></dt><dt><span class="sect1"><a href="#idp39864424">6.7. Simplified Routing related files</a></span></dt><dt><span class="sect1"><a href="#idp39876328">6.8. ATA controller SMART data</a></span></dt><dt><span class="sect1"><a href="#idp39878312">6.9. Asymmetric routing table</a></span></dt><dt><span class="sect1"><a href="#idp39882152">6.10. The Image History file</a></span></dt><dt><span class="sect1"><a href="#idp39887592">6.11. The file "lsof"</a></span></dt><dt><span class="sect1"><a href="#idp39890600">6.12. Memory dump of the process sport</a></span></dt><dt><span class="sect1"><a href="#idp39894440">6.13. Out-of-memory profiling</a></span></dt><dt><span class="sect1"><a href="#idp39896360">6.14. CIFS pre-population related data</a></span></dt><dt><span class="sect1"><a href="#idp39899944">6.15. RSP related data</a></span></dt><dt><span class="sect1"><a href="#idp39903656">6.16. SAR statistics</a></span></dt><dt><span class="sect1"><a href="#idp39904616">6.17. Active Directory Integration</a></span></dt><dt><span class="sect1"><a href="#idp39907432">6.18. Process dumps</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39518760"></a>6.1. Index</h2></div></div></div><p>A system dump is a collection of historical data and a snapshot of
the state of the Steelhead appliance.
</p><p>It contains the following sections:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Creation of the system dump and how to provide it to the Riverbed TAC.
</p></li><li class="listitem"><p>The current configuration of the device.
</p></li><li class="listitem"><p>The log files of the Steelhead appliance.
</p></li><li class="listitem"><p>Hardware information about the Steelhead appliance.
</p></li><li class="listitem"><p>System information about the Steelhead appliance.
</p></li><li class="listitem"><p>The alarms on a Steelhead appliance.
</p></li><li class="listitem"><p>Simplified routing.
</p></li><li class="listitem"><p>SMART data.
</p></li><li class="listitem"><p>Asymmetric routing.
</p></li><li class="listitem"><p>Image history.
</p></li><li class="listitem"><p>lsof.
</p></li><li class="listitem"><p>Memory dump of the optimization process.
</p></li><li class="listitem"><p>Out-of-memory profiling.
</p></li><li class="listitem"><p>CIFS pre-population.
</p></li><li class="listitem"><p>RSP related data.
</p></li><li class="listitem"><p>SDR statistics.
</p></li><li class="listitem"><p>Statistic files.
</p></li><li class="listitem"><p>SAR statistics.
</p></li><li class="listitem"><p>Active Directory information.
</p></li><li class="listitem"><p>Process dumps.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39543848"></a>6.2. Creation of a system dump</h2></div></div></div><p>To generate a system dump from the CLI, issue the commands
<code class="computeroutput">debug generate dump</code>
(with the possible options of
<span class="italics">stats</span>
to include the statistics and
<span class="italics">all-logs</span>
to include all the log files). Then use the command
<code class="computeroutput">file debug &lt;system dump&gt; upload &lt;URL&gt;</code>
to upload the system dump to a remote FTP server or SSH server. To
see a list of all system dumps from the CLI, use the command
<code class="computeroutput">show files debug-dump</code>.
</p><div class="figure"><a name="idp39545576"></a><p class="title"><b>Figure 6.1. Create a system dump from the CLI</b></p><div class="figure-contents"><pre class="screen">SH # debug generate dump
Systemdump sysdump-SH-20111010-163012.tgz generated
SH # show files debug-dump
sysdump-SH-20111010-163012.tgz
SH # file debug-dump sysdump-SH-20111010-163012.tgz upload ftp://192.168.1.1/incoming/sysd \
    ump-SH-20111010-163012.tgz
SH # 
</pre></div></div><br class="figure-break"><p>Since RiOS version 8.5, the system dump can be directly uploaded
to the Riverbed FTP server if Steelhead appliance has direct access
to the Internet:
</p><div class="figure"><a name="idp39546152"></a><p class="title"><b>Figure 6.2. Upload a system dump directly to the Riverbed FTP server</b></p><div class="figure-contents"><pre class="screen">SH # file debug-dump sysdump-SH-20111010-163012.tgz case 123456
</pre></div></div><br class="figure-break"><p>To generate a system dump from the GUI, go to Reports -&gt; Diagnostics -&gt;
System dumps and click on the
<span class="italics">Generate System Dump</span>
button. When the system dump is completed you can download it to
your computer.
</p><div class="figure"><a name="idp39547048"></a><p class="title"><b>Figure 6.3. Create a system dump from the GUI</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/06-systemdumpcreate.png" align="middle" width="100%" alt="Create a system dump from the GUI"></td></tr></table></div></div></div><br class="figure-break"><p>If there is not enough disk space available or there are too many system
dumps, the Steelhead appliance will complain:
</p><div class="figure"><a name="idp39548008"></a><p class="title"><b>Figure 6.4. Not being able to generate a system dump</b></p><div class="figure-contents"><pre class="screen">SH # debug generate dump all-logs
% Insufficient disk space to perform sysdump.

SH # debug generate dump
% Limit on number of sysdumps on the system is 10,
please remove some before generating new ones
</pre></div></div><br class="figure-break"><p>Use the commands in the section about
<span class="italics">Partitions running out of space</span>
to free up the disk space.
</p><p>As can be seen from the name, the system dump is a gzip compressed
tar-ball. The filename contains the hostname of the Steelhead
appliance and the date and time the system dump was created.
</p><p>Note that over time, new features are added to the system dump
process. It could be possible that some files or sections described
here are not available in earlier RiOS versions.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39549160"></a>6.2.1. Dealing with a system dump</h3></div></div></div><p>As the extension shows, the system dump is a gzip compressed tar-ball.
The standard
<span class="italics">tar</span>
command can be used to extract it:
<code class="computeroutput">tar zxvf &lt;system dump&gt;</code>.
Some of the files in it will still be compressed, use the
<span class="italics">gunzip</span>
command to decompress them:
<code class="computeroutput">gunzip sydump*/*.gz</code>.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39549096"></a>6.3. Configuration of the system</h2></div></div></div><p>This section describes the configuration of the Steelhead appliance
as seen in the system dump.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39551208"></a>6.3.1. The configuration of the optimization service</h3></div></div></div><p>The configuration of the system, as seen by the output of the command
<code class="computeroutput">show running</code>,
can be found in the file
<span class="italics">active-running.txt</span>.
</p><div class="figure"><a name="idp39556200"></a><p class="title"><b>Figure 6.5. Contents of the active-running.txt file</b></p><div class="figure-contents"><pre class="screen">##
## Network interface configuration
##
   interface inpath0_0 description ""
no interface inpath0_0 dhcp
no interface inpath0_0 dhcp dynamic-dns
no interface inpath0_0 force-mdi-x enable
   interface inpath0_0 ip address 10.17.6.100 /25
   interface inpath0_0 mtu "1500"
no interface inpath0_0 shutdown
   interface inpath0_0 speed "auto"
   interface inpath0_0 txqueuelen "100"
   interface lan0_0 description ""
</pre></div></div><br class="figure-break"><p>The output of the command
<code class="computeroutput">show running full</code>
can be found in the file 
<span class="italics">active-running-full.txt</span>.
</p><p>There are more files which names start with
<span class="italics">active</span>,
like the
<span class="italics">active.db</span>,
<span class="italics">active.txt</span>
and
<span class="italics">active-brief.txt</span>.
These are the configuration files which contain all of the knobs
and buttons of the optimization service, but in an internal format.
</p><p>Further there are files which names start with
<span class="italics">local</span>,
like the
<span class="italics">local.txt</span>
and
<span class="italics">local-brief.txt</span>.
These are also part of the configuration but with fields part of
auto-configuration like the license keys.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39559336"></a>6.3.2. The configuration of the various daemons</h3></div></div></div><p>In the directory
<span class="italics">output</span>
are the configurations of the various daemons of the operating
system, like the syslog daemon and the SNMP daemon:
</p><div class="figure"><a name="idp39559976"></a><p class="title"><b>Figure 6.6. Configuration of the syslog daemon and SNMP daemon</b></p><div class="figure-contents"><pre class="screen">[~/CSH-20110530-163605] edwin@t43&gt;cat output/syslog.conf
##
## This file was AUTOMATICALLY GENERATED.  DO NOT MODIFY.
## Any changes will be lost.
##
## Generated by md_syslog at 2011/05/24 16:07:00
##
*.notice                        -/var/log/messages
local1.*                        -/var/log/user_messages

[~/CSH-20110530-163605] edwin@t43&gt;cat output/snmpd.conf
##
## This file was AUTOMATICALLY GENERATED.  DO NOT MODIFY.
## Any changes will be lost.
##
## Generated by md_snmp at 2011/05/24 16:07:11
##
rocommunity public
trapcommunity public
trapinterface primary
sysServices 78
engineID 0x8000430b805525428b4b8706c7
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39560552"></a>6.4. Log files</h2></div></div></div><p>There are various system logs included in the system dump of the
Steelhead appliance:
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39560872"></a>6.4.1. System logs</h3></div></div></div><p>The messages files (messages, messages.1.gz, messages.2.gz etc) are
the system logs which can also be seen on the CLI with the command
<code class="computeroutput">show log</code>
and
<code class="computeroutput">show log files N</code>.
</p><p>The first line in the system logs is the version of RiOS running
on the Steelhead appliance at the time the system logs get rotated.
</p><p>By default the logging level of the Steelhead appliances is set to
<span class="italics">notice</span>
level, but when investigating problems
<span class="italics">info level logging</span>
might be required.
</p><div class="figure"><a name="idp39562472"></a><p class="title"><b>Figure 6.7. Beginning of the file "messages"</b></p><div class="figure-contents"><pre class="screen">BUILD_PROD_VERSION:               rbt_sh 6.5.0a #84_26 2011-04-04 20:34:46 i386 root@misko \
    lc:svn://svn/mgmt/branches/canary_84_fix_branch
May 28 00:00:00 CSH syslogd 1.4.1: restart.
May 28 00:00:21 CSH sport[6693]: [smbsfe.NOTICE] 15446 {10.0.1.1:53286 192.168.1.1:445} Cl \
    ient and Server negotiated SMB2 protocol SMB2.Turning OFF CIFS optimizations. However  \
    SDR optimizations will continue.
May 28 00:00:53 CSH sport[6693]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 10 \
    .45.5.3
May 28 00:00:53 CSH sport[6693]: [splice/oob.NOTICE] 10 {- -} Lost OOB Splice between ladd \
    r=10.33.0.91:7800 and raddr=10.45.5.3:7800
</pre></div></div><br class="figure-break"><p>The format of the lines logged by the optimization service is:
</p><div class="figure"><a name="idp39563112"></a><p class="title"><b>Figure 6.8. Format of the log messages by the optimization service</b></p><div class="figure-contents"><pre class="screen">&lt;date&gt; &lt;time&gt; &lt;hostname&gt; sport[process id] &lt;functionality.loglevel&gt; &lt;splice-id&gt; {&lt;client I \
    P address:client TCP port&gt; &lt;server IP address:server TCP port&gt;} &lt;message&gt;
</pre></div></div><p><br class="figure-break">
</p><p>The
<span class="italics">date</span>
only contains the month name and the date, not the year.
The
<span class="italics">date</span>
and
<span class="italics">time</span>
do not contain the time zone configured on the
Steelhead appliance. The loglevel, or severity, is the importance
of the message shown, it can be info, notice, warn(ing), err(or)
and crit(ical). The
<span class="italics">splice-id</span>
is a sequence number of the inner channel being setup. if no splice-id
can be determined it will be replaced by a "-" (dash) and the IP
address and TCP ports will be replaced by a dash too.
</p><p>The
<span class="italics">functionality</span>
can be the part of the "sport" optimization service:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>splice/probe: Messages related to the auto-discovery of optimized
  TCP sessions.
</p></li><li class="listitem"><p>io/inner/prod: Messages related to the setup of an optimized TCP
  session.
</p></li><li class="listitem"><p>splice/oob: The Out-of-Band Splice between two Steelhead
  appliances.
</p></li><li class="listitem"><p>connect_pool: The list of TCP sessions part of the Connection
  Pool.
</p></li><li class="listitem"><p>mapi/*: MAPI latency optimization related messages.
</p></li><li class="listitem"><p>smbcfe: CIFS client-side latency optimization related messages.
</p></li><li class="listitem"><p>smbsfe: CIFS server-side latency optimization related messages.
</p></li><li class="listitem"><p>http/*: HTTP latency optimization related messages.
</p></li></ul></div><p>Or from other processes on the Steelhead appliances:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>kernel / intercept: Messages in related to the intercept kernel-module
  which tracks the setup of new optimized TCP sessions.
</p></li><li class="listitem"><p>mgmtd: Messages related to the management daemon.
</p></li><li class="listitem"><p>pm: Messages related to the process manager.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39572200"></a>6.4.2. GUI logs</h3></div></div></div><p>The GUI logs are logged in the files
<span class="italics">web_access.log</span>
and
<span class="italics">web_error.log</span>,
which are the normal Apache-style logging.
</p><p>The file
<span class="italics">web_access.log</span>
contains the IP address the request came from, the date and time,
the URL requested, the return result and the size of the payload
returned.
</p><div class="figure"><a name="idp39573416"></a><p class="title"><b>Figure 6.9. Beginning of the file "web_access.log"</b></p><div class="figure-contents"><pre class="screen">10.0.1.1 - - [30/May/2011:16:20:02 +1000] "GET /rollup-product.css?v=1001518176 HTTP/1.1"  \
    304 -
10.0.1.1 - - [30/May/2011:16:20:03 +1000] "POST /mgmt/xmldata?p=inpathRules HTTP/1.1" 200  \
    489
10.0.1.1 - - [30/May/2011:16:20:07 +1000] "GET /images/aet_edit_close.png HTTP/1.1" 200 17 \
    3
10.0.1.1 - - [30/May/2011:16:20:18 +1000] "POST /mgmt/xmldata?p=dynamicStatus HTTP/1.1" 20 \
    0 98
</pre></div></div><br class="figure-break"><p>The file
<span class="italics">web_error.log</span>
contains the date and time and the reported issue.
</p><div class="figure"><a name="idp39574312"></a><p class="title"><b>Figure 6.10. Beginning of the file "web_error.log"</b></p><div class="figure-contents"><pre class="screen">[Mon May 30 00:00:00 2011] [notice] Apache configured -- resuming normal operations
[Mon May 30 16:20:00 2011] [notice] Graceful restart requested, doing restart
[Mon May 30 16:20:00 2011] [notice] Apache configured -- resuming normal operations
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39574760"></a>6.4.3. Kernel log</h3></div></div></div><p>The kernel log of the Steelhead appliance is recorded in the file
<span class="italics">dmesg</span>.
This kernel log is a circular buffer which gets populated from the
moment the Steelhead appliance gets booted. If the system dump is
taken soon after the reboot, it will contain the whole boot log.
</p><div class="figure"><a name="idp39575336"></a><p class="title"><b>Figure 6.11. Part of the file "dmesg"</b></p><div class="figure-contents"><pre class="screen">Linux version 2.6.9-34.EL-rbt-7989SMP (root@miskolc.lab.nbttech.com) (gcc version 3.4.6 20 \
    060404 (Red Hat 3.4.6-10)) #2 SMP Fri Feb 4 18:54:45 PST 2011
BIOS-provided physical RAM map:
 BIOS-e820: 0000000000000000 - 000000000009fc00 (usable)
 BIOS-e820: 000000000009fc00 - 00000000000a0000 (reserved)
 BIOS-e820: 00000000000e0000 - 0000000000100000 (reserved)
 BIOS-e820: 0000000000100000 - 00000000dffd0000 (usable)
</pre></div></div><br class="figure-break"><p>The file
<span class="italics">dmesg-boot</span>,
available since RiOS version 8.5, contains a copy of the
<span class="italics">dmesg</span>
file just after the startup of the Steelhead appliance.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39576616"></a>6.4.4. CLI history log</h3></div></div></div><p>The file
<span class="italics">cli_history_root</span>
contains the commands entered on the CLI by the admin user. For
example, this is the history of the upgrade of the Steelhead
appliance:
</p><div class="figure"><a name="idp39577192"></a><p class="title"><b>Figure 6.12. Part of the file "cli_history_root"</b></p><div class="figure-contents"><pre class="screen"> 20110524155032 0
show run
 20110524155047 0
no interface primary shutdown 
 20110524155500 0
image fetch *
 20110524160139 0
image install sh-i386-6.5.0a 
 20110524160316 0
image install sh-i386-6.5.0a 1
 20110524160347 0
image boot 1
 20110524160349 0
wr m
 20110524160349 0
reload
</pre></div></div><br class="figure-break"><p>The numbers are the year-month-day-hour-minute-second format.
</p><p>There are lines which could contain a username or password. That
part of the line has been removed, for example in the
<code class="computeroutput">image fetch</code>
command.
</p><p>There is a similar file for the monitor user called
<span class="italics">cli_history_monitor</span>.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39578664"></a>6.4.5. Optimization service memory log</h3></div></div></div><p>Under normal operations, the Steelhead appliance is logging under
the Notice priority. But a lot of interesting information is logged
in the optimization service under the Info level.
</p><p>The optimization service keeps the last 16 kilobytes of the messages
logged under Info level and higher. When the optimization service
logs an error with a priority of Error or higher (Error, Critical
or Emergency), it will write this to the file
<code class="computeroutput">/var/log/memlog</code>.
This way important information of the optimization service in case
of an error in the optimization service can be caught even if
specific Info level logging hasn't been enabled.
</p><div class="figure"><a name="idp39579368"></a><p class="title"><b>Figure 6.13. First ten lines of the file memlog.1</b></p><div class="figure-contents"><pre class="screen">[Sep 14 15:26:25 19591 659750 /splice/client INFO] {57.200.61.29:1993 57.200.2.20:8014} St \
    art flowing, lport 38856, rport 7800, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_A \
    UTO, TRANSPORT_ID_NONE, TPTOPT_NONE(0x0), TRPY_FULL
[Sep 14 15:26:25 19591 -1 /http/cache INFO] {- -} decode decode DONE
[Sep 14 15:26:25 19591 659750 /splice/client INFO] {57.200.61.29:1993 57.200.2.20:8014} fi \
    ni client 57.200.61.29:1993 server 57.200.2.20:8014 cfe 57.200.157.219:38856 sfe 172.1 \
    9.18.152:7800 app TCP
[Sep 14 15:26:25 19591 -1 /http/cache INFO] {- -} decode decode DONE
[Sep 14 15:26:25 19591 659751 /splice/client INFO] {57.200.61.29:1994 57.200.2.20:8014} in \
    it client 57.200.61.29:1994 server 57.200.2.20:8014 cfe 57.200.157.219:7801 sfe 172.19 \
    .18.152:7800 client connected: yes
[Sep 14 15:26:25 19591 659751 /splice/client INFO] {57.200.61.29:1994 57.200.2.20:8014} tr \
    py: TRPY_FULL, csum 0 local: 57.200.61.29:1994 remote: 57.200.2.20:8014
[Sep 14 15:26:25 19591 -1 /http/cache INFO] {- -} decode decode DONE
[Sep 14 15:26:25 19591 -1 /http/cache INFO] {- -} decode decode DONE
[Sep 14 15:26:25 19591 -1 /http/cache INFO] {- -} decode decode DONE
[Sep 14 15:26:25 19591 659751 /splice/client INFO] {57.200.61.29:1994 57.200.2.20:8014} Sp \
    lice client side initializing: No protocol port = 8014 protocol id = TCP(0) transport  \
    = TRANSPORT_ID_NONE
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39579816"></a>6.4.6. Log file management</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39580008"></a>6.4.6.1. Period based log file rotation</h4></div></div></div><p>By default the system logs are rotated once every day at midnight:
</p><div class="figure"><a name="idp39580392"></a><p class="title"><b>Figure 6.14. Output of the "show logging" command, daily rotation</b></p><div class="figure-contents"><pre class="screen">SH # show logging
Local logging level: notice
Default remote logging level: notice
Number of archived log files to keep: 10
Log rotation frequency: daily
</pre></div></div><br class="figure-break"><p>However, every twenty minutes the Steelhead appliance will check if the
file size of the current log file is more than 1 Gb. If it is more than
1 Gb, it will force a rotation of it.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39581032"></a>6.4.6.2. Size based log file rotation</h4></div></div></div><p>The log file rotation can be set to a size based rotation scheme, for
example when the 20 minute check interval is too small.
</p><div class="figure"><a name="idp39581352"></a><p class="title"><b>Figure 6.15. Output of the "show logging" command, rotation by size</b></p><div class="figure-contents"><pre class="screen">SH (config) # logging files rotation criteria size 1000
SH (config) # show logging
Local logging level: notice
Default remote logging level: notice
Number of archived log files to keep: 10
Log rotation size threshold: 1000 megabytes
SH (config) # logging files rotation criteria frequency daily
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39581864"></a>6.4.6.3. Manual log file rotation</h4></div></div></div><p>To force a log file rotation, use the command
<code class="computeroutput">logging files rotation force</code>.
</p><p>To manually remove a set of log files, use the command
<code class="computeroutput">logging files delete oldest</code>.
</p><div class="figure"><a name="idp39582888"></a><p class="title"><b>Figure 6.16. Manually removing log files</b></p><div class="figure-contents"><pre class="screen">SH # logging files delete oldest ?
&lt;cr&gt;             Delete the single oldest log file
&lt;number&gt;         Select the number of oldest log files to delete
SH # logging files delete oldest 3
SH #
</pre></div></div><br class="figure-break"><p>You can download previous system logs via the GUI under Reports -&gt;
Diagnostics -&gt; System Logs Download.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="systemdump_hardwareinformation"></a>6.5. Hardware Information</h2></div></div></div><p>The file
<span class="italics">hardwareinfo.txt</span>
contains information of the Steelhead appliance like the DMI table,
the sensors on the motherboard, the PCI bus details, the hard disk
and RAID status and IPMI information.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39584296"></a>6.5.1. DMI and SMBIOS</h3></div></div></div><p>The DMI (Desktop Management Interface) or SMBIOS (System Management
BIOS) table is an overview of the devices of the Steelhead appliance
like the motherboard, memory configuration, SATA controllers, USB
controllers etc.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39584680"></a>6.5.2. Sensors</h3></div></div></div><p>The sensors section shows the state of the fan-speeds, line voltages
and temperature sensors.
</p><div class="figure"><a name="idp39585000"></a><p class="title"><b>Figure 6.17. Output of the sensors section on the 100 / 200 / 300 models</b></p><div class="figure-contents"><pre class="screen">w83627hf-isa-0290
Adapter: ISA adapter
VCore 1:   +1.22 V  (min =  +0.00 V, max =  +0.00 V)
VCore 2:   +1.04 V  (min =  +0.00 V, max =  +0.00 V)
+3.3V:     +3.28 V  (min =  +3.14 V, max =  +3.46 V)
+5V:       +4.89 V  (min =  +4.73 V, max =  +5.24 V)
+12V:     +11.31 V  (min = +10.82 V, max = +13.19 V)
-12V:      +1.13 V  (min = -13.18 V, max = -10.88 V)
-5V:       +2.54 V  (min =  -5.25 V, max =  -4.75 V)
V5SB:      +5.38 V  (min =  +4.73 V, max =  +5.24 V)
VBat:      +3.17 V  (min =  +2.40 V, max =  +3.60 V)
fan1:     5818 RPM  (min = 2657 RPM, div = 2)
fan2:        0 RPM  (min = 2657 RPM, div = 2)
fan3:        0 RPM  (min = 2657 RPM, div = 2)
temp1:       +52 C  (high =    -1 C, hyst =   -65 C)   sensor = thermistor
temp2:     +39.0 C  (high =  +120 C, hyst =  +115 C)   sensor = PII/Celeron diode
temp3:     -47.5 C  (high =  +120 C, hyst =  +115 C)   sensor = PII/Celeron diode
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39585576"></a><p class="title"><b>Figure 6.18. Output of the sensors section on the 520 / 1020 / 1520 / 2020 models</b></p><div class="figure-contents"><pre class="screen">bmc-i2c-0-00
Adapter: IPMI adapter
in1:       +3.07 V  (min =  +2.64 V, max =  +0.00 V)
fan1:     3150 RPM  (min =  750 RPM)
fan2:     3150 RPM  (min =  750 RPM)
fan3:     1350 RPM  (min = 1425 RPM)
temp1:     +41.0 C  (high =  +125 C, hyst =  -127 C)
temp2:     +31.0 C  (high =   +53 C, hyst =  -127 C)
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39586088"></a><p class="title"><b>Figure 6.19. Output of the sensors section on the 3020 / 3520 / 5520 / 6020 / 6120 models</b></p><div class="figure-contents"><pre class="screen">adm1026-i2c-1-2c
Adapter: SMBus2 AMD8111 adapter at cc00
in0:       +2.31 V  (min =  +0.00 V, max =  +2.99 V)
in1:       +1.59 V  (min =  +2.25 V, max =  +2.75 V)   ALARM
in2:       +2.62 V  (min =  +2.25 V, max =  +2.75 V)
in3:       +1.22 V  (min =  +2.25 V, max =  +2.75 V)   ALARM
in4:       +0.00 V  (min =  +0.00 V, max =  +2.99 V)   ALARM
in5:       +0.00 V  (min =  +0.00 V, max =  +2.99 V)   ALARM
in6:       +0.00 V  (min =  +0.00 V, max =  +2.49 V)   ALARM
in7:       +1.43 V  (min =  +1.02 V, max =  +1.68 V)
in8:       +0.00 V  (min =  +0.00 V, max =  +2.49 V)
in9:       +0.44 V  (min =  +0.00 V, max =  +0.70 V)
in10:      +3.30 V  (min =  +2.97 V, max =  +3.64 V)
in11:      +3.42 V  (min =  +0.00 V, max =  +4.42 V)
in12:      +3.35 V  (min =  +2.97 V, max =  +3.64 V)
in13:      +5.02 V  (min =  +4.50 V, max =  +5.49 V)
in14:      +1.43 V  (min =  +1.02 V, max =  +1.68 V)
in15:     +12.19 V  (min = +10.81 V, max = +13.19 V)
in16:     -11.95 V  (min = -13.18 V, max = -10.80 V)
fan0:     5113 RPM  (min =  712 RPM, div = 8)
fan1:     5113 RPM  (min =  712 RPM, div = 8)
fan2:     4963 RPM  (min =  712 RPM, div = 8)
fan3:     5113 RPM  (min =  712 RPM, div = 8)
fan4:     5113 RPM  (min =  712 RPM, div = 8)
fan5:     4963 RPM  (min =  712 RPM, div = 8)
fan6:        0 RPM  (min =  712 RPM, div = 8)   ALARM
fan7:        0 RPM  (min =  712 RPM, div = 8)   ALARM
temp1:       +34 C  (low  =    +0 C, high =   +80 C)
temp2:       +50 C  (low  =    +0 C, high =   +72 C)
temp3:       +45 C  (low  =    +0 C, high =   +72 C)

w83627hf-isa-0290
Adapter: ISA adapter
VCore 1:   +1.30 V  (min =  +0.00 V, max =  +0.00 V)
VCore 2:   +1.31 V  (min =  +0.00 V, max =  +0.00 V)
+3.3V:     +3.33 V  (min =  +3.14 V, max =  +3.47 V)
+5V:       +5.03 V  (min =  +4.76 V, max =  +5.24 V)
+12V:     +12.22 V  (min = +10.82 V, max = +13.19 V)
-12V:     -11.70 V  (min = -13.18 V, max = -10.80 V)
-5V:       -1.93 V  (min =  -5.25 V, max =  -4.75 V)
V5SB:      +5.32 V  (min =  +4.76 V, max =  +5.24 V)       ALARM
VBat:      +2.59 V  (min =  +2.40 V, max =  +3.60 V)
fan1:        0 RPM  (min = 2657 RPM, div = 2)
fan2:        0 RPM  (min = 2657 RPM, div = 2)
fan3:        0 RPM  (min = 2657 RPM, div = 2)
temp1:       +39 C  (high =  +120 C, hyst =  +115 C)   sensor = thermistor

temp2:     +43.0 C  (high =   +80 C, hyst =   +75 C)   sensor = thermistor

temp3:     +37.0 C  (high =   +80 C, hyst =   +75 C)   sensor = thermistor

ERROR: Can't get VID data!
alarms:
beep_enable:
          Sound alarm disabled
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39586600"></a><p class="title"><b>Figure 6.20. Output of the sensors section on the 150 / 250 / 550 models</b></p><div class="figure-contents"><pre class="screen">"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/cpu0_vid: "1500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/detach_state: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_input: "3624
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_min: "2500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_input: "3619
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_min: "2500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_input: "3673
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_min: "2500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_input: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_input: "5026
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_max: "6641
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_input: "1192
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_max: "2988
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_input: "3321
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_max: "4383
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_input: "5016
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_max: "6641
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_input: "12188
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_max: "15938
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_input: "3309
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_max: "4383
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_input: "3221
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_max: "4383
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/name: "dme1737
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1: "103
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_channels_zone: "7
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_point1_pwm: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_point2_pwm: "255
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_pwm_min: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_enable: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_freq: "25000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_ramp_rate: "206
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2: "102
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_channels_zone: "7
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_point1_pwm: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_point2_pwm: "255
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_pwm_min: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_enable: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_freq: "25000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_ramp_rate: "206
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3: "102
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_channels_zone: "7
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_point1_pwm: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_point2_pwm: "255
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_pwm_min: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_enable: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_freq: "25000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_ramp_rate: "206
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_fault: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_input: "59000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_max: "127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_min: "-127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_offset: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_fault: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_input: "39000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_max: "127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_min: "-127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_offset: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_fault: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_input: "41000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_max: "127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_min: "-127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_offset: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/vrm: "14
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_channels_temp: "1
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point1_temp: "55000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point1_temp_hyst: "51000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point2_temp: "75000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point3_temp: "80000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_channels_temp: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point1_temp: "42000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point1_temp_hyst: "38000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point2_temp: "52000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point3_temp: "62000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_channels_temp: "4
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point1_temp: "47000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point1_temp_hyst: "43000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point2_temp: "57000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point3_temp: "67000
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39587176"></a><p class="title"><b>Figure 6.21. Output of the sensors section on the 1050 / 2050 models</b></p><div class="figure-contents"><pre class="screen">bmc-i2c-1-00
Adapter: IPMI adapter
in1:       +1.11 V  (min =  +0.97 V, max =  +1.43 V)
in2:       +0.00 V  (min =  +0.97 V, max =  +1.43 V)
in3:       +1.14 V  (min =  +0.95 V, max =  +1.28 V)
in4:       +5.06 V  (min =  +4.63 V, max =  +5.33 V)
in5:       +1.47 V  (min =  +1.38 V, max =  +1.58 V)
in6:       +1.79 V  (min =  +1.66 V, max =  +1.90 V)
in7:      +11.81 V  (min = +11.14 V, max = +12.77 V)
in8:       +3.34 V  (min =  +3.06 V, max =  +3.52 V)
in9:       +4.87 V  (min =  +4.63 V, max =  +5.33 V)
fan1:     8760 RPM  (min = 1080 RPM)
fan2:     9360 RPM  (min = 1080 RPM)
fan3:     9480 RPM  (min = 1080 RPM)
fan4:        0 RPM  (min = 1080 RPM)
fan5:     9120 RPM  (min = 1080 RPM)
fan6:        0 RPM  (min = 1080 RPM)
fan7:     9120 RPM  (min = 1080 RPM)
fan8:        0 RPM  (min = 1080 RPM)
fan9:        0 RPM  (min = 1080 RPM)
fan10:       0 RPM  (min = 1080 RPM)
temp1:     +42.0 C  (high =   +95 C, hyst =   +10 C)
temp2:    +100.0 C  (high =   +95 C, hyst =   +10 C)
temp3:     +39.0 C  (high =   +55 C, hyst =  -123 C)
temp4:     +46.0 C  (high =   +55 C, hyst =  -123 C)
temp5:     +42.0 C  (high =   +57 C, hyst =  -123 C)
temp6:     +47.0 C  (high =   +57 C, hyst =  -123 C)
temp7:     +35.0 C  (high =   +57 C, hyst =  -123 C)
temp8:     +36.0 C  (high =   +57 C, hyst =  -123 C)
temp9:     +40.0 C  (high =   +57 C, hyst =  -123 C)
temp10:    +31.0 C  (high =   +57 C, hyst =  -123 C)
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39587752"></a><p class="title"><b>Figure 6.22. Output of the sensors section on the 5050 / 6050 / 7050 models</b></p><div class="figure-contents"><pre class="screen">bmc-i2c-4-00
Adapter: IPMI adapter
in1:       +1.10 V  (min =  +0.91 V, max =  +1.50 V)
in2:       +0.00 V  (min =  +0.91 V, max =  +1.50 V)
in3:       +1.18 V  (min =  +0.95 V, max =  +1.28 V)
in4:       +1.81 V  (min =  +1.66 V, max =  +1.90 V)
in5:       +0.00 V  (min =  +1.66 V, max =  +1.90 V)
in6:       +1.24 V  (min =  +1.09 V, max =  +1.29 V)
in7:       +1.40 V  (min =  +1.25 V, max =  +1.48 V)
in8:       +1.51 V  (min =  +1.35 V, max =  +1.59 V)
in9:       +3.36 V  (min =  +3.06 V, max =  +3.52 V)
in10:      +4.92 V  (min =  +4.63 V, max =  +5.33 V)
fan1:     3000 RPM  (min = 1080 RPM)
fan2:     3240 RPM  (min = 1080 RPM)
fan3:     3120 RPM  (min = 1080 RPM)
fan4:     4920 RPM  (min = 1080 RPM)
fan5:     3000 RPM  (min = 1080 RPM)
fan6:     3000 RPM  (min = 1080 RPM)
fan7:     7800 RPM  (min =  540 RPM)
fan8:     6360 RPM  (min =  540 RPM)
fan9:     7560 RPM  (min =  540 RPM)
fan10:    6000 RPM  (min =  540 RPM)
temp1:     +50.0 C  (high =   +85 C, hyst =  -123 C)
temp2:    -128.0 C  (high =   +85 C, hyst =  -123 C)
temp3:     +40.0 C  (high =   +85 C, hyst =  -123 C)
temp4:     +39.0 C  (high =   +85 C, hyst =  -123 C)
temp5:     +36.0 C  (high =   +55 C, hyst =  -123 C)
temp6:     +38.0 C  (high =   +80 C, hyst =  -123 C)
temp7:     +37.0 C  (high =   +65 C, hyst =  -123 C)
temp8:     +36.0 C  (high =   +65 C, hyst =  -123 C)
temp9:     +33.0 C  (high =   +57 C, hyst =  -123 C)
temp10:    +33.0 C  (high =   +57 C, hyst =  -123 C)
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39588328"></a><p class="title"><b>Figure 6.23. Output of the sensors section on the 255 models</b></p><div class="figure-contents"><pre class="screen">coretemp-isa-0000
Adapter: ISA adapter
Core 0:      +43.0 C  (high = +86.0 C, crit = +100.0 C)  

nct7904-i2c-0-2d
Adapter: SMBus I801 adapter at f000
VSEN1:       +1.05 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN2:       +2.01 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN3:       +2.01 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN4:       +2.01 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN5:       +2.01 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN6:       +1.58 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN7:       +1.61 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN8:       +1.61 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN9:       +0.90 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN10:      +2.02 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN11:      +1.50 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN12:      +0.79 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN13:      +1.00 V  (min =  +0.00 V, max =  +4.09 V)   
VSEN14:      +0.99 V  (min =  +0.00 V, max =  +4.09 V)   
3VDD:        +3.31 V  (min =  +0.00 V, max = +12.28 V)   
VBAT:        +3.28 V  (min =  +0.00 V, max = +12.28 V)   
3VSB:        +3.32 V  (min =  +0.00 V, max = +12.28 V)   
FAN1:       5192 RPM  (min =  164 RPM)
FAN2:          0 RPM  (min =  164 RPM)
FAN3:       5294 RPM  (min =  164 RPM)
FAN4:          0 RPM  (min =  164 RPM)
FAN5:          0 RPM  (min =  164 RPM)
FAN6:          0 RPM  (min =  164 RPM)
FAN7:          0 RPM  (min =  164 RPM)
FAN8:          0 RPM  (min =  164 RPM)
FAN9:          0 RPM  (min =  164 RPM)
FAN10:         0 RPM  (min =  164 RPM)
LTD:         +35.9 C  (high = +100.0 C, hyst = +95.0 C)  sensor = thermistor
DTS1:        +42.0 C  (high = +100.0 C, hyst = +95.0 C)  sensor = Intel PECI
DTS2:         +0.0 C  (high = +100.0 C, hyst = +95.0 C)  sensor = Intel PECI
DTS3:         +0.0 C  (high = +100.0 C, hyst = +95.0 C)  sensor = Intel PECI
DTS4:         +0.0 C  (high = +100.0 C, hyst = +95.0 C)  sensor = Intel PECI
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39588904"></a><p class="title"><b>Figure 6.24. Output of the sensors section on the 555 / 755 models</b></p><div class="figure-contents"><pre class="screen">"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/cpu0_vid: "1500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/detach_state: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_input: "3624
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_min: "2500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan1_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_input: "3619
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_min: "2500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan2_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_input: "3673
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_min: "2500
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan3_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_input: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/fan4_type: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_input: "5026
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_max: "6641
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in0_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_input: "1192
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_max: "2988
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in1_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_input: "3321
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_max: "4383
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in2_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_input: "5016
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_max: "6641
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in3_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_input: "12188
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_max: "15938
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in4_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_input: "3309
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_max: "4383
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in5_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_input: "3221
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_max: "4383
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/in6_min: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/name: "dme1737
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1: "103
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_channels_zone: "7
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_point1_pwm: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_point2_pwm: "255
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_auto_pwm_min: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_enable: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_freq: "25000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm1_ramp_rate: "206
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2: "102
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_channels_zone: "7
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_point1_pwm: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_point2_pwm: "255
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_auto_pwm_min: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_enable: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_freq: "25000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm2_ramp_rate: "206
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3: "102
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_channels_zone: "7
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_point1_pwm: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_point2_pwm: "255
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_auto_pwm_min: "100
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_enable: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_freq: "25000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/pwm3_ramp_rate: "206
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_fault: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_input: "59000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_max: "127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_min: "-127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp1_offset: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_fault: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_input: "39000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_max: "127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_min: "-127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp2_offset: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_alarm: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_fault: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_input: "41000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_max: "127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_min: "-127000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/temp3_offset: "0
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/vrm: "14
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_channels_temp: "1
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point1_temp: "55000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point1_temp_hyst: "51000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point2_temp: "75000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone1_auto_point3_temp: "80000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_channels_temp: "2
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point1_temp: "42000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point1_temp_hyst: "38000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point2_temp: "52000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone2_auto_point3_temp: "62000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_channels_temp: "4
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point1_temp: "47000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point1_temp_hyst: "43000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point2_temp: "57000
"/sys/devices/pci0000:00/0000:00:1f.3/i2c-0/0-002e/zone3_auto_point3_temp: "67000
</pre></div></div><br class="figure-break"><p>For the CX5055 and CX7055 models, the output of the sensors is not
available in the system dump yet up to RiOS version 8.5.
</p><div class="figure"><a name="idp39589608"></a><p class="title"><b>Figure 6.25. Output of the sensors section on the EX560 / EX760 models</b></p><div class="figure-contents"><pre class="screen">bmc-i2c-1-00
Adapter: IPMI adapter
fan1:     4320 RPM  (min = 1800 RPM)                  
fan2:     4200 RPM  (min = 1800 RPM)                  
fan3:     3000 RPM  (min = 1800 RPM)                  
temp1:     -15.0 C  (high =  +127 C, hyst =  -127 C)   
temp2:     +22.0 C  (high =   +47 C, hyst =  -127 C)   
temp3:     +24.0 C  (high =   +95 C, hyst =  -127 C)   
temp4:     +31.0 C  (high =    +0 C, hyst =  -127 C)   
</pre></div></div><br class="figure-break"><p>For the EX1160, EX1260 and EX1360 models, the output of the sensors is not
available in the system dump yet up to RiOS version 8.5.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39590312"></a>6.5.3. The PCI bus</h3></div></div></div><p>The PCI bus shows the cards attached to the PCI bus, for example
the various Ethernet NICs.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39590632"></a>6.5.4. Hard disks</h3></div></div></div><p>The hard disks are identified by mapping, hardware identification,
RAID status, LED status and solid-state disk wear status.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39590952"></a>6.5.4.1. Disks mapped to the chassis location</h4></div></div></div><p>The chassis of a Steelhead appliance has several slots for the hard
disks, which can be used fully or partly.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The 1RU chassis of the 1050 and 2050 models can contain four hard
  disks, but for the 1050L and 1050M model there will be only one
  slot occupied and for the 1050H model there will only be two slots
  occupied. The 1050LR, 1050MR, 1050HR and 250 models have four disks.
</p></li><li class="listitem"><p>The chassis for the 5050 and 6050 models can contain 16 hard
  disks, but for the 5050L and 5050M models only eight hard disks
  are used while for the 5050H model only 12 hard disks are used.
</p></li></ul></div><div class="figure"><a name="idp39591720"></a><p class="title"><b>Figure 6.26. Hard disk to chassis mapping for a 1050L and 1050M model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

0:0:0:0 disk0 sda online
1:0:0:0 disk1 missing missing
2:0:0:0 disk2 missing missing
3:0:0:0 disk3 missing missing
6:0:0:0 flash0 sha online
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39592296"></a><p class="title"><b>Figure 6.27. Hard disk to chassis mapping for a 1050H model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

0:0:0:0 disk0 sda online
1:0:0:0 disk1 sdb online
2:0:0:0 disk2 missing missing
3:0:0:0 disk3 missing missing
6:0:0:0 flash0 sha online
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39662504"></a><p class="title"><b>Figure 6.28. Hard disk to chassis mapping for a 2050 model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

0:0:0:0 disk0 sda online
1:0:0:0 disk1 sdb online
2:0:0:0 disk2 sdc online
3:0:0:0 disk3 sdd online
6:0:0:0 flash0 sde online
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39663016"></a><p class="title"><b>Figure 6.29. Hard disk to chassis mapping for a 5050L and 5050M model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

1:0:0:0 flash0 sha online
0:0:42:0 disk0 sde online
0:0:43:0 disk1 sdf online
0:0:44:0 disk2 sdg online
0:0:36:0 disk3 sdb online
0:0:41:0 disk4 sdd online
0:0:38:0 disk5 sdc online
0:0:45:0 disk6 sdh online
0:0:35:0 disk7 sda online
unknown disk8 missing missing
unknown disk9 missing missing
unknown disk10 missing missing
unknown disk11 missing missing
unknown disk12 missing missing
unknown disk13 missing missing
unknown disk14 missing missing
unknown disk15 missing missing
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39663592"></a><p class="title"><b>Figure 6.30. Hard disk to chassis mapping for a 5050H model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

0:0:18:0 disk0 sda online
0:0:19:0 disk1 sdb online
0:0:20:0 disk2 sdc online
0:0:21:0 disk3 sdd online
0:0:22:0 disk4 sde online
0:0:23:0 disk5 sdf online
0:0:24:0 disk6 sdg online
0:0:25:0 disk7 sdh online
0:0:26:0 disk8 sdi online
0:0:27:0 disk9 sdj online
0:0:28:0 disk10 sdk online
0:0:29:0 disk11 sdl online
unknown disk12 missing missing
unknown disk13 missing missing
unknown disk14 missing missing
unknown disk15 missing missing
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39664104"></a><p class="title"><b>Figure 6.31. Hard disk to chassis mapping for a 6050 model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

1:0:0:0 flash0 sha online
0:0:18:0 disk0 sda online
0:0:19:0 disk1 sdb online
0:0:20:0 disk2 sdc online
0:0:21:0 disk3 sdd online
0:0:22:0 disk4 sde online
0:0:23:0 disk5 sdf online
0:0:31:0 disk6 sdn online
0:0:24:0 disk7 sdg online
0:0:25:0 disk8 sdh online
0:0:26:0 disk9 sdi online
0:0:27:0 disk10 sdj online
0:0:28:0 disk11 sdk online
0:0:29:0 disk12 sdl online
0:0:30:0 disk13 sdm online
0:0:32:0 disk14 sdo online
0:0:33:0 disk15 sdp online
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39664616"></a><p class="title"><b>Figure 6.32. Hard disk to chassis mapping for a 7050L model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

1:0:0:0 flash0 sha online
0:0:49:0 disk0 sdc online
0:0:61:0 disk1 sdg online
0:0:75:0 disk2 sdo online
0:0:74:0 disk3 sdn online
0:0:72:0 disk4 sdl online
0:0:51:0 disk5 sdd online
0:0:46:0 disk6 sda online
0:0:76:0 disk7 sdp online
0:0:73:0 disk8 sdm online
0:0:70:0 disk9 sdj online
0:0:52:0 disk10 sde online
0:0:47:0 disk11 sdb online
0:0:77:0 disk12 sdq online
0:0:71:0 disk13 sdk online
0:0:68:0 disk14 sdi online
0:0:54:0 disk15 sdf online
unknown disk16 missing missing
unknown disk17 missing missing
unknown disk18 missing missing
unknown disk19 missing missing
unknown disk20 missing missing
unknown disk21 missing missing
unknown disk22 missing missing
unknown disk23 missing missing
unknown disk24 missing missing
unknown disk25 missing missing
unknown disk26 missing missing
unknown disk27 missing missing
unknown disk28 missing missing
unknown disk29 missing missing
unknown disk30 missing missing
0:0:62:0 disk31 sdh online
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39665128"></a><p class="title"><b>Figure 6.33. Hard disk to chassis mapping for a 7050M model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

0:0:49:0 disk0 sdd online
0:0:61:0 disk1 sdo online
0:0:75:0 disk2 sdac online
0:0:74:0 disk3 sdab online
0:0:72:0 disk4 sdz online
0:0:51:0 disk5 sdf online
0:0:46:0 disk6 sda online
0:0:76:0 disk7 sdad online
0:0:73:0 disk8 sdaa online
0:0:70:0 disk9 sdx online
0:0:52:0 disk10 sdg online
0:0:47:0 disk11 sdb online
0:0:77:0 disk12 sdae online
0:0:71:0 disk13 sdy online
0:0:68:0 disk14 sdv online
0:0:54:0 disk15 sdi online
0:0:48:0 disk16 sdc online
0:0:60:0 disk17 sdn online
0:0:69:0 disk18 sdw online
0:0:65:0 disk19 sds online
0:0:55:0 disk20 sdj online
0:0:50:0 disk21 sde online
0:0:59:0 disk22 sdm online
0:0:67:0 disk23 sdu online
0:0:64:0 disk24 sdr online
0:0:56:0 disk25 sdk online
0:0:53:0 disk26 sdh online
0:0:58:0 disk27 sdl online
0:0:66:0 disk28 sdt online
0:0:63:0 disk29 sdq online
unknown disk30 missing missing
0:0:62:0 disk31 sdp online
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39665640"></a><p class="title"><b>Figure 6.34. Hard disk to chassis mapping for a 1555L, 1555M and 1555H model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

0:0:0:0 disk0 sda online
1:0:0:0 disk1 sdb online
2:0:0:0 disk2 sdc online
3:0:0:0 disk3 sdd online
6:0:0:0 flash0 sha online
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39666216"></a><p class="title"><b>Figure 6.35. Hard disk to chassis mapping for a 5055M and 5055H model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

6:0:0:0 flash0 sda online
0:0:0:0 disk0 sdb online
0:0:1:0 disk1 sdc online
0:0:2:0 disk2 sdd online
0:0:3:0 disk3 sde online
0:0:4:0 disk4 sdf online
0:0:5:0 disk5 sdg online
0:0:6:0 disk6 sdh online
0:0:7:0 disk7 sdi online
0:0:8:0 disk8 sdj online
0:0:9:0 disk9 sdk online
unknown disk10 missing missing
unknown disk11 missing missing
unknown disk12 missing missing
unknown disk13 missing missing
unknown disk14 missing missing
unknown disk15 missing missing
unknown disk16 missing missing
unknown disk17 missing missing
unknown disk18 missing missing
unknown disk19 missing missing
unknown disk20 missing missing
unknown disk21 missing missing
unknown disk22 missing missing
unknown disk23 missing missing
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39658664"></a><p class="title"><b>Figure 6.36. Hard disk to chassis mapping for a 7055L model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

6:0:0:0 flash0 sdm online
0:0:0:0 disk0 sda online
0:0:1:0 disk1 sdb online
0:0:2:0 disk2 sdc online
0:0:3:0 disk3 sdd online
0:0:4:0 disk4 sde online
0:0:5:0 disk5 sdf online
0:0:6:0 disk6 sdg online
0:0:7:0 disk7 sdh online
0:0:8:0 disk8 sdi online
0:0:9:0 disk9 sdj online
0:0:10:0 disk10 sdk online
0:0:11:0 disk11 sdl online
unknown disk12 missing missing
unknown disk13 missing missing
unknown disk14 missing missing
unknown disk15 missing missing
unknown disk16 missing missing
unknown disk17 missing missing
unknown disk18 missing missing
unknown disk19 missing missing
unknown disk20 missing missing
unknown disk21 missing missing
unknown disk22 missing missing
unknown disk23 missing missing
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39659176"></a><p class="title"><b>Figure 6.37. Hard disk to chassis mapping for a 7055M model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

6:0:0:0 flash0 sda online
0:0:0:0 disk0 sdb online
0:0:1:0 disk1 sdc online
0:0:2:0 disk2 sdd online
0:0:3:0 disk3 sde online
0:0:4:0 disk4 sdf online
0:0:5:0 disk5 sdg online
0:0:6:0 disk6 sdh online
0:0:7:0 disk7 sdi online
0:0:8:0 disk8 sdj online
0:0:9:0 disk9 sdk online
0:0:10:0 disk10 sdl online
0:0:11:0 disk11 sdm online
0:0:15:0 disk12 sdq online
0:0:16:0 disk13 sdr online
0:0:12:0 disk14 sdn online
0:0:13:0 disk15 sdo online
0:0:14:0 disk16 sdp online
unknown disk17 missing missing
unknown disk18 missing missing
unknown disk19 missing missing
unknown disk20 missing missing
unknown disk21 missing missing
unknown disk22 missing missing
unknown disk23 missing missing
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39659688"></a><p class="title"><b>Figure 6.38. Hard disk to chassis mapping for a 7055H model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':

6:0:0:0 flash0 sda online
0:0:0:0 disk0 sdb online
0:0:1:0 disk1 sdc online
0:0:2:0 disk2 sdd online
0:0:3:0 disk3 sde online
0:0:4:0 disk4 sdf online
0:0:5:0 disk5 sdg online
0:0:6:0 disk6 sdh online
0:0:7:0 disk7 sdi online
0:0:8:0 disk8 sdj online
0:0:9:0 disk9 sdk online
0:0:10:0 disk10 sdl online
0:0:11:0 disk11 sdm online
0:0:16:0 disk12 sdr online
0:0:17:0 disk13 sds online
0:0:12:0 disk14 sdn online
0:0:13:0 disk15 sdo online
0:0:14:0 disk16 sdp online
0:0:15:0 disk17 sdq online
unknown disk18 missing missing
unknown disk19 missing missing
unknown disk20 missing missing
unknown disk21 missing missing
unknown disk22 missing missing
unknown disk23 missing missing
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39660200"></a><p class="title"><b>Figure 6.39. Hard disk to chassis mapping for a DX8000 model</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of '/opt/hal/bin/hwtool.py -q disk=map':
6:0:0:0 flash0 sdc online
0:0:0:0 disk0 sda online
0:0:1:0 disk1 sdb online
unknown disk2 missing missing
unknown disk3 missing missing
unknown disk4 missing missing
unknown disk5 missing missing
unknown disk6 missing missing
unknown disk7 missing missing
unknown disk8 missing missing
unknown disk9 missing missing
unknown disk10 missing missing
unknown disk11 missing missing
unknown disk12 missing missing
unknown disk13 missing missing
unknown disk14 missing missing
unknown disk15 missing missing
unknown disk16 missing missing
unknown disk17 missing missing
unknown disk18 missing missing
unknown disk19 missing missing
unknown disk20 missing missing
unknown disk21 missing missing
unknown disk22 missing missing
unknown disk23 missing missing
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39660712"></a>6.5.4.2. Disk information</h4></div></div></div><p>Every disk will have their model type displayed:
</p><div class="figure"><a name="idp39661096"></a><p class="title"><b>Figure 6.40. Various hard disk fields on a 2050 model</b></p><div class="figure-contents"><pre class="screen">Output of '/opt/hal/bin/raid/rrdm_tool.py -d /disk':

Num Drives : 4
0       WDC WD2500YD-01N        490234752       mgmt    online
1       WDC WD2500YD-01N        490234752       mgmt    online
2       WDC WD2500YD-01N        490234752       mgmt    online
3       WDC WD2502ABYS-0        490350672       mgmt    online
</pre></div></div><br class="figure-break"><p>And the front LED status:
</p><div class="figure"><a name="idp39661672"></a><p class="title"><b>Figure 6.41. Front LED status fields for a 2050 model</b></p><div class="figure-contents"><pre class="screen">Output of '/opt/hal/bin/raid/rrdm_tool.py --get-led-status':

Disk 0 Fault LED is off
Disk 1 Fault LED is off
Disk 2 Fault LED is off
Disk 3 Fault LED is off
</pre></div></div><br class="figure-break"><p>And the various fields of the physical disks:
</p><div class="figure"><a name="idp39699176"></a><p class="title"><b>Figure 6.42. Physical characteristics of the disks in a 2050 model</b></p><div class="figure-contents"><pre class="screen">Output of '/opt/hal/bin/raid/rrdm_tool.py --get-physical':

        ----------------------------------------
        Physical Drive 0
        ----------------------------------------
        Status: online          Type: disk
        Product: WDC WD2500YD-01N               Capacity: 233 GB
        Serial: WD-WCANKM053027         Firmware: 10.02E01
        Licensed: True

        ----------------------------------------
        Physical Drive 1
        ----------------------------------------
        Status: online          Type: disk
        Product: WDC WD2500YD-01N               Capacity: 233 GB
        Serial: WD-WCANKM083657         Firmware: 10.02E01
        Licensed: True

        ----------------------------------------
        Physical Drive 2
        ----------------------------------------
        Status: online          Type: disk
        Product: WDC WD2500YD-01N               Capacity: 233 GB
        Serial: WD-WCANKM029761         Firmware: 10.02E01
        Licensed: True

        ----------------------------------------
        Physical Drive 3
        ----------------------------------------
        Status: online          Type: disk
        Product: WDC WD2502ABYS-0               Capacity: 233 GB
        Serial: WD-WCAT11168840         Firmware: 02.03B02
        Licensed: True
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39699752"></a>6.5.5. RAID configuration</h3></div></div></div><p>The Steelhead appliances either use a single disk, a RAID0 configuration
or a RAID10 configuration.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39700072"></a>6.5.5.1. RAID0 configuration</h4></div></div></div><p>For the RAID0 configuration in the 1050H model, only the data store
and the /proxy partition are in a RAID0 configuration. The /var
partition is not in a RAID1 configuration, it is only stored on the
first hard disk:
</p><div class="figure"><a name="idp39700392"></a><p class="title"><b>Figure 6.43. RAID configuration for RAID0 on a 1050H model</b></p><div class="figure-contents"><pre class="screen">Output of 'cat /proc/mdstat':

Personalities : [linear] [raid0] [raid10] [raid6] [raid5] 
md1 : active linear sda6[0] sdb6[1]
      204812544 blocks 64k rounding

unused devices: &lt;none&gt;
</pre></div></div><br class="figure-break"><p>The /var partition is on /dev/sda3, the /proxy partition is on
/dev/md1.
</p><div class="figure"><a name="idp39700968"></a><p class="title"><b>Figure 6.44. Partition on a 1050H model</b></p><div class="figure-contents"><pre class="screen">Filesystem         1024-blocks      Used Available Capacity Mounted on
/dev/sda3             16513448   4893416  10781092      32% /var
/dev/md1             201598176     32936 191324616       1% /proxy
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39701416"></a>6.5.5.2. RAID10 configuration</h4></div></div></div><p>The capable 1050 models, the 2050, 5050, 6050 and CX1555 use RAID10
to provide redundancy. The 7050, CX5055, CX7055 and DX8000 models use
RAID1 for redundancy on their hard disks, not for the solid state disks.
</p><div class="figure"><a name="idp39701736"></a><p class="title"><b>Figure 6.45. RAID configuration for RAID10 on a 2050 model</b></p><div class="figure-contents"><pre class="screen">Output of 'cat /proc/mdstat':
Personalities : [linear] [raid0] [raid10] [raid6] [raid5] 
md3 : active raid10 sda6[0] sdd6[3] sdc6[2] sdb6[1]
      73930880 blocks 64K chunks 2 near-copies [4/4] [UUUU]
      
md0 : active raid10 sda5[0] sdd5[3] sdc5[2] sdb5[1]
      390636288 blocks 64K chunks 2 near-copies [4/4] [UUUU]
      
md2 : active raid10 sda2[0] sdd2[3] sdc2[2] sdb2[1]
      6297344 blocks 64K chunks 2 near-copies [4/4] [UUUU]
      
md1 : active raid10 sda3[0] sdd3[3] sdc3[2] sdb3[1]
      16787712 blocks 64K chunks 2 near-copies [4/4] [UUUU]
      
unused devices: &lt;none&gt;
</pre></div></div><br class="figure-break"><p>The
<span class="italics">/var</span>
partition is on /dev/md1
and the
<span class="italics">/proxy</span>
partition is on /dev/md3:
</p><div class="figure"><a name="idp39702824"></a><p class="title"><b>Figure 6.46. Partition on a 2050 model</b></p><div class="figure-contents"><pre class="screen">Filesystem         1024-blocks      Used Available Capacity Mounted on
/dev/md1              16523904    611780  15072740       4% /var
/dev/md3              72768928  25591492  43480892      38% /proxy
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39707432"></a>6.5.6. IPMI</h3></div></div></div><p>IPMI (Intelligent Platform Management Interface) is a standard
for monitoring system hardware, like power supplies, fans, temperatures,
watchdogs, voltage levels etc.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39707752"></a>6.5.6.1. IPMI SEL records</h4></div></div></div><p>In the
<span class="italics">hardwareinfo.txt</span>
file it keeps track of the events of various hardware pieces on the
xx50 series models:
</p><div class="figure"><a name="idp39708328"></a><p class="title"><b>Figure 6.47. Various IPMI event records</b></p><div class="figure-contents"><pre class="screen">SEL Record ID          : 0001
 Record Type           : 02
 Timestamp             : 02/02/2009 09:42:51
 Generator ID          : 0020
 EvM Revision          : 04
 Sensor Type           : Power Unit
 Sensor Number         : 84
 Event Type            : Generic Discrete
 Event Direction       : Assertion Event
 Event Data            : 01ffff
 Description           : Redundancy Lost

SEL Record ID          : 014b
 Record Type           : 02
 Timestamp             : 03/06/2009 14:43:10
 Generator ID          : 0020
 EvM Revision          : 04
 Sensor Type           : Temperature
 Sensor Number         : 7a
 Event Type            : Threshold
 Event Direction       : Assertion Event
 Event Data            : 593939
 Description           : Upper Critical going high

SEL Record ID          : 0157
 Record Type           : 02
 Timestamp             : 04/06/2011 15:56:55
 Generator ID          : 0020
 EvM Revision          : 04
 Sensor Type           : Watchdog 2
 Sensor Number         : 81
 Event Type            : Sensor-specific Discrete
 Event Direction       : Assertion Event
 Event Data            : c104ff
 Description           : Hard reset
</pre></div></div><br class="figure-break"><p>The first record is an alert that one of the power supplies in the
Steelhead appliance are disconnected or have failed. The second
record is a temperature alarm and the third one was that the hardware
watchdog has timed out and the machine has been reset.
</p><p>Note that the time on the SEL records do not always match the system
time. This issue is resolved in RiOS version 7.0 and higher.
</p><p>The following sensor types are known:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Power Supply or Power Unit: A power supply related event.
</p></li><li class="listitem"><p>FAN: A fan related event.
</p></li><li class="listitem"><p>Temperature: A temperature sensor related event.
</p></li><li class="listitem"><p>Watchdog 2: The hardware watchdog related event.
</p></li><li class="listitem"><p>NMI: The software interrupt related event.
</p></li><li class="listitem"><p>Event Logging Disabled: All SEL records have been erased. This
  is part of the manufacturing phase.
</p></li><li class="listitem"><p>Voltage CMOS Battery: The CMOS Battery is failing.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39710888"></a>6.5.6.2. IPMI SDR list</h4></div></div></div><p>IPMI also tracks the status of various sensors, which partly overlays
with some of the output of the sensors section:
</p><div class="figure"><a name="idp39711208"></a><p class="title"><b>Figure 6.48. Output of the command "ipmitool sdr list" on the 1050 / 2050 models</b></p><div class="figure-contents"><pre class="screen">Output of ipmitool sdr list: 
CPU0 Vcore       | 1.19 Volts        | ok
CPU1 Vcore       | disabled          | ns
FSB Vtt          | 1.13 Volts        | ok
5V               | 5.02 Volts        | ok
1.5V             | 1.47 Volts        | ok
Vdimm            | 1.81 Volts        | ok
12V              | 11.81 Volts       | ok
3.3Vsb           | 3.34 Volts        | ok
5Vsb             | 4.85 Volts        | ok
CPU0 Below Tmax  | 45 degrees C      | ok
CPU1 Below Tmax  | disabled          | ns
SB Temp          | 37 degrees C      | ok
MEM Temp         | 40 degrees C      | ok
FAN1             | 8760 RPM          | ok
FAN3             | 9360 RPM          | ok
FAN5             | 7440 RPM          | ok
FAN6             | 9960 RPM          | ok
FAN7             | 7320 RPM          | ok
FAN8             | 9840 RPM          | ok
FAN9             | 9120 RPM          | ok
FAN10            | 0 RPM             | ok
FAN2             | 0 RPM             | ok
FAN4             | 0 RPM             | ok
LAN Temp         | 39 degrees C      | ok
MCH Temp         | 38 degrees C      | ok
HDD BP Temp1     | 33 degrees C      | ok
HDD BP Temp2     | 29 degrees C      | ok
PSU Temp         | 36 degrees C      | ok
SYS Temp         | 29 degrees C      | ok
PS0 Temp         | 32 degrees C      | ok
PS1 Temp         | disabled          | ns
PS0 FAN1         | 8280 RPM          | ok
PS0 FAN2         | 6540 RPM          | ok
PS1 FAN1         | disabled          | ns
PS1 FAN2         | disabled          | ns
PS0              | 0x01              | ok
PS1              | Not Readable      | ns
PWR_UNIT_RDN     | 0x02              | ok
</pre></div></div><br class="figure-break"><p>If the PS FAN is 0 RPM while the PS Temp is non-zero, that means
that the power cable is removed from the power supply.
</p><div class="figure"><a name="idp39720104"></a><p class="title"><b>Figure 6.49. PS0 is connected, PS1 is not connected</b></p><div class="figure-contents"><pre class="screen">PS0 Temp         | 32 degrees C      | ok
PS1 Temp         | 38 degrees C      | ok
PS0 FAN1         | 8400 RPM          | ok
PS0 FAN2         | 6600 RPM          | ok
PS1 FAN1         | 0 RPM             | ok
PS1 FAN2         | 0 RPM             | ok
PS0              | 0x01              | ok
PS1              | 0x09              | ok
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39720552"></a>6.5.7. Riverbed approved hardware</h3></div></div></div><p>Riverbed appliances only work with Riverbed approved hardware, like
hard disks, memory and network cards. If unlicensed hardware is
detected the Steelhead appliance will raise an alarm about it.
</p><p>For example for a 2050L model, the licensing details will show up
in the system dump as:
</p><div class="figure"><a name="idp39721000"></a><p class="title"><b>Figure 6.50. Licensed hardware in a 2050L model</b></p><div class="figure-contents"><pre class="screen">Output of /opt/hal/bin/hwtool.py -q disk-license: 
disk0 Licensed
disk1 Licensed
disk2 Licensed
disk3 Licensed
flash0 Licensed

Output of /opt/hal/bin/hwtool.py -q nic-license: 
primary Licensed
aux Licensed
lan0_0 Licensed
lan0_1 Licensed
lan1_0 Licensed
lan1_1 Licensed
wan0_0 Licensed
wan0_1 Licensed
wan1_0 Licensed
wan1_1 Licensed

Output of /opt/hal/bin/hwtool.py -q memory: 
Total Licensed Memory: 8 GB
Total Unlicensed Memory: 0 GB
DIMM0: 2048 Licensed
DIMM1: 2048 Licensed
DIMM2: 2048 Licensed
DIMM3: 2048 Licensed
DIMM4: No Module Installed
DIMM5: No Module Installed
DIMM6: No Module Installed
DIMM7: No Module Installed
Number of DIMMs: 8

Output of /opt/hal/bin/hwtool.py -q cpu: 
Manufacturer: GenuineIntel
Number of cores: 4
Speed: 1995 MHz
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39721448"></a>6.5.8. The NICs and other PCI slots</h3></div></div></div><p>The list of installed NICs and other PCI cards can be found in the
<span class="italics">hwtool.py</span>
section:
</p><div class="figure"><a name="idp39722024"></a><p class="title"><b>Figure 6.51. The NICs and other PCI cards</b></p><div class="figure-contents"><pre class="screen">Output of '/opt/hal/bin/hwtool.py -q cli':

Hardware revision: 
Mainboard:  Platform 3UABA Motherboard, 400-00300-10
Slot 0: .......... 4 Port Copper GigE Network Bypass Module, Integrated
Slot 1: .......... 2 Port LR Fiber 10 GigE PCI-E Network Bypass and Redirect Card, 410-003 \
    01-01
Slot 2: .......... 2 Port LR Fiber 10 GigE PCI-E Network Bypass and Redirect Card, 410-003 \
    01-01
Slot 5: .......... SDR Accelerator Card, 410-00303
</pre></div></div><br class="figure-break"><p>There are several kinds of cards available:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Copper-based bypass cards. They can be integrated on the motherboard
  or via extra PCI cards:
</p><div class="figure"><a name="idp39722856"></a><p class="title"><b>Figure 6.52. Copper-based bypass cards</b></p><div class="figure-contents"><pre class="screen">2 Port Copper FastEthernet Network Bypass Module, Integrated
2 Port Copper GigE Network Bypass Card, CMP-00028
2 Port Copper GigE Network Bypass Module, Integrated
4 Port Copper GigE Network Bypass Module, Integrated
4 Port Copper GigE PCI-E 8 Lane, Low Profile, Network Bypass Card, 410-00103
4 Port Copper GigE PCI-E Ethernet Card, 410-GEOPS-02
4 Port Copper GigE PCI-E Network Bypass Card, 410-00044-01
4 Port Copper GigE PCI-E Network Bypass Card, 410-00047-01
4 Port Copper GigE PCI-X Network Bypass Card, CMP-00074
6 Port Copper GigE PCI-X Network Bypass Card, 150-00011
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>Fiber-based bypass cards. They can be LR, SR, SX or LX.
</p><div class="figure"><a name="idp39727784"></a><p class="title"><b>Figure 6.53. Fiber-based bypass cards</b></p><div class="figure-contents"><pre class="screen">2 Port Fiber (LR, SR) SFP+ 10 GigE PCI-E Server Adaptor Card, 410-00049-01
2 Port LR Fiber 10 GigE PCI-E gen-2 Network Bypass and Redirect Card, 410-00301-02
2 Port LR Fiber 10 GigE PCI-E Network Bypass and Redirect Card, 410-00301-01
2 Port LX Fiber GigE PCI-E Network Bypass Card, 410-00105
2 Port SR Fiber 10 GigE PCI-E gen-2 Network Bypass and Redirect Card, 410-00302-02
2 Port SR Fiber 10 GigE PCI-E Network Bypass and Redirect Card, 410-00302-01
2 Port SX Fiber GigE PCI-E Network Bypass Card, 410-00101
4 Port LX Fiber GigE PCI-E 8 Lane, Network Bypass Card, 410-00106
4 Port LX fiber GigE PCI-E Network Bypass Card, 410-00046-01
4 Port SX Fiber GigE PCI-E, half length, Network Bypass Card, 410-00102
4 Port SX fiber GigE PCI-E Network Bypass Card, 410-00045-01
4 Port SX Fiber GigE PCI-X Network Bypass Card, 150-00010
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>Virtual bypass cards.
</p><div class="figure"><a name="idp39728488"></a><p class="title"><b>Figure 6.54. Virtual bypass cards</b></p><div class="figure-contents"><pre class="screen">2 Port E1000 Pair Module, VM-E1000E
2 Port Virtual Inpath Pair Module, VM-X
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>RAID controllers, for the xx20 series Steelhead appliances.
</p><div class="figure"><a name="idp39729256"></a><p class="title"><b>Figure 6.55. RAID controllers</b></p><div class="figure-contents"><pre class="screen">LSI Logic / Symbios Logic MegaRAID SATA 300-8X RAID Controller, CMP-00127
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>Video cards
</p><div class="figure"><a name="idp39729960"></a><p class="title"><b>Figure 6.56. Video cards</b></p><div class="figure-contents"><pre class="screen">MSI VGA card, 410-00052-01
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>SDR Accelerator cards, for the offload of LZ compression into hardware.
</p><div class="figure"><a name="idp39730664"></a><p class="title"><b>Figure 6.57. SDR Accelerator cards</b></p><div class="figure-contents"><pre class="screen">SDR Accelerator Card 10X, 410-00055
SDR Accelerator Card, 410-00303
</pre></div></div><p><br class="figure-break">
</p></li></ul></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39731240"></a>6.6. System Information</h2></div></div></div><p>The file
<span class="italics">sysinfo.txt</span>
contains the system information of the Steelhead appliance. It
contains the operating system information, hard disk utilization,
ifconfig output, ECC counter details, system and in-path routing
tables, the output of the arp command, the process list, the directory
listing of /var/opt and /var/log, IP/TCP/UDP/ICMP networking
statistics and NIC interface statistics.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39731880"></a>6.6.1. Operating system and RiOS versions</h3></div></div></div><p>The first section contains the hostname, serial number of the device,
the RiOS version on the device, the original software version and
the date and time and uptime of the device:
</p><div class="figure"><a name="idp39732200"></a><p class="title"><b>Figure 6.58. System Information for a 550M model</b></p><div class="figure-contents"><pre class="screen">System information:

Hostname: CSH
Serial Number: J47NG00012345
Model Number: 550M
Version:  rbt_sh 6.5.2 #113_20 2011-10-04 15:39:37 i386 root@moscow:svn://svn/mgmt/branche \
    s/canary_113_fix_7_sedgman_branch
Manufactured version: 5.0.8
Date:     2011-12-16 17:42:23
Uptime:   70d 4h 4m 21s

Service Uptime [DD-HH:MM:SS]: 24-04:10:37
</pre></div></div><br class="figure-break"><p>This device is running the 64-bit version of RiOS version 6.5.2.
The i386 shows it is a 32-bit version, if it shows x86_64 then it
is the 64-bit version.
</p><p>The
<span class="italics">Uptime</span>
is the uptime of the Steelhead appliance, the
<span class="italics">Service Uptime</span>
is the uptime of the optimization service.
</p><p>The next section contains the build details of the
<span class="italics">sport</span>
binary of this RiOS version. For RiOS EX, this can be used to
determine the RiOS version used in this RiOS EX software:
</p><div class="figure"><a name="idp39733864"></a><p class="title"><b>Figure 6.59. System information for an EX1160L model</b></p><div class="figure-contents"><pre class="screen">System information:

Hostname: CSH
Serial Number: F84YU00012345
Model Number: EX1160L
Disk Layout: vsp_granite
Version:  rbt_ex 1.0.5 #556_10 2013-05-07 17:11:29 x86_64 root@montreux:svn://svn/build/br \
    anches/malta-ex_556_fix_branch
Manufactured version: 1.0.1a
Date:     2013-12-18 16:28:47
Uptime:   12d 17h 54m 5s

Service Uptime [DD-HH:MM:SS]: 12-17:49:31

==================================================
Output of '/opt/rbt/bin/sport -v':

Version: rbt_sh 7.0.6 (malta/fix/556_10)
Options: configure --disable-debug --enable-optimize --enable-epoll --enable-nfs --with-na \
    t=DEVNBT --enable-linker-map --with-tmslib=/work/prebuilt-modules/built-mgmt/branches/ \
    malta_556_fix_branch/125493/centos-4.2/x86_64/rbt_sh-7.0.6/tmslib --with-vmwaretools=/ \
    mnt/builds/prebuilt-modules/built-vmware-tools/branches/malta_556_fix_branch/4752/cent \
    os-4.2/x86_64 --with-sysincl=/work/prebuilt-modules/built-kernel/branches/malta_556_fi \
    x_branch/16634/2.6.9-34.EL/centos-4.2/x86_64//smp/smp
Builder: root@montreux (Linux CentOS release 4.8 (Final))
Kernel : 2.6.9-34.EL-rbt-16251SMP
Time   : Tue May  7 16:24:05 PDT 2013
Input  : /work/flamebox/sport-build-19763/sport
Output : /work/flamebox/sport-build-19763/sport/build
MD5    : b576d0f26bea7fe622721e3adb2c4a88
</pre></div></div><br class="figure-break"><p>After RiOS EX 3.0 the output of this command only shows the RiOS
EX software version, not the corresponding RiOS software version.
</p><p>The next table contains the full list of RiOS EX software and
matching RiOS version. An up-to-date list can be found in KB article
S20423.
</p><div class="table"><a name="idp39734568"></a><p class="title"><b>Table 6.1. RiOS EX software and matching RiOS version</b></p><div class="table-contents"><table summary="RiOS EX software and matching RiOS version" border="1"><colgroup><col><col></colgroup><tbody><tr><td>RiOS EX software</td><td>Corresponding RiOS version</td></tr><tr><td>1.0.1</td><td>7.0.2</td></tr><tr><td>1.0.2</td><td>7.0.3</td></tr><tr><td>1.0.4</td><td>7.0.5</td></tr><tr><td>1.0.5</td><td>7.0.6</td></tr><tr><td>2.0.0</td><td>8.0.0</td></tr><tr><td>2.0.1</td><td>8.0.1</td></tr><tr><td>2.0.2</td><td>8.0.1a</td></tr><tr><td>2.1.0</td><td>8.0.2</td></tr><tr><td>2.1.1</td><td>8.0.2</td></tr><tr><td>2.1.2</td><td>8.0.2</td></tr><tr><td>2.5.0</td><td>8.0.2d</td></tr><tr><td>2.5.1</td><td>8.0.2d</td></tr><tr><td>2.5.2</td><td>8.0.4</td></tr><tr><td>3.0.0</td><td>8.5.0</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39748008"></a>6.6.2. Hard disk utilization</h3></div></div></div><p>The hard disk utilization part shows the usage of the various
partitions on the Steelhead appliance. The only ones interesting
are the
<span class="italics">/var</span>
partition which stores the various log files and data
files, the
<span class="italics">/config </span>
partition which stores the systems configuration and the
<span class="italics">/proxy</span>
partition which contains PFS and RSP data.
</p><p>The data store partition is not visible here since its format is not
known by the
<span class="italics">df</span>
utility.
</p><div class="figure"><a name="idp39749608"></a><p class="title"><b>Figure 6.60. Hard disk utilization overview</b></p><div class="figure-contents"><pre class="screen">Output of 'df -Pka':

Filesystem         1024-blocks      Used Available Capacity Mounted on
rootfs                  516008    292116    197608      60% /
/proc                        0         0         0       -  /proc
none                   1815084       232   1814852       1% /dev
/dev/root               516008    292116    197608      60% /
none                   1815084       232   1814852       1% /dev
tmpfs                  1815084      7260   1807824       1% /lib/modules
/proc                        0         0         0       -  /proc
/proc/bus/usb                0         0         0       -  /proc/bus/usb
/sys                         0         0         0       -  /sys
none                         0         0         0       -  /dev/pts
/dev/sdb2               128716     11254    110816      10% /boot
/dev/sdb1               253611      4246    236271       2% /bootmgr
/dev/sdb7               418806     49904    347277      13% /config
/dev/sda3             16513448   2769100  12905408      18% /var
none                   1815084         0   1815084       0% /dev/shm
none                     16384         4     16380       1% /tmp
/dev/disk0p6          56765020  39510668  14370736      74% /proxy
encfs                   418806     49904    347277      13% /var/opt/rbt/decrypted
</pre></div></div><br class="figure-break"><p>The
<span class="italics">/boot</span>
mount point is sometimes on the second partition (
<span class="italics">/dev/sdb2</span>
on a 550 model) and sometimes on the third partition (
<span class="italics">/dev/sdb3</span>
on a 550 model), depending on which boot partition the Steelhead
appliance is booted from. This is located on the USB Flash disk.
</p><p>The
<span class="italics">/config</span>
mount point is the partition with the configuration of the Steelhead
appliance. It is located on the USB Flash disk.
</p><p>The
<span class="italics">/var</span>
mount point is the partition which is writable by the operating
system. It contains:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The log files are in
<span class="italics">/var/log</span>.
</p></li><li class="listitem"><p>RiOS images are uploaded to
<span class="italics">/var/opt/tms/images</span>.
</p></li><li class="listitem"><p>System dumps are created into
<span class="italics">/var/opt/tms/sysdumps</span>.
</p></li><li class="listitem"><p>Process dumps are created in
<span class="italics">/var/opt/tms/snapshots</span>.
</p></li><li class="listitem"><p>The Secure Vault is in
<span class="italics">/var/opt/rbt/decrypted</span>,
  which contains the SSL certificates and private keys and the
  encrypted data store password.  It is not a physical file system
  but an encrypted file system which lies on
<span class="italics">/var/opt/rbt/encrypted</span>.
</p></li></ul></div><p>
</p><p>The
<span class="italics">/proxy</span>
mount point is the partition which contains the Proxy File System
data (PFS) or the Riverbed Services Platform data (RSP).
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39759016"></a>6.6.3. Ifconfig output</h3></div></div></div><p>The ifconfig output shows some high level statistics of various
network interfaces. The most important fields are the administrative
status
<span class="italics">UP</span>,
the IP address
<span class="italics">inet addr</span>,
the hardware MAC address
<span class="italics">HWaddr</span>
and some general counters like
<span class="italics">RX packets</span>
and
<span class="italics">TX packets</span>.
</p><div class="figure"><a name="idp39760680"></a><p class="title"><b>Figure 6.61. Ifconfig output</b></p><div class="figure-contents"><pre class="screen">Output of 'ifconfig -a':

inpath0_0 Link encap:Ethernet  HWaddr 00:0E:B6:12:34:57  
          inet addr:10.0.1.6  Bcast:10.0.1.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:5703948 errors:0 dropped:0 overruns:0 frame:0
          TX packets:5649152 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:1403364965 (1.3 GiB)  TX bytes:1171662453 (1.0 GiB)

lan0_0    Link encap:Ethernet  HWaddr 00:0E:B6:12:34:57  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:4643691 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2781142 errors:2 dropped:0 overruns:0 carrier:2
          collisions:0 txqueuelen:100 
          RX bytes:1040279574 (992.0 MiB)  TX bytes:601245915 (573.3 MiB)
          Memory:fdce0000-fdd00000 

primary   Link encap:Ethernet  HWaddr 00:0E:B6:12:34:56  
          inet addr:10.0.1.5  Bcast:10.0.1.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:38967 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1874049 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:3564489 (3.3 MiB)  TX bytes:472288871 (450.4 MiB)
          Memory:fd9e0000-fda00000 

wan0_0    Link encap:Ethernet  HWaddr 00:0E:B6:12:34:58  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1060250 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2867967 errors:2 dropped:0 overruns:0 carrier:1
          collisions:0 txqueuelen:100 
          RX bytes:466055536 (444.4 MiB)  TX bytes:627854299 (598.7 MiB)
          Memory:fdc80000-fdca0000 
</pre></div></div><br class="figure-break"><p>The following information can be seen in this overview:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The virtual interface named
<span class="italics">inpath0_0</span>
  has the IP address 10.0.1.6, the physical lan0_0 and wan0_0
  interfaces do not have an IP address.
</p></li><li class="listitem"><p>The MAC address of the inpath0_0 interface is the MAC address of
  the lan0_0 interface.
</p></li><li class="listitem"><p>The MAC address of the lan0_0 interface is one lower than the MAC
  address of the wan0_0 interface.
</p></li><li class="listitem"><p>The administrative status of all interfaces is
<span class="italics">UP</span>.
  In virtual in-path deployment the administrative status of the
  lan0_0 does not contain the string
<span class="italics">UP</span>.
</p></li><li class="listitem"><p>The counters on the RX packets and TX packets are cumulative and
  should have zero errors. These counters can be zeroed out with
  the command
<code class="computeroutput">clear interfaces all</code>.
  In the example there have been two carrier errors on the lan0_0
  interface, which could be because of loss of the Ethernet link
  with the connected device.
</p></li><li class="listitem"><p>The interfaces named
<span class="italics">rios_wan0</span>
  and
<span class="italics">rios_wan0</span>
  are used by the RSP system.
</p></li><li class="listitem"><p>The interface named
<span class="italics">prihw</span>
  is the physical interface on which the primary interface is mapped.
</p></li><li class="listitem"><p>The interface named
<span class="italics">rbtpipe</span>
  is used by the Steelhead Cloud Accelerator functionality.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39765160"></a>6.6.4. Memory ECC counters</h3></div></div></div><p>The memory used in the Steelhead appliances has Error Correcting
Code capabilities, which means that if it finds a bit-error it will
try to correct it: It will be marked as a 
<span class="italics">Correctable Error</span>
if successful and as an
<span class="italics">Uncorrectable Error</span>
if unsuccessful.
</p><div class="figure"><a name="idp39765992"></a><p class="title"><b>Figure 6.62. ECC counter output</b></p><div class="figure-contents"><pre class="screen">Output of 'show_ecc_status':

/sys/devices/system/edac/mc/mc0/csrow0/ce_count:0
/sys/devices/system/edac/mc/mc0/csrow0/ch0_ce_count:0
/sys/devices/system/edac/mc/mc0/csrow0/ue_count:0
/sys/devices/system/edac/mc/mc0/csrow3/ce_count:0
/sys/devices/system/edac/mc/mc0/csrow3/ch0_ce_count:0
/sys/devices/system/edac/mc/mc0/csrow3/ue_count:0
/sys/devices/system/edac/mc/mc0/csrow0/ch0_dimm_label:DIMM0
/sys/devices/system/edac/mc/mc0/csrow3/ch0_dimm_label:DIMM0
/sys/devices/system/edac/mc/mc0/csrow0/size_mb:1024
/sys/devices/system/edac/mc/mc0/csrow3/size_mb:1024
</pre></div></div><br class="figure-break"><p>The output shows ce_count (the number of Correctable Errors),
ue_count (the number of Uncorrectable Errors), the name of the
memory stick (dimm_label) and the size of the memory stick (size_mb).
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39766568"></a>6.6.5. System and in-path routing tables</h3></div></div></div><p>The Steelhead appliance has multiple routing tables: One for the
primary and auxiliary interface and one for every in-path interface.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39766888"></a>6.6.5.1. The system routing tables</h4></div></div></div><p>The system routing table is used for management traffic send from
the Steelhead appliance.
</p><div class="figure"><a name="idp39767208"></a><p class="title"><b>Figure 6.63. System routing table output</b></p><div class="figure-contents"><pre class="screen">Output of 'route -n':

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.0.1.0        0.0.0.0         255.255.255.0   U     0      0        0 primary
0.0.0.0         10.0.1.9        0.0.0.0         UG    1      0        0 primary

Output of 'route -Cn':

Kernel IP routing cache
Source      Destination     Gateway         Flags Metric Ref    Use Iface
10.0.1.7    192.168.1.98    10.0.1.9        0      0        2 inpath0_0
10.0.1.7    192.168.1.52    10.0.1.9        0      0        2 inpath0_0
10.0.1.7    192.168.1.175   10.0.1.9        0      0        2 inpath0_0
10.0.1.7    192.168.1.39    10.0.1.9        0      0        2 inpath0_0
[..]
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39767656"></a>6.6.5.2. The in-path routing tables</h4></div></div></div><p>The in-path routing tables are the routing tables specifically for
the in-path interfaces. For simple networks where there is only one
IP subnet behind the Steelhead appliance, most of the time it will
only contain the default gateway. For Steelhead appliances which
use the simplified routing table it only needs to contain the default
gateway.
</p><div class="figure"><a name="idp39767976"></a><p class="title"><b>Figure 6.64. In-path routing table output</b></p><div class="figure-contents"><pre class="screen">Output of 'ip route show table proxytable0_0':

10.0.1.0/24 dev inpath0_0  scope link 
default via 10.0.r.9 dev inpath0_0 onlink 
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39768424"></a>6.6.6. The output of the arp command</h3></div></div></div><p>The output of the ARP table contains the IP addresses of the devices
on the IP subnets connected to both the primary and auxiliary interface
and the in-path interfaces:
</p><div class="figure"><a name="idp39654120"></a><p class="title"><b>Figure 6.65. ARP table overview</b></p><div class="figure-contents"><pre class="screen">Output of 'arp -na':

? (10.0.1.1) at 00:1B:0C:B0:34:38 [ether] on primary
? (10.0.1.9) at 00:0D:B9:17:28:DE [ether] on inpath0_0
? (10.0.1.1) at 00:1B:0C:B0:34:38 [ether] on inpath0_0
? (10.0.1.7) at &lt;incomplete&gt; on inpath0_0
</pre></div></div><br class="figure-break"><p>The only MAC address known on the primary interface is the MAC
address of the client with which we connect to the CLI of the
Steelhead appliance.  On the in-path interface there is the MAC
address of the default gateway and the MAC address of the clients
which have optimized TCP connections. The Steelhead appliance has
tried to find out the MAC address of the host with IP address
10.0.1.7 but didn't get answer on its ARP request.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39654696"></a>6.6.7. Output of netstat</h3></div></div></div><p>In RiOS version 8.0 and below, the netstat section shows the open
sockets on the Steelhead appliance and the state of the socket.
</p><div class="figure"><a name="idp39655016"></a><p class="title"><b>Figure 6.66. Output of the netstat command</b></p><div class="figure-contents"><pre class="screen">Output of 'netstat -a --numeric-hosts':

Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address    Foreign Address    State
tcp        0      0 10.0.1.6:7810    0.0.0.0:*          LISTEN
tcp        0      0 127.0.0.1:8005   0.0.0.0:*          LISTEN
tcp        0      0 0.0.0.0:904      0.0.0.0:*          LISTEN
tcp        0      0 0.0.0.0:8009     0.0.0.0:*          LISTEN
tcp        0      0 0.0.0.0:8333     0.0.0.0:*          LISTEN
tcp        0      0 127.0.0.1:7821   0.0.0.0:*          LISTEN
tcp        0      0 10.0.1.6:http    0.0.0.0:*          LISTEN
tcp        0      0 127.0.0.1:8307   0.0.0.0:*          LISTEN
tcp        0      0 0.0.0.0:8308     0.0.0.0:*          LISTEN
tcp        0      0 127.0.0.1:8086   0.0.0.0:*          LISTEN
tcp        0      0 10.0.1.6:ssh     0.0.0.0:*          LISTEN
tcp        0      0 10.0.1.6:7800    0.0.0.0:*          LISTEN
tcp        0      0 10.0.1.6:7801    0.0.0.0:*          LISTEN
tcp        0      0 10.0.1.6:https   0.0.0.0:*          LISTEN
tcp        0      0 0.0.0.0:8222     0.0.0.0:*          LISTEN
tcp        0      0 10.0.1.6:7801    192.168.1.6:19472  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:55588  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:55591  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:55596  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:58625  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:55597  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:55598  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:55599  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:39427  ESTABLISHED
tcp        0      0 10.0.1.6:7801    192.168.1.6:25651  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:62215  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:59687  ESTABLISHED
tcp        0      0 10.0.1.6:7800    192.168.1.6:57636  ESTABLISHED
tcp        0      0 127.0.0.1:33387  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33388  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33403  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33402  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33401  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33406  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33405  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33404  127.0.0.1:8086     CLOSE_WAIT
tcp        0      0 127.0.0.1:33392  127.0.0.1:8086     TIME_WAIT
tcp        0      0 127.0.0.1:33411  127.0.0.1:8086     FIN_WAIT2
</pre></div></div><br class="figure-break"><p>The states here are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="italics">LISTEN</span>,
  when the socket is opened by a process waiting for a new TCP
  session to be setup to it.
</p></li><li class="listitem"><p>
<span class="italics">ESTABLISHED</span>,
  when a TCP session has been setup towards the service.
</p></li><li class="listitem"><p>
<span class="italics">CLOSE_WAIT</span>,
  where the socket is still open on this computer despite having
  received a TCP FIN from the remote computer.
</p></li><li class="listitem"><p>
<span class="italics">TIME_WAIT</span>,
  when a TCP session has been torn down properly and is now
  lingering to catch any leftover packets.
</p></li><li class="listitem"><p>
<span class="italics">FIN_WAIT2</span>,
  when the socket has been closed but the remote computer has not
  send the FIN yet.
</p></li></ul></div><p>Normally the Recv-Q and Send-Q should be zero or close to zero. If
the values in there are non-zero then it might be an indication of
a slow client.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39772904"></a>6.6.8. Output of ss</h3></div></div></div><p>In RiOS version 8.5 and higher, the output of the tool
<span class="italics">ss</span>,
short for 
<span class="italics">socket statistics</span>,
is included in the file
<span class="italics">sysinfo.txt</span>
in favour of the
<span class="italics">netstat</span>
command.
</p><div class="figure"><a name="idp39774312"></a><p class="title"><b>Figure 6.67. Output of the command "ss"</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of 'ss -meanoiA inet,unix':

Netid  State      Recv-Q Send-Q     Local Address:Port       Peer Address:Port 
[...]
tcp    LISTEN     0      128      ::ffff:10.0.1.6:7801                 :::*      ino:56032 \
    08 sk:ffff8800703c01c0
         mem:(r0,w0,f0,t0) 
tcp    LISTEN     0      128                   :::443                  :::*      ino:32080 \
     sk:ffff8800635faa80
         mem:(r0,w0,f0,t0) 
[...]
tcp    ESTAB      0      0        ::ffff:10.0.1.6:7800    ::ffff:10.92.31.243:38880  timer \
    :(keepalive,4min58sec,0) ino:40312268 sk:ffff880065d8ca40
         mem:(r0,w0,f0,t0) ts sack reno wscale:8,2 rto:573 rtt:191/71.75 ato:40 cwnd:4 sen \
    d 242.6Kbps rcv_space:31856
</pre></div></div><br class="figure-break"><p>After the header, the first socket listens on a specific IP address
for connections on TCP port 7801, while the second socket listens
on all IP addresses on TCP port 443.
</p><p>The third socket shows an established connection with the following
features and characteristics:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="italics">ts</span>:
  TCP Time stamps are used.
</p></li><li class="listitem"><p>
<span class="italics">sack</span>:
  Selective ACKing can be used.
</p></li><li class="listitem"><p>
<span class="italics">ecn</span>:
  Explicit congestion notification is used.
</p></li><li class="listitem"><p>
<span class="italics">ecnseen</span>:
  At least one ECT packets was seen.
</p></li><li class="listitem"><p>
<span class="italics">fastopen</span>:
  The SYN packet contained data.
</p></li><li class="listitem"><p>
<span class="italics">reno</span>:
  TCP Reno will be used for network congestion diagnostics.
</p></li><li class="listitem"><p>
<span class="italics">wscale:8,2</span>:
  TCP Window scaling is used with a factor 8 on the outgoing packets
  and factor 2 on the incoming packets.
</p></li><li class="listitem"><p>
<span class="italics">ato:40</span>:
  ???
</p></li><li class="listitem"><p>
<span class="italics">mss:1434</span>:
  The maximum segment size is 1434 bytes.
</p></li><li class="listitem"><p>
<span class="italics">cwnd:4</span>:
  The congestion window is 4.
</p></li><li class="listitem"><p>
<span class="italics">ssthresh:?</span>:
  The slow-start threshold.
</p></li><li class="listitem"><p>
<span class="italics">send 242.6Kbps</span>:
  Calculated send-speed, based on sender congestion window, sender
  maximum segment size and round trip time.
</p></li><li class="listitem"><p>
<span class="italics">unacked:2920</span>:
  Number of bytes not yet acknowledged.
</p></li><li class="listitem"><p>
<span class="italics">retrans:1460</span>:
  Number of bytes retransmitted for this socket.
</p></li><li class="listitem"><p>
<span class="italics">lost:1460</span>:
  Number of bytes lost for this socket.
</p></li><li class="listitem"><p>
<span class="italics">sacked:4</span>:
  Number of frames retransmitted via SACK.
</p></li><li class="listitem"><p>
<span class="italics">fackets:12</span>:
  Number of frames retransmitted because of a fast ACK.
</p></li><li class="listitem"><p>
<span class="italics">reordering:123</span>:
  Number of frames which did not arrive in the right order.
</p></li><li class="listitem"><p>
<span class="italics">rcv_rtt:1.3</span>:
  The receiver round trip time ???
</p></li><li class="listitem"><p>
<span class="italics">rcv_space:31856</span>:
  The socket receive space, for incoming packets.
</p></li><li class="listitem"><p>
<span class="italics">rto:573</span>:
  The TCP Retransmission timeout is 573ms.
</p></li><li class="listitem"><p>
<span class="italics">rtt:191/71.75</span>:
  The round trip time ???
</p></li><li class="listitem"><p>
<span class="italics">cwnd:4</span>:
  The congestion window is 4.
</p></li><li class="listitem"><p>
<span class="italics">ssthresh:???</span>:
  The slow-start threshold.
</p></li><li class="listitem"><p>
<span class="italics">qack:???</span>:
  ???
</p></li><li class="listitem"><p>
<span class="italics">bidir:???</span>:
  ???
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39787240"></a>6.6.9. The process list</h3></div></div></div><p>There are two different process lists available in the system dump.
The first one is in the file 
<span class="italics">top_output.txt</span>,
which is a snapshot of the process list made by the "top" program.
The second one is the output of the "ps" program in the file
<span class="italics">sysinfo.txt</span>.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39788072"></a>6.6.9.1. Output of the top program</h4></div></div></div><p>Top is a Unix program which gives a continuous updated overview of
the CPU load, memory usage, process statistics and the processes.
</p><div class="figure"><a name="idp39788392"></a><p class="title"><b>Figure 6.68. Output of the top program</b></p><div class="figure-contents"><pre class="screen">top - 17:47:03 up  1:53,  0 users,  load average: 0.58, 0.54, 0.48
Tasks:  96 total,   4 running,  92 sleeping,   0 stopped,   0 zombie
Cpu(s):  7.6% us,  3.5% sy,  0.0% ni, 76.9% id, 11.1% wa,  0.1% hi,  0.9% si
Mem:   2054092k total,  2037524k used,    16568k free,     3172k buffers
Swap:  2097136k total,      248k used,  2096888k free,  1557400k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND            
 6693 admin     12  -3 1351m 1.3g 1.1g R   48 66.9   4:34.58 sport              
 6601 admin     15   0 70056  34m 2764 S    4  1.7   2:30.85 statsd             
 4466 admin     15   0  180m  36m 8940 S    1  1.8   0:53.26 mgmtd              
</pre></div></div><br class="figure-break"><p>The first part is split in five lines:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The system time, uptime, number of users and the 1, 5 and 15
  minute average load. The load average is the percentage of time
  when there are processes running or ready to run.
</p></li><li class="listitem"><p>The number of processes in total, the ones currently running, the
  ones waiting for data to run or for a timer to expire, the number
  of stopped processes and the number of zombie processes. The last
  two should be zero.
</p></li><li class="listitem"><p>The CPU overview shows the CPU utilization, averaged out from the
  number of cores in the system. There are seven states: User-land
  (non-kernel processes), system (kernel processes), niced user-land,
  idle, waiting for I/O, hardware interrupt handling and software
  interrupt handling.
</p></li><li class="listitem"><p>The real memory numbers: The total amount of memory, the amount
  used, the amount free and the amount used in various network and
  disk buffers.
</p></li><li class="listitem"><p>The swap memory numbers: The total amount of swap memory, the
  amount used, the amount free and the amount which is currently not
  used but can used for swap without having to reinitialize it.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39790056"></a>6.6.9.2. Output of ps</h4></div></div></div><p>This section shows the process list output as seen on Unix machines.
It contains the process ID, the parent process ID, the amount of
CPU it used, the memory utilization, the start time of the process
and the process name.
</p><div class="figure"><a name="idp39790376"></a><p class="title"><b>Figure 6.69. The process lists.</b></p><div class="figure-contents"><pre class="screen">Output of 'ps -Aww -o user,pid,ppid,pcpu,pri,nice,vsize,rss,majflt,tty,stat,wchan,start,bs \
    dtime,command':

USER       PID  PPID %CPU PRI  NI   VSZ  RSS MAJFLT TT       STAT WCHAN   STARTED   TIME C \
    OMMAND
admin        1     0  0.0  23   0  2016  608     14 ?        S    -        May 24   0:11 i \
    nit [3]                                                   
[...]
admin     5081     1  0.0  23   0  8724 5992      1 ?        Ss   -        May 24   0:04 / \
    opt/tms/bin/pm
admin     5082  5081  0.7  23   0 70124 63184     3 ?        Ss   -        May 24  64:57 / \
    opt/tms/bin/mgmtd
admin     7148  5081  0.0  23   0  6784 4320     21 ?        Ss   -        May 24   0:02 / \
    opt/tms/bin/snmpd -f -s -c /etc/snmpd.conf
admin     7149  5081  0.4  24   0 16728 9700      9 ?        Ss   -        May 24  38:39 / \
    opt/tms/bin/statsd
admin     7164  5081  0.0  23   0  6188 2780      5 ?        Ss   -        May 24   0:08 / \
    opt/tms/bin/cmcfc
admin     7177  5081  0.1  23   0  4972 2544      1 ?        Ss   -        May 24  11:19 / \
    opt/tms/bin/crld
admin     7186  5081  0.0  23   0  1540  600      1 ?        Ss   -        May 24   0:00 / \
    usr/sbin/crond -n
admin     7188  5081  0.0  23   0  5984 2936      9 ?        Ss   -        May 24   0:01 / \
    usr/sbin/httpd -D NO_DETACH -f /etc/opt/tms/output/httpd.conf
ntp       7193  5081  0.0  23   0  3760 1588      5 ?        Ss   -        May 24   0:01 / \
    usr/sbin/ntpd -n -u ntp -g
</pre></div></div><br class="figure-break"><p>In this output you will see the earlier described processes running
on the Steelhead appliance: pm, mgmtd, snmpd, statsd and so on.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39790952"></a>6.6.10. The list of currently logged in users</h3></div></div></div><p>This will show the users logged in and on which terminals they are
logged in via:
</p><div class="figure"><a name="idp39791272"></a><p class="title"><b>Figure 6.70. Output of the "who" command</b></p><div class="figure-contents"><pre class="screen">Output of 'who -a':

                        Sep 12 15:34               436 id=si    term=0 exit=0
           system boot  Sep 12 15:34
           run-level 3  Sep 12 15:34                   last=S
                        Sep 12 15:34              2797 id=l3    term=0 exit=0
LOGIN      tty1         Sep 12 15:34              8156 id=1
LOGIN      tty2         Sep 12 15:34              8157 id=2
LOGIN      ttyS0        Sep 14 15:49             24796 id=co
admin    + pts/0        Sep 14 15:46 00:02       16987 (57.200.1.39)
           pts/1        Sep 12 16:56             21448 id=ts/1  term=0 exit=0
LOGIN      ttyS0        Sep 14 13:06             22714 id=S0
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39791720"></a>6.6.11. The directory listing of /var/opt and /var/log</h3></div></div></div><p>From a user-land perspective, there is only one partition writable
on the Steelhead appliance and that is the
<span class="italics">/var</span>
partition. It is used for storing the log files, uploading new RiOS
images, statistics files, keeping state for processes and so on.
</p><div class="figure"><a name="idp39792296"></a><p class="title"><b>Figure 6.71. Contents of /var/log</b></p><div class="figure-contents"><pre class="screen">Output of 'find /var/log -type f -ls':

985101  496 -rw-r--r--   1 admin    root       503664 May 23 23:50 /var/log/sa/sa23
985014  496 -rw-r--r--   1 admin    root       503664 May 24 23:50 /var/log/sa/sa24
985027  496 -rw-r--r--   1 admin    root       503664 May 22 23:50 /var/log/sa/sa22
984975  496 -rw-r--r--   1 admin    root       503664 May 25 23:50 /var/log/sa/sa25
984998 373836 -rw-r--r--   1 admin    root     382423665 May 30 17:46 /var/log/messages
985073    8 -rw-r--r--   1 admin    root         7020 May 30 17:46 /var/log/user_messages
985077    4 -rw-------   1 admin    root         1508 May  3 15:20 /var/log/web_access_log \
    .4.gz
985031 1608 -rw-rw-rw-   1 admin    root      1638508 May 29 00:00 /var/log/sdr.stats.2.gz
985051  268 -rw-r--r--   1 admin    root       270153 May 28 00:00 /var/log/messages.3.gz
985094    4 -rw-------   1 admin    root          101 May 29 00:00 /var/log/web_error_log. \
    2.gz
984999   16 -rw-------   1 admin    root        12392 May 30 17:00 /var/log/oom_profile.lo \
    g.3.gz
985089    4 -rw-------   1 admin    root          100 May 28 00:00 /var/log/web_error_log. \
    3.gz
985064    4 -rw-r--r--   1 admin    root          389 May 29 00:00 /var/log/user_messages. \
    2.gz
985084    4 -rw-------   1 admin    root         2629 May  5 00:00 /var/log/web_access_log \
    .2.gz
[...]
</pre></div></div><br class="figure-break"><p>The files sa* contain the System Accounting Records, various log
files named messages.*, log files for the web server named web*.
</p><div class="figure"><a name="idp39792872"></a><p class="title"><b>Figure 6.72. Contents of /var/opt</b></p><div class="figure-contents"><pre class="screen">Output of 'find /var/opt ( -name .running -prune ) -o -type f -ls':

608197 104020 -rw-rw-rw-   1 admin    root     106404863 Jan 27  2010 /var/opt/tms/images/ \
    cmc.upgrade.tbz
607889 4336 -rw-------   1 admin    root      4426824 Apr 29  2009 /var/opt/tms/snapshots/ \
    CSH-webasd-20090409-090119.tar.gz
460290 5644 -rw-rw-rw-   1 admin    root      5764037 Apr  9  2009 /var/opt/tms/sysdumps/s \
    ysdump-CSH-20090409-085757.tgz
459922  528 -rw-rw-rw-   1 admin    root       532985 Apr  9  2009 /var/opt/tms/sysdumps/s \
    ysdump-CSH-20090409-090119.tgz
459990 27020 -rw-rw-rw-   1 admin    root     27634079 May 30 16:22 /var/opt/tms/sysdumps/ \
    sysdump-CSH-20110530-162201.tgz
</pre></div></div><br class="figure-break"><p>Here you can see a RiOS image uploaded by the CMC, a process dump
of the process
<span class="italics">webasd</span>
and three system dumps.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39793768"></a>6.6.12. IP/TCP/UDP/ICMP networking statistics</h3></div></div></div><p>This is the statistics output of the netstat command.
</p><div class="figure"><a name="idp39794152"></a><p class="title"><b>Figure 6.73. Output of the "netstat -s" command</b></p><div class="figure-contents"><pre class="screen">Output of '/bin/netstat -s':

Ip:
    3313608 total packets received
    0 forwarded
    0 incoming packets discarded
    3312203 incoming packets delivered
    5123477 requests sent out
Icmp:
    4786 ICMP messages received
    2 input ICMP message failed.
    ICMP input histogram:
        destination unreachable: 56
        echo requests: 4730
    4786 ICMP messages sent
    0 ICMP messages failed
    ICMP output histogram:
        destination unreachable: 56
        echo replies: 4730
Tcp:
    18875 active connections openings
    18098 passive connection openings
    4 failed connection attempts
    2118 connection resets received
    1506 connections established
    3301666 segments received
    3274784 segments send out
    2287 segments retransmited
    0 bad segments received.
    1536 resets sent
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39794664"></a>6.6.13. NIC interface settings and statistics.</h3></div></div></div><p>This section shows more details on the Ethernet cards than the
ifconfig output shows, for example the speeds the card is able to
negotiate to, if it used auto-negotiation or not and the current
negotiated speed.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39794984"></a>6.6.13.1. Auto-negotiation and link speed</h4></div></div></div><p>In this output, the NIC is configured for auto-negotiation. During
the negotiation, it has advertised 10 Mbps, 100 Mbps and 1000 Mbps
speeds and the negotiation came up with 1000 Mbps. Because of the
gigabit speed, it was also able to negotiate the Ethernet pause
feature, which will allow the NIC to alert the connected device to
stop sending new Ethernet frames.
</p><div class="figure"><a name="idp39795304"></a><p class="title"><b>Figure 6.74. Ethtool section for an auto-negotiated Ethernet link</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of 'ethtool wan0_0':

Settings for wan0_0:
        Supported ports: [ TP ]
        Supported link modes:   10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Supports auto-negotiation: Yes
        Advertised link modes:  10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Advertised auto-negotiation: Yes
        Speed: 1000Mb/s
        Duplex: Full
        MDI: mdi
        Port: Twisted Pair
        PHYAD: 1
        Transceiver: internal
        Auto-negotiation: on
        Supports Wake-on: d
        Wake-on: d
        Current message level: 0x00000001 (1)
        Link detected: yes

==================================================
</pre></div></div><br class="figure-break"><p>In this output, the auto-negotiation is not enabled but its speed
and duplex are set to 100 Mbps and Full Duplex:
</p><div class="figure"><a name="idp39796008"></a><p class="title"><b>Figure 6.75. Ethtool section for a fixed speed and duplex Ethernet link</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of 'ethtool lan0_0':

Settings for lan0_0:
        Supported ports: [ TP ]
        Supported link modes:   10baseT/Half 10baseT/Full 
                                100baseT/Half 100baseT/Full 
                                1000baseT/Full 
        Supports auto-negotiation: Yes
        Advertised link modes:  Not reported
        Advertised auto-negotiation: No
        Speed: 100Mb/s
        Duplex: Full
        MDI: mdi
        Port: Twisted Pair
        PHYAD: 1
        Transceiver: internal
        Auto-negotiation: off
        Supports Wake-on: d
        Wake-on: d
        Current message level: 0x00000007 (7)
        Link detected: yes

==================================================
</pre></div></div><br class="figure-break"><p>In this example, the NIC didn't manage to negotiate an Ethernet
link:
</p><div class="figure"><a name="idp39796712"></a><p class="title"><b>Figure 6.76. No Ethernet link negotiated</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of 'ethtool lan0_0':

Settings for lan0_0:
        Supported ports: [ TP ]
        Supported link modes:   10baseT/Half 10baseT/Full 
                                100baseT/Half 100baseT/Full 
                                1000baseT/Full 
        Supports auto-negotiation: Yes
        Advertised link modes:  Not reported
        Advertised auto-negotiation: No
        Speed: Unknown! (65535)
        Duplex: Unknown! (255)
        MDI: Unknown! (0)
        Port: Twisted Pair
        PHYAD: 1
        Transceiver: internal
        Auto-negotiation: off
        Supports Wake-on: d
        Wake-on: d
        Current message level: 0x00000007 (7)
        Link detected: no

==================================================
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39797224"></a>6.6.13.2. Ethernet flow control</h4></div></div></div><p>The Ethernet flow control allows a receiver of Ethernet frames to
indicate that the sender should pause sending temporary. It is
possible that the flow control is allowed only in one direction.
</p><div class="figure"><a name="idp39863144"></a><p class="title"><b>Figure 6.77. Ethernet flow control</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of 'ethtool -a lan0_0':

Pause parameters for lan0_0:
Autonegotiate:  on
RX:             on
TX:             on

==================================================
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39863592"></a>6.6.13.3. Offloading features</h4></div></div></div><p>Various offloading features like TCP checksum generation and TCP
segmentation offloading.
</p><div class="figure"><a name="idp39863912"></a><p class="title"><b>Figure 6.78. TCP segmentation offloading</b></p><div class="figure-contents"><pre class="screen">==================================================
Output of 'ethtool -a lan0_0':

Offload parameters for lan0_0:
rx-checksumming: on
tx-checksumming: on
scatter-gather: on
tcp-segmentation-offload: on
udp-fragmentation-offload: off
generic-segmentation-offload: on
generic-receive-offload: off
large-receive-offload: off
==================================================
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39864424"></a>6.7. Simplified Routing related files</h2></div></div></div><p>The Simplified Routing tables keeps track of an IP address and the
MAC address of the gateway via which the IP address is reachable.
These tables are independent per in-path interface.
</p><p>For RiOS version 6.0 and higher the files with the related information
are
<span class="italics">macmap_tables</span>
and
<span class="italics">er/*/pkttab_entries</span>.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39865384"></a>6.7.1. Mapping IP addresses to MAC addresses</h3></div></div></div><p>The
<span class="italics">macmap_tables</span>
file contains the mapping of IP address to MAC addresses:
</p><div class="figure"><a name="idp39866024"></a><p class="title"><b>Figure 6.79. The contents of the file macmap_tables</b></p><div class="figure-contents"><pre class="screen">    relay         ip_addr          mac_addr  vlan ref_count
inpath0_0        10.0.1.1 d4:9a:20:c2:52:0e     0        0
inpath0_0        10.0.1.9 00:0d:b9:17:28:de     0        0
inpath0_0      172.16.3.1 00:0d:b9:17:28:de     0        0
inpath0_0     192.168.1.6 00:0d:b9:17:28:de     0        0
inpath0_0     192.168.1.1 00:0d:b9:17:28:de     0        0
[...]
</pre></div></div><br class="figure-break"><p>This shows that on inpath0_0 the IP addresses in the 192.168.1.0/24
subnet can be found behind the device with the MAC address
00:0d:b9:17:28:de.
</p><p>This data can be seen from the CLI with the command
<code class="computeroutput">show in-path macmap-tables</code>.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39875304"></a>6.7.2. Mapping of MAC address to in-path interface LAN or WAN interfaces</h3></div></div></div><p>The pkttab_entries file contains the mapping of the MAC addresses
on the LAN or the WAN side of the in-path interface. The number in
the path is the sequence number of the in-path interface.
</p><div class="figure"><a name="idp39875624"></a><p class="title"><b>Figure 6.80. The contents of the file er/0/pkttab_entries</b></p><div class="figure-contents"><pre class="screen">ent/tot  ht[chain] p        addr           vlan   dev        type          hits  flaps p   \
     vlan_chg p   race
  1/  2    31[  0] 0  d4:9a:20:c2:52:0e       0   lan0_0    EAL_DEV_LAN    30    0     0   \
            0 0      0
  2/  2    31[  0] 0  00:26:88:1e:39:80       0   wan0_0    EAL_DEV_WAN    55    0     0   \
            0 0      0
</pre></div></div><br class="figure-break"><p>This data cannot be seen from the CLI.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39876328"></a>6.8. ATA controller SMART data</h2></div></div></div><p>The file
<span class="italics">smart.txt</span>
contains the SMART data (Self-Monitoring, Analysis and Reporting
Technology) of the ATA controller of the hard disks. This information
is available for all hard disks except for the xx20 series 3RU
models in which the hard disks are behind a hardware RAID controller.
</p><p>The following fields are interesting from a possible failure point
of view:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Current Pending Sector Count: Number of sectors the hard disk
  controller thinks are unstable but not yet reallocated.
</p></li><li class="listitem"><p>Offline Uncorrectable: Number of sectors which have been attempted
  to reallocated but which failed. The data in there is lost.
</p></li><li class="listitem"><p>Raw Read Error Rate: The checksum of the data read from the platter
  was incorrect and error correction was required to restore the
  data.
</p></li><li class="listitem"><p>Seek Error Rate: The number of seek related issues, when the arm
  of the servo does not properly position the head on the right
  track.
</p></li><li class="listitem"><p>Reallocated Sector Count: The number of sectors which have been
  reallocated to a different sector on the disk.
</p></li><li class="listitem"><p>Reallocated Event Count: Number of times a sector has to be
  reallocated to a different location on the drive.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39878312"></a>6.9. Asymmetric routing table</h2></div></div></div><p>Note: See the chapter
<a class="xref" href="#operation_asymmetricrouting" title="5.15. Asymmetric Routing">Asymmetric Routing</a> in the
<span class="italics">Operational Related Issues</span>
section for the full explanation of the asymmetric routing feature.
</p><p>The file
<span class="italics">asymrouting_table</span>
contains the current status of the asymmetric routing table:
</p><div class="figure"><a name="idp39879592"></a><p class="title"><b>Figure 6.81. Contents of the file "asymrouting_table"</b></p><div class="figure-contents"><pre class="screen">10.20.53.121 10.21.1.201 SYN-rexmit 0 1344925735 1344925735
10.20.53.121 10.21.1.220 SYN-rexmit 4 1344925739 1344925739
10.8.6.20 10.8.32.54 bad-RST 54125 1344893467 1344900082
10.8.6.20 10.4.89.95 bad-RST 82927 1344922268 1344922277
10.8.6.20 10.12.64.20 bad-RST 54124 1344893466 1344922283
10.4.199.87 10.20.53.121 invalid-SYNACK 86170 1344925510 1344925510
10.20.53.121 10.21.1.212 SYN-rexmit 2 1344925737 1344925737
10.8.6.20 10.8.44.104 bad-RST 54124 1344893467 1344900082
10.20.53.121 10.21.1.200 SYN-rexmit 0 1344925735 1344925735
</pre></div></div><br class="figure-break"><p>The format of the fields is:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>IP address client
</p></li><li class="listitem"><p>IP address server
</p></li><li class="listitem"><p>Asymmetric routing reason
</p></li><li class="listitem"><p>Timeout in seconds
</p></li><li class="listitem"><p>Date and time created, seconds since 1 January 1970
</p></li><li class="listitem"><p>Date and time last used, seconds since 1 January 1970
</p></li></ul></div><p>
</p><p>So for the line
<code class="computeroutput">10.8.6.20 10.4.89.95 bad-RST 82927 1344922268 1344922277</code>,
the timeout was most likely 86400 seconds (one day), the time it
was created was on 14 August 2012 at 05:31:08 and the last time a
new TCP session got passed-through was nine seconds later on 05:31:17.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39882152"></a>6.10. The Image History file</h2></div></div></div><p>The file
<code class="computeroutput">image_history</code>
contains the list of RiOS images which this Steelhead appliance has
been booted into.
</p><div class="figure"><a name="idp39882728"></a><p class="title"><b>Figure 6.82. Contents of the file "image_history"</b></p><div class="figure-contents"><pre class="screen">Firstboot to rbt_sh 5.5.9 #187_4 2010-10-14 18:48:05 x86_64 root@poznan:svn://svn/mgmt/bra \
    nches/guam_187_fix_branch on Thu Jun 30 21:51:32 GMT 2011
Upgraded to rbt_sh 6.1.3a #77_11 2011-03-13 20:11:47 x86_64 root@palermo0:svn://svn/mgmt/b \
    ranches/cook_77_fix_branch on Thu Jun 30 22:26:45 GMT 2011
Reverted to rbt_sh 5.5.9 #187_4 2010-10-14 18:48:05 x86_64 root@poznan:svn://svn/mgmt/bran \
    ches/guam_187_fix_branch on Tue Aug  2 12:42:39 GMT 2011
Reverted to rbt_sh 6.1.3a #77_11 2011-03-13 20:11:47 x86_64 root@palermo0:svn://svn/mgmt/b \
    ranches/cook_77_fix_branch on Thu Aug  4 17:38:40 GMT 2011
Upgraded to rbt_sh 6.5.1 #100_13 2011-05-24 14:19:19 x86_64 root@palermo0:svn://svn/mgmt/b \
    ranches/canary_100_fix_branch on Thu Aug  4 18:10:43 GMT 2011
</pre></div></div><br class="figure-break"><p>This Steelhead appliance had RiOS version 5.5.9 installed when it
came out of the box and got upgraded to RiOS version 6.1.3a half
an hour later. Later it got downgraded to RiOS version 5.5.9 and
then upgraded again to 6.1.3a and 6.5.1 at the same time.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39887592"></a>6.11. The file "lsof"</h2></div></div></div><p>The file
<code class="computeroutput">lsof.txt</code>
contains the output of the command
<code class="computeroutput">lsof</code>,
which is used to display the list of open file descriptors (files,
pipes, sockets).
</p><div class="figure"><a name="idp39888424"></a><p class="title"><b>Figure 6.83. Output of the file "lsof.txt"</b></p><div class="figure-contents"><pre class="screen">COMMAND     PID   USER   FD   TYPE   DEVICE     SIZE    NODE NAME
[...]
sshd       6198  admin  cwd    DIR     8,69     4096       2 /
sshd       6198  admin  rtd    DIR     8,69     4096       2 /
sshd       6198  admin  txt    REG     8,69   444313   33830 /usr/sbin/sshd
sshd       6198  admin  mem    REG     8,69   113224   39572 /lib64/ld-2.3.4.so
sshd       6198  admin  mem    REG     8,69    36144   39578 /lib64/libpam.so.0.77
sshd       6198  admin  mem    REG     8,69    17000   39624 /lib64/libdl-2.3.4.so
sshd       6198  admin  mem    REG     8,69  1565275    3019 /opt/rbt/lib/libcrypto.so.0.9 \
    .8
sshd       6198  admin  mem    REG     8,69    16280   39602 /lib64/libutil-2.3.4.so
sshd       6198  admin  mem    REG     8,69    77072   39560 /usr/lib64/libz.so.1.2.1.2
sshd       6198  admin  mem    REG     8,69   112176   39613 /lib64/libnsl-2.3.4.so
sshd       6198  admin  mem    REG     8,69    42672   39592 /lib64/libcrypt-2.3.4.so
sshd       6198  admin  mem    REG     8,69    90672   39579 /lib64/libresolv-2.3.4.so
sshd       6198  admin  mem    REG     8,69  1630336   39755 /lib64/tls/libc-2.3.4.so
sshd       6198  admin  mem    REG     8,69    63736   39586 /lib64/libaudit.so.0.0.0
sshd       6198  admin  mem    REG     8,69    58872   39582 /lib64/libnss_files-2.3.4.so
sshd       6198  admin  DEL    REG      0,6          2268647 /dev/zero
sshd       6198  admin  mem    REG     8,69    12888   39729 /lib64/security/pam_stack.so
sshd       6198  admin  mem    REG     8,69     8864   39721 /lib64/security/pam_nologin.s \
    o
sshd       6198  admin  mem    REG     8,69    20824   39706 /lib64/security/pam_limits.so
sshd       6198  admin  mem    REG     8,69    53104   39727 /lib64/security/pam_console.s \
    o
sshd       6198  admin  mem    REG     8,69   557176   39237 /usr/lib64/libglib-2.0.so.0.4 \
    00.7
sshd       6198  admin  mem    REG     8,69     4560   39731 /lib64/security/pam_deny.so
sshd       6198  admin  mem    REG     8,69    12624   39743 /lib64/security/pam_env.so
sshd       6198  admin  mem    REG     8,69    57662    2764 /opt/tms/lib/security/pam_rad \
    ius_auth.so
sshd       6198  admin  mem    REG     8,69   145059    2766 /opt/tms/lib/security/pam_uni \
    x.so
sshd       6198  admin  mem    REG     8,69    10692    2767 /opt/tms/lib/security/pam_fai \
    ldelay.so
sshd       6198  admin  mem    REG     8,69    24632   39609 /lib64/libnss_dns-2.3.4.so
sshd       6198  admin  DEL    REG      0,6          2269964 /dev/zero
sshd       6198  admin    0u   CHR      1,3             1102 /dev/null
sshd       6198  admin    1u   CHR      1,3             1102 /dev/null
sshd       6198  admin    2u   CHR      1,3             1102 /dev/null
sshd       6198  admin    3u  IPv4  2268635              TCP 10.0.1.5:ssh-&gt;10.0.1.1:40520  \
    (ESTABLISHED)
sshd       6198  admin    4r  FIFO      0,7          2269968 pipe
sshd       6198  admin    5w  FIFO      0,7          2269968 pipe
sshd       6198  admin    7w  FIFO      0,7          2269969 pipe
sshd       6198  admin    8r  FIFO      0,7          2269970 pipe
sshd       6198  admin   10r  FIFO      0,7          2269971 pipe
[...]
sshd      11011  admin    3u  IPv4    25118              TCP *:ssh (LISTEN)
[...]
</pre></div></div><br class="figure-break"><p>In this example, the process
<span class="italics">sshd</span>
has the process ID
<span class="italics">6198</span>,
is running as the user
<span class="italics">admin</span>,
is the binary located in
<code class="computeroutput">/usr/sbin/sshd</code>
has a couple of libraries loaded and has an ESTABLISHED TCP socket
between 10.0.1.1:40520 and 10.0.1.5:22.
</p><p>The process
<span class="italics">sshd</span>
with process ID 11011 has a TCP socket without an IP address and
in the LISTEN mode, which means that it is waiting for new TCP
sessions.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39890600"></a>6.12. Memory dump of the process sport</h2></div></div></div><p>The file
<span class="italics">mem-dump</span>
contains the dump of the meta data of the objects allocated in the
memory pool of the optimization service.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39891176"></a>6.12.1. The header</h3></div></div></div><p>The header contains information about the memory available, the
amount of memory used, the number of optimized TCP sessions and the
state of the optimization service:
</p><div class="figure"><a name="idp39891496"></a><p class="title"><b>Figure 6.84. Header of the mem-dump file</b></p><div class="figure-contents"><pre class="screen">AdmissionControl: Total System Memory = 7971, Current Usage = 4083 (3844 mmap, 236 non-hse \
    g), Slack Memory = 150, Connections = 522, State = 0

Peer Count: Online Peers = 13, Expired Peers = 0
</pre></div></div><br class="figure-break"><p>When the current usage is of memory is above a certain value, the
optimization service will go into memory based admission control.
The values for this can be found in the value for the fields
<code class="computeroutput">/rbt/sport/admission/config/cutoff_mem</code>
and
<code class="computeroutput">/rbt/sport/admission/config/enable_mem</code>:
</p><div class="figure"><a name="idp39892648"></a><p class="title"><b>Figure 6.85. Memory based admission based control values</b></p><div class="figure-contents"><pre class="screen">[~/sysdump-SH] edwin@t43&gt;grep /rbt/sport/admission/config/.*mem active-brief.txt
/rbt/sport/admission/config/cutoff_mem = 5200 (uint32)
/rbt/sport/admission/config/enable_mem = 5100 (uint32)
</pre></div></div><br class="figure-break"><p>So in this case, the current usage is 4083 Mb, well below the cutoff
value of 5200 Mb. Therefore there is no memory based admission
control.
</p><p>When the number of current connection usage is above a certain
value, the optimization service will go into connection based
admission control. The values for this can be found in the value
for the fields
<code class="computeroutput">/rbt/sport/admission/config/cutoff_conn</code>
and
<code class="computeroutput">/rbt/sport/admission/config/enable_conn</code>:
</p><div class="figure"><a name="idp39893864"></a><p class="title"><b>Figure 6.86. Connection based admission based control values</b></p><div class="figure-contents"><pre class="screen">[~/sysdump-SH] edwin@t43&gt;grep /rbt/sport/admission/config/.*conn active-brief.txt
/rbt/sport/admission/config/cutoff_conn = 2550 (uint32)
/rbt/sport/admission/config/enable_conn = 2500 (uint32)
</pre></div></div><br class="figure-break"><p>So in the case, the current amount is 522, well below the cutoff
value of 2550. Therefore there is no connection based admission
control.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39894440"></a>6.13. Out-of-memory profiling</h2></div></div></div><p>The files
<span class="italics">oom_profile.log*</span>
are populated every thirty seconds with
the output of the commands
<code class="computeroutput">cat /proc/meminfo</code>
and
<code class="computeroutput">ps</code>.
</p><div class="figure"><a name="idp39895528"></a><p class="title"><b>Figure 6.87. Contents of the file oom_profile.log</b></p><div class="figure-contents"><pre class="screen">================================================================================
Fri Sep 14 15:40:28 CEST 2012
================================================================================

cat /proc/meminfo
MemTotal:      8162944 kB
MemFree:       2683204 kB
Buffers:         67880 kB
Cached:        4221328 kB
SwapCached:          0 kB
Active:        4292324 kB
Inactive:       944588 kB
HighTotal:           0 kB
HighFree:            0 kB
LowTotal:      8162944 kB
LowFree:       2683204 kB
SwapTotal:     6297336 kB
SwapFree:      6297336 kB
Dirty:           32504 kB
Writeback:           0 kB
Mapped:        4696692 kB
Slab:           178840 kB
Committed_AS:  4968392 kB
PageTables:      21556 kB
VmallocTotal: 536870911 kB
VmallocUsed:    280440 kB
VmallocChunk: 536588807 kB
HugePages_Total:     0
HugePages_Free:      0
Hugepagesize:     2048 kB

ps -Aww -o pid,ppid,pcpu,vsize,rss,majflt,tty,stat,wchan,command
  PID  PPID %CPU   VSZ  RSS MAJFLT TT       STAT WCHAN  COMMAND
    1     0  0.0  4768  628     14 ?        S    -      init [3]  
    2     1  0.0     0    0      0 ?        S    migrat [migration/0]
    3     1  0.0     0    0      0 ?        SN   ksofti [ksoftirqd/0]
    4     1  0.0     0    0      0 ?        S    watchd [watchdog/0]
    5     1  0.0     0    0      0 ?        S    migrat [migration/1]
    6     1  0.0     0    0      0 ?        SN   ksofti [ksoftirqd/1]
    7     1  0.0     0    0      0 ?        S    watchd [watchdog/1]
    8     1  0.0     0    0      0 ?        S    migrat [migration/2]
    9     1  0.0     0    0      0 ?        SN   ksofti [ksoftirqd/2]
   10     1  0.0     0    0      0 ?        S    watchd [watchdog/2]
   11     1  0.0     0    0      0 ?        S    migrat [migration/3]
[...]
 8010     1  0.0 28716 7676      0 ?        Ss   -      /opt/tms/bin/pm
 8109     1  0.0  2396  320      0 ?        S&lt;   -      /opt/tms/bin/csoftwatch
 8138     1  0.0  4188  588      3 ?        S&lt;   wait   sh /sbin/softwatch.sh   
          
 8156     1  0.0  2540  468      0 tty1     Ss+  -      /sbin/mingetty tty1
 8157     1  0.0  2540  468      0 tty2     Ss+  -      /sbin/mingetty tty2
10554     1  0.1 20696 3520      0 ?        Ss   fuse_d /usr/local/bin/encfs -S 
/var/opt/rbt/encrypted/ /var/opt/rbt/decrypted
10907  8010  0.0  3640  660      0 ?        Ss   -      /usr/sbin/crond -n
10910  8010  0.0 17040 2008      7 ?        Ss   -      /usr/sbin/ntpd -n -u ntp
 -g
10912  8010  0.0 99480 28788    90 ?        Ssl  -      /opt/rbt/bin/rcud --logr
c /etc/rcud.logrc
11011  8010  0.0 15172 1876      3 ?        Ss   -      /usr/sbin/sshd -D
11012  8010  0.0 18536 8328      4 ?        S&lt;Lsl -     /opt/tms/bin/wdt
11560  8010  0.0 38732 5176     33 ?        Ss   -      /usr/sbin/winbindd -F
17859 11560  0.0 38692 5128      0 ?        S    fcntl_ /usr/sbin/winbindd -F
19591  8010  4.2 4294084 4283876 0 ?        S&lt;Lsl -     /opt/rbt/bin/sport /etc/opt/tms/ou \
    tput/configfile.xml --logrc /etc/sport.logrc --logfile /var/log/sport.log -t /etc/opt/ \
    tms/output/tds_config.xml
</pre></div></div><br class="figure-break"><p>With running this every 30 seconds, memory usage related issues are
tracked.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39896360"></a>6.14. CIFS pre-population related data</h2></div></div></div><p>The CIFS pre-population related configuration data is stored in the file
<code class="computeroutput">rcud.conf</code>.
This data is in the XML format and contains a single &lt;share&gt; section
per CIFS pre-population share:
</p><div class="figure"><a name="idp39896936"></a><p class="title"><b>Figure 6.88. The rcud.conf section for the share \\192.168.1.1\Test</b></p><div class="figure-contents"><pre class="screen">  &lt;share&gt;
    &lt;config       min_sync_freq_sec="60"
       sendbuf_size_byte="65536"
       recvbuf_size_byte="65536"
       get_share_size_freq_sec="10800"
       local_name="\\192.168.1.1\Test"
       server_name="192.168.1.1"
       server_path="\\192.168.1.1\Test"
       server_port="0"
       server_acct="mavetju\edwin"
       server_pwd="630434303e3cac08a322aa43346430394cc498f42be4e34d"
       mode="3"
       sync_freq_sec="300"
       sync_start_time="1299551270"
       full_sync_freq_sec="300"
       full_sync_start_time="1299551270"
       sharing="false"
       syncing="false"
       version_number="3"
       id="11"
       skip_init_copy="false"
/&gt;
[...]
    &lt;status       status="2"
       initial_copy_completion_time_sec="1299552948"
       initial_copy_completion_time_usec="8736"
       last_sync_status="true"
       last_sync_time_sec="1299553115"
       last_sync_time_usec="596340"
       last_full_sync_status="true"
       last_full_sync_time_sec="1299552948"
       last_full_sync_time_usec="8826"
       last_sync_begin_time_sec="30137660"
       last_sync_begin_time_usec="395507260"
       size_byte="0"
       acl_swapped="false"
/&gt;
  &lt;/share&gt;
</pre></div></div><br class="figure-break"><p>The status of the CIFS pre-population can be found in the
<code class="computeroutput">pfs</code>
directory. The names of the files are related to a share starts with
that name, for example for the share with the name
<code class="computeroutput">\\192.168.1.1\Test</code>,
the following files are generated:
</p><div class="figure"><a name="idp39898216"></a><p class="title"><b>Figure 6.89. Files for the share \\192.168.1.1\Test</b></p><div class="figure-contents"><pre class="screen">-rw-r--r--   1 edwin  edwin      0 Mar  8  2011 \\192.168.1.1\Test.err_log
-rw-r--r--   1 edwin  edwin    290 Mar  8  2011 \\192.168.1.1\Test.initial-copy.status
-rw-r--r--   1 edwin  edwin   2153 Mar  8  2011 \\192.168.1.1\Test.last-sync.status
</pre></div></div><br class="figure-break"><p>The synchronization status can be found in the files with the suffix
<code class="computeroutput">.initial-copy</code>
and
<code class="computeroutput">last-sync.status</code>:
</p><div class="figure"><a name="idp39899304"></a><p class="title"><b>Figure 6.90. Contents of the files initial-copy.status and last-sync.status</b></p><div class="figure-contents"><pre class="screen">Get initial copy started at Thu Sep  9 15:44:34 2010
Get initial copy completed at Thu Sep  9 15:44:43 2010
 Received 1 directories, 7 files, 0 deletions.  0 objects have error. (1101879 bytes were  \
    received in 7.330629 seconds at 1.202493 Mbps)

Full sync started at Thu Nov 25 15:45:48 2010
Full sync completed at Thu Nov 25 15:45:49 2010
 Sent 1 directories, 1 files, 0 deletions and 0 renames. 0 objects have error.
 (712321 bytes were sent in 3.213981 seconds)
===============================================
Full sync started at Thu Nov 25 16:51:50 2010
Full sync failed at Thu Nov 25 16:53:20 2010 connecting to server failed!
 Sent 0 directories, 0 files, 0 deletions and 0 renames. 0 objects have error.
 (0 bytes were sent in 0.000000 seconds)
</pre></div></div><br class="figure-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39899944"></a>6.15. RSP related data</h2></div></div></div><p>The RSP related data in the system dump is stored in the
<code class="computeroutput">rsp/</code>
directory. The most important information is related to the RSP
slots.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39900584"></a>6.15.1. RSP slots</h3></div></div></div><p>The RSP slot related data is stored in the
<code class="computeroutput">rsp/slots</code>
directory.
</p><div class="figure"><a name="idp39901160"></a><p class="title"><b>Figure 6.91. Files in the rsp/slots directory</b></p><div class="figure-contents"><pre class="screen">[~/sysdumps/2050L] edwin@t43&gt;ls -alR rsp/slots/
total 14
drwxr-xr-x  7 edwin  edwin   512 Sep 14 23:50 .
drwxr-xr-x  5 edwin  edwin  2048 Sep 14 23:50 ..
drwxr-xr-x  2 edwin  edwin   512 Sep 14 23:50 1
drwxr-xr-x  2 edwin  edwin   512 Sep 14 23:50 2
drwxr-xr-x  2 edwin  edwin   512 Sep 14 23:50 3
drwxr-xr-x  2 edwin  edwin   512 Sep 14 23:50 4
drwxr-xr-x  2 edwin  edwin   512 Sep 14 23:50 RiverbedSMC

rsp/slots/1:
total 4
drwxr-xr-x  2 edwin  edwin  512 Sep 14 23:50 .
drwxr-xr-x  7 edwin  edwin  512 Sep 14 23:50 ..

rsp/slots/2:
[...]

rsp/slots/RiverbedSMC:
total 18
drwxr-xr-x  2 edwin  edwin   512 Sep 14 23:50 .
drwxr-xr-x  7 edwin  edwin   512 Sep 14 23:50 ..
-rw-r--r--  1 edwin  edwin     5 Nov  9  2011 .enabled
-rw-r--r--  1 edwin  edwin     0 Aug 22  2011 .installed
-rw-r--r--  1 edwin  edwin     6 Apr 10 18:02 .priority
-rw-r--r--  1 edwin  edwin     0 Sep 29  2009 RiverbedSMC.vmsd
-rw-r--r--  1 edwin  edwin   266 Sep 29  2009 RiverbedSMC.vmxf
-rw-r--r--  1 edwin  edwin   698 Apr 10 18:02 rsp.conf
-rw-r--r--  1 edwin  edwin     0 Aug 22  2011 rsp.vmsd
-rw-r--r--  1 edwin  edwin  2895 Sep 13 02:09 rsp.vmx
-rw-r--r--  1 edwin  edwin   258 Aug 22  2011 rsp.vmxf
</pre></div></div><br class="figure-break"><p>The file
<code class="computeroutput">.enabled</code>
contains either "false" or "true", depending if an RSP slot is
enabled. Of the file
<code class="computeroutput">rsp.vmx</code>,
the only interesting field is
<span class="italics">memsize</span>
which defines how much memory is allocated for this RSP slot:
</p><div class="figure"><a name="idp39902632"></a><p class="title"><b>Figure 6.92. Memory allocation for the RSP slot RiverbedSMC </b></p><div class="figure-contents"><pre class="screen">[~/sysdumps/2050L] edwin@t43&gt;grep memsize rsp/slots/RiverbedSMC/rsp.vmx
memsize = "768"
</pre></div></div><br class="figure-break"><p>The file
<code class="computeroutput">rsp.conf</code>
contains the RSP Package Creator related configuration.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39903656"></a>6.16. SAR statistics</h2></div></div></div><p>The System Accounting Records contain statistics of the kernel
running on the Steelhead appliance. The most basic ones are the CPU
utilization, system load, NIC statistics and memory usage.
</p><p>The Steelhead appliance keeps track of about a month of SAR data.
The SAR data gets generated every day at 23:53 and during the
generation of a system dump:
</p><div class="figure"><a name="idp39904168"></a><p class="title"><b>Figure 6.93. Overview of the SAR data files</b></p><div class="figure-contents"><pre class="screen">-rw-r--r--  1 edwin  edwin  1281662 Sep 10 07:53 2012.09.09.23.53.sar
-rw-r--r--  1 edwin  edwin  1272770 Sep 11 07:53 2012.09.10.23.53.sar
-rw-r--r--  1 edwin  edwin  1281518 Sep 12 07:53 2012.09.11.23.53.sar
-rw-r--r--  1 edwin  edwin   872426 Sep 13 00:15 2012.09.12.16.15.sar
-rw-r--r--  1 edwin  edwin  1281519 Sep 13 07:53 2012.09.12.23.53.sar
</pre></div></div><br class="figure-break"><p>You can use a visualization tool like kSar to graph the data. You
can find it at http://sourceforge.net/projects/ksar/.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39904616"></a>6.17. Active Directory Integration</h2></div></div></div><p>For Active Directory integration, the data is stored in the
<code class="computeroutput">pfs/</code>
directory. There are two important files: The joining of the Steelhead
appliance to the domain and the communication towards the Domain
Controllers.
</p><div class="figure"><a name="idp39905576"></a><p class="title"><b>Figure 6.94. Contents of the pfs directory</b></p><div class="figure-contents"><pre class="screen">[~/sysdumps/CSH] edwin@t43&gt;ls -al pfs            
total 9836
drwxr-xr-x   2 edwin  edwin      512 Sep 18 19:47 .
drwxr-xr-x  19 edwin  edwin    10240 Sep 18 19:47 ..
-rw-r--r--   1 edwin  edwin   916073 Aug  4 22:51 log.wb-EXAMPLE
-rw-r--r--   1 edwin  edwin     1628 Aug 25 21:16 log.winbindd
-rw-r--r--   1 edwin  edwin        0 May 31  2010 log.winbindd-dc-connect
-rw-r--r--   1 edwin  edwin        0 Jul 21  2010 log.winbindd-locator
-rw-r--r--   1 edwin  edwin   310610 Sep  8  2010 net_ads.out
-rw-r--r--   1 edwin  edwin   175287 Aug 25 21:17 smbd.log
</pre></div></div><br class="figure-break"><p>The file
<code class="computeroutput">net_ads.out</code>
contains the logs for when the Steelhead appliance gets joined to
the domain. The most important data it is at the end:
</p><div class="figure"><a name="idp39906408"></a><p class="title"><b>Figure 6.95. Contents of the net_ads.out</b></p><div class="figure-contents"><pre class="screen">[2010/09/08 16:42:25,  1] libnet/libnet_join.c:libnet_Join(1920)
  libnet_Join:
      libnet_JoinCtx: struct libnet_JoinCtx
          out: struct libnet_JoinCtx
              account_name             : NULL
              netbios_domain_name      : 'EXAMPLE'
              dns_domain_name          : 'EXAMPLE.ORG'
              forest_name              : 'EXAMPLE.ORG'
              dn                       : 'CN=csh,CN=Computers,DC=EXAMPLE,DC=ORG'
              domain_sid               : *
                  domain_sid               : S-1-5-21-1298361332-912839128-1298391823
              modified_config          : 0x00 (0)
              error_string             : NULL
              domain_is_ad             : 0x01 (1)
              result                   : WERR_OK
[2010/09/08 16:42:25,  2] utils/net.c:main(849)
  return code = 0
Using short domain name -- EXAMPLE
Joined 'CSH' to realm 'EXAMPLE.ORG'
</pre></div></div><br class="figure-break"><p>This shows that the Steelhead was successfully joined to the Active
Directory domain.
</p><p>The file
<code class="computeroutput">log.wb-EXAMPLE</code>
contains the logs of the communication to the domain controller.
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39907432"></a>6.18. Process dumps</h2></div></div></div><p>When a process on the Steelhead fails, the operating system will
generate a core dump of it: A copy of all the memory of the process
as it was in use at the moment it failed. The size of the core dump
depends on the size of the process, for a core dump of the optimization
service this can be hundreds of megabytes.
</p><p>After the core dump is generated, the process
<span class="italics">pm</span>
will tell the process
<span class="italics">mgmtd</span>
to generate a system dump and merge the two dumps into a process
dump. This process might take a while, during which the process
does not get restarted.
</p><p>It can be necessary in the lifetime of a case that Riverbed TAC
requires a process dump of the optimization service. The way to
generate one is to use the command
<code class="computeroutput">debug service clone dump start</code>
or the command
<code class="computeroutput">pm process &lt;PROCESS&gt; send-signal SIGQUIT</code>.
</p><p>The command
<code class="computeroutput">debug service clone dump start</code>
will create a clone of the optimization service first and generates
a process dump of the clone. This will cause the optimization and the
normal traffic to continue.
</p><div class="figure"><a name="idp39909480"></a><p class="title"><b>Figure 6.96. Generating a process dump of the process sport by cloning it</b></p><div class="figure-contents"><pre class="screen">SH # debug service clone dump start
[... some times passes ...]
SH # show files process-dump
SH-sport-20130102-123456.tar.gz
SH # file process-dump SH-sport-20130102-123456.tar.gz ftp://192.168.1.1/incoming/SH-sport \
    -20130102-123456.tar.gz
SH # show info
Current User:      admin

Status:            Healthy
Config:            working
Appliance Up Time: 12d 11h 20m 7s
Service Up Time:   12d 11h 18m 14s
Managed by CMC:    yes
Temperature (C):   44
</pre></div></div><br class="figure-break"><p>The command
<code class="computeroutput">pm process &lt;PROCESS&gt; send-signal SIGQUIT</code>
will terminate the optimization service and then generate
a process dump of it. This will cause the optimized TCP sessions to
be aborted and the optimization service to be restarted.
</p><div class="figure"><a name="idp39910376"></a><p class="title"><b>Figure 6.97. Generating a process dump of the process sport by restarting it</b></p><div class="figure-contents"><pre class="screen">SH # pm process sport send-signal SIGQUIT
[... some times passes ...]
SH # show files process-dump
SH-sport-20130102-123456.tar.gz
SH # file process-dump SH-sport-20130102-123456.tar.gz ftp://192.168.1.1/incoming/SH-sport \
    -20130102-123456.tar.gz
SH # show info
Current User:      admin

Status:            Healthy
Config:            working
Appliance Up Time: 12d 11h 24m 23s
Service Up Time:   1m 31s
Managed by CMC:    yes
Temperature (C):   44
</pre></div></div><br class="figure-break"></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="Different_Network_Troubleshooting_Scenarios"></a>Chapter 7. Different Network Troubleshooting Scenarios</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp39911336">7.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp39912872">7.2. Traffic is blocked when the Steelhead appliance goes in by-pass.</a></span></dt><dt><span class="sect1"><a href="#idp39915688">7.3. Traffic is not optimized between two sites.</a></span></dt><dt><span class="sect1"><a href="#idp39961000">7.4. An optimized TCP Session gets reset or hangs</a></span></dt><dt><span class="sect1"><a href="#idp39965544">7.5. Slow network</a></span></dt><dt><span class="sect1"><a href="#idp40002408">7.6. Connection-based Admission Control</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39911336"></a>7.1. Index</h2></div></div></div><p>In this chapter several failure scenarios and their troubleshooting
approaches are described.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Traffic is blocked when the Steelhead appliance goes in by-pass.
</p></li><li class="listitem"><p>Traffic is not optimized between two sites.
</p></li><li class="listitem"><p>Optimized TCP sessions which fail halfway.
</p></li><li class="listitem"><p>Slow networks.
</p></li><li class="listitem"><p>How to find the cause of connection-based admission control.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39912872"></a>7.2. Traffic is blocked when the Steelhead appliance goes in by-pass.</h2></div></div></div><p>Under normal operational circumstances when the Steelhead appliance
is fully operational, the LAN and WAN interfaces each have an
Ethernet links negotiated towards the devices they it connected to:
From the LAN interface to the LAN switch and from the WAN interface
to the WAN router.
</p><p>When an in-path interface goes in by-pass, due to the termination
of the optimization service or when the appliance gets turned off,
it will connect the cables of the LAN switch and the WAN router
directly to each other and these two device should negotiate an
Ethernet link together.
</p><p>Ethernet link negotiation failure could happen when:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The cabling between the interfaces on the LAN switch and WAN
  router has become incompatible. Keep in mind that an in-path
  interface in by-pass mode acts like a crossover cable and that Fast
  Ethernet interfaces don't have the ability to detect the cable
  type. Also check the
<a class="xref" href="#install_cables" title="4.4. Cables">Cables</a>   section in the 
<span class="italics">Installation Related Issues</span>
  chapter.
</p></li><li class="listitem"><p>The configuration of the interfaces on the LAN switch and the WAN
  router has become incompatible. For example, one WAN interface
  is setup to 100 Mbps Full Duplex and the LAN interface is set to
  auto-negotiation on gigabit speeds only, then there will never an
  Ethernet link established.
</p></li><li class="listitem"><p>The in-path interface is by default configured for fail-to-wire
  but can be configured to be fail-to-block. Use the commands
<code class="computeroutput">show interfaces inpath0_0 configured</code>
  to determine the current state and the configuration command
<code class="computeroutput">no interface inpath0_0 fail-to-bypass enable</code>
  to go to fail-to-block.
</p><div class="figure"><a name="idp39915112"></a><p class="title"><b>Figure 7.1. In-path interface being configured for fail-to-block</b></p><div class="figure-contents"><pre class="screen">  SH (config) # show interfaces inpath0_0 configured 
  Interface inpath0_0 configuration
     Enabled:            no
     DHCP:               no
     Dynamic DNS DHCP:   no
     IP address:         10.0.1.6
     Netmask:            255.255.255.0
     MTU:                1500
     Failure mode:       Bypass
  SH (config) # no interface inpath0_0 fail-to-bypass enable 
  SH (config) # show interfaces inpath0_0 configured 
  Interface inpath0_0 configuration
     Enabled:            no
     DHCP:               no
     Dynamic DNS DHCP:   no
     IP address:         10.0.1.6
     Netmask:            255.255.255.0
     MTU:                1500
     Failure mode:       Disconnect
</pre></div></div><br class="figure-break"></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39915688"></a>7.3. Traffic is not optimized between two sites.</h2></div></div></div><p>When traffic is not optimized between two sites, the following steps
can be taken to determine the source of the problem:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Check the health of the appliances.
</p></li><li class="listitem"><p>Setup a TCP session which is expected to be optimized.
</p></li><li class="listitem"><p>Determine if the client-side Steelhead appliance sees this TCP session.
</p></li><li class="listitem"><p>Determine if the server-side Steelhead appliance sees this TCP session.
</p></li><li class="listitem"><p>Determine the cause of the failure of setup of inner channel.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39917224"></a>7.3.1. Health of the appliances</h3></div></div></div><p>A Steelhead appliance will not optimize any new TCP sessions whilst the
device is in Admission Control, like a TCP Connection Limit admission
control or Memory based admission control. Use the command
<code class="computeroutput">show info</code>
to confirm this and the command
<code class="computeroutput">show alarms triggered</code>
to determine which alarms are triggered.
</p><p>A Steelhead appliance will not optimize any new TCP sessions if the
packet goes via an interface which is in by-pass mode. Use tcpdump
to confirm that the traffic from the client to the server goes via
the Steelhead appliance.
</p><p>A Steelhead appliance in a Connection Forwarding cluster will not
optimize any new TCP sessions if the Connection Forwarding peer is
unreachable and Allow Failure in the Connection Forwarding configuration
is not enabled. Use the command
<code class="computeroutput">show in-path neighbour</code>
to confirm this.
</p><p>A Steelhead appliance will not optimize any new TCP sessions if the
combination of the client IP address and server IP address is in
the Asymmetric Routing table. Use the command
<code class="computeroutput">show in-path asym-route-tab</code>
to and
<code class="computeroutput">in-path asym-route-tab flush</code>
to deal with this.
</p><p>Only once confirmed that both Steelhead appliances are in a healthy
state, further troubleshooting can be started.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39919336"></a>7.3.2. Setup a TCP session expected to be optimized</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39919528"></a>7.3.2.1. Obtain necessary data</h4></div></div></div><p>First step is to determine the details of the TCP traffic that
doesn't get optimized. The information required is the source-subnets
where the clients are located (source-address) and the IP address
of the server (dest-address) and the TCP port of the service
(dest-port).
</p><p>In this example the IP address of the client will be 10.0.1.1, the
IP address of the server will be 192.168.1.1 and the TCP port is
543.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39919976"></a>7.3.2.2. Obtain access to the client</h4></div></div></div><p>The second step is to get access to a client. This would be easiest
if there is access to a client via a remote access or remote desktop
program:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Access to Unix based clients can be achieved via SSH or Telnet.
  Once logged in on the client, use the Telnet command to setup a
  TCP session to the server.
</p></li><li class="listitem"><p>Access to Microsoft Windows based client can be achieved via the
  Microsoft Remote Desktop application or screen sharing applications
  programs like VNC or Goto Assist. Once access has been obtained,
  use the Shell command
<code class="computeroutput">telnet.exe</code>
  to setup a TCP session to the server.
</p><p>  Note that Windows 7 does not install the telnet program by default,
  it can be installed via Control Panel -&gt; Programs and Features
  -&gt; Enable Windows Features.
</p></li><li class="listitem"><p>If no access can be obtained via real clients, consider accessing
  the local LAN switch, if it supports remote shells, or via an SSH
  session towards the local Steelhead appliance, if the primary
  interface of the Steelhead appliance is connected to the LAN switch.
  There use the telnet command to setup a TCP session to the server.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39921384"></a>7.3.2.3. Use Telnet to setup a TCP session to the server</h4></div></div></div><p>The syntax of the Telnet command is as follows:
</p><div class="figure"><a name="idp39921768"></a><p class="title"><b>Figure 7.2. Usage of the telnet command</b></p><div class="figure-contents"><pre class="screen">$ telnet 192.168.1.1 543
Trying 192.168.1.1...
Connected to 192.168.1.1.
Escape character is '^]'.
</pre></div></div><p><br class="figure-break">
</p><p>The full usage of this command is described in the chapter
<a class="xref" href="#tools_telnet" title="3.7. Telnet">Telnet</a> section in the
<span class="italics">The Command Line and Tools</span>
chapter.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39922920"></a>7.3.3. How the client-side Steelhead appliance sees this TCP session</h3></div></div></div><p>The next step is to see if and how the client-side Steelhead appliance
sees this TCP session.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39923304"></a>7.3.3.1. More information on why the TCP session was not optimized</h4></div></div></div><p>This can be found via the GUI under Reports -&gt; Networking -&gt; Current
Connections. Under connection type, select
<span class="italics">All</span>
and under Filter enter the IP address of the client and search for
the line with the IP addresses of the client and the server.
</p><div class="figure"><a name="idp39923944"></a><p class="title"><b>Figure 7.3. Reports -&gt; Networking -&gt; Current Connections</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/07-scenarios-05-currentconnections.png" align="middle" width="100%" alt="Reports -&gt; Networking -&gt; Current Connections"></td></tr></table></div></div></div><br class="figure-break"><p>On the CLI this can be done with the command
<code class="computeroutput">show connections all filter 10.0.1.1</code>.
</p><div class="figure"><a name="idp39937448"></a><p class="title"><b>Figure 7.4. Output of the "show connections all" command.</b></p><div class="figure-contents"><pre class="screen">SH # show connections all
T  Source                Destination           App    Rdn Since
--------------------------------------------------------------------------------
O  10.0.1.1        37780 192.168.1.1       543 TCP     0% 2012/07/29 01:54:35
PI 192.168.1.1     42342 10.0.1.1           22            2012/07/28 14:06:56 s
PU 10.0.1.1        51274 192.168.1.1       443            2012/07/29 01:43:22 c
PU 10.0.1.1        51490 192.168.1.1        80            2012/07/29 01:54:08 c
--------------------------------------------------------------------------------
Established Optimized (O):     1
Half-Opened Optimized (H):     0
Half-Closed Optimized (C):     0
Pass Through (P):              3
PI = Passthrough Intentional
PU = Passthrough Unintentional
</pre></div></div><br class="figure-break"><p>If the client-side Steelhead appliance does not show this TCP
session, then the TCP session followed a path between the client
and the server which is not covered by this Steelhead appliance.
</p><p>If the TCP session shows up as
<span class="italics">192.168.1.1:543 10.0.1.1:1025</span>,
then the first packet seen by the client-side Steelhead appliance
is the TCP SYN-ACK, not the TCP SYN packet. In that case the path
from the client to the server bypasses this Steelhead appliance and
the path from the server to the client does go through this Steelhead
appliance.
</p><p>If the TCP session shows up as
<span class="italics">10.0.1.1:1025 192.168.1.1:543</span>,
then check the details of the TCP session. This can be done in the
GUI by clicking on the magnifying glass in front of the TCP session.
</p><div class="figure"><a name="idp39938792"></a><p class="title"><b>Figure 7.5. TCP session details</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/07-scenarios-05-tcpsessiondetails.png" align="middle" width="100%" alt="TCP session details"></td></tr></table></div></div></div><br class="figure-break"><p>On the CLI this can be done with the command 
<code class="computeroutput">show connections all filter 10.0.1.1 full</code>.
</p><div class="figure"><a name="idp39939944"></a><p class="title"><b>Figure 7.6. Output of the "show connections all full" command.</b></p><div class="figure-contents"><pre class="screen">T  Source                Destination           App    Rdn Since
--------------------------------------------------------------------------------
O  10.0.1.1        37780 192.168.1.1       543 TCP     0% 2012/07/29 01:54:35
                  Peer: 192.168.1.6      7800    Flags: cfe,sdr,lz,te=0,pe=0    
           Outer Local: 10.0.1.6         7801    Inner: 19421                   
          Outer Remote: 10.0.1.6        37780  WAN/LAN: 0KB / 0KB
PI 192.168.1.1     42342 10.0.1.1           22            2012/07/28 14:06:56 s
PU 10.0.1.1        51274 192.168.1.1       443            2012/07/29 01:43:22 c
PU 10.0.1.1        51490 192.168.1.1        80            2012/07/29 01:54:08 c
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39940456"></a>7.3.3.2. Different kinds of pass-through TCP sessions</h4></div></div></div><p>There are two kinds of pass-through TCP sessions:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Intentional pass-through sessions, caused by in-path rules.
</p></li><li class="listitem"><p>Un-intentional pass-through session, caused by the failure to
  find or connect to another Steelhead appliance.
</p></li></ul></div><p>If the TCP session is intentional passed-through, then checking the
in-path rules is a good first step.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39941544"></a>7.3.3.3. Reasons for pass-through</h4></div></div></div><p>The pass-through reasons contain the next clue on why the client-side
Steelhead appliance couldn't setup an optimized TCP session:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the pass-through reason is
<span class="italics">SYN on the WAN side</span>,
  then the naked SYN packet for this TCP session showed up at the
  WAN interface instead of at the LAN interface: The LAN and WAN
  cables are swapped.
</p></li><li class="listitem"><p>If the pass-through reason is
<span class="italics">No more Steelheads</span>,
  then the SYN+ packet leaving the Steelhead appliance did not go
  through the server-side Steelhead appliance. Use the traceroute
  command to determine the path the IP packets take.
</p></li><li class="listitem"><p>If the pass-through reason is
<span class="italics">Asymmetric Routing</span>,
  then the server-side Steelhead appliance saw the SYN+ packet and
  send the SYN/ACK+, but the client-side Steelhead appliance did
  not see the SYN/ACK+ but the result of the client receiving the
  SYN/ACK+.
</p><p>  Check the Asymmetric Routing table to find out the reason for the
  pass-through of the TCP session.
</p></li><li class="listitem"><p>If the pass-through reason is
<span class="italics">Connection is currently paused</span>,
  then the optimization service is in admission control and not
  optimizing new TCP sessions.
</p></li><li class="listitem"><p>There is no space in the TCP Options field for the auto-discovery
  probe. The maximum length of the TCP header is 64 bytes with 20
  bytes used by fixed fields, leaving only 44 bytes for TCP Options.
  The standard TCP options like MSS size, Selective ACK, TCP
  Timestamps) leave enough space for the auto-discovery probe, but
  other extensions like auto-discovery probes from other vendors
  doesn't leave enough spare for the auto-discovery probe to be
  added.
</p><div class="figure"><a name="idp39944040"></a><p class="title"><b>Figure 7.7. No room for new TCP options for the auto-discovery phase</b></p><div class="figure-contents"><pre class="screen">  CSH [intercept.WARN] no room for option: 122.102.98.114:49809 -&gt; 172.21.3.101:443
</pre></div></div><br class="figure-break"></li></ul></div><p>A full list of pass-through reasons can be found in the Steelhead
Management Console and Users Guide and KB article S15377.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39944680"></a>7.3.3.4. Does the auto-discovery probe get attached?</h4></div></div></div><p>Next step is to confirm that the client-side Steelhead appliance
is putting the auto-discovery probe on to the TCP SYN packet. For
this two SSH sessions to the CLI are needed, one to trace traffic
on the LAN side and one to trace traffic on the WAN side. If the
TCP SYN packet comes in on a specific LAN interface, it will be
sent out via the corresponding WAN interface.
</p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39949160"></a>7.3.3.4.1. Client-side Steelhead appliance does attach an auto-discovery probe.</h5></div></div></div><p>In this example, the client-side Steelhead appliance does properly
attach a TCP auto-discovery probe on the new TCP SYN packet.
</p><div class="figure"><a name="idp39949480"></a><p class="title"><b>Figure 7.8. Running tcpdump on the LAN side</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni lan0_0 '(host 192.168.1.1 and host 10.0.1.1 and port 543) or (vlan and ( \
    host 192.168.1.1 and host 10.0.1.1 and port 543))'
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
09:51:50.122355 IP 10.0.1.1.57198 &gt; 192.168.1.1.543: Flags [S], seq 3205639252, win 65535, \
     options [mss 1460,nop,wscale 3,nop,nop,TS val 346474876 ecr 0,sackOK,eol], length 0
09:51:50.256198 IP 192.168.1.1.543 &gt; 10.0.1.1.57198: Flags [S.], seq 3950051338, ack 32056 \
    39253, win 5792, options [mss 1460,sackOK,TS val 1644000 ecr 346474876,nop,wscale 2],  \
    length 0
09:51:50.259818 IP 10.0.1.1.57198 &gt; 192.168.1.1.543: Flags [.], seq 1, ack 1, win 65535, o \
    ptions [nop,nop,TS val 346475011 ecr 1644000], length 0
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39949928"></a><p class="title"><b>Figure 7.9. Running tcpdump on the WAN side</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni wan0_0 '(host 192.168.1.1 and host 10.0.1.1 and port 543) or (vlan and ( \
    host 192.168.1.1 and host 10.0.1.1 and port 543))'
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
09:51:50.122430 IP 10.0.1.1.57198 &gt; 192.168.1.1.543: Flags [S], seq 3205639252, win 65535, \
     options [mss 1460,nop,wscale 3,nop,nop,TS val 346474876 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
09:51:50.256076 IP 192.168.1.1.543 &gt; 10.0.1.1.57198: Flags [S.], seq 20020520, ack 3205639 \
    253, win 65535, options [mss 1460,nop,wscale 3,nop,nop,TS val 346474876 ecr 0,sackOK,n \
    op,nop,rvbd-probe EAD 0c01,nop,nop,nop,eol], length 0
09:51:50.256109 IP 192.168.1.1.543 &gt; 10.0.1.1.57198: Flags [S.], seq 20020520, ack 3205639 \
    253, win 65535, options [mss 1460,nop,wscale 3,TS val 346474876 ecr 0,sackOK,rvbd-prob \
    e AD CSH:10.0.1.6 SSH:192.168.1.6:7800 11110a000106c0a801061e78,rvbd-probe EAD 0e3d,no \
    p,eol], length 0
</pre></div></div><br class="figure-break"><p>The TCP SYN packets with the
<span class="italics">rvbd-probe AD</span>
TCP option, or the SYN+, is seen here and shows that the client-side
Steelhead has processed the new TCP session properly.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39950760"></a>7.3.3.4.2. Client-side Steelhead appliance does not attach an auto-discovery probe.</h5></div></div></div><p>In this example, the client-side Steelhead appliance does not attach
a TCP auto-discovery probe on the new TCP SYN packet.
</p><div class="figure"><a name="idp39951080"></a><p class="title"><b>Figure 7.10. Running tcpdump on the LAN side</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni lan0_0 '(host 192.168.1.1 and host 10.0.1.1 and port 543) or (vlan and ( \
    host 192.168.1.1 and host 10.0.1.1 and port 543))'
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
09:55:09.968491 IP 10.0.1.1.57269 &gt; 192.168.1.1.543: Flags [S], seq 587559488, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 346673686 ecr 0,sackOK,eol], length 0
09:55:10.102059 IP 192.168.1.1.543 &gt; 10.0.1.1.57269: Flags [S.], seq 214939753, ack 587559 \
    489, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 2495570782 ecr 346673686] \
    , length 0
09:55:10.105859 IP 10.0.1.1.57269 &gt; 192.168.1.1.543: Flags [.], seq 1, ack 1, win 65535, o \
    ptions [nop,nop,TS val 346673823 ecr 2495570782], length 0
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39951528"></a><p class="title"><b>Figure 7.11. Running tcpdump on the WAN side</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni wan0_0 '(host 192.168.1.1 and host 10.0.1.1 and port 543) or (vlan and ( \
    host 192.168.1.1 and host 10.0.1.1 and port 543))'
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
09:55:09.968576 IP 10.0.1.1.57269 &gt; 192.168.1.1.543: Flags [S], seq 587559488, win 65535,  \
    options [mss 1460,nop,wscale 3,nop,nop,TS val 346673686 ecr 0,sackOK,eol], length 0
09:55:10.101988 IP 192.168.1.1.543 &gt; 10.0.1.1.57269: Flags [S.], seq 214939753, ack 587559 \
    489, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 2495570782 ecr 346673686] \
    , length 0
09:55:10.105920 IP 10.0.1.1.57269 &gt; 192.168.1.1.543: Flags [.], seq 1, ack 1, win 65535, o \
    ptions [nop,nop,TS val 346673823 ecr 2495570782], length 0
</pre></div></div><br class="figure-break"><p>If there is no auto-discovery probe seen on the outgoing SYN packet,
then the optimization service might not be enabled on that particular
in-path interface, the appliance might be in admission control or
there is asymmetric routing happening.
</p></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39952104"></a>7.3.4. How the server-side Steelhead appliance sees this TCP session</h3></div></div></div><p>The next step is to see what the server-side Steelhead appliance
sees about this TCP session.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39952488"></a>7.3.4.1. More information on why the TCP session was not optimized</h4></div></div></div><p>The first step would be to check in the GUI on the Current Connections
page for this TCP session, just like on the client-side Steelhead
appliance.
</p><p>If the pass-through reason is
<span class="italics">SYN on the WAN side</span>,
then the auto-discovery TCP option has been stripped on the path
between the client-side Steelhead appliance and the server-side
Steelhead appliance.
</p><p>If the pass-through type is
<span class="italics">Intentional pass-through</span>,
then the auto-discovery probe is ignored because of a peering-rule.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39953704"></a>7.3.4.2. Does the auto-discovery probe get detected?</h4></div></div></div><p>Next step is to confirm that the server-side Steelhead appliance
does see an auto-discovery probe in the SYN+ packet.
</p><div class="figure"><a name="idp39954024"></a><p class="title"><b>Figure 7.12. Running tcpdump on the client-side WAN side, seeing the SYN+ packet</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni wan0_0 '(host 192.168.1.1 and host 10.0.1.1 and port 543) or (vlan and ( \
    host 192.168.1.1 and host 10.0.1.1 and port 543))'
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
10:05:30.767917 IP 10.0.1.1.57489 &gt; 192.168.1.1.543: Flags [S], seq 1098146093, win 65535, \
     options [mss 1460,nop,wscale 3,nop,nop,TS val 347290479 ecr 0,sackOK,nop,nop,rvbd-pro \
    be AD CSH:10.0.1.6 01010a0001060005,rvbd-probe EAD 0c01,nop,eol], length 0
10:05:30.900270 IP 192.168.1.1.543 &gt; 10.0.1.1.57489: Flags [S.], seq 2704856677, ack 10981 \
    46094, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 1624055221 ecr 34729047 \
    9], length 0
10:05:30.903472 IP 10.0.1.1.57489 &gt; 192.168.1.1.543: Flags [.], seq 1, ack 1, win 65535, o \
    ptions [nop,nop,TS val 347290613 ecr 1624055221], length 0
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp39954472"></a><p class="title"><b>Figure 7.13. Running tcpdump on the server-side WAN side without the SYN+ packet</b></p><div class="figure-contents"><pre class="screen">CSH # tcpdump -ni wan0_0 '(host 192.168.1.1 and host 10.0.1.1 and port 543) or (vlan and ( \
    host 192.168.1.1 and host 10.0.1.1 and port 543))'
tcpdump: WARNING: wan0_0: no IPv4 address assigned
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wan0_0, link-type EN10MB (Ethernet), capture size 300 bytes
09:47:29.245645 IP 10.0.1.1.57489 &gt; 192.168.1.1.543: Flags [S], seq 1098146093, win 65535, \
     options [mss 1460,nop,wscale 3,nop,nop,TS val 347290479 ecr 0,sackOK,nop,nop,nop,nop, \
    nop,nop,nop,nop,nop,nop,nop,nop,nop,nop,nop,eol], length 0
09:47:29.245784 IP 192.168.1.1.543 &gt; 10.0.1.1.57489: Flags [S.], seq 2704856677, ack 10981 \
    46094, win 65535, options [mss 1460,nop,wscale 3,sackOK,TS val 1624055221 ecr 34729047 \
    9], length 0
09:47:29.382200 IP 10.0.1.1.57489 &gt; 192.168.1.1.543: Flags [.], seq 1, ack 1, win 65535, o \
    ptions [nop,nop,TS val 347290613 ecr 1624055221], length 0
</pre></div></div><br class="figure-break"><p>If a normal naked SYN packet gets seen on the server-side Steelhead
appliance, although there was a SYN+ packet send by the client-side
Steelhead appliance, then it is stripped somewhere in the path
between the client-side Steelhead appliance and the server-side
Steelhead appliance. Firewalls, intrusion detection and prevention
systems (IDS/IPS) are well known for removing the probes.
</p><p>If there is neither a SYN+ nor a naked SYN packet seen on the
server-side Steelhead appliance, then the path of the traffic between
the client and the server does not include the server-side Steelhead
appliance.  Use the traceroute program to determine the path of the
traffic.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39955176"></a>7.3.4.3. Return of SYN/ACK+ packet</h4></div></div></div><p>When the server-side Steelhead appliances sees a SYN+ packet and it
is willing to peer with it, it will return a SYN/ACK+ packet. This
packet should arrive at the client-side Steelhead appliance. If it
doesn't get seen at the client-side Steelhead appliance, then the
path the traffic takes from the server-side Steelhead appliance to
the client does not go via the client-side Steelhead appliance.
</p><p>If both the Steelhead appliances see the auto-discovery probes,
then the inner channel will be setup.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39955624"></a>7.3.5. Cause of the failure of setup of inner channel</h3></div></div></div><p>Once the two Steelhead appliance have detected each other via the
auto-discovery probe in the TCP Options, the client-side Steelhead
will setup an inner channel to the server-side Steelhead appliance.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39955944"></a>7.3.5.1. With the Correct Addressing WAN Visibility mode</h4></div></div></div><p>The behaviour in setup of an inner channel is different when the
two appliances do or don't have a Out-of-Band Splice setup between
them.
</p><p>This can be determined via the list of Connected Appliances (available
with the CLI command
<code class="computeroutput">show peers</code>
and in the GUI at Reports -&gt; Optimization -&gt; Connected Appliances).
If the peer in-path IP address shows up as Online, then an OOB
Splice has been established already.
</p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39956648"></a>7.3.5.1.1. Out-of-Band Splice does not yet exist</h5></div></div></div><p>When no Out-of-Band Splice exists, the optimization service will
setup a new OOB TCP session between the IP address of the in-path
interface on the client-side Steelhead appliance and the IP address of the
in-path interface on the server-side Steelhead appliance on TCP port 7800.
</p><p>On the client-side Steelhead appliance a TCP SYN packet will be
sent, it should arrive on the server-side Steelhead appliance and
be replied by a TCP SYN/ACK packet. The TCP SYN/ACK packet
should arrive on the client-side Steelhead appliance and it should
be replied with by a TCP ACK packet.
</p><p>Note that the path the SYN+ packet from the client takes can be
different from the path that the TCP SYN packet from the inner
channel. This also means that the behaviour of various networking
equipment, like routing decisions, the traffic shaper behaviour
and the firewall policy, can be different.
</p><p>Once the TCP session for the OOB splice is successfully setup, the Steelhead
appliances will perform the OOB handshake during which they will
exchange details and capabilities and the OOB Splice is completed.
After that, unless one of the Steelhead appliances goes into Admission
Control and will terminate the OOB Splice, there will be no more
data exchanged over the OOB Splice.
</p><p>If the OOB Splice does not get established, the inner channel for
the optimized TCP session will also not be setup and the TCP session
will be passed-through. Use the traceroute command to see if there
is a difference in the path the traffic takes from the client to
the server and in the path it takes for traffic from the IP address
of the in-path interface of the client-side Steelhead appliance to
the IP address of the in-path interface of the server-side Steelhead
appliance.
</p><p>The next step is the setup of a Connection Pool of 20 TCP sessions
which can be converted later to inner channels. These are normal
TCP sessions from the IP address of the in-path interface of the
client-side Steelhead appliance to the IP address of the in-path
interface of the server-side Steelhead appliance on TCP port 7800,
but no data is send over it until later. If the OOB Splice got
setup, then the setup of these TCP sessions shouldn't be a problem.
</p><p>The final step is the conversion of one of the TCP sessions of the
Connection Pool into an inner channel by sending the inner channel
handshake over the TCP session and once acknowledged with a TCP
ACK, the inner channel is established.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39957800"></a>7.3.5.1.2. Out-of-Band Splice already exists</h5></div></div></div><p>When the Out-of-Band Splice already exists, there will also be the
Connection Pool, a pool of pre-setup TCP sessions between the in-path
interfaces of the client-side and server-side Steelhead appliances
available to be converted into inner channels for optimized TCP
sessions.
</p><p>The Connection Pool exists as long as the OOB Splice exists. The OOB
Splice is a TCP session with a very short TCP keep-alive interval
and thus should be the first to know that the server-side Steelhead
is not reachable.
</p><p>Before they start being used, these TCP sessions in the Connection
Pool might have already been there for a long time, lying idle
until a new TCP session gets optimized. When needed, the inner
channel handshake gets send over one of the TCP sessions in the
Connection Pool and once acknowledged with a TCP ACK, the TCP session
is converted into an inner channel.
</p><p>If the TCP ACK expected after the inner channel handshake does not
show up at the client-side Steelhead appliance, then the inner
channel might have been timed out in a session-table in a firewall.
</p><p>If the reply to the inner channel handshake is a TCP RST packet,
then there is possibly a firewall in the middle which has expired the TCP
session.
</p></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39958632"></a>7.3.5.2. With the Port Transparency WAN Visibility mode</h4></div></div></div><p>With the Port Transparency WAN Visibility mode, the inner channel
consists of a TCP session from the IP address of the in-path interface
of the client-side Steelhead appliance to the IP address of the
in-path interface of the server-side Steelhead appliance, but with
the TCP port numbers of the original TCP session.
</p><p>Because of the different TCP port numbers, it is not possible to
setup a Connection Pool in advance and the setup of the TCP session
for the inner channel does need to happen for every optimized TCP
session with the Port Transparency WAN Visibility mode.
</p><p>After the auto-discovery phase, the client-side Steelhead appliance
will send a TCP SYN packet with the Transparency TCP Option in it.
This Transparency TCP Option has the IP addresses of the in-path
interfaces of the Steelhead appliances in it and the TCP port numbers
used on the Steelhead appliances to identify the inner channel.
</p><p>Just with the Correct Addressing WAN Visibility, the path that the
TCP SYN packet with the Transparency TCP option takes can be different
from the path that the SYN+ packet takes. This also means that the
behaviour of various networking equipment, like the routing
decisions, the traffic shaper behaviour and the firewall policy,
can be different.
</p><p>If this TCP SYN packet with the Transparency TCP Option does not
reach the server-side Steelhead appliance, check the path the TCP
SYN packet takes with the traceroute command.
</p><p>If the path is the same, then check if a normal TCP session without
the Transparency TCP Options towards the IP address of the server-side
Steelhead appliance but to the server TCP port does arrive on the
server-side Steelhead appliance. If it does arrive there, then there
is something in the path which dropped the packet because of the
Transparency TCP Option.
</p><p>After the TCP SYN packet with the Transparency TCP Option arrives
at the server-side Steelhead appliance, it will send a TCP SYN/ACK
with the Transparency TCP Option back to the client-side Steelhead
appliance which will send the final TCP ACK with the Transparency
TCP Option and the TCP session of the inner channel is setup.
</p><p>Once the TCP session of the inner channel is setup, the client-side
Steelhead appliance will send the inner channel handshake over the
TCP session and once acknowledged with a TCP ACK, the inner channel
is established.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39959848"></a>7.3.6. With the Full Transparency WAN Visibility mode</h3></div></div></div><p>With the Full Transparency WAN Visibility mode, the inner channel
consists of a TCP session from the IP address of the original TCP
session and with the TCP port numbers of the original TCP session.
</p><p>Also here it is not possible to setup a Connection Pool in advance
and the setup of the TCP session for the inner channel does also
need to happen for every optimized TCP session with the Full
Transparency WAN Visibility mode.
</p><p>After the auto-discovery phase, the client-side Steelhead appliance
will send a TCP SYN packet with the Transparency TCP Option in it,
just like with Port Transparency.
</p><p>Unlike with the Correct Addressing and the Port Transparency WAN
Visibility, the path that the TCP SYN packet with the Transparency
TCP option takes is the same as the SYN+ packet takes. This means
that firewall networking equipment might complain now: The
previous TCP SYN packet had different TCP sequence numbers.
</p><p>If this TCP SYN packet with the Full Transparency TCP Option does
not reach the server-side Steelhead appliance, change the in-path
rule from the Full Transparency WAN Visibility to the Full Transparency
With Firewall Reset WAN Visibility. This will cause the Steelhead
appliance to send a TCP RST before sending the TCP SYN packet with
the Full Transparency TCP Options, attempting to clear any firewall
state tables.
</p><p>After the TCP SYN packet with the Transparency TCP Option arrives
at the server-side Steelhead appliance, it will send a TCP SYN/ACK
with the Transparency TCP Option back to the client-side Steelhead
appliance which will send the final TCP ACK with the Transparency
TCP Option and the TCP session of the inner channel is setup.
</p><p>Once the TCP session of the inner channel is setup, the client-side
Steelhead appliance will send the inner channel handshake over the
TCP session and once acknowledged with a TCP ACK, the inner channel
is established.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39961000"></a>7.4. An optimized TCP Session gets reset or hangs</h2></div></div></div><p>The final result is the same, the client and the server stop
communicating with each other, but the cause is different:
</p><p>An optimized TCP session hangs when traffic in one direction is
blocked, an optimized TCP session gets reset when the client or
the server gets a TCP RST packet.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39961512"></a>7.4.1. Reset TCP sessions</h3></div></div></div><p>A TCP session gets reset when it receives a TCP RST packet. TCP
RST packets are generated when:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A TCP SYN packet arrives at the server but there is no service
  listening on the destination TCP port. The client will report
  this as
<span class="italics">Connection refused</span>.
</p></li><li class="listitem"><p>A TCP SYN/ACK packet arrives at the client but the client doesn't
  have a socket open on that TCP port. This can happen the program
  which has opened the socket has already closed it before the TCP
  SYN/ACK returns.
</p></li><li class="listitem"><p>A TCP packet arrives at a client or server but that one doesn't
  know about this TCP session anymore. This can happen when a long
  idle TCP session comes back alive and the machine on the other
  side has been restarted.
</p></li><li class="listitem"><p>A TCP packet arrives at a client or server but the TCP sequence
  numbers are invalid. This can happen in WAN optimization environments
  where the SYN/ACK+ bypasses both the client-side and server-side
  Steelhead appliances.
</p></li><li class="listitem"><p>A firewall sees traffic for a TCP session which is not in its TCP
  session table. This can happen when the TCP session comes back
  online after it has been idle for a long time and the TCP session
  has timed-out on the firewall.
</p></li><li class="listitem"><p>A firewall sees incorrect TCP sequence behaviour. This happens
  when traffic for a second TCP session with the same IP addresses
  and TCP port numbers gets seen. This can happen when using the
  Full Transparency WAN Visibility.
</p></li><li class="listitem"><p>A firewall detects a time-out on a state change in the TCP three-way
  handshake and resets the TCP session towards the client and the
  server to alert it that the TCP session could not be established.
  This can happen during the auto-discovery process when a firewall
  in the middle only sees the SYN+ and SYN/ACK+ and not the final
  TCP ACK.
</p></li><li class="listitem"><p>An Intrusion Prevention System detects a violation of the protocol
  on top of TCP and aborts the TCP session. This can happen when
  the Port Transparency or the Full Transparency WAN Visibility is
  used in a network with an IPS device between the Steelhead
  appliances.
</p></li><li class="listitem"><p>For an optimized TCP session, which consists of three TCP sessions,
  the inner channel between the two Steelhead appliances fails and
  therefore the two outer channels also get reset.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39963880"></a>7.4.2. Hanging TCP sessions</h3></div></div></div><p>A hanging TCP session happens when traffic being sent out from one
side is blocked in the network and the TCP Window of the sender is
filling up and stops sending further packets.
</p><p>This can happen when:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A device in the path is buffering the traffic while it waits for
  a network path to become available. This could happen when a VPN
  tunnel gets restarted or when a non-IP routing device is buffering
  the packets.
</p></li><li class="listitem"><p>A device in the path is blackholing the traffic.
</p></li><li class="listitem"><p>A device in the path cannot forward the IP packet because of MTU
  size issues and the ICMP Fragmentation Needed packets send by the
  blocking device do not arrive at the sender.
</p></li><li class="listitem"><p>An Intrusion Prevention System has detected a protocol violation
  on top of TCP and discards the packet. This can happen when
  the Port Transparency or the Full Transparency WAN Visibility is
  used in a network with an IPS between the Steelhead appliances.
</p></li></ul></div><p>This issue can be detected by tracing the TCP session at the sender
and see that despite sending various TCP packets, there is no TCP
acknowledgement coming from the other side.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39965544"></a>7.5. Slow network</h2></div></div></div><p>This part looks at the network being slow and what the causes can be.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39965864"></a>7.5.1. Is the TCP session optimized?</h3></div></div></div><p>In the list of Current Connections the TCP session should be shown
as being optimized and not pass-through.
</p><p>If it is pass-through, then why is it in pass-through? In the Current
Connections reports, either from the GUI under Reports -&gt; Networking
-&gt; Current Connections or from the CLI with the command
<code class="computeroutput">show connections all</code>,
is shown if the TCP session is pass-through because of an intentional
reason (That is an in-path rule which prevents the TCP session from
being optimized) or because of an unintentional reason:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>SYN on WAN side: The naked SYN packet arrived on the WAN side of
  the device. This is normal on data-center Steelhead appliances
  for traffic which will terminate on the hosts in the data-center.
  If this TCP session is expected to be optimized, then check what
  is happening with the naked SYN and SYN+ packets during the
  auto-discovery phase.
</p></li><li class="listitem"><p>No Peer: The auto-discovery probe in the SYN+ did not get intercepted
  by another Steelhead appliance. If this TCP session is expected
  to be optimized, then check what is happening with the SYN+ packet
  during the auto-discovery phase.
</p></li><li class="listitem"><p>Pre-existing connection: The first packet for this TCP session
  seen by the optimization service was not the TCP handshake in the
  beginning of the stream but another packet halfway the stream.
  This can happen when the optimization service has been restarted.
  The way out is to either reset the TCP session from the GUI or
  CLI or to restart the application on the client.
</p></li><li class="listitem"><p>Asymmetric Routing: The source and destination IP addresses are
  in the asymmetric routing table.
</p></li></ul></div><p>A full list of them can be found at KB article S15377 - "What are
the Reason Codes for pass-through connections in the Current
Connections report?" available from the Riverbed Support website.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39967528"></a>7.5.2. Is the Latency Optimization working?</h3></div></div></div><p>In the list of Current Connections in the GUI the TCP session will
show a red triangle if the latency optimization has failed and has
reduced the optimization functionality back to bandwidth reduction
only.
</p><p>The following issues can occur:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A CIFS session is requested to use SMBv2 and the Steelhead appliance
  is not able to perform latency optimization on this traffic
  (Available since RiOS version 6.5). A workaround can be to let
  the Steelhead appliance negotiate the SMB version back to SMB
  version 1.
</p></li><li class="listitem"><p>A CIFS session uses SMB Signing or a MAPI session encrypted MAPI
  and the server-side Steelhead appliance isn't configured to support
  this kind of data.
</p></li><li class="listitem"><p>A CIFS session uses SMB Signing or a MAPI session encrypted MAPI
  and the server-side Steelhead appliance isn't able to impersonate
  the user against the AD infrastructure. This issue is logged on
  the server-side Steelhead appliance and can be related to:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Inability to determine the Domain Controllers via DNS or to
    reach a certain Domain Controller.
</p></li><li class="listitem"><p>In case the Steelhead appliance is configured to use to one
    specific Domain Controller, the Domain Controller can have been
    decommissioned or has out-of-sync data on it.
</p></li><li class="listitem"><p>Steelhead appliance object in Active Directory has disappeared.
</p></li><li class="listitem"><p>Delegate user in Active Directory has been locked out or has
    its password changed.
</p></li><li class="listitem"><p>Absence of delegate user in Active Directory.
</p></li><li class="listitem"><p>Absence of the CIFS server in the Delegate list on the delegate
    user in Active Directory.
</p></li><li class="listitem"><p>Protocol issues between the Steelhead appliance and a Domain
    Controller (For example, Windows 2008R2 servers where not supported
    to delegate to until RiOS version 6.1)
</p></li><li class="listitem"><p>Time skew between the server-side Steelhead appliance and the
    Domain Controllers.
</p></li></ul></div></li><li class="listitem"><p>A signed CIFS session uses a system account to map a drive. Since
  no user account is used here, the optimization service cannot
  impersonate anything on this CIFS session. A workaround to reduce
  the side-effect of blacklisting this server would be to use a
  special CIFS server for shares mapped by computer accounts so
  that the blacklisting of this server doesn't affect the optimization
  of other CIFS shares. This can be overcome by using Kerberos
  authentication.
</p></li><li class="listitem"><p>A MAPI session uses a MAPI dialect which is not supported for
  latency optimization. Examples are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Blackberry related traffic.
</p></li><li class="listitem"><p>Exchange to Exchange traffic.
</p></li></ul></div></li><li class="listitem"><p>An HTTP session is using an HTTP protocol which uses other methods
  than GET and PUT. An example of this is the DAV Filesystem which
  is layered on top of HTTP which is not supported until RiOS 8.5.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39987688"></a>7.5.3. Is the slowness on the network?</h3></div></div></div><p>At this moment, the TCP session is optimized and the latency
optimization is working fine. The next step is to determine what
goes slow and what goes fast and what the Steelhead appliance
complains about.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39988008"></a>7.5.3.1. CIFS related issues</h4></div></div></div><p>The questions which need to be asked are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Is the slowness happening during the reading by an application?
  This could be a file server issue, like file locking or authentication
  / authorization.
</p></li><li class="listitem"><p>Is the slowness happening during the copying from the file server
  onto the computer? The expected behaviour here is a fast copy
  since there is no locking happening.
</p></li><li class="listitem"><p>Is the slowness happening during a write operation by an application
  and also on a re-save without any changes? The first one could
  be slow, the second one is expected to be fast.
</p></li><li class="listitem"><p>Is the slowness happening during a write operation from the computer
  to the file server? That should be fast, if the file had not changed
  since you copied it from the file server.
</p></li></ul></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39989160"></a>7.5.3.1.1. Response times</h5></div></div></div><p>For CIFS latency optimization, we expect fast local acknowledgments
on the SMB requests like closing files, disconnecting from a share
and obtaining a directory listing.
</p><p>In Wireshark you can see this under Statistics -&gt; Service Response
Times -&gt; SMB.
</p><div class="figure"><a name="idp39989608"></a><p class="title"><b>Figure 7.14. Latency optimized SMB requests response times overview</b></p><div class="figure-contents"><pre class="screen">=================================================================
SMB SRT Statistics:
Filter:
Commands                   Calls    Min SRT    Max SRT    Avg SRT
Close                          1   0.000212   0.000212   0.000212
Open AndX                      1   0.134227   0.134227   0.134227
Read AndX                     18   0.354067   0.887230   0.646874
Tree Disconnect                1   0.000169   0.000169   0.000169
Negotiate Protocol             1   0.133985   0.133985   0.133985
Session Setup AndX             2   0.133340   0.136641   0.134991
Tree Connect AndX              2   0.132323   0.134432   0.133378
Query Information Disk         1   0.222203   0.222203   0.222203

Transaction2 Commands      Calls    Min SRT    Max SRT    Avg SRT
FIND_FIRST2                    2   0.287443   0.560205   0.423824
FIND_NEXT2                     4   0.000094   0.009760   0.004776
QUERY_FILE_INFO                1   0.134086   0.134086   0.134086
GET_DFS_REFERRAL               1   0.133184   0.133184   0.133184

NT Transaction Commands    Calls    Min SRT    Max SRT    Avg SRT
=================================================================
</pre></div></div><br class="figure-break"><p>If the response times of Close, Tree Disconnect and FIND_NEXT2 are
not significantly lower, the CIFS latency optimization might be
disabled or not working.
</p><p>If it is only the response times of the write requests which are
not significantly lower, then it might be that the optimization
service has detected that the remote disk is near full capacity and
has turned off its Write Behind feature for that CIFS session.
</p><div class="figure"><a name="idp39990440"></a><p class="title"><b>Figure 7.15. CIFS Write Behind has been disabled by the optimization service.</b></p><div class="figure-contents"><pre class="screen">CSH sport[14140]: [smbcfe.NOTICE] 679459 {10.0.1.1:3346 192.168.1.1:445} Disk usage reache \
    d threshold (2048 MB free) on share \FOO\BAR, disabling write/setfile pre-acking 
</pre></div></div><br class="figure-break"></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp39990888"></a>7.5.3.1.2. File formats</h5></div></div></div><p>When saving a file via an application, the file format it uses is
very important for the performance of the transmission of the file.
</p><p>For example when the file format is uncompressed, a little change
in the content will only affect a small of the file.
</p><p>Take these two files which are nearly the same. Changing a single
line in the text one generates a diff of 2 lines. After compression,
the files are not only different in size, but as the output of
bsdiff (a binary patch generator) shows, the contents of the file
are also different enough to generate a patch which is larger than
the original file.
</p><div class="figure"><a name="idp39991464"></a><p class="title"><b>Figure 7.16. Comparison of two binary files</b></p><div class="figure-contents"><pre class="screen">[~/size] edwin@t43&gt;ls -al gcc.1 gcc.2
-rw-r--r--  1 edwin  edwin  584775 Oct 21 16:58 gcc.1
-rw-r--r--  1 edwin  edwin  584775 Oct 21 16:58 gcc.2
[~/size] edwin@t43&gt;wc gcc.1
   13118   79291  584775 gcc.1
[~/size] edwin@t43&gt;diff gcc.1 gcc.2
134c134
&lt; XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
---
&gt; gcc \- GNU project C and C++ compiler

[~/size] edwin@t43&gt;zip gcc.1.zip gcc.1; zip gcc.2.zip gcc.2
updating: gcc.1 (deflated 72%)
updating: gcc.2 (deflated 72%)
[~/size] edwin@t43&gt;bsdiff gcc.1.zip gcc.2.zip bsdiff
[~/size] edwin@t43&gt;ls -al gcc.1.zip gcc.2.zip bsdiff 
-rw-r--r--  1 edwin  edwin  163096 Oct 24 07:32 bsdiff
-rw-r--r--  1 edwin  edwin  162215 Oct 24 07:22 gcc.1.zip
-rw-r--r--  1 edwin  edwin  162228 Oct 24 07:22 gcc.2.zip
</pre></div></div><br class="figure-break"><p>Because of this huge change, the performance of a save inside the
appliance will be like an initial cold transfer.
</p></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39992040"></a>7.5.3.2. Database connections</h4></div></div></div><p>Communication towards a database can be done in two ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The client sends a request and asks for the complete data set.
  The result will be large blob of data which will have a great
  data-reduction and speed improvement on it.
</p></li><li class="listitem"><p>The client sends a request and asks for the first record, then
  the next record and the next record. Because of the constant
  exchange of single packet questions and answers with a small
  payload, the optimization level will be very small. To make things
  worse, various optimization features like Neural Framing will
  become a major delay for each packet.
</p><p>  The best way to investigate if this stream can be optimized is:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Create an auto-discovery in-path rule which targets the traffic
    towards the IP address of the database server and TCP port.
    Perform the query and measure how long it takes.
</p></li><li class="listitem"><p>Alter the in-path rule to disable Neural Framing. Perform the
    query and measure how long it takes.
</p></li><li class="listitem"><p>Alter the in-path rule to become a pass-through rule. Perform
    the query and measure how long it takes.
</p></li></ul></div><p>
</p><p>  Depending on which one goes best, use that method.
</p></li></ul></div><p>The best way forward here is to change the client application to
perform the query in a large batch method instead of performing a
large amount of small queries.

</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40002408"></a>7.6. Connection-based Admission Control</h2></div></div></div><p>As discussed earlier, there are several kinds of admission control.
This chapter only focuses on connection-based admission control,
where the number of optimized TCP sessions going through the Steelhead
appliance is larger than the licensed amount.
</p><p>The first symptom will be the alarm on the Steelhead appliance,
delivered to you via email or an SNMP trap. In the reports section,
the graph of the Connection History will show a flat line at the
time the Steelhead appliance was in connection-based admission
control:
</p><div class="figure"><a name="idp40002856"></a><p class="title"><b>Figure 7.17. Connection-based admission control for a 5520 model</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/05-operation-04-tcplimit.jpg" align="middle" alt="Connection-based admission control for a 5520 model"></td></tr></table></div></div></div><br class="figure-break"><p>At midnight, the number of optimized TCP sessions was below 15 000.
At around 08:00, it has risen to 15 000 and the optimization service
went into admission control. At 16:00, it has dropped back to below
15 000 and the optimization service came out of admission control.
</p><p>There are several reasons for entering admission control:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Sizing issues, caused by natural growth of the network or by a
  change in the protocols spoken.
</p></li><li class="listitem"><p>Malicious traffic, caused by clients which are consuming large
  amount of TCP sessions without any good reason.
</p></li><li class="listitem"><p>Failure to tear down TCP sessions, caused by clients or servers
  not properly taking down TCP sessions.
</p></li></ul></div><p>
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40004712"></a>7.6.1. Sizing issues</h3></div></div></div><p>In either of these two examples, the capacity of the current model is
not sufficient anymore and should either be upgraded using a higher
license or upgraded to a larger appliance if a license upgrade is not
possible.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40005032"></a>7.6.1.1. Natural growth</h4></div></div></div><p>Natural growth is related to an increase of the number of clients
behind the Steelhead appliance or to an increase in network-based
applications.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40005352"></a>7.6.1.2. Change in protocols spoken</h4></div></div></div><p>A change in the protocols spoken is related to a migration from one
protocol to another, like from POP3 to MAPI: POP3 uses short-lived
TCP sessions so for 100 clients you can live with 20 concurrent TCP
sessions for this, while MAPI uses at least 3 long-lived TCP sessions
so for 100 clients you suddenly need about 300 concurrent TCP
sessions already!
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40005672"></a>7.6.2. Malicious traffic</h3></div></div></div><p>Use the Current Connections overview to see if there are obvious
hosts to look at.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40005992"></a>7.6.2.1. Port scanners</h4></div></div></div><p>The behaviour of a TCP port scanner is that it sends out a large
amount of TCP SYN packets and waits for any answers. When a Steelhead
appliance sees these TCP SYN packets, it will try to setup optimized
TCP sessions and can run into Connection-based admission control.
</p><p>The way to find them is to run tcpdump and filter for packets with
the TCP SYN flag set with the command
<code class="computeroutput">tcpdump -ni lan0_0 -c 100 'tcp[tcpflags] &amp; tcp-syn != 0'</code>.
</p><p>The best practice is to create an in-path rule on the local Steelhead
appliance to not optimize any traffic from the host which is doing
the port scanning.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40011048"></a>7.6.2.2. How to determine the application</h4></div></div></div><p>Once the offending host has been determined, the next step will be to
identify the application which is sending the traffic.
</p><p>On Linux and Unix systems, this can be done with the command
<code class="computeroutput">lsof</code>:
</p><div class="figure"><a name="idp40011816"></a><p class="title"><b>Figure 7.18. Use "lsof" to determine which application is owning a TCP session</b></p><div class="figure-contents"><pre class="screen">$ lsof -n | grep 192.168.1.1:543
nc       5637 edwin     3u     IPv4   56433930    TCP  192.168.1.1:543-&gt;10.0.1.1:53036 (ES \
    TABLISHED)
</pre></div></div><br class="figure-break"><p>In this case the application
<span class="italics">nc</span>
which is using the TCP session between 10.0.1.1:53036 and
192.168.1.1:543.
</p><p>On Microsoft Windows, this can be done with the output of
<code class="computeroutput">netstat -no</code>
to determine the Process ID:
</p><div class="figure"><a name="idp40013096"></a><p class="title"><b>Figure 7.19. Use "netstat -no" to determine the Process ID of the application owning a TCP session</b></p><div class="figure-contents"><pre class="screen">C:\Users\edwin.MAVETJU&gt;netstat -no

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  [...]
  TCP    10.17.6.60:51749       173.194.79.125:5222    ESTABLISHED     1908
  [...]
</pre></div></div><br class="figure-break"><p>And the Windows Task Manager, add the PID to the output via View -&gt;
Select Columns, to determine the application:
</p><div class="figure"><a name="idp40013672"></a><p class="title"><b>Figure 7.20. Windows Task Manager with Process ID</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/07-scenarios-11-windowstaskmanager.png" align="middle" width="100%" alt="Windows Task Manager with Process ID"></td></tr></table></div></div></div><br class="figure-break"><p>In this case the application "pidgin.exe" which is using the TCP session
between 10.0.1.1:51749 and 173.194.79.125:5222.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40014632"></a>7.6.3. Failure to tear down TCP sessions</h3></div></div></div><p>A TCP session starts with a SYN, SYN/ACK and ACK handshake and is
terminated with a RST if things go wrong or with a FIN where both
side have successfully received all the traffic.
</p><p>Once the client or the server has sent a FIN, the TCP session is
in a half-closed state. Once both the client and the server have
sent a FIN, the TCP session is closed.
</p><p>As long as an optimized TCP session is in the half-closed state,
it counts towards the TCP session usage. If the FIN by the other
side is never send, the TCP session on the Steelhead appliance will
stay open indefinitely. In the Current Connection report, you
will then see an abnormal large amount of half-closed TCP sessions.
For example for a 250H model, it will show 20 optimized TCP sessions
and 200 half-closed TCP sessions.
</p><p>According to the RFC about TCP, the half-closed timer for TCP
sessions should expire after 2 times MSL (Maximum Segment Lifetime,
most common is 60 seconds). So to overcome this half-closed state
issue, the following CLI command can be entered to close the
half-closed TCP sessions after certain period:
<code class="computeroutput">protocol connection lan half-closed kill-timeout &lt;number of seconds&gt;</code>.
</p><p>If a half-closed TCP session is about to be terminated due to this
time-out, it will show up in the logs as:
</p><div class="figure"><a name="idp40015720"></a><p class="title"><b>Figure 7.21. A half-closed TCP is about to be terminated</b></p><div class="figure-contents"><pre class="screen">SH sport[431]: [io/outer/cons.INFO] 5 {192.168.0.1:1025 10.0.1.1:80} Kicking off half-clos \
    ed connection
</pre></div></div><p><br class="figure-break">
</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="Latency_Optimization"></a>Chapter 8. Latency Optimization</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp40016680">8.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp39999208">8.2. Introduction to Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40009192">8.3. CIFS Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40041640">8.4. CIFS Pre-population</a></span></dt><dt><span class="sect1"><a href="#idp40078696">8.5. NFS Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40069416">8.6. MAPI Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40080616">8.7. Windows Active Directory integration</a></span></dt><dt><span class="sect1"><a href="#idp40099816">8.8. MS-SQL Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40100584">8.9. FTP Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#latencyoptimization_httplatencyoptimization">8.10. HTTP Latency Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40174824">8.11. SSL Pre-optimization</a></span></dt><dt><span class="sect1"><a href="#idp40185896">8.12. SCA Latency Optimization</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40016680"></a>8.1. Index</h2></div></div></div><p>This chapter describes various aspects of the latency optimization features.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Introduction to latency optimization
</p></li><li class="listitem"><p>CIFS latency optimization
</p></li><li class="listitem"><p>NFS latency optimization
</p></li><li class="listitem"><p>MAPI latency optimization
</p></li><li class="listitem"><p>MAPI Outlook Anywhere latency optimization
</p></li><li class="listitem"><p>Lotus Notes optimization
</p></li><li class="listitem"><p>MS-SQL latency optimization
</p></li><li class="listitem"><p>FTP latency optimization
</p></li><li class="listitem"><p>HTTP latency optimization
</p></li><li class="listitem"><p>Citrix latency optimization
</p></li><li class="listitem"><p>FCIP latency optimization
</p></li><li class="listitem"><p>SSL pre-optimization
</p></li><li class="listitem"><p>Active Directory integration
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp39999208"></a>8.2. Introduction to Latency Optimization</h2></div></div></div><p>Latency Optimization is a WAN optimization method where the
optimization is happening on the application protocol transported
on top of the TCP layer.
</p><p>Latency Optimization is based on the behaviour seen between the
client and the server, to enable the Steelhead appliance to act on
behalf of the server or the client to improve the response time
for the client.
</p><p>Latency Optimization is often controlled by the client-side Steelhead
appliance, the capabilities are limited to the features available
on both the client-side and server-side Steelhead appliance.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp39999784"></a>8.2.1. Protocol improvements</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp39999976"></a>8.2.1.1. File system related protocol improvements</h4></div></div></div><p>For network file system related protocols, like CIFS, SMBv2, SMBv3
and NFS, the following improvements can be made:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Directory content prefetching, where the full contents of a
  directory and its meta-data is pre-read by the client-side Steelhead
  appliance when the client asks for the first directory entry.
</p></li><li class="listitem"><p>Read-ahead on read operations, where the next blocks of a file
  are read in advance by the client-side Steelhead appliance when
  the client asks for the first block of the file.
</p></li><li class="listitem"><p>Early acknowledgement on write operations, where the client-side
  Steelhead will acknowledge the writing of a block once it has
  transmitted the request over the wire but before the file server
  has remotely acknowledged it.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40000936"></a>8.2.1.2. FTP related protocol improvements</h4></div></div></div><p>There is no real protocol improvements, the only thing the FTP
latency optimization does do is keep track of the FTP data channel
to make sure that the traffic statistics are marked as such.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40001256"></a>8.2.1.3. MS-SQL related protocol improvements</h4></div></div></div><p>This is only for the database access as provided by MS-Access 2000.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40001576"></a>8.2.1.4. Email related protocol improvements</h4></div></div></div><p>For email related protocols, like MAPI and Lotus Notes, the following
improvements can be made:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Data store warming on attachments, where the client-side Steelhead
  appliance will read the attachment in advance of the request of
  the client.
</p></li><li class="listitem"><p>Read-ahead on attachments, where the client-side Steelhead appliance
  will read the next block of the attachment in advance of the
  request of the client.
</p></li><li class="listitem"><p>Write-behind on attachments, where the client-side Steelhead
  appliance will acknowledge the writing of the block of an attachment
  on behalf of the server.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40006696"></a>8.2.1.5. HTTP related protocol improvements</h4></div></div></div><p>For HTTP related protocols, the following improvements can be made:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Caching of objects where the client-side Steelhead appliance will
  keep static objects in its objects cache for as long as specified
  by the HTTP server.
</p></li><li class="listitem"><p>Pre-acking of non-changed objects, where the client-side Steelhead
  appliance will answer requests for static objects based as long
  as specified by the HTTP server.
</p></li><li class="listitem"><p>Prefetching of static objects based on the HTML code returned in
  the response from the server.
</p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40007656"></a>8.2.2. What can go wrong?</h3></div></div></div><p>Unlike TCP Optimization where the protocol is well documented,
vendor neutral and compatibility towards other TCP stacks is a
priority, latency optimization is done on protocols which are vendor
specific protocol, with client and server behaviour not always well
known, and with compatibility layers towards older versions of the
protocol.
</p><p>Latency optimization is done for specific server and specific client
actions and capabilities, based on the behaviour observed for certain
client-side actions. This behaviour can differ between different
versions of the protocol and even between different versions of the
client and server software.
</p><p>Moving away from the versions of the clients and servers supported
by the version of RiOS running on the Steelhead appliances could
cause problems in the latency optimization because of yet unsupported
changes in the client and server behaviour.
</p><p>Possible issues which can go wrong:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>New versions of the protocol which implement new features which
  are not compatible with the current protocol.
</p></li><li class="listitem"><p>New versions of the protocol which cannot fallback to earlier
  versions. For example, some SMB version 2 clients can fallback
  to the CIFS version 1 protocol.
</p></li><li class="listitem"><p>Servers which do not implement the protocol as expected, for
  example by returning statuses which could be considered valid for
  the client but are considered fatal for the latency optimization.
</p></li></ul></div><p>Before doing upgrades of the client and the server software for
protocols on which latency optimization is performed, please make
sure that the new protocols are supported by the software versions
running on Steelhead appliances.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40009192"></a>8.3. CIFS Latency Optimization</h2></div></div></div><p>CIFS latency optimization works in the following ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Directory index pre-fetching and directory meta-data subscription.
</p></li><li class="listitem"><p>File read-ahead and write-behind.
</p></li></ul></div><p>CIFS latency optimization does not work if:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The client or server operating system is not supported. For example
  the AS/400 CIFS client is not supported as a client.
</p></li><li class="listitem"><p>CIFS traffic is signed and the Active Directory integration failed.
  For example Active Directory user delegation for the CIFS server
  being optimized to is not enabled in the Active Directory
  configuration. Another example is that the Windows 2008 R2 server
  wasn't supported for Active Directory integration until RiOS
  version 6.1.
</p></li><li class="listitem"><p>If the server-side Steelhead appliance cannot get a lock on a
  file. This can happen on CIFS file servers which have this file
  locking as a non-default option like the NetApp file server.
</p></li><li class="listitem"><p>If the SMB version required by the client is not supported by the
  Steelhead appliance. For example SMBv2 is supported only from RiOS
  version 6.5 and SMBv3 is supported since RiOS version 8.5.
</p></li></ul></div><p>The result will be that the interactive performance of the CIFS
session will be like an unoptimized CIFS session and that during
file-transfers only data-reduction will happening.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40019368"></a>8.3.1. Setup of an optimized CIFS session</h3></div></div></div><p>When a Windows client attaches to a CIFS share, it will setup two
TCP sessions towards the server: One on port 445 and one on port
139. The one on port 139 will be terminated immediately if the one
on port 445 sets up properly.
</p><div class="figure"><a name="idp40019688"></a><p class="title"><b>Figure 8.1. Example of a TCP session on port 139 being terminated immediately</b></p><div class="figure-contents"><pre class="screen">CSH sport[6693]: [splice/probe.NOTICE] 0 {- -} (locl: 10.0.1.6:50499 clnt: 10.0.1.1:2686 s \
    erv: 192.168.1.1:139) No inner channel created for this probe splice
CSH sport[6693]: [clientsplice.ERR] - {clnt:10.0.1.1:2690 peer: 192.168.1.6:7800 serv:192. \
    168.1.1:139} End of stream reading connect result
</pre></div></div><br class="figure-break"><p>The first line gets logged when the TCP RST packet was received by
the client-side Steelhead appliance before the inner channel was
setup, the second line gets logged when the TCP session gets closed
by the server without having send or received any data over the TCP
connection.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40020264"></a>8.3.2. Characteristics of an optimized CIFS session:</h3></div></div></div><p>Since the Steelhead appliance is a WAN optimizer and not a network
file system, all file system related operations and retrieval of
data are still coming from the remote file servers. Requests for
the creation, opening, closing and removal of a file are still fully
going to the remote file server and answered by the remote file
server. The reading from and writing to files will be locally
acknowledged by the Steelhead appliance and then forwarded to the
remote file server.
</p><p>To display the response times in Wireshark go to the Statistics -&gt;
Service Response Times -&gt; SMB.
</p><div class="figure"><a name="idp40020712"></a><p class="title"><b>Figure 8.2. Wireshark Response time statistics for an unoptimized CIFS session</b></p><div class="figure-contents"><pre class="screen">=================================================================
SMB SRT Statistics:
Filter: 
Commands                   Calls    Min SRT    Max SRT    Avg SRT
Close                          1   0.133577   0.133577   0.133577
Open AndX                      1   0.133348   0.133348   0.133348
Read AndX                     18   0.368455   1.169644   0.902801
Tree Disconnect                2   0.133128   0.133643   0.133386
Negotiate Protocol             1   0.132288   0.132288   0.132288
Session Setup AndX             2   0.132696   0.135587   0.134142
Tree Connect AndX              2   0.133005   0.133278   0.133142
Query Information Disk         1   0.132691   0.132691   0.132691

Transaction2 Commands      Calls    Min SRT    Max SRT    Avg SRT
FIND_FIRST2                    2   0.136227   0.558457   0.347342
FIND_NEXT2                     4   0.133153   0.135975   0.134642
QUERY_FILE_INFO                1   0.133137   0.133137   0.133137
GET_DFS_REFERRAL               1   0.132695   0.132695   0.132695

NT Transaction Commands    Calls    Min SRT    Max SRT    Avg SRT
=================================================================
</pre></div></div><br class="figure-break"><p>All SMB commands take at least the 130 ms of the RTT time.
</p><div class="figure"><a name="idp40021352"></a><p class="title"><b>Figure 8.3. Wireshark Response time statistics for an optimized CIFS session</b></p><div class="figure-contents"><pre class="screen">=================================================================
SMB SRT Statistics:
Filter: 
Commands                   Calls    Min SRT    Max SRT    Avg SRT
Close                          1   0.000212   0.000212   0.000212
Open AndX                      1   0.134227   0.134227   0.134227
Read AndX                     18   0.354067   0.887230   0.646874
Tree Disconnect                1   0.000169   0.000169   0.000169
Negotiate Protocol             1   0.133985   0.133985   0.133985
Session Setup AndX             2   0.133340   0.136641   0.134991
Tree Connect AndX              2   0.132323   0.134432   0.133378
Query Information Disk         1   0.222203   0.222203   0.222203

Transaction2 Commands      Calls    Min SRT    Max SRT    Avg SRT
FIND_FIRST2                    2   0.287443   0.560205   0.423824
FIND_NEXT2                     4   0.000094   0.009760   0.004776
QUERY_FILE_INFO                1   0.134086   0.134086   0.134086
GET_DFS_REFERRAL               1   0.133184   0.133184   0.133184

NT Transaction Commands    Calls    Min SRT    Max SRT    Avg SRT
=================================================================
</pre></div></div><br class="figure-break"><p>Locally handled commands like the Close and Tree Disconnect return
immediately. Pre-fetched information like the Read AndX (18 * 0.646
seconds optimized versus 18 * 0.902 seconds unoptimized) and the
FIND_NEXT2 commands (2 * 0.423 + 4 * 0.004 seconds optimized versus
2 * 0.347 + 4 * 0.134 seconds unoptimized) take much less time.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40021928"></a>8.3.3. CIFS latency related issues</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40022120"></a>8.3.3.1. Skewed statistics due to read-ahead in the Windows Explorer</h4></div></div></div><p>The preview feature in the Windows Explorer and the Mac OS X Finder
only read parts of the file to get the meta-data of it, but the
read-ahead functionality in the latency optimization service will
read much more than ever will be requested by the client, therefore
the statistics for that TCP option or for the that protocol might
be skewed.
</p><div class="figure"><a name="idp40022504"></a><p class="title"><b>Figure 8.4. Skewed statistics on the client-side Steelhead appliance because of read-ahead in the Windows Explorer.</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptimization-cifsskew.png" align="middle" width="100%" alt="Skewed statistics on the client-side Steelhead appliance because of read-ahead in the Windows Explorer."></td></tr></table></div></div></div><br class="figure-break"><p>This behaviour might be seen on the client-side Steelhead where the amount of
WAN traffic is significant larger than the amount of LAN traffic, or when
comparing the client-side and server-side LAN traffic where the amount of LAN
traffic on the server-side is significantly larger than on the client-side.
</p><div class="figure"><a name="idp40023464"></a><p class="title"><b>Figure 8.5. Comparison of the client-side and server-side LAN traffic for CIFS latency optimization</b></p><div class="figure-contents"><pre class="screen">XXX
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40023912"></a>8.3.3.2. CIFS read-ahead failure</h4></div></div></div><p>The CIFS read-ahead feature works great when reading a file
sequentially, but when the data is accessed randomly it will cause
a large amount of unnecessary reads to the server and data transfers
to the client-side Steelhead appliance. If the extensions of the
files which are randomly accessed are known, it is possible to put
them in a blacklist for the CIFS read-ahead feature:
</p><div class="figure"><a name="idp40024232"></a><p class="title"><b>Figure 8.6. Disable the CIFS read-ahead feature for files with the extension "myob"</b></p><div class="figure-contents"><pre class="screen">CSH (config) # protocol cifs big-read-blklst add myob
You must restart the optimization service for your changes to take effect.
CSH (config) # show protocol cifs big-read-blklst
  myob
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40024680"></a>8.3.3.3. Slow file servers</h4></div></div></div><p>When a request to a file server takes more than 500 milliseconds,
the Steelhead appliance will log a message about this:
</p><div class="figure"><a name="idp40025000"></a><p class="title"><b>Figure 8.7. Heads up that the replies from the file servers are slow</b></p><div class="figure-contents"><pre class="screen">CSH sport[27756]: [smbcfe.NOTICE] 379355 {10.0.1.1:49202 192.168.1.1:445} Request nt_creat \
    e_andx still waiting after 0.715137 sec, mid=2496 queue_cnt=1 queue_wait_state=1 enque \
    ue time=1347517794.630794 
CSH sport[27756]: [smbcfe.NOTICE] 379355 {10.0.1.1:49202 192.168.1.1:445} Request nt_creat \
    e_andx still waiting after 1.715144 sec, mid=2496 queue_cnt=1 queue_wait_state=1 enque \
    ue time=1347517794.630794 
CSH sport[27756]: [smbcfe.NOTICE] 379355 {10.0.1.1:49202 192.168.1.1:445} Request nt_creat \
    e_andx still waiting after 2.715170 sec, mid=2496 queue_cnt=1 queue_wait_state=1 enque \
    ue time=1347517794.630794 
CSH sport[27756]: [smbcfe.NOTICE] 379355 {10.0.1.1:49202 192.168.1.1:445} Request nt_creat \
    e_andx still waiting after 4.715130 sec, mid=2496 queue_cnt=1 queue_wait_state=1 enque \
    ue time=1347517794.630794 
</pre></div></div><br class="figure-break"><p>The request types can be
<span class="italics">nt_create_andx</span>,
<span class="italics">nt_read_andx</span>
and
<span class="italics">transaction2</span>.
</p><p>If this happens on the server-side Steelhead appliance, then check
the load on the file server and any speed/duplex issues on the path
towards the file server.
</p><p>If this only happens on the client-side Steelhead appliance, then
check the path towards the server-side Steelhead appliance.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40026664"></a>8.3.3.4. Write-behind feature stops</h4></div></div></div><p>The Write-behind feature stops if the CIFS share is more than 98%
full and will be enabled again when the CIFS share is less than 92%
full.
</p><div class="figure"><a name="idp40039336"></a><p class="title"><b>Figure 8.8. CIFS write-behind stopping because of a full disk.</b></p><div class="figure-contents"><pre class="screen">CSH sport[14140]: [smbcfe.NOTICE] 679459 {10.0.1.1:3346 192.168.1.1:445} Disk usage reache \
    d threshold (2048 MB free) on share \FOO\BAR, disabling write/setfile pre-acking
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40039848"></a>8.3.3.5. Oplock failure</h4></div></div></div><p>An oplock is a feature which deals with the opening of the same
file by multiple clients. When one client has a lock on a file, any
other clients cannot get a lock until the first client has released
the lock. If the server-side Steelhead appliance deals with the
lock, it will be able to do better read-ahead optimization.
</p><p>If the server-side Steelhead appliance cannot obtain the oplock,
it will not perform read-ahead on the file and the CIFS performance
to the client will suffer from it:
</p><div class="figure"><a name="idp40040296"></a><p class="title"><b>Figure 8.9. Unable to obtain oplock on a file</b></p><div class="figure-contents"><pre class="screen">CSH sport[22371]: [smbcfe.INFO] 2720339 {10.0.1.1:11847 192.168.1.1:445} process_create_an \
    dx_response file was not granted any oplock File: \Share\book.pdf Desired Access : 0x2 \
    0089 FID : 0x4012
</pre></div></div><br class="figure-break"><p>Possible reasons are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The file server does not support oplocks. Please check the
  configuration of the file server.
</p></li><li class="listitem"><p>The file server was accessed by a remote client whose CIFS session
  did not get optimized or which CIFS session did not go through
  this Steelhead appliance.
</p></li><li class="listitem"><p>The file was opened on the console of the file server.
</p></li></ul></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40041640"></a>8.4. CIFS Pre-population</h2></div></div></div><p>Strictly speaking CIFS pre-population is not a latency optimization
feature but a data store warming feature. The feature overcomes the
initial cold data transfer of new files read from a remote CIFS
share by going through the remote CIFS share during the night and
performing the initial cold transfer. As a result the next morning
the data store is warm for the contents of the new files from the remote
CIFS share and the users immediately experience the full optimization.
</p><p>The configuration of the CIFS pre-population requires name of the
remote CIFS share, the username and the password to access the
remote CIFS share. All files and directories on that remote CIFS
share should be readable by that user.
</p><div class="figure"><a name="idp40042088"></a><p class="title"><b>Figure 8.10. CIFS pre-population configuration</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptimization-cifsprepop-configuration.png" align="middle" width="100%" alt="CIFS pre-population configuration"></td></tr></table></div></div></div><br class="figure-break"><p>The optimization service on the client-side Steelhead appliance
needs to see the naked SYN of the CIFS session. The TCP SYN packet
will leave the primary interface and should go arrive on the LAN
interface where it will be processed as a normal TCP session to be
optimized and go through the in-path rules.
</p><p>When modifying the CIFS pre-population share from the CLI, the share
needs to be entered like a Windows path with backslashes. Because
the backslash has a different meaning on the CLI, it is required
to escape the backslashes. This is the way to escape the name for
the share
<code class="computeroutput">\\192.168.1.1\admin\prepop</code>
is
<code class="computeroutput">\\\\192.168.1.1\\admin\\prepop</code>.
</p><p>The CIFS pre-population process consists of three steps: The registration
of the CIFS share, the initial syncing and the periodical syncing.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40043880"></a>8.4.1. The registration of the CIFS share</h3></div></div></div><p>During the registration the CIFS pre-population process will connect
to the remote server, login and map the share.
</p><div class="figure"><a name="idp40044200"></a><p class="title"><b>Figure 8.11. Successful registration of the CIFS pre-population session</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [rcud/req/.NOTICE] - {- -} Received action: /rbt/rcu/action/share_config
CSH rcud[5555]: [rcud/main/.INFO] - {- -} Adding share:  Share : \\192.168.1.1\admin\prepo \
    p Server name : 192.168.1.1 Server path : \\192.168.1.1\admin\prepop Server port : 0 S \
    hare Mode : 3 Sync freq : 604800
CSH rcud[5555]: [rcud/main/.INFO] - {- -} Share parameters verified locally. Reply to mgmt \
    d
CSH rcud[5555]: [rcud/main/.INFO] - {- -} succ=0, msg=Share registration in progress ...
CSH rcud[5555]: [policy_manager.INFO] - {- -}  @ [126]: Saved policies
CSH rcud[5555]: [rcud/main/.INFO] - {- -} For Share : \\192.168.1.1\admin\prepop
CSH mgmtd[3544]: [mgmtd.NOTICE]: Share registration in progress ... 
CSH webasd[6087]: [web.INFO]: web: Received return code 0, return message 'Share registrat \
    ion in progress ...\n' from gclSession pygs_handle_any_response 
CSH rcud[5555]: [rcud/share/.INFO] - {- -} Share \\192.168.1.1\admin\prepop Enter dispatch \
    _cmd(): cmd=REGISTER_SHARE
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} dispatch_cmd() START CMD : REGISTER_SHARE Sha \
    re : \\192.168.1.1\admin\prepop
CSH sport[2946]: [splice/client.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} init client 10.0 \
    .1.5:47055 server 192.168.1.1:139 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connec \
    ted: yes 
CSH sport[2946]: [splice/client.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Start flowing, l \
    port 40281, rport 7800, OPOL_NORMAL, NAGLE_NEVER, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_ \
    ID_NONE, TPTOPT_NONE(0x0), TRPY_NONE 
CSH rcud[5555]: [cifsclient.INFO] - {- -}  @ [320]: Connected to server 192.168.1.1
CSH webasd[6087]: [web.INFO]: web: User admin viewing setupPrepop page. 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[0] = PC NETWORK PROGRAM 1.0 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[1] = MICROSOFT NETWORKS 1.03 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[2] = MICROSOFT NETWORKS 3.0 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[3] = LANMAN1.0 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[4] = LM1.2X002 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[5] = DOS LANMAN2.1 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[6] = NT LANMAN 1.0 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[7] = NT LM 0.12 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[8] = Samba 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect[9] = RCU SMB 1 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} rcu dialect index = 9 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect in response before: 6 
CSH sport[2946]: [cifs_neg.INFO] 14 {- -} Dialect in response after: 9 
CSH sport[2946]: [smbmux_cfe/scons.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Creating pars \
    er type: SMB_PARSER 
CSH sport[2946]: [smbmux_cfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Creating client-sid \
    e SMB parser 
CSH sport[2946]: [smbcfe.INFO] 14 {- -} RTT time: sec:0, usec:305000 
CSH sport[2946]: [smbcfe.INFO] 14 {- -} MAX metadata cache time: 2.000000 sec, data cache  \
    time 20.000000 sec 
CSH sport[2946]: [smbcfe.INFO] 14 {- -} Idle FOI timeouts : 15250 No oplock timeout : 7625 \
     
CSH sport[2946]: [smbcfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Client Native OS Versio \
    n: bytes:  52 69 4f 53                                       RiOS 
CSH sport[2946]: [smbcfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Client Native LAN Manag \
    er: bytes  52 42 54 2d 43 69 66 73   43 6c 69 65 6e 74       RBT-Cifs  Client 
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH sport[2946]: [smbcfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Client Native OS Versio \
    n: bytes:  52 69 4f 53                                       RiOS 
CSH sport[2946]: [smbcfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Client Native LAN Manag \
    er: bytes  52 42 54 2d 43 69 66 73   43 6c 69 65 6e 74       RBT-Cifs  Client 
CSH sport[2946]: [smbcfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Server Native OS Versio \
    n: unix: Unix 
CSH sport[2946]: [smbcfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Server Native LAN Manag \
    er: Samba: Samba 
CSH sport[2946]: [smbsign_cfe.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} Shutting down sign \
    ing blade for this connection. Reason - Signing feature disabled on SFE. 
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH sport[2946]: [smbcfe/ccons.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} SMBConsumer::eof( \
    ) this=0x52d2b30, qlen=0 
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed successfully  CMD : REGISTER_SHARE  \
    Share : \\192.168.1.1\admin\prepop
CSH sport[2946]: [smbcfe/scons.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} SMBConsumer::eof( \
    ) this=0x52d2c08, qlen=0 
CSH sport[2946]: [splice/client.INFO] 14 {10.0.1.5:47055 192.168.1.1:139} fini client 10.0 \
    .1.5:47055 server 192.168.1.1:139 cfe 10.0.1.6:40281 sfe 192.168.1.6:7800 app CIFS 
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Share Registered
</pre></div></div><br class="figure-break"><p>It shows up as a normal CIFS session on TCP port 139 or 445 and it
should complete with a successful completion:
<code class="computeroutput">Completed successfully  CMD : REGISTER_SHARE Share : \\192.168.1.1\admin\prepop</code>.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40045160"></a>8.4.2. Failure of a registration</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40045352"></a>8.4.2.1. Invalid hostname in the remote share</h4></div></div></div><p>The host portion of the remote share can be entered by IP addresses
or by hostname, for example
<span class="italics">\\192.168.1.1\admin</span>
or
<span class="italics">\\share.example.com\admin</span>.
</p><p>If the hostname cannot be resolved, the logs show the error
<code class="computeroutput">Host not found (authoritative)</code>:
</p><div class="figure"><a name="idp40046632"></a><p class="title"><b>Figure 8.12. Registration failed due to an unknown hostname</b></p><div class="figure-contents"><pre class="screen">CSH mgmtd[3544]: [mgmtd.NOTICE]: Share registration in progress ... 
CSH webasd[6087]: [web.INFO]: web: Received return code 0, return message 'Share registrat \
    ion in progress ...\n' from gclSession pygs_handle_any_response 
CSH rcud[5555]: [rcud/share/.INFO] - {- -} Share \\foo.example.com\test Enter dispatch_cmd \
    (): cmd=REGISTER_SHARE
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} dispatch_cmd() START CMD : REGISTER_SHARE Sha \
    re : \\foo.example.com\test
CSH webasd[6087]: [web.INFO]: web: User admin viewing setupPrepop page. 
CSH rcud[5555]: [cifsclient.NOTICE] - {- -}  @ [233]: Host not found (authoritative)
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} kerberos authentication on port 139 Failed,  \
    trying NTLMSSP...
CSH rcud[5555]: [cifsclient.NOTICE] - {- -}  @ [233]: Host not found (authoritative)
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Logon to port: 139 Failed: 
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Retrying alternate CIFS port...
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH rcud[5555]: [cifsclient.NOTICE] - {- -}  @ [233]: Host not found (authoritative)
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} kerberos authentication on port 445 Failed,  \
    trying NTLMSSP...
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH rcud[5555]: [cifsclient.NOTICE] - {- -}  @ [233]: Host not found (authoritative)
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Network error. Success, error no : 0 =&gt; erro \
    r_info.h:235
CSH rcud[5555]: [rcud/client/.WARN] - {- -} run_rbcp_cmd_v3 : Connecting to server failed. \
      Server : foo.example.com Share : \\foo.example.com\test
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} record_start_to_status_file(): Received unkno \
    wn command: 0
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -}  got unknown cmd:0
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed with Error   CMD : REGISTER_SHARE S \
    hare : \\foo.example.com\test
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Share has error
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40047144"></a>8.4.2.2. Remote host doesn't respond</h4></div></div></div><p>If the host doesn't exist or doesn't respond, the logs show the error:
<code class="computeroutput">Network error. Connection reset by peer, error no : 104</code>:
</p><div class="figure"><a name="idp40056040"></a><p class="title"><b>Figure 8.13. Registration failed due to an non-responding remote server</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH last message repeated 2 times
CSH sport[2946]: [segstore/peertable.INFO] - {- -} Attempting to write stat table to offse \
    t 1. Num pages: 9 
CSH sport[2946]: [segstore/peertable.INFO] - {- -} Write stat table complete, error 0 
CSH kernel: [intercept.WARN] Detected SYN retransmits for a PFSv3 connection.  Potential r \
    easons include the remote host or network being down, probe filtering, and asymmetric  \
    routing.
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH kernel: [intercept.WARN] Detected SYN retransmits for a PFSv3 connection.  Potential r \
    easons include the remote host or network being down, probe filtering, and asymmetric  \
    routing.
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH last message repeated 3 times
CSH rcud[5555]: [cifsclient.INFO] - {- -}  @ [320]: Connected to server 192.168.1.2
CSH rcud[5555]: [cifsclient.NOTICE] - {- -}  @ [53]: Send failed
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Logon to port: 139 Failed: 
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Retrying alternate CIFS port...
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH kernel: [intercept.WARN] Detected SYN retransmits for a PFSv3 connection.  Potential r \
    easons include the remote host or network being down, probe filtering, and asymmetric  \
    routing.
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH kernel: [intercept.WARN] Detected SYN retransmits for a PFSv3 connection.  Potential r \
    easons include the remote host or network being down, probe filtering, and asymmetric  \
    routing.
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH last message repeated 4 times
CSH rcud[5555]: [cifsclient.INFO] - {- -}  @ [320]: Connected to server 192.168.1.2
CSH rcud[5555]: [cifsclient.NOTICE] - {- -}  @ [53]: Send failed
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Network error. Connection reset by peer, err \
    or no : 104
CSH rcud[5555]: [rcud/client/.WARN] - {- -} run_rbcp_cmd_v3 : Connecting to server failed. \
      Server : 192.168.1.2 Share : \\192.168.1.2\admin\prepop
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} record_start_to_status_file(): Received unkno \
    wn command: 0
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -}  got unknown cmd:0
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed with Error   CMD : REGISTER_SHARE S \
    hare : \\192.168.1.2\admin\prepop
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Share has error
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40056616"></a>8.4.2.3. Authentication failed</h4></div></div></div><p>If the username or password provided is incorrect, the logs will show
<code class="computeroutput">Session setup failed. Status code : NT_STATUS_LOGON_FAILURE</code>:
</p><div class="figure"><a name="idp40057256"></a><p class="title"><b>Figure 8.14. Registration failed due to a login failure</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Session setup failed. Status code : NT_STATU \
    S_LOGON_FAILURE =&gt; ntlm_session_impl.cc:131
CSH rcud[5555]: [rcud/client/.WARN] - {- -} run_rbcp_cmd_v3 : Connecting to server failed. \
      Server : 192.168.1.1 Share : \\192.168.1.1\prepop
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed with Error   CMD : REGISTER_SHARE S \
    hare : \\192.168.1.1\prepop
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Share has error
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40057704"></a>8.4.2.4. Invalid path on remote server</h4></div></div></div><p>If the path on the remote server does not exist, the logs will show
<code class="computeroutput">Failed to map share, because network path is unavailable</code>:
</p><div class="figure"><a name="idp40058344"></a><p class="title"><b>Figure 8.15. Registration failed due to a login failure</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Registration in progress...
CSH rcud[5555]: [rcud/client/.NOTICE] - {- -} Could not connect to share \\192.168.1.1\pre \
    pop. Tree connect failed. Status code : Failed to map share, because network path is u \
    navailable =&gt; tree_connect_impl.cc:90
CSH rcud[5555]: [rcud/client/.WARN] - {- -} run_rbcp_cmd_v3 : Connecting to server failed. \
      Server : 192.168.1.1 Share : \\192.168.1.1\prepop
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} record_start_to_status_file(): Received unkno \
    wn command: 0
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -}  got unknown cmd:0
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed with Error   CMD : REGISTER_SHARE S \
    hare : \\192.168.1.1\prepop
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Share has error
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40058792"></a>8.4.3. The syncing of data</h3></div></div></div><p>When the registration has completed successfully, the syncing needs
to be enabled. From the CLI this can be done with the command
<code class="computeroutput">prepop share modify remote-path &lt;share&gt; syncing true</code>.
</p><p>In this example, the remote share has two files in it:
<span class="italics">\foo.doc</span>
and
<span class="italics">\bar\bar.pdf</span>.
</p><div class="figure"><a name="idp40060200"></a><p class="title"><b>Figure 8.16. A successful sync</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [crawler.INFO] - {- -} Get initial copy started at Fri 2014-Jan-03 21:29:0 \
    1
CSH rcud[5555]: [cifsfs.INFO] - {- -}  @ [199]: Base cifs sync directory = '\prepop'
CSH sport[2946]: [smbcfe/file.INFO] 17 {10.0.1.5:47717 192.168.1.1:139} process_trans2_fin \
    dfirst_response() has search attr : 23 
CSH sport[2946]: [smbcfe/file.INFO] 17 {10.0.1.5:47717 192.168.1.1:139} process_trans2_fin \
    dfirst_response() has search attr : 23 
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \foo.doc
CSH last message repeated 4 times
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Get initial copy in progress s \
    ince Fri Jan  3 21:28:59 2014
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \foo.doc
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \bar\bar.pdf
CSH last message repeated 4 times
CSH rcud[5555]: [rcud/req/.NOTICE] - {- -} Received action: /rbt/rcu/action/share_config
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -}  Syncing changed for Share : \\192.168.1.1\ad \
    min\prepop Old syncing : 1 New syncing: 0
CSH rcud[5555]: [rcud/main/.INFO] - {- -} succ=0, msg=Share modify succeeded
CSH mgmtd[3544]: [mgmtd.NOTICE]: Share modify succeeded 
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \bar\bar.pdf
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Get initial copy in progress s \
    ince Fri Jan  3 21:28:59 2014
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Get initial copy in progress s \
    ince Fri Jan  3 21:28:59 2014
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \bar\bar.pdf
CSH rcud[5555]: [crawler/sync_lists.INFO] - {- -}  @ [194]: Synced file : \foo.doc
CSH rcud[5555]: [crawler/sync_lists.INFO] - {- -}  @ [194]: Synced file : \bar\bar.pdf
CSH sport[2946]: [smbcfe/file.NOTICE] 17 {10.0.1.5:47717 192.168.1.1:139}  File::add_trans \
    2_findnext_data() last entries dont match : \ 
CSH rcud[5555]: [crawler.INFO] - {- -} Get initial copy completed successfully at Fri 2014 \
    -Jan-03 21:29:14
CSH rcud[5555]: [crawler.INFO] - {- -} Received 2 files, 0 objects have error. (34125972 b \
    ytes were received in 13.7194 seconds at 19.8993 Mbps)
CSH sport[2946]: [smbcfe/ccons.INFO] 17 {10.0.1.5:47717 192.168.1.1:139} SMBConsumer::eof( \
    ) this=0x52f0130, qlen=0 
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed successfully  CMD : GET_INITIAL_COP \
    Y Share : \\192.168.1.1\admin\prepop
CSH sport[2946]: [smbcfe/scons.INFO] 17 {10.0.1.5:47717 192.168.1.1:139} SMBConsumer::eof( \
    ) this=0x52f0208, qlen=0 
CSH sport[2946]: [splice/client.INFO] 17 {10.0.1.5:47717 192.168.1.1:139} fini client 10.0 \
    .1.5:47717 server 192.168.1.1:139 cfe 10.0.1.6:40284 sfe 192.168.1.6:7800 app CIFS 
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Share idle
</pre></div></div><br class="figure-break"><p>The
<span class="italics">Initial Copy</span>
log file shows it as:
</p><div class="figure"><a name="idp40061096"></a><p class="title"><b>Figure 8.17. Log file of the Initial Copy</b></p><div class="figure-contents"><pre class="screen">Get initial copy started at Fri 2014-Jan-03 21:29:01
Synced file : \foo.doc
Synced file : \bar\bar.pdf
Get initial copy completed successfully at Fri 2014-Jan-03 21:29:14
Received 2 files, 0 objects have error. (34125972 bytes were received in 13.7194 seconds a \
    t 19.8993 Mbps)
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40061544"></a>8.4.4. Failure of syncing of data</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40061736"></a>8.4.4.1. Client-side Steelhead doesn't see the CIFS session</h4></div></div></div><p>In previous RiOS versions, if the client-side Steelhead appliance
did not see the CIFS pre-population session, the CIFS pre-population
process would warn about this and abort.
</p><p>With the new implementation this doesn't happen anymore. The best
way to check is to initiate a manual sync and confirm that the TCP
session is optimized. This can be done with the command
<code class="computeroutput">prepop share manual-sync remote-path &lt;path&gt;</code>
</p><div class="figure"><a name="idp40062504"></a><p class="title"><b>Figure 8.18. Manually starting a CIFS pre-population sync</b></p><div class="figure-contents"><pre class="screen">CSH (config) # prepop share manual-sync remote-path \\\\192.168.1.1\\admin\\prepop 
Share manual sync in progress...
</pre></div></div><br class="figure-break"><p>This can be caused by:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The cable of the primary interface is attached to the WAN router
  instead of to the LAN switch. If this is on design, consider
  connecting the auxiliary interface to the LAN switch and a routing
  statement to force traffic to the CIFS servers to go via the
  gateway on the auxiliary interface.
</p></li><li class="listitem"><p>In case of a parallel cluster, the traffic from the LAN switch
  does not go via this Steelhead appliance. The way around this
  could be to configure the data store synchronization and to enable
  the CIFS pre-population on the Steelhead appliance through which
  the naked SYN normally goes.
</p></li><li class="listitem"><p>In-path rules on the Steelhead appliance prevent optimization
  from this traffic. The way around this would be to allow optimization
  from the Steelhead appliance primary interface to the CIFS servers.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40071976"></a>8.4.4.2. Unable to read the files</h4></div></div></div><p>When the CIFS pre-population process cannot read a certain file or
directory, it will mark it as failed.
</p><p>In this example, the file
<span class="italics">bar\bar.pdf </span>
is not readable by the specified user.
</p><div class="figure"><a name="idp40072680"></a><p class="title"><b>Figure 8.19. Unable to read some of the files</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [crawler.INFO] - {- -} Get initial copy started at Fri 2014-Jan-03 21:23:5 \
    7
CSH rcud[5555]: [cifsfs.INFO] - {- -}  @ [199]: Base cifs sync directory = '\prepop'
CSH sport[2946]: [smbcfe/file.INFO] 16 {10.0.1.5:47574 192.168.1.1:139} process_trans2_fin \
    dfirst_response() has search attr : 23 
CSH sport[2946]: [smbcfe/file.INFO] 16 {10.0.1.5:47574 192.168.1.1:139} process_trans2_fin \
    dfirst_response() has search attr : 23 
CSH rcud[5555]: [sync_obj.ERR] - {- -}  @ [59]: Nt Create AndX failed. Status code : NT_ST \
    ATUS_ACCESS_DENIED =&gt; nt_create_andx_impl.cc:94. For \bar\bar.pdf
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \foo.doc
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Get initial copy in progress s \
    ince Fri Jan  3 21:23:55 2014
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \foo.doc
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Get initial copy in progress s \
    ince Fri Jan  3 21:23:55 2014
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \foo.doc
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \foo.doc
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \bar\bar.pdf
CSH rcud[5555]: [crawler/sync_lists.INFO] - {- -}  @ [194]: Synced file : \foo.doc
CSH rcud[5555]: [crawler/sync_lists.INFO] - {- -}  @ [194]: Synced file : \bar\bar.pdf
CSH rcud[5555]: [rcud/client/.ERR] - {- -} Sync error. 
CSH rcud[5555]: [rcud/client/.ERR] - {- -} Failed to sync share \\192.168.1.1\admin. 
CSH rcud[5555]: [crawler.INFO] - {- -} Get initial copy completed with error.
CSH rcud[5555]: [crawler.INFO] - {- -} Received 1 files, 1 objects have error. (17062986 b \
    ytes were received in 11.5794 seconds at 11.7885 Mbps)
CSH sport[2946]: [smbcfe.INFO] 16 {10.0.1.5:47574 192.168.1.1:139} clearing pending req:   \
    uid: 0x64 tid: 0x1 pid: 0x15b3 mid: 0x11f omid: 0x11f smid: 0x11f cmd: close subcmd: 0 \
     infolvl: 0 fid: 0x1cb5 status: 1 len 45 time: 1388744649.518695 sec 
CSH sport[2946]: [smbcfe/ccons.INFO] 16 {10.0.1.5:47574 192.168.1.1:139} SMBConsumer::eof( \
    ) this=0x52f1530, qlen=0 
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed with Error   CMD : GET_INITIAL_COPY \
     Share : \\192.168.1.1\admin\prepop
</pre></div></div><br class="figure-break"><p>The Initial Copy log shows:
</p><div class="figure"><a name="idp40073320"></a><p class="title"><b>Figure 8.20. Initial copy failed due to reading errors</b></p><div class="figure-contents"><pre class="screen">Get initial copy started at Fri 2014-Jan-03 21:23:57
Synced file : \foo.doc
Error in syncing file \bar\bar.pdf
Get initial copy completed with error.
Received 1 files, 1 objects have error. (17062986 bytes were received in 11.5794 seconds a \
    t 11.7885 Mbps)
</pre></div></div><br class="figure-break"><p>To prevent the failure of one or two files which couldn't be
synchronized to be seen as a full failure of the Initial Sync, a
failure ignore percentage can be configured:
</p><div class="figure"><a name="idp40073896"></a><p class="title"><b>Figure 8.21. CIFS pre-population failure settings</b></p><div class="figure-contents"><pre class="screen">CSH (config) # show prepop settings 
Maximum Mpx Count Percentage:    40
Ignore Percentage:    0
CSH (config) # prepop settings ignore-pct 10
Processed RCU configuration command.
CSH (config) # show prepop settings 
Maximum Mpx Count Percentage:    40
Ignore Percentage:    10
</pre></div></div><br class="figure-break"><p>Now up to 10% of the files to be synced can fail and the initial
sync is still considered to be successful.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40074472"></a>8.4.5. Periodical syncing</h3></div></div></div><p>After the initial syncing, the periodical syncing checks for new
files and updated files.
</p><div class="figure"><a name="idp40074792"></a><p class="title"><b>Figure 8.22. No new files found during the periodical sync</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [crawler.INFO] - {- -} Sync started at Fri 2014-Jan-03 21:33:15
CSH rcud[5555]: [cifsfs.INFO] - {- -}  @ [199]: Base cifs sync directory = '\prepop'
CSH sport[2946]: [smbcfe/file.INFO] 19 {10.0.1.5:47840 192.168.1.1:139} process_trans2_fin \
    dfirst_response() has search attr : 23 
CSH sport[2946]: [smbcfe/file.INFO] 19 {10.0.1.5:47840 192.168.1.1:139} process_trans2_fin \
    dfirst_response() has search attr : 23 
CSH sport[2946]: [smbcfe/file.NOTICE] 19 {10.0.1.5:47840 192.168.1.1:139}  File::add_trans \
    2_findnext_data() last entries dont match : \ 
CSH rcud[5555]: [crawler.INFO] - {- -} Sync completed successfully at Fri 2014-Jan-03 21:3 \
    3:16
CSH rcud[5555]: [crawler.INFO] - {- -} Received 0 files, 0 objects have error. (0 bytes we \
    re received in 1.26024 seconds at 0 Mbps)
CSH sport[2946]: [smbcfe/ccons.INFO] 19 {10.0.1.5:47840 192.168.1.1:139} SMBConsumer::eof( \
    ) this=0x5494530, qlen=0 
CSH rcud[5555]: [rcud/share/.NOTICE] - {- -} Completed successfully  CMD : START_SYNC Shar \
    e : \\192.168.1.1\admin\prepop
CSH sport[2946]: [smbcfe/scons.INFO] 19 {10.0.1.5:47840 192.168.1.1:139} SMBConsumer::eof( \
    ) this=0x5494608, qlen=0 
CSH sport[2946]: [splice/client.INFO] 19 {10.0.1.5:47840 192.168.1.1:139} fini client 10.0 \
    .1.5:47840 server 192.168.1.1:139 cfe 10.0.1.6:40286 sfe 192.168.1.6:7800 app CIFS 
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : Share idle
</pre></div></div><br class="figure-break"><p>The
<span class="italics">Last Sync</span>
log files show as:
</p><div class="figure"><a name="idp40075688"></a><p class="title"><b>Figure 8.23. The Last Sync log files shows no new files found</b></p><div class="figure-contents"><pre class="screen">Sync started at Fri 2014-Jan-03 21:33:15
Sync completed successfully at Fri 2014-Jan-03 21:33:16
Received 0 files, 0 objects have error. (0 bytes were received in 1.26024 seconds at 0 Mbp \
    s)
</pre></div></div><br class="figure-break"><p>If the timestamp of a remote file has changed or a new file has
been detected, it will be transferred:
</p><div class="figure"><a name="idp40076392"></a><p class="title"><b>Figure 8.24. New files found during the periodical sync</b></p><div class="figure-contents"><pre class="screen">CSH rcud[5555]: [crawler.INFO] - {- -} Sync started at Fri 2014-Jan-03 21:34:15
CSH rcud[5555]: [cifsfs.INFO] - {- -}  @ [199]: Base cifs sync directory = '\prepop'
CSH sport[2946]: [smbcfe/file.INFO] 20 {10.0.1.5:47863 192.168.1.1:139} process_trans2_fin \
    dfirst_response() has search attr : 23 
CSH last message repeated 2 times
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \quux\quux.mbox
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \quux\quux.mbox
CSH rcud[5555]: [rcud/share/.INFO] - {- -}  Status string : START_SYNC in progress since F \
    ri Jan  3 21:34:12 2014
CSH rcud[5555]: [sync_file.INFO] - {- -}  @ [207]: Syncing file \quux\quux.mbox
CSH last message repeated 3 times
CSH rcud[5555]: [crawler/sync_lists.INFO] - {- -}  @ [194]: Synced file : \quux\quux.mbox
CSH sport[2946]: [smbcfe/file.NOTICE] 20 {10.0.1.5:47863 192.168.1.1:139}  File::add_trans \
    2_findnext_data() last entries dont match : \ 
CSH rcud[5555]: [crawler.INFO] - {- -} Sync completed successfully at Fri 2014-Jan-03 21:3 \
    4:23
CSH rcud[5555]: [crawler.INFO] - {- -} Received 1 files, 0 objects have error. (17062986 b \
    ytes were received in 7.97558 seconds at 17.1152 Mbps)
</pre></div></div><br class="figure-break"><p>The
<span class="italics">Last Sync</span>
log files show as:
</p><div class="figure"><a name="idp40077288"></a><p class="title"><b>Figure 8.25. The Last Sync log files shows new or updated files found</b></p><div class="figure-contents"><pre class="screen">Sync started at Fri 2014-Jan-03 21:34:15
Synced file : \quux\quux.mbox
Sync completed successfully at Fri 2014-Jan-03 21:34:23
Received 1 files, 0 objects have error. (17062986 bytes were received in 7.97558 seconds a \
    t 17.1152 Mbps)
</pre></div></div><br class="figure-break"><p>The status of the CIFS pre-population process can be determined with
the command
<code class="computeroutput">show prepop stats shares</code>:
</p><div class="figure"><a name="idp40078184"></a><p class="title"><b>Figure 8.26. Status of the pre-population shares during syncing and when the share is idle</b></p><div class="figure-contents"><pre class="screen">CSH # show prepop stats shares
+=============================
| Prepopulation name: '\\192.168.1.1\admin\prepop'
|
| ----- Statistics -----
|   Receiving                : NONE
|   Files Received           : 1
|   Directories Received     : 0
|   Bytes Received           : 17062986
CSH # show prepop stats shares
+=============================
| Prepopulation name: '\\192.168.1.1\admin\prepop'
|
| ----- Statistics -----
|   No action in progress
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40078696"></a>8.5. NFS Latency Optimization</h2></div></div></div><p>NFS latency optimization works in the following ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Directory index pre-fetching.
</p></li><li class="listitem"><p>File read-ahead and write-behind.
</p></li></ul></div><p>NFS latency optimization does not work if:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The NFS version spoken is not NFS version 3.
</p><div class="figure"><a name="idp40079912"></a><p class="title"><b>Figure 8.27. NFS optimization does not work for NFS version 4</b></p><div class="figure-contents"><pre class="screen">  SH sport[24148]: [SunRpc-CFE/SunRpcParser.WARN] - {10.0.1.1:1023 192.168.1.1:2049} NFSv4 \
     traffic detected between client 10.0.1.1 and server 192.168.1.1
  SH sport[24148]: [SunRpc-CFE/SunRpcParser.WARN] - {10.0.1.1:1022 192.168.1.1:2049} NFSv4 \
     traffic detected between client 10.0.1.1 and server 192.168.1.1
  statsd[23848]: [statsd.NOTICE]: Alarm triggered for rising error for event nfs_v2_v4 
</pre></div></div><p><br class="figure-break">
</p></li><li class="listitem"><p>If the NFS Authentication method is set to Kerberos authentication.
</p><div class="figure"><a name="idp40068456"></a><p class="title"><b>Figure 8.28. NFS optimization does not work when using Kerberos authentication</b></p><div class="figure-contents"><pre class="screen">  SH sport[24148]: [SunRpc-CFE/NfsV3Parser.NOTICE] - {10.0.1.1:1023 192.168.1.1:2049} SunR \
    pcParser: Client Call has an authenticationflavor which we do not support. Shutting La \
    tencyOptimization for this connection.
</pre></div></div><p><br class="figure-break">
</p></li></ul></div><p>NFS Funkiness:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>There is a 15 second directory meta-data timer[SOURCE: NFS standard]
  which can show files which have been removed or not show files
  which have been created on other machines. This is NFS behaviour,
  not Steelhead appliance specific behaviour.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40069416"></a>8.6. MAPI Latency Optimization</h2></div></div></div><p>MAPI latency optimization works in the following ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Attachment read-ahead and write-behind.
</p></li><li class="listitem"><p>MAPI pre-population for attachment warming.
</p></li></ul></div><p>MAPI latency optimization does not work if:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>MAPI traffic is encrypted and the Active Directory integration
  has not been setup or is temporary suspended.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40070632"></a>8.6.1. Setup of an optimized MAPI session</h3></div></div></div><p>The Outlook client sets up a TCP session on port 135 to the Exchange
servers port mapper to find out on which TCP port the Exchange service
is running. The client-side Steelhead appliance shows this session
as EPM, Exchange Port Mapper. The server-side Steelhead appliance
will receive the answer from the EPM service, rewrite the TCP port
to port 7830 and forwards the answer to the client-side Steelhead
appliance. Then the client-side Steelhead appliance will tell the
Outlook client to use port 7830 and sets up a hidden in-path rule
which states that all traffic towards the Exchange server on TCP
port 7830 has to go to the current server-side Steelhead appliance.
</p><p>The Outlook client will setup three TCP sessions to the Exchange
service on port 7830, they are intercepted by the client-side
Steelhead appliance and forwarded to the configured server-side
Steelhead appliance. There they are forwarded to the Exchange server
on the TCP port received in the answer from the Exchange Port Mapper.
</p><p>By default three TCP sessions are setup, one will be added for every
shared calendar.
</p><p>The hidden in-path rule is for all new TCP sessions towards the
Exchange server and is parsed before the normal in-path rules. To
disable this in-path rule, use the CLI command
<code class="computeroutput">in-path probe-mapi-data</code>
command. Use the command
<code class="computeroutput">show in-path probe-mapi-data</code>
to see the current setting of this feature.
</p><div class="figure"><a name="idp40080104"></a><p class="title"><b>Figure 8.29. See the MAPI probing option</b></p><div class="figure-contents"><pre class="screen">CSH (config) # in-path probe-mapi-data 
You must restart the optimization service for your changes to take effect.
CSH (config) # show in-path probe-mapi-data
Probe MAPI connections to learn VLAN info: yes 
</pre></div></div><br class="figure-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40080616"></a>8.7. Windows Active Directory integration</h2></div></div></div><p>Integration into the Windows Active Directory infrastructure is
needed to seamlessly integrate in the optimization of encrypted
MAPI and signed CIFS sessions.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40080936"></a>8.7.1. The prerequisites for Active Directory integration</h3></div></div></div><p>Before the Steelhead appliances can do this integration, they need
to be joined to the Active Directory domain. Before this can happen
you need to take care of several things:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The primary interface of the Steelhead appliance should be
  configured and have access to the network where the Domain
  Controllers are in.
</p></li><li class="listitem"><p>The hostname configured on the Steelhead appliance should be 15
  characters or less.
</p></li><li class="listitem"><p>The hostname configured on the Steelhead appliance should not yet
  exist in the Active Directory configuration.
</p></li><li class="listitem"><p>One of the domain names configured on the Steelhead appliance
  should contain the Active Directory domain name.
</p></li><li class="listitem"><p>The DNS servers configured in the Steelhead appliance should be
  able to resolve the Active Directory domain name.
</p></li><li class="listitem"><p>In DNS, the IP address of the primary interface of the Steelhead
  appliance needs to be available as a PTR record:
</p><div class="figure"><a name="idp40082536"></a><p class="title"><b>Figure 8.30. 192.168.1.6 points to ssh-primary.example.org</b></p><div class="figure-contents"><pre class="screen">[~] edwin@t43&gt;dig -x 192.168.1.6

; &lt;&lt;&gt;&gt; DiG 9.8.1-P1 &lt;&lt;&gt;&gt; -x 192.168.1.6
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 18322
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1

;; QUESTION SECTION:
;6.1.168.192.in-addr.arpa.      IN      PTR

;; ANSWER SECTION:
6.1.168.192.in-addr.arpa. 3583  IN      PTR     ssh-primary.example.org.

;; AUTHORITY SECTION:
1.168.192.in-addr.arpa.  3583   IN      NS      ns0.example.org.

;; ADDITIONAL SECTION:
ns0.example.org.        3583    IN      A       192.168.1.1

;; Query time: 12 msec
;; SERVER: 192.168.1.1#53(192.168.1.1)
;; WHEN: Fri Oct 26 20:13:39 2012
;; MSG SIZE  rcvd: 142
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>The clock on the Steelhead appliances needs to be in sync with
  the clock of the AD Domain Controller. If the Domain Controllers
  are synchronized against the same NTP server as the Steelhead appliance,
  then this will be fine. If the Domain Controllers are not synchronized
  against NTP servers, it will be best to configure the NTP servers
  on the Steelhead appliances to the Domain Controller:
</p><div class="figure"><a name="idp40083176"></a><p class="title"><b>Figure 8.31. NTP servers configured are the local Domain Controllers</b></p><div class="figure-contents"><pre class="screen">ntp enable
ntp server 192.168.1.1 enable
ntp server 192.168.1.1 version "4"
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>DNS should contain the LDAP SRV records for the domain to join.
  So if the domain is example.com, the following DNS SRV records
  should exist: _ldap._tcp.example.org.
</p><div class="figure"><a name="idp40083880"></a><p class="title"><b>Figure 8.32. DNS SRV records for _ldap._tcp.example.org</b></p><div class="figure-contents"><pre class="screen">[~] edwin@t43&gt;dig _ldap._tcp.example.org srv
; &lt;&lt;&gt;&gt; DiG 9.8.1-P1 &lt;&lt;&gt;&gt; _ldap._tcp.example.org srv
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 5339
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; QUESTION SECTION:
;_ldap._tcp.example.org.         IN      SRV

;; ANSWER SECTION:
_ldap._tcp.example.org.      600 IN      SRV     0 100 389 dc.example.org.

;; ADDITIONAL SECTION:
dc.example.org.             3600 IN      A       192.168.1.1

;; Query time: 719 msec
;; SERVER: 192.168.1.1#53(192.168.1.1)
;; WHEN: Fri Oct 26 20:59:16 2012
;; MSG SIZE  rcvd: 2105
</pre></div></div><br class="figure-break"><p>  This shows that the domain controllers for the Active Directory
  domain example.org can be found at dc.example.org.
</p></li><li class="listitem"><p>Access to an Active Directory account with domain join privileges.
</p></li></ul></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40097000"></a>8.7.1.1. Possible issues during the domain join</h4></div></div></div><p>Here are several examples of failures of the domain join.
</p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40097384"></a>8.7.1.1.1. Clock skew issues</h5></div></div></div><p>If the clocks on the Steelhead appliance and on the domain controller
are too far apart, the domain join will fail with the following
error:
</p><div class="figure"><a name="idp40097704"></a><p class="title"><b>Figure 8.33. Domain join failed because of a clock skew between the Steelhead appliance and the Domain Controller</b></p><div class="figure-contents"><pre class="screen">mgmtd[4232]: [mgmtd.NOTICE]: Join domain in progress...
rcud[5610]: [rcud/main/.INFO] - {- -} Waiting for join domain to finish ...
rcud[5610]: [rcud/main/.ERR] - {- -} Join domain failed. Failed to join domain: Error: Uns \
    pecified GSS failure. Minor code may provide more information : Clock skew too great
mgmtd[4232]: [mgmtd.ERR]: Domain configuration failed: 1 Join failed
</pre></div></div><br class="figure-break"></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40098152"></a>8.7.1.1.2. DNS related issues</h5></div></div></div><p>If the Active Directory domain cannot be found in DNS, the domain
join will fail with the following error:
</p><div class="figure"><a name="idp40098472"></a><p class="title"><b>Figure 8.34. Domain join failed because of DNS related issues</b></p><div class="figure-contents"><pre class="screen">mgmtd[4232]: [mgmtd.NOTICE]: Join domain in progress...
rcud[5610]: [rcud/main/.INFO] - {- -} Waiting for join domain to finish ...
rcud[4637]: [rcud/main/.ERR] - {- -} Failed to join domain: Error: Operations error. Possi \
    ble DNS misconfiguration. 
mgmtd[4232]: [mgmtd.ERR]: Domain configuration failed: 1 Join failed
</pre></div></div><br class="figure-break"></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40098984"></a>8.7.1.1.3. Active Directory object already exists</h5></div></div></div><p>If the object for the Steelhead appliance already exist in Active
Directory and the joining account does not have privileges to replace
old objects, the domain join will fail with the following error:
</p><div class="figure"><a name="idp40099304"></a><p class="title"><b>Figure 8.35. Domain join failed because the object in Active Directory already exists</b></p><div class="figure-contents"><pre class="screen">mgmtd[4232]: [mgmtd.NOTICE]: Join domain in progress...
rcud[5610]: [rcud/main/.INFO] - {- -} Waiting for join domain to finish ...
rcud[14701]: [rcud/main/.ERR] - {- -} Failed to join domain: Failed to set account flags f \
    or machine account (NT_STATUS_ACCESS_DENIED)
mgmtd[4232]: [mgmtd.ERR]: Domain configuration failed: 1 Join failed
</pre></div></div><br class="figure-break"></div></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40099816"></a>8.8. MS-SQL Latency Optimization</h2></div></div></div><p>The optimization of the MS-SQL protocol is only supports the MS-SQL
2000 protocol. The reason for this is because the encrypted login
session for later versions of the MS-SQL protocol is not decodable
and thus is the optimization service not able to identify the
database to connect to.
</p><p>Before enabling this feature please contact Riverbed Professional
Services for an investigation in the improvements of this data.
</p><p>Since RiOS 8.5 the MS-SQL latency optimization feature has been
removed from the GUI.

</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40100584"></a>8.9. FTP Latency Optimization</h2></div></div></div><p>There is not really FTP latency optimization happening, the only
reason it gets intercepted and processed is to get the FTP Data
channel statistics correct and to get the synchronization between
the data channel and command channel correctly.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40100904"></a>8.9.1. How it works</h3></div></div></div><p>In the lifetime of the FTP Command Channel, the Steelhead appliance
checks for the PORT commands to see which TCP sessions are used for
the FTP Data Channel. Once known, the server-side Steelhead appliance
(for active FTP) or the client-side Steelhead appliance (for passive
FTP) will setup a hidden fixed target in-path rule so that the
traffic goes through the two Steelhead appliances and gets identified
as FTP Data traffic.
</p><p>From RiOS version 6.1 this hidden in-path rule does not get created
by default anymore.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40101352"></a>8.9.2. Data channel and command channel synchronization</h3></div></div></div><p>According to FTP standard, the transfer of a file goes as follows:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The client sends a PORT command over the command channel which
  informs the server to which IP address and TCP port it should
  connect to.
</p></li><li class="listitem"><p>The server sets up a TCP session for the data channel, transfers
  the data over it and closes the data channel.
</p></li><li class="listitem"><p>The server sends a 226 response code, which means that the file
  has been transferred.
</p></li><li class="listitem"><p>The client knows now that the whole file has been transferred.
</p></li></ul></div><p>
</p><p>With a Steelhead appliance in between, the server-side Steelhead
appliance might still be encoding the data from the server when the
server closes the data channel and sends the 226 response code to
the client. That early 226 response code might confuse the client
and makes it close the data channel while it is still receiving the
data.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40102824"></a>8.9.3. Where things can go wrong</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40103016"></a>8.9.3.1. FTP Data Channel not recognized as such</h4></div></div></div><p>If Enhanced Auto Discovery is not enabled and there are multiple
Steelhead appliances in a serial deployment at the FTP server side,
it is possible that the Steelhead appliance with the termination
of the optimized FTP Data channel is not the one which terminates
the optimized FTP Command channel. That will prevent the traffic
statistics to be correctly identified as FTP data.
</p><div class="figure"><a name="idp40103336"></a><p class="title"><b>Figure 8.36. FTP Data reported as unknown protocols</b></p><div class="figure-contents"><pre class="screen">!! Graphics file XXX.png not found
XXX Lots of unknown data which should have been FTP Data
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="latencyoptimization_httplatencyoptimization"></a>8.10. HTTP Latency Optimization</h2></div></div></div><p>HTTP latency optimization works in various ways:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>HTTP meta-data caching.
</p></li><li class="listitem"><p>HTTP object prefetching.
</p></li></ul></div><p>HTTP latency optimization doesn't work when:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>When the HTTP request method is not POST nor GET, for example
  WEBDAV related requests.
</p></li><li class="listitem"><p>When the format of the requested URL or the referrer field is invalid.
</p></li><li class="listitem"><p>When there are multiple HTTP requests in a single TCP session and
  one of them fails, the rest of the HTTP requests won't be optimized.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40105640"></a>8.10.1. How HTTP Latency Optimization work</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40105832"></a>8.10.1.1. HTTP Meta-Data Caching</h4></div></div></div><p>A HTTP Reply header can contain the expected life-time of an object:
</p><div class="figure"><a name="idp40106152"></a><p class="title"><b>Figure 8.37. An HTTP Reply header</b></p><div class="figure-contents"><pre class="screen">HTTP/1.0 200 OK
Content-Type: image/png
Last-Modified: Fri, 15 Jul 2011 23:21:33 GMT
Date: Mon, 14 Nov 2011 21:41:50 GMT
Expires: Mon, 15 Nov 2011 21:41:50 GMT
Cache-Control: public, max-age=86400
X-Content-Type-Options: nosniff
Server: example.mavetju.org
Content-Length: 35636
X-XSS-Protection: 1; mode=block
</pre></div></div><br class="figure-break"><p>The following meta-data can be seen on this response:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The modification time of the object is
<span class="italics">Fri, 15 Jul 2011 23:21:33 GMT</span>.
</p></li><li class="listitem"><p>The date on the server is
<span class="italics">Mon, 14 Nov 2011 21:41:50 GMT</span>.
</p></li><li class="listitem"><p>The object can be used in public caches until
<span class="italics">Mon, 15 Nov 2011 21:41:50 GMT</span>.
  This is an old notation style.
</p></li><li class="listitem"><p>The object can be used in public caches for
<span class="italics">86400 seconds</span>
  (or 1 day). This is the new notation style.
</p></li></ul></div><p>There are several ways for a web-browser to get an object:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>From its browser cache. From the last time the object was requested,
  the browser was told that it could use it for 86400 seconds.
</p></li><li class="listitem"><p>After the 86400 seconds, the object in the browser-cache has
  become stale and the web-browser will ask the web-server to send
  the object again if it has been changed since its
<span class="italics">Last-Modified</span>
  date. If it has been changed, the web server will send the new
  object. If it has not been changed, it will respond with a HTTP
  304 response and a new
<span class="italics">Cache-Control</span>
  line which states that the stale object can be used for another
  86400 seconds. This is a low-bandwidth browser-cache mechanism
  for refreshing objects.
</p><p>  This answer can either go all the way to the web-server or can
  be answered by a local web-cache or a server-side web-cache.
</p><div class="figure"><a name="idp40122280"></a><p class="title"><b>Figure 8.38. A 304 response code</b></p><div class="figure-contents"><pre class="screen">GET /foo.png HTTP/1.1
Host: example.mavetju.org
User-Agent: Mozilla/5.0 (X11; FreeBSD i386; rv:22.0) Gecko/20100101 Firefox/22.0
Referer: http://example.mavetju.org/
Connection: keep-alive
If-Modified-Since: Mon, 10 Mar 2008 18:47:44 GMT

HTTP/1.1 304 Not Modified
Date: Sun, 29 Sep 2013 17:06:08 GMT
Server: Apache/2.2.3 (FreeBSD)
Connection: close
Expires: Sun, 29 Sep 2013 21:08:31 GMT
Cache-Control: public, max-age=86400
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>The web-browser can ask the web-server to send the object forcing
  it to come from the web-server without allowing it to be served
  from any caches.
</p></li></ul></div><p>
</p><div class="figure"><a name="idp40122984"></a><p class="title"><b>Figure 8.39. Network with Web-browsers, web-caches and web-servers</b></p><div class="figure-contents"><pre class="screen">browser -- SH -- WAN -- SH -- cache -- WAN -- SH -- server cache -- server
</pre></div></div><br class="figure-break"><p>When the web-browser asks for an object and the Steelhead appliance
optimizes the HTTP session, it can keep track of the meta-data. If
the client asks for an object refresh via an
<span class="italics">If-Modified-Since</span>
and the Steelhead appliance has already learned from a request via
another client that the object hasn't changed and a new expiration
time has been given, the Steelhead appliance can answer the web-browser
that the object is still valid and provide a new expiration time.
That doesn't save only bandwidth but also reduces the round trip
time.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40123880"></a>8.10.1.2. HTTP Object Prefetching</h4></div></div></div><p>If the object requested by the web-server is of the type text/html,
it can contain embedded objects like images, style sheet and
JavaScript files.
</p><p>If the Steelhead appliance parses the returned text/html object and
fetches the embedded objects from the web-server before the web-browser
has a chance to request them, then the Steelhead appliance can serve
the objects to the web-browser locally instead of the web-browser
having to go all the way to the web-server for it.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40124328"></a>8.10.2. Troubleshooting HTTP latency optimization</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40124520"></a>8.10.2.1. Response of the first request takes too long</h4></div></div></div><p>Unlike proxy servers where the TCP session is terminated on the
proxy server, an optimized TCP session is setup to the remote server
first before the latency optimization kicks in. Thus the first
request will take longer to setup, especially if the Full Transparency
WAN visibility is used for the inner channel.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40124840"></a>8.10.2.2. Invalid URL or referrer field</h4></div></div></div><p>The most common issue is that a requested URL or given referrer
contains a space. While technically this is a violation of the
syntax, the space should be replaced by a %20, a lot of scripts or
web-browsers send it, while web-servers and proxies have been taught
to deal with the issue.
</p><div class="figure"><a name="idp40129320"></a><p class="title"><b>Figure 8.40. An invalid URL error messages due to spaces in the URL</b></p><div class="figure-contents"><pre class="screen">CSH sport[24250]: [http/client.INFO] 3277788 {10.0.1.1:24750 192.168.1.1:80} Request parse \
     error, code = HTTP_ERR_HEADER_LINE GET /foo /bar.png HTTP:/1.1\013\010Referrer: http: \
    //example.mavetju.org/\013\010Host: example.mavetju.org\013\010
</pre></div></div><br class="figure-break"><p>By default, the Steelhead appliances will throw an error and not
perform HTTP latency on this TCP session anymore, but with the
command
<code class="computeroutput">protocol http space-in-uri enable</code>
it will allow this and process the request anyway.
</p><div class="figure"><a name="idp40130280"></a><p class="title"><b>Figure 8.41. Output of the command "show protocol http"</b></p><div class="figure-contents"><pre class="screen">CSH (config) # protocol http space-in-uri enable
You must restart the optimization service for your changes to take effect.
CSH (config) # show protocol http internal
[..]
Allow Parsing Space in URI:          yes
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40130728"></a>8.10.2.3. What kind of HTTP latency optimization is performed?</h4></div></div></div><p>When performing the HTTP latency optimization, the client-side
Steelhead will add a line in the HTTP response header:
</p><div class="figure"><a name="idp40131112"></a><p class="title"><b>Figure 8.42. X-RBT-Optimized header</b></p><div class="figure-contents"><pre class="screen">X-RBT-Optimized-By: CSH (RiOS 6.1.5b) PT
</pre></div></div><br class="figure-break"><p>The first part of the string is the name of the client-side Steelhead
performing the latency optimization, the middle part contains the
RiOS version running on the Steelhead appliance and the third part
contains the optimization scheme code.
</p><div class="table"><a name="idp40131688"></a><p class="title"><b>Table 8.1. HTTP Optimization Scheme Code</b></p><div class="table-contents"><table summary="HTTP Optimization Scheme Code" border="1"><colgroup><col><col><col></colgroup><tbody><tr><td>UL</td><td>URL Learning</td><td>The optimization service learns the order of URLs being requested for a certain base URL and will request the next ones once a base URL gets requested</td></tr><tr><td>PP</td><td>Parse-and-Prefetch</td><td>The optimization service is parsing the return HTML code for objects it can request in advance</td></tr><tr><td>PT</td><td>Object Prefetch Table (OPT)</td><td>Response is served from the local Steelhead HTTP cache</td></tr><tr><td>MC</td><td>Metadata Response</td><td> </td></tr><tr><td>RA</td><td>Reuse-Auth</td><td> </td></tr><tr><td>FN</td><td>Force-NTLM</td><td> </td></tr><tr><td>SA</td><td>Strip-Auth-hdr</td><td> </td></tr><tr><td>GR</td><td>Gratuitous-401</td><td>The client-side Steelhead appliance replied with a 401 or 403</td></tr><tr><td>SC</td><td>Strip-Compress</td><td>The header field "Accept-Encoding: gzip, deflate" has been removed</td></tr><tr><td>IC</td><td>Insert-Cookie</td><td> </td></tr><tr><td>IK</td><td>Insert-Keep-alive</td><td>Despite that the client didn't request it, the optimization service inserted a "Connection: Keep-Alive" in the request</td></tr><tr><td>IF</td><td>Inflight-Cache (Stream Splitting)</td><td> </td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40137256"></a>8.10.2.4. What kind of internal decisions for HTTP optimization are made?</h4></div></div></div><p>Further information about the internals of the HTTP optimization
can be enabled with the command
<code class="computeroutput">protocol http x-debug enable</code>.
</p><div class="figure"><a name="idp40146152"></a><p class="title"><b>Figure 8.43. Enabling the HTTP debugging feature</b></p><div class="figure-contents"><pre class="screen">CSH (config) # protocol http x-debug enable
CSH (config) # show protocol http internal
Insert Pre-Fetch X-Header:                      yes 
Insert X-RBT-Debug header:                      yes 
[...]
</pre></div></div><br class="figure-break"><p>In the HTTP response, this will add a new line:
<code class="computeroutput">X-RBT-Debug</code>.
</p><div class="figure"><a name="idp40147048"></a><p class="title"><b>Figure 8.44. The X-RBT-Debug line</b></p><div class="figure-contents"><pre class="screen">X-RBT-Debug: 0x81,SPIP,FPSF
</pre></div></div><br class="figure-break"><p>The first field,
<span class="italics">0x81</span>,
is the optimization scheme and its value represents a bitmask which
explains which features are enabled for the request:
</p><div class="table"><a name="idp40147880"></a><p class="title"><b>Table 8.2. Optimization scheme bit mask</b></p><div class="table-contents"><table summary="Optimization scheme bit mask" border="1"><colgroup><col><col></colgroup><tbody><tr><td>0x0001</td><td>URL Learning</td></tr><tr><td>0x0002</td><td>Parse and Prefetch</td></tr><tr><td>0x0004</td><td>Object Prefetch Table</td></tr><tr><td>0x0008</td><td>Reuse NTLM Authentication</td></tr><tr><td>0x0010</td><td>Force Negotation NTLM</td></tr><tr><td>0x0020</td><td>Strip authentication header</td></tr><tr><td>0x0040</td><td>Gratuitous 401</td></tr><tr><td>0x0080</td><td>Strip Compression</td></tr><tr><td>0x0100</td><td>Insert Cookie</td></tr><tr><td>0x0200</td><td>Insert keep-alive</td></tr><tr><td>0x010000</td><td>Frontpage Extensions</td></tr><tr><td>0x020000</td><td>WebDAV support</td></tr><tr><td>0x040000</td><td>FSS HTTP</td></tr></tbody></table></div></div><br class="table-break"><p>So for the value of 0x81 the features used are
<span class="italics">Strip Compression</span>
and
<span class="italics">URL Learning</span>.
</p><p>This value is also seen in the logs for that TCP session:
</p><div class="figure"><a name="idp40153320"></a><p class="title"><b>Figure 8.45. HTTP Optimization scheme</b></p><div class="figure-contents"><pre class="screen">CSH sport[16611]: [http/client.INFO] 6629561 {10.0.1.1:65310 192.168.1.1:80} codec flow co \
    ntrol is disabled 
CSH sport[16611]: [http/client.INFO] 6629561 {10.0.1.1:65310 192.168.1.1:80} opt_scheme_ u \
    pdated to 129 from auto config table 
</pre></div></div><br class="figure-break"><p>In this example, the 129 decimal is 0x81 hexadecimal, relates to the
same features as seen earlier.
</p><p>The next fields are the actions and decisions of the HTTP optimization
code. The four letters are part of a code:
</p><p>The first letter is the status:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="bold"><strong>S</strong></span>
from Success
</p></li><li class="listitem"><p>
<span class="bold"><strong>F</strong></span>
from Failure
</p></li><li class="listitem"><p>
<span class="bold"><strong>I </strong></span>
from Information
</p></li></ul></div><p>
</p><p>The second letter is the category:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="bold"><strong>C</strong></span>
from Cache
</p></li><li class="listitem"><p>
<span class="bold"><strong>P</strong></span>
from Prefetch
</p></li><li class="listitem"><p>
<span class="bold"><strong>M</strong></span>
from Miscellaneous
</p></li></ul></div><p>
</p><p>The third and the fourth letter are the action and specific reason
codes.
</p><p>So the code
<span class="italics">SPIP</span>
would be a success from the prefetching functionality and the code
<span class="italics">FPSF</span>
would be a failure for the prefetching functionality.
</p><div class="table"><a name="idp40158184"></a><p class="title"><b>Table 8.3. Cache related category</b></p><div class="table-contents"><table summary="Cache related category" border="1"><colgroup><col><col></colgroup><tbody><tr><td>FCAA</td><td>Failed to cache because the content is authenticated but cache_without_auth is off</td></tr><tr><td>FCAE</td><td>Failed to cache because the extension is not present in the cache extension list</td></tr><tr><td>FCAI</td><td>Invalid request, e.g., absence of host header</td></tr><tr><td>FCAL</td><td>The body is too big to cache</td></tr><tr><td>FCAS</td><td>The remaining lifetime is too short to cache</td></tr><tr><td>FCAU</td><td>Not allowed to cache, e.g., cache-control header</td></tr><tr><td>FCS2</td><td>The current cache entry only has the header</td></tr><tr><td>FCSA</td><td>Failed to serve due to the absence of Accept-Encoding header</td></tr><tr><td>FCSC</td><td>The Steelhead appliance is not configured to serve full body cache</td></tr><tr><td>FCSD</td><td>Failed to serve from cache because of a different encoding</td></tr><tr><td>FCSE</td><td>Failed to serve from cache because the extension is not present in the cache extension list</td></tr><tr><td>FCSI</td><td>Invalid request, e.g., absence of host header</td></tr><tr><td>FCSM</td><td>Miscellaneous reason</td></tr><tr><td>FCSN</td><td>The object is not present in cache</td></tr><tr><td>FCSU</td><td>The object is not allowed to cache, e.g., cache-control header</td></tr><tr><td>FCSX</td><td>Failed to serve cached object because it has been expired</td></tr><tr><td>SCAN</td><td>The object is added to cache</td></tr><tr><td>SCAR</td><td>The object has been refreshed in the cache</td></tr></tbody></table></div></div><br class="table-break"><div class="table"><a name="idp40164712"></a><p class="title"><b>Table 8.4. Prefetch related category</b></p><div class="table-contents"><table summary="Prefetch related category" border="1"><colgroup><col><col></colgroup><tbody><tr><td>FPIA</td><td>Failed to initiate prefetching because authentication is required. OR, no response has been received through this connection so the Steelhead appliance is not yet aware if authentication is needed or not</td></tr><tr><td>FPID</td><td>Failed to add the URL to the APT database</td></tr><tr><td>FPIE</td><td>Didn't initiate prefetching because inner channel is being terminated</td></tr><tr><td>FPIH</td><td>Failed to initiate prefetching because a header is missing (most likely cookie header)</td></tr><tr><td>FPIM</td><td>Reached the maximum prefetch limit</td></tr><tr><td>FPLF</td><td>Failed to learn the object because APT is full</td></tr><tr><td>FPLH</td><td>Failed to learn the object due to the absence of the header</td></tr><tr><td>FPLM</td><td>Failed to learn the object because the Steelhead appliance is occupying its MAX MEM</td></tr><tr><td>FPSA</td><td>Authentication is required</td></tr><tr><td>FPSE</td><td>APT request was EOF'ed</td></tr><tr><td>FPSF</td><td>APT was not found for the object</td></tr><tr><td>FPSN</td><td>APT request was not sent</td></tr><tr><td>FPSR</td><td>Received error status code for APT request</td></tr><tr><td>IPGP</td><td>APT is generated via PnP</td></tr><tr><td>IPGU</td><td>APT is generated via URL Learning</td></tr><tr><td>IPLP</td><td>The object has been purged from UL APT tree</td></tr><tr><td>IPSC</td><td>The prefetched object is served through callback, i.e., the request was halted for the APT response to come.</td></tr><tr><td>SPIP</td><td>This object triggered prefetching</td></tr><tr><td>SPLN</td><td>The object was learned by UL</td></tr><tr><td>SPPP</td><td>The page is parsed for PnP</td></tr></tbody></table></div></div><br class="table-break"><div class="table"><a name="idp40171688"></a><p class="title"><b>Table 8.5. Miscellaneous category</b></p><div class="table-contents"><table summary="Miscellaneous category" border="1"><colgroup><col><col></colgroup><tbody><tr><td>FM4S</td><td>Received a 401 despite that strip authentication took the strip header off</td></tr><tr><td>FMGS</td><td>Failed to store the 401 response because the body is shorter than specified</td></tr><tr><td>IMAA</td><td>Expecting an authenticaton header in the request but it was absent</td></tr><tr><td>IMAC</td><td>Stopped storing the body for processing because the Steelhead appliance is in a LOW MEM state</td></tr><tr><td>IMBR</td><td>This is a base request</td></tr><tr><td>IMIR</td><td>The Steelhead appliance inserted a referer header</td></tr><tr><td>SMGN</td><td>The 401/407 response is newly added</td></tr><tr><td>SMGR</td><td>The 401/407 response cache entry is refreshed</td></tr></tbody></table></div></div><br class="table-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40174824"></a>8.11. SSL Pre-optimization</h2></div></div></div><p>Unlike the other protocols in this chapter, SSL pre-optimization
is a transport layer feature: Instead of the protocol being
encapsulated inside the TCP layer, the protocol is being encapsulated
inside the SSL layer and then encapsulated inside the TCP layer.
</p><div class="figure"><a name="idp40175144"></a><p class="title"><b>Figure 8.46. SSL encapsulated HTTP traffic</b></p><div class="figure-contents"><pre class="screen">                        .---------------.
                        | HTTP protocol |
      .---------------. |---------------|
      | HTTP protocol | | SSL protocol  |
      |---------------| |---------------|
      | TCP protocol  | | TCP protocol  |
      |---------------| |---------------|
      | IP protocol   | | IP protocol   |
      '---------------' '---------------'
</pre></div></div><br class="figure-break"><p>SSL encapsulation is not limited to HTTP only. It is used for the
encryption of many protocols like HTTP, IMAP, POP3 and SMTP.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40175720"></a>8.11.1. Configuration on the Steelhead appliances</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40175912"></a>8.11.1.1. Obtain an SSL license</h4></div></div></div><p>To be able to optimize SSL encrypted traffic, SSL licenses are
required to enable this feature. You can request them for free from
the Riverbed Support website.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40176232"></a>8.11.1.2. Configuring SSL peering</h4></div></div></div><p>This is described in the
<a class="xref" href="#operation_security_sslsecurepeering" title="5.22.3.2. SSL Secure Peering">SSL Secure Peering</a> section in the
<span class="italics">Operational Related Issues</span>
chapter.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40177000"></a>8.11.1.3. Server Certificate and Server Private Key</h4></div></div></div><p>To be able to optimize traffic towards an SSL server, you will need
to obtain the SSL certificate and the SSL private key of the server.
</p><p>In this scenario, the company Example Dot Com has a Root CA and an
intermediate CA. To get this working the server-side Steelhead
appliance needs to know about the CA certificate, the intermediate
CA certificate and the server private key and certificate.
</p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40177448"></a>8.11.1.3.1. Import of the server private key and certificate with the issuer certificate missing.</h5></div></div></div><p>If the issuer certificate of the server certificate is not known
on the Steelhead appliance, then you need to obtain that issuer
certificate too.
</p><div class="figure"><a name="idp40177768"></a><p class="title"><b>Figure 8.47. Missing issuer certificate during the import of the server key and certificate</b></p><div class="figure-contents"><pre class="screen">webasd[7055]: [web.INFO]: web: User admin viewing setupServiceProtocolsSSLMain page. 
sport[7402]: [sport/mgmt/ssl.INFO] - {- -} getting SSL discovered servers information 
sport[7402]: [sport/mgmt/ssl.INFO] - {- -} getting SSL bypassed servers information 
webasd[7055]: [web.NOTICE]: web: user admin: SSL ACTION: /rbt/sport/ssl/action/server_cert \
    s/add_import; PARAMETERS: name = , exportable = true 
mgmtd[3958]: [mgmtd.INFO]: while importing www.example.com: code 20 at 0 depth lookup: una \
    ble to get local issuer certificate  
mgmtd[3958]: [mgmtd.INFO]: /C=AU/ST=NSW/L=Sydney/O=Example Dot Com/OU=Webserver Department \
    /CN=www.example.com/emailAddress=www@example.com 
mgmtd[3958]: [mgmtd.INFO]: EVENT:  /rbt/sport/ssl/event/change/backend_server 
sport[7402]: [sport/mgmt/ssl.INFO] - {- -} dyn config modify/add SSL server certificate [w \
    ww.example.com]. 
sport[7402]: [sslmodule.INFO] - {- -} Added a certificate with name "www.example.com" 
mgmtd[3958]: [mgmtd.NOTICE]: Server certificate "www.example.com" added successfully. 
mgmtd[3958]: [mgmtd.INFO]: verification failed: code 20 at 0 depth lookup: unable to get l \
    ocal issuer certificate  
mgmtd[3958]: [mgmtd.INFO]: /C=AU/ST=NSW/L=Sydney/O=Example Dot Com/OU=Webserver Department \
    /CN=www.example.com/emailAddress=www@example.com 
mgmtd[3958]: [mgmtd.NOTICE]: But the certificate did not pass verification, so if the actu \
    al backend server uses the same certificate, the appliance might not be able to connec \
    t to it. Additional Certificate Authorities might be needed. 
mgmtd[3958]: [mgmtd.NOTICE]: To avoid potential verification problems at clients (eg, brow \
    ser pop-up warnings), additional/correct chain certificates might be needed.  
webasd[7055]: [web.INFO]: web: Received return code 0, return message 'Server certificate  \
    "www.example.com" added successfully.\nBut the certificate did not pass verification,  \
    so if the actual backend server uses the same certificate, the appliance might not be  \
    able to connect to it. Additional Certificate Authorities might be needed.\nTo avoid p \
    otential verification problems at clients (eg, browser pop-up warnings), additional/co \
    rrect chain certificates might be needed.\n' from gclSession pygs_handle_any_response 
webasd[7055]: [web.INFO]: web: User admin viewing setupServiceProtocolsSSLMain page. 
</pre></div></div><br class="figure-break"><p>To see which issuer certificate is missing, use the command
<code class="computeroutput">show protocol ssl server-cert</code>:
</p><div class="figure"><a name="idp40178792"></a><p class="title"><b>Figure 8.48. Output of the command "show protocol ssl server-cert"</b></p><div class="figure-contents"><pre class="screen">SSH # show protocol ssl server-cert name www.example.com
Name: www.example.com
Exportable: yes

Certificate Details:
Issued To:
  Common Name:       www.example.com
  Organization:      Example Dot Com
  Locality:          Sydney
  State:             NSW
  Country:           AU
  Serial Number:     1 (0x1)
Issued By:
  Common Name:       Example Dot Com Intermediate Certificate
  Organization:      Example Dot Com
  State:             NSW
  Country:           AU
Validity:
  Issued On:         Aug  5 08:08:44 2012 GMT
  Expires On:        Aug  5 08:08:44 2013 GMT
Fingerprint:
  SHA1:              FB:C5:FF:07:81:08:7D:DF:A8:40:6B:68:15:03:47:63:89:F8:72:2C
Key:                 
  Type:              RSA
  Size (Bits):       4096

No chain certificates.
</pre></div></div><br class="figure-break"><p>This shows that we don't have the certificate of the issuer
<span class="italics">Example Dot Com Intermediate Certificate</span>.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40179752"></a>8.11.1.3.2. Import of the server private key and certificate with the intermediate certificate available but the Root CA certificate missing</h5></div></div></div><p>If the issuer certificate of the server certificate is known
on the Steelhead appliance, but the CA Root certificate is not
known, then you need to obtain that CA Root certificate too.
</p><div class="figure"><a name="idp40180072"></a><p class="title"><b>Figure 8.49. Missing Root CA certificate missing but intermediate certificate is there</b></p><div class="figure-contents"><pre class="screen">webasd[7055]: [web.INFO]: web: User admin viewing setupServiceProtocolsSSLCAs page. 
webasd[7055]: [web.NOTICE]: web: user admin: SSL ACTION: /rbt/sport/ssl/action/server_cert \
    s/add_import; PARAMETERS: name = , exportable = true 
mgmtd[3958]: [mgmtd.INFO]: while importing www.example.com: code 2 at 1 depth lookup: unab \
    le to get issuer certificate  
mgmtd[3958]: [mgmtd.INFO]: /C=AU/ST=NSW/L=Sydney/O=Example Dot Com/CN=Example Dot Com Inte \
    rmediate Certificate/emailAddress=intca@example.com 
mgmtd[3958]: [mgmtd.INFO]: EVENT:  /rbt/sport/ssl/event/change/backend_server 
sport[7402]: [sport/mgmt/ssl.INFO] - {- -} dyn config modify/add SSL server certificate [w \
    ww.example.com]. 
sport[7402]: [sslmodule.INFO] - {- -} Added a certificate with name "www.example.com" 
mgmtd[3958]: [mgmtd.NOTICE]: Server certificate "www.example.com" added successfully. 
mgmtd[3958]: [mgmtd.INFO]: verification failed: code 2 at 1 depth lookup: unable to get is \
    suer certificate  
mgmtd[3958]: [mgmtd.INFO]: /C=AU/ST=NSW/L=Sydney/O=Example Dot Com/CN=Example Dot Com Inte \
    rmediate Certificate/emailAddress=intca@example.com 
mgmtd[3958]: [mgmtd.NOTICE]: But the certificate did not pass verification, so if the actu \
    al backend server uses the same certificate, the appliance might not be able to connec \
    t to it. Additional Certificate Authorities might be needed. 
mgmtd[3958]: [mgmtd.NOTICE]: Certificate Authority "Example_Dot_Com_Intermediate_CA" autom \
    atically added to the certificate chain. To avoid potential verification problems at c \
    lients (eg, browser pop-up warnings), additional/correct chain certificates might be n \
    eeded.  
webasd[7055]: [web.INFO]: web: Received return code 0, return message 'Server certificate  \
    "www.example.com" added successfully.\nBut the certificate did not pass verification,  \
    so if the actual backend server uses the same certificate, the appliance might not be  \
    able to connect to it. Additional Certificate Authorities might be needed.\nCertificat \
    e Authority "Example_Dot_Com_Intermediate_CA" automatically added to the certificate c \
    hain.\nTo avoid potential verification problems at clients (eg, browser pop-up warning \
    s), additional/correct chain certificates might be needed.\n' from gclSession pygs_han \
    dle_any_response 
webasd[7055]: [web.INFO]: web: User admin viewing setupServiceProtocolsSSLMain page. 
</pre></div></div><br class="figure-break"><p>The difference here is that the string
<code class="computeroutput">Certificate Authority "Example_Dot_Com_Intermediate_CA" automatically added to the certificate chain</code>
has been added, which shows that the issuer of the server certificate
is known.
</p><p>Again, the command
<code class="computeroutput">show protocol ssl server-cert</code>
can be used to see which one is expected:
</p><div class="figure"><a name="idp40181352"></a><p class="title"><b>Figure 8.50. Output of the command "show protocol ssl server-cert" for a chained certificate</b></p><div class="figure-contents"><pre class="screen">SSH # show protocol ssl server-cert name www.example.com
Name: www.example.com
Exportable: yes

Certificate Details:
Issued To:
  Common Name:       www.example.com
  Organization:      Example Dot Com
  Locality:          Sydney
  State:             NSW
  Country:           AU
  Serial Number:     1 (0x1)
Issued By:
  Common Name:       Example Dot Com Intermediate Certificate
  Organization:      Example Dot Com
  State:             NSW
  Country:           AU
Validity:
  Issued On:         Aug  5 08:08:44 2012 GMT
  Expires On:        Aug  5 08:08:44 2013 GMT
Fingerprint:
  SHA1:              FB:C5:FF:07:81:08:7D:DF:A8:40:6B:68:15:03:47:63:89:F8:72:2C
Key:                 
  Type:              RSA
  Size (Bits):       4096

Chain certificates:
  Name  (Issued To)
  DF095A93A56EA5A63C9286673A84AB22  (Example Dot Com Intermediate Certificate)

SSH # show protocol ssl server-cert name www.example.com chain-cert DF095A93A56EA5A63C9286 \
    673A84AB22 certificate 
Issued To:
  Common Name:       Example Dot Com Intermediate Certificate
  Organization:      Example Dot Com
  State:             NSW
  Country:           AU
  Serial Number:     1 (0x1)
Issued By:
  Common Name:       Example Dot Com Root Certificate
  Organization:      Example Dot Com
  Locality:          Sydney
  State:             NSW
  Country:           AU
Validity:
  Issued On:         Aug  5 08:01:14 2012 GMT
  Expires On:        Aug  5 08:01:14 2013 GMT
Fingerprint:
  SHA1:              C3:D8:46:D6:A3:5B:F7:7D:1E:2E:C4:E9:DC:89:1D:AD:AF:4E:95:2F
Key:                 
  Type:              RSA
  Size (Bits):       4096
</pre></div></div><br class="figure-break"><p>This shows that we don't have the certificate of the issuer
<span class="italics">Example Dot Com Root Certificate</span>.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40182312"></a>8.11.1.3.3. Import of the server private key and certificate with the intermediate certificate and Root CA certificate available</h5></div></div></div><div class="figure"><a name="idp40182568"></a><p class="title"><b>Figure 8.51. Successful import of the server certificate</b></p><div class="figure-contents"><pre class="screen">webasd[7055]: [web.NOTICE]: web: user admin: SSL ACTION: /rbt/sport/ssl/action/server_cert \
    s/add_import; PARAMETERS: name = , exportable = true 
mgmtd[3958]: [mgmtd.INFO]: EVENT:  /rbt/sport/ssl/event/change/backend_server 
sport[7402]: [sport/mgmt/ssl.INFO] - {- -} dyn config modify/add SSL server certificate [w \
    ww.example.com]. 
sport[7402]: [sslmodule.INFO] - {- -} Added a certificate with name "www.example.com" 
mgmtd[3958]: [mgmtd.NOTICE]: Server certificate "www.example.com" added successfully. 
mgmtd[3958]: [mgmtd.NOTICE]: Certificate Authority "DF095A93A56EA5A63C9286673A84AB22" auto \
    matically added to the certificate chain.  
webasd[7055]: [web.INFO]: web: Received return code 0, return message 'Server certificate  \
    "www.example.com" added successfully.\nCertificate Authority "DF095A93A56EA5A63C928667 \
    3A84AB22" automatically added to the certificate chain.\n' from gclSession pygs_handle \
    _any_response 
webasd[7055]: [web.INFO]: web: User admin viewing setupServiceProtocolsSSLMain page. 
sport[7402]: [sport/mgmt/ssl.INFO] - {- -} getting SSL discovered servers information 
sport[7402]: [sport/mgmt/ssl.INFO] - {- -} getting SSL bypassed servers information 
</pre></div></div><br class="figure-break"></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40183016"></a>8.11.1.4. Configure an in-path rule with SSL pre-optimization</h4></div></div></div><p>In the GUI of the client-side Steelhead appliance, add an in-path
rule towards the SSL server with
<span class="italics">SSL</span>
as the
<span class="italics">Pre-optimization Policy</span>:
</p><div class="figure"><a name="idp40183912"></a><p class="title"><b>Figure 8.52. SSL Pre-optimization in-path rule</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptions-18-inpathrule.png" align="middle" width="100%" alt="SSL Pre-optimization in-path rule"></td></tr></table></div></div></div><br class="figure-break"><p>No change is needed on the server-side Steelhead appliance, as the
peering rules will take care of it.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40184808"></a>8.11.2. Test the optimization of the SSL pre-optimization</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40185064"></a>8.11.2.1. Test the optimization of the SSL session</h4></div></div></div><p>If the SSL pre-optimization is working, after the setup of the TCP
session data reduction should be seen and the server should show
up as discovered in the SSL discovery list:
</p><div class="figure"><a name="idp40185384"></a><p class="title"><b>Figure 8.53. SSL discovery list</b></p><div class="figure-contents"><pre class="screen">SSH # show protocol ssl backend disc-table
Discovered servers:
   # Server Name               IP              Port  Certificate Name           
---- ------------------------- --------------- ----- -------------------------  
   1 www.example.com           192.168.1.1     443   www.example.com            
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40185896"></a>8.12. SCA Latency Optimization</h2></div></div></div><p>SCA latency optimization works in various ways to improve performance
times of cloud based Software-as-a-Service (SaaS) applications like
Microsoft Office 365 and Salesforce.
</p><p>The overall SCA service is delivered in conjunction with the Akamai
CDN (Content Delivery Network). SCA combines the Riverbed WAN
optimization technology (RiOS) with the Akamai Internet optimization
technology (SureRoute) for accelerating SaaS platform performance.
SCA uses Akamai SureRoute to provide a reliable transport across
the fastest path through thousands of servers in many countries
while dynamically adding RiOS instance at points nearest to the
SaaS service provider.
</p><p>SCA optimization is achieved using normal TCP, SDR and HTTP latency
optimization techniques.
</p><p>There are two methods of deployment at the customer premises.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Direct branch Internet deployment: The branch offices have their
  own Internet connectivity.
</p></li><li class="listitem"><p>Back-hauled Internet deployment: The branch offices connect to
  the Internet over an internal WAN or a VPN connection to a centralized
  data center location that controls all Internet access.
</p></li></ul></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40207656"></a>8.12.1. How SCA Latency Optimizations work.</h3></div></div></div><p>SCA optimization uses the same HTTP and TCP optimization features
to deliver performance enhancement. See the
<a class="xref" href="#latencyoptimization_httplatencyoptimization" title="8.10. HTTP Latency Optimization">HTTP Latency Optimization</a> section in the
<span class="italics">Latency Optimization</span>
chapter for those details.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40208424"></a>8.12.2. SCA components</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>SaaS Platform: The platform that uses Software as a Service, such
  as Salesforce or Microsoft Office 365.
</p></li><li class="listitem"><p>Akamai Intelligent Platform: The Akamai distributed network of
  over 100 000 servers deployed in over 1 000 locations world-wide
  across the public Internet. The platform hosts Riverbed Steelhead
  technology and provides Internet-based optimization for Enterprise
  SaaS traffic.
</p></li><li class="listitem"><p>Akamai SureRoute Optimization: Akamai SureRoute Optimization uses
  a suite of technologies to provide fast and reliable delivery
  between the Akamai Edge Servers. Route optimization examines
  multiple paths across the Internet to find the fastest path and
  route past any failures; the Enhanced Akamai Protocol overcomes
  the inefficiencies of TCP to provide the highest throughput and
  fastest recovery; and Packet Redundancy enables you to recreate
  any lost data without having the client or server to retransmit.
</p></li><li class="listitem"><p>Akamai Edge Server: The Akamai Edge Server in the Akamai Intelligent
  Platform closest to the end-user is dynamically and intelligently
  selected (regardless of whether the end-user location has direct
  Internet access or the data is back-hauled to the Internet gateway
  at the data center). The Akamai Edge Server closest to the SaaS
  provider's data center runs the RiOS instances and acts as a peer
  to the registered ESH.
</p></li><li class="listitem"><p>Enterprise Data Center Steelhead (DCSH): The Steelhead appliance
  located in the customer data center close to the customer Internet
  egress point. It contains the Akamai Cloud Proxy (ACP) feature.
</p></li><li class="listitem"><p>Enterprise Branch Steelhead (BSH): The Steelhead appliance located
  in the customer branch office that intercepts any connections
  destined for the SaaS platform to be accelerated. The Enterprise
  Branch Steelhead can host the Akamai Cloud Proxy (ACP) feature,
  but does not require it. ACP is a software component that grants
  the Steelhead appliance access to the Akamai Intelligent Platform.
  The registered ESH accelerates application performance and data
  transfer over the private WAN and the Internet, overcoming bandwidth
  and geographical limitations.
</p></li><li class="listitem"><p>Riverbed Cloud Portal: An always on, always available Web portal
  that enables you to log on to deploy and manage Riverbed software,
  ESHs and SCA in the cloud. The Riverbed Cloud Portal manages
  registration and deregistration of SCA; it also provides the
  status of SCA.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40210024"></a>8.12.3. Setup of an optimized SCA connection Direct Branch Deployment</h3></div></div></div><div class="figure"><a name="idp40210280"></a><p class="title"><b>Figure 8.54. SCA connection Direct Branch Deployment</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptimization-22-SCA-direct-branch.png" align="middle" width="100%" alt="SCA connection Direct Branch Deployment"></td></tr></table></div></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40211176"></a>8.12.4. Setup of an optimized SCA connection Back-Hauled Deployment</h3></div></div></div><div class="figure"><a name="idp40211432"></a><p class="title"><b>Figure 8.55. SCA connection Back-Hauled Deployment</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptimization-22-SCA-back-haul.png" align="middle" width="100%" alt="SCA connection Back-Hauled Deployment"></td></tr></table></div></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40212264"></a>8.12.5. Troubleshooting SCA latency optimization</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40212456"></a>8.12.5.1. Mandatory components for a working SCA solution to operate</h4></div></div></div><p>The following steps need to be taken to get a working SCA solution:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Steelhead appliance has a valid (not expired)
  SSL certificate.
</p></li><li class="listitem"><p>The Steelhead appliance has a valid SSL license installed.
</p></li><li class="listitem"><p>SSL optimization is enabled on the Steelhead appliance.
</p></li><li class="listitem"><p>Port 443 is removed from the "Secure" ports label list under
  Configure -&gt; Networking -&gt; Port Labels.
</p></li><li class="listitem"><p>The Steelhead appliance's primary interface is connected.
</p></li><li class="listitem"><p>The Host Settings is configured with valid DNS server IP addresses
  and these DNS servers must be able to resolve named from the
  public Internet, for example salesforce.com.
</p></li><li class="listitem"><p>The Steelhead appliance has NTP configured and is synced, also
  the correct time zone needs to be configured on the Steelhead
  appliance.
</p></li><li class="listitem"><p>An account on the Riverbed Cloud Portal is required.
</p></li><li class="listitem"><p>The Steelhead appliance needs to be appropriately registered on
  the Cloud Portal and a valid SCA license needs to be configured.
</p></li><li class="listitem"><p>Any firewall between the Steelhead appliance and the public
  Internet must allow for outbound access from the primary interface
  IP address to ports 80 and 443. If using external DNS or NTP
  servers, also the UDP/TCP ports 53 and UDP port 123 need to have
  outbound access. Ensure that the stateful feature is enabled for
  UDP packets.
</p></li><li class="listitem"><p>Any firewall between the Steelhead appliance and the public
  Internet should allow outbound UDP port 9545 from all in-path
  interfaces on the Steelhead appliance. Ensure that the stateful
  feature is enabled on the firewall in order to allow for returning
  UDP packets.
</p></li><li class="listitem"><p>You need to have an existing account with your SaaS provider.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40215592"></a>8.12.5.2. Validate SCA subscription and acceleration service is turned on</h4></div></div></div><p>In the Riverbed Cloud Portal, click Cloud Accelerator and select
SaaS Platforms -&gt; Office 365 | Salesforce | Google Apps.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Check that the Start Time and the End Time are valid.
</p></li><li class="listitem"><p>The Active columns should display
<span class="italics">true</span>
  and the Terminated column should display
<span class="italics">false</span>.
</p></li><li class="listitem"><p>The Acceleration Service should be
<span class="italics">ON</span>.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40217448"></a>8.12.5.3. The ESH should communicate with the Riverbed Cloud Portal</h4></div></div></div><p>Check the ESH is communicating with the Riverbed Cloud Portal using
the following steps:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>In the Riverbed Cloud Portal, click Cloud Accelerator and then
  select Enterprise Steelhead Appliances. Verify that the serial
  number of the ESH is listed in either Pending, Granted or Denied
  sections.
</p></li><li class="listitem"><p>Check the output of the command
<code class="computeroutput">show service cloud-accel</code>.
  The Reason field indicates the current status of the ESH. If the
  reason is
<span class="italics">Disabled by administrative action</span>
  and Enabled is
<span class="italics">Yes</span>
  then the ESH might have been denied service by the Riverbed Cloud
  Portal, or de-registered from the ESH. You must register the ESH
  again.
</p><div class="figure"><a name="idp40219048"></a><p class="title"><b>Figure 8.56. Output of the command 'show service cloud-accel'</b></p><div class="figure-contents"><pre class="screen">ESH # show service cloud-accel
Enabled: Yes
Status: Unregistered
Reason: Disabled by administrative action (Tue Aug 21
Portal: cloudportal.riverbed.com:443 (HTTPS)
Redirection: Enabled
Port: 9545
State: Active
Spill-over Policy: Disabled
ESH #
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>If the reason is
<span class="italics">Disabled by administrative action</span>
  and Enabled is
<span class="italics">No</span>
  then the ESH might have been denied service by the Riverbed Cloud
  Portal, or de-registered from the ESH. Also, the SCA service was
  disabled on the ESH.
</p><div class="figure"><a name="idp40224424"></a><p class="title"><b>Figure 8.57. Output of the command 'show service cloud-accel'</b></p><div class="figure-contents"><pre class="screen">ESH # show service cloud-accel
Enabled: No
Status: Unregistered
Reason: Disabled by administrative action (Tue Aug 21
Portal: cloudportal.riverbed.com:443 (HTTPS)
Redirection: Enabled
Port: 9545
State: Inactive
Spill-over Policy: Disabled
ESH #
</pre></div></div><br class="figure-break"></li><li class="listitem"><p>If the reason is Appliance is
<span class="italics">Pending Service</span>
  then you must grant access to the ESH on the Riverbed Cloud Portal.
  If the reason is
<span class="italics">Couldn't resolve host name</span>
  then check the DNS settings on the ESH. SCA uses the Steelhead
  appliance DNS settings. When you change DNS settings, remember
  to disable and re-enable the cloud acceleration service on the
  ESH.
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40225640"></a>8.12.5.4. Some connections result in protocol errors</h4></div></div></div><p>Protocol errors for some of the connections is expected behavior.
This is because the system does not optimize every single SSL
connection. For example, in the following figure below, connections
to www.salesfore.com (204.14.235.50) and login.salesforce.com
(204.14.234.101) are not optimized (not SSL decrypted). However,
connections to na2.salesforce.com (204.14.234.81) are optimized.
</p><div class="figure"><a name="idp40225960"></a><p class="title"><b>Figure 8.58. SCA passed through connections.</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptimization-22-SCA-not-optimized.png" align="middle" width="100%" alt="SCA passed through connections."></td></tr></table></div></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40226792"></a>8.12.5.5. SCA blocked by SaaS whitelist</h4></div></div></div><p>Salesforce has a whitelist security feature. Customers can permit/deny
source IP ranges to their particular Salesforce instances. For the
SCA feature to work successfully, specific Akamai IP ranges must
be permitted to the Salesforce instances. Please see KB S18309 for
further information.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40227112"></a>8.12.5.6. Is the traffic redirected to the Akamai SRIP network?</h4></div></div></div><p>From a computer behind the client-side Steelhead appliance, initiate
the traceroute command to a SaaS provider server and observe the
IP address of the first hop. If the first hop is
<span class="bold"><strong>NOT</strong></span>
the IP address of your default gateway, then the packets are
redirected into the SRIP network.
</p><div class="figure"><a name="idp40227816"></a><p class="title"><b>Figure 8.59. The first hop found by traceroute should be the SRIP-Edge host</b></p><div class="figure-contents"><pre class="screen">Default gateway is 192.168.128.1
C:\&gt;tracert ch1prd0410.outlook.com
Tracing route to ch1prd0410.outlook.com [157.56.244.182]
over a maximum of 30 hops:
1 23 ms 38 ms 19 ms 58.27.86.183 &lt;&lt; [SRIP-Edge]
2 305 ms 236 ms 234 ms 198.63.231.204 &lt;&lt; [SRIP-Gateway]
3 235 ms 235 ms 237 ms be-5.r05.chcgil09.us.bb.gin.ntt.net [131.103.136.1]
4 235 ms 265 ms 237 ms 0.xe-10-2-0.BR3.CHI13.ALTER.NET [204.255.168.69]
5 234 ms 239 ms 236 ms 0.ae3.XL4.CHI13.ALTER.NET [152.63.66.77]
6 237 ms 235 ms 236 ms TenGigE0-5-2-0.GW2.CHI13.ALTER.NET [152.63.67.106]
7 268 ms 415 ms 417 ms microsoft-gw.customer.alter.net [63.84.96.94]
8 240 ms 238 ms 239 ms xe-3-0-1-0.ch1-16c-1a.ntwk.msn.net [207.46.46.153]
9 236 ms 235 ms 238 ms xe-5-0-0-0.ch1-96c-1b.ntwk.msn.net [207.46.46.125]
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40228328"></a>8.12.5.7. The error message 'Inner channel is not secure' appears</h4></div></div></div><div class="figure"><a name="idp40228584"></a><p class="title"><b>Figure 8.60. SCA inner channel is not secure.</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptimization-22-SCA-inner-not-secure.png" align="middle" width="100%" alt="SCA inner channel is not secure."></td></tr></table></div></div></div><br class="figure-break"><p>If the connection details display the error message
<span class="italics">Inner channel is not secure</span>
then there is an issue with peering between the Steelhead appliance
and the cloud. Check the validity of the peering certificate and
ensure that the Peering Trust list contains the appropriate CA.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40229864"></a>8.12.5.8. SSL security certificates error messages in the browser</h4></div></div></div><p>When accessing the SaaS provider's website, the browser displays
an error message about the SSL security certificate.
</p><div class="figure"><a name="idp40230248"></a><p class="title"><b>Figure 8.61. SCA invalid CA certificate installed in client browser.</b></p><div class="figure-contents"><pre class="screen"></pre><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td align="center"><img src="graphs/08-latencyoptimization-22-SCA-inner-not-secure.png" align="middle" width="100%" alt="SCA invalid CA certificate installed in client browser."></td></tr></table></div></div></div><br class="figure-break"><p>Ensure that the CA (CA that signed the Proxy Certificate) root
certificate is installed correctly on your computer. This could be
either a Customer-hosted CA or Cloud-hosted CA depending on the
configuration for the SCA service in the cloud portal. The customer
has a choice, by default it is cloud hosted.

</p></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="Logging"></a>Chapter 9. Logging</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp40231848">9.1. Index</a></span></dt><dt><span class="sect1"><a href="#idp40232872">9.2. Logging format</a></span></dt><dt><span class="sect1"><a href="#idp40238504">9.3. TCP Optimization</a></span></dt><dt><span class="sect1"><a href="#idp40284264">9.4. OOB Splice and Connection Pool</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40231848"></a>9.1. Index</h2></div></div></div><p>This chapter describes on how to read the log files generated during
the normal operation of the Steelhead appliance.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The logging format
</p></li><li class="listitem"><p>TCP Optimization
</p></li><li class="listitem"><p>Out-of-Band Splice and Connection Pool
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40232872"></a>9.2. Logging format</h2></div></div></div><p>The Steelhead appliance uses the standard Unix syslog format with
a timestamp, a hostname, the process name and the process ID, the
facility, the priority and the line to be logged:
</p><div class="figure"><a name="idp40233192"></a><p class="title"><b>Figure 9.1. Example log lines</b></p><div class="figure-contents"><pre class="screen">Dec 12 16:21:59 CSH mgmtd[5082]: [mgmtd.NOTICE]: Configuration changed by user admin
Dec 12 16:26:27 CSH sport[24798]: [splice/client.INFO] 2 {10.0.1.1:60832 192.168.1.1:25} i \
    nit client 10.0.1.1:60832 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 \
     client connected: yes 
May 30 17:46:09 SSH webasd[6763]: [web.NOTICE]: web: Attempt to Authenticate admin 
May 30 17:46:10 SSH last message repeated 2 times
</pre></div></div><br class="figure-break"><p>The timestamp is the English three letter abbreviation for the month,
the day of the month and the 24 hour time.
</p><p>The hostname is the hostname of the machine the line is logged on.
</p><p>If the process name is
<span class="italics">sport</span>,
that is the optimization service. The list of the process names
can be found in the
<a class="xref" href="#riverbedapproach_appliancesetup_processes" title="2.2.4. The processes on the Steelhead appliance">The processes on the Steelhead appliance</a> section in the
<span class="italics">Riverbed Approach to WAN Optimization</span>
chapter. The number behind the process name is the Unix process ID.
</p><p>The facility is the internal part of the various services. For the
process
<span class="italics">sport</span>
that might be:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>splice: The setup and termination of TCP sessions used for
  optimization.
</p></li><li class="listitem"><p>mapi: MAPI latency optimization.
</p></li><li class="listitem"><p>smbcfe: CIFS latency optimization where this Steelhead appliance
  is the client-side Steelhead appliance.
</p></li><li class="listitem"><p>smbsfe: CIFS latency optimization where this Steelhead appliance
  is the server-side Steelhead appliance.
</p></li></ul></div><p>
</p><p>Some facilities can be further specified, for example:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>splice/oob: The Out-of-Band Splice related messages.
</p></li><li class="listitem"><p>splice/probe: The auto-discovery part of the setup of optimized
  TCP sessions.
</p></li></ul></div><p>
</p><p>The priorities are: Debug, Info, Notice, Warning, Error, Critical, Alert,
and Emergency. Under normal operation, the logging level should be
set to Notice. Under troubleshooting operation with Riverbed TAC,
the logging level could be set to Info. Setting it to Warning or
higher will reduce the ability of Riverbed TAC to properly analyze
what was going on on the Steelhead appliance and should not be used.
Do not use Debug.
</p><p>It is possible to increase the logging level for a single part of the
optimization service with the command
<code class="computeroutput">logging filter</code>,
for example to have the HTTP latency optimization service set to Info
level logging while the rest is on the default Notice level, use the
following command:
<code class="computeroutput">logging filter http level info</code>.
</p><div class="figure"><a name="idp40237608"></a><p class="title"><b>Figure 9.2. Change the logging level of a single part of the optimization level</b></p><div class="figure-contents"><pre class="screen">SH (config) # logging filter http level info
SH (config) # show logging
Local logging level: notice
Default remote logging level: notice
No remote syslog receivers configured.
Number of archived log files to keep: 10
Log rotation frequency: daily
SH (config) # show logging filter
Local logging level: notice
Process  Description                   Level
-------- ----------------------------- --------
http     HTTP Optimization             info
</pre></div></div><br class="figure-break"><p>The rest of the line is the message being logged. For optimized TCP
connections they start with the string in the format
<code class="computeroutput">&lt;splicenumber&gt; {&lt;client IP address&gt;:&lt;client TCP port&gt; &lt;server IP address&gt;:&lt;server TCP port&gt;}</code>.
This string can be used to match multiple lines to a single optimized
TCP session.
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40238504"></a>9.3. TCP Optimization</h2></div></div></div><p>This section is about the basic setup of any optimized TCP session.
</p><p>These messages are logged at INFO level, which means that they are
normally not visible in the logs.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40238952"></a>9.3.1. A single optimized TCP session via Auto-discovery</h3></div></div></div><p>This is the setup of a TCP session between the client and the server
on TCP port 25. The default values are used at the in-path rules,
nothing fancy. Despite this is the first example, assumed is that
the Out-of-Band Splice has already been setup.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40239336"></a>9.3.1.1. With Enhanced Auto Discovery enabled</h4></div></div></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40239528"></a>9.3.1.1.1. On the client-side Steelhead appliance</h5></div></div></div><div class="figure"><a name="idp40239784"></a><p class="title"><b>Figure 9.3. Setup of an optimized TCP session from the client-side Steelhead appliance, Enhanced Auto Discovery and no Enhanced Auto Discovery </b></p><div class="figure-contents"><pre class="screen">CSH sport[24798]: [splice/client.INFO] 2 {10.0.1.1:60832 192.168.1.1:25} init client 10.0. \
    1.1:60832 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connecte \
    d: yes 
CSH sport[24798]: [splice/client.INFO] 2 {10.0.1.1:60832 192.168.1.1:25} Splice client sid \
    e initializing: No protocol port = 25 protocol id = TCP(0) transport = TRANSPORT_ID_NO \
    NE 
CSH sport[24798]: [splice/client.INFO] 2 {10.0.1.1:60832 192.168.1.1:25} Start flowing, lp \
    ort 40268, rport 7800, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_ \
    ID_NONE, TPTOPT_NONE(0x0) 

CSH sport[24798]: [splice/client.INFO] 2 {10.0.1.1:60832 192.168.1.1:25} fini client 10.0. \
    1.1:60832 server 192.168.1.1:25 cfe 10.0.1.6:40268 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"><p>The client-side of the optimized TCP session can be determined by
the logging facility:
<span class="italics">splice/client</span>.
The first line is printed when the SYN/ACK+ has been returned from
the server-side Steelhead appliance.
</p><p>There are four lines logged:
</p><p>The first line is the start of the optimized TCP session,
<span class="italics">init</span>.
It determines the IP addresses and TCP ports of the client, the
server, the client-side Steelhead appliance
<span class="italics">cfe</span>
and the server-side
Steelhead appliance
<span class="italics">sfe</span>.
The TCP port of the client-side Steelhead appliance is port 7801,
which is an internal port.
</p><p>The words
<span class="italics">client connected: yes</span>
shows that the OOB Splice has already been setup.
</p><p>The second line determines the latency optimization, plain TCP in
this case
<span class="italics">protocol id = TCP(0)</span>,
and the pre-optimization parameters.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>TRANSPORT_ID_NONE: Nothing special on the inner channel.
</p></li><li class="listitem"><p>TRANSPORT_ID_SSLINNER: The inner channel is SSL encrypted.
</p></li></ul></div><p>The third line shows the TCP ports of the inner channel and the
parameters on the outer channels.
</p><p>The words
<span class="italics">lport 40268</span>
are from the TCP port of the inner channel on the client-side
Steelhead appliance, the words
<span class="italics">rport 7800</span>
are from the TCP port of the inner channel on the server-side
Steelhead appliance.
</p><p>The next fields are the Optimization Policy, the Neural Framing,
the Pre-optimization Policy, the Latency Policy, the inner channel
Transport layer Policies and the Transport Optimization.
</p><p>Optimization Policy:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>OPOL_NORMAL: Perform full optimization with SDR and compression.
</p></li><li class="listitem"><p>OPOL_SDR_ONLY: Perform SDR Only, do not perform compression.
</p></li><li class="listitem"><p>OPOL_COMPR_ONLY: Perform only compression, do not perform SDR.
</p></li><li class="listitem"><p>OPOL_NONE: Do not perform SDR nor compression.
</p></li><li class="listitem"><p>OPOL_IN_MEM_ONLY: Use SDR-M: Perform full optimization with SDR
  and compression but keep the references in memory only, do not
  write them to disk.
</p></li></ul></div><p>
</p><p>Neural Framing Mode:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>NAGLE_NEVER: Always process the TCP payload packet by packet.
</p></li><li class="listitem"><p>NAGLE_ALWAYS: Use the Nagle algorithm to decide when to process
  the TCP payload data.
</p></li><li class="listitem"><p>NAGLE_TCPHINTS: Process the TCP payload data when a TCP packet
  with the PUSH flag has arrived.
</p></li><li class="listitem"><p>NAGLE_NEURAL: Let the neural framing algorithm decide when to
  process the TCP payload data.
</p></li></ul></div><p>
</p><p>The Pre-optimization Policy:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>PREOPT_NONE: No pre-optimization necessary.
</p></li><li class="listitem"><p>PREOPT_SSL: The data on the outer channels is SSL encrypted.
</p></li><li class="listitem"><p>PREOPT_JINIT: The data on the outer channels is jinitiator encapsulated.
</p></li><li class="listitem"><p>PREOPT_JINIT_SSL: The data on the outer channels is jinitiator
  over SSL encrypted.
</p></li></ul></div><p>
</p><p>The Latency Optimization Policy:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>LATOPT_AUTO: The Latency Optimization is determined on the
  destination TCP port.
</p></li><li class="listitem"><p>LATOPT_HTTP: Use HTTP Latency Optimization.
</p></li><li class="listitem"><p>LATOPT_NONE: Do not use any Latency Optimization.
</p></li><li class="listitem"><p>LATOPT_RPCH: Use RPC-over-HTTP Latency for Outlook Anywhere.
</p></li></ul></div><p>
</p><p>The inner channel Transport layer Policies:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>TRANSPORT_ID_NONE: No transport policy, the inner channel is
  not encrypted.
</p></li><li class="listitem"><p>TRANSPORT_ID_SSLINNER: The inner channel is SSL encrypted.
</p></li></ul></div><p>
</p><p>Transport Optimization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>TPTOPT_NONE: Do not perform a transport optimization.
</p></li><li class="listitem"><p>SCPS_IN_TE_W: Act as a SCPS initiator terminator on the WAN side.
</p></li><li class="listitem"><p>SCPS_IN_TE_L: Act as a SCPS initiator terminator on the LAN side.
</p></li><li class="listitem"><p>SCPS_TE_W: Act as a SCPS terminator on the WAN side.
</p></li><li class="listitem"><p>SCPS_TE_L: Act as a SCPS terminator on the LAN side.
</p></li><li class="listitem"><p>SCPS_IN_W: Act as a SCPS initiator on the WAN side.
</p></li><li class="listitem"><p>SCPS_IN_L: Act as a SCPS initiator on the LAN side.
</p></li><li class="listitem"><p>TPTOPT_PROXY: Do not use SCPS, only act as a TCP proxy.
</p></li></ul></div><p>
</p><p>The fourth line is the termination of the optimized TCP session,
<span class="italics">fin</span>.
It shows the IP addresses and TCP ports of the client, server,
client-side Steelhead appliance and the server-side Steelhead
appliance.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40252200"></a>9.3.1.1.2. On the server-side Steelhead appliance</h5></div></div></div><p>With Enhanced Auto Discovery the TCP session towards the server is
setup before the inner channel is created.
</p><div class="figure"><a name="idp40252520"></a><p class="title"><b>Figure 9.4. Setup of an optimized TCP session from the server-side Steelhead appliance, Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:0 clnt: 10.0.1.1:60832 se \
    rv: 192.168.1.1:25) init 
SSH sport[24255]: [splice/server.INFO] 2 {- -} init cfe 10.0.1.6:40268 sfe 192.168.1.6:780 \
    0 
SSH sport[24255]: [splice/server.INFO] 2 {- -}  sock 40 id 548627 client 10.0.1.1:60832 se \
    rver 192.168.1.1:25 remote inner port 7800 trpy TRPY_NONE 
SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40269 clnt: 10.0.1.1:6083 \
    2 serv: 192.168.1.1:25) acquired 
SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40269 clnt: 10.0.1.1:6083 \
    2 serv: 192.168.1.1:25) fini 
SSH sport[24255]: [splice/server.INFO] 2 {- -} Splice server side initializing: No protoco \
    l port = 25 transport = TRANSPORT_ID_NONE 
SSH sport[24255]: [splice/server.INFO] 2 {10.0.1.1:60832 192.168.1.1:25} Start flowing, lp \
    ort 7800, rport 40268, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_ \
    ID_NONE, TPTOPT_NONE(0x0) 

SSH sport[24255]: [splice/server.INFO] 2 {10.0.1.1:60832 192.168.1.1:25} fini client 10.0. \
    1.1:60832 server 192.168.1.1:25 cfe 10.0.1.6:40268 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"><p>The server-side of the optimized TCP session can be determined by
the logging facility:
<span class="italics">splice/probe</span>
and
<span class="italics">splice/server</span>.
The first line is printed when a SYN+ packet is seen.
</p><p>The first line identifies the auto discovery probe in the SYN+
packet: It determines the in-path interface IP address the probe
came in on and the IP addresses and TCP ports of the client and
server.  Note that this line was not shown on the client-side
Steelhead appliance.
</p><p>The second line is printed when the TCP session with the server has
been setup. It contains the IP addresses and TCP port numbers of
the inner channel to be setup.
</p><p>The third line contains the IP addresses and TCP port numbers of
the client and the server and the WAN visibility mode:
</p><p>WAN Visibility:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>TRPY_NONE: Correct Addressing
</p></li><li class="listitem"><p>TRPY_PORT: Port Transparency
</p></li><li class="listitem"><p>TRPY_FULL: Full Transparency
</p></li></ul></div><p>
</p><p>Line four and five are internal housekeeping of the auto-discovery
phase.
</p><p>Line six contains the protocol port and the Transport Policies.
</p><p>Line seven shows the TCP ports of the inner channel and the parameters
on the outer channels.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The
<span class="italics">lport</span>
  is the TCP port of the inner channel on the client-side Steelhead
  appliance.
</p></li><li class="listitem"><p>The
<span class="italics">rport</span>
  is the TCP port of the inner channel on the server-side Steelhead
  appliance.
</p></li></ul></div><p>The next fields are the Optimization Policy, the Neural Framing,
the Pre-optimization Policy, the Latency Policy, the Transport
layer Policies and the Transport Optimization.
</p><p>Line eight shows the end of the optimized TCP session again.
</p></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40272936"></a>9.3.1.2. With Enhanced Auto Discovery not enabled</h4></div></div></div><p>Without Enhanced Auto Discovery the inner channel is created before
the TCP session towards the server is setup. The logging on the
client-side Steelhead appliance is the same as with Enhanced Auto
Discovery enabled.
</p><div class="figure"><a name="idp40273256"></a><p class="title"><b>Figure 9.5. Setup of an optimized TCP session from the server-side Steelhead appliance, No Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[3073]: [splice/server.INFO] 2 {- -} init cfe 10.0.1.6:40268 sfe 192.168.1.6:7800 \
     
SSH sport[3073]: [splice/server.INFO] 2 {- -}  sock 39 id 548627 client 10.0.1.1:52776 ser \
    ver 192.168.1.1:25 remote inner port 7800 trpy TRPY_NONE 
SSH sport[3073]: [splice/server.INFO] 2 {- -} Splice server side initializing: No protocol \
     port = 25 transport = TRANSPORT_ID_NONE 
SSH sport[3073]: [splice/server.INFO] 2 {10.0.1.1:52776 192.168.1.1:25} Start flowing, lpo \
    rt 7800, rport 40268, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_I \
    D_NONE, TPTOPT_NONE(0x0) 

SSH sport[3073]: [splice/server.INFO] 2 {10.0.1.1:52776 192.168.1.1:25} fini client 10.0.1 \
    .1:52776 server 192.168.1.1:25 cfe 10.0.1.6:40268 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"><p>As can be seen here, the
<span class="italics">splice/probe</span>
messages do not appear because without Enhanced Auto Discovery the
inner channel is setup towards the first Steelhead appliance in the
network and therefore no further detection is necessary performed.
</p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40274088"></a>9.3.2. Optimized TCP session and an Out-of-Band Splice</h3></div></div></div><p>When two Steelhead appliances setup an optimized TCP session between
two in-path interfaces for the first time, they will setup the
Out-of-Band Splice first and then the optimized TCP session. Note
that the setup of the TCP sessions for the Connection Pool is not
logged in the system logs.
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40274408"></a>9.3.2.1. With Enhanced Auto Discovery enabled.</h4></div></div></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40274600"></a>9.3.2.1.1. On the client-side Steelhead appliance</h5></div></div></div><div class="figure"><a name="idp40274792"></a><p class="title"><b>Figure 9.6. Setup of an OOB Splice from the client-side Steelhead appliance, Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">CSH sport[24798]: [splice/client.INFO] 1 {10.0.1.1:47616 192.168.1.1:25} init client 10.0. \
    1.1:47616 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connecte \
    d: no 
CSH sport[24798]: [splice/oob.INFO] 1 {- -} New OOB Splice created at 10.0.1.6 for peer 19 \
    2.168.1.6 
CSH sport[24798]: [mgmt.INFO] - {- -} mgmtd notified that remote peer 192.168.1.6 was disc \
    overed 
CSH sport[24798]: [splice/oob.INFO] 1 {- -} Establishing OOB Splice from 10.0.1.6:0 to 192 \
    .168.1.6:7800 
CSH mgmtd[3766]: [mgmtd.INFO]: EVENT:  /rbt/sport/peer/event/added 
CSH sport[24798]: [splice/oob.INFO] 1 {- -} OOB Splice connected from 10.0.1.6:40271 to 19 \
    2.168.1.6:7800 
CSH sport[24798]: [splice/oob.INFO] 1 {- -} Negotiated sport protocol version: 8 for peer: \
     192.168.1.6:7800 
CSH sport[24798]: [splice/client.INFO] 1 {10.0.1.1:47616 192.168.1.1:25} Splice client sid \
    e initializing: No protocol port = 25 protocol id = TCP(0) transport = TRANSPORT_ID_NO \
    NE 
CSH sport[24798]: [splice/client.INFO] 1 {10.0.1.1:47616 192.168.1.1:25} Start flowing, lp \
    ort 40269, rport 7800, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_ \
    ID_NONE, TPTOPT_NONE(0x0) 

CSH sport[24798]: [splice/client.INFO] 1 {10.0.1.1:47616 192.168.1.1:25} fini client 10.0. \
    1.1:47616 server 192.168.1.1:25 cfe 10.0.1.6:40269 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"><p>Line one has the words
<span class="italics">client connected: no</span>,
which means that no OOB Splice has been setup yet.
</p><p>Line two to seven are related to the setup of the OOB Splice.
</p><p>Line eight and nine are the setup of the inner channel of the
optimized TCP session.
</p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="idp40276008"></a>9.3.2.1.2. On the server-side Steelhead appliance</h5></div></div></div><div class="figure"><a name="idp40276200"></a><p class="title"><b>Figure 9.7. Setup of an OOB Splice from the server-side Steelhead appliance, Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:0 clnt: 10.0.1.1:47616 se \
    rv: 192.168.1.1:25) init 
SSH sport[24255]: [splice/oob.INFO] 1 {- -} New OOB Splice created at 192.168.1.6 for peer \
     10.0.1.6 
SSH sport[24255]: [mgmt.INFO] - {- -} mgmtd notified that remote peer 10.0.1.6 was discove \
    red 
SSH sport[24255]: [splice/oob.INFO] 1 {- -} Negotiated sport protocol version: 8 for peer: \
     10.0.1.6:0 
SSH mgmtd[4018]: [mgmtd.INFO]: EVENT:  /rbt/sport/peer/event/added 
SSH sport[24255]: [splice/server.INFO] 1 {- -} init cfe 10.0.1.6:40269 sfe 192.168.1.6:780 \
    0 
SSH sport[24255]: [splice/server.INFO] 1 {- -}  sock 41 id 548627 client 10.0.1.1:47616 se \
    rver 192.168.1.1:25 remote inner port 7800 trpy TRPY_NONE 
SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40268 clnt: 10.0.1.1:4761 \
    6 serv: 192.168.1.1:25) acquired 
SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40268 clnt: 10.0.1.1:4761 \
    6 serv: 192.168.1.1:25) fini 
SSH sport[24255]: [splice/server.INFO] 1 {- -} Splice server side initializing: No protoco \
    l port = 25 transport = TRANSPORT_ID_NONE 
SSH sport[24255]: [splice/server.INFO] 1 {10.0.1.1:47616 192.168.1.1:25} Start flowing, lp \
    ort 7800, rport 40269, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_ \
    ID_NONE, TPTOPT_NONE(0x0) 

SSH sport[24255]: [splice/server.INFO] 1 {10.0.1.1:47616 192.168.1.1:25} fini client 10.0. \
    1.1:47616 server 192.168.1.1:25 cfe 10.0.1.6:40269 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"><p>Line two to five are for the setup of the inner channel.
</p></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40276904"></a>9.3.2.2. With Enhanced Auto Discovery not enabled</h4></div></div></div><p>On the server-side Steelhead appliance the logging is similar to
the server-side Steelhead appliance with Enhanced Auto Discovery
enabled, but without the
<span class="italics">splice/probe</span>
messages:
</p><div class="figure"><a name="idp40277480"></a><p class="title"><b>Figure 9.8. Setup of an OOB Splice from the server-side Steelhead appliance, no Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[3073]: [splice/oob.INFO] 1 {- -} New OOB Splice created at 192.168.1.6 for peer  \
    10.0.1.6 
SSH sport[3073]: [mgmt.INFO] - {- -} mgmtd notified that remote peer 10.0.1.6 was discover \
    ed 
SSH sport[3073]: [splice/oob.INFO] 1 {- -} Negotiated sport protocol version: 8 for peer:  \
    10.0.1.6:0 
SSH mgmtd[4018]: [mgmtd.INFO]: EVENT:  /rbt/sport/peer/event/added 
SSH sport[3073]: [splice/server.INFO] 1 {- -} init cfe 10.0.1.6:40269 sfe 192.168.1.6:7800 \
     
SSH sport[3073]: [splice/server.INFO] 1 {- -}  sock 40 id 548627 client 10.0.1.1:34669 ser \
    ver 192.168.1.1:25 remote inner port 7800 trpy TRPY_NONE 
SSH sport[3073]: [splice/server.INFO] 1 {- -} Splice server side initializing: No protocol \
     port = 25 transport = TRANSPORT_ID_NONE 
SSH sport[3073]: [splice/server.INFO] 1 {10.0.1.1:34669 192.168.1.1:25} Start flowing, lpo \
    rt 7800, rport 40269, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_I \
    D_NONE, TPTOPT_NONE(0x0) 

SSH sport[3073]: [splice/server.INFO] 1 {10.0.1.1:34669 192.168.1.1:25} fini client 10.0.1 \
    .1:34669 server 192.168.1.1:25 cfe 10.0.1.6:40269 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40277928"></a>9.3.3. Failures</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40278120"></a>9.3.3.1. Cannot setup Out-of-Band Splice</h4></div></div></div><p>Before the inner channel of an optimized TCP session can be setup,
the Out-of-Band Splice must have been setup. If the OOB Splice
cannot be setup, then the optimized TCP session will not be setup.
</p><div class="figure"><a name="idp40278440"></a><p class="title"><b>Figure 9.9. Cannot setup OOB Splice</b></p><div class="figure-contents"><pre class="screen">CSH sport[4564]: [splice/client.INFO] 1 {10.0.1.1:56604 192.168.1.1:25} init client 10.0.1 \
    .1:56604 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connected \
    : no 
CSH sport[4564]: [splice/client.INFO] 1 {10.0.1.1:56604 192.168.1.1:25} fini client 10.0.1 \
    .1:56604 server 192.168.1.1:25 cfe 10.0.1.6:0 sfe 192.168.1.6:7800 app TCP 
CSH kernel: [intercept.INFO] Peer 192.168.1.6:7800 is unreachable or incompatible. New con \
    nections going through that peer will be passed through temporarily.
CSH kernel: [intercept.INFO] Peer 192.168.1.6:7800 is unreachable or incompatible. New con \
    nections going to server 192.168.1.1:25 through that peer using local inpath 10.0.1.6  \
    will be passed through for at least 293 seconds.
CSH sport[4564]: [connect_pool.WARN] - {- -} Error connecting to peer: Connection timed ou \
    t 
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40278888"></a>9.3.3.2. No service is listening</h4></div></div></div><p>With Enhanced Auto Discovery the outer channel towards the server
is setup before the inner channel is established. Therefore this
issue is only logged on the server-side Steelhead appliance:
</p><div class="figure"><a name="idp40279208"></a><p class="title"><b>Figure 9.10. Server-side Steelhead appliance, no service listening on TCP port 25, Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:0 clnt: 10.0.1.1:22778 se \
    rv: 192.168.1.1:25) init 
SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40427 clnt: 10.0.1.1:2277 \
    8 serv: 192.168.1.1:25) Error connecting to server: Connection refused 
SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40427 clnt: 10.0.1.1:2277 \
    8 serv: 192.168.1.1:25) fini 
</pre></div></div><br class="figure-break"><p>Without Enhanced Auto Discovery the inner channel is setup first
before being checked if the service is actually reachable and
available. Therefore both the client-side and the server-side
Steelhead appliance will log about it:
</p><div class="figure"><a name="idp40279784"></a><p class="title"><b>Figure 9.11. Client-side Steelhead appliance, no service listening on TCP port 25, no Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">CSH sport[4511]: [splice/client.INFO] 3 {10.0.1.1:41527 192.168.1.1:25} init client 10.0.1 \
    .1:41527 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connected \
    : yes 
CSH sport[4511]: [splice/client.INFO] 3 {10.0.1.1:41527 192.168.1.1:25} Splice client side \
     initializing: No protocol port = 25 protocol id = TCP(0) transport = TRANSPORT_ID_NON \
    E 
CSH sport[4511]: [splice/client.INFO] 3 {10.0.1.1:41527 192.168.1.1:25} Start flowing, lpo \
    rt 40270, rport 7800, OPOL_NORMAL, NAGLE_ALWAYS, PREOPT_NONE, LATOPT_AUTO, TRANSPORT_I \
    D_NONE, TPTOPT_NONE(0x0) 
CSH sport[4511]: [decoder.INFO] 3 {10.0.1.1:41527 192.168.1.1:25} Warning: Inner channel d \
    own prematurely, peer probably down; requesting shutdown 
CSH sport[4511]: [splice/client.INFO] 3 {10.0.1.1:41527 192.168.1.1:25} fini client 10.0.1 \
    .1:41527 server 192.168.1.1:25 cfe 10.0.1.6:40270 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp40280232"></a><p class="title"><b>Figure 9.12. Server-side Steelhead appliance, no service listening on TCP port 25, no Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[3073]: [splice/server.INFO] 3 {- -} init cfe 10.0.1.6:40270 sfe 192.168.1.6:7800 \
     
SSH sport[3073]: [splice/server.INFO] 3 {- -}  sock 41 id 548627 client 10.0.1.1:41527 ser \
    ver 192.168.1.1:25 remote inner port 7800 trpy TRPY_NONE 
SSH sport[3073]: [splice/server.INFO] 3 {- -} (clnt: 10.0.1.1:41527 peer: 10.0.1.6:40270 s \
    erv: 192.168.1.1:25) Error connecting to server: Connection refused 
SSH sport[3073]: [splice/server.INFO] 3 {- -} fini client 10.0.1.1:41527 server 192.168.1. \
    1:25 cfe 10.0.1.6:40270 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40280744"></a>9.3.3.3. No host on the subnet</h4></div></div></div><p>With Enhanced Auto Discovery the outer channel towards the server
is tried to be setup before the inner channel is established. Since
all failure is happening on the server-side Steelhead appliance,
the client-side Steelhead appliance will not show any logging for
this TCP session:
</p><div class="figure"><a name="idp40281064"></a><p class="title"><b>Figure 9.13. Server-side Steelhead appliance, no host with IP address 192.168.1.1, Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:0 clnt: 10.0.1.1:65396 se \
    rv: 192.168.1.1:25) init 
SSH sport[24255]: [splice/probe.INFO] 0 {- -} (locl: 192.168.1.6:40428 clnt: 10.0.1.1:6539 \
    6 serv: 192.168.1.1:25) fini 
</pre></div></div><br class="figure-break"><p>Without Enhanced Auto Discovery the inner channel is setup first
before being checked if the service is actually reachable and
available. Therefor there is also logging for this TCP session on
the client-side Steelhead appliance.
</p><div class="figure"><a name="idp40281640"></a><p class="title"><b>Figure 9.14. Client-side Steelhead appliance, no host with IP address 192.168.1.1, no Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">CSH sport[4511]: [splice/client.INFO] 4 {10.0.1.1:31909 192.168.1.1:25} init client 10.0.1 \
    .1:31909 server 192.168.1.1:25 cfe 10.0.1.6:7801 sfe 192.168.1.6:7800 client connected \
    : no 
CSH sport[4511]: [splice/client.INFO] 4 {10.0.1.1:31909 192.168.1.1:25} Splice client side \
     initializing: No protocol port = 25 protocol id = TCP(0) transport = TRANSPORT_ID_NON \
    E 
CSH sport[4511]: [splice/client.INFO] 4 {10.0.1.1:31909 192.168.1.1:25} fini client 10.0.1 \
    .1:31909 server 192.168.1.1:25 cfe 10.0.1.6:40272 sfe 192.168.1.6:7800 app TCP 
CSH kernel: [intercept.INFO] Peer 192.168.1.6:7800 is unreachable or incompatible. New con \
    nections going through that peer will be passed through temporarily.
CSH kernel: [intercept.INFO] Peer 192.168.1.6:7800 is unreachable or incompatible. New con \
    nections going to server 192.168.1.1:25 through that peer using local inpath 10.0.1.6  \
    will be passed through for at least 293 seconds.
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp40282088"></a><p class="title"><b>Figure 9.15. Server-side Steelhead appliance, no host with IP address 192.168.1.1, no Enhanced Auto Discovery</b></p><div class="figure-contents"><pre class="screen">SSH sport[3073]: [splice/server.INFO] 4 {- -} init cfe 10.0.1.6:40272 sfe 192.168.1.6:7800 \
     
SSH sport[3073]: [splice/server.INFO] 4 {- -}  sock 43 id 548627 client 10.0.1.1:31909 ser \
    ver 192.168.1.1:25 remote inner port 7800 trpy TRPY_NONE 
SSH sport[3073]: [splice/server.INFO] 4 {- -} fini client 10.0.1.1:31909 server 192.168.1. \
    1:25 cfe 10.0.1.6:40272 sfe 192.168.1.6:7800 app TCP 
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40282536"></a>9.3.3.4. Third SYN received before inner channel got setup</h4></div></div></div><p>To setup a TCP session the client will send a maximum of three SYN
packets. When the first SYN packet is intercepted by the Steelhead
appliance and an optimized TCP session can be setup for it, it will
put the TCP session in a NAT table and send a SYN+. If the second
SYN packet is intercepted, it will just ignore it because an optimized
is already being setup. If the third SYN packet is received and the
optimized TCP session is not yet setup, it will just pass the SYN
packet through and mark the TCP session as pass-through.
</p><div class="figure"><a name="idp40282920"></a><p class="title"><b>Figure 9.16. Third SYN received before inner channel got setup</b></p><div class="figure-contents"><pre class="screen">SH kernel: [intercept.NOTICE] nat_check: SYN packet for already natted connection 10.0.1.1 \
    :52181 -&gt; 10.0.1.6:5486 ==&gt; 10.0.1.1:52181 -&gt; 192.168.1.6:7801
</pre></div></div><br class="figure-break"></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40283432"></a>9.3.3.5. TCP session closed before the inner channel could have been setup</h4></div></div></div><p>Some applications, for example the Windows SMB protocol, setup
multiple TCP sessions at once and close the others when one of them
gets setup successfully. It is possible that the inner channel for
them hasn't been setup yet, and the following message is logged:
</p><div class="figure"><a name="idp40283752"></a><p class="title"><b>Figure 9.17. TCP session closed before the inner channel could have been setup</b></p><div class="figure-contents"><pre class="screen">CSH sport[6693]: [splice/probe.NOTICE] 0 {- -} (locl: 10.0.1.6:50499 clnt: 10.0.1.1:2686 s \
    erv: 192.168.1.1:139) No inner channel created for this probe splice
</pre></div></div><br class="figure-break"></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40284264"></a>9.4. OOB Splice and Connection Pool</h2></div></div></div><p>This section is about the setup and termination of the Out-of-Band
splice and the TCP sessions from the Connection Pool.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40284584"></a>9.4.1. OOB Splice lost due to admission control</h3></div></div></div><p>When a Steelhead appliance goes into admission control, it will
send the OOB disconnect message
<span class="italics">Admission Control</span>
to the connected Steelhead appliances and terminate the TCP sessions
of the connection pool.
</p><div class="figure"><a name="idp40285224"></a><p class="title"><b>Figure 9.18. Local Steelhead appliance into admission control</b></p><div class="figure-contents"><pre class="screen">CSH statsd[7333]: [statsd.NOTICE]: Alarm triggered for rising error for event admission_co \
    nn 
CSH sport[8298]: [admission_control.NOTICE] - {- -} Connection limit achieved. Total Conne \
    ctions 136, Branched Warmed Connections 0 
CSH sport[8298]: [admission_control.WARN] - {- -} Pausing intercept: Connection limit achi \
    eved;  
CSH sport[8298]: [admission_control.NOTICE] - {- -} Memory Usage: 296 Current Connections: \
     136 TCP Memory Usage: 29; 
CSH sport[8298]: [splice/oob.NOTICE] 11 {- -} Resetting state for oob splice: laddr=10.0.1 \
    .6:43437 raddr=192.168.1.6:7800 cflag=0x8 
CSH sport[8298]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp40285736"></a><p class="title"><b>Figure 9.19. Remote Steelhead appliance into admission control</b></p><div class="figure-contents"><pre class="screen">CSH sport[6693]: [splice/oob.NOTICE] 8 {- -} Received disconnect cause="Admission control" \
     laddr=10.0.1.6:7800 raddr=192.168.1.6:26539
CSH sport[6693]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
CSH sport[6693]: [splice/oob.NOTICE] 8 {- -} Lost OOB Splice between laddr=10.0.1.6:7800 a \
    nd raddr=192.168.1.6:7800
CSH sport[6693]: [spawnsplice.NOTICE] - {- -} (from 192.168.1.6:26607) End of stream readi \
    ng splice hdr info. Peer maybe down.
CSH sport[6693]: [spawnsplice.NOTICE] - {- -} (from 192.168.1.6:26582) End of stream readi \
    ng splice hdr info. Peer maybe down.
CSH sport[6693]: [spawnsplice.NOTICE] - {- -} (from 192.168.1.6:26578) End of stream readi \
    ng splice hdr info. Peer maybe down.
[...]
CSH sport[6693]: [spawnsplice.NOTICE] - {- -} (from 192.168.1.6:26545) End of stream readi \
    ng splice hdr info. Peer maybe down.
CSH sport[6693]: [spawnsplice.NOTICE] - {- -} (from 192.168.1.6:26556) End of stream readi \
    ng splice hdr info. Peer maybe down.
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40286248"></a>9.4.2. Inner channel setup failures</h3></div></div></div><p>When an inner channel gets setup and fails, the existing OOB Splice
gets torn down:
</p><div class="figure"><a name="idp40286568"></a><p class="title"><b>Figure 9.20. Remote Steelhead appliance failed to setup an inner channel</b></p><div class="figure-contents"><pre class="screen">CSH sport[26658]: [splice/oob.NOTICE] 12 {- -} Received disconnect cause="TproxyClientSpli \
    ce connect failure" laddr=10.0.1.6:57962 raddr=192.168.1.6:7800 
CSH sport[26658]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
CSH sport[26658]: [splice/oob.NOTICE] 12 {- -} Lost OOB Splice between laddr=10.0.1.6:5796 \
    2 and raddr=192.168.1.6:7800 
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40287080"></a>9.4.3. High Availability switch</h3></div></div></div><p>In a High Availability setup, where one Steelhead appliance is the
primary and takes all connections and the second Steelhead appliance
is the backup, the switch in roles shows like this:
</p><div class="figure"><a name="idp40287400"></a><p class="title"><b>Figure 9.21. Remote Steelhead becomes the backup in a High Availability cluster</b></p><div class="figure-contents"><pre class="screen">CSH sport[26658]: [splice/oob.NOTICE] 12 {- -} Received disconnect cause="FailoverSplice r \
    eleased ownership" laddr=10.0.1.6:57962 raddr=192.168.1.6:7800 
CSH sport[26658]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
CSH sport[26658]: [splice/oob.NOTICE] 12 {- -} Lost OOB Splice between laddr=10.0.1.6:5796 \
    2 and raddr=192.168.1.6:7800 
</pre></div></div><br class="figure-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40287848"></a>9.4.4. Voluntary takedown of OOB Splice</h3></div></div></div><p>The keep-alive packets going over the OOB Splice and the Connection Pool
can be expensive with for example satellite links. It is possible for
the OOB Splice to be taken down when there are no active optimized
TCP sessions:
</p><div class="figure"><a name="idp40288168"></a><p class="title"><b>Figure 9.22. Local Steelhead appliance disconnects</b></p><div class="figure-contents"><pre class="screen">CSH sport[15982]: [splice/oob.NOTICE] 1 {- -} Resetting state for oob splice: laddr=10.0.1 \
    .6:37964 raddr=192.168.1.6:7800 cflag=0x200 
CSH sport[15982]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
CSH sport[15982]: [splice/OOBHandler.NOTICE] - {- -} Dropping oob because of no sessions t \
    o 192.168.1.6:7800 
</pre></div></div><br class="figure-break"><div class="figure"><a name="idp40288616"></a><p class="title"><b>Figure 9.23. Local Steelhead appliance disconnects</b></p><div class="figure-contents"><pre class="screen">CSH sport[15982]: [splice/oob.NOTICE] 1 {- -} Received disconnect cause="No connections to \
     Peer" laddr=10.0.1.6:37957 raddr=192.168.1.6:7800 
CSH sport[15982]: [connect_pool.NOTICE] - {- -} Destroying pool to peer: 192.168.1.6
CSH sport[15982]: [splice/oob.NOTICE] 1 {- -} Lost OOB Splice between laddr=10.0.1.6:37957 \
     and raddr=192.168.1.6:7800 
</pre></div></div><br class="figure-break"></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="Further_help_and_support"></a>Chapter 10. Further help and support</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp40290472">10.1. Riverbed websites</a></span></dt><dt><span class="sect1"><a href="#idp40293672">10.2. Documentation</a></span></dt><dt><span class="sect1"><a href="#idp40294696">10.3. Riverbed TAC</a></span></dt></dl></div><p>This chapter contains the sources of further support.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Riverbed Support and Riverbed Splash website.
</p></li><li class="listitem"><p>Documentation.
</p></li><li class="listitem"><p>Riverbed TAC
</p></li></ul></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40290472"></a>10.1. Riverbed websites</h2></div></div></div><p>There are two websites to find help on issues: The Riverbed Support
website and the Riverbed Splash website.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40290792"></a>10.1.1. The Riverbed Support website</h3></div></div></div><p>The Riverbed Support website can be found at http://support.riverbed.com/.
It contains software images for all products, full documentation
sets and a knowledge base system.
</p><p>To get access to the support website, you need to create an account
for which you need to have a Steelhead appliance with a valid support
contract in your network, either purchased or via an evaluation
implementation.
</p><p>On the site you can see company specific details like:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The assets assigned to your company with their support contract
  expiry date,
</p></li><li class="listitem"><p>The cases you have created with the Riverbed TAC,
</p></li><li class="listitem"><p>The license keys for your assets.
</p></li></ul></div><p>
</p><p>And general links to:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The RiOS Software and Documentation download area. On it there
  is also a Software Upgrade Path which displays which intermediate
  software releases needs to be installed when upgrading between
  two software versions.
</p></li><li class="listitem"><p>The Knowledge base area, with various knowledge base articles which
  explains possible problem scenarios, third party software
  compatibility and explanation of logging and error messages.
</p></li><li class="listitem"><p>The Multimedia section, which has various videos on how to replace
  parts of the hardware of the system.
</p></li></ul></div><p>
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40293096"></a>10.1.2. The Riverbed Splash website</h3></div></div></div><p>The Riverbed Splash website is a community driven discussion forum
and can be found at http://splash.riverbed.com/. It contains
white papers, discussion forums and has an email alert service for
software release announcements.
</p><p>Unlike the official Riverbed Support website, everybody can sign
up to this forum and join the discussions.

</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40293672"></a>10.2. Documentation</h2></div></div></div><p>There are several documents available from the Support website which
will describe the basics, the capabilities and the features of the
Steelhead appliances.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Management Console Users Guide, which describes the various
  parts of the GUI of the Steelhead appliance.
</p></li><li class="listitem"><p>The Deployment Guide, which describes various deployment scenarios
  and integration issues.
</p></li><li class="listitem"><p>The Hardware Maintenance Guide, which describes the steps for
  installing new hardware into a Steelhead appliance and replacing
  hardware into a Steelhead appliance received via an RMA.
</p></li></ul></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40294696"></a>10.3. Riverbed TAC</h2></div></div></div><p>The Riverbed TAC provides technical support for operational issues
related to Riverbed products in your network. There are six TAC
centers globally distributed to provide follow-the-sun support:
Sydney in Australia, Singapore, Hoofddorp in the Netherlands,
Bracknell in the United Kingdom, New York in the eastern USA and
Sunnyvale and San Francisco in the western USA.
</p><p>They can be reached via email (mail to support@riverbed.com), via
the Riverbed Support website (http://support.riverbed.com/cases/)
or via the telephone (+1 415 247 7831).
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40295144"></a>10.3.1. Priority</h3></div></div></div><p>There are four priority levels which are used by Riverbed TAC to
find out the urgency of a case: P1 for critical issues, P2 for
urgent issues, P3 for normal issues or questions and P4 for
administrative issues.
</p><p>For a case opened via email, it will always open as a P3. Cases
opened via the website or via the phone can have their priority set
during the entering process.
</p><p>Do not open a P1 case via email or the website, always call in to
get immediate support.
</p><p>For non-P1 cases, the TAC engineer assigned to the case will most
likely answer via email. If you want to be contacted via telephone
to discuss, please state this and the telephone number you can be
reached on in the initial email.
</p><p>Sometimes cases are opened or picked up outside your normal business
hours and are handled by a TAC engineer outside your region. If the
situation sounds urgent and no contact could be made, the TAC
engineer will re-queue the case to the appropriate region for follow
up during your business hours. If this has not happened, feel free
to call in the to TAC to request the case to be re-assigned to a
local TAC engineer.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40295976"></a>10.3.2. Before you open a case</h3></div></div></div><p>To make life easier of the TAC engineer and for a quicker handling
of the case, please consider the following issues:
</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40296296"></a>10.3.2.1. Identify the systems involved</h4></div></div></div><p>The systems involved in the issue can be either a single Steelhead
appliance in case of a hardware problem. It can multiple Steelhead
appliances on multiple sites of the network. It can include
non-Riverbed devices, like Exchange servers or firewalls.
</p><p>Make sure you are able to describe the network around the Steelhead
appliances:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>What are the devices connected to the Steelhead appliance?
</p></li><li class="listitem"><p>Are there IDS/IPS/firewalls devices on the network between the
  client and server?
</p></li><li class="listitem"><p>Are there any load-balancers involved?
</p></li><li class="listitem"><p>Are the Steelhead appliances on this site a new implementation?
</p></li><li class="listitem"><p>Were there any changes to the network earlier?
</p></li><li class="listitem"><p>Were there any changes to the clients or servers earlier?
</p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40298152"></a>10.3.2.2. Prepare a system dump</h4></div></div></div><p>Please create a system dump on the devices you are experiencing a
problem on. If the issue is hardware related, a system dump of the
device itself is sufficient. If the issue is not hardware related,
then the system dumps of all the devices involved will most likely
be required.
</p><p>System dumps can be either:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Emailed to the TAC engineer. There is a 50 Mb size limit on
  incoming emails.
</p></li><li class="listitem"><p>Attached to the case at the Riverbed Support website. There is a
  100 Mb size limit on files uploaded via the Riverbed Support
  website.
</p></li><li class="listitem"><p>Uploaded to the Riverbed FTP server at ftp://ftp.riverbed.com/incoming/.
  Please prefix the file uploaded with the string
"<span class="italics">case_NNNNNN_</span>"
  so the files can be easily identified. Make sure you use the FTP
  client Binary Mode to transfer the files. There is no size limit
  on this method.
</p><p>  The
<span class="italics">/incoming</span>
  directory is write-only and the contents are hidden, which means
  that you can only upload files to it and not see the directory
  contents. If the upload gets aborted half-way then it is not
  possible to resume the upload. If this happens, change the filename
  and retry the upload again.
</p><p>  Since RiOS version 8.5, the GUI and the CLI allow upload to the
  FTP server directly. If the network policies allow the Steelhead
  appliance to access the Riverbed FTP directly, please use that
  method.
</p></li><li class="listitem"><p>Be stored on a private dropbox system of your choice so that the
  TAC engineer can retrieve it from there.
</p></li></ul></div><p>If the system dump is too large to be emailed or uploaded in one
go, consider splitting the system dump with WinZIP or WinRAR so
that the pieces can be emailed or uploaded without running into the
size or access restrictions.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40300328"></a>10.3.2.3. Alarms</h4></div></div></div><p>If you get an alarm from the Steelhead appliance via email, attach
it to the case. Not all the information from these emails is available
from the system dump.
</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idp40300648"></a>10.3.2.4. RMA details</h4></div></div></div><p>If the issue seems to be a hardware problem, please obtain the
following details in case an RMA is required:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The name, email address and telephone number of the person who
  will receive the replacement part.
</p></li><li class="listitem"><p>The address to send the replacement part to.
</p></li><li class="listitem"><p>If it is a full-chassis RMA, please state if the device has RSP
  features installed and the number of by-pass cards and their types
  installed.
</p></li><li class="listitem"><p>For Platinum and Gold Plus support RMAs, please state the date
  and time the delivery and replacement can be done (ASAP or a
  specific date/time) and any access restrictions to the site.
</p></li><li class="listitem"><p>For full chassis replacements in Platinum support RMAs, note that
  the field engineer swaps the device and only configures the device
  in such a way that the primary interface is reachable on the
  network. Software upgrades and further configuration will need
  to be done by the customer.
</p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40322536"></a>10.3.3. Life cycle of a case with Riverbed TAC</h3></div></div></div><p>In general, once a case is submitted
(<span class="italics">New</span>),
it will be picked up by a TAC engineer
(<span class="italics">Working</span>).
During the investigation of the issue, it might be that the TAC
engineer is waiting for further information like RMA details, a
system dump or tcpdump traces
(<span class="italics">Waiting Customer Information</span>).
At a certain moment the problem has been identified and can be
rectified
(<span class="italics">Waiting Solution Verification</span>)
and closure of the case
(<span class="italics">Pending Closure</span>).
Sometimes the problem needs a solution in the RiOS software itself
to engineering
(<span class="italics">Waiting for Engineering Fix, Waiting Software Release</span>)
but at the end it will be all resolved
(<span class="italics">Closed</span>).
</p><p>There are other states, for example when a case is opened on a
device without a valid support contract
(<span class="italics">Waiting Entitlement</span>)
or when an RMA has been issued
(<span class="italics">Waiting Hardware Replacement</span>).

</p></div></div></div><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="Jargon"></a>Appendix A. Jargon</h1></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Admission Control (operational): The state for the optimization
  service which prevents it from the optimization of new TCP sessions
  based on TCP session limits, TCP bandwidth limits or memory
  utilization.
</p></li><li class="listitem"><p>Asymmetric Routing (networking): The situation where the traffic
  between client and server takes a different path compared with
  the traffic between server and client.
</p></li><li class="listitem"><p>Auto-Discovery (optimization): The method of discovering peer
  Steelhead appliances in the path between the client and the server.
</p></li><li class="listitem"><p>Auto-Discovery Probe (optimization): The TCP Option in the TCP
  SYN packet which is used in the Auto-Discovery method.
</p></li><li class="listitem"><p>By-pass card (hardware): A network card with one or more LAN and
  WAN interface pairs.
</p></li><li class="listitem"><p>Central Management Console: An application to manage the configuration
  of Steelhead appliances, to monitor the behaviour of Steelhead
  appliances, Interceptor application and Steelhead Mobile Controllers.
</p></li><li class="listitem"><p>CFE (networking): Client File Engine, internal name for Client-side
  Steelhead Appliance.
</p></li><li class="listitem"><p>CLI (operational): The Steelhead appliance command-line interface.
</p></li><li class="listitem"><p>Client-side Steelhead appliance (networking): The Steelhead
  appliance closest to the client setting up the TCP session.
</p></li><li class="listitem"><p>CMC (operational): See Central Management Console.
</p></li><li class="listitem"><p>Cold Transfer (optimization): An optimized file transfer with data
  which is not seen before by the Steelhead appliance and thus needs
  to be labeled and transferred to the other Steelhead appliance.
</p></li><li class="listitem"><p>Connection Forwarding (optimization): The method for two or more
  Steelhead appliances to exchange information about TCP sessions
  optimized by one of the Steelhead appliances.
</p></li><li class="listitem"><p>Connection Pool (optimization, networking): A set of pre-setup
  TCP sessions setup between two Steelhead appliance in-path
  interfaces which can be converted into Inner Channels.
</p></li><li class="listitem"><p>Correct Addressing (optimization, networking): The WAN visibility
  method of the inner channel where the IP addresses are the IP
  addresses of the Steelhead appliance in-path interfaces and the
  TCP port numbers used are TCP port numbers defined by the client-side
  and server-side Steelhead appliances.
</p></li><li class="listitem"><p>CSH (networking): See Client-side Steelhead appliance.
</p></li><li class="listitem"><p>Data store (optimization): The dictionary with the reference labels
  and frames.
</p></li><li class="listitem"><p>Data store ID (optimization): The identifier of a data store.
</p></li><li class="listitem"><p>Data Store Synchronization (optimization): The method for two
  Steelhead appliances to synchronize their data store so that learned
  references are not lost if one of the data stores vanishes.
</p></li><li class="listitem"><p>Fault Tolerant Segstore (hardware): A data store storage implementation
  which allows for failure of the underlying storage devices.
</p></li><li class="listitem"><p>Fixed Target (optimization): The method of setting up an inner
  channel by defining the IP address of the peer Steelhead appliance
  in the in-path rule.
</p></li><li class="listitem"><p>Frame (optimization): A string of characters.
</p></li><li class="listitem"><p>FTS (hardware): See Fault Tolerant Segstore.
</p></li><li class="listitem"><p>Full Transparency (optimization, networking): The WAN visibility
  method of the inner channel where the IP addresses and TCP port
  numbers used are the IP addresses and TCP port numbers of the
  client and server.
</p></li><li class="listitem"><p>GUI (operational): The Steelhead appliance web-interface.
</p></li><li class="listitem"><p>Inner channel (optimization, networking): The part of an optimized
  TCP session between two Steelhead appliances.
</p></li><li class="listitem"><p>In-Path Deployment (networking): A deployment method where the
  Steelhead appliance is located between two network devices.
</p></li><li class="listitem"><p>In-path Interface (operation, networking): A virtual interface
  consisting of a physical LAN and WAN interface on a by-pass card.
</p></li><li class="listitem"><p>In-Path Rules (optimization): The list of rules traversed to
  determine what to happen with a new TCP session seen by a naked
  SYN packet.
</p></li><li class="listitem"><p>Label (optimization): A unique identifier for a frame.
</p></li><li class="listitem"><p>Link State Protocol (networking): A method for an interface in a
  pair of LAN and WAN interfaces to follow the network link state
  of its peer.
</p></li><li class="listitem"><p>LSP (networking): See Link State Protocol.
</p></li><li class="listitem"><p>MFE (networking): Middle File Engine, internal name for Middle
  Steelhead Appliance.
</p></li><li class="listitem"><p>Middle Steelhead appliance (networking): Any Steelhead appliance
  in between the client-side Steelhead appliance and the server-side
  Steelhead appliance.
</p></li><li class="listitem"><p>MSH (networking): See Middle Steelhead appliance.
</p></li><li class="listitem"><p>Naked SYN (optimization): A TCP SYN packet without an
  auto-discovery probe attached to it.
</p></li><li class="listitem"><p>OOB Splice (optimization): See Out-of-Band splice.
</p></li><li class="listitem"><p>Optimization service (optimization): The process on the Steelhead
  appliance which does do the optimization of the network traffic.
</p></li><li class="listitem"><p>Out-of-Band Splice (optimization): A control TCP session between
  two in-path interface IP addresses.
</p></li><li class="listitem"><p>Out of Path Deployment (networking): A deployment method where
  the Steelhead appliance is not located in the path, virtual or
  non-virtual, of the traffic.
</p></li><li class="listitem"><p>Outer channel (optimization, networking): The part of an optimized
  TCP session between a Steelhead appliance and the client or the
  server.
</p></li><li class="listitem"><p>Peering Rule (optimization): A list of rules traversed to determine
  what to happen with a new TCP session identified by a SYN+ packet.
</p></li><li class="listitem"><p>Port Transparency (networking): The WAN visibility method of the
  inner channel where the IP addresses used are the IP addresses
  of the Steelhead appliance in-path interfaces and the TCP port
  numbers used are the TCP port numbers of the client and server.
</p></li><li class="listitem"><p>Reference (optimization): A frame in the data store, identified
  by a label.
</p></li><li class="listitem"><p>RiOS (optimization): The Riverbed Optimization System.
</p></li><li class="listitem"><p>RSP (virtualization): See Riverbed Services Platform.
</p></li><li class="listitem"><p>RSP image (virtualization): The RSP software as provided by
  Riverbed to be installed on the Steelhead appliance.
</p></li><li class="listitem"><p>RSP package (virtualization): A software image of the virtual
  machine as created by the RSP Package Generator.
</p></li><li class="listitem"><p>RSP Package Generator (virtualization): The tool to convert a
  VMware based virtual machine into an RSP package.
</p></li><li class="listitem"><p>RSP service (virtualization): The RSP software running on the
  Steelhead appliance.
</p></li><li class="listitem"><p>RSP slot (virtualization): The virtual machine on the RSP service.
</p></li><li class="listitem"><p>Riverbed Services Platform (virtualization): The virtualization
  platform on the Steelhead appliances.
</p></li><li class="listitem"><p>Scalable Data Referencing (optimization): The dictionary methods
  that the Steelhead appliance applies to optimize data.
</p></li><li class="listitem"><p>SDR (optimization): See Scalable Data Referencing.
</p></li><li class="listitem"><p>SDR-A (optimization): SDR Advanced, where the optimization service
  decided to use normal SDR or SDR-M based on the disk load on the
  Steelhead appliance.
</p></li><li class="listitem"><p>SDR-M (optimization): SDR Memory, where the optimization service
  only uses a memory based data store and not a disk based data
  store.
</p></li><li class="listitem"><p>Secure Sockets Layer (optimization): An encrypted transport layer.
</p></li><li class="listitem"><p>Secure vault (hardware): An encrypted disk partition on the
  Steelhead appliance.
</p></li><li class="listitem"><p>Segstore (optimization): See Data store.
</p></li><li class="listitem"><p>Server-side Steelhead appliance (networking): The Steelhead
  appliance closest to the server the TCP session is being setup
  to.
</p></li><li class="listitem"><p>SFE (networking): Server File Engine, internal name for Server-side
  Steelhead Appliance.
</p></li><li class="listitem"><p>SH (networking): Abbreviation for Steelhead appliance.
</p></li><li class="listitem"><p>SHM (optimization): The Steelhead Mobile software.
</p></li><li class="listitem"><p>Simplified Routing (networking, optimization): Routing decisions
  which are based on data learned from packets going through an
  in-path interface.
</p></li><li class="listitem"><p>SMC (hardware): The Steelhead Mobile Controller.
</p></li><li class="listitem"><p>SPort (optimization): See Optimization service.
</p></li><li class="listitem"><p>SSH (networking): See Server-side Steelhead appliance.
</p></li><li class="listitem"><p>SSL (optimization): See Secure Sockets Layer.
</p></li><li class="listitem"><p>SYN+ packet (optimization): A TCP SYN packet with an auto-discovery
  probe in it.
</p></li><li class="listitem"><p>SYN/ACK+ packet (optimization): A TCP SYN/ACK packet with an
  auto-discovery probe in it.
</p></li><li class="listitem"><p>Virtual In-Path Deployment (networking): A deployment method where
  the Steelhead appliance is not located in between two network
  devices but gets the interesting traffic forwarded by a WCCP
  router, via PBR or via a Interceptor appliance.
</p></li><li class="listitem"><p>WAN visibility (networking): The IP address and TCP port number
  used for the inner channel of the optimized TCP session.
</p></li><li class="listitem"><p>Warm Transfer (optimization): An optimized file transfer with
  data which has been seen before by the Steelhead appliance and
  thus only the references need to be send to the other Steelhead
  appliance.
</p></li></ul></div></div><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="Troubleshooting_workflow_for_network_performance_related_issues"></a>Appendix B. Troubleshooting workflow for network performance related issues</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idp40350120">B.1. Step One: Does the TCP session get optimized?</a></span></dt><dt><span class="sect1"><a href="#idp40394664">B.2. Step Two: Does TCP optimization and data reduction work?</a></span></dt><dt><span class="sect1"><a href="#idp40401832">B.3. Step Three: Does latency optimization work</a></span></dt></dl></div><p>This appendix describes the steps to be taken to isolate network
performance related issues.

</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40350120"></a>B.1. Step One: Does the TCP session get optimized?</h2></div></div></div><p>If the optimized TCP session gets setup properly, it will be displayed
in the list of Current Connections. If the TCP session doesn't show
there, this chapter needs to be followed.
</p><p>Most of the troubleshooting for this step can be done via the GUI
or by checking the output of the
<span class="italics">tcpdump</span>
tool.
</p><p>The setup of an optimized TCP session consists of three phases: The
auto-discovery phase, the OOB channel and the setup of the inner
and outer channels phase.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40301864"></a>B.1.1. Phase A: Does the auto-discovery phase complete?</h3></div></div></div><p>During the auto-discovery phase, the client-side Steelhead (CSH)
should intercept the naked SYN from the client on the LAN interface,
attach the auto-discovery probe and send the SYN+ out on the
corresponding WAN interface.
</p><p>Why was the naked SYN not seen?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The traffic towards the server does not go via the CSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Are there other paths from the client's LAN switch to the WAN router.
</p></li><li class="listitem"><p>Check the MAC tables on the various devices to confirm that the
    traffic towards the CSH in-path IP addresses and the gateway
    behind the CSH are going out via the same port.
</p></li><li class="listitem"><p>Are there any other CSHs there? 
</p></li></ul></div><p>
</p></li><li class="listitem"><p>In case of a virtual in-path WCCP/PBR deployment, the WCCP/PBR
  router does not forward the traffic towards the CSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check the redirection access-lists on the WCCP/PBR routers to
    confirm that the client/server IP addresses are matching.
</p></li><li class="listitem"><p>Check that the incoming interface for the client traffic does
    have the redirection statements configured.
</p></li><li class="listitem"><p>Check that the WCCP routers and the CSH can see each other.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>Why did the auto-discovery probe not get attached?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The optimization service is not running.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>It can have crashed, is turned off, didn't want to start.
</p></li><li class="listitem"><p>There is a connection-forwarding failure or fail-over mode.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The naked SYN showed up on the WAN interface for in-path deployments.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>LAN/WAN cable switched.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The in-path interface is not enabled for optimization.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check the settings under Configure -&gt; Optimization -&gt; General
    Settings.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>A pass-through in-path rule prevents it.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check the in-path rules.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The CSH is in connection-based admission control.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Confirm that there has been no admission control alarms.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The client/server IP addresses are in the asymmetric routing table.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check the asymmetric routing table and flush it if necessary.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>There is no space in the TCP header to store the auto-discovery probe.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check the kernel logs this with the command
<code class="computeroutput">support show kernel-logs</code>.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>The SYN+ should arrive on the server-side Steelhead (SSH).
</p><p>Why does the SYN+ not get seen?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Routing issues between CSH and SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Run traceroute and confirm that the traffic goes through the SSH.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>A naked SYN gets seen!
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Auto-discovery probe gets stripped by firewall.
</p></li><li class="listitem"><p>Compare TCP headers.
</p></li><li class="listitem"><p>Third SYN from the client? A Firewall doesn't like the
    auto-discovery probe and drops the SYN+.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Traffic passed a NAT gateway which changes source IP address and
  maybe also stripped off the auto-discovery probe.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Try fixed-target rules
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>In case of Enhanced Auto-Discovery, the SSH will send a SYN/ACK++
to the CSH and forwards the SYN+ via the corresponding interface and
waits for a SYN/ACK.
</p><p>Why does the SYN/ACK++ not get seen on the SSH?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The in-path interface gateway is set to the LAN side which
  doesn't send it back via this in-path interface.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check in-path routing table.
</p></li><li class="listitem"><p>Check the LAN side interface.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>In-path interface cannot resolve the gateway IP address.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Inspect ARP table.
</p></li><li class="listitem"><p>Try to ping the default gateway from the in-path interface IP address.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The optimization service is not running.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>It can have crashed, is turned off, didn't want to start.
</p></li><li class="listitem"><p>There is a connection-forwarding failure or fail-over mode.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The in-path interface is not enabled for optimization.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check the settings under Configure -&gt; Optimization -&gt; General
    Settings.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>A pass-through peering rule prevents it.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check the peering rules.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The SSH is in connection-based admission control.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Confirm that there has been no admission control alarms.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>Why does the SYN/ACK++ not get seen by the CSH?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Routing issues between the CSH and SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Run traceroute and confirm that the traffic goes through the CSH.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>A naked SYN/ACK arrives.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Auto-discovery probe gets stripped by a firewall
</p></li><li class="listitem"><p>Compare TCP headers.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Asymmetric routing bypasses the CSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>You should see a TCP RST from the client.
</p></li></ul></div><p>
</p></li></ul></div><p>Why does the SYN+ not get seen leaving the SSH?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>No idea. Does this happen?
</p></li></ul></div><p>
</p><p>Why does the SYN/ACK not get seen?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The server doesn't answer.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>The server is off.
</p></li><li class="listitem"><p>The traffic is blocked by firewall.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The traffic from the server to the client does not go via the SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>This is a case of server-side asymmetry.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>The SSH will send a SYN/ACK+ towards the CSH.
</p><p>Why does the SYN/ACK+ not get send?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The in-path interface gateway is set to the LAN side which
  doesn't send it back via the WAN interface.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Check in-path routing table.
</p></li><li class="listitem"><p>Check the LAN interface.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>In-path interface cannot resolve the gateway IP address.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Inspect ARP table.
</p></li><li class="listitem"><p>Try to ping the default gateway from the in-path interface IP address.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>Why does the SYN/ACK+ not get received by the CSH?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Asymmetric routing bypasses the CSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>You should see a TCP RST from the client on the LAN side.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>In case of Enhanced Auto-Discovery, a firewall blocks the SYN/ACK+
  because it has already seen it as the SYN/ACK++.
</p></li><li class="listitem"><p>A naked SYN/ACK arrives
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Auto-discovery probe gets stripped by a firewall.
</p></li><li class="listitem"><p>Compare TCP headers.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>At the end of the auto-discovery phase, the CSH will not send a
final ACK of the TCP handshake.
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40385704"></a>B.1.2. Phase B: Do the OOB channel and the Connection Pool get setup?</h3></div></div></div><p>After the auto-discovery phase, the CSH will setup an OOB channel
to the SSH. This is a TCP session from the CSH in-path interface
to the SSH in-path interface on TCP port 7800.
</p><p>Why does the OOB TCP session not get setup?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Routing issues between the CSH and SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Run ping and traceroute to see check the paths.
</p></li><li class="listitem"><p>Telnet from CSH in-path IP address to SSH in-path IP address
    on TCP port 7800.
</p></li><li class="listitem"><p>Run tcpdump to see which part doesn't work.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Timeout in the setup of the OOB channel.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Traffic towards SSH is blocked.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>After the OOB channel is setup, the CSH will setup the Connection
Pool to the CSH. This is a set of 20 TCP sessions from the CSH
in-path interface to the SSH in-path interface on TCP port 7800.
</p><p>Why do the Connection pool TCP sessions not get setup?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The CSH in-path rules state that the inner channel WAN visibility
  is Port of Full Transparency.
</p></li><li class="listitem"><p>Routing issues between the CSH and SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Run ping and traceroute to see check the paths.
</p></li><li class="listitem"><p>Telnet from CSH in-path IP address to SSH in-path IP address
    on TCP port 7800.
</p></li><li class="listitem"><p>Run tcpdump to see which part doesn't work.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Timeout of the setup of the TCP Connections.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Traffic towards SSH is blocked.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40389992"></a>B.1.3. Phase C: Does the inner channel get established?</h3></div></div></div><p>After the auto-discovery phase, the CSH will setup an Inner Channel.
</p><p>For the Correct Addressing WAN visibility, this will happen by the
conversion of a TCP session in the Connection Pool into an inner
channel.
</p><p>Why does the conversion from TCP session of the Connection Pool into
an inner channel fail?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Setup packet doesn't arrive at SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>The TCP sessions could have timed out by a firewall in the
    network. Reduce TCP Keep-Alive interval for the inner channels.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>For the Port Transparency WAN visibility, this will be a normal
TCP session from the CSH in-path interface IP address to the SSH
in-path interface IP address, but with the TCP port of original
naked SYN.
</p><p>Why does the inner channel not get setup?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Routing issues between the CSH and SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Run ping and traceroute to see check the paths.
</p></li><li class="listitem"><p>Take traces to see which part doesn't get setup.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Traffic towards SSH is blocked.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Timeout of the setup of the inner channel.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>A naked SYN arrives at the SSH.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Transparency options get stripped by a firewall.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>For the Full Transparency WAN visibility, this will be a TCP session
from the original client IP address to the original server IP
address, but with the TCP port of original naked SYN.
</p><p>Why does the inner channel not get setup?
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A firewall doesn't allow the "old" SYN with different TCP sequence
  numbers.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Use Full Transparency with Firewall Reset to reset the state
    tables on the firewall.
</p></li></ul></div><p>
</p></li></ul></div><p>
</p><p>Once the TCP session is setup, the CSH will send the splice setup
message and the inner channel is setup.
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40394664"></a>B.2. Step Two: Does TCP optimization and data reduction work?</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40394920"></a>B.2.1. Issue one: The inner channel doesn't stay up.</h3></div></div></div><p>As long as the client and the server don't close the TCP session,
the inner channel should stay up.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The TCP connection times out.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>The inner channel doesn't support fragmentation. If there is a
    gateway in the path which doesn't support for the MTU size of
    the in-path interface, we expect to see an ICMP Fragmentation
    Required packet with the right MTU size. If that packet doesn't
    get delivered, the TCP session will time out.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>The TCP session gets reset.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>A firewall in between the CSH and SSH has noted that the final
    ACK of the setup of the original TCP session didn't arrive.
    After a timeout the firewall will send a TCP RST to the client
    and server, intercepted by the CSH and SSH which will terminate
    the TCP session. This will affect long-lived TCP sessions most.
</p></li><li class="listitem"><p>With the Full Transparency or Port Transparency WAN visibility,
    an IPS/IDS will find out that the protocol spoken on the inner
    channel isn't the protocol expected and it will terminate the
    TCP session.
</p></li></ul></div><p>
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40396584"></a>B.2.2. Issue two: Traffic is not suited for optimization.</h3></div></div></div><p>The traffic must be suitable for optimization.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Bad data reduction.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Encrypted traffic. If it is SSL encrypted it could be optimized
    with SSL pre-optimization. If anything else, no luck. Check the
    documentation of the application to see if this can be disabled.
</p></li><li class="listitem"><p>Compressed traffic. Check the documentation of the application
    if this can be disabled.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Bad traffic scenario.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>If the traffic between the client and server is not a stream
    of lots of traffic in burst but more a ping-pong, the neural
    framing algorithm will cause extra delay here.
</p></li></ul></div><p>
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40398248"></a>B.2.3. Issue three: Network issues</h3></div></div></div><p>If the network isn't happy, the optimized traffic won't perform
well neither.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Speed / duplex mismatch.
</p></li><li class="listitem"><p>Congestion.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>QoS not enabled.
</p></li><li class="listitem"><p>QoS bandwidth misconfigured.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>Large Fat Network.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>WAN link doesn't get filled. Use HS-TCP or MX-TCP.
</p></li></ul></div><p>
</p></li><li class="listitem"><p>WAN bandwidth admission control.
</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp40400360"></a>B.2.4. Issue four: Steelhead related issues</h3></div></div></div><p>And it could just be that the SH is not performing well.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>CPU load, paging.
</p></li><li class="listitem"><p>Broken disk.
</p></li><li class="listitem"><p>High disk utilization: SDR Cost / SDR Latency / Disk Load 3.
</p></li><li class="listitem"><p>QoS configuration wrong.
</p></li><li class="listitem"><p>Optimization service not happy.
</p></li></ul></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp40401832"></a>B.3. Step Three: Does latency optimization work</h2></div></div></div><p>If the latency optimization doesn't work, then it's all depending
on the protocol being spoken:
</p><p>SMB latency optimization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Failed oplock acquisition.
</p></li><li class="listitem"><p>Write-behind cancellation.
</p></li><li class="listitem"><p>Unsupported SMB version.
</p></li><li class="listitem"><p>Unsupported SMB server.
</p></li><li class="listitem"><p>If the data is signed and the Active Directory integration failed.
</p></li><li class="listitem"><p>Just an inefficient approach: Copy a roaming profile consisting
  of a lot of directories and small files instead of copying one
  large file and decompressing it locally.
</p></li></ul></div><p>
</p><p>MAPI latency optimization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If the data is encrypted and the Active Directory integration failed.
</p></li><li class="listitem"><p>For MAPI-OA, is the SSL optimization working?
</p></li></ul></div><p>
</p><p>HTTP latency optimization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Latency optimization discontinues for the rest of the requests
  when one fails.
</p></li><li class="listitem"><p>If Full Transparency is used, every new HTTP session needs to be
  auto-discovered and inner channel being setup before the requests
  are forwarded.
</p></li><li class="listitem"><p>+ ?
</p></li></ul></div><p>
</p><p>NFS latency optimization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Unsupported NFS version.
</p></li><li class="listitem"><p>Unsupported authentication encryption mechanism.
</p></li></ul></div><p>
</p><p>MS-SQL:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Unsupported MS-SQL version.
</p></li></ul></div><p>
</p><p>Lotus Notes:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The traffic is encrypted and the latency optimization is not
  configured for it.
</p></li></ul></div><p>
</p><p>SSL pre-optimization:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The maximum number of optimized TCP sessions being SSL encrypted
  is about 40-50% of the hardware specified amount of TCP sessions
  the machine is capable of.
</p></li></ul></div><p>

</p></div></div></div></body></html>
